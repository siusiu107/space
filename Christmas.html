<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ„ Christmas Rhythm Stage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --glass: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.14);
      --bg: #040a18;
      --accent: #ff4d7a;
      --accent-2: #5df2ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Noto Sans KR','Montserrat', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 25%, rgba(255,255,255,0.12), transparent 32%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.08), transparent 30%),
        linear-gradient(160deg, #0a1633 0%, #050912 45%, #021623 100%);
      color:#e7f5ff;
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
    }
    .snow{position:absolute;inset:0;pointer-events:none;background-image:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22 viewBox=%220 0 10 10%22%3E%3Ccircle cx=%222%22 cy=%223%22 r=%220.6%22 fill=%22%23fff%22 opacity=%220.4%22/%3E%3Ccircle cx=%228%22 cy=%229%22 r=%220.5%22 fill=%22%23fff%22 opacity=%220.35%22/%3E%3Ccircle cx=%225%22 cy=%226%22 r=%220.4%22 fill=%22%23fff%22 opacity=%220.3%22/%3E%3C/svg%3E');animation: drift 18s linear infinite;}
    @keyframes drift{from{transform:translateY(-20px);}to{transform:translateY(40px);}}
    header{
      max-width:1200px;
      margin:0 auto;
      padding:28px 16px 6px;
      text-align:center;
      position:relative;
      z-index:1;
    }
    h1{
      margin:0;
      font-size:28px;
      letter-spacing:0.3px;
    }
    h1 span{ color:var(--accent); }
    .subtitle{ color:#bed8ff; margin:6px 0 14px; font-size:15px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,0.1); padding:8px 14px; border-radius:999px; font-size:13px; text-transform:uppercase; letter-spacing:1px; color:#ffe2f3; border:1px solid rgba(255,255,255,0.15); }
    .layout{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:16px; padding:16px; max-width:1200px; margin:0 auto; position:relative; z-index:1; }
    .panel{
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:16px;
      box-shadow:0 16px 32px rgba(0,0,0,0.4);
      backdrop-filter:blur(8px);
    }
    #game-container{
      background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.65)), #050912;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:18px;
      position:relative;
      overflow:hidden;
      min-height:560px;
    }
    label{ display:block; margin-top:12px; font-weight:700; letter-spacing:0.2px; }
    .hint{ color:#cfe2ff; font-size:14px; line-height:1.55; }
    select, button{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.35); color:#fff; font-size:15px;
    }
    select{ appearance:none; background-image:linear-gradient(45deg, transparent 50%, #8bafff 50%), linear-gradient(135deg, #8bafff 50%, transparent 50%); background-position: calc(100% - 18px) calc(50% - 4px), calc(100% - 13px) calc(50% - 4px); background-size:6px 6px; background-repeat:no-repeat; }
    button{
      cursor:pointer;
      background:linear-gradient(120deg, #ff9acb 0%, #ff4d7a 45%, #5df2ff 100%);
      color:#0b0b14;
      font-weight:800;
      border:none;
      box-shadow:0 10px 30px rgba(255,77,122,0.35);
      transition:transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 12px 34px rgba(93,242,255,0.4); }
    button:disabled{ opacity:.65; cursor:not-allowed; box-shadow:none; }
    .stats{ display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:10px; margin-top:12px; font-size:14px; }
    .stat{ padding:10px 12px; border-radius:12px; background:rgba(0,0,0,0.32); border:1px solid rgba(255,255,255,0.12); display:flex; justify-content:space-between; align-items:center; }
    #status{ margin-top:10px; color:#ffe8a6; font-weight:800; min-height:22px; letter-spacing:0.2px; }
    .keys{ margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit, minmax(60px, 1fr)); gap:10px; }
    .keycap{ padding:10px; text-align:center; border-radius:12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); font-weight:700; box-shadow:inset 0 1px 0 rgba(255,255,255,0.1); }
    canvas{ border-radius:14px; overflow:hidden; width:100% !important; height:auto !important; }
    .mobile-hint{ color:#9fc5ff; font-size:13px; margin-top:8px; display:flex; align-items:center; gap:8px; }
    @media (max-width: 720px){
      header{ padding-top:24px; }
      h1{ font-size:24px; }
      .panel{ padding:14px; }
      #game-container{ min-height:520px; }
      .keys{ grid-template-columns:repeat(4, 1fr); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
  <div class="snow"></div>
  <header>
    <div class="badge">HOLIDAY PARTY â€¢ ë¦¬ë“¬ì±Œë¦°ì§€</div>
    <h1>ğŸ§ <span>í¬ë¦¬ìŠ¤ë§ˆìŠ¤</span> ë¦¬ë“¬ê²Œì„</h1>
    <p class="subtitle">ì‹¤ì œ ìºë¡¤ê³¼ í•¨ê»˜ ë” ìƒë™ê° ìˆê²Œ! íˆíŠ¸ë¥¼ ì´ì–´ê°€ê³  ì™„ë²½ í´ë¦¬ì–´ë¡œ ì„ ë¬¼ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
  </header>
  <div class="layout">
    <div class="panel">
      <p class="hint">ğŸ„ ì‹ ë‚˜ëŠ” ìºë¡¤ 8ê³¡ì„ ë°”ë¡œ ì¬ìƒí•  ìˆ˜ ìˆë„ë¡ ì—°ê²°í–ˆì–´ìš”. ì²˜ìŒë¶€í„° ëê¹Œì§€ ë†“ì¹˜ì§€ ë§ê³  ì—°ì† íˆíŠ¸ë¥¼ ë…¸ë ¤ë³´ì„¸ìš”!</p>
      <label>ê³¡ ì„ íƒ</label>
      <select id="track-select" aria-label="í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê³¡ ì„ íƒ"></select>
      <button id="start-btn" style="margin-top:12px;">ê²Œì„ ì‹œì‘</button>
      <div id="status" aria-live="polite"></div>
      <div class="stats">
        <div class="stat"><span>íˆíŠ¸</span><strong id="hit-count">0</strong></div>
        <div class="stat"><span>ë¯¸ìŠ¤</span><strong id="miss-count">0</strong></div>
        <div class="stat"><span>ì—°ì†</span><strong id="combo-count">0</strong></div>
      </div>
      <div class="keys">
        <div class="keycap">D</div>
        <div class="keycap">F</div>
        <div class="keycap">J</div>
        <div class="keycap">K</div>
      </div>
      <div class="mobile-hint">ğŸ’¡ ëª¨ë°”ì¼ì—ì„  í™”ë©´ì„ ëˆ•í˜€ ë‘ ì†ê°€ë½ìœ¼ë¡œ D/F/J/K ìœ„ì¹˜ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</div>
    </div>
    <div id="game-container" aria-label="ë¦¬ë“¬ê²Œì„ ì˜ì—­"></div>
  </div>

  <script>
    const tracks = [
      { name:'Jingle Bells (Upbeat Remix)', artist:'Alex Productions', url:'https://cdn.pixabay.com/audio/2022/12/19/audio_4fec3b4bb4.mp3' },
      { name:'Deck the Halls', artist:'Nico Staf', url:'https://cdn.pixabay.com/download/audio/2023/12/11/audio_8f31cddd84.mp3?filename=deck-the-halls-150740.mp3' },
      { name:'We Wish You a Merry Christmas', artist:'Grand_Project', url:'https://cdn.pixabay.com/download/audio/2023/12/11/audio_35bc0e8d47.mp3?filename=we-wish-you-a-merry-christmas-150742.mp3' },
      { name:'Joyful Christmas', artist:'PrazKazak', url:'https://cdn.pixabay.com/download/audio/2022/12/07/audio_7fb2f6a510.mp3?filename=joyful-christmas-126566.mp3' },
      { name:'Christmas Sleigh Ride', artist:'LiteSaturation', url:'https://cdn.pixabay.com/download/audio/2023/12/08/audio_27e1ca1192.mp3?filename=christmas-sleigh-ride-150550.mp3' },
      { name:'Happy Xmas Bells', artist:'Grand_Project', url:'https://cdn.pixabay.com/download/audio/2023/12/11/audio_dfef399b95.mp3?filename=happy-xmas-bells-150744.mp3' },
      { name:'Upbeat Christmas', artist:'Oleg Kirilkov', url:'https://cdn.pixabay.com/download/audio/2022/11/29/audio_85d6a8c41f.mp3?filename=upbeat-christmas-124132.mp3' },
      { name:'Christmas Funk', artist:'FASSounds', url:'https://cdn.pixabay.com/download/audio/2022/11/14/audio_795bec5e54.mp3?filename=christmas-funk-12748.mp3' }
    ];

    const keyToLane = { KeyD:0, KeyF:1, KeyJ:2, KeyK:3 };
    const laneColors = ['#00d4ff','#5cffc8','#ffc85c','#ff7aa5'];
    let gameInstance = null;
    let currentScene = null;
    let activeAudio = null;

    const rhythmData = { schedule: [], startedAt: 0, hits:0, misses:0, combo:0, sent:false };

    const statusEl = document.getElementById('status');
    const hitEl = document.getElementById('hit-count');
    const missEl = document.getElementById('miss-count');
    const comboEl = document.getElementById('combo-count');
    const startBtn = document.getElementById('start-btn');
    const selectEl = document.getElementById('track-select');

    function fillTracks(){
      tracks.forEach((t, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `${idx+1}. ${t.name} Â· ${t.artist}`;
        selectEl.appendChild(opt);
      });
    }

    function updateStats(){
      hitEl.textContent = rhythmData.hits;
      missEl.textContent = rhythmData.misses;
      comboEl.textContent = rhythmData.combo;
    }

    function buildSchedule(durationMs){
      const beat = 620;
      const count = Math.min(220, Math.max(48, Math.floor(durationMs / beat)));
      const schedule = [];
      let lane = 0;
      for (let i=0;i<count;i++){
        const time = i*beat + Phaser.Math.Between(-120, 120);
        lane = (lane + Phaser.Math.Between(1,3)) % 4;
        schedule.push({ time: Math.max(0, time), lane });
      }
      return schedule;
    }

    function destroyGame(){
      if (gameInstance) {
        gameInstance.destroy(true);
        gameInstance = null;
      }
    }

    function handleAudioError(message){
      statusEl.textContent = message;
      startBtn.disabled = false;
      destroyGame();
    }

    function initGameFromAudio(){
      const durationMs = (Number.isFinite(activeAudio.duration) && activeAudio.duration > 0)
        ? activeAudio.duration * 1000
        : 30000;
      rhythmData.schedule = buildSchedule(durationMs);
      destroyGame();
      gameInstance = new Phaser.Game({
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 540, height: 720 },
        parent: 'game-container',
        backgroundColor: '#050912',
        physics: { default: 'arcade' },
        scene: [RhythmScene]
      });
      activeAudio.currentTime = 0;
      activeAudio.play().catch(()=>{
        handleAudioError('ì˜¤ë””ì˜¤ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì†Œë¦¬ë¥¼ ì¼œì£¼ì„¸ìš”.');
      });
    }

    function finishRun(scene){
      if (rhythmData.finished) return;
      rhythmData.finished = true;
      const perfect = rhythmData.hits > 0 && rhythmData.misses === 0;
      statusEl.textContent = perfect ? 'ì™„ë²½ í´ë¦¬ì–´! ì‚°íƒ€ ì¡°ê° 5ê°œ íšë“!' : 'í´ë¦¬ì–´! ë‹¤ì‹œ ë„ì „í•´ ë³´ì„¸ìš”.';
      if (perfect && !rhythmData.sent) {
        try { window.parent.postMessage({ type:'christmas-clear', pieces:5, perfect:true }, '*'); } catch {}
        rhythmData.sent = true;
      }
      startBtn.disabled = false;
    }

    class RhythmScene extends Phaser.Scene {
      constructor(){ super('RhythmScene'); }
      create(){
        currentScene = this;
        this.cameras.main.setBackgroundColor('#050912');
        this.hitY = 600;
        this.noteSpeed = 340;
        this.window = 76;
        this.activeNotes = [];
        this.scheduleIndex = 0;
        rhythmData.hits = 0; rhythmData.misses = 0; rhythmData.combo = 0; rhythmData.finished = false; rhythmData.sent = false;
        updateStats();

        const width = this.game.config.width;
        const laneWidth = 120;
        this.laneX = [width/2 - laneWidth*1.5, width/2 - laneWidth*0.5, width/2 + laneWidth*0.5, width/2 + laneWidth*1.5];
        this.add.rectangle(width/2, this.hitY, width, 4, 0xffffff, 0.3);
        this.laneX.forEach((x, idx)=>{
          this.add.rectangle(x, this.hitY, laneWidth-4, 18, Phaser.Display.Color.HexStringToColor(laneColors[idx]).color, 0.18);
        });

        this.input.keyboard.on('keydown', (ev)=>this.handleKey(ev.code));
        rhythmData.startedAt = performance.now();
      }

      spawnNote(lane){
        const x = this.laneX[lane];
        const note = this.add.rectangle(x, -30, 68, 16, Phaser.Display.Color.HexStringToColor(laneColors[lane]).color).setOrigin(0.5);
        note.lane = lane;
        this.activeNotes.push(note);
      }

      handleKey(code){
        const lane = keyToLane[code];
        if (lane === undefined) return;
        let best = null;
        let bestIdx = -1;
        for (let i=0;i<this.activeNotes.length;i++){
          const n = this.activeNotes[i];
          if (n.lane !== lane) continue;
          const dist = Math.abs(n.y - this.hitY);
          if (dist <= this.window && (best === null || dist < best.dist)) {
            best = { note:n, dist, idx:i };
          }
        }
        if (best){
          rhythmData.hits += 1;
          rhythmData.combo = rhythmData.combo + 1;
          best.note.destroy();
          this.activeNotes.splice(best.idx, 1);
          statusEl.textContent = best.dist < 28 ? 'PERFECT!' : 'GOOD!';
        } else {
          rhythmData.misses += 1;
          rhythmData.combo = 0;
          statusEl.textContent = 'MISS...';
        }
        updateStats();
      }

      update(_, delta){
        if (!rhythmData.startedAt || rhythmData.finished) return;
        const now = performance.now();
        const elapsed = now - rhythmData.startedAt;
        while (this.scheduleIndex < rhythmData.schedule.length && rhythmData.schedule[this.scheduleIndex].time <= elapsed + 1100){
          this.spawnNote(rhythmData.schedule[this.scheduleIndex].lane);
          this.scheduleIndex++;
        }

        for (let i=this.activeNotes.length-1;i>=0;i--){
          const n = this.activeNotes[i];
          n.y += this.noteSpeed * (delta/1000);
          if (n.y > this.hitY + this.window){
            rhythmData.misses += 1;
            rhythmData.combo = 0;
            statusEl.textContent = 'MISS...';
            n.destroy();
            this.activeNotes.splice(i,1);
            updateStats();
          }
        }

        if (this.scheduleIndex >= rhythmData.schedule.length && this.activeNotes.length === 0) {
          finishRun(this);
        }
      }
    }

    async function startGame(){
      const idx = Number(selectEl.value) || 0;
      const track = tracks[idx] || tracks[0];
      statusEl.textContent = 'ë¡œë”© ì¤‘...';
      startBtn.disabled = true;
      if (activeAudio) { try { activeAudio.pause(); } catch{} }
      destroyGame();

      activeAudio = new Audio(track.url);
      activeAudio.crossOrigin = 'anonymous';

      const loadTimeout = setTimeout(() => {
        handleAudioError('ìŒì› ë¡œë”©ì´ ì§€ì—°ë©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }, 7000);

      const readyHandler = () => {
        clearTimeout(loadTimeout);
        statusEl.textContent = `${track.name} ì¬ìƒ ì‹œì‘! ë³¼ë¥¨ì„ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.`;
        initGameFromAudio();
      };

      activeAudio.addEventListener('loadedmetadata', readyHandler, { once:true });
      activeAudio.addEventListener('canplaythrough', readyHandler, { once:true });
      activeAudio.addEventListener('error', () => {
        clearTimeout(loadTimeout);
        handleAudioError('ìŒì› ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }, { once:true });
      activeAudio.addEventListener('ended', () => finishRun(currentScene));
      activeAudio.load();
    }

    startBtn.addEventListener('click', () => {
      startGame().catch((err) => handleAudioError(err.message || 'íŠ¸ë™ì„ ì¤€ë¹„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
    });
    fillTracks();
    statusEl.textContent = 'D / F / J / K í‚¤ë¡œ íŒì •ì„ ì— ë§ì¶° ëˆ„ë¥´ì„¸ìš”.';
  </script>
</body>
</html>
