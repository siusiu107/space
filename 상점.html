<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIU ìƒì </title>
  <style>
    :root {
      --bg: radial-gradient(circle at top, #0f172a 0%, #020617 60%, #000 100%);
      --card: rgba(3, 7, 18, 0.4);
      --stroke: rgba(255,255,255,0.08);
      --accent: #38bdf8;
      --danger: #f43f5e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .title {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .badge {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 0.78rem;
    }
    .balance-box {
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 12px;
      padding: 10px 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.82rem;
    }
    .balance-label { opacity: 0.7; }
    .balance-value { font-weight: 700; color: #f97316; }
    main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }
    .item {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      backdrop-filter: blur(10px);
    }
    .item-title {
      font-weight: 700;
      font-size: 1rem;
    }
    .item-desc {
      font-size: 0.78rem;
      opacity: 0.75;
      line-height: 1.4;
    }
    .price {
      font-weight: 600;
      font-size: 0.85rem;
      color: #f97316;
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .buy-btn {
      margin-top: 6px;
      border: none;
      background: linear-gradient(120deg, #0ea5e9, #6366f1);
      border-radius: 999px;
      color: #fff;
      padding: 6px 10px;
      font-weight: 600;
      font-size: 0.78rem;
      cursor: pointer;
    }
    .buy-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    footer {
      font-size: 0.7rem;
      opacity: 0.4;
      text-align: center;
      margin-top: auto;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">ğŸ›’ SIU ì´ë²¤íŠ¸ ìƒì </div>
      <div class="badge" id="user-status">ë¡œê·¸ì¸ í™•ì¸ ì¤‘â€¦</div>
    </div>
    <div class="balance-box">
      <span class="balance-label">ì´ë²¤íŠ¸ ì½”ì¸</span>
      <span class="balance-value" id="eco-balance">-</span>
    </div>
  </header>

  <main>
    <!-- 1. 30ë¶„ ì „ì²´ ë²„í”„ ê¶Œí•œë§Œ ê¸°ë¡ -->
    <article class="item">
      <div class="item-title">ì „ì²´ ë²„í”„ 30ë¶„</div>
      <div class="item-desc">
        ê²Œì„ ë°ì´í„°ì— <code>/shop/pendingBuff</code> ìœ¼ë¡œë§Œ ë‚¨ê¹ë‹ˆë‹¤.<br />
        ë©”ì¸ ê²Œì„ì—ì„œ ì´ ê°’ë§Œ ì½ì–´ì„œ ë²„í”„ ì ìš©í•˜ë©´ ë¼.
      </div>
      <div class="price">200 <span style="opacity:0.6;">ì´ë²¤íŠ¸ì½”ì¸</span></div>
      <button class="buy-btn" data-buy="buff_all_30m">êµ¬ë§¤</button>
    </article>

    <!-- 2. ìŠ¤í‚¨ í•´ì œ -->
    <article class="item">
      <div class="item-title">ìš°ì£¼ì„  ìŠ¤í‚¨ í•´ì œ</div>
      <div class="item-desc">
        <code>/shop/skins/space</code> = true ë¡œë§Œ ë‚¨ê¹ë‹ˆë‹¤.<br />
        ë©”ì¸ ê²Œì„ì—ì„œ ì´ ê°’ ìˆìœ¼ë©´ ìŠ¤í‚¨ ë…¸ì¶œ.
      </div>
      <div class="price">300 <span style="opacity:0.6;">ì´ë²¤íŠ¸ì½”ì¸</span></div>
      <button class="buy-btn" data-buy="skin_space">êµ¬ë§¤</button>
    </article>

    <!-- 3. ì¶œì„ê¶Œ ì¶©ì „ -->
    <article class="item">
      <div class="item-title">ì¶œì„ê¶Œ +1</div>
      <div class="item-desc">
        <code>/shop/tickets/daily</code> ë¥¼ +1ë§Œ ì‹œí‚µë‹ˆë‹¤.<br />
        ë©”ì¸ì—ì„œ ì´ ìˆ«ìë§Œí¼ ì†Œëª¨í•˜ë„ë¡ë§Œ ì—°ê²°í•˜ë©´ ë.
      </div>
      <div class="price">150 <span style="opacity:0.6;">ì´ë²¤íŠ¸ì½”ì¸</span></div>
      <button class="buy-btn" data-buy="ticket_daily">êµ¬ë§¤</button>
    </article>
  </main>

  <footer>
    íŒŒì´ì–´ë² ì´ìŠ¤ì— ì§ì ‘ ì“°ëŠ” í˜ì´ì§€. ì˜ì‹¬ë„(/security)ì—ëŠ” <b>ì ˆëŒ€</b> ì ‘ê·¼ ì•ˆ í•¨.
  </footer>

  <script type="module">
    // ğŸ”¥ Firebase ë¶ˆëŸ¬ì˜¤ê¸°
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      update,
      runTransaction,
      push
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // ë©”ì¸ ê²Œì„ì´ë‘ ê°™ì€ ì„¤ì • ì¨ì•¼ ê°™ì€ RTDBë¥¼ ë§Œì§
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const statusEl = document.getElementById("user-status");
    const ecoEl    = document.getElementById("eco-balance");

    // ì‹¤ì œë¡œ íŒ”ë¦¬ëŠ” ì•„ì´í…œ ì •ì˜
    const SHOP_ITEMS = [
      {
        id: "buff_all_30m",
        name: "ì „ì²´ ë²„í”„ 30ë¶„",
        price: 200,
        write: async (basePath) => {
          // ì˜ì‹¬ë„ X, ê²Œì„ë°ì´í„°ë§Œ ì°¸ê³ í•˜ë„ë¡ ë³„ë„ ìœ„ì¹˜ì— ë‚¨ê¹€
          await update(ref(db), {
            [`${basePath}/shop/pendingBuff`]: {
              type: "all",
              value: 0.5,
              durationMs: 30 * 60 * 1000,
              grantedAt: Date.now(),
              from: "shop.html"
            }
          });
        }
      },
      {
        id: "skin_space",
        name: "ìš°ì£¼ì„  ìŠ¤í‚¨",
        price: 300,
        write: async (basePath) => {
          await update(ref(db), {
            [`${basePath}/shop/skins/space`]: true
          });
        }
      },
      {
        id: "ticket_daily",
        name: "ì¶œì„ê¶Œ +1",
        price: 150,
        write: async (basePath) => {
          // ìˆ«ìë§Œ +1 í•˜ë„ë¡ íŠ¸ëœì­ì…˜
          const tRef = ref(db, `${basePath}/shop/tickets/daily`);
          await runTransaction(tRef, (cur) => {
            const v = typeof cur === "number" ? cur : 0;
            return v + 1;
          });
        }
      }
    ];

    let uid = null;
    let userBasePath = null;

    // í˜„ì¬ ì´ë²¤íŠ¸ì½”ì¸ ë‹¤ì‹œ ì½ì–´ì˜¤ê¸°
    async function refreshBalance() {
      if (!userBasePath) return;
      const ecoRef = ref(db, `${userBasePath}/gameData/eventCoins`);
      const snap = await get(ecoRef);
      const val = snap.exists() ? snap.val() : 0;
      ecoEl.textContent = val;
      return val;
    }

    // êµ¬ë§¤ ì²˜ë¦¬
    async function handleBuy(itemId) {
      if (!uid || !userBasePath) {
        alert("ì•„ì§ ë¡œê·¸ì¸/ê²½ë¡œë¥¼ ëª» ì°¾ì•˜ì–´ìš”. ì¡°ê¸ˆ ìˆë‹¤ê°€ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜.");
        return;
      }

      const item = SHOP_ITEMS.find(i => i.id === itemId);
      if (!item) return;

      const ecoRef = ref(db, `${userBasePath}/gameData/eventCoins`);
      let purchaseOk = false;
      let newBalance = 0;

      // ì´ë²¤íŠ¸ ì½”ì¸ë§Œ ì°¨ê°
      await runTransaction(ecoRef, (current) => {
        const cur = typeof current === "number" ? current : Number(current) || 0;
        if (cur < item.price) {
          // ì”ì•¡ ë¶€ì¡± -> ê·¸ëŒ€ë¡œ ë°˜í™˜
          purchaseOk = false;
          return cur;
        }
        purchaseOk = true;
        newBalance = cur - item.price;
        return newBalance;
      });

      if (!purchaseOk) {
        alert("ì´ë²¤íŠ¸ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        await refreshBalance();
        return;
      }

      // ì—¬ê¸°ì„œë¶€í„°ëŠ” â€˜ì˜ì‹¬ë„â€™ë‘ ê´€ë ¨ ì—†ëŠ” ìœ„ì¹˜ì—ë§Œ ì”€
      // êµ¬ë§¤ ë¡œê·¸
      const logKey = push(ref(db, `${userBasePath}/shop/purchases`)).key;
      const payload = {
        itemId: item.id,
        name: item.name,
        price: item.price,
        paidWith: "eventCoins",
        ts: Date.now(),
        // ğŸ‘‡ ì´ê±° ë„£ì–´ë‘ë©´ ë©”ì¸ì—ì„œ ë³¼ ë•Œë„ "ì´ê±´ ìƒì ì—ì„œ ì‚° ê±°" ë¼ê³  êµ¬ë¶„ ê°€ëŠ¥
        suspicionSafe: true,
        source: "shop.html"
      };
      await update(ref(db), {
        [`${userBasePath}/shop/purchases/${logKey}`]: payload
      });

      // ì•„ì´í…œ íš¨ê³¼ ì“°ê¸° (ì „ë¶€ /shop ë°‘ì´ë¼ ì˜ì‹¬ë„ íŠ¸ë¦¬ê±° ì•ˆ ë¨)
      await item.write(userBasePath);

      // ì”ì•¡ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
      await refreshBalance();
      alert("êµ¬ë§¤ ì™„ë£Œ!");
    }

    // ë²„íŠ¼ ë°”ì¸ë”©
    document.querySelectorAll("[data-buy]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-buy");
        handleBuy(id).catch((err) => {
          console.error(err);
          alert("êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”. ì½˜ì†” í™•ì¸í•´ë´.");
        });
      });
    });

    // ë¡œê·¸ì¸ ê°ì§€
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        statusEl.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        ecoEl.textContent = "-";
        uid = null;
        userBasePath = null;
        return;
      }
      uid = user.uid;
      statusEl.textContent = user.email || user.uid;

      // ë©”ì¸ ê²Œì„ì´ë‘ ë˜‘ê°™ì´ userServerMapì—ì„œ ì‹¤ì œ ê²½ë¡œ ì°¾ì•„ì˜´
      const mapSnap = await get(ref(db, `userServerMap/${uid}`));
      if (!mapSnap.exists()) {
        statusEl.textContent = "userServerMap ì—†ìŒ (ë©”ì¸ì—ì„œ í•œ ë²ˆ ë¡œê·¸ì¸í•´)";
        return;
      }
      const mapping = mapSnap.val() || {};
      userBasePath = `users/${mapping.server}/${mapping.id}`;

      await refreshBalance();
    });
  </script>
</body>
</html>
