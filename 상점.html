<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íƒœì–‘ê³„ì •ë³µ - ìƒì </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <!-- Applixir SDK -->
  <script src="https://cdn.applixir.com/applixir.app.v6.0.1.js"></script>

  <style>
    :root{
      --bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      --panel: rgba(8,10,16,0.55);
      --stroke: rgba(255,255,255,0.06);
      --txt: #e2f3ff;
      --muted: #96b7d3;
      --accent: #00d0ff;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px 12px 50px;
    }
    header{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .title-wrap{display:flex;gap:8px;align-items:center;}
    .title-icon{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(180deg,#00d0ff,#0070ff);
      display:flex;align-items:center;justify-content:center;
      color:#001018;font-weight:700;
    }
    .title-main{font-weight:700;}
    .title-sub{font-size:11px;color:var(--muted);}
    .balance{
      display:flex;gap:10px;align-items:center;
    }
    .bal-box{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.03);
      border-radius:12px;
      padding:4px 10px;
      display:flex;gap:6px;align-items:center;
      font-size:12px;
    }
    .bal-label{opacity:.7;}
    .bal-value{font-weight:700;font-variant-numeric:tabular-nums;}
    .layout{
      flex:1;
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      gap:12px;
      min-height:0;
    }
    /* ì™¼ìª½: ê´‘ê³ +ìƒíƒœ */
    .left-panel{
      background:rgba(0,0,0,0.15);
      border:1px solid rgba(255,255,255,0.02);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }
    .section-title{
      font-size:12px;
      opacity:.7;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .card{
      background:rgba(4,6,12,0.35);
      border:1px solid rgba(255,255,255,0.03);
      border-radius:12px;
      padding:7px 10px 8px;
    }
    .big-val{font-size:1.4rem;font-weight:700;}
    .btn{
      background:linear-gradient(180deg,#0ea5e9,#6366f1);
      border:none;
      padding:6px 10px;
      border-radius:999px;
      color:#fff;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .btn:disabled{opacity:.4;cursor:not-allowed;}
    /* ì˜¤ë¥¸ìª½: ìƒì  */
    .shop-panel{
      background:rgba(0,0,0,0.08);
      border:1px solid rgba(255,255,255,0.02);
      border-radius:14px;
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:8px;
    }
    .tab-btn{
      background:rgba(255,255,255,0.01);
      border:1px solid transparent;
      border-radius:999px;
      padding:4px 12px;
      color:var(--txt);
      font-size:12px;
      cursor:pointer;
    }
    .tab-btn.active{
      background:linear-gradient(180deg,rgba(0,208,255,.25),rgba(0,94,191,0));
      border-color:rgba(0,208,255,0.5);
    }
    .items{
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      overflow-y:auto;
    }
    .item{
      width:calc(33.33% - 8px);
      min-width:210px;
      background:radial-gradient(circle at 10% 10%, rgba(255,255,255,0.05), rgba(0,0,0,0));
      border:1px solid rgba(255,255,255,0.03);
      border-radius:12px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item-top{display:flex;gap:8px;}
    .item-icon{
      width:34px;height:34px;border-radius:10px;
      background:rgba(0,208,255,0.12);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }
    .item-name{font-weight:700;}
    .item-desc{font-size:12px;color:var(--muted);line-height:1.3;}
    .price{font-size:11px;display:inline-flex;gap:4px;align-items:center;background:rgba(0,0,0,0.22);border:1px solid rgba(255,255,255,0.03);border-radius:999px;padding:2px 8px;}
    .buy-btn{
      background:linear-gradient(180deg,#00d0ff,#0090ff);
      border:none;
      border-radius:999px;
      padding:6px 10px;
      color:#001018;
      font-weight:700;
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      gap:4px;align-items:center;
    }
    #toast{
      position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
      background:rgba(0,0,0,.8);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:10px;
      padding:6px 12px;
      display:none;
      font-size:12px;
      z-index:9999;
    }
    #applixir_anchor{width:0;height:0;overflow:hidden;}
    @media (max-width:960px){
      .layout{grid-template-columns:1fr;}
      .item{width:calc(50% - 8px);}
    }
    @media (max-width:640px){
      .item{width:100%;}
      header{flex-wrap:wrap;}
      .balance{width:100%;justify-content:flex-end;}
    }
  </style>
</head>
<body>
  <header>
    <div class="title-wrap">
      <div class="title-icon">ğŸ›’</div>
      <div>
        <div class="title-main">SIU í†µí•© ìƒì </div>
        <div class="title-sub">Applixir ê´‘ê³  ì‹œì²­ + ì´ë²¤íŠ¸ì½”ì¸ ìƒì  (ì˜ì‹¬ë„ ë¹„í¬í•¨)</div>
      </div>
    </div>
    <div class="balance">
      <div class="bal-box">
        <span class="bal-label">ì´ë²¤íŠ¸ì½”ì¸</span>
        <span class="bal-value" id="eco-balance">-</span>
      </div>
      <div class="bal-box" id="user-status">ë¡œê·¸ì¸ í™•ì¸ ì¤‘â€¦</div>
    </div>
  </header>

  <div class="layout">
    <!-- ì™¼ìª½: ê´‘ê³  -->
    <div class="left-panel">
      <div class="section-title">
        <span>ğŸ“º ë¦¬ì›Œë“œ ê´‘ê³ </span>
        <small>3íšŒ +1 / 5íšŒ +3</small>
      </div>
      <div class="card">
        <div style="font-size:12px;opacity:.6;">ê´‘ê³  ëˆ„ì  ì‹œì²­ìˆ˜</div>
        <div class="big-val" id="ad-views">-</div>
      </div>
      <div class="card">
        <button id="btn-ad" class="btn" disabled>ê´‘ê³  ì‹œì²­í•˜ê¸°</button>
        <div id="ad-msg" style="font-size:11px;opacity:.6;margin-top:4px;"></div>
      </div>
      <div class="card" style="font-size:11px;opacity:.55;">
        ë³´ìƒì€ <code>/ads/applixir/...</code> ì•„ë˜ì—ë§Œ ê¸°ë¡ë˜ê³ ,<br/>
        <code>/security</code> ë‚˜ ì˜ì‹¬ë„ ê²½ë¡œì—ëŠ” ì „í˜€ ì•ˆ ì”ë‹ˆë‹¤.
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ìƒì  -->
    <div class="shop-panel">
      <div class="tabs">
        <button class="tab-btn active" data-tab="featured">â­ ì¶”ì²œ</button>
        <button class="tab-btn" data-tab="buffs">âš¡ ë²„í”„</button>
        <button class="tab-btn" data-tab="tickets">ğŸŸï¸ í‹°ì¼“/ê¸°íƒ€</button>
      </div>
      <div class="items" id="items"></div>
    </div>
  </div>

  <!-- Applixirê°€ ë¹„ë””ì˜¤ ì£¼ì…í•  ê³³ -->
  <div id="applixir_anchor"></div>

  <div id="toast"></div>

  <script type="module">
    // ===========================================================
    // ==== ì„¤ì • (ì—¬ê¸°ë§Œ ë„¤ í”„ë¡œì íŠ¸ì— ë§ê²Œ ë°”ê¾¸ë©´ ë³€í™˜ ê°€ëŠ¥) ====
    // ===========================================================
    const APPLIXIR_API_KEY = "581358cb-52b3-4c27-a835-44b167debbe4"; // ë„¤ê°€ ì¤€ í‚¤

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    // ===========================================================
    // Firebase ë¶ˆëŸ¬ì˜¤ê¸°
    // ===========================================================
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      update,
      runTransaction,
      push
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const app  = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // DOM ìš”ì†Œ
    const ecoEl    = document.getElementById('eco-balance');
    const userEl   = document.getElementById('user-status');
    const adViewsEl= document.getElementById('ad-views');
    const adBtn    = document.getElementById('btn-ad');
    const adMsg    = document.getElementById('ad-msg');
    const itemsEl  = document.getElementById('items');
    const toastEl  = document.getElementById('toast');

    let uid = null;
    let userBasePath = null; // users/{server}/{id}

    // ===========================================================
    // ìƒì  ì•„ì´í…œ (ì´ë²¤íŠ¸ì½”ì¸ ì „ìš©)
    // ===========================================================
    const SHOP_ITEMS = {
      featured: [
        { id:'buff_all_30m', icon:'ğŸ’«', name:'ì „ì²´ ë²„í”„ 30ë¶„', desc:'/shop/pendingBuff ë¡œ ë‚´ë ¤ê°€ê³ , ë©”ì¸ì—ì„œë§Œ ì‹¤ì œ ì ìš©', priceEvent:3,
          write: async (basePath) => {
            await update(ref(db), {
              [`${basePath}/shop/pendingBuff`]: {
                type:'all',
                value:0.3,
                durationMs:30*60*1000,
                grantedAt:Date.now(),
                source:'shop'
              }
            });
          }
        },
        { id:'res_pack_500', icon:'ğŸª¨', name:'ìì› 500ê¶Œí•œ', desc:'/shop/pendingRes ë¡œë§Œ ë‚¨ê¹€', priceEvent:1,
          write: async (basePath) => {
            await update(ref(db), {
              [`${basePath}/shop/pendingRes`]: {
                amount:500,
                grantedAt:Date.now(),
                source:'shop'
              }
            });
          }
        }
      ],
      buffs: [
        { id:'buff_coin_10m', icon:'ğŸ’°', name:'ì½”ì¸ +50% (10ë¶„)', desc:'ë©”ì¸ì—ì„œë§Œ ì½ë„ë¡ /shop/pendingBuffCoin ì— ì”€', priceEvent:2,
          write: async (basePath) => {
            await update(ref(db), {
              [`${basePath}/shop/pendingBuffCoin`]: {
                value:0.5,
                durationMs:10*60*1000,
                grantedAt:Date.now(),
                source:'shop'
              }
            });
          }
        },
        { id:'buff_res_10m', icon:'ğŸª', name:'ìì› +80% (10ë¶„)', desc:'ìì›ë§Œ ì˜¬ë¦¬ëŠ” ë²„í”„', priceEvent:2,
          write: async (basePath) => {
            await update(ref(db), {
              [`${basePath}/shop/pendingBuffRes`]: {
                value:0.8,
                durationMs:10*60*1000,
                grantedAt:Date.now(),
                source:'shop'
              }
            });
          }
        }
      ],
      tickets: [
        { id:'ticket_daily', icon:'ğŸ°', name:'ì¶œì„ê¶Œ +1', desc:'/shop/tickets/daily ì„ +1ë§Œ í•¨', priceEvent:1,
          write: async (basePath) => {
            const tRef = ref(db, `${basePath}/shop/tickets/daily`);
            await runTransaction(tRef, (cur) => {
              const v = typeof cur === 'number' ? cur : 0;
              return v + 1;
            });
          }
        },
        { id:'skin_space', icon:'ğŸš€', name:'ìš°ì£¼ì„  ìŠ¤í‚¨ í•´ì œ', desc:'/shop/skins/space = true', priceEvent:4,
          write: async (basePath) => {
            await update(ref(db), {
              [`${basePath}/shop/skins/space`]: true
            });
          }
        }
      ]
    };

    // ===========================================================
    // ë Œë”
    // ===========================================================
    function renderTab(tab){
      itemsEl.innerHTML = '';
      const list = SHOP_ITEMS[tab] || [];
      list.forEach(item => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="item-top">
            <div class="item-icon">${item.icon}</div>
            <div>
              <div class="item-name">${item.name}</div>
              <div class="item-desc">${item.desc}</div>
            </div>
          </div>
          <div class="price">ğŸŸï¸ ${item.priceEvent}</div>
          <button class="buy-btn" data-id="${item.id}">êµ¬ë§¤</button>
        `;
        const btn = el.querySelector('.buy-btn');
        btn.addEventListener('click', () => buyItem(tab, item.id));
        itemsEl.appendChild(el);
      });
    }

    // íƒ­ ì´ë²¤íŠ¸
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTab(btn.dataset.tab);
      });
    });

    // ì´ˆê¸° íƒ­
    renderTab('featured');

    // ===========================================================
    // Firebase ë¡œê·¸ì¸ ê°ì§€
    // ===========================================================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        userEl.textContent = "ë¡œê·¸ì¸ í•„ìš”";
        adBtn.disabled     = true;
        return;
      }
      uid = user.uid;
      userEl.textContent = user.email || user.uid;

      // userServerMapì—ì„œ ì‹¤ì œ ê²½ë¡œ ì°¾ê¸°
      const mapSnap = await get(ref(db, `userServerMap/${uid}`));
      if (!mapSnap.exists()) {
        userEl.textContent = "userServerMap ì—†ìŒ(ë©”ì¸ ë¨¼ì €)";
        adBtn.disabled = true;
        return;
      }
      const m = mapSnap.val();
      userBasePath = `users/${m.server}/${m.id}`;

      await Promise.all([
        refreshEventCoins(),
        refreshAdViews()
      ]);

      adBtn.disabled = false;
    });

    async function refreshEventCoins(){
      if (!userBasePath) return;
      const snap = await get(ref(db, `${userBasePath}/gameData/eventCoins`));
      const val = snap.exists() ? snap.val() : 0;
      ecoEl.textContent = Number(val).toLocaleString('ko-KR');
      return Number(val) || 0;
    }

    async function refreshAdViews(){
      if (!userBasePath) return;
      const snap = await get(ref(db, `${userBasePath}/ads/applixir/viewCount`));
      const val = snap.exists() ? snap.val() : 0;
      adViewsEl.textContent = val;
      return Number(val) || 0;
    }

    // ===========================================================
    // ìƒì  êµ¬ë§¤ (ì´ë²¤íŠ¸ì½”ì¸ë§Œ)
    // ===========================================================
    async function buyItem(tab, itemId){
      if (!userBasePath) {
        showToast("ë¡œê·¸ì¸/ê²½ë¡œ í™•ì¸ ì•ˆ ë¨");
        return;
      }
      const item = (SHOP_ITEMS[tab] || []).find(i => i.id === itemId);
      if (!item) return;

      const ecoRef = ref(db, `${userBasePath}/gameData/eventCoins`);
      let ok = false;
      let newBal = 0;
      await runTransaction(ecoRef, (cur) => {
        const v = typeof cur === 'number' ? cur : Number(cur) || 0;
        if (v < item.priceEvent) {
          ok = false;
          return v;
        }
        ok = true;
        newBal = v - item.priceEvent;
        return newBal;
      });

      if (!ok) {
        showToast("ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
        await refreshEventCoins();
        return;
      }

      // êµ¬ë§¤ ë¡œê·¸ (/shop/purchases) - ì˜ì‹¬ë„ X
      const logKey = push(ref(db, `${userBasePath}/shop/purchases`)).key;
      await update(ref(db), {
        [`${userBasePath}/shop/purchases/${logKey}`]: {
          itemId: item.id,
          name: item.name,
          priceEvent: item.priceEvent,
          ts: Date.now(),
          source: "shop",
          suspicionSafe: true
        }
      });

      // ì•„ì´í…œ íš¨ê³¼ ê¸°ë¡ (/shop/... ë°‘ë§Œ)
      await item.write(userBasePath);

      // ì”ì•¡ ë‹¤ì‹œ í‘œì‹œ
      ecoEl.textContent = newBal.toLocaleString('ko-KR');
      showToast("êµ¬ë§¤ ì™„ë£Œ!");
    }

    // ===========================================================
    // ê´‘ê³  ë³´ê¸° (Applixir)
    // ===========================================================
    adBtn.addEventListener('click', () => {
      if (!userBasePath) {
        showToast("ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.");
        return;
      }
      try {
        initializeAndOpenPlayer({
          apiKey: APPLIXIR_API_KEY,
          injectionElementId: "applixir_anchor",
          adStatusCallbackFn: onAdStatus,
          adErrorCallbackFn: onAdError
        });
      } catch (e) {
        console.error(e);
        showToast("ê´‘ê³  ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜");
      }
    });

    function onAdStatus(status){
      console.log("Applixir:", status);
      if (!status || !status.type) return;

      // ê´‘ê³  ì—†ìŒ
      if (status.type === 'allAdsCompleted' && status.noads === true) {
        adMsg.textContent = "ê´‘ê³  ì—†ìŒ (Applixir ì‘ë‹µ)";
        showToast("í˜„ì¬ ë…¸ì¶œí•  ê´‘ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ê´‘ê³  ì™„ì£¼
      if (status.type === 'complete' || status.type === 'allAdsCompleted') {
        adMsg.textContent = "ê´‘ê³  ì‹œì²­ ì™„ë£Œ, ë³´ìƒ ì²˜ë¦¬ ì¤‘â€¦";
        giveAdReward().catch(err => {
          console.error(err);
          showToast("ë³´ìƒ ì²˜ë¦¬ ì˜¤ë¥˜");
        });
      }
    }

    function onAdError(err){
      console.warn("Applixir Error:", err);
      showToast("ê´‘ê³  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      adMsg.textContent = "ê´‘ê³  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
    }

    // ê´‘ê³  ì‹œì²­ í›„: viewCount +1 â†’ 3ë°°ìˆ˜ +1, 5ë°°ìˆ˜ +3
    async function giveAdReward(){
      if (!userBasePath) return;

      const viewRef = ref(db, `${userBasePath}/ads/applixir/viewCount`);
      let finalCount = 0;
      await runTransaction(viewRef, (cur) => {
        const v = typeof cur === 'number' ? cur : Number(cur) || 0;
        finalCount = v + 1;
        return finalCount;
      });

      adViewsEl.textContent = finalCount;

      let reward = 0;
      if (finalCount % 5 === 0) {
        reward = 3;
      } else if (finalCount % 3 === 0) {
        reward = 1;
      }

      if (reward === 0) {
        adMsg.textContent = `ëˆ„ì  ${finalCount}íšŒ (ë³´ìƒ ì—†ìŒ)`;
        return;
      }

      // eventCoins + reward
      const ecoRef = ref(db, `${userBasePath}/gameData/eventCoins`);
      let newBal = 0;
      await runTransaction(ecoRef, (cur) => {
        const v = typeof cur === 'number' ? cur : Number(cur) || 0;
        newBal = v + reward;
        return newBal;
      });

      // ë³´ìƒ ë¡œê·¸ (/ads/... ë°‘)
      const rKey = push(ref(db, `${userBasePath}/ads/applixir/rewards`)).key;
      const ups = {};
      ups[`${userBasePath}/ads/applixir/rewards/${rKey}`] = {
        ts: Date.now(),
        viewCount: finalCount,
        reward,
        currency: 'eventCoins',
        source: 'applixir',
        suspicionSafe: true
      };
      await update(ref(db), ups);

      ecoEl.textContent = newBal.toLocaleString('ko-KR');
      adMsg.textContent = `ëˆ„ì  ${finalCount}íšŒ â†’ ì´ë²¤íŠ¸ì½”ì¸ +${reward}`;
      showToast(`ì´ë²¤íŠ¸ì½”ì¸ ${reward}ê°œ ì§€ê¸‰`);
    }

    // ===========================================================
    // í† ìŠ¤íŠ¸
    // ===========================================================
    let toastTimer = null;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.style.display = 'none';
      }, 2500);
    }
  </script>
</body>
</html>
