<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>이벤트코인 보상 (Applixir • 합법증가)</title>
  <style>
    :root {
      --bg:#0b1220; --panel:#121a2d; --muted:#9fb1d0; --text:#e8f0ff; --accent:#5aa8ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100dvh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(900px 500px at 15% -10%, #1a2b52, transparent 60%),
                  radial-gradient(800px 520px at 110% 110%, #16253e, transparent 60%),
                  var(--bg);
      color:var(--text); font-family: Inter, system-ui, Segoe UI, Apple SD Gothic Neo, Malgun Gothic, Arial, sans-serif;
      padding:24px;
    }
    .box{
      width:100%; max-width:580px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    h1{margin:0 0 8px; font-size:20px}
    .sub{color:var(--muted); font-size:13px; margin-bottom:10px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0}
    .pill{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); padding:8px 12px; border-radius:999px; font-weight:700}
    .btn{cursor:pointer; border:none; background:var(--accent); color:#0b1220; font-weight:800; padding:10px 14px; border-radius:12px}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .mono{font-family:ui-monospace,Consolas,Monaco,monospace}
    .log{margin-top:12px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; max-height:180px; overflow:auto; font-size:12px; color:#cfe2ff}
    .prog{width:100%; height:8px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.12)}
    .prog > i{display:block; height:100%; width:0%; background:var(--accent)}
  </style>
</head>
<body>
  <div class="box">
    <h1>이벤트코인 보상</h1>
    <div class="sub">광고 3회 <b>완료</b> 시 <b>+2 EC</b> • 게임 저장소에 그대로 기록 • 합법증가 흐름 사용</div>

    <div class="row">
      <div class="pill">보유 EC: <span id="ec" class="mono" style="margin-left:6px">—</span></div>
      <button id="btn" class="btn">광고 보기</button>
    </div>

    <div class="row">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted)">
          <div>진행도</div><div><span id="prog-text">0</span> / 3</div>
        </div>
        <div class="prog"><i id="prog-bar"></i></div>
      </div>
    </div>

    <div id="log" class="log mono" aria-live="polite"></div>
  </div>

  <!-- Applixir -->
  <div id="applixir-anchor"></div>
  <script src="https://cdn.applixir.com/applixir.app.v6.0.1.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, get, onValue, runTransaction, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // === Firebase (메인 게임과 동일) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // === 상태 ===
    const API_KEY = "581358cb-52b3-4c27-a835-44b167debbe4";
    const $ec   = document.getElementById('ec');
    const $btn  = document.getElementById('btn');
    const $log  = document.getElementById('log');
    const $pBar = document.getElementById('prog-bar');
    const $pTxt = document.getElementById('prog-text');

    // 진행도는 로컬에만 저장 (서버 의심도 영향 X)
    const LS_KEY = "siu_adTriplet";
    let adProg = Math.max(0, Math.min(2, parseInt(localStorage.getItem(LS_KEY) || "0", 10)));
    let basePath = null;
    let dataRef  = null;
    let securityRef = null;

    const sid = Math.random().toString(36).slice(2, 10);

    function log(t) { $log.textContent = (new Date().toLocaleTimeString() + " " + t + "\\n" + $log.textContent).slice(0, 5000); }
    function setProg(n) {
      adProg = n;
      localStorage.setItem(LS_KEY, String(n));
      $pTxt.textContent = String(n);
      $pBar.style.width = (Math.round((n/3)*100)) + "%";
    }
    setProg(adProg);

    function defaultData() {
      return { resources:0, coins:0, eventCoins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20,
               workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[], _lastUpdated: Date.now() };
    }

    async function resolveBasePath(uid) {
      try {
        const mapSnap = await get(ref(db, `userServerMap/${uid}`));
        if (mapSnap.exists()) {
          const m = mapSnap.val() || {};
          if (m.server && m.id) return `users/${m.server}/${m.id}`;
        }
      } catch {/*ignore*/}
      try {
        const legacy = await get(ref(db, `users/${uid}`));
        if (legacy.exists()) return `users/${uid}`;
      } catch {/*ignore*/}
      throw new Error("게임 데이터를 먼저 생성해 주세요. (메인 게임 1회 실행)");
    }

    function subscribeBalance() {
      onValue(dataRef, (snap) => {
        const v = snap.exists() ? (snap.val() || {}) : {};
        $ec.textContent = String(v.eventCoins || 0);
      });
    }

    async function markAudit(type) {
      try {
        await push(ref(db, `${basePath}/audit/ads`), {
          provider: 'applixir', type, sid, ts: serverTimestamp()
        });
      } catch (e) {/* no-op */}
    }

    async function markSecurity() {
      try {
        await update(securityRef, {
          lastRewardFrom: 'applixir',
          lastRewardAt: serverTimestamp(),
          adSafe: true
        });
      } catch (e) {/* no-op */}
    }

    // 합법증가 경로: 게임이 제공하는 정식 훅이 있으면 그걸 쓰고,
    // 없으면 트랜잭션으로 eventCoins만 +2.
    async function awardEC2Legit() {
      try {
        const before = (typeof makeDeltaSnapshot === 'function') ? makeDeltaSnapshot() : null;

        if (typeof registerAuditIntent === 'function') registerAuditIntent('eco', 2);
        if (typeof auditGain === 'function')           auditGain('eco', 2);

        // 로컬 상태
        window.state = window.state || {};
        window.state.eventCoins = (window.state.eventCoins || 0) + 2;

        if (before && typeof deltaFrom === 'function' && typeof applyPrizeTransaction === 'function') {
          const delta = deltaFrom(before);
          await applyPrizeTransaction(delta);
        } else {
          // fallback: 서버 트랜잭션
          await runTransaction(dataRef, (cur) => {
            if (!cur) cur = defaultData();
            const next = { ...cur };
            next.eventCoins = (next.eventCoins || 0) + 2;
            next._lastUpdated = Date.now();
            return next;
          });
        }

        await Promise.all([ markAudit('triplet-award'), markSecurity() ]);

        if (typeof updateUI === 'function') updateUI();
        if (typeof showToast === 'function') showToast('이벤트코인 +2');

      } catch (e) {
        console.warn('awardEC2Legit error', e);
        if (typeof showToast === 'function') showToast('보상 처리 실패. 다시 시도해 주세요.');
      }
    }

    function playAd() {
      try {
        initializeAndOpenPlayer({
          apiKey: API_KEY,
          injectionElementId: 'applixir-anchor',
          adStatusCallbackFn: async (st) => {
            const t = (st && st.type) ? String(st.type) : String(st);
            if (t === 'loaded')  log('광고 로드됨');
            if (t === 'started') log('광고 시작');
            if (t === 'complete') {
              log('광고 완료 (1회)');
              await markAudit('complete');
              const next = (adProg + 1) % 3;
              setProg(next);
              if (next === 0) await awardEC2Legit();
              else if (typeof showToast === 'function') showToast(`진행도: ${next}/3 (3회마다 +2 EC)`);
            }
            if (t === 'skipped') log('광고 스킵됨 (미지급)');
          },
          adErrorCallbackFn: () => {
            if (typeof showToast === 'function') showToast('지금은 광고 재고가 없어요. 잠시 후 다시 시도해 주세요.');
          }
        });
      } catch(e) {
        console.warn('Applixir init error', e);
        if (typeof showToast === 'function') showToast('플레이어 준비 실패');
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { $ec.textContent = "로그인 필요"; $btn.disabled = true; log("로그인 후 이용하세요."); return; }
      try {
        basePath = await resolveBasePath(user.uid);
        dataRef  = ref(db, `${basePath}/gameData`);
        securityRef = ref(db, `${basePath}/security`);
        subscribeBalance();
        $btn.disabled = false;
        log("준비 완료");
      } catch (e) {
        $ec.textContent = "—";
        $btn.disabled = true;
        log(e.message || "초기화 실패");
      }
    });

    document.getElementById('btn').addEventListener('click', playAd);
  </script>
</body>
</html>
