<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</title>
  <!-- í‘œì‹œ ê²½ë¡œ ê³ ì •: /ê²Œì„ (í˜¸ìŠ¤íŠ¸ëŠ” ë³€ê²½ ë¶ˆê°€) -->
  <script>
    (function(){
      try {
        history.replaceState(null, '', '/ê²Œì„' + (location.hash || ''));
      } catch (e) {
        console.warn('ì£¼ì†Œ í‘œì‹œ ë³€ê²½ ì‹¤íŒ¨:', e);
      }
    })();
  </script>
  <style>
    /* (ìƒëµ: ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼ â€” ë³€ê²½ ì—†ìŒ) */
    body { margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    img { display:block; }
    #top-bar, #container { visibility: hidden; }
    /* ... ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ ìƒëµ (ì›ë³¸ ê·¸ëŒ€ë¡œ) ... */
    /* (ì „ì²´ ìŠ¤íƒ€ì¼ì€ ìœ„ì— ìˆë˜ ê²ƒê³¼ ë™ì¼í•©ë‹ˆë‹¤) */
  </style>
</head>
<body>
  <!-- (HTML êµ¬ì¡°ëŠ” ëª¨ë‘ ë™ì¼ â€” ìƒëµí•˜ì§€ ì•Šì•˜ì§€ë§Œ ì—¬ê¸°ì„  í•µì‹¬ ìŠ¤í¬ë¦½íŠ¸ ê°•ì¡°ë¥¼ ìœ„í•´ ë³¸ë¬¸ì„ ìœ ì§€í•©ë‹ˆë‹¤) -->
  <!-- ì¸ì¦ -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <h2 id="auth-title">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" autocomplete="username" />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <button id="login-btn" class="primary-btn">ë¡œê·¸ì¸</button>
    <button id="signup-btn" class="ghost-btn">íšŒì›ê°€ì…</button>

    <button id="google-btn" aria-label="êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° (ê¶Œì¥)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <!-- êµ¬ê¸€ SVG (ìƒëµ ê°€ëŠ¥) -->
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false">
          <path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/>
          <path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/>
          <path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24c0 3.7 1.1 7.3 3 10.4l7.5-5z"/>
          <path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/>
        </svg>
      </span>
      <span class="g-text">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° <small>(ê¶Œì¥)</small></span>
    </button>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600; box-shadow: 0 2px 6px rgba(0,0,0,0.4);" aria-label="ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° (find.htmlìœ¼ë¡œ ì´ë™)" title="ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);"></div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px; color:#e6f7ff;">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘</div>
            <div id="login-overlay-sub" style="font-size:12px; color:#bcd8ee; margin-top:2px;">ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦</div>
          </div>
        </div>

        <div id="overlay-spinner" style="margin:0 auto 12px;">
          <div class="spinner" aria-hidden="true"></div>
        </div>

        <div style="width:220px; margin:0 auto 10px; background:rgba(255,255,255,0.04); border-radius:8px; padding:6px;">
          <div id="overlay-progress" style="height:8px; width:0%; border-radius:6px; background:linear-gradient(90deg,#00c0ff,#0077ff); transition:width .4s ease;"></div>
        </div>

        <ol id="overlay-steps" style="list-style:none; padding:0; margin:0; font-size:13px; color:#dbefff; max-width:260px;">
          <li data-step="1" style="opacity:0.9; margin-bottom:6px;">1. ì¸ì¦ì°½ ì—´ê¸°</li>
          <li data-step="2" style="opacity:0.6; margin-bottom:6px;">2. ê¶Œí•œ ìš”ì²­</li>
          <li data-step="3" style="opacity:0.4;">3. ë¡œê·¸ì¸ ì™„ë£Œ</li>
        </ol>

        <div id="login-overlay-detail" style="font-size:12px; color:#9fbfda; margin-top:10px; min-height:20px;">ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>

  <!-- (ì´í•˜ ë©”ì¸ UI â€” ìƒëµí•˜ì§€ ì•ŠìŒ, ì›ë³¸ê³¼ ë™ì¼) -->
  <div id="popup-blocker" role="alert" aria-live="assertive">
    <div class="box">
      <h2>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2>
      <p>ì´ í˜ì´ì§€ëŠ” íŒì—… ì°½ìœ¼ë¡œ ì—´ë ¤ì•¼ í•©ë‹ˆë‹¤.<br>í˜„ì¬ëŠ” íŒì—…ì´ ì•„ë‹Œ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ë˜ì—ˆê¸° ë•Œë¬¸ì— ê²Œì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <div>
        <button id="reopen-popup" class="popup-btn primary">íŒì—…ìœ¼ë¡œ ì—´ê¸°</button>
        <button id="close-tab" class="popup-btn ghost">ì´ íƒ­ ë‹«ê¸°</button>
      </div>
      <p style="margin-top:12px;color:#9aa6c4;font-size:13px">íŒì—…ì´ ì°¨ë‹¨ë  ê²½ìš° ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>
    </div>
  </div>

  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ìì›: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ì½”ì¸: 0</span>
    </div>
    <div class="bar-group">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />
      <span id="ship-level">1ë ™ (20ì½”ì¸)</span>
      <button id="upgrade-ship">ì—…ê·¸ë ˆì´ë“œ</button>
    </div>
  </div>

  <div id="container">
    <h1>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</h1>
    <nav>
      <div class="tab active" data-tab="main">ë©”ì¸</div>
      <div class="tab" data-tab="workers">ìš°ì£¼ì¸ ì•Œë°”</div>
      <div class="tab" data-tab="upgrades">í´ë¦­ë‹¹ ì—…ê·¸ë ˆì´ë“œ</div>
      <div class="tab" data-tab="planets">í–‰ì„± êµ¬ë§¤</div>
      <div class="tab" data-tab="reset">ì´ˆê¸°í™”</div>
    </nav>
    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="ê´‘ì„" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ìì› â†’ 1ì½”ì¸</button>
        <button id="auto-convert-buy" class="general">ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>ì´ ì´ˆë‹¹ ìì›: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ì•Œë°” ê³ ìš© (<span id="worker-cost">0</span>ì½”ì¸)</button>
      <p>ì´ ì´ˆë‹¹ ì½”ì¸: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ì½”ì¸ ì•Œë°” (<span id="conversion-cost">0</span>ì½”ì¸)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>í´ë¦­ë‹¹ ìì›: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (15ì½”ì¸)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <div id="reset-content" class="tab-content">
      <button id="reset-button" class="general">ì´ˆê¸°í™”</button>
    </div>

  </div>

  <div id="custom-menu">
    <div class="menu-item" data-action="menu">ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</div>
    <div class="menu-item" data-action="download">â¬‡ï¸ ì•± ë‹¤ìš´ë¡œë“œ</div>
    <div class="menu-item" data-action="resume">â–¶ï¸ ê²Œì„ ê³„ì†í•˜ê¸°</div>
    <div class="menu-item" data-action="rank">ğŸ† ë­í‚¹ ë³´ê¸°</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null; // onValue êµ¬ë… í•´ì œ ë³´ê´€
    let localLastWrite = 0; // ë¡œì»¬ì—ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ë¡í•œ íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)
    let isInitialSync = false; // **ì¶”ê°€: ë¡œê·¸ì¸ ì§í›„ ì´ˆê¸° ë™ê¸°í™” í”Œë˜ê·¸**
    const defaultData = { resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20, workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[] };
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const clickUpgradeCost=15;

    function getWorkerCost() { return Math.floor(initialWorkerCost * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower() { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost() { return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

    function convertResources(maxCount = null) {
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count > 0) {
        state.resources -= count * 10;
        state.coins += count;
      }
    }

    async function ensureInitialData(refPath) {
      try {
        await runTransaction(refPath, current => {
          if (current === null) {
            return { ...defaultData, _lastUpdated: Date.now() };
          }
          return current;
        });
      } catch (err) {
        console.error('ì´ˆê¸°í™” íŠ¸ëœì­ì…˜ ì—ëŸ¬:', err);
      }
    }

    function save() {
      if (!uid || !dataRef) return;
      const now = Date.now();
      state._lastUpdated = now;
      localLastWrite = now;
      try {
        localStorage.setItem(`lastWrite_${uid}`, String(now));
      } catch (e) {}
      const toSave = { ...state };
      update(dataRef, toSave).catch(err => console.error('ì €ì¥ ì—ëŸ¬:', err));
    }

    function friendlyAuthError(err) {
      if (!err || !err.code) return 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      const code = err.code || '';
      switch (code) {
        case 'auth/wrong-password': return 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
        case 'auth/user-not-found': return 'ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íšŒì›ê°€ì…í•´ ì£¼ì„¸ìš”.';
        case 'auth/email-already-in-use': return 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
        case 'auth/invalid-email': return 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        case 'auth/weak-password': return 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
        case 'auth/popup-blocked': return 'íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë°©ë²•ì„ ì‹œë„í•˜ì„¸ìš”.';
        case 'auth/popup-closed-by-user': return 'íŒì—… ì°½ì„ ë‹«ì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        case 'auth/network-request-failed': return 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
        default: return err.message || 'ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }
    }

    const authContainer = document.getElementById('auth-container');
    const authErrorEl = document.getElementById('auth-error');
    const loginOverlay = document.getElementById('login-overlay');

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg;
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      if (isError) {
        authErrorEl.style.color = '#ffdede';
      } else {
        authErrorEl.style.color = '#dfffe8';
      }
    }

    function showLoginOverlay(show, text = 'ë¡œê·¸ì¸ ì¤‘â€¦', opts = {}) {
      const overlay = document.getElementById('login-overlay');
      const title = document.getElementById('login-overlay-title');
      const sub = document.getElementById('login-overlay-sub');
      const detail = document.getElementById('login-overlay-detail');
      const progress = document.getElementById('overlay-progress');
      const provIcon = document.getElementById('overlay-provider-icon');
      const steps = Array.from(document.querySelectorAll('#overlay-steps li'));

      if (!overlay) return;
      if (text) title.textContent = text;
      sub.textContent = opts.subText || 'ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦';
      detail.textContent = opts.detail || 'ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒì—…ì´ ì°¨ë‹¨ë˜ë©´ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';

      provIcon.innerHTML = '';
      if (opts.provider === 'google') {
        provIcon.innerHTML = `...`; // ìƒëµ
        if (!text) title.textContent = 'êµ¬ê¸€ë¡œ ë¡œê·¸ì¸ ì¤‘â€¦';
        sub.textContent = 'êµ¬ê¸€ ì¸ì¦ì°½ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.';
      } else {
        provIcon.textContent = 'ğŸ”’';
        if (!text) title.textContent = 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘â€¦';
        sub.textContent = opts.subText || 'ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦';
      }

      steps.forEach((li) => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
      const activateStep = (n) => {
        steps.forEach((li, idx) => {
          if (idx < n) { li.setAttribute('data-active','true'); li.style.opacity = 1; }
          else { li.removeAttribute('data-active'); li.style.opacity = 0.6; }
        });
      };

      if (show) {
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        activateStep(1); progress.style.width = '24%';
        overlay._progressTimer && clearTimeout(overlay._progressTimer);
        overlay._progressTimer = setTimeout(() => {
          activateStep(2); progress.style.width = '64%';
        }, 800);
        overlay._progressTimer2 && clearTimeout(overlay._progressTimer2);
        overlay._progressTimer2 = setTimeout(() => {
          progress.style.width = '84%';
        }, 1700);
      } else {
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        progress.style.width = '0%';
        steps.forEach(li => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
        overlay._progressTimer && clearTimeout(overlay._progressTimer);
        overlay._progressTimer2 && clearTimeout(overlay._progressTimer2);
      }

      overlay.success = (msg) => {
        title.textContent = msg || 'ë¡œê·¸ì¸ ì™„ë£Œ';
        detail.textContent = 'ì•ˆì „í•˜ê²Œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
        activateStep(3); progress.style.width = '100%';
        setTimeout(() => { showLoginOverlay(false); }, 900);
      };
      overlay.fail = (msg) => {
        title.textContent = msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        detail.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        progress.style.width = '6%';
        overlay.style.boxShadow = '0 6px 20px rgba(255,0,0,0.12)';
        setTimeout(() => { overlay.style.boxShadow = ''; showLoginOverlay(false); }, 1400);
      };
    }

    // onAuthStateChanged: êµ¬ë… í•´ì œ -> ë¡œê·¸ì¸ ì²˜ë¦¬ -> ì´ˆê¸° ë™ê¸°í™” í”Œë˜ê·¸ ì²˜ë¦¬
    onAuthStateChanged(auth, async user => {
      showAuthStatus('');
      if (dataUnsubscribe) {
        try { dataUnsubscribe(); } catch (e) {}
        dataUnsubscribe = null;
      }

      if (user) {
        uid = user.uid;
        dataRef = ref(db, `users/${uid}/gameData`);

        // ë¡œê·¸ì¸ ì§í›„ ì´ˆê¸° ë™ê¸°í™” í”Œë˜ê·¸ í™œì„±í™”
        isInitialSync = true;

        // ê³„ì •ë³„ lastWrite ë¶ˆëŸ¬ì˜¤ê¸°
        try {
          const saved = localStorage.getItem(`lastWrite_${uid}`);
          localLastWrite = saved ? parseInt(saved, 10) : 0;
        } catch (e) { localLastWrite = 0; }

        showLoginOverlay(false);
        authContainer.classList.add('hidden');
        setTimeout(() => {
          authContainer.style.display = 'none';
          document.getElementById('logout-btn').style.display = 'block';
          ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'visible');
        }, 340);

        await ensureInitialData(dataRef);

        // ì•ˆì „í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ: ì´ˆê¸° ë™ê¸°í™” ì‹œì—ëŠ” ì„œë²„ ìš°ì„ (ì €ì¥ ê¸ˆì§€), ì´ˆê¸° ë™ê¸°í™” ëë‚œ ë’¤ ì¶©ëŒ ì²˜ë¦¬ í—ˆìš©
        dataUnsubscribe = onValue(dataRef, snap => {
          const server = snap.exists() ? snap.val() : null;
          if (!server) {
            // ì„œë²„ì— ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ì„ ë•Œ: ì´ˆê¸° ë™ê¸°í™” ì¤‘ì´ë©´ ë¡œì»¬ ê¸°ë³¸ê°’ ìœ ì§€í•˜ë˜ 'ë®ì–´ì“°ê¸°'ëŠ” í•˜ì§€ ì•ŠìŒ
            if (isInitialSync) {
              state = { ...defaultData };
              updateUI(); renderPlanets();
              isInitialSync = false; // ì´ˆê¸° ë™ê¸°í™” ë
              return;
            } else {
              // ì´í›„ë¼ë©´ ì—­ì‹œ ì•ˆì „í•˜ê²Œ ê¸°ë³¸ê°’ ì ìš© (í•„ìš”ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦´ ìˆ˜ ìˆìŒ)
              state = { ...defaultData };
              updateUI(); renderPlanets();
              return;
            }
          }

          const serverLast = server._lastUpdated || 0;

          if (isInitialSync) {
            // **ì´ˆê¸° ë™ê¸°í™”**: ì„œë²„ê°€ ì¡´ì¬í•˜ë©´ ë¬´ì¡°ê±´ ì„œë²„ ìš°ì„ ìœ¼ë¡œ ë®ì–´ì”€(ì €ì¥ ê¸ˆì§€)
            state = { ...defaultData, ...server };
            updateUI(); renderPlanets();
            isInitialSync = false;
            return;
          }

          // ì´ˆê¸° ë™ê¸°í™”ê°€ ëë‚œ ì´í›„ì˜ ì¼ë°˜ ì¶©ëŒ ì²˜ë¦¬ ë¡œì§
          if (serverLast >= (localLastWrite || 0)) {
            // ì„œë²„ê°€ ìµœì‹  ë˜ëŠ” ë™ì¼ -> ì„œë²„ë¥¼ ì‹ ë¢°
            state = { ...defaultData, ...server };
          } else {
            // ë¡œì»¬ì´ ìµœì‹ : ë¡œì»¬ì„ ì„œë²„ì— ë‹¤ì‹œ ì“´ë‹¤(ì¶©ëŒí•´ê²°)
            state = { ...defaultData, ...server, ...state };
            // ì•ˆì „ì„±: ì‹¤ì œë¡œ ë¡œì»¬ì´ ì„œë²„ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì €ì¥
            try {
              const serverStr = JSON.stringify(server);
              const localStr = JSON.stringify(state);
              if (localStr !== serverStr) {
                save(); // ë¡œì»¬ì„ ì„œë²„ì— ë°˜ì˜
              }
            } catch (e) {
              // ì§ë ¬í™” ì—ëŸ¬ ë°œìƒ ì‹œë¼ë„ ê¸°ë³¸ì ìœ¼ë¡œ save í˜¸ì¶œ
              save();
            }
          }
          updateUI(); renderPlanets();
        });

      } else {
        // ë¡œê·¸ì•„ì›ƒ: ì•ˆì „í•˜ê²Œ ë¡œì»¬ ìƒíƒœ ì´ˆê¸°í™”
        uid = null; dataRef = null;
        state = { ...defaultData };
        localLastWrite = 0;
        isInitialSync = false;
        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        document.getElementById('logout-btn').style.display = 'none';
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
      }
    });

    // (ì´í•˜ ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬/ê²Œì„ ë¡œì§ â€” êµ¬ì¡°/UI ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    document.getElementById('login-btn').addEventListener('click', async () => {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        showLoginOverlay(true, 'ë¡œê·¸ì¸ ì¤‘â€¦ ì ì‹œë§Œìš”');
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.warn(err);
        showLoginOverlay(false);
        showAuthStatus(friendlyAuthError(err));
      }
    });

    document.getElementById('signup-btn').addEventListener('click', async (e) => {
      e.preventDefault(); showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        showLoginOverlay(true, 'ê³„ì • ìƒì„± ì¤‘â€¦');
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.warn(err);
        showLoginOverlay(false);
        showAuthStatus(friendlyAuthError(err));
      }
    });

    const googleBtn = document.getElementById('google-btn');
    if (googleBtn) {
      googleBtn.addEventListener('click', async () => {
        showAuthStatus('');
        const provider = new GoogleAuthProvider();
        try {
          showLoginOverlay(true, 'êµ¬ê¸€ ì¸ì¦ ì‹œì‘', { provider: 'google', subText: 'êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì—°ê²°í•©ë‹ˆë‹¤.', detail: 'êµ¬ê¸€ íŒì—…ì´ ì—´ë¦¬ë©´ ê³„ì •ì„ ì„ íƒí•˜ê³  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' });
          await signInWithPopup(auth, provider);
          const overlay = document.getElementById('login-overlay');
          overlay && overlay.success && overlay.success('ë¡œê·¸ì¸ ì™„ë£Œ â€” í™˜ì˜í•©ë‹ˆë‹¤');
        } catch (err) {
          console.warn('signInWithPopup ì‹¤íŒ¨, signInWithRedirectë¡œ í´ë°±:', err);
          try {
            showLoginOverlay(true, 'ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ ì¤‘', { provider: 'google', subText: 'ë¸Œë¼ìš°ì € ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.' });
            await signInWithRedirect(auth, provider);
          } catch (err2) {
            showLoginOverlay(false);
            showAuthStatus(friendlyAuthError(err2));
          }
        }
      });
    }

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    function updateUI() {
      document.getElementById('score').innerText = `ìì›: ${Math.floor(state.resources)}`;
      document.getElementById('coins').innerText = `ì½”ì¸: ${Math.floor(state.coins)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}ë ™ (${state.shipUpgradeCost}ì½”ì¸)`;
      document.getElementById('ship-img').src = `/images/ship-level${state.shipLevel}.png`;
      document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

      const clickUp = document.getElementById('click-upgrade');
      clickUp.innerText = `í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (${clickUpgradeCost}ì½”ì¸)`;
      clickUp.disabled = state.coins < clickUpgradeCost;
      document.getElementById('click-power').innerText = state.clickPower;

      const autoBtn = document.getElementById('auto-convert-buy');
      autoBtn.innerHTML = state.autoConvertBought ? 'êµ¬ë§¤ ì™„ë£Œ' : 'ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)';
      autoBtn.disabled = state.autoConvertBought || state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ì•Œë°” ê³ ìš© (${getWorkerCost()}ì½”ì¸)`;
      hireWork.disabled = state.coins < getWorkerCost();
      document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower()).toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ì½”ì¸ ì•Œë°” (${getConversionCost()}ì½”ì¸)`;
      hireConv.disabled = state.coins < getConversionCost();
      document.getElementById('coin-per-sec').innerText = state.conversionCount;
    }

    function renderPlanets() {
      const planets = [ {name:'ë‹¬',cost:100,requiredShipLevel:1}, {name:'ìˆ˜ì„±',cost:500,requiredShipLevel:2}, {name:'ê¸ˆì„±',cost:2000,requiredShipLevel:3}, {name:'ì§€êµ¬',cost:10000,requiredShipLevel:4}, {name:'í™”ì„±',cost:50000,requiredShipLevel:5}, {name:'ëª©ì„±',cost:250000,requiredShipLevel:6}, {name:'í† ì„±',cost:1000000,requiredShipLevel:7}, {name:'ì²œì™•ì„±',cost:5000000,requiredShipLevel:8}, {name:'í•´ì™•ì„±',cost:20000000,requiredShipLevel:9} ];
      const list = document.getElementById('planet-list'); list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.innerHTML = `<strong>${p.name}</strong> â€” ${p.cost.toLocaleString()}ì½”ì¸<br>í•„ìš” ë ™: ${p.requiredShipLevel}`;
        const btn = document.createElement('button'); btn.className = 'general'; btn.textContent = owned ? 'êµ¬ë§¤ ì™„ë£Œ' : (canBuy ? 'êµ¬ë§¤' : 'ë ™ ë¶€ì¡±'); btn.disabled = owned || !canBuy;
        btn.onclick = () => { if (state.coins >= p.cost) { state.coins -= p.cost; if (!state.ownedPlanets) state.ownedPlanets = []; state.ownedPlanets.push(i); save(); updateUI(); renderPlanets(); if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html'; } };
        div.appendChild(btn); list.appendChild(div);
      });
    }

    function spawnParticles(x,y) { for (let i=0;i<15;i++){ const span = document.createElement('span'); span.className='particle'; span.style.setProperty('--dx',(Math.random()-0.5)*100+'px'); span.style.setProperty('--dy',(Math.random()-1)*100+'px'); span.style.left = x+'px'; span.style.top = y+'px'; document.getElementById('ore-container').appendChild(span); setTimeout(()=>span.remove(),800); } }

    window.onload = () => {
      document.getElementById('ore').addEventListener('click', e => { const rect = e.target.getBoundingClientRect(); spawnParticles(e.clientX - rect.left, e.clientY - rect.top); state.resources += state.clickPower; if (state.autoConvertBought) convertResources(); save(); updateUI(); });
      document.getElementById('convert-button').addEventListener('click', () => { convertResources(1); save(); updateUI(); });
      document.getElementById('auto-convert-buy').addEventListener('click', () => { if (!state.autoConvertBought && state.coins >= 100) { state.coins -= 100; state.autoConvertBought = true; save(); updateUI(); } });
      document.getElementById('hire-worker').addEventListener('click', () => { const cost = getWorkerCost(); if (state.coins >= cost) { state.coins -= cost; state.workerCount++; save(); updateUI(); } });
      document.getElementById('hire-conversion').addEventListener('click', () => { const cost = getConversionCost(); if (state.coins >= cost) { state.coins -= cost; state.conversionCount++; save(); updateUI(); } });
      document.getElementById('upgrade-ship').addEventListener('click', () => { if (state.coins >= state.shipUpgradeCost) { state.coins -= state.shipUpgradeCost; state.shipLevel++; state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30); save(); updateUI(); renderPlanets(); } });
      document.getElementById('click-upgrade').addEventListener('click', () => { if (state.coins >= clickUpgradeCost) { state.coins -= clickUpgradeCost; state.clickPower++; save(); updateUI(); } });
      document.getElementById('reset-button').addEventListener('click', () => { if (confirm('ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { state = { ...defaultData }; save(); updateUI(); renderPlanets(); } });
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tab.dataset.tab}-content`).classList.add('active'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); }));

      setInterval(() => {
        if (!uid) return;
        if (state.workerCount > 0) state.resources += state.workerCount * getWorkerPower();
        if (state.conversionCount > 0) state.coins += state.conversionCount;
        if (state.autoConvertBought) convertResources();
        save();
        updateUI();
      }, 1000);
    };
  </script>

  <!-- (ì´í•˜ íŒì—… ê²€ì‚¬Â·ì»¤ìŠ¤í…€ ë©”ë‰´ ë“±ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€) -->
  <script>
    (function() {
      const EXPECTED_POPUP_NAME = 'gameWindow';
      const BLOCKER_ID = 'popup-blocker';
      let blocker = document.getElementById(BLOCKER_ID);
      let blockerTemplate = blocker ? blocker.cloneNode(true) : null;
      let allowUnload = false;
      function allowTemporaryUnload(ms = 1000) { allowUnload = true; setTimeout(() => { allowUnload = false; }, ms); }
      window.addEventListener('beforeunload', (e) => { if (allowUnload) return; e.preventDefault(); e.returnValue = ''; return ''; });
      function isOpenedAsPopup() {
        try { if (window.opener && !window.opener.closed) { try { if (window.opener.location && window.opener.location.origin === location.origin) return true; } catch (e) { return true; } } } catch (e) {}
        if (window.name === EXPECTED_POPUP_NAME) return true;
        if (location.search.includes('popup=1') || location.hash.includes('popup=1')) return true;
        try { if (window.outerWidth && window.outerHeight) { const smallWidth = screen.width - 100; const smallHeight = screen.height - 100; if (window.outerWidth <= smallWidth || window.outerHeight <= smallHeight) return true; } } catch (e) {}
        try { if (window.self !== window.top) return false; } catch (e) {}
        return false;
      }
      function showBlocker() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) { if (blockerTemplate) { document.body.appendChild(blockerTemplate.cloneNode(true)); } else { const div = document.createElement('div'); div.id = BLOCKER_ID; div.setAttribute('role','alert'); div.className = ' active'; div.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:3000;padding:20px;'; div.innerHTML = '<div class="box" style="max-width:560px;background:#0b0b0f;border:1px solid #222;padding:24px;border-radius:10px;color:#ddd;text-align:center;"><h2 style="color:#ffcc00;margin-bottom:10px">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2><p style="margin-bottom:16px;color:#bbb">ì´ í˜ì´ì§€ëŠ” íŒì—… ì°½ìœ¼ë¡œ ì—´ë ¤ì•¼ í•©ë‹ˆë‹¤.<br>í˜„ì¬ëŠ” íŒì—…ì´ ì•„ë‹Œ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ë˜ì—ˆê¸° ë•Œë¬¸ì— ê²Œì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><div><button id="reopen-popup" class="popup-btn primary" style="padding:10px 14px;border-radius:8px;border:0;margin:6px;font-weight:700">íŒì—…ìœ¼ë¡œ ì—´ê¸°</button><button id="close-tab" class="popup-btn ghost" style="padding:10px 14px;border-radius:8px;border:1px solid #444;margin:6px;background:transparent;color:#fff">ì´ íƒ­ ë‹«ê¸°</button></div><p style="margin-top:12px;color:#9aa6c4;font-size:13px">íŒì—…ì´ ì°¨ë‹¨ë  ê²½ìš° ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p></div>'; document.body.appendChild(div); } blocker = document.getElementById(BLOCKER_ID); bindBlockerButtons(); } blocker.classList.add('active'); blocker.style.display = 'flex'; blocker.style.pointerEvents = 'auto'; blocker.style.zIndex = '999999'; } catch (e) { console.error('showBlocker error', e); } }
      function hideBlocker() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) return; blocker.classList.remove('active'); blocker.style.display = 'none'; } catch (e) {} }
      function tryOpenPopupFromThisTab() { const w = 1024, h = 768; const left = Math.max(0, Math.round((screen.width - w) / 2)); const top  = Math.max(0, Math.round((screen.height - h) / 2)); const opts = `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no`; const popup = window.open(window.location.href + (location.search ? '&' : '?') + 'popup=1', EXPECTED_POPUP_NAME, opts); if (!popup) { alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.'); return; } try { popup.focus(); } catch(e) {} setTimeout(()=>{ try{ allowTemporaryUnload(1500); window.close(); } catch(e){} }, 300); }
      function bindBlockerButtons() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) return; const reopenBtn = blocker.querySelector('#reopen-popup'); const closeBtn = blocker.querySelector('#close-tab'); if (reopenBtn) { reopenBtn.addEventListener('click', tryOpenPopupFromThisTab); } if (closeBtn) { closeBtn.addEventListener('click', function(){ try{ allowTemporaryUnload(1500); window.close(); } catch(e){} }); } } catch (e) {} }
      function setupMutationProtection() { blocker = document.getElementById(BLOCKER_ID); if (blocker && !blockerTemplate) blockerTemplate = blocker.cloneNode(true); const watchTargets = ['auth-container','top-bar','container', BLOCKER_ID]; const body = document.body; const observer = new MutationObserver((mutations) => { try { let shouldRestoreBlocker = false; for (const m of mutations) { if (m.type === 'childList') { for (const n of m.removedNodes) { if (n && n.id === BLOCKER_ID) shouldRestoreBlocker = true; } const b = document.getElementById(BLOCKER_ID); if (!b) shouldRestoreBlocker = true; } if (m.type === 'attributes' && (m.target && (m.target.id === BLOCKER_ID || watchTargets.includes(m.target.id)))) { const t = m.target; const style = window.getComputedStyle(t); if (!isOpenedAsPopup() && (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity || '1') < 0.1)) { shouldRestoreBlocker = true; } } } if (!isOpenedAsPopup()) { const b = document.getElementById(BLOCKER_ID); if (!b) shouldRestoreBlocker = true; else { const cs = window.getComputedStyle(b); if (cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity || '1') < 0.1) shouldRestoreBlocker = true; } } if (shouldRestoreBlocker) { showBlocker(); bindBlockerButtons(); } } catch (e) { console.error('mutation observer error', e); } }); observer.observe(body, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'], attributeOldValue:true }); setInterval(() => { try { if (!isOpenedAsPopup()) { const b = document.getElementById(BLOCKER_ID); if (!b) { showBlocker(); bindBlockerButtons(); return; } const cs = window.getComputedStyle(b); if (cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity || '1') < 0.1) { showBlocker(); bindBlockerButtons(); return; } const z = parseInt((b.style.zIndex || '0').replace(/[^0-9]/g,'')) || 0; if (z < 99999) { b.style.zIndex = '999999'; } } else { const b = document.getElementById(BLOCKER_ID); if (b) { hideBlocker(); } } } catch (e) {} }, 600); }
      document.addEventListener('DOMContentLoaded', () => { blocker = document.getElementById(BLOCKER_ID); if (blocker && !blockerTemplate) blockerTemplate = blocker.cloneNode(true); if (!isOpenedAsPopup()) { showBlocker(); } else { hideBlocker(); console.log('íŒì—…ìœ¼ë¡œ ì—´ë¦¼ â€” ê²Œì„ ì‹¤í–‰ í—ˆìš© (íŒì—… ê²€ì‚¬ í†µê³¼)'); } bindBlockerButtons(); setupMutationProtection(); });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({ disableMenu: true, disableSelect: true, disableCopy: true, disableCut: true, disablePaste: true, clearIntervalWhenDevOpenTrigger: true, ondevtoolopen(type, next) { window.close(); next(); }, ondevtoolclose() { console.warn('DevTools ë‹«í˜ ê°ì§€ë¨'); } });

    const customMenu = document.getElementById('custom-menu');
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    });

    customMenu.addEventListener('click', async (e) => {
      const target = e.target;
      const action = target.getAttribute('data-action');
      if (!action) return;

      if (action === 'menu') {
        try {
          if (window.opener && !window.opener.closed) {
            try { window.opener.focus(); } catch (err) { }
          }
        } catch (err) { }

        try {
          window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*');
        } catch (err) { }

        try { window.close(); } catch (err) { }

        setTimeout(() => {
          try {
            if (!window.closed) {
              window.location.href = '/index.html';
            }
          } catch (err) {
            try { window.open('/index.html', '_self'); } catch (e) { }
          }
        }, 250);
        return;
      }

      if (action === 'download') {
        try {
          window.location.href = '/app-download.html';
        } catch (err) {
          try { window.open('/app-download.html', '_self'); } catch (e) { }
        }
        return;
      }

      if (action === 'resume') {
        customMenu.style.display = 'none';
        return;
      }
      if (action === 'rank') {
        window.location.href = '/ranking.html';
        return;
      }
    });

    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display = 'none'; });

    document.addEventListener('contextmenu', function (e) {
      if (e.target.closest('input, textarea, [contenteditable="true"]')) return;
      e.preventDefault();
    });
  </script>
</body>
</html>
