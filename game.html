<!DOCTYPE html>   <html lang="ko">  <head>  Â  <meta charset="UTF-8" />  Â  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

Â  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</title>

Â  <!-- ìµœì´ˆ ì ‘ì† ì‹œ /loginìœ¼ë¡œ í•œë²ˆë§Œ ë¼ìš°íŒ… -->

Â  <script>

Â  Â  try {

Â  Â  Â  if (!sessionStorage.getItem('pmode_init')) {

Â  Â  Â  Â  history.replaceState(null, '', '/login' + (location.hash || ''));

Â  Â  Â  Â  sessionStorage.setItem('pmode_init', '1');

Â  Â  Â  }

Â  Â  } catch (e) {}

Â  </script>

Â  <!-- íŒì—…/ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¶€ëª¨ ë³´ì•ˆ ì•Œë¦¼/í—ˆìš© ë„ë©”ì¸ -->

Â  <script>

Â  Â  const allowedParentOrigins = [

Â  Â  Â  location.origin,

Â  Â  Â  'https://xn--989a202a4ogwtc69p.siustudio.kro.kr',

Â  Â  Â  'https://siustudio.kro.kr'

Â  Â  ];

Â  Â  function isAllowedRedirect(urlStr) {

Â  Â  Â  try {

Â  Â  Â  Â  const u = new URL(urlStr);

Â  Â  Â  Â  if (u.protocol !== 'https:') return false;

Â  Â  Â  Â  const host = u.hostname;

Â  Â  Â  Â  const base1 = 'xn--989a202a4ogwtc69p.siustudio.kro.kr';

Â  Â  Â  Â  const base2 = 'siustudio.kro.kr';

Â  Â  Â  Â  return (host === base1 || host === base2 ||

Â  Â  Â  Â  Â  host.endsWith('.' + base1) || host.endsWith('.' + base2));

Â  Â  Â  } catch { return false; }

Â  Â  }

Â  Â  let parentOrigin     = sessionStorage.getItem('parent_origin')     || null;

Â  Â  let pendingRedirect  = sessionStorage.getItem('pending_redirect')  || null;

Â  Â  let pendingState     = sessionStorage.getItem('pending_state')     || null;

Â  Â  function consumePendingRedirect() {

Â  Â  Â  let target = null;

Â  Â  Â  try {

Â  Â  Â  Â  const fromStorage = sessionStorage.getItem('pending_redirect');

Â  Â  Â  Â  if (fromStorage) {

Â  Â  Â  Â  Â  sessionStorage.removeItem('pending_redirect');

Â  Â  Â  Â  Â  target = fromStorage;

Â  Â  Â  Â  }

Â  Â  Â  } catch {}

Â  Â  Â  if (!target && pendingRedirect) target = pendingRedirect;

Â  Â  Â  pendingRedirect = null;

Â  Â  Â  return (target && isAllowedRedirect(target)) ? target : null;

Â  Â  }

Â  Â  function notifyReadyToParent() {

Â  Â  Â  try {

Â  Â  Â  Â  if (window.opener && !window.opener.closed) {

Â  Â  Â  Â  Â  allowedParentOrigins.forEach((o) => {

Â  Â  Â  Â  Â  Â  try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }

Â  Â  Â  } catch {}

Â  Â  }

Â  Â  notifyReadyToParent();

Â  Â  function notifyAuthSuccessAndExit() {

Â  Â  Â  const target = consumePendingRedirect();

Â  Â  Â  const hasParent = window.opener && !window.opener.closed && parentOrigin;

Â  Â  Â  if (hasParent) {

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  window.opener.postMessage({

Â  Â  Â  Â  Â  Â  type: 'auth-success', ok: true, redirect: target || undefined, receivedState: pendingState

Â  Â  Â  Â  Â  }, parentOrigin);

Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  try { window.close(); } catch {}

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  if (target) window.location.href = target;

Â  Â  }

Â  Â  window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;

Â  </script>

Â  <style>

Â  Â  :root{

Â  Â  Â  --glass-bg: rgba(10,12,20,0.40);

Â  Â  Â  --glass-brd: rgba(255,255,255,0.08);

Â  Â  Â  --accent: #00d4ff;

Â  Â  }

Â  Â  body { margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat; color:#fff; }

Â  Â  img { display:block; }

Â  Â  /* ë¶€íŒ…/ìŠ¤í”¼ë„ˆ */

Â  Â  #top-bar, #container { visibility: hidden; }

Â  Â  .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }

Â  Â  @keyframes spin { to { transform:rotate(360deg); } }

Â  Â  #boot-overlay{

Â  Â  Â  position:fixed; inset:0; z-index:3000;

Â  Â  Â  display:flex; align-items:center; justify-content:center;

Â  Â  Â  background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));

Â  Â  Â  backdrop-filter: blur(3px);

Â  Â  }

Â  Â  #boot-overlay .card{

Â  Â  Â  width:min(420px,92vw); border-radius:14px;

Â  Â  Â  border:1px solid rgba(255,255,255,0.10);

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));

Â  Â  Â  padding:16px; text-align:center; color:#e6f7ff;

Â  Â  Â  box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);

Â  Â  }

Â  Â  /* ë¡œê·¸ì¸ ì¹´ë“œ */

Â  Â  #auth-container {

Â  Â  Â  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;

Â  Â  Â  width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));

Â  Â  Â  box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);

Â  Â  Â  backdrop-filter: blur(6px);

Â  Â  Â  transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;

Â  Â  Â  display:none;

Â  Â  }

Â  Â  #auth-container.hidden { opacity:0; transform: translate(-50%, -46%) scale(.98); pointer-events:none; visibility:hidden; }

Â  Â  #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }

Â  Â  #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20); color:#fff; outline:none; font-size:14px; }

Â  Â  #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.22); }

Â  Â  #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }

Â  Â  #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer; }

Â  Â  .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }

Â  Â  .auth-status.show { opacity:1; transform:translateY(0); }

Â  Â  .login-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60)); border-radius:14px; z-index:1100; opacity:1; pointer-events:auto; }

Â  Â  .login-overlay.show { display:flex; }

Â  Â  .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

Â  Â  .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }

Â  Â  .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }

Â  Â  .google-btn small { font-weight:600; color:#666; font-size:11px; }

Â  Â  @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

Â  Â  /* ìƒë‹¨ ë°” */

Â  Â  #top-bar {

Â  Â  Â  position: fixed; top: 5px; left: 5px; right: 5px;

Â  Â  Â  display: flex; flex-wrap: wrap; gap:6px 8px;

Â  Â  Â  justify-content: space-between; align-items: center;

Â  Â  Â  background: rgba(30,30,30,0.55);

Â  Â  Â  padding:6px 10px; border-radius:8px;

Â  Â  Â  font-size:12px; z-index:1000;

Â  Â  Â  border: 1px solid rgba(255,255,255,0.08);

Â  Â  Â  white-space: nowrap;

Â  Â  Â  overflow: hidden;

Â  Â  }

Â  Â  .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden; }

Â  Â  .bar-group img { width:16px; height:16px; }

Â  Â  .bar-group span { white-space: nowrap; }

Â  Â  #ship-img{ width:16px; height:16px; }

Â  Â  #settings-btn {

Â  Â  Â  margin-left: 8px; padding: 6px 10px; border-radius: 8px;

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));

Â  Â  Â  border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;

Â  Â  Â  cursor: pointer; font-weight: 700;

Â  Â  }

Â  Â  #settings-btn:hover { filter: brightness(1.08); }

Â  Â  /* ì˜ì‹¬ë„ ë°°ì§€: ìš”êµ¬ì‚¬í•­ëŒ€ë¡œ ì™„ì „ ìˆ¨ê¹€ */

Â  Â  #suspicion-badge{ display:none !important; }

Â  Â  /* ë³¸ë¬¸ */

Â  Â  #container { margin:56px auto 20px; width:90%; max-width:640px; padding:16px 20px; background:rgba(30,30,30,0.55); border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.08); }

Â  Â  h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }

Â  Â  button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }

Â  Â  button.general:disabled { opacity:0.5; cursor:not-allowed; }

Â  Â  .tab-content { display:none; margin-top:12px; }

Â  Â  .tab-content.active { display:block; }

Â  Â  .particle { position:absolute; width:6px; height:6px; background:#ffd700; border-radius:50%; opacity:.8; animation:floatUp .8s ease-out forwards; pointer-events:none; }

Â  Â  @keyframes floatUp { to { transform: translate(var(--dx),var(--dy)) scale(0); opacity:0; } }

Â  Â  #ore { width:200px; cursor:pointer; }

Â  Â  /* ìš°í´ë¦­ ë©”ë‰´ */

Â  Â  #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.90); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }

Â  Â  #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; }

Â  Â  #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }

Â  Â  #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

Â  Â  /* ë°”í…€ ë‚´ë¹„ */

Â  Â  #bottom-nav{

Â  Â  Â  position: fixed;

Â  Â  Â  left: 50%; bottom: max(12px, env(safe-area-inset-bottom, 12px));

Â  Â  Â  transform: translateX(-50%);

Â  Â  Â  display: flex; gap: 8px; padding: 8px;

Â  Â  Â  background: var(--glass-bg); backdrop-filter: blur(10px);

Â  Â  Â  border: 1px solid var(--glass-brd);

Â  Â  Â  border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);

Â  Â  Â  z-index: 1200; max-width: 96vw;

Â  Â  }

Â  Â  #bottom-nav .tab{

Â  Â  Â  display: inline-flex; align-items: center; justify-content: center;

Â  Â  Â  gap: 6px; min-width: 70px; padding: 10px 12px; font-size: 13px;

Â  Â  Â  color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));

Â  Â  Â  border: 1px solid rgba(255,255,255,0.06); transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;

Â  Â  }

Â  Â  #bottom-nav .tab:hover{ transform: translateY(-1px); }

Â  Â  #bottom-nav .tab.active{

Â  Â  Â  color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);

Â  Â  Â  border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);

Â  Â  }

Â  Â  #container{ padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }

Â  Â  #planets-content{ padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px)); }

Â  Â  @media (max-width: 420px){

Â  Â  Â  #top-bar{ font-size:11px; padding:6px 8px; }

Â  Â  Â  #settings-btn{ padding:5px 8px; font-size:12px; }

Â  Â  Â  #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; }

Â  Â  Â  #bottom-nav .tab{ padding:10px 8px; min-width:0; }

Â  Â  Â  h1{ font-size:1.2em; }

Â  Â  }

Â  Â  /* ì‚¬ì´ë“œ ë©”ë‰´ */

Â  Â  #side-menu-toggle{

Â  Â  Â  position: fixed; left: 8px; bottom: calc(96px + env(safe-area-inset-bottom, 0px));

Â  Â  Â  z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);

Â  Â  Â  background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;

Â  Â  Â  display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);

Â  Â  }

Â  Â  #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }

Â  Â  #side-backdrop.show{ opacity:1; pointer-events:auto; }

Â  Â  #side-menu{

Â  Â  Â  position: fixed; top: 0; left:  0; bottom:  0; width: 260px; max-width: 84vw;

Â  Â  Â  transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);

Â  Â  Â  background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);

Â  Â  Â  backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);

Â  Â  }

Â  Â  #side-menu.open{ transform: translateX(0); }

Â  Â  .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }

Â  Â  .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }

Â  Â  .side-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));

Â  Â  Â  border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none; }

Â  Â  .side-item:hover{ filter: brightness(1.08); }

Â  Â  .side-item .icon{ width:18px; text-align:center; }

Â  Â  .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

Â  Â  @media (max-width: 420px){ #side-menu-toggle{ bottom: calc(88px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; } #side-menu{ width: 240px; } }

Â  Â  /* ===== ì¶œì„ & ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ ===== */

Â  Â  #daily-overlay{

Â  Â  Â  position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;

Â  Â  Â  background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);

Â  Â  }

Â  Â  #daily-overlay.show{ display:flex; }

Â  Â  #daily-card{

Â  Â  Â  width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));

Â  Â  Â  padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);

Â  Â  Â  color:#eaf6ff;

Â  Â  }

Â  Â  #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }

Â  Â  #daily-info{ margin:6px 0 10px; font-size:12px; color:#cfe6ff; min-height:36px; }

Â  Â  #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

Â  Â  .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }

Â  Â  .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }

Â  Â  .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

Â  Â  /* ìŠ¬ë¡¯í˜• (ì„¸ë¡œ ë‚™í•˜) */

Â  Â  #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }

Â  Â  .slot-window{ width:320px; height:56px; overflow:hidden; border-radius:10px;

Â  Â  Â  background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }

Â  Â  .reel{ display:flex; flex-direction:column; }

Â  Â  .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }

Â  Â  .slot-icon{ font-size:20px; }

Â  Â  /* ì»¨íŠ¸ë¡¤/í™•ë¥ /ëª©ë¡ */

Â  Â  #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

Â  Â  .spinbtn{ padding:10px 14px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.14); font-weight:900; }

Â  Â  .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }

Â  Â  .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }

Â  Â  .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }

Â  Â  #prob-toggle{ width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;

Â  Â  Â  border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff; }

Â  Â  #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }

Â  Â  #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }

Â  Â  #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }

Â  Â  #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }

Â  Â  /* ë²„í”„ ìƒíƒœ ì´ë¦„+ì”ì—¬ */

Â  Â  #buff-status{

Â  Â  Â  display:inline-block;

Â  Â  Â  max-width: clamp(120px, 40vw, 260px);

Â  Â  Â  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;

Â  Â  Â  vertical-align: middle; margin-left: 6px; color:#9fdcff; font-variant-numeric: tabular-nums;

Â  Â  }

Â  Â  /* í† ìŠ¤íŠ¸ */

Â  Â  #toast{

Â  Â  Â  position: fixed;

Â  Â  Â  left: 50%;

Â  Â  Â  bottom: calc(80px + env(safe-area-inset-bottom, 12px));

Â  Â  Â  transform: translateX(-50%) translateY(20px);

Â  Â  Â  min-width: 220px; max-width: 92vw;

Â  Â  Â  padding: 10px 12px;

Â  Â  Â  background: rgba(10,12,20,0.85);

Â  Â  Â  border: 1px solid rgba(255,255,255,0.14);

Â  Â  Â  border-radius: 12px;

Â  Â  Â  color:#eaf6ff; font-weight:800; font-size:13px;

Â  Â  Â  display: none; z-index: 4000;

Â  Â  Â  box-shadow: 0 10px 28px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);

Â  Â  }

Â  Â  #toast.show{ display:block; animation: toast-pop .28s ease-out forwards; }

Â  Â  #toast .t-row{ display:flex; align-items:center; gap:10px; }

Â  Â  #toast .t-msg{ flex:1; }

Â  Â  #toast .t-btn{

Â  Â  Â  padding: 6px 10px; border-radius: 8px; border:1px solid rgba(255,255,255,0.12);

Â  Â  Â  background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; font-weight:900; cursor:pointer;

Â  Â  }

Â  Â  @keyframes toast-pop {

Â  Â  Â  from { opacity:0; transform: translateX(-50%) translateY(20px); }

Â  Â  Â  to   { opacity:1; transform: translateX(-50%) translateY(0); }

Â  Â  }

Â  Â  /* ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë²„ë ˆì´ */

Â  Â  #migrate-overlay{

Â  Â  Â  position: fixed; inset:0; z-index:3600; display:none; align-items:center; justify-content:center;

Â  Â  Â  background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);

Â  Â  }

Â  Â  #migrate-overlay.show{ display:flex; }

Â  Â  #migrate-card{

Â  Â  Â  width:min(560px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));

Â  Â  Â  padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);

Â  Â  Â  color:#eaf6ff;

Â  Â  }

Â  Â  #migrate-card h3{ margin:0 0 8px; font-size:18px; }

Â  Â  #migrate-desc{ font-size:13px; color:#cfe6ff; line-height:1.5; }

Â  Â  .warnbox{

Â  Â  Â  margin:10px 0; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,211,110,.45);

Â  Â  Â  background: rgba(255,211,110,.10); color:#ffe3a3; font-weight:700;

Â  Â  }

Â  Â  #migrate-progress{ margin-top:10px; font-size:13px; color:#a6e7ff; min-height:20px; }

Â  Â  #migrate-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }

Â  Â  #migrate-start{ padding:10px 14px; border-radius:10px; border:none; font-weight:900; cursor:pointer;

Â  Â  Â  background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }

Â  Â  #migrate-start[disabled]{ opacity:.6; cursor:not-allowed; }

Â  Â  /* ì´ìš©ì•½ê´€ & ì •ì§€ ì˜¤ë²„ë ˆì´ */

Â  Â  .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;

Â  Â  Â  background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px); z-index:3650; }

Â  Â  .overlay.show{ display:flex; }

Â  Â  .overlay-card{ width:min(620px,94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);

Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));

Â  Â  Â  padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08); color:#eaf6ff; }

Â  Â  .overlay-card h3{ margin:0 0 8px; font-size:18px; }

Â  Â  .overlay-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }

Â  Â  #tos-body{ max-height:40vh; overflow:auto; padding:10px; border:1px solid rgba(255,255,255,0.10);

Â  Â  Â  border-radius:10px; background: rgba(0,0,0,0.2); font-size:13px; color:#cfe6ff; }

Â  Â  #tos-accept[disabled]{ opacity:.6; cursor:not-allowed; }

Â  </style>

</head>  <body>  Â  <!-- ë¶€íŒ… ì¤‘ ì˜¤ë²„ë ˆì´ (ìµœì´ˆ 1íšŒë§Œ) -->  Â  <div id="boot-overlay" aria-hidden="false">

Â  Â  <div class="card" role="status" aria-live="polite" aria-atomic="true">

Â  Â  Â  <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">

Â  Â  Â  Â  <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>

Â  Â  Â  Â  <div style="text-align:left;">

Â  Â  Â  Â  Â  <div style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>

Â  Â  Â  Â  Â  <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>

Â  Â  </div>

Â  </div>

Â  <!-- ì¸ì¦ -->

Â  <div id="auth-container" role="dialog" aria-labelledby="auth-title">

Â  Â  <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">

Â  Â  Â  <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">ë¡œê·¸ì¸</button>

Â  Â  Â  <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">íšŒì›ê°€ì…</button>

Â  Â  </div>

Â  Â  <h2 id="auth-title">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>

Â  Â  <input type="email" id="email" placeholder="ì´ë©”ì¼" autocomplete="username" />

Â  Â  <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />

Â  Â  <div id="signup-extra" style="display:none; margin-top:6px;">

Â  Â  Â  <input type="password" id="password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password" />

Â  Â  Â  <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">

Â  Â  Â  Â  <input type="checkbox" id="tos-checkbox" /> <span>ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤</span>

Â  Â  Â  </label>

Â  Â  Â  <div style="margin-top:6px; font-size:12px; color:#cfe6ff; text-align:left; line-height:1.45;">

Â  Â  Â  Â  <b>ì´ìš©ì•½ê´€ ì•ˆë‚´:</b><br/>

Â  Â  Â  Â  Â· ì¹˜íŒ…/í•µ ì‚¬ìš©, ë²„ê·¸ ì•…ìš©, ê³„ì • ì–‘ë„/ëŒ€ì—¬ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.<br/>

Â  Â  Â  Â  Â· <u>ìì›Â·ì½”ì¸ ë¹„ì •ìƒ ê¸‰ì¦(ì˜ˆ: í•œ ë²ˆì— 10ì–µ ì½”ì¸)</u> íƒì§€ ì‹œ ê²½ê³  ë˜ëŠ” ì¦‰ì‹œ ì •ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>

Â  Â  Â  Â  Â· ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ â€˜ì´ìš©ì•½ê´€ ë™ì˜â€™ ëª¨ë‹¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

Â  Â  Â  </div>

Â  Â  Â  <!-- ğŸ”— ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸° (inframe /privacy) -->

Â  Â  Â  <div style="margin-top:8px; text-align:left;">

Â  Â  Â  Â  <a href="#" id="tos-more-link" style="font-size:12px; color:#9fdcff; text-decoration:underline;">

Â  Â  Â  Â  Â  ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸°

Â  Â  Â  Â  </a>

Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <button id="login-btn" class="primary-btn">ë¡œê·¸ì¸</button>

Â  Â  <button id="signup-btn" class="ghost-btn" style="display:none">íšŒì›ê°€ì…</button>

Â  Â  <button id="google-btn" aria-label="êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° (ê¶Œì¥)" class="google-btn">

Â  Â  Â  <span class="g-icon" aria-hidden="true">

Â  Â  Â  Â  <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false"><path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/><path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/><path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/></svg>

Â  Â  Â  </span>

Â  Â  Â  <span class="g-text">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° <small>(ê¶Œì¥)</small></span>

Â  Â  </button>

Â  Â  <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">

Â  Â  Â  <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>

Â  Â  </div>

Â  Â  <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>

Â  Â  <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

Â  Â  <div id="login-overlay" class="login-overlay" aria-hidden="true">

Â  Â  Â  <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">

Â  Â  Â  Â  <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">

Â  Â  Â  Â  Â  <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>

Â  Â  Â  Â  Â  <div style="text-align:left;">

Â  Â  Â  Â  Â  Â  <div id="login-overlay-title" style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘</div>

Â  Â  Â  Â  Â  Â  <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦</div>

Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- ìƒë‹¨ ë°” & ë©”ì¸ ê²Œì„ -->

Â  <div id="top-bar">

Â  Â  <div class="bar-group">

Â  Â  Â  <img src="/images/resource-icon.png" alt="Resource" />

Â  Â  Â  <span id="score">ìì›: 0</span>

Â  Â  Â  <img src="/images/coin-icon.png" alt="Coin" />

Â  Â  Â  <span id="coins">ì½”ì¸: 0</span>

Â  Â  Â  <img src="/images/event-icon.png" alt="EventCoin" />

Â  Â  Â  <span id="ecoins">ì´ë²¤íŠ¸ì½”ì¸: 0</span>

Â  Â  </div>

Â  Â  <div class="bar-group">

Â  Â  Â  <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />

Â  Â  Â  <span id="ship-level">1ë ™ (20ì½”ì¸)</span>

Â  Â  Â  <button id="upgrade-ship">ì—…ê·¸ë ˆì´ë“œ</button>

Â  Â  Â  <span id="buff-status" title="í™œì„± ë²„í”„ ëª©ë¡">ë²„í”„: ì—†ìŒ</span>

Â  Â  Â  <span id="suspicion-badge" title="í•µ ì‚¬ìš© ì˜ì‹¬ë„">ì˜ì‹¬ë„: 0</span>

Â  Â  Â  <button id="settings-btn" aria-label="ì„¤ì •ìœ¼ë¡œ ì´ë™">âš™ï¸ ì„¤ì •</button>

Â  Â  </div>

Â  </div>

Â  <div id="container">

Â  Â  <h1>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</h1>

Â  Â  <div id="main-content" class="tab-content active">

Â  Â  Â  <div id="ore-container" style="position:relative; display:inline-block;">

Â  Â  Â  Â  <img src="/images/ore.png" id="ore" alt="ê´‘ì„" />

Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">

Â  Â  Â  Â  <button id="convert-button" class="general">10ìì› â†’ 1ì½”ì¸</button>

Â  Â  Â  Â  <button id="auto-convert-buy" class="general">ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div id="workers-content" class="tab-content">

Â  Â  Â  <p>ì´ ì´ˆë‹¹ ìì›: <span id="resource-per-sec">0</span></p>

Â  Â  Â  <button id="hire-worker" class="general">ì•Œë°” ê³ ìš© (<span id="worker-cost">0</span>ì½”ì¸)</button>

Â  Â  Â  <p>ì´ ì´ˆë‹¹ ì½”ì¸: <span id="coin-per-sec">0</span></p>

Â  Â  Â  <button id="hire-conversion" class="general">ì½”ì¸ ì•Œë°” (<span id="conversion-cost">0</span>ì½”ì¸)</button>

Â  Â  </div>

Â  Â  <div id="upgrades-content" class="tab-content">

Â  Â  Â  <p>í´ë¦­ë‹¹ ìì›: <span id="click-power">1</span></p>

Â  Â  Â  <button id="click-upgrade" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (15ì½”ì¸)</button>

Â  Â  </div>

Â  Â  <div id="planets-content" class="tab-content">

Â  Â  Â  <div id="planet-list"></div>

Â  Â  </div>

Â  Â  <!-- ë°”í…€ ë‚´ë¹„ -->

Â  Â  <nav id="bottom-nav" aria-label="ê²Œì„ íƒ­ ë‚´ë¹„ê²Œì´ì…˜">

Â  Â  Â  <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ğŸª¨</span><span class="t-label">ë©”ì¸</span></div>

Â  Â  Â  <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">ğŸ‘©â€ğŸš€</span><span class="t-label">ìš°ì£¼ì¸</span></div>

Â  Â  Â  <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">âš™ï¸</span><span class="t-label">ì—…ê·¸ë ˆì´ë“œ</span></div>

Â  Â  Â  <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ğŸª</span><span class="t-label">í–‰ì„±</span></div>

Â  Â  </nav>

Â  </div>

Â  <!-- ì»¤ìŠ¤í…€ ë©”ë‰´ -->

Â  <div id="custom-menu">

Â  Â  <div class="menu-item" data-action="menu"><span>ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></div>

Â  Â  <div class="menu-item" data-action="download"><span>â¬‡ï¸ ì•± ë‹¤ìš´ë¡œë“œ</span></div>

Â  Â  <div class="menu-item" data-action="resume"><span>â–¶ï¸ ê²Œì„ ê³„ì†í•˜ê¸°</span></div>

Â  Â  <div class="menu-item" data-action="rank"><span>ğŸ† ë­í‚¹ ë³´ê¸°</span></div>

Â  Â  <div class="menu-item" data-action="attendance">

Â  Â  Â  <span>ğŸ“… ì¶œì„ ë³´ìƒ</span>

Â  Â  Â  <span id="attendance-left">-</span>

Â  Â  </div>

Â  </div>

Â  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->

Â  <button id="side-menu-toggle" aria-label="ì‚¬ì´ë“œ ë©”ë‰´ ì—´ê¸°" title="ë©”ë‰´">â˜°</button>

Â  <div id="side-backdrop" aria-hidden="true"></div>

Â  <aside id="side-menu" aria-label="ì‚¬ì´ë“œ ë©”ë‰´" aria-hidden="true">

Â  Â  <div class="side-header">ë©”ë‰´</div>

Â  Â  <nav class="side-items">

Â  Â  Â  <button class="side-item" data-action="menu"><span class="icon">ğŸ®</span><span>ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></button>

Â  Â  Â  <button class="side-item" data-action="download"><span class="icon">â¬‡ï¸</span><span>ì•± ë‹¤ìš´ë¡œë“œ</span></button>

Â  Â  Â  <button class="side-item" data-action="resume"><span class="icon">â–¶ï¸</span><span>ê²Œì„ ê³„ì†í•˜ê¸°</span></button>

Â  Â  Â  <button class="side-item" data-action="rank"><span class="icon">ğŸ†</span><span>ë­í‚¹ ë³´ê¸°</span></button>

Â  Â  Â  <button class="side-item" data-action="attendance">

Â  Â  Â  Â  <span><span class="icon">ğŸ“…</span>ì¶œì„ ë³´ìƒ</span>

Â  Â  Â  Â  <span class="side-right" id="attendance-left-side">-</span>

Â  Â  Â  </button>

Â  Â  </nav>

Â  </aside>

Â  <!-- ì¶œì„/ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ -->

Â  <div id="daily-overlay" aria-hidden="true">

Â  Â  <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">

Â  Â  Â  <div id="daily-title">

Â  Â  Â  Â  <span>ğŸ“… ì˜¤ëŠ˜ì˜ ë³´ìƒ & ìŠ¬ë¡¯</span>

Â  Â  Â  Â  <button id="prob-toggle" title="í™•ë¥ /ë³´ìƒ ì •ë³´">i</button>

Â  Â  Â  </div>

Â  Â  Â  <div class="tabbar">

Â  Â  Â  Â  <button class="tbtn active" data-mode="daily">ì¶œì„ ìŠ¬ë¡¯(ë¬´ë£Œ/ì¼1íšŒ)</button>

Â  Â  Â  Â  <button class="tbtn" data-mode="premium">í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯(ì´ë²¤íŠ¸ì½”ì¸ 1)</button>

Â  Â  Â  Â  <button class="tbtn" data-mode="ecoin">ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯(10)</button>

Â  Â  Â  </div>

Â  Â  Â  <div id="daily-info">í™•ì¸ ì¤‘â€¦</div>

Â  Â  Â  <div id="slot-wrap">

Â  Â  Â  Â  <div class="slot-window">

Â  Â  Â  Â  Â  <div id="slot-reel" class="reel"></div>

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  <div id="mode-row">

Â  Â  Â  Â  <button id="spin-daily"   class="spinbtn spin-free">ë¬´ë£Œ ì¶œì„ ëŒë¦¬ê¸°</button>

Â  Â  Â  Â  <button id="spin-premium" class="spinbtn spin-prem">í”„ë¦¬ë¯¸ì—„ ëŒë¦¬ê¸°(-EC 1)</button>

Â  Â  Â  Â  <button id="spin-ecoin"   class="spinbtn spin-ecoin">ì´ë²¤íŠ¸ì½”ì¸ ëŒë¦¬ê¸°(-EC 10)</button>

Â  Â  Â  </div>

Â  Â  Â  <div id="prob-panel"></div>

Â  Â  Â  <div id="reward-list"></div>

Â  Â  Â  <div id="daily-actions">

Â  Â  Â  Â  <button id="daily-close">ë‹«ê¸°</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- ğŸ”¶ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë²„ë ˆì´ -->

Â  <div id="migrate-overlay" aria-hidden="true">

Â  Â  <div id="migrate-card" role="dialog" aria-modal="true" aria-labelledby="migrate-title">

Â  Â  Â  <h3 id="migrate-title">ë°ì´í„° ì €ì¥ ë°©ì‹ ë³€ê²½ ì•ˆë‚´</h3>

Â  Â  Â  <div id="migrate-desc">

Â  Â  Â  Â  ê²Œì„ ë‚´ ë°ì´í„° ì €ì¥ ë°©ì‹ì´ ë³€ê²½ë˜ì–´ <b>ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>

Â  Â  Â  Â  ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>ê¸°ì¡´ ìœ„ì¹˜ì˜ ëª¨ë“  ë°ì´í„°(í•˜ìœ„ í‚¤ ì „ì²´)</b>ë¥¼ ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³ , <b>ì›ë³¸ì€ ì‚­ì œ</b>ë©ë‹ˆë‹¤.

Â  Â  Â  </div>

Â  Â  Â  <div class="warnbox">âš ï¸ ì§„í–‰ ì¤‘ ì°½ì„ ë‹«ê±°ë‚˜ ì¢…ë£Œí•˜ë©´ <b>ë°ì´í„° ì´ì „ ì¤‘ ë¬¸ì œ</b>ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ëŠ¥í•˜ë©´ ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>

Â  Â  Â  <div id="migrate-progress">ëŒ€ê¸° ì¤‘â€¦</div>

Â  Â  Â  <div id="migrate-actions">

Â  Â  Â  Â  <button id="migrate-start">ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- ğŸ“œ ì´ìš©ì•½ê´€ ì˜¤ë²„ë ˆì´ -->

Â  <div id="tos-overlay" class="overlay" aria-hidden="true">

Â  Â  <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="tos-title">

Â  Â  Â  <h3 id="tos-title">ì´ìš©ì•½ê´€ ë™ì˜</h3>

Â  Â  Â  <div id="tos-body">

Â  Â  Â  Â  <p>ë³¸ ê²Œì„ì€ ê³µì •í•œ í”Œë ˆì´ë¥¼ ìœ„í•´ ì¹˜íŒ…Â·í•µ ì‚¬ìš©ì„ ì—„ê²©íˆ ê¸ˆì§€í•©ë‹ˆë‹¤.</p>

Â  Â  Â  Â  <ul>

Â  Â  Â  Â  Â  <li>í´ë¼ì´ì–¸íŠ¸Â·ì½˜ì†” ì¡°ì‘ ë“±ìœ¼ë¡œ ìì›/ì½”ì¸ì„ ë¹„ì •ìƒì ìœ¼ë¡œ ì¦ê°€ì‹œí‚¤ëŠ” í–‰ìœ„ ê¸ˆì§€</li>

Â  Â  Â  Â  Â  <li>ë²„ê·¸ ì•…ìš© ê¸ˆì§€, ê³„ì • ì–‘ë„/ëŒ€ì—¬ ê¸ˆì§€</li>

Â  Â  Â  Â  Â  <li><b>ë¹„ì •ìƒ ê¸‰ì¦</b> ì˜ˆì‹œ: í•œ ë²ˆì— <b>10ì–µ ì½”ì¸</b> ì´ìƒ ì¦ê°€ â†’ ì¦‰ì‹œ ì •ì§€ ê°€ëŠ¥</li>

Â  Â  Â  Â  </ul>

Â  Â  Â  Â  <p>ë™ì˜ í›„ í”Œë ˆì´ë¥¼ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

Â  Â  Â  </div>

Â  Â  Â  <label style="display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;">

Â  Â  Â  Â  <input type="checkbox" id="tos-agree" /> <span>ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤</span>

Â  Â  Â  </label>

Â  Â  Â  <div class="overlay-actions">

Â  Â  Â  Â  <button id="tos-accept" class="spinbtn spin-free" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- ğŸ§© ì •ì±…(inframe) ì˜¤ë²„ë ˆì´ (/privacy í‘œì‹œ) -->

Â  <div id="policy-overlay" class="overlay" aria-hidden="true">

Â  Â  <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="policy-title">

Â  Â  Â  <h3 id="policy-title">ì´ìš©ì•½ê´€ Â· ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h3>

Â  Â  Â  <div style="height:70vh; max-height:80vh; margin-top:6px;">

Â  Â  Â  Â  <iframe

Â  Â  Â  Â  Â  id="policy-frame"

Â  Â  Â  Â  Â  title="ì •ì±… ë¬¸ì„œ"

Â  Â  Â  Â  Â  src="/privacy"

Â  Â  Â  Â  Â  loading="lazy"

Â  Â  Â  Â  Â  style="width:100%; height:100%; border:0; border-radius:10px; background:#fff;"

Â  Â  Â  Â  Â  sandbox="allow-same-origin allow-scripts allow-forms allow-popups"

Â  Â  Â  Â  Â  referrerpolicy="no-referrer"

Â  Â  Â  Â  ></iframe>

Â  Â  Â  </div>

Â  Â  Â  <div class="overlay-actions">

Â  Â  Â  Â  <button id="policy-close" class="spinbtn">ë‹«ê¸°</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- â›” ì •ì§€ ì˜¤ë²„ë ˆì´ (ì˜¤íƒ ëŒ€ì‘ ë²„íŠ¼ í¬í•¨) -->

Â  <div id="ban-overlay" class="overlay" aria-hidden="true">

Â  Â  <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="ban-title">

Â  Â  Â  <h3 id="ban-title">â›” ê³„ì • ì •ì§€ë¨</h3>

Â  Â  Â  <div id="ban-desc">

Â  Â  Â  Â  <p>ì´ìš©ì•½ê´€ ìœ„ë°˜ ì˜ì‹¬ì— ë”°ë¼ í”Œë ˆì´ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.</p>

Â  Â  Â  Â  <p>ì˜ì‹¬ë„: <b id="ban-sus-value">0</b></p>

Â  Â  Â  Â  <p style="color:#ffd36e">â€» ì •ì§€ ì¤‘ì—ëŠ” ìì›/ì½”ì¸ì´ ì¦ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

Â  Â  Â  Â  <div style="margin-top:8px; font-size:13px; color:#cfe6ff;">

Â  Â  Â  Â  Â  ì˜¤íƒìœ¼ë¡œ íŒë‹¨ë˜ë©´ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ <b>ì§€ì›íŒ€ì— ì¦‰ì‹œ ë©”ì¼</b>ì„ ë³´ë‚´ê±°ë‚˜, <b>ì •ë³´ ë³µì‚¬</b> í›„ ìˆ˜ë™ ë©”ì¼ ì „ì†¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  <div class="overlay-actions" style="flex-wrap:wrap;">

Â  Â  Â  Â  <button id="ban-appeal-email" class="spinbtn">ğŸ“§ ì˜¤íƒ ë©”ì¼ ë³´ë‚´ê¸°</button>

Â  Â  Â  Â  <button id="ban-copy-info" class="spinbtn">ğŸ“‹ ì •ë³´ ë³µì‚¬</button>

Â  Â  Â  Â  <button id="ban-ok" class="spinbtn">ë‹«ê¸°</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <!-- ì‚¬ìš´ë“œ -->

Â  <audio id="sfx-start"  src="/sounds/roulette_start.mp3" preload="auto"></audio>

Â  <audio id="sfx-tick"   src="/sounds/roulette_tick.mp3"  preload="auto"></audio>

Â  <audio id="sfx-win"    src="/sounds/roulette_win.mp3"   preload="auto"></audio>

Â  <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->

Â  <div id="toast" role="status" aria-live="polite"></div>

Â  <!-- Firebase + ê²Œì„ ë¡œì§ -->

Â  <script type="module">

Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";

Â  Â  import {

Â  Â  Â  getAuth, onAuthStateChanged,

Â  Â  Â  signInWithEmailAndPassword,

Â  Â  Â  sendEmailVerification,               // ë¡œê·¸ì¸ ì•ˆë‚´ìš© (íŒ¨ìŠ¤ì›Œë“œ ê³„ì •)

Â  Â  Â  GoogleAuthProvider, signInWithPopup, signInWithRedirect,

Â  Â  Â  // âœ… ì´ë©”ì¼ ë§í¬ ê°€ì…(ì¸ì¦ ì „ê¹Œì§€ ê³„ì • ë¯¸ìƒì„±)

Â  Â  Â  sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink,

Â  Â  Â  EmailAuthProvider, linkWithCredential

Â  Â  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

Â  Â  import {

Â  Â  Â  getDatabase, ref, onValue, runTransaction, update, get

Â  Â  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

Â  Â  const firebaseConfig = {

Â  Â  Â  apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",

Â  Â  Â  authDomain: "siu-studio.firebaseapp.com",

Â  Â  Â  databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",

Â  Â  Â  projectId: "siu-studio",

Â  Â  Â  storageBucket: "siu-studio.appspot.com",

Â  Â  Â  messagingSenderId: "830887143444",

Â  Â  Â  appId: "1:830887143444:web:70b45fc12140e893c31f01",

Â  Â  Â  measurementId: "G-1Y090YJDB6"

Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);

Â  Â  const auth = getAuth(app);

Â  Â  const db   = getDatabase(app);

Â  Â  // âœ… ì¸ì¦ ë§í¬ íšŒê·€ ëª©ì ì§€ ì„¤ì •(í˜„ì¬ í˜ì´ì§€ë¡œ)

Â  Â  const actionCodeSettings = {

Â  Â  Â  url: location.origin + location.pathname,

Â  Â  Â  handleCodeInApp: true

Â  Â  };

Â  Â  /* ======================

Â  Â  Â  Â ê³µí†µ ìƒíƒœ / ê²½ë¡œ

Â  Â  Â  Â ====================== */

Â  Â  const SUPPORT_EMAIL = 'appeals@siustudio.kro.kr';

Â  Â  let state = {};

Â  Â  let uid = null;

Â  Â  let dataRef = null;

Â  Â  let dataUnsubscribe = null;

Â  Â  let localLastWrite = 0;

Â  Â  let isInitialSync = false;

Â  Â  let userServerKey = null;

Â  Â  let userIdKey     = null; // ğŸ”‘ ê²½ë¡œìš©(ì¸ì½”ë”©ëœ í‚¤)

Â  Â  let userBasePath  = null;

Â  Â  let dailyUnlocked = false;

Â  Â  let rankingUnlocked = false;

Â  Â  let bootDone = false;

Â  Â  /* ======================

Â  Â  Â  Â í† ìŠ¤íŠ¸ / UI ìœ í‹¸

Â  Â  Â  Â ====================== */

Â  Â  let toastTimer = null;

Â  Â  function showToast(message, actionText = null, onAction = null, ttlMs = 5000){

Â  Â  Â  if (!bootDone) return;

Â  Â  Â  const box = document.getElementById('toast');

Â  Â  Â  if(!box) return;

Â  Â  Â  clearTimeout(toastTimer);

Â  Â  Â  box.innerHTML = `<div class="t-row">

Â  Â  Â  Â  <span class="t-msg">${message}</span>

Â  Â  Â  Â  ${actionText ? <button class="t-btn" id="toast-action">${actionText}</button> : ``}

Â  Â  Â  </div>`;

Â  Â  Â  box.classList.add('show');

Â  Â  Â  box.style.display='block';

Â  Â  Â  function hideToast(){ box.classList.remove('show'); box.style.display='none'; }

Â  Â  Â  if(actionText && onAction){

Â  Â  Â  Â  const btn = document.getElementById('toast-action');

Â  Â  Â  Â  if(btn){ btn.onclick = () => { try{ onAction(); }catch{} hideToast(); }; }

Â  Â  Â  }

Â  Â  Â  toastTimer = setTimeout(hideToast, ttlMs);

Â  Â  }

Â  Â  /* ======================

Â  Â  Â  Â ë²„í”„ ì €ì¥/ì ìš©/í‘œì‹œ

Â  Â  Â  Â ====================== */

Â  Â  function buffStorageKey(){ return siu_buffs_${uid||'anon'}; }

Â  Â  function ensureFx(){ if(!window.fx) window.fx={}; if(!window.fx.buffs) window.fx.buffs=[]; }

Â  Â  function persistBuffs(){

Â  Â  Â  ensureFx();

Â  Â  Â  try {

Â  Â  Â  Â  const now = Date.now();

Â  Â  Â  Â  const toSave = window.fx.buffs.filter(b=>b && b.until>now);

Â  Â  Â  Â  localStorage.setItem(buffStorageKey(), JSON.stringify(toSave));

Â  Â  Â  } catch {}

Â  Â  }

Â  Â  function loadBuffs(){

Â  Â  Â  ensureFx();

Â  Â  Â  try {

Â  Â  Â  Â  const raw = localStorage.getItem(buffStorageKey());

Â  Â  Â  Â  const arr = raw ? JSON.parse(raw) : [];

Â  Â  Â  Â  const now = Date.now();

Â  Â  Â  Â  window.fx.buffs = Array.isArray(arr) ? arr.filter(b=>b && b.until>now) : [];

Â  Â  Â  } catch { window.fx.buffs = []; }

Â  Â  }

Â  Â  function pruneExpiredBuffs(){

Â  Â  Â  ensureFx();

Â  Â  Â  const before = window.fx.buffs.length;

Â  Â  Â  const now = Date.now();

Â  Â  Â  window.fx.buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);

Â  Â  Â  if (window.fx.buffs.length !== before) persistBuffs();

Â  Â  }

Â  Â  function activeBuffFactor(kind){

Â  Â  Â  ensureFx();

Â  Â  Â  const now = Date.now();

Â  Â  Â  let factor = 1;

Â  Â  Â  (window.fx.buffs||[]).forEach(b=>{

Â  Â  Â  Â  if(!b || now>=b.until) return;

Â  Â  Â  Â  if (b.type==='all') factor *= (1 + b.value);

Â  Â  Â  Â  else if (kind==='res'  && b.type==='res')  factor *= (1 + b.value);

Â  Â  Â  Â  else if (kind==='coin' && b.type==='coin') factor *= (1 + b.value);

Â  Â  Â  });

Â  Â  Â  return factor;

Â  Â  }

Â  Â  function addTempBuff(type, value, dur){

Â  Â  Â  ensureFx();

Â  Â  Â  const now=Date.now();

Â  Â  Â  window.fx.buffs.push({ type, value, until: now + dur });

Â  Â  Â  persistBuffs();

Â  Â  Â  renderBuffStatus();

Â  Â  }

Â  Â  function renderBuffStatus(){

Â  Â  Â  const el = document.getElementById('buff-status');

Â  Â  Â  if(!el){ return; }

Â  Â  Â  pruneExpiredBuffs();

Â  Â  Â  const now = Date.now();

Â  Â  Â  const names = { all:'ì „ì²´', coin:'ì½”ì¸', res:'ìì›' };

Â  Â  Â  const items = (window.fx.buffs||[])

Â  Â  Â  Â  .filter(b=>b && b.until>now)

Â  Â  Â  Â  .map(b=>{

Â  Â  Â  Â  Â  const leftMs = b.until - now;

Â  Â  Â  Â  Â  const m = Math.max(0, Math.floor(leftMs/60000));

Â  Â  Â  Â  Â  const s = Math.max(0, Math.floor((leftMs%60000)/1000));

Â  Â  Â  Â  Â  const mult = 1 + b.value;

Â  Â  Â  Â  Â  const multText = (Math.abs(mult - Math.round(mult)) < 1e-9) ? x${Math.round(mult)} : x${(Math.round(mult*10)/10)};

Â  Â  Â  Â  Â  return ${names[b.type]||'ë²„í”„'} ${multText} (${m}:${String(s).padStart(2,'0')});

Â  Â  Â  Â  });

Â  Â  Â  el.textContent = items.length ? ë²„í”„: ${items.join(' Â· ')} : 'ë²„í”„: ì—†ìŒ';

Â  Â  Â  el.title = items.join('\n') || 'ë²„í”„ ì—†ìŒ';

Â  Â  }

Â  Â  /* ========= ìˆ«ì í•œêµ­ì‹ ë‹¨ìœ„ ========= */

Â  Â  function formatKR(num, decimalsForUnits = 2) {

Â  Â  Â  if (num === null || num === undefined) return '0';

Â  Â  Â  if (!isFinite(num)) return String(num);

Â  Â  Â  const neg = num < 0;

Â  Â  Â  let n = Math.abs(num);

Â  Â  Â  const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°', 'ê²½', 'í•´', 'ì', 'ì–‘', 'êµ¬', 'ê°„', 'ì •', 'ì¬', 'ê·¹'];

Â  Â  Â  let u = 0;

Â  Â  Â  while (n >= 10000 && u < units.length - 1) { n /= 10000; u++; }

Â  Â  Â  if (u === 0) {

Â  Â  Â  Â  const rounded = Math.round(n);

Â  Â  Â  Â  return (neg ? '-' : '') + rounded.toLocaleString('ko-KR');

Â  Â  Â  }

Â  Â  Â  const s = n.toFixed(decimalsForUnits).replace(/.0+$|(.\d*[1-9])0+$/, '$1');

Â  Â  Â  return (neg ? '-' : '') + s + units[u];

Â  Â  }

Â  Â  /* ========= ê¸°ë³¸ ë°ì´í„° & ìœ í‹¸ ========= */

Â  Â  const defaultData = {

Â  Â  Â  resources:0, coins:0, eventCoins:0,

Â  Â  Â  clickPower:1, shipLevel:1, shipUpgradeCost:20,

Â  Â  Â  workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[],

Â  Â  Â  _lastUpdated: 0

Â  Â  };

Â  Â  const initialWorkerCost=10, workerCostGrowth=1.2;

Â  Â  const initialWorkerPower=1, workerPowerGrowth=1.05;

Â  Â  const initialConversionCost=50, conversionCostGrowth=1.3;

Â  Â  const clickUpgradeCost=15;

Â  Â  function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }

Â  Â  function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }

Â  Â  function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

Â  Â  // ğŸ”„ ë³€í™˜(ì¦ê°€/ì§€ì¶œ ì¥ë¶€ ë°˜ì˜)

Â  Â  function convertResources(maxCount = null) {

Â  Â  Â  const possible = Math.floor(state.resources / 10);

Â  Â  Â  const count = maxCount === null ? possible : Math.min(possible, maxCount);

Â  Â  Â  if (count > 0) {

Â  Â  Â  Â  const resOut = count * 10;

Â  Â  Â  Â  state.resources -= resOut;

Â  Â  Â  Â  auditSpend('res', resOut);

Â  Â  Â  Â  const coinMul = activeBuffFactor('coin');

Â  Â  Â  Â  const inc = count * coinMul;

Â  Â  Â  Â  state.coins += inc;

Â  Â  Â  Â  auditGain('coin', inc);

Â  Â  Â  }

Â  Â  }

Â  Â  async function ensureInitialData(refObj) {

Â  Â  Â  try {

Â  Â  Â  Â  await runTransaction(refObj, current => {

Â  Â  Â  Â  Â  if (current === null) return { ...defaultData, _lastUpdated: Date.now() };

Â  Â  Â  Â  Â  return current;

Â  Â  Â  Â  });

Â  Â  Â  } catch (err) { console.error('ì´ˆê¸°í™” íŠ¸ëœì­ì…˜ ì—ëŸ¬:', err); }

Â  Â  }

Â  Â  function save() {

Â  Â  Â  if (!uid || !dataRef) return;

Â  Â  Â  if (isInitialSync) return;

Â  Â  Â  if (!window.__PLAY_ALLOWED) return;

Â  Â  Â  const now = Date.now();

Â  Â  Â  state._lastUpdated = now;

Â  Â  Â  localLastWrite = now;

Â  Â  Â  try { localStorage.setItem(lastWrite_${uid}, String(now)); } catch {}

Â  Â  Â  update(dataRef, { ...state }).catch(err => console.error('ì €ì¥ ì—ëŸ¬:', err));

Â  Â  }

Â  Â  /* ========= ìƒˆ í‚¤ ê·œì¹™ ========= */

Â  Â  function encodeEmailToKey(email){

Â  Â  Â  const s = String(email||'').trim().toLowerCase();

Â  Â  Â  return s

Â  Â  Â  Â  .replace(/\s+/g,'')

Â  Â  Â  Â  .replace(/@/g,'at')

Â  Â  Â  Â  .replace(/./g,'dot')

Â  Â  Â  Â  .replace(/[#$î€î€/?%*]/g,'-')

Â  Â  Â  Â  .replace(/[^a-z0-9_-]/g, '-')

Â  Â  Â  Â  .replace(/-+/g,'-')

Â  Â  Â  Â  .replace(/^[-]+|[-]+$/g,'') || 'user';

Â  Â  }

Â  Â  function fallbackIdFromDisplayName(name){

Â  Â  Â  return (String(name||'').trim().toLowerCase() || 'user')

Â  Â  Â  Â  .replace(/[^a-z0-9_-]/g,'-')

Â  Â  Â  Â  .replace(/-+/g,'-')

Â  Â  Â  Â  .replace(/^[-]+|[-]+$/g,'') || 'user';

Â  Â  }

Â  Â  function fallbackIdFromUid(uid){

Â  Â  Â  return user_${String(uid||'').slice(0,8) || '00000000'};

Â  Â  }

Â  Â  function makeIdKeyFromUser(user){

Â  Â  Â  if (user?.email) return encodeEmailToKey(user.email);

Â  Â  Â  if (user?.displayName) return fallbackIdFromDisplayName(user.displayName);

Â  Â  Â  return fallbackIdFromUid(user?.uid);

Â  Â  }

Â  Â  function isNewlyCreatedAccount(user, minutes = 5) {

Â  Â  Â  try {

Â  Â  Â  Â  const ct = Date.parse(user?.metadata?.creationTime || '') || 0;

Â  Â  Â  Â  const lt = Date.parse(user?.metadata?.lastSignInTime || '') || 0;

Â  Â  Â  Â  if (!ct || !lt) return false;

Â  Â  Â  Â  return Math.abs(lt - ct) <= minutes * 60 * 1000;

Â  Â  Â  } catch { return false; }

Â  Â  }

Â  Â  async function allocateServerForUser(){

Â  Â  Â  try{

Â  Â  Â  Â  const res = await runTransaction(ref(db, 'meta/nextIndex'), cur => (cur || 0) + 1);

Â  Â  Â  Â  const idx = res?.snapshot?.val() || 1;

Â  Â  Â  Â  const serverNum = Math.max(1, Math.ceil(idx / 15));

Â  Â  Â  Â  return server${serverNum};

Â  Â  Â  }catch{

Â  Â  Â  Â  return 'server1';

Â  Â  Â  }

Â  Â  }

Â  Â  async function planMigrationForUser(user){

Â  Â  Â  const uid = user.uid;

Â  Â  Â  const desiredId = makeIdKeyFromUser(user);

Â  Â  Â  const desiredServer = await allocateServerForUser();

Â  Â  Â  let mapping = null;

Â  Â  Â  try {

Â  Â  Â  Â  const m = await get(ref(db, userServerMap/${uid}));

Â  Â  Â  Â  mapping = m.exists() ? (m.val() || null) : null;

Â  Â  Â  } catch {}

Â  Â  Â  const legacySnap = await get(ref(db, users/${uid}));

Â  Â  Â  const legacyExists = legacySnap.exists();

Â  Â  Â  let srcBasePath = null;

Â  Â  Â  let server = desiredServer;

Â  Â  Â  if (mapping && mapping.server && mapping.id) {

Â  Â  Â  Â  srcBasePath = users/${mapping.server}/${mapping.id};

Â  Â  Â  Â  server = mapping.server;

Â  Â  Â  } else if (legacyExists) {

Â  Â  Â  Â  srcBasePath = users/${uid};

Â  Â  Â  }

Â  Â  Â  const destBasePath = users/${server}/${desiredId};

Â  Â  Â  const destSnap = await get(ref(db, destBasePath));

Â  Â  Â  const destExists = destSnap.exists();

Â  Â  Â  if (isNewlyCreatedAccount(user) && !legacyExists && !mapping && !destExists) {

Â  Â  Â  Â  return { need: false, server, oldMapping: null, srcBasePath: null, destBasePath, reason: 'fresh-signup' };

Â  Â  Â  }

Â  Â  Â  if (mapping && mapping.server && mapping.id && mapping.id !== desiredId) {

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  const srcSnap = await get(ref(db, srcBasePath));

Â  Â  Â  Â  Â  if (!srcSnap.exists()){

Â  Â  Â  Â  Â  Â  return { need:false, server: mapping.server, oldMapping: mapping, srcBasePath: null, destBasePath, reason: 'rename-mapping-only' };

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  return { need:true, server: mapping.server, oldMapping: mapping, srcBasePath, destBasePath, reason: 'rename-to-email-id' };

Â  Â  Â  }

Â  Â  Â  if (!mapping && legacyExists) {

Â  Â  Â  Â  return { need:true, server, oldMapping: null, srcBasePath: users/${uid}, destBasePath, reason: 'legacy-flat' };

Â  Â  Â  }

Â  Â  Â  return { need:false, server, oldMapping: mapping || null, srcBasePath: null, destBasePath, reason: 'fresh-or-already-ok' };

Â  Â  }

Â  Â  function showMigrateOverlay(show=true, msg='ëŒ€ê¸° ì¤‘â€¦'){

Â  Â  Â  const ov = document.getElementById('migrate-overlay');

Â  Â  Â  const pr = document.getElementById('migrate-progress');

Â  Â  Â  if (pr) pr.textContent = msg || '';

Â  Â  Â  if (ov){

Â  Â  Â  Â  ov.classList.toggle('show', !!show);

Â  Â  Â  Â  ov.setAttribute('aria-hidden', show ? 'false':'true');

Â  Â  Â  }

Â  Â  }

Â  Â  function setMigrateProgress(msg){ const pr=document.getElementById('migrate-progress'); if(pr) pr.textContent = msg||''; }

Â  Â  function disableMigrateStart(dis=true){ const btn=document.getElementById('migrate-start'); if(btn) btn.disabled=!!dis; }

Â  Â  async function performMigration(srcBasePath, destBasePath, user){

Â  Â  Â  setMigrateProgress('1/3 ê¸°ì¡´ ë°ì´í„° ì½ëŠ” ì¤‘â€¦');

Â  Â  Â  const srcRef = ref(db, srcBasePath);

Â  Â  Â  const destRef = ref(db, destBasePath);

Â  Â  Â  const snap = await get(srcRef);

Â  Â  Â  if (!snap.exists()){

Â  Â  Â  Â  setMigrateProgress('ì†ŒìŠ¤ì— ë°ì´í„°ê°€ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤.');

Â  Â  Â  } else {

Â  Â  Â  Â  const payload = snap.val() || {};

Â  Â  Â  Â  setMigrateProgress('2/3 ìƒˆ ìœ„ì¹˜ë¡œ ë³µì‚¬ ì¤‘â€¦');

Â  Â  Â  Â  await update(ref(db), { [destBasePath]: payload });

Â  Â  Â  Â  setMigrateProgress('3/3 ì›ë³¸ ì‚­ì œ ì¤‘â€¦');

Â  Â  Â  Â  await update(ref(db), { [srcBasePath]: null });

Â  Â  Â  }

Â  Â  Â  const displayEmail = String(user?.email || '').trim();

Â  Â  Â  await update(ref(db), {

Â  Â  Â  Â  [userServerMap/${user.uid}]: {

Â  Â  Â  Â  Â  server: userServerKey,

Â  Â  Â  Â  Â  id: userIdKey,

Â  Â  Â  Â  Â  displayId: displayEmail || null,

Â  Â  Â  Â  Â  migratedAt: Date.now()

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  setMigrateProgress('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! ì ì‹œ í›„ ê²Œì„ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦');

Â  Â  }

Â  Â  /* ======================

Â  Â  Â  Â KST ìœ í‹¸ / ë°ì¼ë¦¬

Â  Â  Â  Â ====================== */

Â  Â  function kstDate(d=new Date()){

Â  Â  Â  return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));

Â  Â  }

Â  Â  function kstDayKey(d=new Date()){

Â  Â  Â  const t = kstDate(d);

Â  Â  Â  const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');

Â  Â  Â  return ${y}-${m}-${day};

Â  Â  }

Â  Â  function nextResetKST(d=new Date()){ const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n; }

Â  Â  function fmtLeft(ms){

Â  Â  Â  if(ms<=0) return 'ì§€ê¸ˆ ê°€ëŠ¥';

Â  Â  Â  const s=Math.floor(ms/1000);

Â  Â  Â  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;

Â  Â  Â  return ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')};

Â  Â  }

Â  Â  function calcBaseCoin(){

Â  Â  Â  const rps = state.workerCount * getWorkerPower();

Â  Â  Â  const cps = state.conversionCount;

Â  Â  Â  const rpc = state.clickPower;

Â  Â  Â  const planets = (state.ownedPlanets?.length || 0);

Â  Â  Â  const ship = (state.shipLevel || 1);

Â  Â  Â  const auto = state.autoConvertBought ? 1 : 0;

Â  Â  Â  const score =

Â  Â  Â  Â  20 * Math.log2(1 + rps) +

Â  Â  Â  Â  45 * Math.log2(1 + cps) +

Â  Â  Â  Â  10 * Math.log2(1 + rpc) +

Â  Â  Â  Â  120 * planets +

Â  Â  Â  Â  32  * ship +

Â  Â  Â  Â  (auto ? 20 : 0);

Â  Â  Â  const baseRaw = 50 + score;

Â  Â  Â  const base = Math.round(baseRaw * 0.65);

Â  Â  Â  return Math.min(Math.max(base, 30), 30000);

Â  Â  }

Â  Â  const TPL_DAILY = [

Â  Â  Â  { key:'coin_x1_4', type:'coin', coinMul:1.4, icon:'ğŸ’°', color:'#00E5FF', w:0.32 },

Â  Â  Â  { key:'coin_x1_8', type:'coin', coinMul:1.8, icon:'ğŸ’°', color:'#4DFFB5', w:0.18 },

Â  Â  Â  { key:'res_x2_5m', type:'buff', bkind:'res',  bmult:1.0, bdur:5601000, icon:'âš¡', color:'#FFA8FF', w:0.22 },

Â  Â  Â  { key:'all_x2_3m', type:'buff', bkind:'all',  bmult:1.0, bdur:3601000, icon:'ğŸš€', color:'#8AE1FF', w:0.16 },

Â  Â  Â  { key:'coinbuf_x2_3m', type:'buff', bkind:'coin', bmult:1.0, bdur:3601000, icon:'ğŸª™', color:'#FFD0A8', w:0.11 },

Â  Â  Â  { key:'eco_1',     type:'ecoin', val:1,       icon:'ğŸŸï¸', color:'#FFD05C', w:0.01 }

Â  Â  ];

Â  Â  const TPL_PREMIUM = [

Â  Â  Â  { key:'coin_x2_2',   type:'coin', coinMul:2.2, icon:'ğŸ’°', color:'#00E5FF', w:0.22 },

Â  Â  Â  { key:'coin_x3_2',   type:'coin', coinMul:3.2, icon:'ğŸ’°', color:'#4DFFB5', w:0.19 },

Â  Â  Â  { key:'coin_x5_5',   type:'coin', coinMul:5.5, icon:'ğŸ’°', color:'#32C6FF', w:0.12 },

Â  Â  Â  { key:'all_x2_10m',  type:'buff', bkind:'all',  bmult:1.0, bdur:10601000, icon:'ğŸš€', color:'#8AE1FF', w:0.20 },

Â  Â  Â  { key:'res_x3_7m',   type:'buff', bkind:'res',  bmult:2.0, bdur:7601000,  icon:'âš¡', color:'#FFA8FF', w:0.16 },

Â  Â  Â  { key:'coinbuf_x3_5m', type:'buff', bkind:'coin', bmult:2.0, bdur:5601000, icon:'ğŸª™', color:'#FFD0A8', w:0.08 },

Â  Â  Â  { key:'eco_3',       type:'ecoin', val:3,       icon:'ğŸŸï¸', color:'#FF9E3D', w:0.03 }

Â  Â  ];

Â  Â  const TPL_ECOIN = [

Â  Â  Â  { key:'coin_x3_5',   type:'coin', coinMul:3.5, icon:'ğŸ’°', color:'#00E5FF', w:0.22 },

Â  Â  Â  { key:'coin_x5_8',   type:'coin', coinMul:5.8, icon:'ğŸ’°', color:'#4DFFB5', w:0.18 },

Â  Â  Â  { key:'coin_x9',     type:'coin', coinMul:9.0, icon:'ğŸ’°', color:'#32C6FF', w:0.10 },

Â  Â  Â  { key:'all_x3_15m',  type:'buff', bkind:'all',  bmult:2.0, bdur:15601000, icon:'ğŸš€', color:'#8AE1FF', w:0.20 },

Â  Â  Â  { key:'res_x5_12m',  type:'buff', bkind:'res',  bmult:4.0, bdur:12601000, icon:'âš¡', color:'#FFA8FF', w:0.16 },

Â  Â  Â  { key:'eco_8',       type:'ecoin', val:8,       icon:'ğŸŸï¸', color:'#FFBE5C', w:0.10 },

Â  Â  Â  { key:'eco_12',      type:'ecoin', val:12,      icon:'ğŸŸï¸', color:'#FF9E3D', w:0.03 },

Â  Â  Â  { key:'eco_20',      type:'ecoin', val:20,      icon:'ğŸŸï¸', color:'#FF7AE1', w:0.01 }

Â  Â  ];

Â  Â  function materializeItems(tpl, mode){

Â  Â  Â  const base = calcBaseCoin();

Â  Â  Â  const modeAdj = mode === 'daily' ? 0.9 : (mode === 'premium' ? 1.15 : 1.2);

Â  Â  Â  return tpl.map(it=>{

Â  Â  Â  Â  if (it.type==='coin'){

Â  Â  Â  Â  Â  const amt = Math.max(1, Math.round(base * it.coinMul * modeAdj));

Â  Â  Â  Â  Â  return {

Â  Â  Â  Â  Â  Â  ...it,

Â  Â  Â  Â  Â  Â  awardCoin: amt,

Â  Â  Â  Â  Â  Â  label:ì½”ì¸ ${formatKR(amt)},

Â  Â  Â  Â  Â  Â  onWin:()=>{

Â  Â  Â  Â  Â  Â  Â  // âœ… ì¶œì„/ìŠ¬ë¡¯ ì½”ì¸ ì§€ê¸‰ì€ ê°ì‚¬ ì˜ë„ í—ˆìš© ì°½ ë“±ë¡ + í•©ë²• ì¥ë¶€ ë°˜ì˜

Â  Â  Â  Â  Â  Â  Â  registerAuditIntent('coin', amt);    // ì˜ë„ í—ˆìš©(ë ˆì´ìŠ¤ ë³´ì •)

Â  Â  Â  Â  Â  Â  Â  state.coins += amt;

Â  Â  Â  Â  Â  Â  Â  auditGain('coin', amt);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  };

Â  Â  Â  Â  }

Â  Â  Â  Â  if (it.type==='ecoin'){

Â  Â  Â  Â  Â  return {

Â  Â  Â  Â  Â  Â  ...it,

Â  Â  Â  Â  Â  Â  awardEcoin: it.val,

Â  Â  Â  Â  Â  Â  label:ì´ë²¤íŠ¸ì½”ì¸ Ã—${it.val},

Â  Â  Â  Â  Â  Â  onWin:()=>{

Â  Â  Â  Â  Â  Â  Â  registerAuditIntent('eco', it.val);

Â  Â  Â  Â  Â  Â  Â  state.eventCoins = (state.eventCoins||0) + it.val;

Â  Â  Â  Â  Â  Â  Â  auditGain('eco', it.val);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  };

Â  Â  Â  Â  }

Â  Â  Â  Â  if (it.type==='buff'){

Â  Â  Â  Â  Â  const multText = x${1+it.bmult};

Â  Â  Â  Â  Â  const minText  = ${Math.round(it.bdur/60000)}m;

Â  Â  Â  Â  Â  let title = it.bkind==='all' ? ëª¨ë“  ìƒì‚° ${multText}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : it.bkind==='coin' ? ì½”ì¸ ìƒì‚° ${multText}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â :                    ìì› ìƒì‚° ${multText};

Â  Â  Â  Â  Â  return { ...it, label:${title} / ${minText}, onWin:()=>{ addTempBuff(it.bkind, it.bmult, it.bdur); } };

Â  Â  Â  Â  }

Â  Â  Â  Â  return it;

Â  Â  Â  });

Â  Â  }

Â  Â  function getItemsForMode(mode){

Â  Â  Â  const tpl = mode==='daily'   ? TPL_DAILY

Â  Â  Â  Â  Â  Â  Â  Â : mode==='premium' ? TPL_PREMIUM

Â  Â  Â  Â  Â  Â  Â  Â : mode==='ecoin'   ? TPL_ECOIN

Â  Â  Â  Â  Â  Â  Â  Â : TPL_PREMIUM;

Â  Â  Â  return materializeItems(tpl, mode);

Â  Â  }

Â  Â  function playSfx(id){

Â  Â  Â  const el=document.getElementById(id);

Â  Â  Â  if (el && el.play){ el.currentTime=0; el.play().catch(()=>{}); return; }

Â  Â  Â  try{

Â  Â  Â  Â  const ctx = new (window.AudioContext||window.webkitAudioContext)();

Â  Â  Â  Â  const o = ctx.createOscillator(); const g=ctx.createGain();

Â  Â  Â  Â  o.connect(g); g.connect(ctx.destination); o.type='triangle';

Â  Â  Â  Â  o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;

Â  Â  Â  Â  g.gain.setValueAtTime(.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);

Â  Â  Â  Â  o.start(); o.stop(ctx.currentTime+.08);

Â  Â  Â  }catch{}

Â  Â  }

Â  Â  function startTickLoop(intv=120){ stopTickLoop(); startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv); }

Â  Â  function stopTickLoop(){ if(startTickLoop._id){ clearInterval(startTickLoop._id); startTickLoop._id=null; } }

Â  Â  const slotWrap = document.getElementById('slot-wrap');

Â  Â  const reel = document.getElementById('slot-reel');

Â  Â  function buildSlot(items){

Â  Â  Â  const rows = items.map(it=><div class="slot-item"><span class="slot-icon">${it.icon||'ğŸ'}</span>${it.label||it.key}</div>).join('');

Â  Â  Â  reel.innerHTML = rows.repeat(8);

Â  Â  Â  reel.style.transform = 'translateY(0px)';

Â  Â  Â  reel.style.transition = 'none';

Â  Â  }

Â  Â  let isSpinning = false;

Â  Â  function spinSlot(items, picked){

Â  Â  Â  const rowH=56;

Â  Â  Â  const idx = Math.max(0, items.findIndex(it=>it.key===picked.key));

Â  Â  Â  const stopRow = (items.length*6) + (idx<0?0:idx);

Â  Â  Â  const targetY = - stopRow * rowH;

Â  Â  Â  startTickLoop(90);

Â  Â  Â  playSfx('sfx-start');

Â  Â  Â  return new Promise(resolve=>{

Â  Â  Â  Â  requestAnimationFrame(()=>{

Â  Â  Â  Â  Â  requestAnimationFrame(()=>{

Â  Â  Â  Â  Â  Â  reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';

Â  Â  Â  Â  Â  Â  reel.style.transform = translateY(${targetY}px);

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  });

Â  Â  Â  Â  reel.ontransitionend = ()=>{ reel.ontransitionend=null; stopTickLoop(); playSfx('sfx-win'); resolve(); };

Â  Â  Â  });

Â  Â  }

Â  Â  const dailyOverlay = document.getElementById('daily-overlay');

Â  Â  const dailyInfo    = document.getElementById('daily-info');

Â  Â  const dailyCloseBtn= document.getElementById('daily-close');

Â  Â  const probPanel    = document.getElementById('prob-panel');

Â  Â  const probToggle   = document.getElementById('prob-toggle');

Â  Â  const rewardList   = document.getElementById('reward-list');

Â  Â  const tabs = Array.from(document.querySelectorAll('.tbtn'));

Â  Â  const spinDailyBtn   = document.getElementById('spin-daily');

Â  Â  const spinPremiumBtn = document.getElementById('spin-premium');

Â  Â  const spinEcoinBtn   = document.getElementById('spin-ecoin');

Â  Â  let dailyCache = null;

Â  Â  let currentMode = 'daily';

Â  Â  let activeItems = [];

Â  Â  /* ====== ğŸ”’ ì´ë²¤íŠ¸ ì ê¸ˆ(ìº”ìŠ¬) ìœ í‹¸ ====== */

Â  Â  let eventLockUntil = 0;

Â  Â  function isEventLocked(){ return Date.now() < eventLockUntil; }

Â  Â  function cancelEvents(reason='ì´ë²¤íŠ¸ ì¼ì‹œ ì¤‘ì§€'){

Â  Â  Â  eventLockUntil = Date.now() + 5601000; // 5ë¶„ ì ê¸ˆ

Â  Â  Â  try { showToast(ğŸŸï¸ ${reason} (5ë¶„), null, null, 4500); } catch {}

Â  Â  Â  try {

Â  Â  Â  Â  const info = document.getElementById('daily-info');

Â  Â  Â  Â  if (info) info.innerHTML = 'âš ï¸ ì•ˆì „ ì ê²€ìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';

Â  Â  Â  } catch {}

Â  Â  Â  updateSpinButtons();

Â  Â  }

Â  Â  function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }

Â  Â  function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }

Â  Â  dailyCloseBtn.onclick = closeDailyOverlay;

Â  Â  probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

Â  Â  function setMode(mode){

Â  Â  Â  currentMode = mode;

Â  Â  Â  tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));

Â  Â  Â  activeItems = getItemsForMode(mode);

Â  Â  Â  slotWrap.style.display     = 'flex';

Â  Â  Â  document.getElementById('spin-daily').style.display   = (mode==='daily')? 'inline-block':'none';

Â  Â  Â  document.getElementById('spin-premium').style.display = (mode==='premium')? 'inline-block':'none';

Â  Â  Â  document.getElementById('spin-ecoin').style.display   = (mode==='ecoin')? 'inline-block':'none';

Â  Â  Â  buildSlot(activeItems);

Â  Â  Â  buildProbPanel(activeItems, mode);

Â  Â  Â  buildRewardList(activeItems);

Â  Â  Â  updateSpinButtons();

Â  Â  }

Â  Â  tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

Â  Â  function buildProbPanel(items, mode){

Â  Â  Â  const total=items.reduce((a,b)=>a+b.w,0)||1;

Â  Â  Â  const rows=items.map(it=><tr><td>${it.icon||''} ${it.label||it.key}</td><td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td></tr>).join('');

Â  Â  Â  const header = mode==='daily' ? 'ì¶œì„ ìŠ¬ë¡¯ í™•ë¥ '

Â  Â  Â  Â  Â  Â  Â  Â  Â  : mode==='premium' ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ í™•ë¥ (EC -1)'

Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ í™•ë¥ (EC -10)';

Â  Â  Â  probPanel.innerHTML = <div style="margin-bottom:6px; color:#9fdcff;">${header}</div><table>${rows}</table>;

Â  Â  }

Â  Â  function buildRewardList(items){

Â  Â  Â  rewardList.innerHTML = 'ğŸ° ë³´ìƒ ëª©ë¡: ' + items.map(it=>${it.icon||''} ${it.label||it.key}).join(' Â· ');

Â  Â  }

Â  Â  function canClaimToday(){

Â  Â  Â  const today = kstDayKey();

Â  Â  Â  return dailyCache?.lastKey !== today;

Â  Â  }

Â  Â  function refreshDailyInfo(canClaim){

Â  Â  Â  const today = kstDayKey();

Â  Â  Â  const streak = dailyCache?.streak || 0;

Â  Â  Â  const resetLeft = Math.max(0, nextResetKST()-kstDate());

Â  Â  Â  const leftText = canClaim ? 'ì§€ê¸ˆ ê°€ëŠ¥' : ë‹¤ìŒ ì¶œì„ê¹Œì§€ ${fmtLeft(resetLeft)};

Â  Â  Â  if (!dailyUnlocked){

Â  Â  Â  Â  const need = Math.max(0, 100 - (state.coins||0));

Â  Â  Â  Â  dailyInfo.innerHTML = ğŸ”’ ì¶œì„ ë³´ìƒì€ <b>100ì½”ì¸</b> ëª¨ìœ¼ë©´ í•´ì œ!<br>ë‚¨ì€ ì½”ì¸: <b>${formatKR(need)}</b>;

Â  Â  Â  Â  spinDailyBtn.disabled = true;

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  dailyInfo.innerHTML = canClaim

Â  Â  Â  Â  ? ì˜¤ëŠ˜(${today}) ì¶œì„ ìŠ¬ë¡¯ ê°€ëŠ¥! <b>${leftText}</b><br>ì—°ì† ${streak}ì¼

Â  Â  Â  Â  : ì˜¤ëŠ˜(${today})ì€ ì´ë¯¸ ì™„ë£Œ. <b>${leftText}</b><br>í˜„ì¬ ì—°ì† ${streak}ì¼;

Â  Â  Â  spinDailyBtn.disabled = !canClaim;

Â  Â  }

Â  Â  async function applyPrizeTransaction(delta){

Â  Â  Â  await runTransaction(dataRef, current => {

Â  Â  Â  Â  const cur = current || { ...defaultData };

Â  Â  Â  Â  const next = { ...cur };

Â  Â  Â  Â  next.coins      = (next.coins||0) + (delta.coins||0);

Â  Â  Â  Â  next.resources  = (next.resources||0) + (delta.resources||0);

Â  Â  Â  Â  next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);

Â  Â  Â  Â  next._lastUpdated = Date.now();

Â  Â  Â  Â  return next;

Â  Â  Â  });

Â  Â  }

Â  Â  function makeDeltaSnapshot(){

Â  Â  Â  return { coins: state.coins||0, resources: state.resources||0, eventCoins: state.eventCoins||0 };

Â  Â  }

Â  Â  function deltaFrom(before){

Â  Â  Â  return {

Â  Â  Â  Â  coins: (state.coins||0) - before.coins,

Â  Â  Â  Â  resources: (state.resources||0) - before.resources,

Â  Â  Â  Â  eventCoins: (state.eventCoins||0) - before.eventCoins

Â  Â  Â  };

Â  Â  }

Â  Â  function pickWeighted(items){ const s=items.reduce((a,b)=>a+b.w,0); let r=Math.random()*s; for(const it of items){ if((r-=it.w)<=0) return it; } return items.at(-1); }

Â  Â  function canSpendEC(n){ return (state.eventCoins||0) >= n; }

Â  Â  /* ğŸ” ë²„íŠ¼ ìƒíƒœ(ì ê¸ˆ í¬í•¨) */

Â  Â  function updateSpinButtons(){

Â  Â  Â  const locked = isEventLocked();

Â  Â  Â  const canDaily   = dailyUnlocked && canClaimToday() && !isSpinning;

Â  Â  Â  const canPremium = canSpendEC(1)  && !isSpinning;

Â  Â  Â  const canEcoin   = canSpendEC(10) && !isSpinning;

Â  Â  Â  spinDailyBtn.disabled   = locked || !canDaily;

Â  Â  Â  spinPremiumBtn.disabled = locked || !canPremium;

Â  Â  Â  spinEcoinBtn.disabled   = locked || !canEcoin;

Â  Â  Â  if (locked && dailyInfo){

Â  Â  Â  Â  dailyInfo.innerHTML = 'âš ï¸ ì•ˆì „ ì ê²€ìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';

Â  Â  Â  }

Â  Â  }

Â  Â  async function tryUnlockDaily(){

Â  Â  Â  if (!uid || dailyUnlocked) return;

Â  Â  Â  if ((state.coins || 0) >= 100){

Â  Â  Â  Â  dailyUnlocked = true;

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  await update(ref(db), { [${userBasePath}/daily/unlocked]: true });

Â  Â  Â  Â  } catch(e){ console.warn('unlock save error', e); }

Â  Â  Â  Â  showToast('ğŸ”“ ì¶œì„ ë³´ìƒ ì ê¸ˆ í•´ì œ!', 'ì§€ê¸ˆ ì—´ê¸°', () => {

Â  Â  Â  Â  Â  setMode('daily'); openDailyOverlay();

Â  Â  Â  Â  });

Â  Â  Â  Â  refreshDailyInfo(canClaimToday());

Â  Â  Â  Â  updateAttendanceLabels();

Â  Â  Â  Â  updateSpinButtons();

Â  Â  Â  }

Â  Â  }

Â  Â  async function handleSpin(mode){

Â  Â  Â  if (!uid || !window.__PLAY_ALLOWED || isSpinning) return;

Â  Â  Â  if (!security.tosAccepted){ showTosOverlay(true); return; }

Â  Â  Â  if (security.banned){ showBanOverlay(true); return; }

Â  Â  Â  // ğŸ”’ ì´ë²¤íŠ¸ ì ê¸ˆ ì¤‘ì´ë©´ ì°¨ë‹¨

Â  Â  Â  if (isEventLocked()){

Â  Â  Â  Â  dailyInfo.innerHTML = 'ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';

Â  Â  Â  Â  updateSpinButtons();

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  if (mode==='daily' && !dailyUnlocked) { refreshDailyInfo(false); return; }

Â  Â  Â  if (mode==='premium' && !canSpendEC(1)) { dailyInfo.innerHTML='ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 1)'; return; }

Â  Â  Â  if (mode==='ecoin'   && !canSpendEC(10)){ dailyInfo.innerHTML='ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 10)'; return; }

Â  Â  Â  setMode(mode);

Â  Â  Â  const picked = pickWeighted(activeItems);

Â  Â  Â  const before = makeDeltaSnapshot();

Â  Â  Â  if (mode==='premium') { auditSpend('eco', 1);  state.eventCoins -= 1; }

Â  Â  Â  if (mode==='ecoin')   { auditSpend('eco', 10); state.eventCoins -= 10; }

Â  Â  Â  isSpinning = true; updateSpinButtons();

Â  Â  Â  await spinSlot(activeItems, picked);

Â  Â  Â  picked.onWin();

Â  Â  Â  try{

Â  Â  Â  Â  const delta = deltaFrom(before);

Â  Â  Â  Â  await applyPrizeTransaction(delta); updateUI();

Â  Â  Â  Â  if (mode==='daily'){

Â  Â  Â  Â  Â  const today = kstDayKey(); const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));

Â  Â  Â  Â  Â  let streak = Number(dailyCache?.streak||0);

Â  Â  Â  Â  Â  if (dailyCache?.lastKey === yesterday) streak+=1; else streak=1;

Â  Â  Â  Â  Â  await update(ref(db), {

Â  Â  Â  Â  Â  Â  [${userBasePath}/daily]: { ...(dailyCache||{}), unlocked: true, lastKey: today, streak, lastClaimAt: Date.now(), lastPrize: picked.key }

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  dailyCache = { ...(dailyCache||{}), lastKey: today, streak, unlocked:true };

Â  Â  Â  Â  Â  dailyInfo.innerHTML = ğŸ‰ ë‹¹ì²¨: <b>${picked.label}</b><br>ì—°ì† ${streak}ì¼;

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  dailyInfo.innerHTML = (mode==='premium')

Â  Â  Â  Â  Â  Â  ? ğŸ‰ í”„ë¦¬ë¯¸ì—„ ë‹¹ì²¨: <b>${picked.label}</b>

Â  Â  Â  Â  Â  Â  : ğŸ‰ EC ìŠ¬ë¡¯ ë‹¹ì²¨: <b>${picked.label}</b>;

Â  Â  Â  Â  }

Â  Â  Â  }catch(e){

Â  Â  Â  Â  console.error(e);

Â  Â  Â  Â  dailyInfo.textContent='ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

Â  Â  Â  }finally{

Â  Â  Â  Â  isSpinning = false; updateSpinButtons();

Â  Â  Â  }

Â  Â  }

Â  Â  document.getElementById('spin-daily').onclick   = ()=>handleSpin('daily');

Â  Â  document.getElementById('spin-premium').onclick = ()=>handleSpin('premium');

Â  Â  document.getElementById('spin-ecoin').onclick   = ()=>handleSpin('ecoin');

Â  Â  async function fetchDaily(){

Â  Â  Â  if (!uid) return;

Â  Â  Â  try{

Â  Â  Â  Â  const snap = await get(ref(db, ${userBasePath}/daily));

Â  Â  Â  Â  const v = snap.exists() ? snap.val() : { lastKey:null, streak:0, unlocked:false };

Â  Â  Â  Â  dailyCache = v;

Â  Â  Â  Â  dailyUnlocked = v?.unlocked ? true : false;

Â  Â  Â  }catch{

Â  Â  Â  Â  dailyCache = { lastKey:null, streak:0, unlocked:false }; dailyUnlocked = false;

Â  Â  Â  }

Â  Â  }

Â  Â  async function checkDailyAndMaybeShow(){

Â  Â  Â  await fetchDaily();

Â  Â  Â  refreshDailyInfo(canClaimToday());

Â  Â  Â  setMode('daily');

Â  Â  Â  if (dailyUnlocked && canClaimToday()) openDailyOverlay();

Â  Â  }

Â  Â  const attMenuRight = document.getElementById('attendance-left');

Â  Â  const attSideRight = document.getElementById('attendance-left-side');

Â  Â  function updateAttendanceLabels(){

Â  Â  Â  if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }

Â  Â  Â  if (!dailyUnlocked){ attMenuRight.textContent='ì ê¸ˆ'; attSideRight.textContent='ì ê¸ˆ'; return; }

Â  Â  Â  const today = kstDayKey();

Â  Â  Â  const can = (dailyCache?.lastKey !== today);

Â  Â  Â  if (can){ attMenuRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; attSideRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; }

Â  Â  Â  else{

Â  Â  Â  Â  const left = Math.max(0, nextResetKST()-kstDate());

Â  Â  Â  Â  const txt = fmtLeft(left);

Â  Â  Â  Â  attMenuRight.textContent=txt; attSideRight.textContent=txt;

Â  Â  Â  }

Â  Â  }

Â  Â  setInterval(updateAttendanceLabels, 1000);

Â  Â  function setShipImage(level) {

Â  Â  Â  const img = document.getElementById('ship-img');

Â  Â  Â  if (!img) return;

Â  Â  Â  let attempted = Math.max(1, level);

Â  Â  Â  img.onerror = function onErr() {

Â  Â  Â  Â  if (attempted > 1) {

Â  Â  Â  Â  Â  attempted -= 1;

Â  Â  Â  Â  Â  img.src = /images/ship-level${attempted}.png;

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  img.onerror = null;

Â  Â  Â  Â  Â  img.src = /images/ship-level1.png;

Â  Â  Â  Â  }

Â  Â  Â  };

Â  Â  Â  img.src = /images/ship-level${attempted}.png;

Â  Â  }

Â  Â  const authContainer = document.getElementById('auth-container');

Â  Â  const authErrorEl   = document.getElementById('auth-error');

Â  Â  const bootOverlay   = document.getElementById('boot-overlay');

Â  Â  // â˜… ë¶€íŒ… ì˜¤ë²„ë ˆì´ëŠ” 'ì²˜ìŒ 1íšŒ'ë§Œ

Â  Â  function setBootVisible(v){

Â  Â  Â  if (!bootOverlay) return;

Â  Â  Â  const seen = localStorage.getItem('boot_seen') === '1';

Â  Â  Â  if (seen) {

Â  Â  Â  Â  bootOverlay.style.display = 'none';

Â  Â  Â  Â  bootOverlay.setAttribute('aria-hidden','true');

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  bootOverlay.style.display = v ? 'flex' : 'none';

Â  Â  Â  bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');

Â  Â  }

Â  Â  function showAuthStatus(msg, isError = true) {

Â  Â  Â  authErrorEl.textContent = msg || '';

Â  Â  Â  if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');

Â  Â  Â  authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';

Â  Â  }

Â  Â  function showGameUI() {

Â  Â  Â  try {

Â  Â  Â  Â  authContainer.classList.add('hidden');

Â  Â  Â  Â  try { history.replaceState(null, '', '/ê²Œì„' + (location.hash || '')); } catch {}

Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  authContainer.style.display = 'none';

Â  Â  Â  Â  Â  ['top-bar','container'].forEach(id => {

Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);

Â  Â  Â  Â  Â  Â  if (el) el.style.visibility = 'visible';

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }, 300);

Â  Â  Â  } catch (e) { console.error('showGameUI error', e); }

Â  Â  }

Â  Â  /* ===========================

Â  Â  Â  Â âš ï¸ ë³´ì•ˆ/ì•½ê´€/ì˜ì‹¬ë„ (ê°•í™”íŒ)

Â  Â  Â  Â =========================== */

Â  Â  let security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };

Â  Â  let securityDirty = false;

Â  Â  // ì„ê³„ê°’

Â  Â  const SEC_WARN_LEVEL = 20;  // ê²½ê³ 

Â  Â  const SEC_BAN_LEVEL  = 30;  // ì •ì§€

Â  Â  // ê°ì§€ íŒŒë¼ë¯¸í„°(ë” ê¹ê¹í•˜ê²Œ)

Â  Â  const EPS               = 1e-6;

Â  Â  const UNKNOWN_THRESH    = 0.05;

Â  Â  const HUMAN_MAX_CPS     = 12;

Â  Â  const MAX_TICK_GAP_MS   = 5000;

Â  Â  const RES_WEIGHT        = 0.8;

Â  Â  const COIN_WEIGHT       = 1.0;

Â  Â  const ECO_WEIGHT        = 1.2;

Â  Â  // â˜… ì¦‰ì‹œ ë°´ ê¸‰ì¦ í•œê³„

Â  Â  const BAN_SPIKE_COINS = 1_000_000_000;

Â  Â  const BAN_SPIKE_RES   = 100_000_000;

Â  Â  const BAN_SPIKE_ECO   = 50_000;

Â  Â  // ì˜ì‹¬ë„ ë°°ì§€ ë Œë”(í™”ë©´ì—ì„  ìˆ¨ê¹€ ìƒíƒœ)

Â  Â  function renderSecurityBadge(){

Â  Â  Â  const el = document.getElementById('suspicion-badge');

Â  Â  Â  if (!el) return;

Â  Â  Â  el.classList.remove('warn','ban');

Â  Â  Â  el.textContent = ì˜ì‹¬ë„: ${Math.round(security.suspicion)};

Â  Â  Â  if (security.suspicion >= SEC_BAN_LEVEL){ el.classList.add('ban'); }

Â  Â  Â  else if (security.suspicion > SEC_WARN_LEVEL){ el.classList.add('warn'); }

Â  Â  }

Â  Â  function showTosOverlay(show=true){

Â  Â  Â  const ov = document.getElementById('tos-overlay');

Â  Â  Â  if (ov){ ov.classList.toggle('show', !!show); ov.setAttribute('aria-hidden', show?'false':'true'); }

Â  Â  }

Â  Â  function showBanOverlay(show=true){

Â  Â  Â  const ov = document.getElementById('ban-overlay');

Â  Â  Â  if (ov){

Â  Â  Â  Â  document.getElementById('ban-sus-value').textContent = Math.round(security.suspicion || 0);

Â  Â  Â  Â  ov.classList.toggle('show', !!show); ov.setAttribute('aria-hidden', show?'false':'true');

Â  Â  Â  }

Â  Â  }

Â  Â  function markTosViolationFlag(){

Â  Â  Â  const vio = security.suspicion > SEC_WARN_LEVEL || security.banned;

Â  Â  Â  if (security.tosViolated !== vio){ security.tosViolated = vio; securityDirty = true; }

Â  Â  }

Â  Â  async function loadSecurity(){

Â  Â  Â  try {

Â  Â  Â  Â  const snap = await get(ref(db, ${userBasePath}/security));

Â  Â  Â  Â  if (snap.exists()){

Â  Â  Â  Â  Â  const v = snap.val() || {};

Â  Â  Â  Â  Â  security = { ...security, ...v };

Â  Â  Â  Â  }

Â  Â  Â  } catch {}

Â  Â  Â  markTosViolationFlag();

Â  Â  Â  await saveSecurity();

Â  Â  }

Â  Â  async function saveSecurity(){

Â  Â  Â  if (!uid || !userBasePath) return;

Â  Â  Â  if (!securityDirty) return;

Â  Â  Â  try {

Â  Â  Â  Â  await update(ref(db), { [${userBasePath}/security]: {

Â  Â  Â  Â  Â  suspicion: security.suspicion,

Â  Â  Â  Â  Â  banned: security.banned,

Â  Â  Â  Â  Â  tosAccepted: security.tosAccepted,

Â  Â  Â  Â  Â  tosViolated: security.tosViolated,

Â  Â  Â  Â  Â  fairSeconds: security.fairSeconds,

Â  Â  Â  Â  Â  lastWarnAt: security.lastWarnAt

Â  Â  Â  Â  }});

Â  Â  Â  } catch {}

Â  Â  Â  securityDirty = false;

Â  Â  }

Â  Â  // â˜… NEW: ì§€ì› ì»¨í…ìŠ¤íŠ¸ ì €ì¥/ë³µêµ¬

Â  Â  const SUPPORT_CTX_KEY = 'siu_support_ctx';

Â  Â  function saveSupportCtx(extra = {}) {

Â  Â  Â  const ctx = {

Â  Â  Â  Â  server: userServerKey || null,

Â  Â  Â  Â  idKey: userIdKey || null,

Â  Â  Â  Â  basePath: userBasePath || null,

Â  Â  Â  Â  uid: uid || null,

Â  Â  Â  Â  suspicion: (security && typeof security.suspicion === 'number') ? security.suspicion : null,

Â  Â  Â  Â  banned: !!(security && security.banned),

Â  Â  Â  Â  ts: Date.now(),

Â  Â  Â  Â  ...extra

Â  Â  Â  };

Â  Â  Â  try { localStorage.setItem(SUPPORT_CTX_KEY, JSON.stringify(ctx)); } catch {}

Â  Â  Â  return ctx;

Â  Â  }

Â  Â  function readSupportCtx() {

Â  Â  Â  try {

Â  Â  Â  Â  const raw = localStorage.getItem(SUPPORT_CTX_KEY);

Â  Â  Â  Â  return raw ? JSON.parse(raw) : null;

Â  Â  Â  } catch { return null; }

Â  Â  }

Â  Â  /* âœ… ì¶”ê°€: ë°´ ë˜ì¹˜/ì˜¤ë²„ë ˆì´ ì¼ê´„ í•´ì œ ìœ í‹¸ */

Â  Â  function clearSupportCtx(){

Â  Â  Â  try { localStorage.removeItem(SUPPORT_CTX_KEY); } catch {}

Â  Â  }

Â  Â  function hideAllOverlays(){

Â  Â  Â  try{ showBanOverlay(false); }catch{}

Â  Â  Â  try{ showTosOverlay(false); }catch{}

Â  Â  Â  try{ showMigrateOverlay(false); }catch{}

Â  Â  Â  try{

Â  Â  Â  Â  const ov = document.getElementById('daily-overlay');

Â  Â  Â  Â  if (ov){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }

Â  Â  Â  }catch{}

Â  Â  Â  /* âœ… ì •ì±…(inframe) ì˜¤ë²„ë ˆì´ë„ í•¨ê»˜ ë‹«ê¸° */

Â  Â  Â  try{

Â  Â  Â  Â  const pov = document.getElementById('policy-overlay');

Â  Â  Â  Â  if (pov){ pov.classList.remove('show'); pov.setAttribute('aria-hidden','true'); }

Â  Â  Â  }catch{}

Â  Â  }

Â  Â  // === í•©ë²• ì¦ê° ì¥ë¶€(ì¦ê°€Â·ì§€ì¶œÂ·ê·œëª¨ ë°˜ì˜) ===

Â  Â  let audit = {

Â  Â  Â  last: null,

Â  Â  Â  recGain:  { res:0, coin:0, eco:0 },

Â  Â  Â  recSpend: { res:0, coin:0, eco:0 },

Â  Â  Â  lastAt: 0

Â  Â  };

Â  Â  function auditInit(){

Â  Â  Â  audit.last   = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };

Â  Â  Â  audit.recGain  = { res:0, coin:0, eco:0 };

Â  Â  Â  audit.recSpend = { res:0, coin:0, eco:0 };

Â  Â  Â  audit.lastAt = Date.now();

Â  Â  }

Â  Â  function auditGain(kind, amount){

Â  Â  Â  const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);

Â  Â  Â  if (!audit.recGain[k]) audit.recGain[k] = 0;

Â  Â  Â  audit.recGain[k] += Number(amount||0);

Â  Â  }

Â  Â  function auditSpend(kind, amount){

Â  Â  Â  const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);

Â  Â  Â  if (!audit.recSpend[k]) audit.recSpend[k] = 0;

Â  Â  Â  audit.recSpend[k] += Number(amount||0);

Â  Â  }

Â  Â  // ê¸°ì¡´ í˜¸í™˜

Â  Â  function auditAdd(kind, amount){ auditGain(kind, amount); }

Â  Â  function auditResetCycle(){

Â  Â  Â  audit.recGain  = { res:0, coin:0, eco:0 };

Â  Â  Â  audit.recSpend = { res:0, coin:0, eco:0 };

Â  Â  Â  audit.last     = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };

Â  Â  Â  audit.lastAt   = Date.now();

Â  Â  }

Â  Â  // âœ… ì˜ë„ëœ(í•©ë²•) ì§€ê¸‰ì„ ë¯¸ë¦¬ ì‹ ê³ í•´ ì˜¤íƒì„ ì°¨ë‹¨í•˜ëŠ” í—ˆìš© ì°½

Â  Â  let auditIntent = { res:0, coin:0, eco:0, until:0 };

Â  Â  function registerAuditIntent(kind, amount, windowMs=6000){

Â  Â  Â  const now = Date.now();

Â  Â  Â  if (auditIntent.until < now) auditIntent = { res:0, coin:0, eco:0, until: now + windowMs };

Â  Â  Â  const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);

Â  Â  Â  auditIntent[k] = (auditIntent[k] || 0) + Math.max(0, Number(amount||0));

Â  Â  Â  auditIntent.until = Math.max(auditIntent.until, now + windowMs);

Â  Â  }

Â  Â  // === Vercel BAN ì—”ë“œí¬ì¸íŠ¸ ìë™ ë¡œë” (RTDB meta/banEndpoint ì‚¬ìš©) ===

Â  Â  let __BAN_ENDPOINT = null;

Â  Â  async function __getBanEndpoint() {

Â  Â  Â  if (__BAN_ENDPOINT) return __BAN_ENDPOINT;

Â  Â  Â  try {

Â  Â  Â  Â  const snap = await get(ref(db, 'meta/banEndpoint'));

Â  Â  Â  Â  if (snap.exists()) __BAN_ENDPOINT = String(snap.val());

Â  Â  Â  } catch {}

Â  Â  Â  return __BAN_ENDPOINT;

Â  Â  }

Â  Â  async function requestAccountDisable(reason = 'auto-ban') {

Â  Â  Â  try {

Â  Â  Â  Â  const url = await __getBanEndpoint();

Â  Â  Â  Â  if (!url || !auth?.currentUser) return;

Â  Â  Â  Â  const idToken = await auth.currentUser.getIdToken(true);

Â  Â  Â  Â  await fetch(url, {

Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  headers: { 'Content-Type':'application/json' },

Â  Â  Â  Â  Â  body: JSON.stringify({

Â  Â  Â  Â  Â  Â  idToken,

Â  Â  Â  Â  Â  Â  reason,

Â  Â  Â  Â  Â  Â  suspicion: security?.suspicion ?? null

Â  Â  Â  Â  Â  })

Â  Â  Â  Â  });

Â  Â  Â  } catch (e) { console.warn('ban endpoint failed', e); }

Â  Â  }

Â  Â  // í—ˆìš© í•œê³„(ë³´ìˆ˜ì )

Â  Â  function expectedResGain(dtSec){

Â  Â  Â  const resBuff = activeBuffFactor('res');

Â  Â  Â  const workerGain = (state.workerCount * getWorkerPower()) * resBuff * dtSec;

Â  Â  Â  const clickGain  = (state.clickPower || 1) * HUMAN_MAX_CPS * resBuff * dtSec;

Â  Â  Â  return workerGain + clickGain + 0.5;

Â  Â  }

Â  Â  function expectedCoinGain(dtSec){

Â  Â  Â  const coinBuff = activeBuffFactor('coin');

Â  Â  Â  const convGain = (state.conversionCount || 0) * coinBuff * dtSec;

Â  Â  Â  return convGain + 2;

Â  Â  }

Â  Â  // ì˜ì‹¬ë„ ì¡°ì • + ê²½ê³ /ì •ì§€ íŠ¸ë¦¬ê±°

Â  Â  function adjustSuspicion(delta){

Â  Â  Â  const prev = security.suspicion;

Â  Â  Â  security.suspicion = Math.max(0, Math.min(1000, prev + delta));

Â  Â  Â  if (!security.banned && security.suspicion > SEC_WARN_LEVEL){

Â  Â  Â  Â  const now = Date.now();

Â  Â  Â  Â  if (!security.lastWarnAt || now - security.lastWarnAt > 60000){

Â  Â  Â  Â  Â  security.lastWarnAt = now;

Â  Â  Â  Â  Â  showToast('âš ï¸ ì˜ì‹¬ë„ê°€ 20ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë¹„ì •ìƒ ì¦ê°€ê°€ íƒì§€ë˜ë©´ ì •ì§€ë  ìˆ˜ ìˆì–´ìš”.');

Â  Â  Â  Â  Â  securityDirty = true;

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  Â  if (security.suspicion >= SEC_BAN_LEVEL && !security.banned){

Â  Â  Â  Â  security.banned = true;

Â  Â  Â  Â  securityDirty = true;

Â  Â  Â  Â  requestAccountDisable('auto-ban:suspicion>=30').finally(async ()=>{

Â  Â  Â  Â  Â  showBanOverlay(true);

Â  Â  Â  Â  Â  showToast('â›” ì˜ì‹¬ë„ 30 ì´ìƒìœ¼ë¡œ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');

Â  Â  Â  Â  Â  try { await saveSecurity(); } catch {}

Â  Â  Â  Â  Â  saveSupportCtx({ banned: true });

Â  Â  Â  Â  Â  try { await auth.signOut(); } catch {}

Â  Â  Â  Â  });

Â  Â  Â  }

Â  Â  Â  markTosViolationFlag();

Â  Â  Â  securityDirty = true;

Â  Â  Â  renderSecurityBadge();

Â  Â  }

Â  Â  // ê·œëª¨ ê°€ì¤‘ í¬í•¨ ê°ì§€

Â  Â  function auditCheck(){

Â  Â  Â  if (!audit.last){ auditInit(); return; }

Â  Â  Â  const now = Date.now();

Â  Â  Â  let dtMs = now - (audit.lastAt || now);

Â  Â  Â  if (dtMs < 0) dtMs = 0;

Â  Â  Â  if (dtMs > MAX_TICK_GAP_MS) dtMs = MAX_TICK_GAP_MS;

Â  Â  Â  const dtSec = dtMs / 1000;

Â  Â  Â  const cur = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };

Â  Â  Â  let dr = cur.res   - audit.last.res;   // ì‹¤ì¸¡ ë³€í™”ëŸ‰

Â  Â  Â  let dc = cur.coins - audit.last.coins;

Â  Â  Â  let de = cur.eco   - audit.last.eco;

Â  Â  Â  // âœ… ì˜ë„ í—ˆìš© ì°½ ì ìš©(ì„œë²„ ë™ê¸°í™” íƒ€ì´ë°ìœ¼ë¡œ ì¸í•œ ë ˆì´ìŠ¤ ë³´ì •)

Â  Â  Â  if (now <= (auditIntent.until||0)) {

Â  Â  Â  Â  const useRes = Math.min(Math.max(0, dr), auditIntent.res||0);

Â  Â  Â  Â  const useCoin= Math.min(Math.max(0, dc), auditIntent.coin||0);

Â  Â  Â  Â  const useEco = Math.min(Math.max(0, de), auditIntent.eco||0);

Â  Â  Â  Â  dr -= useRes; dc -= useCoin; de -= useEco;

Â  Â  Â  Â  auditIntent.res  -= useRes;

Â  Â  Â  Â  auditIntent.coin -= useCoin;

Â  Â  Â  Â  auditIntent.eco  -= useEco;

Â  Â  Â  } else {

Â  Â  Â  Â  // ì°½ ì¢…ë£Œ ì‹œ ì”ì—¬ëŠ” íê¸°

Â  Â  Â  Â  auditIntent = { res:0, coin:0, eco:0, until:0 };

Â  Â  Â  }

Â  Â  Â  // ì¦‰ì‹œ ë°´ê¸‰ ê¸‰ì¦ (ì ˆëŒ€ì¹˜)

Â  Â  Â  if (dc >= BAN_SPIKE_COINS || dr >= BAN_SPIKE_RES || de >= BAN_SPIKE_ECO) {

Â  Â  Â  Â  adjustSuspicion(SEC_BAN_LEVEL + 1);

Â  Â  Â  Â  auditResetCycle();

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  Â  // ì¥ë¶€ìƒ ê¸°ëŒ€ ë³€í™”ëŸ‰ = í•©ë²• ì¦ê°€ - í•©ë²• ì§€ì¶œ

Â  Â  Â  const legRes  = (audit.recGain.res  - audit.recSpend.res);

Â  Â  Â  const legCoin = (audit.recGain.coin - audit.recSpend.coin);

Â  Â  Â  const legEco  = (audit.recGain.eco  - audit.recSpend.eco);

Â  Â  Â  // ë¬¼ë¦¬ì  ìƒí•œ(ë²„í”„ í¬í•¨, í´ë¦­ ê°€ëŠ¥ ìµœëŒ€ì¹˜/ì•Œë°” ìˆ˜ìµ ë“±)

Â  Â  Â  const physResRoom  = expectedResGain(dtSec);

Â  Â  Â  const physCoinRoom = expectedCoinGain(dtSec);

Â  Â  Â  // ì„¤ëª… ì•ˆë˜ëŠ” "ìˆœì¦ê°€"

Â  Â  Â  const unknownRes  = Math.max(0, dr - legRes);

Â  Â  Â  const unknownCoin = Math.max(0, dc - legCoin);

Â  Â  Â  const unknownEco  = Math.max(0, de - legEco);

Â  Â  Â  // ìƒí•œ ì´ˆê³¼ ìŠ¤íŒŒì´í¬

Â  Â  Â  const spikeRes  = Math.max(0, dr - (legRes  + physResRoom));

Â  Â  Â  const spikeCoin = Math.max(0, dc - (legCoin + physCoinRoom));

Â  Â  Â  /* âœ… ìŠ¬ë¡¯ ì™¸ ì¶œì²˜ ë¶ˆëª… EC ì¦ê°€ â†’ ë¡¤ë°± + ì´ë²¤íŠ¸ 5ë¶„ ì ê¸ˆ(ìº”ìŠ¬) */

Â  Â  Â  if (unknownEco > EPS) {

Â  Â  Â  Â  const rollback = Math.min(Math.floor(unknownEco), Math.floor(state.eventCoins || 0));

Â  Â  Â  Â  if (rollback > 0) {

Â  Â  Â  Â  Â  state.eventCoins -= rollback;   // ì¦‰ì‹œ ì›ë³µ

Â  Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  Â  }

Â  Â  Â  Â  cancelEvents('ë¹„ì •ìƒ ì´ë²¤íŠ¸ì½”ì¸ ì¦ê°€ ê°ì§€');

Â  Â  Â  }

Â  Â  Â  // ê·œëª¨ ë¡œê·¸ ê°€ì¤‘

Â  Â  Â  const mag = Math.log10(1

Â  Â  Â  Â  + unknownRes

Â  Â  Â  Â  + (unknownCoin * 10)

Â  Â  Â  Â  + (unknownEco  * 20)

Â  Â  Â  Â  + spikeRes

Â  Â  Â  Â  + (spikeCoin * 10)

Â  Â  Â  );

Â  Â  Â  // ë¹„ìœ¨ ê°€ì¤‘(ì˜ˆìƒ ìƒí•œ ëŒ€ë¹„ ì´ˆê³¼ ë°°ìœ¨)

Â  Â  Â  const ratioRes  = physResRoom  > 0 ? (dr - legRes) / physResRoom   : 0;

Â  Â  Â  const ratioCoin = physCoinRoom > 0 ? (dc - legCoin) / physCoinRoom : 0;

Â  Â  Â  const ratioBoost = Math.max(0, ratioRes - 1) + Math.max(0, ratioCoin - 1);

Â  Â  Â  // ê¸°ë³¸ ì ìˆ˜

Â  Â  Â  const baseUnknown =

Â  Â  Â  Â  (unknownRes  > EPS ? unknownRes  * RES_WEIGHT  : 0) +

Â  Â  Â  Â  (unknownCoin > EPS ? unknownCoin * COIN_WEIGHT : 0) +

Â  Â  Â  Â  (unknownEco  > EPS ? unknownEco  * ECO_WEIGHT  : 0);

Â  Â  Â  const baseSpike =

Â  Â  Â  Â  (spikeRes  > EPS ? spikeRes  * 1.6 : 0) +

Â  Â  Â  Â  (spikeCoin > EPS ? spikeCoin * 1.6 : 0);

Â  Â  Â  // ìµœì¢… ì˜ì‹¬ì ìˆ˜

Â  Â  Â  let score = (baseUnknown + baseSpike) * (1 + 0.6mag + 0.8ratioBoost);

Â  Â  Â  if (score > UNKNOWN_THRESH){

Â  Â  Â  Â  const add = Math.min(24, Math.max(2, Math.ceil(score)));

Â  Â  Â  Â  adjustSuspicion(add);

Â  Â  Â  Â  security.fairSeconds = 0;

Â  Â  Â  Â  securityDirty = true;

Â  Â  Â  } else {

Â  Â  Â  Â  security.fairSeconds = (security.fairSeconds||0) + dtSec;

Â  Â  Â  Â  if (security.fairSeconds >= 90 && security.suspicion > 0){

Â  Â  Â  Â  Â  adjustSuspicion(-1);

Â  Â  Â  Â  Â  security.fairSeconds = 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  securityDirty = true;

Â  Â  Â  }

Â  Â  Â  auditResetCycle();

Â  Â  }

Â  Â  /* ======================

Â  Â  Â  Â ì§€ì›(ì˜¤íƒ) ë©”ì¼/ë³µì‚¬

Â  Â  Â  Â ====================== */

Â  Â  function buildSupportInfoText(){

Â  Â  Â  const persisted = readSupportCtx();

Â  Â  Â  const server = userServerKey || persisted?.server || '(ì•Œ ìˆ˜ ì—†ìŒ)';

Â  Â  Â  const idKey  = userIdKey     || persisted?.idKey  || '(ì•Œ ìˆ˜ ì—†ìŒ)';

Â  Â  Â  const path   = userBasePath  || persisted?.basePath || '(ì•Œ ìˆ˜ ì—†ìŒ)';

Â  Â  Â  const nowKST = kstDate().toLocaleString('ko-KR');

Â  Â  Â  const uidStr = uid || persisted?.uid || '(ë¯¸ë¡œê·¸ì¸)';

Â  Â  Â  const sus    = (typeof security?.suspicion === 'number') ? security.suspicion

Â  Â  Â  Â  Â  Â  Â  Â  : (typeof persisted?.suspicion === 'number') ? persisted.suspicion : null;

Â  Â  Â  return [

Â  Â  Â  Â  ì„œë²„: ${server},

Â  Â  Â  Â  ì•„ì´ë””í‚¤: ${idKey},

Â  Â  Â  Â  Realtime DB ê²½ë¡œ: ${path},

Â  Â  Â  Â  UID: ${uidStr},

Â  Â  Â  Â  í˜„ì¬ ì˜ì‹¬ë„: ${sus === null ? '(ì•Œ ìˆ˜ ì—†ìŒ)' : sus},

Â  Â  Â  Â  ë°œìƒ ì‹œê°(KST): ${nowKST}

Â  Â  Â  ].join('\n');

Â  Â  }

Â  Â  function buildSupportMail(){

Â  Â  Â  const persisted = readSupportCtx();

Â  Â  Â  const s = userServerKey || persisted?.server || 'server?';

Â  Â  Â  const i = userIdKey     || persisted?.idKey  || 'id?';

Â  Â  Â  const subject = [Appeal] ì˜¤íƒ ê²€í†  ìš”ì²­ - ${s} / ${i};

Â  Â  Â  const header  = 'ì•ˆë…•í•˜ì„¸ìš”, ì˜¤íƒìœ¼ë¡œ ì˜ì‹¬ë˜ì–´ ê²€í† ë¥¼ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.\n';

Â  Â  Â  const info    = buildSupportInfoText();

Â  Â  Â  const footer  = '\n\nìƒì„¸ ìƒí™©:\n(ì—¬ê¸°ì— ìƒí™©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”)\n';

Â  Â  Â  const body    = ${header}\n${info}${footer};

Â  Â  Â  const mailto  = mailto:${SUPPORT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)};

Â  Â  Â  return { subject, body, mailto };

Â  Â  }

Â  Â  async function copySupportInfo(){

Â  Â  Â  try {

Â  Â  Â  Â  await navigator.clipboard.writeText(buildSupportInfoText());

Â  Â  Â  Â  showToast('ë³µì‚¬ ì™„ë£Œ! ë©”ì¼ì— ë¶™ì—¬ë„£ì–´ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.', null, null, 2500);

Â  Â  Â  } catch {

Â  Â  Â  Â  showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', null, null, 2500);

Â  Â  Â  }

Â  Â  }

Â  Â  /* ======================

Â  Â  Â  Â UI ì—…ë°ì´íŠ¸/í–‰ì„±/ë²„íŠ¼

Â  Â  Â  Â ====================== */

Â  Â  function updateUI() {

Â  Â  Â  pruneExpiredBuffs();

Â  Â  Â  document.getElementById('score').innerText  = ìì›: ${formatKR(state.resources)};

Â  Â  Â  document.getElementById('coins').innerText  = ì½”ì¸: ${formatKR(state.coins)};

Â  Â  Â  document.getElementById('ecoins').innerText = ì´ë²¤íŠ¸ì½”ì¸: ${formatKR(state.eventCoins||0)};

Â  Â  Â  document.getElementById('ship-level').innerText = ${state.shipLevel}ë ™ (${formatKR(state.shipUpgradeCost)}ì½”ì¸);

Â  Â  Â  setShipImage(state.shipLevel);

Â  Â  Â  document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

Â  Â  Â  const clickUp = document.getElementById('click-upgrade');

Â  Â  Â  clickUp.innerText = í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (${formatKR(clickUpgradeCost)}ì½”ì¸);

Â  Â  Â  clickUp.disabled  = state.coins < clickUpgradeCost;

Â  Â  Â  document.getElementById('click-power').innerText = Math.round(state.clickPower).toString();

Â  Â  Â  const autoBtn = document.getElementById('auto-convert-buy');

Â  Â  Â  autoBtn.innerHTML = state.autoConvertBought ? 'êµ¬ë§¤ ì™„ë£Œ' : ìë™ë³€í™˜ êµ¬ë§¤<br>(${formatKR(100)}ì½”ì¸);

Â  Â  Â  autoBtn.disabled = state.autoConvertBought || state.coins < 100;

Â  Â  Â  document.getElementById('convert-button').disabled = state.resources < 10;

Â  Â  Â  const hireWork = document.getElementById('hire-worker');

Â  Â  Â  hireWork.innerText = ì•Œë°” ê³ ìš© (${formatKR(getWorkerCost())}ì½”ì¸);

Â  Â  Â  hireWork.disabled = state.coins < getWorkerCost();

Â  Â  Â  document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower() * activeBuffFactor('res')).toFixed(1);

Â  Â  Â  const hireConv = document.getElementById('hire-conversion');

Â  Â  Â  hireConv.innerText = ì½”ì¸ ì•Œë°” (${formatKR(getConversionCost())}ì½”ì¸);

Â  Â  Â  hireConv.disabled = state.coins < getConversionCost();

Â  Â  Â  document.getElementById('coin-per-sec').innerText = (state.conversionCount * activeBuffFactor('coin')).toFixed(1);

Â  Â  Â  renderSecurityBadge();

Â  Â  Â  tryUnlockDaily();

Â  Â  Â  renderBuffStatus();

Â  Â  Â  try {

Â  Â  Â  Â  if (uid) {

Â  Â  Â  Â  Â  const cachePick = {

Â  Â  Â  Â  Â  Â  resources: state.resources,

Â  Â  Â  Â  Â  Â  coins: state.coins,

Â  Â  Â  Â  Â  Â  eventCoins: state.eventCoins,

Â  Â  Â  Â  Â  Â  clickPower: state.clickPower,

Â  Â  Â  Â  Â  Â  shipLevel: state.shipLevel,

Â  Â  Â  Â  Â  Â  shipUpgradeCost: state.shipUpgradeCost,

Â  Â  Â  Â  Â  Â  workerCount: state.workerCount,

Â  Â  Â  Â  Â  Â  conversionCount: state.conversionCount,

Â  Â  Â  Â  Â  Â  autoConvertBought: state.autoConvertBought,

Â  Â  Â  Â  Â  Â  ownedPlanets: state.ownedPlanets

Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  localStorage.setItem(gd_cache_${uid}, JSON.stringify(cachePick));

Â  Â  Â  Â  }

Â  Â  Â  } catch {}

Â  Â  }

Â  Â  function renderPlanets() {

Â  Â  Â  const planets = [

Â  Â  Â  Â  {name:'ë‹¬',cost:100,requiredShipLevel:1},

Â  Â  Â  Â  {name:'ìˆ˜ì„±',cost:500,requiredShipLevel:2},

Â  Â  Â  Â  {name:'ê¸ˆì„±',cost:2000,requiredShipLevel:3},

Â  Â  Â  Â  {name:'ì§€êµ¬',cost:10000,requiredShipLevel:4},

Â  Â  Â  Â  {name:'í™”ì„±',cost:50000,requiredShipLevel:5},

Â  Â  Â  Â  {name:'ëª©ì„±',cost:250000,requiredShipLevel:6},

Â  Â  Â  Â  {name:'í† ì„±',cost:1000000,requiredShipLevel:7},

Â  Â  Â  Â  {name:'ì²œì™•ì„±',cost:5000000,requiredShipLevel:8},

Â  Â  Â  Â  {name:'í•´ì™•ì„±',cost:20000000,requiredShipLevel:9}

Â  Â  Â  ];

Â  Â  Â  const list = document.getElementById('planet-list'); list.innerHTML = '';

Â  Â  Â  planets.forEach((p, i) => {

Â  Â  Â  Â  const div = document.createElement('div');

Â  Â  Â  Â  const owned = state.ownedPlanets && state.ownedPlanets.includes(i);

Â  Â  Â  Â  const canBuy = state.shipLevel >= p.requiredShipLevel;

Â  Â  Â  Â  div.style.margin='10px 0';

Â  Â  Â  Â  div.innerHTML = <strong>${p.name}</strong> â€” ${formatKR(p.cost)}ì½”ì¸<br>í•„ìš” ë ™: ${p.requiredShipLevel};

Â  Â  Â  Â  const btn = document.createElement('button'); btn.className='general';

Â  Â  Â  Â  btn.textContent = owned ? 'êµ¬ë§¤ ì™„ë£Œ' : (canBuy ? 'êµ¬ë§¤' : 'ë ™ ë¶€ì¡±'); btn.disabled = owned || !canBuy;

Â  Â  Â  Â  btn.onclick = async () => {

Â  Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  Â  if (state.coins >= p.cost) {

Â  Â  Â  Â  Â  Â  state.coins -= p.cost;

Â  Â  Â  Â  Â  Â  auditSpend('coin', p.cost);

Â  Â  Â  Â  Â  Â  if (!state.ownedPlanets) state.ownedPlanets = [];

Â  Â  Â  Â  Â  Â  state.ownedPlanets.push(i);

Â  Â  Â  Â  Â  Â  save(); updateUI(); renderPlanets();

Â  Â  Â  Â  Â  Â  if (p.name === 'í™”ì„±' && !rankingUnlocked) {

Â  Â  Â  Â  Â  Â  Â  rankingUnlocked = true;

Â  Â  Â  Â  Â  Â  Â  try { await update(ref(db), { [${userBasePath}/meta/rankingUnlocked]: true }); } catch{}

Â  Â  Â  Â  Â  Â  Â  showToast('ğŸ† ë­í‚¹ ì ê¸ˆ í•´ì œ!', 'ë°”ë¡œ ê°€ê¸°', ()=>{ location.href='/ranking.html'; });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  };

Â  Â  Â  Â  div.appendChild(btn); list.appendChild(div);

Â  Â  Â  });

Â  Â  }

Â  Â  function spawnParticles(x,y) {

Â  Â  Â  for (let i=15;i>0;i--){

Â  Â  Â  Â  const span = document.createElement('span');

Â  Â  Â  Â  span.className='particle';

Â  Â  Â  Â  span.style.setProperty('--dx',(Math.random()-0.5)*100+'px');

Â  Â  Â  Â  span.style.setProperty('--dy',(Math.random()-1)*100+'px');

Â  Â  Â  Â  span.style.left = x+'px'; span.style.top = y+'px';

Â  Â  Â  Â  document.getElementById('ore-container').appendChild(span);

Â  Â  Â  Â  setTimeout(()=>span.remove(),800);

Â  Â  Â  }

Â  Â  }

Â  Â  function ensureReady() {

Â  Â  Â  if (!window.__PLAY_ALLOWED) { showAuthStatus('PCì—ì„œëŠ” íŒì—…ìœ¼ë¡œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. íŒì—…ìœ¼ë¡œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return false; }

Â  Â  Â  if (!uid) { showAuthStatus('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'); return false; }

Â  Â  Â  if (isInitialSync) { showAuthStatus('ë°ì´í„° ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'); return false; }

Â  Â  Â  if (!security.tosAccepted){ showTosOverlay(true); showAuthStatus('ì´ìš©ì•½ê´€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.', true); return false; }

Â  Â  Â  if (security.banned){ showBanOverlay(true); showAuthStatus('ì´ìš©ì•½ê´€ ìœ„ë°˜ ì˜ì‹¬(ê³„ì • ì •ì§€)ìœ¼ë¡œ í”Œë ˆì´ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.', true); return false; }

Â  Â  Â  showAuthStatus(''); return true;

Â  Â  }

Â  Â  function wireGame() {

Â  Â  Â  document.getElementById('ore').addEventListener('click', e => {

Â  Â  Â  Â  if (!uid || isInitialSync || !window.__PLAY_ALLOWED) return;

Â  Â  Â  Â  if (security.banned){ showBanOverlay(true); return; }

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  const rect = e.target.getBoundingClientRect();

Â  Â  Â  Â  spawnParticles(e.clientX - rect.left, e.clientY - rect.top);

Â  Â  Â  Â  const resMul = activeBuffFactor('res');

Â  Â  Â  Â  const inc = state.clickPower * resMul;

Â  Â  Â  Â  state.resources += inc;

Â  Â  Â  Â  auditAdd('res', inc);

Â  Â  Â  Â  if (state.autoConvertBought) convertResources();

Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  });

Â  Â  Â  document.getElementById('convert-button').addEventListener('click', () => { if (!ensureReady()) return; convertResources(1); save(); updateUI(); });

Â  Â  Â  document.getElementById('auto-convert-buy').addEventListener('click', () => {

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  if (!state.autoConvertBought && state.coins >= 100) {

Â  Â  Â  Â  Â  state.coins -= 100;

Â  Â  Â  Â  Â  auditSpend('coin', 100);

Â  Â  Â  Â  Â  state.autoConvertBought = true;

Â  Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  document.getElementById('hire-worker').addEventListener('click', () => {

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  const cost = getWorkerCost();

Â  Â  Â  Â  if (state.coins >= cost) {

Â  Â  Â  Â  Â  state.coins -= cost;

Â  Â  Â  Â  Â  auditSpend('coin', cost);

Â  Â  Â  Â  Â  state.workerCount++;

Â  Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  document.getElementById('hire-conversion').addEventListener('click', () => {

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  const cost = getConversionCost();

Â  Â  Â  Â  if (state.coins >= cost) {

Â  Â  Â  Â  Â  state.coins -= cost;

Â  Â  Â  Â  Â  auditSpend('coin', cost);

Â  Â  Â  Â  Â  state.conversionCount++;

Â  Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  document.getElementById('upgrade-ship').addEventListener('click', () => {

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  if (state.coins >= state.shipUpgradeCost) {

Â  Â  Â  Â  Â  const cost = state.shipUpgradeCost;

Â  Â  Â  Â  Â  state.coins -= cost;

Â  Â  Â  Â  Â  auditSpend('coin', cost);

Â  Â  Â  Â  Â  state.shipLevel++;

Â  Â  Â  Â  Â  state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30);

Â  Â  Â  Â  Â  save(); updateUI(); renderPlanets();

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  // í´ë¦­ ì—…ê·¸ë ˆì´ë“œ

Â  Â  Â  document.getElementById('click-upgrade').addEventListener('click', () => {

Â  Â  Â  Â  if (!ensureReady()) return;

Â  Â  Â  Â  if (state.coins >= clickUpgradeCost){

Â  Â  Â  Â  Â  state.coins -= clickUpgradeCost;

Â  Â  Â  Â  Â  auditSpend('coin', clickUpgradeCost);

Â  Â  Â  Â  Â  state.clickPower = (state.clickPower||1) + 1;

Â  Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  Â  document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {

Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

Â  Â  Â  Â  document.getElementById(tab.dataset.tab + '-content').classList.add('active');

Â  Â  Â  Â  document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));

Â  Â  Â  Â  tab.classList.add('active');

Â  Â  Â  }));

Â  Â  Â  // ë©”ì¸ ë£¨í”„

Â  Â  Â  window.__gameTimer = setInterval(async () => {

Â  Â  Â  Â  if (!uid || isInitialSync || !window.__PLAY_ALLOWED) return;

Â  Â  Â  Â  if (!security.banned){

Â  Â  Â  Â  Â  pruneExpiredBuffs();

Â  Â  Â  Â  Â  let workerGain = state.workerCount * getWorkerPower() * activeBuffFactor('res');

Â  Â  Â  Â  Â  if (state.workerCount > 0){ state.resources += workerGain; auditAdd('res', workerGain); }

Â  Â  Â  Â  Â  let convGain = state.conversionCount * activeBuffFactor('coin');

Â  Â  Â  Â  Â  if (state.conversionCount > 0){ state.coins += convGain; auditAdd('coin', convGain); }

Â  Â  Â  Â  Â  if (state.autoConvertBought) convertResources();

Â  Â  Â  Â  }

Â  Â  Â  Â  auditCheck();

Â  Â  Â  Â  await saveSecurity();

Â  Â  Â  Â  save(); updateUI();

Â  Â  Â  }, 1000);

Â  Â  }

Â  Â  /* ======================

Â  Â  Â  Â ì¸ì¦/ë¶€íŒ… íë¦„

Â  Â  Â  Â ====================== */

Â  Â  const tabLogin  = document.getElementById('auth-tab-login');

Â  Â  const tabSignup = document.getElementById('auth-tab-signup');

Â  Â  const signupExtra = document.getElementById('signup-extra');

Â  Â  const loginBtn  = document.getElementById('login-btn');

Â  Â  const signupBtnEl = document.getElementById('signup-btn');

Â  Â  let currentAuthMode = 'login';

Â  Â  function setAuthMode(mode) {

Â  Â  Â  currentAuthMode = (mode === 'signup') ? 'signup' : 'login';

Â  Â  Â  if (mode === 'signup') {

Â  Â  Â  Â  tabLogin.classList.remove('active'); tabSignup.classList.add('active');

Â  Â  Â  Â  signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';

Â  Â  Â  Â  signupBtnEl.textContent = 'íšŒì›ê°€ì…(ì¸ì¦ ë©”ì¼ ë³´ë‚´ê¸°)'; // âœ… ì´ˆê¸° ë ˆì´ë¸”

Â  Â  Â  } else {

Â  Â  Â  Â  tabLogin.classList.add('active'); tabSignup.classList.remove('active');

Â  Â  Â  Â  signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';

Â  Â  Â  }

Â  Â  Â  showAuthStatus(''); document.getElementById('verify-info').textContent = '';

Â  Â  Â  try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}

Â  Â  }

Â  Â  /* âœ… íƒ­ ì „í™˜ ì‹œ ëª¨ë“  ì˜¤ë²„ë ˆì´ ë‹«ê¸° */

Â  Â  tabLogin.addEventListener('click',  () => { hideAllOverlays(); setAuthMode('login');  showAuthStatus(''); });

Â  Â  tabSignup.addEventListener('click', () => { hideAllOverlays(); setAuthMode('signup'); showAuthStatus(''); });

Â  Â  document.getElementById('settings-btn').addEventListener('click', () => {

Â  Â  Â  try { history.replaceState(null, '', '/game' + (location.hash || '')); } catch {}

Â  Â  Â  location.href = '/setting.html';

Â  Â  });

Â  Â  // ê³µí†µ Auth ì—ëŸ¬ í•¸ë“¤ëŸ¬: ì •ì§€ ê³„ì •

Â  Â  function handleAuthError(err) {

Â  Â  Â  const code = err?.code || '';

Â  Â  Â  if (code === 'auth/user-disabled') {

Â  Â  Â  Â  // âœ… ë¡œê·¸ì¸ ì‹œë„ ì‹œ: ìƒì„¸(ì˜ì‹¬ë„ ë“±) ë…¸ì¶œ ê¸ˆì§€, ë‹¨ ì˜¤íƒ ë©”ì¼ ì•ˆë‚´ëŠ” í¬í•¨

Â  Â  Â  Â  security.banned = true;

Â  Â  Â  Â  securityDirty = true;

Â  Â  Â  Â  showAuthStatus('â›” ì´ìš©ì•½ê´€ ìœ„ë°˜ìœ¼ë¡œ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤íƒìœ¼ë¡œ ì˜ì‹¬ë˜ë©´ appeals@siustudio.kro.kr ë¡œ ë©”ì¼ì„ ë³´ë‚´ ì£¼ì„¸ìš”.', true);

Â  Â  Â  Â  try { saveSupportCtx({ banned: true }); } catch {}

Â  Â  Â  Â  return true;

Â  Â  Â  }

Â  Â  Â  return false;

Â  Â  }

Â  Â  // ğŸ”’ ì´ë©”ì¼ ì¸ì¦ í•„ìˆ˜ ë¡œê·¸ì¸(ë¹„ë°€ë²ˆí˜¸ ì œê³µììš©)

Â  Â  loginBtn.addEventListener('click', async () => {

Â  Â  Â  showAuthStatus('');

Â  Â  Â  const email = document.getElementById('email').value.trim();

Â  Â  Â  const password = document.getElementById('password').value;

Â  Â  Â  if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

Â  Â  Â  try {

Â  Â  Â  Â  const cred = await signInWithEmailAndPassword(auth, email, password);

Â  Â  Â  Â  const user = cred.user;

Â  Â  Â  Â  const isPasswordProvider = user && user.providerData.some(p=>p.providerId==='password');

Â  Â  Â  Â  if (isPasswordProvider && !user.emailVerified) {

Â  Â  Â  Â  Â  try { await sendEmailVerification(user); } catch {}

Â  Â  Â  Â  Â  showAuthStatus('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆì–´ìš”. ë°›ì€ ë©”ì¼ì˜ ë§í¬ë¡œ ì¸ì¦í•œ ë’¤ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', true);

Â  Â  Â  Â  Â  try { await auth.signOut(); } catch {}

Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  // (ë¹„ë°€ë²ˆí˜¸ ì œê³µì + ì¸ì¦ ì™„ë£Œ) ë˜ëŠ” (êµ¬ê¸€ ë“±) â†’ ì •ìƒ

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  if (!handleAuthError(err)) {

Â  Â  Â  Â  Â  const code = (err && err.code) || '';

Â  Â  Â  Â  Â  const msg =

Â  Â  Â  Â  Â  Â  (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials')

Â  Â  Â  Â  Â  Â  Â  ? 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  Â  code === 'auth/user-not-found'         ? 'ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ë¨¼ì € ì§„í–‰í•˜ì„¸ìš”.' :

Â  Â  Â  Â  Â  Â  code === 'auth/invalid-email'          ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  Â  code === 'auth/network-request-failed' ? 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  Â  'ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”';

Â  Â  Â  Â  Â  showAuthStatus(msg);

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  });

Â  Â  // =====================

Â  Â  // âœ… íšŒì›ê°€ì… (ì´ë©”ì¼ ë§í¬ ë°©ì‹)

Â  Â  // =====================

Â  Â  let __emailLinkMode = false; // ë§í¬ íšŒê·€ ìƒíƒœì¸ì§€

Â  Â  async function beginEmailLinkSignup() {

Â  Â  Â  showAuthStatus('');

Â  Â  Â  const email = document.getElementById('email').value.trim();

Â  Â  Â  const agree = document.getElementById('tos-checkbox')?.checked;

Â  Â  Â  if (!email) { showAuthStatus('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

Â  Â  Â  if (!agree) { showAuthStatus('ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì•¼ íšŒì›ê°€ì… ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

Â  Â  Â  try {

Â  Â  Â  Â  await sendSignInLinkToEmail(auth, email, actionCodeSettings);

Â  Â  Â  Â  try { localStorage.setItem('signupEmail', email); } catch {}

Â  Â  Â  Â  showAuthStatus('ğŸ“§ ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼ì˜ ë§í¬ë¥¼ ëˆ„ë¥´ë©´ ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤.', false);

Â  Â  Â  Â  document.getElementById('password')?.setAttribute('disabled','true');

Â  Â  Â  Â  document.getElementById('password-confirm')?.setAttribute('disabled','true');

Â  Â  Â  Â  signupBtnEl.textContent = 'ë©”ì¼ ì „ì†¡ë¨ â€“ ë§í¬ë¡œ ëŒì•„ì˜¤ë©´ ë¹„ë²ˆ ì„¤ì •';

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  const code = err?.code || '';

Â  Â  Â  Â  const msg =

Â  Â  Â  Â  Â  code === 'auth/invalid-email' ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  code === 'auth/missing-android-pkg-name' || code === 'auth/missing-continue-uri' || code === 'auth/unauthorized-continue-uri'

Â  Â  Â  Â  Â  Â  ? 'ì¸ì¦ ë§í¬ ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½˜ì†”ì˜ Authorized domainsë¥¼ í™•ì¸í•˜ì„¸ìš”.' :

Â  Â  Â  Â  Â  'ì¸ì¦ ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';

Â  Â  Â  Â  showAuthStatus(msg);

Â  Â  Â  }

Â  Â  }

Â  Â  async function completeEmailLinkIfNeeded() {

Â  Â  Â  if (!isSignInWithEmailLink(auth, window.location.href)) return;

Â  Â  Â  __emailLinkMode = true;

Â  Â  Â  setAuthMode('signup');

Â  Â  Â  document.getElementById('auth-title').textContent = 'ì´ë©”ì¼ í™•ì¸ë¨ â€“ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •';

Â  Â  Â  document.getElementById('password')?.removeAttribute('disabled');

Â  Â  Â  document.getElementById('password-confirm')?.removeAttribute('disabled');

Â  Â  Â  document.getElementById('signup-extra').style.display = 'block';

Â  Â  Â  signupBtnEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì™„ë£Œí•˜ê¸°';

Â  Â  Â  let email = null;

Â  Â  Â  try { email = localStorage.getItem('signupEmail'); } catch {}

Â  Â  Â  if (!email) email = prompt('ê°€ì…ì— ì‚¬ìš©í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”') || '';

Â  Â  Â  email = email.trim();

Â  Â  Â  if (!email) { showAuthStatus('ì´ë©”ì¼ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }

Â  Â  Â  try {

Â  Â  Â  Â  await signInWithEmailLink(auth, email, window.location.href);

Â  Â  Â  Â  try { localStorage.setItem('signupEmail', email); } catch {}

Â  Â  Â  Â  showAuthStatus('âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ! ì´ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.', false);

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  const code = err?.code || '';

Â  Â  Â  Â  const msg =

Â  Â  Â  Â  Â  code === 'auth/invalid-action-code' ? 'ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ ì£¼ì„¸ìš”.' :

Â  Â  Â  Â  Â  code === 'auth/expired-action-code' ? 'ë§í¬ ìœ íš¨ê¸°ê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ ì£¼ì„¸ìš”.' :

Â  Â  Â  Â  Â  'ë§í¬ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

Â  Â  Â  Â  showAuthStatus(msg);

Â  Â  Â  }

Â  Â  }

Â  Â  async function finalizePassword() {

Â  Â  Â  const email = (localStorage.getItem('signupEmail') || '').trim();

Â  Â  Â  const pw  = document.getElementById('password').value;

Â  Â  Â  const pw2 = document.getElementById('password-confirm').value;

Â  Â  Â  if (!pw || !pw2) { showAuthStatus('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

Â  Â  Â  if (pw !== pw2)   { showAuthStatus('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

Â  Â  Â  if (!auth.currentUser) { showAuthStatus('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return; }

Â  Â  Â  try {

Â  Â  Â  Â  await linkWithCredential(auth.currentUser, EmailAuthProvider.credential(email, pw));

Â  Â  Â  Â  showAuthStatus('ğŸ” ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸ íƒ­ì—ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”.', false);

Â  Â  Â  Â  await auth.signOut();

Â  Â  Â  Â  setAuthMode('login');

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  const code = err?.code || '';

Â  Â  Â  Â  const msg =

Â  Â  Â  Â  Â  code === 'auth/provider-already-linked' ? 'ì´ë¯¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ëœ ê³„ì •ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.' :

Â  Â  Â  Â  Â  code === 'auth/credential-already-in-use' ? 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ìê²©ì¦ëª…ì…ë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  code === 'auth/weak-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.' :

Â  Â  Â  Â  Â  'ë¹„ë°€ë²ˆí˜¸ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';

Â  Â  Â  Â  showAuthStatus(msg);

Â  Â  Â  }

Â  Â  }

Â  Â  // ê¸°ì¡´ íšŒì›ê°€ì… ë²„íŠ¼ ë™ì‘ ëŒ€ì²´

Â  Â  signupBtnEl?.addEventListener('click', async (e) => {

Â  Â  Â  e.preventDefault();

Â  Â  Â  if (__emailLinkMode) {

Â  Â  Â  Â  finalizePassword();

Â  Â  Â  } else {

Â  Â  Â  Â  beginEmailLinkSignup();

Â  Â  Â  }

Â  Â  });

Â  Â  // TOS ë™ì˜

Â  Â  const tosAgree = document.getElementById('tos-agree');

Â  Â  const tosAccept = document.getElementById('tos-accept');

Â  Â  tosAgree?.addEventListener('change', ()=>{ tosAccept.disabled = !tosAgree.checked; });

Â  Â  tosAccept?.addEventListener('click', async ()=>{

Â  Â  Â  security.tosAccepted = true; securityDirty = true;

Â  Â  Â  await saveSecurity();

Â  Â  Â  showTosOverlay(false);

Â  Â  Â  showToast('âœ… ì´ìš©ì•½ê´€ì— ë™ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê³µì •í•œ í”Œë ˆì´ë¥¼ ë¶€íƒë“œë ¤ìš”!', null, null, 3500);

Â  Â  });

Â  Â  // ì •ì§€ ì˜¤ë²„ë ˆì´ ë²„íŠ¼ë“¤

Â  Â  document.getElementById('ban-ok')?.addEventListener('click', ()=> showBanOverlay(false));

Â  Â  document.getElementById('ban-appeal-email')?.addEventListener('click', ()=>{

Â  Â  Â  const { mailto } = buildSupportMail();

Â  Â  Â  location.href = mailto;

Â  Â  });

Â  Â  document.getElementById('ban-copy-info')?.addEventListener('click', copySupportInfo);

Â  Â  // ì„¸ì…˜ ì¤‘ê°„ ì •ì§€ ë¹ ë¥¸ ê°ì§€(30ì´ˆë§ˆë‹¤ í† í° ê°•ì œ ê°±ì‹ )

Â  Â  setInterval(async () => {

Â  Â  Â  try {

Â  Â  Â  Â  if (auth?.currentUser) {

Â  Â  Â  Â  Â  await auth.currentUser.getIdToken(true);

Â  Â  Â  Â  }

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  if (handleAuthError(err)) {

Â  Â  Â  Â  Â  try { await auth.signOut(); } catch {}

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  }, 30000);

Â  Â  // ë°ì´í„° ë°”ì¸ë”©

Â  Â  async function proceedWithDataBinding(){

Â  Â  Â  try {

Â  Â  Â  Â  const rankSnap = await get(ref(db), ${userBasePath}/meta/rankingUnlocked);

Â  Â  Â  Â  rankingUnlocked = !!(rankSnap.exists() ? rankSnap.val() : false);

Â  Â  Â  } catch { rankingUnlocked = false; }

Â  Â  Â  dataRef = ref(db, ${userBasePath}/gameData);

Â  Â  Â  isInitialSync = true;

Â  Â  Â  try {

Â  Â  Â  Â  const saved = localStorage.getItem(lastWrite_${uid});

Â  Â  Â  Â  localLastWrite = saved ? parseInt(saved, 10) : 0;

Â  Â  Â  } catch { localLastWrite = 0; }

Â  Â  Â  await ensureInitialData(dataRef);

Â  Â  Â  await loadSecurity();

Â  Â  Â  saveSupportCtx({ banned: false });

Â  Â  Â  dataUnsubscribe = onValue(dataRef, async snap => {

Â  Â  Â  Â  const server = snap.exists() ? snap.val() : null;

Â  Â  Â  Â  if (isInitialSync) {

Â  Â  Â  Â  Â  state = { ...defaultData, ...(server || {}) };

Â  Â  Â  Â  Â  await fetchDaily();

Â  Â  Â  Â  Â  if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }

Â  Â  Â  Â  Â  isInitialSync = false;

Â  Â  Â  Â  Â  showGameUI();

Â  Â  Â  Â  Â  try { localStorage.setItem('boot_seen', '1'); } catch {}

Â  Â  Â  Â  Â  window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();

Â  Â  Â  Â  Â  await checkDailyAndMaybeShow();

Â  Â  Â  Â  Â  updateAttendanceLabels();

Â  Â  Â  Â  Â  bootDone = true;

Â  Â  Â  Â  Â  auditInit();

Â  Â  Â  Â  Â  renderSecurityBadge();

Â  Â  Â  Â  Â  if (!security.tosAccepted){ showTosOverlay(true); }

Â  Â  Â  Â  Â  if (security.banned){ showBanOverlay(true); }

Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  if (!server) {

Â  Â  Â  Â  Â  state = { ...defaultData };

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  const serverLast = server._lastUpdated || 0;

Â  Â  Â  Â  Â  if (serverLast >= (localLastWrite || 0)) {

Â  Â  Â  Â  Â  Â  state = { ...defaultData, ...server };

Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  state = { ...defaultData, ...server, ...state };

Â  Â  Â  Â  Â  Â  try { if (JSON.stringify(server) !== JSON.stringify(state)) save(); }

Â  Â  Â  Â  Â  Â  catch { save(); }

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }

Â  Â  Â  Â  if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }

Â  Â  Â  });

Â  Â  }

Â  Â  // âœ… onAuthStateChanged ì‹œì‘ ì‹œ ëª¨ë“  ì˜¤ë²„ë ˆì´ ë‹«ê¸°

Â  Â  onAuthStateChanged(auth, async user => {

Â  Â  Â  hideAllOverlays();

Â  Â  Â  setBootVisible(false);

Â  Â  Â  showAuthStatus('');

Â  Â  Â  if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }

Â  Â  Â  if (user) {

Â  Â  Â  Â  /* âœ… ìƒˆ ì„¸ì…˜ì€ í´ë¦° ìƒíƒœë¡œ */

Â  Â  Â  Â  clearSupportCtx();

Â  Â  Â  Â  hideAllOverlays();

Â  Â  Â  Â  security.banned = false; // ì„œë²„ ë¡œë”© ì „ UI ì˜¤íƒ ë°©ì§€

Â  Â  Â  Â  const isPasswordProvider = (user.providerData || []).some(p => p.providerId === 'password');

Â  Â  Â  Â  // ğŸ”’ (íŒ¨ìŠ¤ì›Œë“œ ì œê³µì ì „ìš©) ì´ë©”ì¼ ë¯¸ì¸ì¦ì´ë©´ ì¦‰ì‹œ ì°¨ë‹¨

Â  Â  Â  Â  if (isPasswordProvider && !user.emailVerified) {

Â  Â  Â  Â  Â  try { await sendEmailVerification(user); } catch {}

Â  Â  Â  Â  Â  showAuthStatus('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆì–´ìš”. ë°›ì€ ë©”ì¼ì˜ ë§í¬ë¡œ ì¸ì¦í•œ ë’¤ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', true);

Â  Â  Â  Â  Â  try { await auth.signOut(); } catch {}

Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  uid = user.uid;

Â  Â  Â  Â  loadBuffs();

Â  Â  Â  Â  renderBuffStatus();

Â  Â  Â  Â  // ìºì‹œ ì¦‰ì‹œ ë Œë”

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  const cacheRaw = localStorage.getItem(gd_cache_${uid});

Â  Â  Â  Â  Â  if (cacheRaw) {

Â  Â  Â  Â  Â  Â  const cached = JSON.parse(cacheRaw);

Â  Â  Â  Â  Â  Â  state = { ...defaultData, ...state, ...cached };

Â  Â  Â  Â  Â  Â  showGameUI();

Â  Â  Â  Â  Â  Â  updateUI();

Â  Â  Â  Â  Â  Â  renderPlanets();

Â  Â  Â  Â  Â  Â  bootDone = true;

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  let plan = null;

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  plan = await planMigrationForUser(user);

Â  Â  Â  Â  } catch(e){

Â  Â  Â  Â  Â  console.error('planMigration error', e);

Â  Â  Â  Â  Â  const fallbackServer = await allocateServerForUser();

Â  Â  Â  Â  Â  userServerKey = fallbackServer;

Â  Â  Â  Â  Â  userIdKey     = makeIdKeyFromUser(user);

Â  Â  Â  Â  Â  userBasePath  = users/${userServerKey}/${userIdKey};

Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  await update(ref(db), {

Â  Â  Â  Â  Â  Â  Â  [userServerMap/${uid}]: {

Â  Â  Â  Â  Â  Â  Â  Â  server: userServerKey,

Â  Â  Â  Â  Â  Â  Â  Â  id: userIdKey,

Â  Â  Â  Â  Â  Â  Â  Â  displayId: String(user?.email||'') || null,

Â  Â  Â  Â  Â  Â  Â  Â  assignedAt: Date.now(),

Â  Â  Â  Â  Â  Â  Â  Â  reason: 'plan-error-fallback'

Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  Â  saveSupportCtx({ banned: false });

Â  Â  Â  Â  Â  await proceedWithDataBinding();

Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  userServerKey = plan.server;

Â  Â  Â  Â  userIdKey     = makeIdKeyFromUser(user);

Â  Â  Â  Â  userBasePath  = users/${userServerKey}/${userIdKey};

Â  Â  Â  Â  saveSupportCtx({ banned: false });

Â  Â  Â  Â  if (plan.need) {

Â  Â  Â  Â  Â  showMigrateOverlay(true, 'ëŒ€ê¸° ì¤‘â€¦');

Â  Â  Â  Â  Â  disableMigrateStart(false);

Â  Â  Â  Â  Â  const startBtn = document.getElementById('migrate-start');

Â  Â  Â  Â  Â  if (startBtn){

Â  Â  Â  Â  Â  Â  startBtn.onclick = async ()=>{

Â  Â  Â  Â  Â  Â  Â  disableMigrateStart(true);

Â  Â  Â  Â  Â  Â  Â  try{

Â  Â  Â  Â  Â  Â  Â  Â  await performMigration(plan.srcBasePath, plan.destBasePath, user);

Â  Â  Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db), {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [userServerMap/${uid}]: {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  server: userServerKey,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: userIdKey,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayId: String(user?.email||'') || null,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  migratedAt: Date.now(),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reason: plan.reason

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  Â  Â  Â  Â  saveSupportCtx({ banned: false });

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(()=>{ showMigrateOverlay(false); proceedWithDataBinding(); }, 600);

Â  Â  Â  Â  Â  Â  Â  }catch(e){

Â  Â  Â  Â  Â  Â  Â  Â  console.error('migration failed', e);

Â  Â  Â  Â  Â  Â  Â  Â  setMigrateProgress('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

Â  Â  Â  Â  Â  Â  Â  Â  disableMigrateStart(false);

Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  await update(ref(db), {

Â  Â  Â  Â  Â  Â  Â  [userServerMap/${uid}]: {

Â  Â  Â  Â  Â  Â  Â  Â  server: userServerKey,

Â  Â  Â  Â  Â  Â  Â  Â  id: userIdKey,

Â  Â  Â  Â  Â  Â  Â  Â  displayId: String(user?.email||'') || null,

Â  Â  Â  Â  Â  Â  Â  Â  assignedAt: Date.now(),

Â  Â  Â  Â  Â  Â  Â  Â  reason: plan.reason || 'auto-assign'

Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  } catch {}

Â  Â  Â  Â  Â  saveSupportCtx({ banned: false });

Â  Â  Â  Â  Â  await proceedWithDataBinding();

Â  Â  Â  Â  }

Â  Â  Â  } else {

Â  Â  Â  Â  uid = null; dataRef = null;

Â  Â  Â  Â  userServerKey = null; userIdKey = null; userBasePath = null;

Â  Â  Â  Â  dailyUnlocked = false; rankingUnlocked = false;

Â  Â  Â  Â  bootDone = false;

Â  Â  Â  Â  ensureFx(); window.fx.buffs = [];

Â  Â  Â  Â  renderBuffStatus();

Â  Â  Â  Â  /* âœ… ë¡œê·¸ì•„ì›ƒ ì‹œ ë³´ì•ˆ ìƒíƒœ ì™„ì „ ë¦¬ì…‹ & ë°´ ë˜ì¹˜ ì œê±° */

Â  Â  Â  Â  security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };

Â  Â  Â  Â  securityDirty = false;

Â  Â  Â  Â  renderSecurityBadge();

Â  Â  Â  Â  clearSupportCtx();

Â  Â  Â  Â  hideAllOverlays();

Â  Â  Â  Â  state = { ...defaultData };

Â  Â  Â  Â  localLastWrite = 0; isInitialSync = false;

Â  Â  Â  Â  authContainer.style.display = 'block';

Â  Â  Â  Â  setTimeout(() => authContainer.classList.remove('hidden'), 16);

Â  Â  Â  Â  ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');

Â  Â  Â  Â  setAuthMode(currentAuthMode);

Â  Â  Â  }

Â  Â  });

Â  Â  // âœ… ì²« ë¡œë“œ ì‹œ ì´ë©”ì¼ ë§í¬ íšŒê·€ ì²˜ë¦¬

Â  Â  completeEmailLinkIfNeeded();

Â  Â  // ë¶€íŒ… ì˜¤ë²„ë ˆì´ í˜ì¼ì„¸ì´í”„

Â  Â  setTimeout(() => {

Â  Â  Â  const stillBooting = bootOverlay && getComputedStyle(bootOverlay).display !== 'none';

Â  Â  Â  const gameHidden = document.getElementById('container')?.style.visibility !== 'visible';

Â  Â  Â  if (stillBooting && gameHidden) {

Â  Â  Â  Â  setBootVisible(false);

Â  Â  Â  Â  authContainer.style.display = 'block';

Â  Â  Â  Â  setTimeout(() => authContainer.classList.remove('hidden'), 16);

Â  Â  Â  Â  showAuthStatus('ì„¸ì…˜ í™•ì¸ì´ ì§€ì—°ë˜ì–´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.', false);

Â  Â  Â  }

Â  Â  }, 4000);

Â  Â  document.getElementById('google-btn').addEventListener('click', async () => {

Â  Â  Â  showAuthStatus('');

Â  Â  Â  const provider = new GoogleAuthProvider();

Â  Â  Â  try {

Â  Â  Â  Â  await signInWithPopup(auth, provider);

Â  Â  Â  } catch (err) {

Â  Â  Â  Â  if (handleAuthError(err)) return;

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  await signInWithRedirect(auth, provider);

Â  Â  Â  Â  } catch (err2) {

Â  Â  Â  Â  Â  if (handleAuthError(err2)) return;

Â  Â  Â  Â  Â  showAuthStatus('êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');

Â  Â  Â  Â  }

Â  Â  Â  }

Â  Â  });

Â  Â  window.addEventListener('load', () => {

Â  Â  Â  if (window.__PLAY_ALLOWED) wireGame();

Â  Â  Â  else window.__DEFER_INIT = wireGame;

Â  Â  Â  renderBuffStatus();

Â  Â  Â  renderSecurityBadge();

Â  Â  });

Â  Â  setInterval(renderBuffStatus, 1000);

Â  Â  window.openDailyManual = function(){ checkDailyAndMaybeShow().then(()=>openDailyOverlay()); }

Â  </script>

Â  <!-- ìš°í´ë¦­ ì»¤ìŠ¤í…€ ë©”ë‰´ -->

Â  <script>

Â  Â  const customMenu = document.getElementById('custom-menu');

Â  Â  window.addEventListener('contextmenu', e => {

Â  Â  Â  e.preventDefault();

Â  Â  Â  customMenu.style.top = ${e.clientY}px;

Â  Â  Â  customMenu.style.left = ${e.clientX}px;

Â  Â  Â  customMenu.style.display = 'block';

Â  Â  });

Â  Â  customMenu.addEventListener('click', (e) => {

Â  Â  Â  const btn = e.target.closest('.menu-item');

Â  Â  Â  const action = btn && btn.getAttribute('data-action');

Â  Â  Â  if (!action) return;

Â  Â  Â  if (action === 'menu') {

Â  Â  Â  Â  try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}

Â  Â  Â  Â  try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}

Â  Â  Â  Â  try { window.close(); } catch {}

Â  Â  Â  Â  setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);

Â  Â  Â  }

Â  Â  Â  if (action === 'download') { location.href='/app-download.html'; }

Â  Â  Â  if (action === 'resume')   { customMenu.style.display='none'; }

Â  Â  Â  if (action === 'rank')     { location.href='/ranking.html'; }

Â  Â  Â  if (action === 'attendance'){ customMenu.style.display='none'; try{ window.openDailyManual(); }catch{} }

Â  Â  });

Â  Â  window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display='none'; });

Â  </script>

Â  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->

Â  <script>

Â  Â  (function(){

Â  Â  Â  const sideToggle = document.getElementById('side-menu-toggle');

Â  Â  Â  const sideMenu   = document.getElementById('side-menu');

Â  Â  Â  const backdrop   = document.getElementById('side-backdrop');

Â  Â  Â  function openSide(){

Â  Â  Â  Â  sideMenu.classList.add('open');

Â  Â  Â  Â  sideMenu.setAttribute('aria-hidden','false');

Â  Â  Â  Â  backdrop.classList.add('show');

Â  Â  Â  Â  backdrop.setAttribute('aria-hidden','false');

Â  Â  Â  }

Â  Â  Â  function closeSide(){

Â  Â  Â  Â  sideMenu.classList.remove('open');

Â  Â  Â  Â  sideMenu.setAttribute('aria-hidden','true');

Â  Â  Â  Â  backdrop.classList.remove('show');

Â  Â  Â  Â  backdrop.setAttribute('aria-hidden','true');

Â  Â  Â  }

Â  Â  Â  sideToggle.addEventListener('click', openSide);

Â  Â  Â  backdrop.addEventListener('click', closeSide);

Â  Â  Â  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

Â  Â  Â  sideMenu.addEventListener('click', (e)=>{

Â  Â  Â  Â  const btn = e.target.closest('.side-item');

Â  Â  Â  Â  if(!btn) return;

Â  Â  Â  Â  const action = btn.getAttribute('data-action');

Â  Â  Â  Â  if (action === 'menu') {

Â  Â  Â  Â  Â  try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}

Â  Â  Â  Â  Â  try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}

Â  Â  Â  Â  Â  try { window.close(); } catch {}

Â  Â  Â  Â  Â  setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);

Â  Â  Â  Â  }

Â  Â  Â  Â  if (action === 'download') { location.href='/app-download.html'; }

Â  Â  Â  Â  if (action === 'rank')     { location.href='/ranking.html'; }

Â  Â  Â  Â  if (action === 'attendance'){ try{ window.openDailyManual(); }catch{} }

Â  Â  Â  Â  if (action === 'resume')   { /* ë‹«ê¸°ë§Œ */ }

Â  Â  Â  Â  closeSide();

Â  Â  Â  });

Â  Â  })();

Â  </script>

Â  <!-- ë””ë²„ê·¸ í‚¬ -->

Â  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>

Â  <script>

Â  Â  DisableDevtool({

Â  Â  Â  disableMenu: true,

Â  Â  Â  disableSelect: true,

Â  Â  Â  disableCopy: true,

Â  Â  Â  disableCut: true,

Â  Â  Â  disablePaste: true,

Â  Â  Â  clearIntervalWhenDevOpenTrigger: true,

Â  Â  Â  ondevtoolopen(type, next) {

Â  Â  Â  Â  try { window.close(); } catch {}

Â  Â  Â  Â  next();

Â  Â  Â  },

Â  Â  Â  ondevtoolclose() { console.warn('DevTools ë‹«í˜ ê°ì§€ë¨'); }

Â  Â  });

Â  </script>

Â  <!-- ì›ê²© ì§€ì› -->

Â  <script>

Â  Â  (function(w,t,c,p,s,e){

Â  Â  Â  p=new Promise(function(r){

Â  Â  Â  Â  w[c]={client:function(){

Â  Â  Â  Â  Â  if(!s){ s=document.createElement(t);

Â  Â  Â  Â  Â  Â  s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';

Â  Â  Â  Â  Â  Â  e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);

Â  Â  Â  Â  Â  Â  s.onload=function(){ r(w[c]); };

Â  Â  Â  Â  Â  } return p;

Â  Â  Â  Â  }};

Â  Â  Â  });

Â  Â  })(window,'script','CobrowseIO');

Â  Â  window.CobrowseIO = window.CobrowseIO || {};

Â  Â  CobrowseIO.license = "eFtcbWqBdRylMQ";

Â  Â  CobrowseIO.capabilities = ["cursor","remote-control"];

Â  Â  CobrowseIO.client().then(function(){ CobrowseIO.start(); });

Â  </script>

Â  <!-- Firebase ì»¤ë§¨ë“œ(ì„¸ì…˜ ì œì–´) -->

Â  <script type="module">

Â  Â  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";

Â  Â  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

Â  Â  import { getDatabase, ref, query, orderByChild, equalTo, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

Â  Â  const firebaseConfig = {

Â  Â  Â  apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",

Â  Â  Â  authDomain: "siu-studio.firebaseapp.com",

Â  Â  Â  databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",

Â  Â  Â  projectId: "siu-studio",

Â  Â  Â  storageBucket: "siu-studio.appspot.com",

Â  Â  Â  messagingSenderId: "830887143444",

Â  Â  Â  appId: "1:830887143444:web:70b45fc12140e893c31f01",

Â  Â  Â  measurementId: "G-1Y090YJDB6"

Â  Â  };

Â  Â  const app2 = getApps().length ? getApp() : initializeApp(firebaseConfig);

Â  Â  const auth2 = getAuth(app2);

Â  Â  const db2   = getDatabase(app2);

Â  Â  let sessionId = null;

Â  Â  function setActiveSession(id){

Â  Â  Â  if (!id) return;

Â  Â  Â  sessionId = String(id);

Â  Â  Â  try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}

Â  Â  Â  bindCommands(sessionId);

Â  Â  Â  watchSessionEnd(sessionId);

Â  Â  }

Â  Â  function bindCommands(id){

Â  Â  Â  const cmdRef = ref(db2, sessions/${id}/commands);

Â  Â  Â  onChildAdded(cmdRef, (snap) => {

Â  Â  Â  Â  const cmd = snap.val() || {};

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  if (cmd.type === 'navigate' && cmd.path){

Â  Â  Â  Â  Â  Â  if (/^https?:///i.test(cmd.path)) {

Â  Â  Â  Â  Â  Â  Â  const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;

Â  Â  Â  Â  Â  Â  Â  if (ok) location.assign(cmd.path);

Â  Â  Â  Â  Â  Â  } else { location.assign(cmd.path); }

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  else if (cmd.type === 'click' && cmd.selector){

Â  Â  Â  Â  Â  Â  const el = document.querySelector(cmd.selector);

Â  Â  Â  Â  Â  Â  if (el){

Â  Â  Â  Â  Â  Â  Â  el.focus?.(); el.click?.();

Â  Â  Â  Â  Â  Â  Â  el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window })); }

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  else if (cmd.type === 'highlight' && cmd.selector){

Â  Â  Â  Â  Â  Â  const el = document.querySelector(cmd.selector);

Â  Â  Â  Â  Â  Â  if (el){ const prev = el.style.outline; el.style.outline = '3px solid #00e5ff'; setTimeout(()=>{ el.style.outline = prev; }, 1800); }

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (e) { /* noop */ }

Â  Â  Â  });

Â  Â  }

Â  Â  function watchSessionEnd(id){

Â  Â  Â  const statusRef = ref(db2, sessions/${id}/meta/status);

Â  Â  Â  onValue(statusRef, (snap) => {

Â  Â  Â  Â  if (snap.val() === 'ended') {

Â  Â  Â  Â  Â  try { sessionStorage.removeItem('cobrowse_session_id'); } catch {}

Â  Â  Â  Â  }

Â  Â  Â  });

Â  Â  }

Â  Â  try { sessionId = sessionStorage.getItem('cobrowse_session_id') || null; } catch {}

Â  Â  if (sessionId) {

Â  Â  Â  setActiveSession(sessionId);

Â  Â  } else {

Â  Â  Â  onAuthStateChanged(auth2, (user) => {

Â  Â  Â  Â  if (!user) return;

Â  Â  Â  Â  const q = query(ref(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));

Â  Â  Â  Â  onValue(q, (snap) => {

Â  Â  Â  Â  Â  let latestId = null, latestAt = 0;

Â  Â  Â  Â  Â  snap.forEach(child => {

Â  Â  Â  Â  Â  Â  const v = child.val();

Â  Â  Â  Â  Â  Â  const st = v?.meta?.status;

Â  Â  Â  Â  Â  Â  const created = v?.meta?.createdAt || 0;

Â  Â  Â  Â  Â  Â  if (st === 'active' && created > latestAt) { latestAt = created; latestId = child.key; }

Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  if (latestId) setActiveSession(latestId);

Â  Â  Â  Â  }, { onlyOnce: true });

Â  Â  Â  });

Â  Â  }

Â  </script>

Â  <!-- Popup Enforcement (ê°„ì†Œ) -->

Â  <script>

Â  Â  (function(){

Â  Â  Â  const gate = document.getElementById('popup-gate');

Â  Â  Â  if (!gate) {

Â  Â  Â  Â  window.__PLAY_ALLOWED = (function(){

Â  Â  Â  Â  Â  function isMobileStrict(){

Â  Â  Â  Â  Â  Â  try { if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') return navigator.userAgentData.mobile; } catch {}

Â  Â  Â  Â  Â  Â  const ua = navigator.userAgent || '';

Â  Â  Â  Â  Â  Â  if (/(Android|iPhone|iPad|iPod|Windows Phone|BlackBerry|IEMobile|Mobile)/i.test(ua)) return true;

Â  Â  Â  Â  Â  Â  if (/Mac/.test(navigator.platform || '') && (navigator.maxTouchPoints || 0) > 1) return true;

Â  Â  Â  Â  Â  Â  const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

Â  Â  Â  Â  Â  Â  const canHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;

Â  Â  Â  Â  Â  Â  return (coarse && !canHover);

Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  function isPopup(){ try { if (window.opener && !window.opener.closed) return true; } catch {} try { if (['gameWindow','siuGame','popup'].includes(window.name)) return true; } catch {} return false; }

Â  Â  Â  Â  Â  return isMobileStrict() || isPopup();

Â  Â  Â  Â  })();

Â  Â  Â  Â  if (window.__PLAY_ALLOWED){ ['top-bar','container'].forEach(id => { const el=document.getElementById(id); if(el) el.style.visibility='visible'; }); }

Â  Â  Â  Â  return;

Â  Â  Â  }

Â  Â  })();

Â  </script>

Â  <!-- ğŸ“ ì •ì±…(inframe) ì˜¤ë²„ë ˆì´ ì—´ê¸°/ë‹«ê¸° -->

Â  <script>

Â  Â  (function () {

Â  Â  Â  const more   = document.getElementById('tos-more-link');

Â  Â  Â  const ov     = document.getElementById('policy-overlay');

Â  Â  Â  const frame  = document.getElementById('policy-frame');

Â  Â  Â  const closeB = document.getElementById('policy-close');

Â  Â  Â  function openPolicy() {

Â  Â  Â  Â  if (!ov) return;

Â  Â  Â  Â  if (frame && !frame.dataset._loadedOnce) {

Â  Â  Â  Â  Â  frame.src = '/privacy' + (location.search || '') + (location.hash || '');

Â  Â  Â  Â  Â  frame.dataset._loadedOnce = '1';

Â  Â  Â  Â  }

Â  Â  Â  Â  ov.classList.add('show');

Â  Â  Â  Â  ov.setAttribute('aria-hidden', 'false');

Â  Â  Â  }

Â  Â  Â  function closePolicy() {

Â  Â  Â  Â  if (!ov) return;

Â  Â  Â  Â  ov.classList.remove('show');

Â  Â  Â  Â  ov.setAttribute('aria-hidden', 'true');

Â  Â  Â  }

Â  Â  Â  more    && more.addEventListener('click', (e) => { e.preventDefault(); openPolicy(); });

Â  Â  Â  closeB  && closeB.addEventListener('click', closePolicy);

Â  Â  Â  ov      && ov.addEventListener('click', (e) => { if (e.target === ov) closePolicy(); });

Â  Â  Â  window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePolicy(); });

Â  Â  })();

Â  </script>

</body>  
</html>  