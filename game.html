<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</title>

  <script>
    try {
      if (!sessionStorage.getItem('pmode_init')) {
        history.replaceState(null, '', '/login' + (location.hash || ''));
        sessionStorage.setItem('pmode_init', '1');
      }
    } catch (e) {}
  </script>

  <script>
    const allowedParentOrigins = [
      location.origin,
      'https://xn--989a202a4ogwtc69p.siustudio.kro.kr',
      'https://siustudio.kro.kr'
    ];
    function isAllowedRedirect(urlStr) {
      try {
        const u = new URL(urlStr);
        if (u.protocol !== 'https:') return false;
        const host = u.hostname;
        const base1 = 'xn--989a202a4ogwtc69p.siustudio.kro.kr';
        const base2 = 'siustudio.kro.kr';
        return (
          host === base1 || host === base2 ||
          host.endsWith('.' + base1) || host.endsWith('.' + base2)
        );
      } catch { return false; }
    }
    let parentOrigin     = sessionStorage.getItem('parent_origin')     || null;
    let pendingRedirect  = sessionStorage.getItem('pending_redirect')  || null;
    let pendingState     = sessionStorage.getItem('pending_state')     || null;

    function consumePendingRedirect() {
      let target = null;
      try {
        const fromStorage = sessionStorage.getItem('pending_redirect');
        if (fromStorage) {
          sessionStorage.removeItem('pending_redirect');
          target = fromStorage;
        }
      } catch {}
      if (!target && pendingRedirect) target = pendingRedirect;
      pendingRedirect = null;
      return (target && isAllowedRedirect(target)) ? target : null;
    }

    function notifyReadyToParent() {
      try {
        if (window.opener && !window.opener.closed) {
          allowedParentOrigins.forEach((o) => {
            try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}
          });
        }
      } catch {}
    }
    notifyReadyToParent();

    function notifyAuthSuccessAndExit() {
      const target = consumePendingRedirect();
      const hasParent = window.opener && !window.opener.closed && parentOrigin;
      if (hasParent) {
        try {
          window.opener.postMessage({
            type: 'auth-success', ok: true, redirect: target || undefined, receivedState: pendingState
          }, parentOrigin);
        } catch {}
        try { window.close(); } catch {}
        return;
      }
      if (target) window.location.href = target;
    }
    window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;
  </script>

  <style>
    :root{
      --glass-bg: rgba(10,12,20,0.40);
      --glass-brd: rgba(255,255,255,0.08);
      --accent: #00d4ff;
    }
    body { margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    img { display:block; }
    #top-bar, #container { visibility: hidden; }

    .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    #boot-overlay{
      position:fixed; inset:0; z-index:3000;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      backdrop-filter: blur(3px);
    }
    #boot-overlay .card{
      width:min(420px,92vw); border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));
      padding:16px;
      text-align:center; color:#e6f7ff;
      box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* Î°úÍ∑∏Ïù∏ Ïπ¥Îìú */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));
      box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
      display:none;
    }
    #auth-container.hidden { opacity:0; transform: translate(-50%, -46% ) scale(.98); pointer-events:none; visibility:hidden; }
    #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }
    #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20); color:#fff; outline:none; font-size:14px; }
    #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.22); }
    #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }
    #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer; }

    .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }
    .auth-status.show { opacity:1; transform:translateY(0); }

    .login-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60)); border-radius:14px; z-index:1100; opacity:1; pointer-events:auto; }
    .login-overlay.show { display:flex; }

    .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; }

    @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

    /* ÏÉÅÎã® Î∞î */
    #top-bar {
      position: fixed; top: 5px; left: 5px; right: 5px;
      display: flex; flex-wrap: wrap; gap:6px 8px;
      justify-content: space-between; align-items: center;
      background: rgba(30,30,30,0.55);
      padding:6px 10px; border-radius:8px;
      font-size:12px; z-index:1000;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; }
    .bar-group img { width:16px; height:16px; }
    .bar-group span { white-space: nowrap; }
    #ship-img{ width:16px; height:16px; }

    #settings-btn {
      margin-left: 8px; padding: 6px 10px; border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;
      cursor: pointer; font-weight: 700; writing-mode: horizontal-tb;
    }
    #settings-btn:hover { filter: brightness(1.08); }

    /* Î≥∏Î¨∏ */
    #container { margin:56px auto 20px; width:90%; max-width:640px; padding:16px 20px; background:rgba(30,30,30,0.55); border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
    h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }
    button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }

    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }

    .particle { position:absolute; width:6px; height:6px; background:#ffd700; border-radius:50%; opacity:.8; animation:floatUp .8s ease-out forwards; pointer-events:none; }
    @keyframes floatUp { to { transform: translate(var(--dx),var(--dy)) scale(0); opacity:0; } }
    #ore { width:200px; cursor:pointer; }

    /* Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ */
    #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.90); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }
    #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

    /* Î∞îÌÖÄ ÎÇ¥ÎπÑ */
    #bottom-nav{
      position: fixed;
      left: 50%; bottom: max(12px, env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%);
      display: flex; gap: 8px; padding: 8px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-brd);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      z-index: 1200; max-width: 96vw;
    }
    #bottom-nav .tab{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 6px; min-width: 70px; padding: 10px 12px; font-size: 13px;
      color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06); transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    #bottom-nav .tab:hover{ transform: translateY(-1px); }
    #bottom-nav .tab.active{
      color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);
      border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);
    }

    #container{ padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }
    #planets-content{ padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px)); }

    @media (max-width: 420px){
      #top-bar{ font-size:11px; padding:6px 8px; }
      #settings-btn{ padding:5px 8px; font-size:12px; }
      #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; }
      #bottom-nav .tab{ padding:10px 8px; min-width:0; }
      h1{ font-size:1.2em; }
    }

    /* ÏÇ¨Ïù¥Îìú Î©îÎâ¥ */
    #side-menu-toggle{
      position: fixed; left: 8px; bottom: calc(96px + env(safe-area-inset-bottom, 0px));
      z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;
      display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }
    #side-backdrop.show{ opacity:1; pointer-events:auto; }
    #side-menu{
      position: fixed; top: 0; left: 0; bottom: 0; width: 260px; max-width: 84vw;
      transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);
      background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);
    }
    #side-menu.open{ transform: translateX(0); }
    .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .side-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none; }
    .side-item:hover{ filter: brightness(1.08); }
    .side-item .icon{ width:18px; text-align:center; }
    .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }
    @media (max-width: 420px){ #side-menu-toggle{ bottom: calc(88px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; } #side-menu{ width: 240px; } }

    /* ===== Ï∂úÏÑù & Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ ===== */
    #daily-overlay{
      position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);
    }
    #daily-overlay.show{ display:flex; }
    #daily-card{
      width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));
      padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);
      color:#eaf6ff;
    }
    #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    #daily-info{ margin:6px 0 10px; font-size:13px; color:#cfe6ff; min-height:36px; }
    #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

    .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }
    .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }
    .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

    /* Ïä¨Î°ØÌòï (ÏÑ∏Î°ú ÎÇôÌïò) */
    #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .slot-window{ width:320px; height:56px; overflow:hidden; border-radius:10px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }
    .reel{ display:flex; flex-direction:column; }
    .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }
    .slot-icon{ font-size:20px; }

    /* Ïª®Ìä∏Î°§/ÌôïÎ•†/Î™©Î°ù */
    #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .spinbtn{ padding:10px 14px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.14); font-weight:900; }
    .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }
    .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }
    #prob-toggle{ width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff; }
    #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }
    #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }
    #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }
  </style>
</head>
<body>
  <!-- Î∂ÄÌåÖ Ï§ë Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="boot-overlay" aria-hidden="false">
    <div class="card" role="status" aria-live="polite" aria-atomic="true">
      <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
        <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
        <div style="text-align:left;">
          <div style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë‚Ä¶</div>
          <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
        </div>
      </div>
      <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
    </div>
  </div>

  <!-- Ïù∏Ï¶ù -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">Î°úÍ∑∏Ïù∏</button>
      <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">ÌöåÏõêÍ∞ÄÏûÖ</button>
    </div>

    <h2 id="auth-title">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</h2>
    <input type="email" id="email" placeholder="Ïù¥Î©îÏùº" autocomplete="username" />
    <input type="password" id="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
    <div id="signup-extra" style="display:none; margin-top:6px;">
      <input type="password" id="password-confirm" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏" autocomplete="new-password" />
    </div>

    <button id="login-btn" class="primary-btn">Î°úÍ∑∏Ïù∏</button>
    <button id="signup-btn" class="ghost-btn" style="display:none">ÌöåÏõêÍ∞ÄÏûÖ</button>

    <button id="google-btn" aria-label="Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ (Í∂åÏû•)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false"><path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/><path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/><path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/></svg>
      </span>
      <span class="g-text">Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ <small>(Í∂åÏû•)</small></span>
    </button>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>
    <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë</div>
            <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">Î≥¥Ïïà Ïó∞Í≤∞ ¬∑ Ïù∏Ï¶ù Ï§ë‚Ä¶</div>
          </div>
        </div>
        <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
        <div style="width:220px; margin:0 auto 10px; background:rgba(255,255,255,0.04); border-radius:8px; padding:6px;">
          <div id="overlay-progress" style="height:8px; width:0%; border-radius:6px; background:linear-gradient(90deg,#00c0ff,#0077ff); transition:width .4s ease;"></div>
        </div>
        <ol id="overlay-steps" style="list-style:none; padding:0; margin:0; font-size:13px; color:#dbefff; max-width:260px;">
          <li data-step="1" style="opacity:0.9; margin-bottom:6px;">1. Ïù∏Ï¶ùÏ∞Ω Ïó¥Í∏∞</li>
          <li data-step="2" style="opacity:0.6; margin-bottom:6px;">2. Í∂åÌïú ÏöîÏ≤≠</li>
          <li data-step="3" style="opacity:0.4;">3. Î°úÍ∑∏Ïù∏ ÏôÑÎ£å</li>
        </ol>
        <div id="login-overlay-detail" style="font-size:12px; color:#9fbfda; margin-top:10px; min-height:20px;">Î∏åÎùºÏö∞Ï†Ä ÌåùÏóÖ ÎòêÎäî ÏÉà Ï∞ΩÏóêÏÑú Ïù∏Ï¶ùÏ∞ΩÏù¥ Ïó¥Î¶¥ Ïàò ÏûàÏäµÎãàÎã§.</div>
      </div>
    </div>
  </div>

  <!-- ÏÉÅÎã® Î∞î & Î©îÏù∏ Í≤åÏûÑ -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ÏûêÏõê: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ÏΩîÏù∏: 0</span>
      <!-- Ïù¥Î≤§Ìä∏ ÏΩîÏù∏ -->
      <img src="/images/event-icon.png" alt="EventCoin" />
      <span id="ecoins">Ïù¥Î≤§Ìä∏ÏΩîÏù∏: 0</span>
    </div>
    <div class="bar-group">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />
      <span id="ship-level">1Î†ô (20ÏΩîÏù∏)</span>
      <button id="upgrade-ship">ÏóÖÍ∑∏Î†àÏù¥Îìú</button>
      <button id="settings-btn" aria-label="ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô">‚öôÔ∏è ÏÑ§Ï†ï</button>
    </div>
  </div>

  <div id="container">
    <h1>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</h1>

    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="Í¥ëÏÑù" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ÏûêÏõê ‚Üí 1ÏΩîÏù∏</button>
        <button id="auto-convert-buy" class="general">ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(100ÏΩîÏù∏)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>Ï¥ù Ï¥àÎãπ ÏûêÏõê: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ÏïåÎ∞î Í≥†Ïö© (<span id="worker-cost">0</span>ÏΩîÏù∏)</button>
      <p>Ï¥ù Ï¥àÎãπ ÏΩîÏù∏: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ÏΩîÏù∏ ÏïåÎ∞î (<span id="conversion-cost">0</span>ÏΩîÏù∏)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>ÌÅ¥Î¶≠Îãπ ÏûêÏõê: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (15ÏΩîÏù∏)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <!-- Î∞îÌÖÄ ÎÇ¥ÎπÑ -->
    <nav id="bottom-nav" aria-label="Í≤åÏûÑ ÌÉ≠ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò">
      <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ü™®</span><span class="t-label">Î©îÏù∏</span></div>
      <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">üë©‚ÄçüöÄ</span><span class="t-label">Ïö∞Ï£ºÏù∏</span></div>
      <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">‚öôÔ∏è</span><span class="t-label">ÏóÖÍ∑∏Î†àÏù¥Îìú</span></div>
      <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ü™ê</span><span class="t-label">ÌñâÏÑ±</span></div>
    </nav>
  </div>

  <!-- Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
  <div id="custom-menu">
    <div class="menu-item" data-action="menu"><span>üéÆ Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></div>
    <div class="menu-item" data-action="download"><span>‚¨áÔ∏è Ïï± Îã§Ïö¥Î°úÎìú</span></div>
    <div class="menu-item" data-action="resume"><span>‚ñ∂Ô∏è Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></div>
    <div class="menu-item" data-action="rank"><span>üèÜ Îû≠ÌÇπ Î≥¥Í∏∞</span></div>
    <div class="menu-item" data-action="attendance">
      <span>üìÖ Ï∂úÏÑù Î≥¥ÏÉÅ</span>
      <span id="attendance-left">-</span>
    </div>
  </div>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <button id="side-menu-toggle" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥ Ïó¥Í∏∞" title="Î©îÎâ¥">‚ò∞</button>
  <div id="side-backdrop" aria-hidden="true"></div>
  <aside id="side-menu" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥" aria-hidden="true">
    <div class="side-header">Î©îÎâ¥</div>
    <nav class="side-items">
      <button class="side-item" data-action="menu"><span class="icon">üéÆ</span><span>Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></button>
      <button class="side-item" data-action="download"><span class="icon">‚¨áÔ∏è</span><span>Ïï± Îã§Ïö¥Î°úÎìú</span></button>
      <button class="side-item" data-action="resume"><span class="icon">‚ñ∂Ô∏è</span><span>Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></button>
      <button class="side-item" data-action="rank"><span class="icon">üèÜ</span><span>Îû≠ÌÇπ Î≥¥Í∏∞</span></button>
      <button class="side-item" data-action="attendance">
        <span><span class="icon">üìÖ</span>Ï∂úÏÑù Î≥¥ÏÉÅ</span>
        <span class="side-right" id="attendance-left-side">-</span>
      </button>
    </nav>
  </aside>

  <!-- Ï∂úÏÑù/Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="daily-overlay" aria-hidden="true">
    <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">
      <div id="daily-title">
        <span>üìÖ Ïò§ÎäòÏùò Î≥¥ÏÉÅ & Ïä¨Î°Ø</span>
        <button id="prob-toggle" title="ÌôïÎ•†/Î≥¥ÏÉÅ Ï†ïÎ≥¥">i</button>
      </div>

      <div class="tabbar">
        <button class="tbtn active" data-mode="daily">Ï∂úÏÑù Ïä¨Î°Ø(Î¨¥Î£å/Ïùº1Ìöå)</button>
        <button class="tbtn" data-mode="premium">ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø(Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1)</button>
        <button class="tbtn" data-mode="ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø(10)</button>
      </div>

      <div id="daily-info">ÌôïÏù∏ Ï§ë‚Ä¶</div>

      <!-- Ïä¨Î°ØÌòï (ÏÑ∏Î°ú ÎÇôÌïò) -->
      <div id="slot-wrap">
        <div class="slot-window">
          <div id="slot-reel" class="reel"></div>
        </div>
      </div>

      <div id="mode-row">
        <button id="spin-daily"   class="spinbtn spin-free">Î¨¥Î£å Ï∂úÏÑù ÎèåÎ¶¨Í∏∞</button>
        <button id="spin-premium" class="spinbtn spin-prem">ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎèåÎ¶¨Í∏∞(-EC 1)</button>
        <button id="spin-ecoin"   class="spinbtn spin-ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÎèåÎ¶¨Í∏∞(-EC 10)</button>
      </div>

      <div id="prob-panel"></div>
      <div id="reward-list"></div>

      <div id="daily-actions">
        <button id="daily-close">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- ÏÇ¨Ïö¥Îìú -->
  <audio id="sfx-start"  src="/sounds/roulette_start.mp3" preload="auto"></audio>
  <audio id="sfx-tick"   src="/sounds/roulette_tick.mp3"  preload="auto"></audio>
  <audio id="sfx-win"    src="/sounds/roulette_win.mp3"   preload="auto"></audio>

  <!-- Firebase + Í≤åÏûÑ Î°úÏßÅ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
      sendEmailVerification, GoogleAuthProvider, signInWithPopup, signInWithRedirect
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, onValue, runTransaction, update, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ===== Í≥µÌÜµ ÏÉÅÌÉú =====
    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null;
    let localLastWrite = 0;
    let isInitialSync = false;

    // ÏÉà Íµ¨Ï°∞Ïö© Ï†ÑÏó≠ Í≤ΩÎ°ú
    let userServerKey = null;  // "server1" Îì±
    let userIdKey     = null;  // Ïù¥Î©îÏùº local-part Í∏∞Î∞ò
    let userBasePath  = null;  // `users/${server}/${idKey}`

    const defaultData = {
      resources:0, coins:0, eventCoins:0,
      clickPower:1, shipLevel:1, shipUpgradeCost:20,
      workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[]
    };
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const clickUpgradeCost=15;

    let currentAuthMode = 'login';

    // ‚òÖ ÏµúÏ¥à 1Ìöå Ï∂úÏÑù EC Î≥¥Ïû• ÌîåÎûòÍ∑∏
    let firstDailyGuarantee = false;

    // ===== Ïú†Ìã∏ =====
    function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

    function convertResources(maxCount = null) {
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count > 0) { state.resources -= count * 10; state.coins += count; }
    }

    async function ensureInitialData(refObj) {
      try {
        await runTransaction(refObj, current => {
          if (current === null) return { ...defaultData, _lastUpdated: Date.now() };
          return current;
        });
      } catch (err) { console.error('Ï¥àÍ∏∞Ìôî Ìä∏ÎûúÏû≠ÏÖò ÏóêÎü¨:', err); }
    }

    function save() {
      if (!uid || !dataRef) return;
      if (isInitialSync) return;
      if (!window.__PLAY_ALLOWED) return;
      const now = Date.now();
      state._lastUpdated = now;
      localLastWrite = now;
      try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
      update(dataRef, { ...state }).catch(err => console.error('Ï†ÄÏû• ÏóêÎü¨:', err));
    }

    // ===== ÏÉà Íµ¨Ï°∞: idKey & server Î∞∞Ï†ï =====
    function sanitizeIdKey(raw) {
      const s = (raw || '').toString().trim().toLowerCase();
      const base = s.replace(/[^a-z0-9._-]+/g, '_').replace(/^_+|_+$/g, '');
      return base || 'user';
    }
    function makeIdKeyFromUser(user) {
      const email = (user.email || '').toString();
      if (email.includes('@')) {
        const local = email.split('@')[0];
        return sanitizeIdKey(local);
      }
      const name = sanitizeIdKey(user.displayName || '');
      if (name && name !== 'user') return name;
      return `user_${(user.uid || '').slice(0,6) || '000000'}`;
    }

    async function ensureServerMapping(user) {
      // 1) Í∏∞Ï°¥ Îß§Ìïë ÌôïÏù∏
      const mapRef = ref(db, `userServerMap/${user.uid}`);
      try {
        const snap = await get(mapRef);
        if (snap.exists()) {
          const { server, id } = snap.val() || {};
          if (server && id) return { server, id };
        }
      } catch {}

      // 2) Ïã†Í∑ú Î∞∞Ï†ï
      let nextIndex = 0;
      try {
        const tRef = ref(db, 'meta/nextIndex');
        const res = await runTransaction(tRef, cur => (cur || 0) + 1);
        nextIndex = res?.snapshot?.val() || 1;
      } catch (e) { console.warn('nextIndex txn fail, fallback index=1', e); nextIndex = 1; }

      const serverNum = Math.max(1, Math.ceil(nextIndex / 15)); // 15Î™ÖÎãπ Ìïú ÏÑúÎ≤Ñ
      let server = `server${serverNum}`;
      let idKey  = makeIdKeyFromUser(user);

      // 3) ÏÑúÎ≤Ñ ÎÇ¥ key Ï∂©Îèå Î∞©ÏßÄ
      try {
        const existsSnap = await get(ref(db, `users/${server}/${idKey}`));
        if (existsSnap.exists()) idKey = `${idKey}-${(user.uid||'').slice(0,4)}`;
      } catch {}

      // 4) Îß§Ìïë Ï†ÄÏû•
      try {
        await update(ref(db), {
          [`userServerMap/${user.uid}`]: { server, id: idKey, createdAt: Date.now() }
        });
      } catch (e) { console.error('mapping save error', e); }

      return { server, id: idKey };
    }

    // Íµ¨(old) Í≤ΩÎ°ú ‚Üí Ïã†(new) Í≤ΩÎ°ú 1Ìöå ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò (Ï°¥Ïû¨ Ïãú Î≥µÏÇ¨)
    async function migrateLegacyIfExists(uid, basePath) {
      try {
        const oldSnap = await get(ref(db, `users/${uid}`));
        if (!oldSnap.exists()) return;
        const old = oldSnap.val() || {};
        const updates = {};
        if (old.gameData) updates[`${basePath}/gameData`] = old.gameData;
        if (old.daily)    updates[`${basePath}/daily`]    = old.daily;
        if (Object.keys(updates).length) {
          updates[`migrations/${uid}`] = { to: basePath, at: Date.now() };
          await update(ref(db), updates);
          console.info('Migrated legacy user data to', basePath);
        }
      } catch (e) {
        console.warn('legacy check/migrate failed', e);
      }
    }

    // ======= UI ÏóòÎ¶¨Î®ºÌä∏ =======
    const authContainer = document.getElementById('auth-container');
    const authErrorEl   = document.getElementById('auth-error');
    const bootOverlay   = document.getElementById('boot-overlay');

    function setBootVisible(v){
      if (!bootOverlay) return;
      bootOverlay.style.display = v ? 'flex' : 'none';
      bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');
    }
    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg || '';
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';
    }

    function showLoginOverlay(show, text = 'Î°úÍ∑∏Ïù∏ Ï§ë‚Ä¶', opts = {}) {
      const overlay = document.getElementById('login-overlay');
      if (!overlay) return;
      const title = document.getElementById('login-overlay-title');
      const sub   = document.getElementById('login-overlay-sub');
      const detail= document.getElementById('login-overlay-detail');
      const progress = document.getElementById('overlay-progress');
      const steps = Array.from(document.querySelectorAll('#overlay-steps li'));
      if (text) title.textContent = text;
      sub.textContent    = opts.subText || 'Î≥¥Ïïà Ïó∞Í≤∞ ¬∑ Ïù∏Ï¶ù Ï§ë‚Ä¶';
      detail.textContent = opts.detail  || 'Î∏åÎùºÏö∞Ï†Ä ÌåùÏóÖ ÎòêÎäî ÏÉà Ï∞ΩÏóêÏÑú Ïù∏Ï¶ùÏ∞ΩÏù¥ Ïó¥Î¶¥ Ïàò ÏûàÏäµÎãàÎã§.';
      steps.forEach(li => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
      function activateStep(n){ steps.forEach((li,i)=>{ if(i<n){ li.setAttribute('data-active','true'); li.style.opacity=1; } }); }
      if (show) {
        overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
        activateStep(1); progress.style.width='24%';
        overlay._t1 && clearTimeout(overlay._t1); overlay._t1=setTimeout(()=>{ activateStep(2); progress.style.width='64%'; },800);
        overlay._t2 && clearTimeout(overlay._t2); overlay._t2=setTimeout(()=>{ progress.style.width='84%'; },1700);
      } else {
        overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
        progress.style.width='0%';
        overlay._t1 && clearTimeout(overlay._t1); overlay._t2 && clearTimeout(overlay._t2);
      }
    }

    function showGameUI() {
      try {
        authContainer.classList.add('hidden');
        try { history.replaceState(null, '', '/Í≤åÏûÑ' + (location.hash || '')); } catch {}
        setTimeout(() => {
          authContainer.style.display = 'none';
          const lb = document.getElementById('logout-btn');
          if (lb) lb.style.display = 'block';
          ['top-bar','container'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.visibility = 'visible';
          });
        }, 300);
      } catch (e) { console.error('showGameUI error', e); }
    }

    // ====== Ï∂úÏÑù(KST) Ïú†Ìã∏ ======
    function kstDate(d=new Date()){
      return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }
    function kstDayKey(d=new Date()){
      const t = kstDate(d);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextResetKST(d=new Date()){ const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n; }
    function fmtLeft(ms){
      if(ms<=0) return 'ÏßÄÍ∏à Í∞ÄÎä•';
      const s=Math.floor(ms/1000);
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    // === Î≥¥ÏÉÅ Ïä§ÏºÄÏùºÎü¨/ÌÖúÌîåÎ¶ø ===
    function calcBaseCoin(){
      const rps = state.workerCount * getWorkerPower();
      const cps = state.conversionCount;
      const rpc = state.clickPower;
      const planets = (state.ownedPlanets?.length || 0);
      const ship = (state.shipLevel || 1);
      const auto = state.autoConvertBought ? 1 : 0;
      const score =
        20 * Math.log2(1 + rps) +
        50 * Math.log2(1 + cps) +
        10 * Math.log2(1 + rpc) +
        140 * planets +
        35  * ship +
        (auto ? 25 : 0);
      const baseRaw = 60 + score;
      const base = Math.round(baseRaw * 0.7);
      return Math.min(Math.max(base, 40), 30000);
    }

    const TPL_DAILY = [
      { key:'coin_x0_4',  type:'coin', coinMul:0.4,  icon:'ü™ô', color:'#7AFBFF', w:0.35 },
      { key:'coin_x0_8',  type:'coin', coinMul:0.8,  icon:'üí∞', color:'#4DFFB5', w:0.25 },
      { key:'coin_x1_2',  type:'coin', coinMul:1.2,  icon:'üí∞', color:'#00E5FF', w:0.10 },
      { key:'res_200',    type:'res',  val:200,      icon:'ü™®', color:'#FFEA70', w:0.10 },
      { key:'buff_click', type:'buff', btype:'click', bval:0.5,  bdur:5*60*1000, icon:'‚ö°', color:'#FFA8FF', w:0.075 },
      { key:'buff_conv',  type:'buff', btype:'convert', bval:1.0, bdur:3*60*1000, icon:'‚öôÔ∏è', color:'#FFD0A8', w:0.05 },
      { key:'eco_1',      type:'ecoin', val:1,       icon:'üéüÔ∏è', color:'#FFD05C', w:0.020 },
      { key:'eco_3',      type:'ecoin', val:3,       icon:'üéüÔ∏è', color:'#FF9E3D', w:0.005 }
    ];
    const TPL_PREMIUM = [
      { key:'coin_x1_3',  type:'coin', coinMul:1.3,  icon:'üí∞', color:'#00E5FF', w:0.30 },
      { key:'coin_x1_9',  type:'coin', coinMul:1.9,  icon:'üí∞', color:'#4DFFB5', w:0.22 },
      { key:'coin_x2_6',  type:'coin', coinMul:2.6,  icon:'üí∞', color:'#32C6FF', w:0.12 },
      { key:'res_1000',   type:'res',  val:1000,     icon:'ü™®', color:'#FFEA70', w:0.14 },
      { key:'buff_click2',type:'buff', btype:'click', bval:1.0, bdur:10*60*1000, icon:'‚ö°', color:'#FFA8FF', w:0.12 },
      { key:'buff_conv2', type:'buff', btype:'convert', bval:2.0, bdur:5*60*1000, icon:'‚öôÔ∏è', color:'#FFD0A8', w:0.06 },
      { key:'eco_3',      type:'ecoin', val:3,       icon:'üéüÔ∏è', color:'#FF9E3D', w:0.04 }
    ];
    const TPL_ECOIN = [
      { key:'coin_x3',    type:'coin', coinMul:3.0,  icon:'üí∞', color:'#00E5FF', w:0.26 },
      { key:'coin_x5',    type:'coin', coinMul:5.0,  icon:'üí∞', color:'#4DFFB5', w:0.18 },
      { key:'coin_x8',    type:'coin', coinMul:8.0,  icon:'üí∞', color:'#32C6FF', w:0.10 },
      { key:'buff_duo',   type:'buffBoth', bval:1.0, bdur:15*60*1000, icon:'üöÄ', color:'#8AE1FF', w:0.18 },
      { key:'eco_8',      type:'ecoin', val:8,       icon:'üéüÔ∏è', color:'#FFBE5C', w:0.16 },
      { key:'eco_12',     type:'ecoin', val:12,      icon:'üéüÔ∏è', color:'#FF9E3D', w:0.08 },
      { key:'eco_20',     type:'ecoin', val:20,      icon:'üéüÔ∏è', color:'#FF7AE1', w:0.04 }
    ];
    function materializeItems(tpl){
      const base = calcBaseCoin();
      return tpl.map(it=>{
        if (it.type==='coin'){
          const amt = Math.max(1, Math.round(base * it.coinMul));
          return { ...it, label:`ÏΩîÏù∏ ${amt.toLocaleString()}`, onWin:()=>{ state.coins += amt; } };
        }
        if (it.type==='res'){
          return { ...it, label:`ÏûêÏõê ${it.val.toLocaleString()}`, onWin:()=>{ state.resources += it.val; } };
        }
        if (it.type==='ecoin'){
          return { ...it, label:`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ √ó${it.val}`, onWin:()=>{ state.eventCoins = (state.eventCoins||0) + it.val; } };
        }
        if (it.type==='buff'){
          return { ...it, label:`${it.btype==='click'?'ÌÅ¥Î¶≠':'Î≥ÄÌôò'} +${Math.round(it.bval*100)}% / ${Math.round(it.bdur/60000)}m`,
            onWin:()=>{ addTempBuff(it.btype, it.bval, it.bdur); } };
        }
        if (it.type==='buffBoth'){
          return { ...it, label:`Î™®Îì† ÏÉùÏÇ∞ +${Math.round(it.bval*100)}% / ${Math.round(it.bdur/60000)}m`,
            onWin:()=>{ addTempBuff('click', it.bval, it.bdur); addTempBuff('convert', it.bval, it.bdur); } };
        }
        return it;
      });
    }
    function getItemsForMode(mode){
      const tpl = mode==='daily'   ? TPL_DAILY
               : mode==='premium' ? TPL_PREMIUM
               : mode==='ecoin'   ? TPL_ECOIN
               : TPL_PREMIUM;
      return materializeItems(tpl);
    }

    function playSfx(id){
      const el=document.getElementById(id);
      if (el && el.play){ el.currentTime=0; el.play().catch(()=>{}); return; }
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='triangle';
        o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;
        g.gain.setValueAtTime(.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);
        o.start(); o.stop(ctx.currentTime+.08);
      }catch{}
    }
    function startTickLoop(intv=120){ stopTickLoop(); startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv); }
    function stopTickLoop(){ if(startTickLoop._id){ clearInterval(startTickLoop._id); startTickLoop._id=null; } }
    function addTempBuff(type, value, dur){
      const now=Date.now(); if (!window.fx) window.fx={};
      const slot = (!window.fx._tempBuff || now>=window.fx._tempBuff.until) ? '_tempBuff' : '_tempBuff2';
      if(!window.fx[slot]) window.fx[slot]={type,value,until:now+dur};
      else{ window.fx[slot].type=type; window.fx[slot].value=value; window.fx[slot].until=now+dur; }
    }

    const slotWrap = document.getElementById('slot-wrap');
    const reel = document.getElementById('slot-reel');
    function buildSlot(items){
      const rows = items.map(it=>`<div class="slot-item"><span class="slot-icon">${it.icon||'üéÅ'}</span>${it.label||it.key}</div>`).join('');
      reel.innerHTML = rows.repeat(8);
      reel.style.transform = 'translateY(0px)';
      reel.style.transition = 'none';
    }
    function spinSlot(items, picked){
      const rowH=56, totalRows = items.length*8;
      const idx = items.findIndex(it=>it.key===picked.key);
      const stopRow = (items.length*6) + idx;
      const targetY = - stopRow * rowH;
      startTickLoop(90);
      playSfx('sfx-start');
      requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
          reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';
          reel.style.transform = `translateY(${targetY}px)`;
        });
      });
      return new Promise(resolve=>{
        reel.ontransitionend = ()=>{ reel.ontransitionend=null; stopTickLoop(); playSfx('sfx-win'); resolve(); };
      });
    }

    // ===== Ï∂úÏÑù/ÌôïÎ•†/Î≤ÑÌäº =====
    const dailyOverlay = document.getElementById('daily-overlay');
    const dailyInfo    = document.getElementById('daily-info');
    const dailyCloseBtn= document.getElementById('daily-close');
    const probPanel    = document.getElementById('prob-panel');
    const probToggle   = document.getElementById('prob-toggle');
    const rewardList   = document.getElementById('reward-list');
    const tabs = Array.from(document.querySelectorAll('.tbtn'));
    const spinDailyBtn   = document.getElementById('spin-daily');
    const spinPremiumBtn = document.getElementById('spin-premium');
    const spinEcoinBtn   = document.getElementById('spin-ecoin');

    let dailyCache = null;
    let currentMode = 'daily';
    let activeItems = [];

    function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }
    function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }
    dailyCloseBtn.onclick = closeDailyOverlay;
    probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

    function setMode(mode){
      currentMode = mode;
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
      activeItems = getItemsForMode(mode);
      slotWrap.style.display     = 'flex';
      document.getElementById('spin-daily').style.display   = (mode==='daily')? 'inline-block':'none';
      document.getElementById('spin-premium').style.display = (mode==='premium')? 'inline-block':'none';
      document.getElementById('spin-ecoin').style.display   = (mode==='ecoin')? 'inline-block':'none';
      buildSlot(activeItems);
      buildProbPanel(activeItems, mode);
      buildRewardList(activeItems);
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

    function buildProbPanel(items, mode){
      const header = mode==='daily' ? 'Ï∂úÏÑù Ïä¨Î°Ø ÌôïÎ•†'
                  : mode==='premium' ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø ÌôïÎ•†(EC -1)'
                  : 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø ÌôïÎ•†(EC -10)';

      // ‚òÖ ÏµúÏ¥à 1Ìöå Î≥¥Ïû•: daily + Ïò§Îäò ÎØ∏ÏàòÎ†π + Î≥¥Ïû• ON ‚Üí ÌëúÍ∏∞ 100%
      const today = kstDayKey();
      const canClaim = (dailyCache?.lastKey !== today);
      if (mode==='daily' && firstDailyGuarantee && canClaim) {
        probPanel.innerHTML =
          `<div style="margin-bottom:6px; color:#9fdcff;">${header}</div>
           <table>
             <tr>
               <td>üéüÔ∏è Ïù¥Î≤§Ìä∏ÏΩîÏù∏ √ó3 (ÏµúÏ¥à 1Ìöå Î≥¥Ïû•)</td>
               <td style="text-align:right">100.00%</td>
             </tr>
           </table>`;
        return;
      }

      const total=items.reduce((a,b)=>a+b.w,0);
      const rows=items.map(it=>`<tr><td>${it.icon||''} ${it.label||it.key}</td><td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td></tr>`).join('');
      probPanel.innerHTML = `<div style="margin-bottom:6px; color:#9fdcff;">${header}</div><table>${rows}</table>`;
    }
    function buildRewardList(items){
      rewardList.innerHTML = 'üé∞ Î≥¥ÏÉÅ Î™©Î°ù: ' + items.map(it=>`${it.icon||''} ${it.label||it.key}`).join(' ¬∑ ');
    }
    function refreshDailyInfo(canClaim){
      const today = kstDayKey();
      const streak = dailyCache?.streak || 0;
      const resetLeft = Math.max(0, nextResetKST()-kstDate());
      const leftText = canClaim ? 'ÏßÄÍ∏à Í∞ÄÎä•' : `Îã§Ïùå Ï∂úÏÑùÍπåÏßÄ ${fmtLeft(resetLeft)}`;
      dailyInfo.innerHTML = canClaim
        ? `Ïò§Îäò(${today}) Ï∂úÏÑù Ïä¨Î°Ø Í∞ÄÎä•! <b>${leftText}</b><br>Ïó∞ÏÜç ${streak}Ïùº`
        : `Ïò§Îäò(${today})ÏùÄ Ïù¥ÎØ∏ ÏôÑÎ£å. <b>${leftText}</b><br>ÌòÑÏû¨ Ïó∞ÏÜç ${streak}Ïùº`;
      spinDailyBtn.disabled = !canClaim;
    }

    async function applyPrizeTransaction(delta){
      await runTransaction(dataRef, current => {
        const cur = current || { ...defaultData };
        const next = { ...cur };
        next.coins      = (next.coins||0) + (delta.coins||0);
        next.resources  = (next.resources||0) + (delta.resources||0);
        next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);
        next._lastUpdated = Date.now();
        return next;
      });
    }
    function makeDeltaSnapshot(){
      return { coins: state.coins||0, resources: state.resources||0, eventCoins: state.eventCoins||0 };
    }
    function deltaFrom(before){
      return {
        coins: (state.coins||0) - before.coins,
        resources: (state.resources||0) - before.resources,
        eventCoins: (state.eventCoins||0) - before.eventCoins
      };
    }
    function pickWeighted(items){ const s=items.reduce((a,b)=>a+b.w,0); let r=Math.random()*s; for(const it of items){ if((r-=it.w)<=0) return it; } return items.at(-1); }
    function canSpendEC(n){ return (state.eventCoins||0) >= n; }

    // ==== Ïä§ÌïÄ Î≤ÑÌäº ====
    spinDailyBtn.onclick = async ()=>{
      if (!uid || !window.__PLAY_ALLOWED) return;
      const today = kstDayKey();
      const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));
      if (dailyCache?.lastKey === today) { refreshDailyInfo(false); return; }

      setMode('daily');

      // ‚òÖ Í∞ïÏ†ú ÎãπÏ≤®: ÏµúÏ¥à 1Ìöå EC Î≥¥Ïû•
      const canClaim = (dailyCache?.lastKey !== today);
      let picked;
      if (firstDailyGuarantee && canClaim) {
        picked = activeItems.find(it => it.key === 'eco_3') || {
          key:'eco_3', type:'ecoin', val:3, icon:'üéüÔ∏è',
          label:'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ √ó3',
          onWin:()=>{ state.eventCoins = (state.eventCoins||0) + 3; }
        };
      } else {
        picked = pickWeighted(activeItems);
      }

      const before = makeDeltaSnapshot();
      await spinSlot(activeItems, picked);
      picked.onWin();

      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta);

        let streak = Number(dailyCache?.streak||0);
        streak = (dailyCache?.lastKey === yesterday) ? (streak+1) : 1;

        await update(ref(db, `${userBasePath}/daily`), {
          lastKey: today, streak, lastClaimAt: Date.now(), lastPrize: picked.key
        });
        dailyCache = { lastKey: today, streak };

        // ‚òÖ Î≥¥Ïû• ÏÜåÏßÑ Ï≤òÎ¶¨
        if (firstDailyGuarantee) {
          firstDailyGuarantee = false;
          try { await update(ref(db), { [`${userBasePath}/meta/firstDailyGuarantee`]: false }); } catch {}
        }

        updateUI();
        dailyInfo.innerHTML = `üéâ ÎãπÏ≤®: <b>${picked.label}</b><br>Ïó∞ÏÜç ${streak}Ïùº`;
      }catch(e){
        console.error(e);
        dailyInfo.textContent='Î≥¥ÏÉÅ ÏßÄÍ∏â Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      }
    };
    spinPremiumBtn.onclick = async ()=>{
      if (!uid || !window.__PLAY_ALLOWED) return;
      if (!canSpendEC(1)) { dailyInfo.innerHTML='Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî: 1)'; return; }
      setMode('premium');
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();
      state.eventCoins -= 1;
      await spinSlot(activeItems, picked);
      picked.onWin();
      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta); updateUI();
        dailyInfo.innerHTML=`üéâ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎãπÏ≤®: <b>${picked.label}</b>`;
      }catch(e){ console.error(e); dailyInfo.textContent='ÏßÄÍ∏â Ïò§Î•ò'; }
    };
    spinEcoinBtn.onclick = async ()=>{
      if (!uid || !window.__PLAY_ALLOWED) return;
      if (!canSpendEC(10)) { dailyInfo.innerHTML='Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî: 10)'; return; }
      setMode('ecoin');
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();
      state.eventCoins -= 10;
      await spinSlot(activeItems, picked);
      picked.onWin();
      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta); updateUI();
        dailyInfo.innerHTML=`üéâ EC Ïä¨Î°Ø ÎãπÏ≤®: <b>${picked.label}</b>`;
      }catch(e){ console.error(e); dailyInfo.textContent='ÏßÄÍ∏â Ïò§Î•ò'; }
    };

    // ===== Ï∂úÏÑù Ï∫êÏãú =====
    async function fetchDaily(){
      if (!uid) return;
      try{
        const [dSnap, mSnap] = await Promise.all([
          get(ref(db, `${userBasePath}/daily`)),
          get(ref(db, `${userBasePath}/meta/firstDailyGuarantee`))
        ]);
        dailyCache = dSnap.exists() ? dSnap.val() : { lastKey:null, streak:0 };
        firstDailyGuarantee = mSnap.exists() ? !!mSnap.val() : firstDailyGuarantee;
      }catch{ dailyCache = { lastKey:null, streak:0 }; }
    }
    async function checkDailyAndMaybeShow(){
      await fetchDaily();
      const today = kstDayKey();
      const canClaim = dailyCache?.lastKey !== today;
      refreshDailyInfo(canClaim);
      setMode('daily');
      // ÌäúÌÜ†Î¶¨Ïñº Ï§ëÏóî ÏûêÎèô Ïó¥Í∏∞ ÎßâÍ∏∞
      if (canClaim && !window.__IN_TUTORIAL) openDailyOverlay();
    }

    // ===== Î©îÎâ¥Ïóê "ÎÇ®ÏùÄ ÏãúÍ∞Ñ" ÌëúÏãú =====
    const attMenuRight = document.getElementById('attendance-left');
    const attSideRight = document.getElementById('attendance-left-side');
    function updateAttendanceLabels(){
      if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }
      const today = kstDayKey();
      const can = (dailyCache?.lastKey !== today);
      if (can){ attMenuRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•'; attSideRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•'; }
      else{
        const left = Math.max(0, nextResetKST()-kstDate());
        const txt = fmtLeft(left);
        attMenuRight.textContent=txt; attSideRight.textContent=txt;
      }
    }
    setInterval(updateAttendanceLabels, 1000);

    // ===== Í≤åÏûÑ UI =====
    function updateUI() {
      document.getElementById('score').innerText  = `ÏûêÏõê: ${Math.floor(state.resources)}`;
      document.getElementById('coins').innerText  = `ÏΩîÏù∏: ${Math.floor(state.coins)}`;
      document.getElementById('ecoins').innerText = `Ïù¥Î≤§Ìä∏ÏΩîÏù∏: ${Math.floor(state.eventCoins||0)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}Î†ô (${state.shipUpgradeCost}ÏΩîÏù∏)`;
      document.getElementById('ship-img').src = `/images/ship-level${state.shipLevel}.png`;
      document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

      const clickUp = document.getElementById('click-upgrade');
      clickUp.innerText = `ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (${clickUpgradeCost}ÏΩîÏù∏)`;
      clickUp.disabled = state.coins < clickUpgradeCost;
      document.getElementById('click-power').innerText = state.clickPower;

      const autoBtn = document.getElementById('auto-convert-buy');
      autoBtn.innerHTML = state.autoConvertBought ? 'Íµ¨Îß§ ÏôÑÎ£å' : 'ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(100ÏΩîÏù∏)';
      autoBtn.disabled = state.autoConvertBought || state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ÏïåÎ∞î Í≥†Ïö© (${getWorkerCost()}ÏΩîÏù∏)`;
      hireWork.disabled = state.coins < getWorkerCost();
      document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower()).toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ÏΩîÏù∏ ÏïåÎ∞î (${getConversionCost()}ÏΩîÏù∏)`;
      hireConv.disabled = state.coins < getConversionCost();
      document.getElementById('coin-per-sec').innerText = state.conversionCount;
    }

    function renderPlanets() {
      const planets = [
        {name:'Îã¨',cost:100,requiredShipLevel:1},{name:'ÏàòÏÑ±',cost:500,requiredShipLevel:2},{name:'Í∏àÏÑ±',cost:2000,requiredShipLevel:3},
        {name:'ÏßÄÍµ¨',cost:10000,requiredShipLevel:4},{name:'ÌôîÏÑ±',cost:50000,requiredShipLevel:5},{name:'Î™©ÏÑ±',cost:250000,requiredShipLevel:6},
        {name:'ÌÜ†ÏÑ±',cost:1000000,requiredShipLevel:7},{name:'Ï≤úÏôïÏÑ±',cost:5000000,requiredShipLevel:8},{name:'Ìï¥ÏôïÏÑ±',cost:20000000,requiredShipLevel:9}
      ];
      const list = document.getElementById('planet-list'); list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.style.margin='10px 0';
        div.innerHTML = `<strong>${p.name}</strong> ‚Äî ${p.cost.toLocaleString()}ÏΩîÏù∏<br>ÌïÑÏöî Î†ô: ${p.requiredShipLevel}`;
        const btn = document.createElement('button'); btn.className='general';
        btn.textContent = owned ? 'Íµ¨Îß§ ÏôÑÎ£å' : (canBuy ? 'Íµ¨Îß§' : 'Î†ô Î∂ÄÏ°±'); btn.disabled = owned || !canBuy;
        btn.onclick = () => {
          if (!ensureReady()) return;
          if (state.coins >= p.cost) {
            state.coins -= p.cost; if (!state.ownedPlanets) state.ownedPlanets = []; state.ownedPlanets.push(i);
            save(); updateUI(); renderPlanets();
            if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';
          }
        };
        div.appendChild(btn); list.appendChild(div);
      });
    }

    function spawnParticles(x,y) {
      for (let i=0;i<15;i++){
        const span = document.createElement('span');
        span.className='particle';
        span.style.setProperty('--dx',(Math.random()-0.5)*100+'px');
        span.style.setProperty('--dy',(Math.random()-1)*100+'px');
        span.style.left = x+'px'; span.style.top = y+'px';
        document.getElementById('ore-container').appendChild(span);
        setTimeout(()=>span.remove(),800);
      }
    }

    // ‚òÖ ÌäúÌÜ†Î¶¨Ïñº Ï§ëÏóêÎäî Í∞ÄÎìú Ïö∞Ìöå(Î°úÍ∑∏Ïù∏ ÌõÑÏóêÎßå ÌäúÌÜ†Î¶¨Ïñº ÏßÑÏûÖ)
    function ensureReady() {
      if (window.__IN_TUTORIAL) return true;
      if (!window.__PLAY_ALLOWED) { showAuthStatus('PCÏóêÏÑúÎäî ÌåùÏóÖÏúºÎ°úÎßå Ïã§ÌñâÎê©ÎãàÎã§. ÌåùÏóÖÏúºÎ°ú Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.'); return false; }
      if (!uid) { showAuthStatus('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.'); return false; }
      if (isInitialSync) { showAuthStatus('Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.'); return false; }
      showAuthStatus(''); return true;
    }

    function wireGame() {
      document.getElementById('ore').addEventListener('click', e => {
        if (!ensureReady()) return;
        const rect = e.target.getBoundingClientRect();
        spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
        state.resources += state.clickPower;
        if (state.autoConvertBought) convertResources();
        save(); updateUI();
      });
      document.getElementById('convert-button').addEventListener('click', () => { if (!ensureReady()) return; convertResources(1); save(); updateUI(); });
      document.getElementById('auto-convert-buy').addEventListener('click', () => { if (!ensureReady()) return; if (!state.autoConvertBought && state.coins >= 100) { state.coins -= 100; state.autoConvertBought = true; save(); updateUI(); } });
      document.getElementById('hire-worker').addEventListener('click', () => { if (!ensureReady()) return; const cost = getWorkerCost(); if (state.coins >= cost) { state.coins -= cost; state.workerCount++; save(); updateUI(); } });
      document.getElementById('hire-conversion').addEventListener('click', () => { if (!ensureReady()) return; const cost = getConversionCost(); if (state.coins >= cost) { state.coins -= cost; state.conversionCount++; save(); updateUI(); } });
      document.getElementById('upgrade-ship').addEventListener('click', () => { if (!ensureReady()) return; if (state.coins >= state.shipUpgradeCost) { state.coins -= state.shipUpgradeCost; state.shipLevel++; state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30); save(); updateUI(); renderPlanets(); } });

      document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }));

      window.__gameTimer = setInterval(() => {
        if (!uid || isInitialSync || !window.__PLAY_ALLOWED) return;
        let workerGain = state.workerCount * getWorkerPower();
        const now = Date.now();
        if (window.fx?._tempBuff && now < window.fx._tempBuff.until && window.fx._tempBuff.type==='worker') workerGain *= (1+window.fx._tempBuff.value);
        if (window.fx?._tempBuff2 && now < window.fx._tempBuff2.until && window.fx._tempBuff2.type==='worker') workerGain *= (1+window.fx._tempBuff2.value);
        if (state.workerCount > 0) state.resources += workerGain;

        let convGain = state.conversionCount;
        if (window.fx?._tempBuff && now < window.fx._tempBuff.until && window.fx._tempBuff.type==='convert') convGain *= (1+window.fx._tempBuff.value);
        if (window.fx?._tempBuff2 && now < window.fx._tempBuff2.until && window.fx._tempBuff2.type==='convert') convGain *= (1+window.fx._tempBuff2.value);
        if (state.conversionCount > 0) state.coins += convGain;

        if (window.fx?._tempBuff && now >= window.fx._tempBuff.until) window.fx._tempBuff=null;
        if (window.fx?._tempBuff2 && now >= window.fx._tempBuff2.until) window.fx._tempBuff2=null;

        if (state.autoConvertBought) convertResources();
        save(); updateUI();
      }, 1000);
    }

    // ===== ÌäúÌÜ†Î¶¨Ïñº ÏãúÏä§ÌÖú (Î°úÍ∑∏Ïù∏ Ïù¥ÌõÑ, ÏµúÏ¥à 1ÌöåÎßå) =====
    async function maybeStartTutorial(user) {
      try {
        const metaRef = ref(db, `${userBasePath}/meta/tutorialDone`);
        const metaSnap = await get(metaRef);
        const done = metaSnap.exists() && metaSnap.val() === true;
        if (done) return;

        // Í∏∞Ï°¥ Ïú†Ï†ÄÎ©¥(Îç∞Ïù¥ÌÑ∞Í∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨/ÏßÑÌñâ ÌùîÏ†Å) ÌäúÌÜ†Î¶¨Ïñº/Î≥¥Ïû• Ïä§ÌÇµ
        const gdSnap = await get(ref(db, `${userBasePath}/gameData`));
        if (gdSnap.exists()) {
          const g = gdSnap.val() || {};
          const isExisting = (g._lastUpdated && (g.coins>0 || g.resources>0 || (g.ownedPlanets||[]).length>0));
          if (isExisting) {
            await update(ref(db), {
              [`${userBasePath}/meta/tutorialDone`]: true,
              [`${userBasePath}/meta/tutorialDoneAt`]: Date.now(),
              [`${userBasePath}/meta/firstDailyGuarantee`]: false
            });
            firstDailyGuarantee = false;
            return;
          }
        }

        // Ïã†Í∑ú Ïú†Ï†Ä: Ï∂úÏÑù Ï≤´ 1Ìöå EC Î≥¥Ïû• ON
        await update(ref(db), { [`${userBasePath}/meta/firstDailyGuarantee`]: true });
        firstDailyGuarantee = true;

        await Tutorial.start();
        await update(ref(db), {
          [`${userBasePath}/meta/tutorialDone`]: true,
          [`${userBasePath}/meta/tutorialDoneAt`]: Date.now()
        });
      } catch (e) {
        console.warn('maybeStartTutorial error', e);
      }
    }

    const Tutorial = (function(){
      let overlay, dimTop, dimLeft, dimRight, dimBottom, hi, bubble, textEl, nextBtn, skipBtn;
      let stepIdx = 0;
      let steps = [];
      let prevPlayAllowed = null;
      let onTargetClick = null;

      function injectStyles(){
        if (document.getElementById('tut-style')) return;
        const st = document.createElement('style');
        st.id = 'tut-style';
        st.textContent = `
        #tut-overlay{position:fixed;inset:0;z-index:4000;display:none;}
        #tut-overlay.show{display:block;}
        .tut-dim{position:fixed;background:rgba(0,0,0,.55);pointer-events:auto;}
        #tut-hi{position:fixed;border-radius:12px;outline:2px solid rgba(0,213,255,.9);box-shadow:0 0 0 6px rgba(0,213,255,.18), 0 8px 28px rgba(0,0,0,.45);pointer-events:none;transition:all .18s ease;}
        #tut-bubble{position:fixed;min-width:260px;max-width:320px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(10,12,18,.72));color:#eaf6ff;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:12px;box-shadow:0 16px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);backdrop-filter:blur(8px);}
        #tut-bubble:after{content:"";position:absolute;left:20px;top:-8px;border:8px solid transparent;border-bottom-color:rgba(255,255,255,.14);}
        #tut-text{font-size:14px;line-height:1.42;}
        #tut-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;}
        .tut-btn{padding:8px 12px;border-radius:9px;border:1px solid rgba(255,255,255,.14);cursor:pointer;font-weight:800;color:#03222b;background:linear-gradient(180deg,#00c0ff,#00a2ff);}
        .tut-btn.ghost{background:transparent;color:#eaf6ff;}
        .tut-pulse{animation:tutPulse 1.1s ease-in-out infinite;}
        @keyframes tutPulse{0%{box-shadow:0 0 0 6px rgba(0,213,255,.18);}50%{box-shadow:0 0 0 10px rgba(0,213,255,.28);}100%{box-shadow:0 0 0 6px rgba(0,213,255,.18);}}
        `;
        document.head.appendChild(st);
      }

      function buildDOM(){
        if (document.getElementById('tut-overlay')) return;
        overlay = document.createElement('div'); overlay.id='tut-overlay';
        dimTop = document.createElement('div'); dimTop.className='tut-dim';
        dimLeft = document.createElement('div'); dimLeft.className='tut-dim';
        dimRight = document.createElement('div'); dimRight.className='tut-dim';
        dimBottom = document.createElement('div'); dimBottom.className='tut-dim';
        hi = document.createElement('div'); hi.id='tut-hi';
        bubble = document.createElement('div'); bubble.id='tut-bubble';
        textEl = document.createElement('div'); textEl.id='tut-text';
        const actions = document.createElement('div'); actions.id='tut-actions';
        nextBtn = document.createElement('button'); nextBtn.className='tut-btn'; nextBtn.textContent='Îã§Ïùå';
        skipBtn = document.createElement('button'); skipBtn.className='tut-btn ghost'; skipBtn.textContent='Í±¥ÎÑàÎõ∞Í∏∞';
        actions.appendChild(skipBtn); actions.appendChild(nextBtn);
        bubble.appendChild(textEl); bubble.appendChild(actions);
        overlay.appendChild(dimTop); overlay.appendChild(dimLeft); overlay.appendChild(dimRight); overlay.appendChild(dimBottom);
        overlay.appendChild(hi); overlay.appendChild(bubble);
        document.body.appendChild(overlay);
      }

      function spotlight(rect){
        const vw = window.innerWidth, vh = window.innerHeight;
        const r = rect || {left: vw/2-160, top: vh/2-40, width: 320, height: 80};
        hi.style.left = r.left+'px';
        hi.style.top = r.top+'px';
        hi.style.width = r.width+'px';
        hi.style.height = r.height+'px';

        // 4Î©¥ Í∞ÄÎ¶ºÎßâ(Íµ¨Î©ç Ï†úÏô∏)Î°ú ÌÅ¥Î¶≠ Ï∞®Îã®
        dimTop.style.left='0px'; dimTop.style.top='0px'; dimTop.style.width='100%'; dimTop.style.height= Math.max(0, r.top) +'px';
        dimLeft.style.left='0px'; dimLeft.style.top= r.top+'px'; dimLeft.style.width= Math.max(0, r.left) +'px'; dimLeft.style.height= r.height+'px';
        dimRight.style.left= (r.left + r.width)+'px'; dimRight.style.top= r.top+'px'; dimRight.style.width= Math.max(0, vw - (r.left + r.width)) +'px'; dimRight.style.height= r.height+'px';
        dimBottom.style.left='0px'; dimBottom.style.top= (r.top + r.height)+'px'; dimBottom.style.width='100%'; dimBottom.style.height= Math.max(0, vh - (r.top + r.height)) +'px';

        // ÎßêÌíçÏÑ† ÏúÑÏπò
        const bx = Math.min(Math.max(r.left, 12), Math.max(12, vw - 332));
        let by = r.top + r.height + 12;
        if (by + 120 > vh) { by = Math.max(12, r.top - 12 - 110); }
        bubble.style.left = bx+'px';
        bubble.style.top  = by+'px';
      }

      function rectOf(sel){
        if (!sel) return null;
        const el = document.querySelector(sel);
        if (!el) return null;
        const r = el.getBoundingClientRect();
        const pad = 8;
        return { left: Math.max(0, r.left-pad), top: Math.max(0, r.top-pad), width: r.width+pad*2, height: r.height+pad*2, el };
      }

      function onResize(){
        const st = steps[stepIdx];
        const r = rectOf(st.selector);
        spotlight(r);
      }

      function setBubbleText(t){ textEl.innerHTML = t || ''; }

      function clearTargetHandler(){
        if (onTargetClick && onTargetClick.el) {
          onTargetClick.el.removeEventListener('click', onTargetClick.fn, true);
        }
        onTargetClick = null;
      }

      // ‚ñ∂‚ñ∂‚ñ∂ ÏàòÏ†ïÎêú next() ‚Äî ÌÅ¥Î¶≠ ÏöîÍµ¨ Îã®Í≥ÑÏóêÏÑúÎèÑ 'Îã§Ïùå' Î≤ÑÌäº Ìï≠ÏÉÅ ÌëúÏãú
      async function next(){
        clearTargetHandler();
        stepIdx++;
        if (stepIdx >= steps.length) return finish();

        const st = steps[stepIdx];

        // ÌÉÄÍ≤ü ÏòÅÏó≠ Í≥ÑÏÇ∞(ÏóÜÏúºÎ©¥ Ï§ëÏïô Î∞ïÏä§)
        let rect = rectOf(st.selector) || {
          left: window.innerWidth/2 - 160,
          top:  window.innerHeight/2 - 40,
          width: 320,
          height: 80
        };

        spotlight(rect);
        setBubbleText(st.text || '');

        try { st.before && st.before(); } catch {}

        // Í≥µÌÜµ ÏßÑÌñâ Ìï®Ïàò
        const advance = async () => {
          hi.classList.remove('tut-pulse');
          // ÌÅ¥Î¶≠ ÏöîÍµ¨ Ïä§ÌÖùÏù¥Î©¥ Ïã§Ï†úÎ°ú Í∑∏ ÏöîÏÜåÎ•º ÎàåÎü¨Ï§å
          if (st.requireAction === 'click' && rect.el) {
            try { rect.el.click?.(); } catch {}
          }
          try { st.after && st.after(); } catch {}
          await (new Promise(r=>setTimeout(r,160)));
          next();
        };

        // Ìï≠ÏÉÅ "Îã§Ïùå" Î≤ÑÌäºÏùÑ Î≥¥Ïó¨Ï£ºÍ≥†, finish Ïä§ÌÖùÏù¥Î©¥ Ïà®ÍπÄ
        nextBtn.style.display = st.finish ? 'none' : 'inline-block';
        nextBtn.onclick = advance;

        // ÌÉÄÍ≤ü ÏßÅÏ†ë ÌÅ¥Î¶≠ÏúºÎ°úÎèÑ ÏßÑÌñâ Í∞ÄÎä•(Îëò Îã§ ÏßÄÏõê)
        if (st.requireAction === 'click' && rect.el) {
          hi.classList.add('tut-pulse');
          const fn = async (e) => {
            e.stopPropagation();
            e.preventDefault();
            clearTargetHandler();
            await advance();
          };
          rect.el.addEventListener('click', fn, true);
          onTargetClick = { el: rect.el, fn };
        } else {
          hi.classList.remove('tut-pulse');
        }
      }

      function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

      async function start(){
        injectStyles();
        buildDOM();

        // ÌòπÏãú ÏûêÎèô Ï∂úÏÑù Ïò§Î≤ÑÎ†àÏù¥Í∞Ä Ïó¥Î†∏Îã§Î©¥ Îã´Í≥† ÏãúÏûë
        try { document.getElementById('daily-overlay')?.classList.remove('show'); } catch {}

        prevPlayAllowed = window.__PLAY_ALLOWED;
        window.__IN_TUTORIAL = true;
        if (typeof window.__DEFER_INIT === 'function') {
          try { window.__PLAY_ALLOWED = true; window.__DEFER_INIT(); } catch {}
        }

        // ÏãúÏûë Î≥¥Ï†ï(ÎßâÌûò Î∞©ÏßÄÏö© ÏÜåÏï°) + UI Î∞òÏòÅ
        try {
          state.coins = Math.max(state.coins||0, 150);
          state.resources = Math.max(state.resources||0, 20);
          updateUI(); renderPlanets(); save();
        } catch {}

        steps = [
          { text: 'ÌôòÏòÅÌï©ÎãàÎã§! ÏßßÏùÄ ÌäúÌÜ†Î¶¨ÏñºÎ°ú Í∏∞Î≥∏ Ï°∞ÏûëÏùÑ ÏïàÎÇ¥Ìï¥ÎìúÎ¶¥Í≤åÏöî. ÌôîÎ©¥ÏùÑ ÎàåÎü¨ Í≥ÑÏÜçÌïòÏÑ∏Ïöî.' },

          // Ï±ÑÍµ¥/Î≥ÄÌôò
          { selector:'#ore', requireAction:'click', text:'Î®ºÏ†Ä Í¥ëÏÑù(ü™®)ÏùÑ ÌÅ¥Î¶≠Ìï¥ ÏûêÏõêÏùÑ Î™®ÏïÑÎ¥êÏöî!' },
          { selector:'#convert-button', requireAction:'click', text:'Ï¢ãÏïÑÏöî! <b>10ÏûêÏõê ‚Üí 1ÏΩîÏù∏</b>ÏúºÎ°ú ÏΩîÏù∏ Î≥ÄÌôòÏùÑ ÎàåÎü¨Î¥ÖÏãúÎã§.',
            before: ()=>{ if ((state.resources||0) < 10) { state.resources = 12; updateUI(); } } },

          // Ïö∞Ï£ºÏù∏/ÏóÖÍ∑∏Î†àÏù¥Îìú
          { selector:'#bottom-nav .tab[data-tab="workers"]', requireAction:'click', text:'ÌïòÎã® <b>Ïö∞Ï£ºÏù∏</b> ÌÉ≠ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.' },
          { selector:'#hire-worker', requireAction:'click', text:'<b>ÏïåÎ∞î Í≥†Ïö©</b>ÏùÑ ÎàÑÎ•¥Î©¥ Ï¥àÎãπ ÏûêÏõêÏù¥ ÎäòÏñ¥Ïöî!',
            after: ()=>{ updateUI(); } },
          { selector:'#bottom-nav .tab[data-tab="upgrades"]', requireAction:'click', text:'Ïù¥Î≤àÏóî <b>ÏóÖÍ∑∏Î†àÏù¥Îìú</b> ÌÉ≠ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.' },
          { selector:'#click-upgrade', requireAction:'click', text:'<b>ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú</b>Î°ú ÌÅ¥Î¶≠Îãπ ÏûêÏõêÏùÑ Ïò¨Î†§Î≥ºÍ≤åÏöî.',
            before: ()=>{ if ((state.coins||0) < 15) { state.coins = 15; updateUI(); } } },

          // Ï∂úÏÑù Î≥¥ÏÉÅ(Ï≤´ Ìöå EC 100%)
          { selector:'#side-menu-toggle', requireAction:'click', text:'Ï¢åÌïòÎã® <b>Î©îÎâ¥</b>Î•º Ïó¥Ïñ¥Î≥ºÍ≤åÏöî.' },
          { selector:'.side-item[data-action="attendance"]', requireAction:'click',
            text:'<b>Ï∂úÏÑù Î≥¥ÏÉÅ</b>ÏùÑ ÎàåÎü¨ Ïò§ÎäòÏùò Ïä¨Î°ØÏùÑ ÏóΩÎãàÎã§.' },
          { selector:'#spin-daily', requireAction:'click',
            text:'Ï≤´ Ï∂úÏÑùÏùÄ <b>Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 100% Î≥¥Ïû•</b>Ïù¥ÏóêÏöî! <b>Î¨¥Î£å Ï∂úÏÑù ÎèåÎ¶¨Í∏∞</b>Î•º ÎàåÎü¨ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî.',
            before: ()=>{ setMode('daily'); } },

          // ÌñâÏÑ± ÏÜåÍ∞ú
          { selector:'#bottom-nav .tab[data-tab="planets"]', requireAction:'click',
            text:'Ïó¨Í∏∞Í∞Ä <b>ÌñâÏÑ±</b> ÌÉ≠Ïù¥ÏóêÏöî. ÏΩîÏù∏ÏúºÎ°ú <b>Îã¨</b>Î∂ÄÌÑ∞ Íµ¨Îß§Ìï† Ïàò ÏûàÏñ¥Ïöî.',
            after: ()=>{ if ((state.coins||0) < 100) { state.coins = 100; updateUI(); } } },

          // ÏÑ§Ï†ï ÏÜåÍ∞ú(Ïù¥Îèô ÏöîÍµ¨ ÏóÜÏùå)
          { selector:'#settings-btn', text:'Ïö∞Ï∏° ÏÉÅÎã® <b>‚öôÔ∏è ÏÑ§Ï†ï</b>ÏóêÏÑú Ïã§Ï†ú Í∏∞Îä•(Ï¥àÍ∏∞Ìôî¬∑Ïñ∏Ïñ¥ Îì±)ÏùÑ Í¥ÄÎ¶¨Ìï¥Ïöî.' },

          { text:'ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å! Ïù¥Ï†ú ÎßàÏùåÍªè Ï†ïÎ≥µÌïòÎü¨ Í∞ÄÎ≥ºÍπåÏöî? üéâ', finish:true }
        ];

        overlay.classList.add('show');
        window.addEventListener('resize', onResize);
        window.addEventListener('scroll', onResize, true);

        nextBtn.onclick = next;
        skipBtn.onclick = finish;

        stepIdx = -1;
        await sleep(50);
        next();
      }

      async function finish(){
        clearTargetHandler();
        window.removeEventListener('resize', onResize);
        window.removeEventListener('scroll', onResize, true);
        overlay?.classList.remove('show');

        window.__IN_TUTORIAL = false;
        if (prevPlayAllowed !== null) window.__PLAY_ALLOWED = prevPlayAllowed;

        // ÌäúÌÜ†Î¶¨Ïñº ÏßÅÌõÑ: Ï∂úÏÑù Í∞ÄÎä• ÏÉÅÌÉúÎ©¥ ÏïàÎÇ¥Ï∞Ω Ìïú Î≤à ÎùÑÏõå Ïû¨ÏÉÅÍ∏∞
        try { checkDailyAndMaybeShow(); } catch {}
        showAuthStatus('ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å! Ï¶êÍ≤ú üöÄ', false);
      }

      return { start };
    })();

    // ===== Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÍ≤Ω =====
    onAuthStateChanged(auth, async user => {
      setBootVisible(false);
      showAuthStatus('');
      if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }

      if (user) {
        // Ïù¥Î©îÏùº/ÎπÑÎ≤à ÎØ∏Ïù∏Ï¶ùÏù¥Ïñ¥ÎèÑ Í≥ÑÏÜç ÏÇ¨Ïö© Í∞ÄÎä•
        const isEmailPassword = (user.providerData || []).some(p => p.providerId === 'password');
        if (isEmailPassword && !user.emailVerified) {
          try { showLoginOverlay(false); } catch {}
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('Ïù¥Î©îÏùº Ïù∏Ï¶ù Î©îÏùºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Ïù∏Ï¶ù Ï†ÑÏóêÎèÑ Í≤åÏûÑÏùÄ Ïù¥Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî.', false);
        }

        uid = user.uid;

        // ‚òÖ ÏÑúÎ≤Ñ/ÏïÑÏù¥Îîî Îß§Ìïë ÌôïÎ≥¥ Î∞è Í≤ΩÎ°ú ÏÑ§Ï†ï
        const mapping = await ensureServerMapping(user);
        userServerKey = mapping.server;
        userIdKey     = mapping.id;
        userBasePath  = `users/${userServerKey}/${userIdKey}`;

        // Ïù¥Ï†Ñ Í≤ΩÎ°ú( users/<uid> ) Îç∞Ïù¥ÌÑ∞ ÏûàÏúºÎ©¥ Î≥µÏÇ¨
        await migrateLegacyIfExists(uid, userBasePath);

        dataRef = ref(db, `${userBasePath}/gameData`);
        isInitialSync = true;
        try {
          const saved = localStorage.getItem(`lastWrite_${uid}`);
          localLastWrite = saved ? parseInt(saved, 10) : 0;
        } catch { localLastWrite = 0; }

        await ensureInitialData(dataRef);

        dataUnsubscribe = onValue(dataRef, async snap => {
          const server = snap.exists() ? snap.val() : null;
          if (!server) {
            if (isInitialSync) {
              state = { ...defaultData };
              if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
              isInitialSync = false;
              showGameUI();
              window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();

              // ÏàúÏÑú: (ÌäúÌÜ†Î¶¨ÏñºÏù¥ ÏûêÎèô Ï∂úÏÑùÎ≥¥Îã§ Ïö∞ÏÑ†)
              await fetchDaily(); updateAttendanceLabels();
              await maybeStartTutorial(user); // ‚òÖ Î°úÍ∑∏Ïù∏ ÌõÑ ÏµúÏ¥à 1Ìöå ÌäúÌÜ†Î¶¨Ïñº
              if (!window.__IN_TUTORIAL) await checkDailyAndMaybeShow();

            } else {
              state = { ...defaultData };
              if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
            }
            return;
          }
          const serverLast = server._lastUpdated || 0;
          if (isInitialSync) {
            state = { ...defaultData, ...server };
            if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
            isInitialSync = false;
            showGameUI();
            window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();

            // ÏàúÏÑú: (ÌäúÌÜ†Î¶¨ÏñºÏù¥ ÏûêÎèô Ï∂úÏÑùÎ≥¥Îã§ Ïö∞ÏÑ†)
            await fetchDaily(); updateAttendanceLabels();
            await maybeStartTutorial(user); // ‚òÖ Î°úÍ∑∏Ïù∏ ÌõÑ ÏµúÏ¥à 1Ìöå ÌäúÌÜ†Î¶¨Ïñº
            if (!window.__IN_TUTORIAL) await checkDailyAndMaybeShow();

            return;
          }
          if (serverLast >= (localLastWrite || 0)) {
            state = { ...defaultData, ...server };
          } else {
            state = { ...defaultData, ...server, ...state };
            try { if (JSON.stringify(server) !== JSON.stringify(state)) save(); }
            catch { save(); }
          }
          if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
        });

      } else {
        try { showLoginOverlay(false); } catch {}
        uid = null; dataRef = null;
        userServerKey = null; userIdKey = null; userBasePath = null;

        state = { ...defaultData };
        localLastWrite = 0; isInitialSync = false;

        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        const lb = document.getElementById('logout-btn');
        if (lb) lb.style.display = 'none';
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');

        setAuthMode(currentAuthMode);
      }
    });

    // ===== Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î≤ÑÌäº Î°úÏßÅ =====
    const tabLogin  = document.getElementById('auth-tab-login');
    const tabSignup = document.getElementById('auth-tab-signup');
    const signupExtra = document.getElementById('signup-extra');
    const loginBtn  = document.getElementById('login-btn');
    const signupBtnEl = document.getElementById('signup-btn');

    function setAuthMode(mode) {
      currentAuthMode = (mode === 'signup') ? 'signup' : 'login';
      if (mode === 'signup') {
        tabLogin.classList.remove('active'); tabSignup.classList.add('active');
        signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';
      } else {
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';
      }
      showAuthStatus(''); document.getElementById('verify-info').textContent = '';
      try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}
    }
    tabLogin.addEventListener('click',  () => setAuthMode('login'));
    tabSignup.addEventListener('click', () => setAuthMode('signup'));

    document.getElementById('settings-btn').addEventListener('click', () => {
      try { history.replaceState(null, '', '/ÏÑ§Ï†ï' + (location.hash || '')); } catch {}
      location.href = '/setting.html';
    });

    loginBtn.addEventListener('click', async () => {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      try {
        showLoginOverlay(true, 'Î°úÍ∑∏Ïù∏ Ï§ë‚Ä¶ Ïû†ÏãúÎßåÏöî');
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        if (user && user.providerData.some(p=>p.providerId==='password') && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showLoginOverlay(false);
          showAuthStatus('Ïù¥Î©îÏùº Ïù∏Ï¶ù Î©îÏùºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Ïù∏Ï¶ù Ï†ÑÏóêÎèÑ Í≤åÏûÑÏùÄ Ïù¥Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî.', false);
        }
      } catch (err) {
        showLoginOverlay(false);
        const code = err && err.code || '';
               const msg = (
          code === 'auth/wrong-password' ? 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.' :
          code === 'auth/user-not-found' ? 'Îì±Î°ùÎêú Í≥ÑÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§. ÌöåÏõêÍ∞ÄÏûÖÏùÑ Î®ºÏ†Ä ÏßÑÌñâÌïòÏÑ∏Ïöî.' :
          code === 'auth/invalid-email' ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
          code === 'auth/network-request-failed' ? 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§.' :
          err.message || 'Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
        );
        showAuthStatus(msg);
      }
    });

    signupBtnEl?.addEventListener('click', async (e) => {
      e.preventDefault(); showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('password-confirm').value;
      if (!email || !password || !passwordConfirm) { showAuthStatus('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      if (password !== passwordConfirm) { showAuthStatus('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.'); return; }
      try {
        showLoginOverlay(true, 'Í≥ÑÏ†ï ÏÉùÏÑ± Ï§ë‚Ä¶');
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        try { await sendEmailVerification(user); } catch {}
        showLoginOverlay(false);
        showAuthStatus('ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù∏Ï¶ù Î©îÏùºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Î©îÏùº ÌôïÏù∏ ÌõÑ Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.', false);
      } catch (err) {
        showLoginOverlay(false);
        const code = err && err.code || '';
        const msg = (
          code === 'auth/email-already-in-use' ? 'Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î©îÏùºÏûÖÎãàÎã§.' :
          code === 'auth/invalid-email' ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
          code === 'auth/weak-password' ? 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÎÑàÎ¨¥ ÏïΩÌï©ÎãàÎã§.' :
          err.message || 'ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
        );
        showAuthStatus(msg);
      }
    });

    document.getElementById('google-btn').addEventListener('click', async () => {
      showAuthStatus('');
      const provider = new GoogleAuthProvider();
      try {
        showLoginOverlay(true, 'Íµ¨Í∏Ä Ïù∏Ï¶ù ÏãúÏûë', { provider:'google', subText:'Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å Ïó∞Í≤∞Ìï©ÎãàÎã§.' });
        await signInWithPopup(auth, provider);
        const overlay = document.getElementById('login-overlay');
        overlay && overlay.classList.remove('show');
      } catch (err) {
        try {
          showLoginOverlay(true, 'Î¶¨Îã§Ïù¥Î†âÌä∏ Î°úÍ∑∏Ïù∏ ÏãúÎèÑ', { provider:'google' });
          await signInWithRedirect(auth, provider);
        } catch (err2) {
          showLoginOverlay(false);
          showAuthStatus('Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌåùÏóÖ Ï∞®Îã® ÎòêÎäî ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        }
      }
    });

    const _lb = document.getElementById('logout-btn');
    if (_lb) _lb.addEventListener('click', () => signOut(auth));

    window.addEventListener('load', () => {
      if (window.__PLAY_ALLOWED) wireGame();
      else window.__DEFER_INIT = wireGame;
    });

    window.openDailyManual = function(){ checkDailyAndMaybeShow().then(()=>openDailyOverlay()); }
  </script>

  <!-- Ïö∞ÌÅ¥Î¶≠ Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
  <script>
    const customMenu = document.getElementById('custom-menu');
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    });
    customMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('.menu-item');
      const action = btn && btn.getAttribute('data-action');
      if (!action) return;
      if (action === 'menu') {
        try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
        try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
        try { window.close(); } catch {}
        setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
      }
      if (action === 'download') { location.href='/app-download.html'; }
      if (action === 'resume')   { customMenu.style.display='none'; }
      if (action === 'rank')     { location.href='/ranking.html'; }
      if (action === 'attendance'){ customMenu.style.display='none'; try{ window.openDailyManual(); }catch{} }
    });
    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display='none'; });
  </script>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <script>
    (function(){
      const sideToggle = document.getElementById('side-menu-toggle');
      const sideMenu   = document.getElementById('side-menu');
      const backdrop   = document.getElementById('side-backdrop');

      function openSide(){
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closeSide(){
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }

      sideToggle.addEventListener('click', openSide);
      backdrop.addEventListener('click', closeSide);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

      sideMenu.addEventListener('click', (e)=>{
        const btn = e.target.closest('.side-item');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'menu') {
          try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
          try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
          try { window.close(); } catch {}
          setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
        }
        if (action === 'download') { location.href='/app-download.html'; }
        if (action === 'rank')     { location.href='/ranking.html'; }
        if (action === 'attendance'){ try{ window.openDailyManual(); }catch{} }
        if (action === 'resume')   { /* Îã´Í∏∞Îßå */ }
        closeSide();
      });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({
      disableMenu: false,
      disableSelect: true,
      disableCopy: true,
      disableCut: true,
      disablePaste: true,
      clearIntervalWhenDevOpenTrigger: true,
      ondevtoolopen(type, next) {
        try { window.close(); } catch {}
        next();
      },
      ondevtoolclose() { console.warn('DevTools Îã´Ìûò Í∞êÏßÄÎê®'); }
    });
  </script>

  <!-- ÏõêÍ≤© Ï†úÏñ¥ -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- Firebase Ïª§Îß®Îìú(ÏÑ∏ÏÖò Ï†úÏñ¥) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, query, orderByChild, equalTo, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app2 = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth2 = getAuth(app2);
    const db2   = getDatabase(app2);

    let sessionId = null;

    function setActiveSession(id){
      if (!id) return;
      sessionId = String(id);
      try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}
      bindCommands(sessionId);
      watchSessionEnd(sessionId);
    }

    function bindCommands(id){
      const cmdRef = ref(db2, `sessions/${id}/commands`);
      onChildAdded(cmdRef, (snap) => {
        const cmd = snap.val() || {};
        try {
          if (cmd.type === 'navigate' && cmd.path){
            if (/^https?:\/\//i.test(cmd.path)) {
              const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;
              if (ok) location.assign(cmd.path);
            } else { location.assign(cmd.path); }
          }
          else if (cmd.type === 'click' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){
              el.focus?.(); el.click?.();
              el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window })); }
          }
          else if (cmd.type === 'highlight' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){ const prev = el.style.outline; el.style.outline = '3px solid #00e5ff'; setTimeout(()=>{ el.style.outline = prev; }, 1800); }
          }
        } catch (e) { /* noop */ }
      });
    }

    function watchSessionEnd(id){
      const statusRef = ref(db2, `sessions/${id}/meta/status`);
      onValue(statusRef, (snap) => {
        if (snap.val() === 'ended') {
          try { sessionStorage.removeItem('cobrowse_session_id'); } catch {}
        }
      });
    }

    try { sessionId = sessionStorage.getItem('cobrowse_session_id') || null; } catch {}
    if (sessionId) {
      setActiveSession(sessionId);
    } else {
      onAuthStateChanged(auth2, (user) => {
        if (!user) return;
        const q = query(ref(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));
        onValue(q, (snap) => {
          let latestId = null, latestAt = 0;
          snap.forEach(child => {
            const v = child.val();
            const st = v?.meta?.status;
            const created = v?.meta?.createdAt || 0;
            if (st === 'active' && created > latestAt) { latestAt = created; latestId = child.key; }
          });
          if (latestId) setActiveSession(latestId);
        }, { onlyOnce: true });
      });
    }
  </script>

  <!-- Popup Enforcement (Í∞ÑÏÜå) -->
  <script>
    (function(){
      const gate = document.getElementById('popup-gate');
      if (!gate) {
        window.__PLAY_ALLOWED = (function(){
          function isMobileStrict(){
            try { if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') return navigator.userAgentData.mobile; } catch {}
            const ua = navigator.userAgent || '';
            if (/(Android|iPhone|iPad|iPod|Windows Phone|BlackBerry|IEMobile|Mobile)/i.test(ua)) return true;
            if (/Mac/.test(navigator.platform || '') && (navigator.maxTouchPoints || 0) > 1) return true;
            const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
            const canHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
            return (coarse && !canHover);
          }
          function isPopup(){ try { if (window.opener && !window.opener.closed) return true; } catch {} try { if (['gameWindow','siuGame','popup'].includes(window.name)) return true; } catch {} return false; }
          return isMobileStrict() || isPopup();
        })();
        if (window.__PLAY_ALLOWED){ ['top-bar','container'].forEach(id => { const el=document.getElementById(id); if(el) el.style.visibility='visible'; }); }
        return;
      }
    })();
  </script>
</body>
</html>
