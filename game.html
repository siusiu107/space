<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</title>
  <!-- í‘œì‹œ ê²½ë¡œ ê³ ì •: /ê²Œì„ (í˜¸ìŠ¤íŠ¸ëŠ” ë³€ê²½ ë¶ˆê°€) -->
  <script>
    (function(){
      try {
        history.replaceState(null, '', '/ê²Œì„' + (location.hash || ''));
      } catch (e) {
        console.warn('ì£¼ì†Œ í‘œì‹œ ë³€ê²½ ì‹¤íŒ¨:', e);
      }
    })();
  </script>
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ (ë³€ê²½ ì—†ìŒ) */
    body { margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    img { display:block; }
    #top-bar, #container { visibility: hidden; }

    /* === ë¡œê·¸ì¸ ì¹´ë“œ ë””ìì¸ ê°œì„  === */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(6,7,12,0.55));
      box-shadow: 0 12px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
    }
    #auth-container.hidden { opacity:0; transform: translate(-50%, -46% ) scale(.98); pointer-events:none; visibility:hidden; }

    #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }
    .auth-row { display:flex; gap:8px; align-items:center; justify-content:center; }
    #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.25); color:#fff; outline:none; font-size:14px; }
    #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.25); }
    #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }
    #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.06); cursor:pointer; }

    /* ì—ëŸ¬ / ìƒíƒœ ë©”ì‹œì§€ */
    .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }
    .auth-status.show { opacity:1; transform:translateY(0); }

    /* ë¡œê¹… ì˜¤ë²„ë ˆì´ */
    .login-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.55), rgba(2,6,12,0.75)); border-radius:14px; z-index:1100; opacity:0; pointer-events:none; transition:opacity .24s ease; }
    .login-overlay.show { opacity:1; pointer-events:auto; }
    .login-card { text-align:center; color:#e6f7ff; }
    .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Google ë²„íŠ¼ (ê¸°ì¡´ ÑÑ‚Ğ¸Ğ»ÑŒ ìœ ì§€í•˜ë˜ ì •ë ¬ ê³ ì¹¨) */
    .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; margin-left:6px; }

    /* ì‘ì€ í™”ë©´ì—ì„œ ì¡°ê¸ˆ ì¡°ì • */
    @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

    /* =============== ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ (ë³€ê²½ ê±°ì˜ ì—†ìŒ) =============== */
    #logout-btn { display:none; position:fixed; bottom:20px; right:10px; background:#f44; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; z-index:1001; }
    #top-bar { position: fixed; top: 5px; left: 5px; right: 5px; display: flex; justify-content: space-between; align-items: center; background: rgba(30,30,30,0.85); padding:6px 10px; border-radius:8px; font-size:12px; z-index:1000; }
    .bar-group { display:flex; align-items:center; }
    .bar-group img { width:16px; height:16px; margin-right:4px; }
    .bar-group span { margin-right:12px; white-space: nowrap; }
    #container { margin:50px auto 20px; width:90%; max-width:640px; padding:20px; background:rgba(30,30,30,0.9); border-radius:10px; text-align:center; }
    h1 { font-size:1.6em; margin-bottom:14px; color:#00d4ff; }
    button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }
    #reset-button { background:rgba(255,92,92,0.9)!important; }
    nav { display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:14px; gap:6px; }
    .tab { flex:1 1 45%; min-width:120px; padding:8px; background:rgba(51,51,51,0.85); border-radius:6px; cursor:pointer; text-align:center; }
    .tab.active { background:#00aaff; }
    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }
    .particle { position:absolute; width:6px; height:6px; background:#ffd700; border-radius:50%; opacity:.8; animation:floatUp .8s ease-out forwards; pointer-events:none; }
    @keyframes floatUp { to { transform: translate(var(--dx),var(--dy)) scale(0); opacity:0; } }
    #ore { width:200px; cursor:pointer; }
    #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.95); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 160px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }

    /* === íŒì—… ì°¨ë‹¨ìš© ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ë³€ê²½ ì—†ìŒ) === */
    #popup-blocker {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.9);
      z-index: 3000; /* custom-menu(2000)ë³´ë‹¤ ìœ„ */
      padding: 20px;
    }
    #popup-blocker.active { display: flex; }
    #popup-blocker .box { max-width: 560px; background: #0b0b0f; border: 1px solid #222; padding: 24px; border-radius: 10px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.7); color: #ddd; }
    #popup-blocker h2 { color: #ffcc00; margin-bottom: 10px; }
    #popup-blocker p { margin-bottom: 16px; line-height: 1.4; color: #bbb; }
    .popup-btn { padding: 10px 14px; border-radius: 8px; border: 0; cursor: pointer; font-weight: 700; margin: 6px; }
    .popup-btn.primary { background: #00aaff; color: #000; }
    .popup-btn.ghost { background: transparent; border: 1px solid #444; color: #fff; }

    /* === (ì¶”ê°€) ì˜¤ë²„ë ˆì´ ë‚´ ì§„í–‰ ê´€ë ¨ ìŠ¤íƒ€ì¼ === */
    .login-overlay { transition:opacity .24s ease, visibility .24s ease; }
    .login-overlay.show { opacity:1; pointer-events:auto; }
    .login-overlay .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #overlay-steps li[data-active="true"] { color:#e6f7ff; font-weight:700; opacity:1 !important; }
  </style>
</head>
<body>
  <!-- ì¸ì¦ -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <h2 id="auth-title">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" autocomplete="username" />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <button id="login-btn" class="primary-btn">ë¡œê·¸ì¸</button>
    <button id="signup-btn" class="ghost-btn">íšŒì›ê°€ì…</button>

    <!-- ===== Google ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€ (ê¶Œì¥) ===== -->
    <button id="google-btn" aria-label="êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° (ê¶Œì¥)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <!-- ì¸ë¼ì¸ Google SVG ì•„ì´ì½˜ (ê²½ëŸ‰) -->
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false">
          <path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/>
          <path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/>
          <path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24c0 3.7 1.1 7.3 3 10.4l7.5-5z"/>
          <path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/>
        </svg>
      </span>
      <span class="g-text">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° <small>(ê¶Œì¥)</small></span>
    </button>
    <!-- ===== ë³€ê²½ ë ===== -->

    <!-- ===== ì•„ì´ë”” ì°¾ê¸° ì‚­ì œ: ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë§í¬ë§Œ ë‚¨ê¹€ ===== -->
    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600; box-shadow: 0 2px 6px rgba(0,0,0,0.4);" aria-label="ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° (find.htmlìœ¼ë¡œ ì´ë™)" title="ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
    </div>
    <!-- ===== ë³€ê²½ ë ===== -->

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>

    <!-- ë¡œê·¸ì¸ ìƒíƒœ ì˜¤ë²„ë ˆì´ (êµì²´ëœ ì „ë¬¸ í‘œì‹œ) -->
    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">
            <!-- provider ì•„ì´ì½˜(ë™ì  ì‚½ì…) -->
          </div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px; color:#e6f7ff;">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘</div>
            <div id="login-overlay-sub" style="font-size:12px; color:#bcd8ee; margin-top:2px;">ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦</div>
          </div>
        </div>

        <div id="overlay-spinner" style="margin:0 auto 12px;">
          <div class="spinner" aria-hidden="true"></div>
        </div>

        <!-- ì§„í–‰ë°” (ì‹œê°ì  í”¼ë“œë°±) -->
        <div style="width:220px; margin:0 auto 10px; background:rgba(255,255,255,0.04); border-radius:8px; padding:6px;">
          <div id="overlay-progress" style="height:8px; width:0%; border-radius:6px; background:linear-gradient(90deg,#00c0ff,#0077ff); transition:width .4s ease;"></div>
        </div>

        <!-- ë‹¨ê³„ í‘œì‹œ -->
        <ol id="overlay-steps" style="list-style:none; padding:0; margin:0; font-size:13px; color:#dbefff; max-width:260px;">
          <li data-step="1" style="opacity:0.9; margin-bottom:6px;">1. ì¸ì¦ì°½ ì—´ê¸°</li>
          <li data-step="2" style="opacity:0.6; margin-bottom:6px;">2. ê¶Œí•œ ìš”ì²­</li>
          <li data-step="3" style="opacity:0.4;">3. ë¡œê·¸ì¸ ì™„ë£Œ</li>
        </ol>

        <div id="login-overlay-detail" style="font-size:12px; color:#9fbfda; margin-top:10px; min-height:20px;">ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>

  <!-- === íŒì—… ì°¨ë‹¨ ì˜¤ë²„ë ˆì´ ì¶”ê°€ (ì—¬ê¸°ë§Œ ìƒˆë¡œ ì¶”ê°€ë¨) === -->
  <div id="popup-blocker" role="alert" aria-live="assertive">
    <div class="box">
      <h2>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2>
      <p>ì´ í˜ì´ì§€ëŠ” íŒì—… ì°½ìœ¼ë¡œ ì—´ë ¤ì•¼ í•©ë‹ˆë‹¤.<br>í˜„ì¬ëŠ” íŒì—…ì´ ì•„ë‹Œ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ë˜ì—ˆê¸° ë•Œë¬¸ì— ê²Œì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <div>
        <button id="reopen-popup" class="popup-btn primary">íŒì—…ìœ¼ë¡œ ì—´ê¸°</button>
        <button id="close-tab" class="popup-btn ghost">ì´ íƒ­ ë‹«ê¸°</button>
      </div>
      <p style="margin-top:12px;color:#9aa6c4;font-size:13px">íŒì—…ì´ ì°¨ë‹¨ë  ê²½ìš° ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>
    </div>
  </div>

  <!-- ìƒë‹¨ ë°” -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ìì›: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ì½”ì¸: 0</span>
    </div>
    <div class="bar-group">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />
      <span id="ship-level">1ë ™ (20ì½”ì¸)</span>
      <button id="upgrade-ship">ì—…ê·¸ë ˆì´ë“œ</button>
    </div>
  </div>

  <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
  <div id="container">
    <h1>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</h1>
    <nav>
      <div class="tab active" data-tab="main">ë©”ì¸</div>
      <div class="tab" data-tab="workers">ìš°ì£¼ì¸ ì•Œë°”</div>
      <div class="tab" data-tab="upgrades">í´ë¦­ë‹¹ ì—…ê·¸ë ˆì´ë“œ</div>
      <div class="tab" data-tab="planets">í–‰ì„± êµ¬ë§¤</div>
      <div class="tab" data-tab="reset">ì´ˆê¸°í™”</div>
    </nav>
    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="ê´‘ì„" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ìì› â†’ 1ì½”ì¸</button>
        <button id="auto-convert-buy" class="general">ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>ì´ ì´ˆë‹¹ ìì›: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ì•Œë°” ê³ ìš© (<span id="worker-cost">0</span>ì½”ì¸)</button>
      <p>ì´ ì´ˆë‹¹ ì½”ì¸: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ì½”ì¸ ì•Œë°” (<span id="conversion-cost">0</span>ì½”ì¸)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>í´ë¦­ë‹¹ ìì›: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (15ì½”ì¸)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <div id="reset-content" class="tab-content">
      <button id="reset-button" class="general">ì´ˆê¸°í™”</button>
    </div>

  </div>

  <!-- ì»¤ìŠ¤í…€ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
  <div id="custom-menu">
    <div class="menu-item" data-action="menu">ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</div>
    <div class="menu-item" data-action="download">â¬‡ï¸ ì•± ë‹¤ìš´ë¡œë“œ</div>
    <div class="menu-item" data-action="resume">â–¶ï¸ ê²Œì„ ê³„ì†í•˜ê¸°</div>
    <div class="menu-item" data-action="rank">ğŸ† ë­í‚¹ ë³´ê¸°</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null; // **ì¶”ê°€: onValue êµ¬ë… í•´ì œ í•¨ìˆ˜ ë³´ê´€**
    let localLastWrite = 0; // ë¡œì»¬ì—ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ê¸°ë¡í•œ íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)
    const defaultData = { resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20, workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[] };
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const clickUpgradeCost=15;

    function getWorkerCost() { return Math.floor(initialWorkerCost * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower() { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost() { return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

    function convertResources(maxCount = null) {
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count > 0) {
        state.resources -= count * 10;
        state.coins += count;
      }
    }

    // ì•ˆì „ ì´ˆê¸°í™”: ê±°ë˜(íŠ¸ëœì­ì…˜)ë¡œ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ê°’ ë„£ê¸° (ê²½í•© ë°©ì§€)
    async function ensureInitialData(refPath) {
      try {
        await runTransaction(refPath, current => {
          if (current === null) {
            return { ...defaultData, _lastUpdated: Date.now() };
          }
          return current; // ì´ë¯¸ ìˆìœ¼ë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ
        });
      } catch (err) {
        console.error('ì´ˆê¸°í™” íŠ¸ëœì­ì…˜ ì—ëŸ¬:', err);
      }
    }

    // save: update() ì‚¬ìš©. ì „ì²´ë¥¼ ë®ì–´ì“°ê¸°ë³´ë‹¤ ë³‘í•©í˜• ì—…ë°ì´íŠ¸ë¡œ ë‹¤ë¥¸ í•„ë“œ ì†ì‹¤ ë°©ì§€.
    function save() {
      if (!uid || !dataRef) return;
      // ì‹œê°„ ê¸°ë¡
      const now = Date.now();
      state._lastUpdated = now;
      // **ê³„ì •ë³„ localLastWrite ì €ì¥**
      localLastWrite = now;
      try {
        localStorage.setItem(`lastWrite_${uid}`, String(now));
      } catch (e) { /* localStorage ì‹¤íŒ¨ ë¬´ì‹œ */ }

      // ë³µì œí•´ì„œ ë³´ë‚¼ ê°ì²´ ìƒì„± (ìˆ¨ê²¨ì§„ í•„ë“œë„ ì „ì†¡)
      const toSave = { ...state };
      // updateëŠ” ë³‘í•©ì´ë¼ ì•ˆì „í•¨.
      update(dataRef, toSave).catch(err => console.error('ì €ì¥ ì—ëŸ¬:', err));
    }

    // ===== ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘ =====
    function friendlyAuthError(err) {
      if (!err || !err.code) return 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      const code = err.code || '';
      switch (code) {
        case 'auth/wrong-password': return 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.';
        case 'auth/user-not-found': return 'ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íšŒì›ê°€ì…í•´ ì£¼ì„¸ìš”.';
        case 'auth/email-already-in-use': return 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
        case 'auth/invalid-email': return 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        case 'auth/weak-password': return 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.';
        case 'auth/popup-blocked': return 'íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë°©ë²•ì„ ì‹œë„í•˜ì„¸ìš”.';
        case 'auth/popup-closed-by-user': return 'íŒì—… ì°½ì„ ë‹«ì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        case 'auth/network-request-failed': return 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
        default: return err.message || 'ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }
    }

    // ===== UI í—¬í¼ =====
    const authContainer = document.getElementById('auth-container');
    const authErrorEl = document.getElementById('auth-error');
    const loginOverlay = document.getElementById('login-overlay');

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg;
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      if (isError) {
        authErrorEl.style.color = '#ffdede';
      } else {
        authErrorEl.style.color = '#dfffe8';
      }
    }

    // === (êµì²´ëœ) ì „ë¬¸ì ì¸ ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ í‘œì‹œ í•¨ìˆ˜ ===
    function showLoginOverlay(show, text = 'ë¡œê·¸ì¸ ì¤‘â€¦', opts = {}) {
      const overlay = document.getElementById('login-overlay');
      const title = document.getElementById('login-overlay-title');
      const sub = document.getElementById('login-overlay-sub');
      const detail = document.getElementById('login-overlay-detail');
      const progress = document.getElementById('overlay-progress');
      const provIcon = document.getElementById('overlay-provider-icon');
      const steps = Array.from(document.querySelectorAll('#overlay-steps li'));

      if (!overlay) return;
      if (text) title.textContent = text;
      sub.textContent = opts.subText || 'ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦';
      detail.textContent = opts.detail || 'ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒì—…ì´ ì°¨ë‹¨ë˜ë©´ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';

      provIcon.innerHTML = ''; // ì´ˆê¸°í™”
      if (opts.provider === 'google') {
        provIcon.innerHTML = `
          <svg width="28" height="28" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
            <path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/>
            <path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/>
            <path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24c0 3.7 1.1 7.3 3 10.4l7.5-5z"/>
            <path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/>
          </svg>`;
        if (!text) title.textContent = 'êµ¬ê¸€ë¡œ ë¡œê·¸ì¸ ì¤‘â€¦';
        sub.textContent = 'êµ¬ê¸€ ì¸ì¦ì°½ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.';
      } else {
        provIcon.textContent = 'ğŸ”’';
        if (!text) title.textContent = 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘â€¦';
        sub.textContent = opts.subText || 'ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦';
      }

      steps.forEach((li) => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
      const activateStep = (n) => {
        steps.forEach((li, idx) => {
          if (idx < n) { li.setAttribute('data-active','true'); li.style.opacity = 1; }
          else { li.removeAttribute('data-active'); li.style.opacity = 0.6; }
        });
      };

      if (show) {
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        activateStep(1); progress.style.width = '24%';
        overlay._progressTimer && clearTimeout(overlay._progressTimer);
        overlay._progressTimer = setTimeout(() => {
          activateStep(2); progress.style.width = '64%';
        }, 800);
        overlay._progressTimer2 && clearTimeout(overlay._progressTimer2);
        overlay._progressTimer2 = setTimeout(() => {
          progress.style.width = '84%';
        }, 1700);
      } else {
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        progress.style.width = '0%';
        steps.forEach(li => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
        overlay._progressTimer && clearTimeout(overlay._progressTimer);
        overlay._progressTimer2 && clearTimeout(overlay._progressTimer2);
      }

      overlay.success = (msg) => {
        title.textContent = msg || 'ë¡œê·¸ì¸ ì™„ë£Œ';
        detail.textContent = 'ì•ˆì „í•˜ê²Œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
        activateStep(3); progress.style.width = '100%';
        setTimeout(() => { showLoginOverlay(false); }, 900);
      };
      overlay.fail = (msg) => {
        title.textContent = msg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        detail.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        progress.style.width = '6%';
        overlay.style.boxShadow = '0 6px 20px rgba(255,0,0,0.12)';
        setTimeout(() => { overlay.style.boxShadow = ''; showLoginOverlay(false); }, 1400);
      };
    }

    // ë¡œê·¸ì¸ ìƒíƒœì—ì„œ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì „í™˜ ì²˜ë¦¬ (auth-containerëŠ” ì§ì ‘ ìˆ¨ê¸°ì§€ ë§ê³  í´ë˜ìŠ¤ ì‚¬ìš©)
    onAuthStateChanged(auth, async user => {
      showAuthStatus('');
      // **êµ¬ë… í•´ì œ: ìƒˆë¡œìš´ ê³„ì •ìœ¼ë¡œ ì „í™˜í•˜ê¸° ì „ì— ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°**
      if (dataUnsubscribe) {
        try { dataUnsubscribe(); } catch (e) { /* ë¬´ì‹œ */ }
        dataUnsubscribe = null;
      }

      if (user) {
        uid = user.uid;
        dataRef = ref(db, `users/${uid}/gameData`);

        // ë¡œê·¸ì¸ ì‹œ, ê³„ì •ë³„ë¡œ ì €ì¥ëœ localLastWrite ë¶ˆëŸ¬ì˜¤ê¸° (ì•ˆì •ì„± í–¥ìƒ)
        try {
          const saved = localStorage.getItem(`lastWrite_${uid}`);
          localLastWrite = saved ? parseInt(saved, 10) : 0;
        } catch (e) { localLastWrite = 0; }

        // ë¶€ë“œëŸ¬ìš´ ì „í™˜: overlayê°€ ë³´ì´ë©´ ìˆ¨ê¸°ê³ , ì¹´ë“œ ì¶•ì†Œ í›„ ìˆ¨ê¹€
        showLoginOverlay(false);
        authContainer.classList.add('hidden');
        setTimeout(() => {
          authContainer.style.display = 'none';
          document.getElementById('logout-btn').style.display = 'block';
          ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'visible');
        }, 340);

        // ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™” (ê²½í•© ì—†ë„ë¡ transaction ì‚¬ìš©)
        await ensureInitialData(dataRef);

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ: ì„œë²„ì˜ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„(_lastUpdated)ì„ ê¸°ì¤€ìœ¼ë¡œ ë¡œì»¬ ë®ì–´ì“°ê¸° ì œì–´
        dataUnsubscribe = onValue(dataRef, snap => {
          const server = snap.exists() ? snap.val() : null;
          if (!server) {
            state = { ...defaultData };
            updateUI(); renderPlanets();
            return;
          }
          const serverLast = server._lastUpdated || 0;
          // ì„œë²„ê°€ ìµœì‹ ì´ê±°ë‚˜ ê°™ìœ¼ë©´ ì„œë²„ë¥¼ ì‹ ë¢°
          if (serverLast >= (localLastWrite || 0)) {
            state = { ...defaultData, ...server };
          } else {
            // ë¡œì»¬ì´ ìµœì‹ : ë¡œì»¬ì„ ì„œë²„ì— ë‹¤ì‹œ ì“´ë‹¤(ì¶©ëŒí•´ê²°)
            state = { ...defaultData, ...server, ...state };
            save(); // save()ê°€ localLastWriteì™€ ì„œë²„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
          }
          updateUI(); renderPlanets();
        });

      } else {
        uid = null; dataRef = null;
        // **ì¶”ê°€: ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œì»¬ ìƒíƒœ ë° íƒ€ì„ìŠ¤íƒ¬í”„ ì´ˆê¸°í™”í•˜ì—¬ ì´ì „ ê³„ì • ë°ì´í„°ê°€ ë‚¨ì§€ ì•Šë„ë¡ í•¨**
        state = { ...defaultData };
        localLastWrite = 0;
        try { /* ì„ íƒì ìœ¼ë¡œ ê³„ì •ë³„ lastWrite ì œê±°í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ:
          localStorage.removeItem(`lastWrite_${uid}`);
        */ } catch (e) { /* ë¬´ì‹œ */ }

        authContainer.style.display = 'block';
        // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì²œì²œíˆ ë‚˜íƒ€ë‚´ê¸°
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        document.getElementById('logout-btn').style.display = 'none';
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
      }
    });

    // ê¸°ì¡´ ë¡œê·¸ì¸/íšŒì›ê°€ì… ì´ë²¤íŠ¸ì— ìƒíƒœ UI ì—°ê²° (íŒì—…/ë¦¬ë‹¤ì´ë ‰íŠ¸ í´ë°± í¬í•¨)
    document.getElementById('login-btn').addEventListener('click', async () => {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        showLoginOverlay(true, 'ë¡œê·¸ì¸ ì¤‘â€¦ ì ì‹œë§Œìš”');
        await signInWithEmailAndPassword(auth, email, password);
        // ì„±ê³µí•˜ë©´ onAuthStateChangedì—ì„œ ì²˜ë¦¬
      } catch (err) {
        console.warn(err);
        showLoginOverlay(false);
        showAuthStatus(friendlyAuthError(err));
      }
    });

    document.getElementById('signup-btn').addEventListener('click', async (e) => {
      e.preventDefault(); showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        showLoginOverlay(true, 'ê³„ì • ìƒì„± ì¤‘â€¦');
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.warn(err);
        showLoginOverlay(false);
        showAuthStatus(friendlyAuthError(err));
      }
    });

    // === (êµì²´ëœ) êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í•¸ë“¤ëŸ¬: overlayì— provider ì •ë³´ ì „ë‹¬ ===
    const googleBtn = document.getElementById('google-btn');
    if (googleBtn) {
      googleBtn.addEventListener('click', async () => {
        showAuthStatus('');
        const provider = new GoogleAuthProvider();
        try {
          // ì „ë¬¸ì  í‘œì‹œ: provider='google' ì „ë‹¬, ì„¸ë¶€ë¬¸êµ¬ ì„¤ì •
          showLoginOverlay(true, 'êµ¬ê¸€ ì¸ì¦ ì‹œì‘', { provider: 'google', subText: 'êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì—°ê²°í•©ë‹ˆë‹¤.', detail: 'êµ¬ê¸€ íŒì—…ì´ ì—´ë¦¬ë©´ ê³„ì •ì„ ì„ íƒí•˜ê³  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.' });
          await signInWithPopup(auth, provider);
          // ì„±ê³µ ì‹œ onAuthStateChangedì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ, onAuthStateChangedì—ì„œ overlay.successë¥¼ í˜¸ì¶œí•˜ë„ë¡ í•˜ê±°ë‚˜,
          // ì—¬ê¸°ì„œ ê°„ë‹¨íˆ success ì½œì„ ì‹œë„ (onAuthStateChangedê°€ ë°œìƒí•˜ê¸° ì „ì—)
          const overlay = document.getElementById('login-overlay');
          overlay && overlay.success && overlay.success('ë¡œê·¸ì¸ ì™„ë£Œ â€” í™˜ì˜í•©ë‹ˆë‹¤');
        } catch (err) {
          console.warn('signInWithPopup ì‹¤íŒ¨, signInWithRedirectë¡œ í´ë°±:', err);
          try {
            // í´ë°±: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì „ ìƒíƒœ ì—…ë°ì´íŠ¸
            showLoginOverlay(true, 'ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ ì¤‘', { provider: 'google', subText: 'ë¸Œë¼ìš°ì € ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.' });
            await signInWithRedirect(auth, provider);
          } catch (err2) {
            // ì˜¤ë¥˜ ì²˜ë¦¬: ì „ë¬¸ì  ì‹¤íŒ¨ ë¬¸êµ¬ í‘œì‹œ
            showLoginOverlay(false);
            showAuthStatus(friendlyAuthError(err2));
          }
        }
      });
    }

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    function updateUI() {
      document.getElementById('score').innerText = `ìì›: ${Math.floor(state.resources)}`;
      document.getElementById('coins').innerText = `ì½”ì¸: ${Math.floor(state.coins)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}ë ™ (${state.shipUpgradeCost}ì½”ì¸)`;
      document.getElementById('ship-img').src = `/images/ship-level${state.shipLevel}.png`;
      document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

      const clickUp = document.getElementById('click-upgrade');
      clickUp.innerText = `í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (${clickUpgradeCost}ì½”ì¸)`;
      clickUp.disabled = state.coins < clickUpgradeCost;
      document.getElementById('click-power').innerText = state.clickPower;

      const autoBtn = document.getElementById('auto-convert-buy');
      autoBtn.innerHTML = state.autoConvertBought ? 'êµ¬ë§¤ ì™„ë£Œ' : 'ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)';
      autoBtn.disabled = state.autoConvertBought || state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ì•Œë°” ê³ ìš© (${getWorkerCost()}ì½”ì¸)`;
      hireWork.disabled = state.coins < getWorkerCost();
      document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower()).toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ì½”ì¸ ì•Œë°” (${getConversionCost()}ì½”ì¸)`;
      hireConv.disabled = state.coins < getConversionCost();
      document.getElementById('coin-per-sec').innerText = state.conversionCount;
    }

    function renderPlanets() {
      const planets = [ {name:'ë‹¬',cost:100,requiredShipLevel:1}, {name:'ìˆ˜ì„±',cost:500,requiredShipLevel:2}, {name:'ê¸ˆì„±',cost:2000,requiredShipLevel:3}, {name:'ì§€êµ¬',cost:10000,requiredShipLevel:4}, {name:'í™”ì„±',cost:50000,requiredShipLevel:5}, {name:'ëª©ì„±',cost:250000,requiredShipLevel:6}, {name:'í† ì„±',cost:1000000,requiredShipLevel:7}, {name:'ì²œì™•ì„±',cost:5000000,requiredShipLevel:8}, {name:'í•´ì™•ì„±',cost:20000000,requiredShipLevel:9} ];
      const list = document.getElementById('planet-list'); list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.innerHTML = `<strong>${p.name}</strong> â€” ${p.cost.toLocaleString()}ì½”ì¸<br>í•„ìš” ë ™: ${p.requiredShipLevel}`;
        const btn = document.createElement('button'); btn.className = 'general'; btn.textContent = owned ? 'êµ¬ë§¤ ì™„ë£Œ' : (canBuy ? 'êµ¬ë§¤' : 'ë ™ ë¶€ì¡±'); btn.disabled = owned || !canBuy;
        btn.onclick = () => { if (state.coins >= p.cost) { state.coins -= p.cost; if (!state.ownedPlanets) state.ownedPlanets = []; state.ownedPlanets.push(i); save(); updateUI(); renderPlanets(); if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html'; } };
        div.appendChild(btn); list.appendChild(div);
      });
    }

    function spawnParticles(x,y) { for (let i=0;i<15;i++){ const span = document.createElement('span'); span.className='particle'; span.style.setProperty('--dx',(Math.random()-0.5)*100+'px'); span.style.setProperty('--dy',(Math.random()-1)*100+'px'); span.style.left = x+'px'; span.style.top = y+'px'; document.getElementById('ore-container').appendChild(span); setTimeout(()=>span.remove(),800); } }

    window.onload = () => {
      document.getElementById('ore').addEventListener('click', e => { const rect = e.target.getBoundingClientRect(); spawnParticles(e.clientX - rect.left, e.clientY - rect.top); state.resources += state.clickPower; if (state.autoConvertBought) convertResources(); save(); updateUI(); });
      document.getElementById('convert-button').addEventListener('click', () => { convertResources(1); save(); updateUI(); });
      document.getElementById('auto-convert-buy').addEventListener('click', () => { if (!state.autoConvertBought && state.coins >= 100) { state.coins -= 100; state.autoConvertBought = true; save(); updateUI(); } });
      document.getElementById('hire-worker').addEventListener('click', () => { const cost = getWorkerCost(); if (state.coins >= cost) { state.coins -= cost; state.workerCount++; save(); updateUI(); } });
      document.getElementById('hire-conversion').addEventListener('click', () => { const cost = getConversionCost(); if (state.coins >= cost) { state.coins -= cost; state.conversionCount++; save(); updateUI(); } });
      document.getElementById('upgrade-ship').addEventListener('click', () => { if (state.coins >= state.shipUpgradeCost) { state.coins -= state.shipUpgradeCost; state.shipLevel++; state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30); save(); updateUI(); renderPlanets(); } });
      document.getElementById('click-upgrade').addEventListener('click', () => { if (state.coins >= clickUpgradeCost) { state.coins -= clickUpgradeCost; state.clickPower++; save(); updateUI(); } });
      document.getElementById('reset-button').addEventListener('click', () => { if (confirm('ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { state = { ...defaultData }; save(); updateUI(); renderPlanets(); } });
      document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tab.dataset.tab}-content`).classList.add('active'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); }));

      // ê¸°ì¡´ setIntervalì„ ì•ˆì „í•˜ê²Œ ë³€ê²½: **ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ìˆì„ ë•Œë§Œ ë™ì‘**
      setInterval(() => {
        if (!uid) return; // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ë™ì‘í•˜ì§€ ì•ŠìŒ (ì¤‘ìš”)
        if (state.workerCount > 0) state.resources += state.workerCount * getWorkerPower();
        if (state.conversionCount > 0) state.coins += state.conversionCount;
        if (state.autoConvertBought) convertResources();
        save();
        updateUI();
      }, 1000);
    };
  </script>

  <!-- === íŒì—… ê²€ì‚¬ / ë³µêµ¬ / í‚¤ ì°¨ë‹¨ (ê°•í™”ëœ ë²„ì „) === -->
  <script>
    (function() {
      const EXPECTED_POPUP_NAME = 'gameWindow';
      const BLOCKER_ID = 'popup-blocker';
      let blocker = document.getElementById(BLOCKER_ID);
      let blockerTemplate = blocker ? blocker.cloneNode(true) : null;
      let allowUnload = false;
      function allowTemporaryUnload(ms = 1000) { allowUnload = true; setTimeout(() => { allowUnload = false; }, ms); }
      window.addEventListener('beforeunload', (e) => { if (allowUnload) return; e.preventDefault(); e.returnValue = ''; return ''; });
      function isOpenedAsPopup() {
        try { if (window.opener && !window.opener.closed) { try { if (window.opener.location && window.opener.location.origin === location.origin) return true; } catch (e) { return true; } } } catch (e) {}
        if (window.name === EXPECTED_POPUP_NAME) return true;
        if (location.search.includes('popup=1') || location.hash.includes('popup=1')) return true;
        try { if (window.outerWidth && window.outerHeight) { const smallWidth = screen.width - 100; const smallHeight = screen.height - 100; if (window.outerWidth <= smallWidth || window.outerHeight <= smallHeight) return true; } } catch (e) {}
        try { if (window.self !== window.top) return false; } catch (e) {}
        return false;
      }
      function showBlocker() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) { if (blockerTemplate) { document.body.appendChild(blockerTemplate.cloneNode(true)); } else { const div = document.createElement('div'); div.id = BLOCKER_ID; div.setAttribute('role','alert'); div.className = ' active'; div.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:3000;padding:20px;'; div.innerHTML = '<div class="box" style="max-width:560px;background:#0b0b0f;border:1px solid #222;padding:24px;border-radius:10px;color:#ddd;text-align:center;"><h2 style="color:#ffcc00;margin-bottom:10px">ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</h2><p style="margin-bottom:16px;color:#bbb">ì´ í˜ì´ì§€ëŠ” íŒì—… ì°½ìœ¼ë¡œ ì—´ë ¤ì•¼ í•©ë‹ˆë‹¤.<br>í˜„ì¬ëŠ” íŒì—…ì´ ì•„ë‹Œ ë°©ì‹ìœ¼ë¡œ ì ‘ê·¼ë˜ì—ˆê¸° ë•Œë¬¸ì— ê²Œì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><div><button id="reopen-popup" class="popup-btn primary" style="padding:10px 14px;border-radius:8px;border:0;margin:6px;font-weight:700">íŒì—…ìœ¼ë¡œ ì—´ê¸°</button><button id="close-tab" class="popup-btn ghost" style="padding:10px 14px;border-radius:8px;border:1px solid #444;margin:6px;background:transparent;color:#fff">ì´ íƒ­ ë‹«ê¸°</button></div><p style="margin-top:12px;color:#9aa6c4;font-size:13px">íŒì—…ì´ ì°¨ë‹¨ë  ê²½ìš° ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p></div>'; document.body.appendChild(div); } blocker = document.getElementById(BLOCKER_ID); bindBlockerButtons(); } blocker.classList.add('active'); blocker.style.display = 'flex'; blocker.style.pointerEvents = 'auto'; blocker.style.zIndex = '999999'; } catch (e) { console.error('showBlocker error', e); } }
      function hideBlocker() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) return; blocker.classList.remove('active'); blocker.style.display = 'none'; } catch (e) {} }
      function tryOpenPopupFromThisTab() { const w = 1024, h = 768; const left = Math.max(0, Math.round((screen.width - w) / 2)); const top  = Math.max(0, Math.round((screen.height - h) / 2)); const opts = `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no`; const popup = window.open(window.location.href + (location.search ? '&' : '?') + 'popup=1', EXPECTED_POPUP_NAME, opts); if (!popup) { alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ íŒì—… í—ˆìš© ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.'); return; } try { popup.focus(); } catch(e) {} setTimeout(()=>{ try{ allowTemporaryUnload(1500); window.close(); } catch(e){} }, 300); }
      function bindBlockerButtons() { try { blocker = document.getElementById(BLOCKER_ID); if (!blocker) return; const reopenBtn = blocker.querySelector('#reopen-popup'); const closeBtn = blocker.querySelector('#close-tab'); if (reopenBtn) { reopenBtn.addEventListener('click', tryOpenPopupFromThisTab); } if (closeBtn) { closeBtn.addEventListener('click', function(){ try{ allowTemporaryUnload(1500); window.close(); } catch(e){} }); } } catch (e) {} }
      function setupMutationProtection() { blocker = document.getElementById(BLOCKER_ID); if (blocker && !blockerTemplate) blockerTemplate = blocker.cloneNode(true); const watchTargets = ['auth-container','top-bar','container', BLOCKER_ID]; const body = document.body; const observer = new MutationObserver((mutations) => { try { let shouldRestoreBlocker = false; for (const m of mutations) { if (m.type === 'childList') { for (const n of m.removedNodes) { if (n && n.id === BLOCKER_ID) shouldRestoreBlocker = true; } const b = document.getElementById(BLOCKER_ID); if (!b) shouldRestoreBlocker = true; } if (m.type === 'attributes' && (m.target && (m.target.id === BLOCKER_ID || watchTargets.includes(m.target.id)))) { const t = m.target; const style = window.getComputedStyle(t); if (!isOpenedAsPopup() && (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity || '1') < 0.1)) { shouldRestoreBlocker = true; } } } if (!isOpenedAsPopup()) { const b = document.getElementById(BLOCKER_ID); if (!b) shouldRestoreBlocker = true; else { const cs = window.getComputedStyle(b); if (cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity || '1') < 0.1) shouldRestoreBlocker = true; } } if (shouldRestoreBlocker) { showBlocker(); bindBlockerButtons(); } } catch (e) { console.error('mutation observer error', e); } }); observer.observe(body, { childList:true, subtree:true, attributes:true, attributeFilter:['style','class'], attributeOldValue:true }); setInterval(() => { try { if (!isOpenedAsPopup()) { const b = document.getElementById(BLOCKER_ID); if (!b) { showBlocker(); bindBlockerButtons(); return; } const cs = window.getComputedStyle(b); if (cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity || '1') < 0.1) { showBlocker(); bindBlockerButtons(); return; } const z = parseInt((b.style.zIndex || '0').replace(/[^0-9]/g,'')) || 0; if (z < 99999) { b.style.zIndex = '999999'; } } else { const b = document.getElementById(BLOCKER_ID); if (b) { hideBlocker(); } } } catch (e) {} }, 600); }
      document.addEventListener('DOMContentLoaded', () => { blocker = document.getElementById(BLOCKER_ID); if (blocker && !blockerTemplate) blockerTemplate = blocker.cloneNode(true); if (!isOpenedAsPopup()) { showBlocker(); } else { hideBlocker(); console.log('íŒì—…ìœ¼ë¡œ ì—´ë¦¼ â€” ê²Œì„ ì‹¤í–‰ í—ˆìš© (íŒì—… ê²€ì‚¬ í†µê³¼)'); } bindBlockerButtons(); setupMutationProtection(); });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({ disableMenu: true, disableSelect: true, disableCopy: true, disableCut: true, disablePaste: true, clearIntervalWhenDevOpenTrigger: true, ondevtoolopen(type, next) { window.close(); next(); }, ondevtoolclose() { console.warn('DevTools ë‹«í˜ ê°ì§€ë¨'); } });

    // === ìˆ˜ì •ëœ ë¶€ë¶„: customMenu í´ë¦­ í•¸ë“¤ëŸ¬(ë‹¤ë¥¸ ê±´ ê±´ë“¤ì´ì§€ ì•ŠìŒ) ===
    const customMenu = document.getElementById('custom-menu');

    // ìš°í´ë¦­ ì‹œ ë©”ë‰´ í‘œì‹œ
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    });

    // í´ë¦­ í•¸ë“¤ëŸ¬: 'ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°'ì—ì„œ ì°½ì„ ë‹«ë„ë¡ ì‹œë„
    customMenu.addEventListener('click', async (e) => {
      const target = e.target;
      const action = target.getAttribute('data-action');
      if (!action) return;

      if (action === 'menu') {
        // 1) ë¶€ëª¨ì°½ì´ ìˆìœ¼ë©´ í¬ì»¤ìŠ¤ ì‹œë„
        try {
          if (window.opener && !window.opener.closed) {
            try { window.opener.focus(); } catch (err) { /* ë¬´ì‹œ */ }
          }
        } catch (err) { /* ë¬´ì‹œ */ }

        // 2) ë¶€ëª¨ì—ê²Œ postMessageë¡œ ë‹«ì•„ë‹¬ë¼ê³  ìš”ì²­ (ê°€ëŠ¥í•˜ë©´)
        try {
          window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*');
        } catch (err) { /* ë¬´ì‹œ */ }

        // 3) ì°½ ë‹«ê¸° ì‹œë„
        try { window.close(); } catch (err) { /* ë¸Œë¼ìš°ì €ê°€ í—ˆìš©í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ */ }

        // 4) ë‹«íˆì§€ ì•Šìœ¼ë©´ í´ë°±ìœ¼ë¡œ /index.htmlë¡œ ì´ë™
        setTimeout(() => {
          try {
            if (!window.closed) {
              window.location.href = '/index.html';
            }
          } catch (err) {
            try { window.open('/index.html', '_self'); } catch (e) { /* ë¬´ì‹œ */ }
          }
        }, 250);
        return;
      }

      // === ìƒˆë¡œ ì¶”ê°€: ì•± ë‹¤ìš´ë¡œë“œ í•­ëª© ì²˜ë¦¬ ===
      if (action === 'download') {
        try {
          // ì¦‰ì‹œ ì´ë™
          window.location.href = '/app-download.html';
        } catch (err) {
          try { window.open('/app-download.html', '_self'); } catch (e) { /* ë¬´ì‹œ */ }
        }
        return;
      }

      if (action === 'resume') {
        customMenu.style.display = 'none';
        return;
      }
      if (action === 'rank') {
        window.location.href = '/ranking.html';
        return;
      }
    });

    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display = 'none'; });
  </script>
  <script>
    // ìš°í´ë¦­ ì „ì²´ ì°¨ë‹¨í•˜ë˜ input / textarea / contenteditable ìš”ì†ŒëŠ” ì˜ˆì™¸ë¡œ ë‘ 
    document.addEventListener('contextmenu', function (e) {
      if (e.target.closest('input, textarea, [contenteditable="true"]')) return;
      e.preventDefault();
    });
  </script>
</body>
</html>
