<!-- ====================== game.html ====================== -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>🌌 태양계 정복: 우주 생존 클릭커 🌌</title>

<style>
  :root{
    --glass: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(10,12,20,0.65));
    --stroke: rgba(255,255,255,0.12);
    --fg: #eaf6ff; --muted:#bcd8ee; --accent:#00c0ff; --accent2:#0099ff; --danger:#ff6b6b;
    --bg:#0b1220;
  }
  *{box-sizing:border-box}
  body{margin:0;background:url('/images/space-bg.jpg') center/cover no-repeat fixed, var(--bg);color:var(--fg);font:14px/1.6 Inter,system-ui,Arial}
  img{display:block}
  #top-bar{position:fixed;top:6px;left:6px;right:6px;display:flex;flex-wrap:wrap;gap:6px 8px;
           align-items:center;justify-content:space-between;background:rgba(30,34,48,.85);
           border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;z-index:1000}
  #container{margin:56px auto 20px;width:92%;max-width:680px;padding:16px 20px;background:rgba(20,24,36,.9);border-radius:12px}
  h1{font-size:1.35rem;margin:6px 0 14px;color:#00d4ff}
  button.general{width:calc(100% - 32px);max-width:320px;padding:10px;margin:6px auto;font-size:13px;
                 background:url('/images/button-bg.png') center/contain no-repeat;border:none;border-radius:8px;color:#fff;cursor:pointer}
  button.general:disabled{opacity:.5;cursor:not-allowed}
  .tab-content{display:none;margin-top:12px}.tab-content.active{display:block}
  #bottom-nav{position:fixed;left:50%;bottom:max(12px, env(safe-area-inset-bottom, 12px));
              transform:translateX(-50%);display:flex;gap:8px;padding:8px;background:rgba(10,12,20,.7);
              backdrop-filter:blur(10px);border:1px solid var(--stroke);border-radius:16px;z-index:1200}
  #bottom-nav .tab{display:inline-flex;align-items:center;gap:6px;min-width:72px;padding:10px 12px;border-radius:12px;
                   background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);
                   color:#d7e8ff;font-weight:800;cursor:pointer}
  #bottom-nav .tab.active{color:#06222b;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 6px 18px rgba(0,160,255,.28)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #logout-btn{display:none;position:fixed;top:52px;right:8px;background:#f44;color:#fff;border:none;padding:8px 12px;border-radius:8px;z-index:1400}

  /* ===== 원격지원 패널 ===== */
  #rs-toggle{position:fixed;right:8px;bottom:calc(72px + env(safe-area-inset-bottom,0));z-index:1500;
             width:48px;height:48px;border-radius:14px;border:1px solid var(--stroke);background:linear-gradient(180deg,var(--accent),var(--accent2));color:#00131a;font-weight:900;cursor:pointer}
  #rs-panel{position:fixed;right:8px;bottom:calc(130px + env(safe-area-inset-bottom,0));
            width:min(360px,92vw);max-height:72vh;overflow:hidden;display:none;flex-direction:column;
            background:var(--glass);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.5);z-index:1500}
  #rs-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);font-size:.85em}
  .ok{color:#3bd18e}.wait{color:#60a5fa}.end{color:#f87171}
  #rs-body{display:grid;grid-template-rows:auto auto 1fr auto auto;gap:8px;padding:10px}
  .rs-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rs-chat{min-height:150px;max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px}
  .bubble{max-width:85%;padding:8px 10px;margin:6px 0;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16)}
  .me{margin-left:auto;background:rgba(0,208,255,.16);border-color:rgba(0,208,255,.4)}
  .sys{font-size:.9em;opacity:.95}
  .rs-input{display:flex;gap:8px}
  .rs-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#fff}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#00121a;font-weight:800}
  .btn.secondary{background:transparent;color:var(--fg)}
  .btn.danger{background:linear-gradient(180deg,#ff6b6b,#d74);color:#fff}
  .note{font-size:.85em;color:#9ed0ff}

  /* ===== 사용자 측 미니 미러(관리자 조작 미리보기) ===== */
  #rs-mini-wrap{display:none}
  #rs-mini-toggle{margin-left:auto}
  #rs-mini{position:fixed;right:10px;bottom:calc(190px + env(safe-area-inset-bottom,0));width:220px;height:124px;z-index:1499;
           border:1px solid rgba(255,255,255,.14);border-radius:12px;background:#000;box-shadow:0 12px 28px rgba(0,0,0,.45)}
  /* 클릭 리플 */
  .rip{position:fixed;width:10px;height:10px;border:2px solid #00d4ff;border-radius:999px;pointer-events:none;opacity:.9;transform:translate(-50%,-50%);animation:rip .6s ease-out forwards}
  @keyframes rip{to{opacity:0;transform:translate(-50%,-50%) scale(6)}}

  @media (max-width:420px){
    #container{width:94%;padding:14px}
    #bottom-nav .tab{min-width:0;padding:10px 8px}
    h1{font-size:1.15rem}
    #rs-mini{width:180px;height:102px;right:8px;bottom:calc(200px + env(safe-area-inset-bottom,0))}
  }
</style>
</head>
<body>
  <!-- 상단 바 -->
  <div id="top-bar">
    <div class="row">
      <img src="/images/resource-icon.png" alt="Resource" style="width:16px;height:16px"/>
      <span id="score">자원: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" style="width:16px;height:16px"/>
      <span id="coins">코인: 0</span>
    </div>
    <div class="row">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" style="width:16px;height:16px"/>
      <span id="ship-level">1렙 (20코인)</span>
      <button id="upgrade-ship" class="btn secondary">업그레이드</button>
      <button id="settings-btn" class="btn secondary" aria-label="설정으로 이동">⚙️ 설정</button>
    </div>
  </div>

  <button id="logout-btn">로그아웃</button>

  <!-- 메인 -->
  <div id="container">
    <h1>🌌 태양계 정복: 우주 생존 클릭커 🌌</h1>

    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative;display:inline-block">
        <img src="/images/ore.png" id="ore" alt="광석" style="width:200px;cursor:pointer"/>
      </div>
      <div class="row" style="justify-content:center;gap:8px;align-items:center;margin-top:10px">
        <button id="convert-button" class="general">10자원 → 1코인</button>
        <button id="auto-convert-buy" class="general">자동변환 구매<br/>(100코인)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>총 초당 자원: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">알바 고용 (<span id="worker-cost">0</span>코인)</button>
      <p>총 초당 코인: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">코인 알바 (<span id="conversion-cost">0</span>코인)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>클릭당 자원: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">클릭 업그레이드 (15코인)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <!-- 바텀 내비 -->
    <nav id="bottom-nav" aria-label="게임 탭 내비게이션">
      <div class="tab active" data-tab="main"><span>🪨</span><span>메인</span></div>
      <div class="tab" data-tab="workers"><span>👩‍🚀</span><span>우주인</span></div>
      <div class="tab" data-tab="upgrades"><span>⚙️</span><span>업그레이드</span></div>
      <div class="tab" data-tab="planets"><span>🪐</span><span>행성</span></div>
    </nav>
  </div>

  <!-- 원격지원 토글 & 패널 -->
  <button id="rs-toggle" title="원격지원">RS</button>
  <section id="rs-panel" aria-label="원격지원 패널">
    <div id="rs-head">
      <strong>원격지원</strong>
      <div class="row">
        <span id="rs-badge" class="badge wait">상태: 대기</span>
        <button id="rs-close" class="btn secondary">닫기</button>
      </div>
    </div>
    <div id="rs-body">
      <div class="rs-row" style="justify-content:space-between">
        <div class="rs-row">
          <label class="rs-row"><input type="checkbox" id="rs-allow-nav" style="transform:scale(1.1)"/> 네비게이션 허용</label>
          <label class="rs-row"><input type="checkbox" id="rs-allow-adv" style="transform:scale(1.1)"/> 고급제어(클릭/스크롤) 허용</label>
        </div>
        <div class="rs-row" id="rs-mini-wrap">
          <button id="rs-mini-toggle" class="btn secondary" title="관리자 조작 미리보기 토글">미니 미러</button>
        </div>
      </div>
      <div class="rs-row">
        <button id="rs-request" class="btn">원격지원 요청</button>
        <button id="rs-end" class="btn danger" style="display:none">종료</button>
        <span class="note">요청 후 관리자가 수락하면 화면공유 동의창이 열립니다.</span>
      </div>
      <div id="rs-chat" class="rs-chat" aria-live="polite"></div>
      <div class="rs-input">
        <input id="rs-input" placeholder="메시지를 입력…" />
        <button id="rs-send" class="btn secondary">전송</button>
      </div>
      <div class="note">※ 비밀번호/ID 입력란은 관리자에게 비공개 처리되며 클릭/입력이 차단됩니다.</div>
    </div>
  </section>

  <!-- 사용자 측 미니 미러 iframe -->
  <iframe id="rs-mini" title="관리자 조작 미리보기" aria-hidden="true" style="display:none"></iframe>

<script type="module">
/* ================= Firebase / 공통 설정 ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getDatabase, ref, onValue, runTransaction, update, set, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
  authDomain: "siu-studio.firebaseapp.com",
  databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "siu-studio",
  storageBucket: "siu-studio.appspot.com",
  messagingSenderId: "830887143444",
  appId: "1:830887143444:web:70b45fc12140e893c31f01",
  measurementId: "G-1Y090YJDB6"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

/* ================= 게임 로직 (원본 유지) ================= */
let state = {};
let uid = null;
let dataRef = null;
let isInitialSync=false;
let localLastWrite=0;

const defaultData = { resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20, workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[] };
const initialWorkerCost=10, workerCostGrowth=1.2;
const initialWorkerPower=1, workerPowerGrowth=1.05;
const initialConversionCost=50, conversionCostGrowth=1.3;
const clickUpgradeCost=15;

const scoreEl = document.getElementById('score');
const coinsEl = document.getElementById('coins');
const shipLevelEl = document.getElementById('ship-level');
const shipImgEl = document.getElementById('ship-img');
const upgradeBtn = document.getElementById('upgrade-ship');

function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

function convertResources(maxCount = null) {
  const possible = Math.floor(state.resources / 10);
  const count = maxCount === null ? possible : Math.min(possible, maxCount);
  if (count > 0) { state.resources -= count * 10; state.coins += count; }
}

function save(){
  if(!uid || !dataRef || isInitialSync) return;
  const now=Date.now(); state._lastUpdated=now; localLastWrite=now;
  update(dataRef, {...state}).catch(()=>{});
  try{ localStorage.setItem(`lastWrite_${uid}`, String(now)); }catch{}
}
function updateUI(){
  scoreEl.textContent = `자원: ${Math.floor(state.resources)}`;
  coinsEl.textContent = `코인: ${Math.floor(state.coins)}`;
  shipLevelEl.textContent = `${state.shipLevel}렙 (${state.shipUpgradeCost}코인)`;
  shipImgEl.src = `/images/ship-level${state.shipLevel}.png`;
  upgradeBtn.disabled = state.coins < state.shipUpgradeCost;

  const clickUp = document.getElementById('click-upgrade');
  clickUp.textContent = `클릭 업그레이드 (${clickUpgradeCost}코인)`;
  clickUp.disabled = state.coins < clickUpgradeCost;
  document.getElementById('click-power').textContent = state.clickPower;

  const autoBtn = document.getElementById('auto-convert-buy');
  autoBtn.innerHTML = state.autoConvertBought ? '구매 완료' : '자동변환 구매<br/>(100코인)';
  autoBtn.disabled = state.autoConvertBought || state.coins < 100;

  document.getElementById('convert-button').disabled = state.resources < 10;

  const hireWork = document.getElementById('hire-worker');
  hireWork.textContent = `알바 고용 (${getWorkerCost()}코인)`;
  hireWork.disabled = state.coins < getWorkerCost();
  document.getElementById('resource-per-sec').textContent = (state.workerCount * getWorkerPower()).toFixed(1);

  const hireConv = document.getElementById('hire-conversion');
  hireConv.textContent = `코인 알바 (${getConversionCost()}코인)`;
  hireConv.disabled = state.coins < getConversionCost();
  document.getElementById('coin-per-sec').textContent = state.conversionCount;
}
function renderPlanets(){
  const planets = [
    {name:'달',cost:100,requiredShipLevel:1},{name:'수성',cost:500,requiredShipLevel:2},{name:'금성',cost:2000,requiredShipLevel:3},
    {name:'지구',cost:10000,requiredShipLevel:4},{name:'화성',cost:50000,requiredShipLevel:5},{name:'목성',cost:250000,requiredShipLevel:6},
    {name:'토성',cost:1000000,requiredShipLevel:7},{name:'천왕성',cost:5000000,requiredShipLevel:8},{name:'해왕성',cost:20000000,requiredShipLevel:9}
  ];
  const list = document.getElementById('planet-list'); list.innerHTML='';
  planets.forEach((p, i) => {
    const div = document.createElement('div');
    const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
    const canBuy = state.shipLevel >= p.requiredShipLevel;
    div.style.margin='10px 0';
    div.innerHTML = `<strong>${p.name}</strong> — ${p.cost.toLocaleString()}코인<br/>필요 렙: ${p.requiredShipLevel}`;
    const btn = document.createElement('button'); btn.className='general';
    btn.textContent = owned ? '구매 완료' : (canBuy ? '구매' : '렙 부족'); btn.disabled = owned || !canBuy;
    btn.onclick = () => {
      if (!uid) return;
      if (state.coins >= p.cost) {
        state.coins -= p.cost; if (!state.ownedPlanets) state.ownedPlanets = []; state.ownedPlanets.push(i);
        save(); updateUI(); renderPlanets();
        if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';
      }
    };
    div.appendChild(btn); list.appendChild(div);
  });
}

document.getElementById('settings-btn').onclick = ()=> location.href='/setting.html';
document.getElementById('upgrade-ship').onclick = ()=>{ if(!uid) return; if(state.coins>=state.shipUpgradeCost){ state.coins-=state.shipUpgradeCost; state.shipLevel++; state.shipUpgradeCost=Math.floor(state.shipUpgradeCost*2+30); save(); updateUI(); renderPlanets(); } };
document.getElementById('click-upgrade').onclick = ()=>{ if(!uid) return; if(state.coins>=clickUpgradeCost){ state.coins-=clickUpgradeCost; state.clickPower++; save(); updateUI(); } };
document.getElementById('convert-button').onclick = ()=>{ if(!uid) return; convertResources(1); save(); updateUI(); };
document.getElementById('auto-convert-buy').onclick = ()=>{ if(!uid) return; if(!state.autoConvertBought && state.coins>=100){ state.coins-=100; state.autoConvertBought=true; save(); updateUI(); } };
document.getElementById('hire-worker').onclick = ()=>{ if(!uid) return; const c=getWorkerCost(); if(state.coins>=c){ state.coins-=c; state.workerCount++; save(); updateUI(); } };
document.getElementById('hire-conversion').onclick = ()=>{ if(!uid) return; const c=getConversionCost(); if(state.coins>=c){ state.coins-=c; state.conversionCount++; save(); updateUI(); } };
document.getElementById('ore').addEventListener('click', e=>{ if(!uid) return; state.resources += state.clickPower; if(state.autoConvertBought) convertResources(); save(); updateUI(); });

document.querySelectorAll('#bottom-nav .tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
    document.querySelectorAll('#bottom-nav .tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
  });
});

onAuthStateChanged(auth, async user=>{
  if(user){
    if(!user.emailVerified){ try{ await sendEmailVerification(user);}catch{}; await signOut(auth); return; }
    uid=user.uid;
    const path = ref(db, `users/${uid}/gameData`);
    dataRef = path;
    isInitialSync = true;
    try{
      const saved = localStorage.getItem(`lastWrite_${uid}`); localLastWrite = saved?parseInt(saved,10):0;
    }catch{ localLastWrite = 0; }
    await runTransaction(path, current => current===null ? {...defaultData,_lastUpdated:Date.now()} : current);
    onValue(path, snap=>{
      const server=snap.exists()?snap.val():null;
      if(!server){
        state={...defaultData}; updateUI(); renderPlanets(); isInitialSync=false;
        return;
      }
      if(isInitialSync){ state={...defaultData,...server}; updateUI(); renderPlanets(); isInitialSync=false; return; }
      const serverLast=server._lastUpdated||0;
      state = (serverLast >= (localLastWrite||0)) ? {...defaultData,...server} : {...defaultData, ...server, ...state};
      updateUI(); renderPlanets();
    });
    document.getElementById('logout-btn').style.display='block';
  }else{
    uid=null; dataRef=null; state={...defaultData}; updateUI(); renderPlanets();
    document.getElementById('logout-btn').style.display='none';
  }
});
document.getElementById('logout-btn').onclick = ()=> signOut(auth);

setInterval(()=>{ if(!uid || isInitialSync) return; if(state.workerCount>0) state.resources += state.workerCount * getWorkerPower(); if(state.conversionCount>0) state.coins += state.conversionCount; if(state.autoConvertBought) convertResources(); save(); updateUI(); }, 1000);

/* ================= 원격지원(사용자측) + 미니 미러 ================= */
const rsToggle = document.getElementById('rs-toggle');
const rsPanel  = document.getElementById('rs-panel');
const rsClose  = document.getElementById('rs-close');
const rsBadge  = document.getElementById('rs-badge');
const rsAllowNav = document.getElementById('rs-allow-nav');
const rsAllowAdv = document.getElementById('rs-allow-adv');
const rsRequest  = document.getElementById('rs-request');
const rsEnd      = document.getElementById('rs-end');
const rsChatBox  = document.getElementById('rs-chat');
const rsInput    = document.getElementById('rs-input');
const rsSend     = document.getElementById('rs-send');
const rsMiniWrap = document.getElementById('rs-mini-wrap');
const rsMiniToggle = document.getElementById('rs-mini-toggle');
const rsMini = document.getElementById('rs-mini');

const banned = [/시[ㅣi]발/i,/병?신/i,/좆/i,/fuck/i,/shit/i,/nigg/i,/rape/i,/\b010[-\s]?\d{4}[-\s]?\d{4}\b/i,/(https?:\/\/|t\.me\/|discord\.gg|kakao\.me)/i];
const clean = (t)=> !banned.some(r=>r.test(t||''));
const addMsg = (txt, me=false, sys=false)=>{
  const b=document.createElement('div'); b.className='bubble'+(me?' me':'')+(sys?' sys':''); b.textContent=txt; rsChatBox.appendChild(b); rsChatBox.scrollTop=rsChatBox.scrollHeight;
};
function setBadge(cls, text){ rsBadge.className='badge '+cls; rsBadge.textContent='상태: '+text; }

let pc=null;
function ensurePC(){
  if(pc) return pc;
  pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  pc.onicecandidate = (e)=>{ if(e.candidate){ const c = push(ref(db, `assist/${uid}/signal/userIce`)); set(c, e.candidate.toJSON()); } };
  pc.onconnectionstatechange = ()=>{
    if(pc.connectionState==='connected') setBadge('ok','연결됨');
    if(pc.connectionState==='disconnected' || pc.connectionState==='failed') setBadge('end','해제됨');
  };
  return pc;
}

let sessionRef, chatRef, signalOfferRef, signalAnswerRef, signalAdminIceRef, controlRef;
function bindSessionPaths(){
  sessionRef        = ref(db, `assist/${uid}`);
  chatRef           = ref(db, `assist/${uid}/chat`);
  signalOfferRef    = ref(db, `assist/${uid}/signal/offer`);
  signalAnswerRef   = ref(db, `assist/${uid}/signal/answer`);
  signalAdminIceRef = ref(db, `assist/${uid}/signal/adminIce`);
  controlRef        = ref(db, `assist/${uid}/control`);
}

/* === 미니 미러 프레임 === */
let miniDoc=null, miniCursor=null, miniLabel=null, miniShown=false;
function initMini(){
  const doc = rsMini.contentDocument || rsMini.contentWindow?.document;
  if(!doc) return;
  doc.open();
  doc.write(`<!doctype html><meta charset="utf-8"><style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:12px system-ui,Arial;overflow:hidden}
    .cursor{position:absolute;left:0;top:0;width:14px;height:14px;border:2px solid #00d4ff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(0,212,255,.8)}
    .label{position:absolute;left:8px;top:6px;background:rgba(0,0,0,.4);padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.14)}
  </style><div class="label">관리자 커서</div><div class="cursor" id="c"></div>`);
  doc.close();
  miniDoc=doc; miniCursor=doc.getElementById('c'); miniLabel=doc.querySelector('.label');
}
function showMini(on){
  miniShown=!!on; rsMini.style.display = miniShown ? 'block' : 'none';
  if(miniShown && !miniDoc) initMini();
}
function moveMini(nx, ny, msg){
  if(!miniShown) return;
  if(!miniDoc) initMini();
  const w = rsMini.clientWidth, h = rsMini.clientHeight;
  const x = Math.min(Math.max(nx,0),1)*w, y = Math.min(Math.max(ny,0),1)*h;
  miniCursor.style.left = x+'px'; miniCursor.style.top = y+'px';
  if(msg && miniLabel) miniLabel.textContent = msg;
}
function clickRipple(x,y){
  const d=document.createElement('div'); d.className='rip'; d.style.left=x+'px'; d.style.top=y+'px'; document.body.appendChild(d);
  setTimeout(()=>d.remove(), 650);
}

rsMiniToggle.onclick = ()=> showMini(!miniShown);

const rsToggleBtn = document.getElementById('rs-toggle');
rsToggleBtn.onclick = ()=>{ rsPanel.style.display='flex'; if(uid) rsMiniWrap.style.display='flex'; };
rsClose.onclick = ()=> rsPanel.style.display='none';
rsSend.onclick = ()=>{ const t=rsInput.value.trim(); if(!t) return; rsInput.value=''; if(!clean(t)){ addMsg('부적절한 메시지는 전송할 수 없어요.', false, true); return; } const m=push(chatRef); set(m,{role:'user',text:t,ts:Date.now()}); };

onAuthStateChanged(auth, (user)=>{
  if(!user) return;
  bindSessionPaths();
  update(sessionRef, { uid, status:'idle', allowNav:false, allowAdvanced:false, updatedAt:serverTimestamp() });
  onChildAdded(chatRef, s=>{ const m=s.val(); if(!m) return; addMsg(m.text||'', m.role==='user', m.role==='system'); });

  onValue(ref(db, `assist/${uid}/accept`), async snap=>{
    const v=snap.val(); if(v===true){
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
        const pcLocal = ensurePC();
        stream.getTracks().forEach(t=> pcLocal.addTrack(t, stream));
        const offer = await pcLocal.createOffer(); await pcLocal.setLocalDescription(offer); await set(signalOfferRef, offer);
        rsEnd.style.display=''; rsRequest.style.display='none';
        addMsg('관리자가 연결을 수락했습니다. 화면 공유를 시작합니다.', false, true);
        update(sessionRef, { status:'connecting', updatedAt:serverTimestamp() });
        const sync = ()=> update(sessionRef, { allowNav: !!rsAllowNav.checked, allowAdvanced: !!rsAllowAdv.checked, updatedAt:serverTimestamp() });
        rsAllowNav.onchange = sync; rsAllowAdv.onchange = sync; sync();
        rsMiniWrap.style.display='flex'; // 패널에 미니 미러 토글 노출
      }catch{ addMsg('화면공유가 취소/실패했습니다. 다시 시도해주세요.', false, true); update(sessionRef, { status:'idle', updatedAt:serverTimestamp() }); setBadge('end','취소됨'); }
    }
  });
  onValue(signalAnswerRef, async s=>{ const v=s.val(); if(!v) return; await ensurePC().setRemoteDescription(v); });
  onChildAdded(ref(db, `assist/${uid}/signal/adminIce`), async s=>{ const c=s.val(); if(!c) return; try{ await ensurePC().addIceCandidate(new RTCIceCandidate(c)); }catch{} });

  // 제어 명령 → 실제 동작 + 미니 미러 & 리플
  onChildAdded(ref(db, `assist/${uid}/control`), s=>{
    const c=s.val()||{}; const navOK=!!rsAllowNav.checked; const advOK=!!rsAllowAdv.checked;
    if(c.type==='navigate'&&navOK){ location.href = c.path || location.href; return; }
    if(!advOK) return;
    if(c.type==='click'){
      const x = Math.round(window.innerWidth * c.nx), y = Math.round(window.innerHeight * c.ny);
      const el = document.elementFromPoint(x,y); if(!el) return;
      // 민감영역 차단
      if (el.closest('input[type="password"], [data-sensitive="true"]')){ const m=push(chatRef); set(m,{role:'system',text:'민감한 정보이므로 비공개 처리했습니다.',ts:Date.now()}); moveMini(c.nx,c.ny,'민감영역 차단'); return; }
      try{ el.focus({preventScroll:true}); }catch{}
      el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,clientX:x,clientY:y}));
      clickRipple(x,y);
      moveMini(c.nx,c.ny,'클릭');
    }
    if(c.type==='scroll'){
      window.scrollBy({ top: c.dy||0, behavior:'smooth' });
      moveMini(0.06,0.08, c.dy>0?'스크롤↓':'스크롤↑');
    }
  });
});

// 요청/종료
rsRequest.onclick = async ()=>{
  if(!uid){ addMsg('로그인 후 이용하세요.', false, true); return; }
  const m=push(chatRef); set(m,{role:'user',text:'원격지원 요청합니다 🙏',ts:Date.now()});
  await update(sessionRef, { status:'waiting', updatedAt:serverTimestamp() });
  setBadge('wait','대기');
};
rsEnd.onclick = async ()=>{
  if(pc){ try{ pc.getSenders().forEach(s=>s.track&&s.track.stop()); pc.close(); }catch{} }
  pc=null;
  await update(sessionRef, { status:'ended', allowNav:false, allowAdvanced:false, updatedAt:serverTimestamp() });
  await set(ref(db, `assist/${uid}/signal`), null);
  await set(ref(db, `assist/${uid}/accept`), null);
  await set(ref(db, `assist/${uid}/control`), null);
  await set(ref(db, `assist/${uid}/chat`), null);
  rsEnd.style.display='none'; rsRequest.style.display=''; setBadge('end','종료');
  addMsg('세션을 종료했습니다. 채팅/제어 기록은 삭제됩니다.', false, true);
  showMini(false);
};
</script>
</body>
</html>