<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</title>

  <!-- ÏµúÏ¥à Ï†ëÏÜç Ïãú /loginÏúºÎ°ú ÌïúÎ≤àÎßå ÎùºÏö∞ÌåÖ -->
  <script>
    try {
      if (!sessionStorage.getItem('pmode_init')) {
        history.replaceState(null, '', '/login' + (location.hash || ''));
        sessionStorage.setItem('pmode_init', '1');
      }
    } catch (e) {}
  </script>

  <!-- ÌåùÏóÖ/Î¶¨Îã§Ïù¥Î†âÌä∏ Î∂ÄÎ™® Î≥¥Ïïà ÏïåÎ¶º/ÌóàÏö© ÎèÑÎ©îÏù∏ -->
  <script>
    const allowedParentOrigins = [
      location.origin,
      'https://xn--989a202a4ogwtc69p.siustudio.kro.kr',
      'https://siustudio.kro.kr'
    ];
    function isAllowedRedirect(urlStr) {
      try {
        const u = new URL(urlStr);
        if (u.protocol !== 'https:') return false;
        const host = u.hostname;
        const base1 = 'xn--989a202a4ogwtc69p.siustudio.kro.kr';
        const base2 = 'siustudio.kro.kr';
        return (
          host === base1 ||
          host === base2 ||
          host.endsWith('.' + base1) ||
          host.endsWith('.' + base2)
        );
      } catch {
        return false;
      }
    }
    let parentOrigin    = sessionStorage.getItem('parent_origin')    || null;
    let pendingRedirect = sessionStorage.getItem('pending_redirect') || null;
    let pendingState    = sessionStorage.getItem('pending_state')    || null;

    function consumePendingRedirect() {
      let target = null;
      try {
        const fromStorage = sessionStorage.getItem('pending_redirect');
        if (fromStorage) {
          sessionStorage.removeItem('pending_redirect');
          target = fromStorage;
        }
      } catch {}
      if (!target && pendingRedirect) target = pendingRedirect;
      pendingRedirect = null;
      return (target && isAllowedRedirect(target)) ? target : null;
    }

    function notifyReadyToParent() {
      try {
        if (window.opener && !window.opener.closed) {
          allowedParentOrigins.forEach((o) => {
            try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}
          });
        }
      } catch {}
    }
    notifyReadyToParent();

    function notifyAuthSuccessAndExit() {
      const target = consumePendingRedirect();
      const hasParent = window.opener && !window.opener.closed && parentOrigin;
      if (hasParent) {
        try {
          window.opener.postMessage({
            type: 'auth-success',
            ok: true,
            redirect: target || undefined,
            receivedState: pendingState
          }, parentOrigin);
        } catch {}
        try { window.close(); } catch {}
        return;
      }
      if (target) window.location.href = target;
    }
    window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;
  </script>

  <style>
    :root{
      --glass-bg: rgba(10,12,20,0.40);
      --glass-brd: rgba(255,255,255,0.08);
      --accent: #00d4ff;
    }
    body {
      margin:0;
      padding:0;
      font-family:Inter, Arial, sans-serif;
      background:url('/images/space-bg.jpg') center/cover no-repeat;
      color:#fff;
    }
    img { display:block; }

    /* Î∂ÄÌåÖ/Ïä§ÌîºÎÑà */
    #top-bar, #container { visibility: hidden; }
    .spinner {
      width:46px;
      height:46px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.12);
      border-top-color: #00d4ff;
      animation:spin 1s linear infinite;
      margin:0 auto 10px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    #boot-overlay{
      position:fixed; inset:0; z-index:3000;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      backdrop-filter: blur(3px);
    }
    #boot-overlay .card{
      width:min(420px,92vw); border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));
      padding:16px; text-align:center; color:#e6f7ff;
      box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* Î°úÍ∑∏Ïù∏ Ïπ¥Îìú */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));
      box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
      display:none;
    }
    #auth-container.hidden {
      opacity:0;
      transform: translate(-50%, -46%) scale(.98);
      pointer-events:none;
      visibility:hidden;
    }
    #auth-container h2 {
      margin:0 0 12px;
      font-size:20px;
      color:#e8faff;
      letter-spacing:0.2px;
    }
    #auth-container input {
      width:100%; padding:12px 12px; margin:8px 0;
      border-radius:10px; border:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.20); color:#fff;
      outline:none; font-size:14px;
    }
    #auth-container input:focus {
      box-shadow:0 8px 20px rgba(0,160,255,0.08);
      border-color:rgba(0,160,255,0.22);
    }
    #auth-container .primary-btn {
      width:100%; padding:12px; margin-top:8px; border-radius:10px;
      background:linear-gradient(90deg,#00c0ff,#0077ff);
      color:#00120b; font-weight:800; border:none; cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,120,255,0.12);
    }
    #auth-container .ghost-btn {
      width:100%; padding:10px; margin-top:6px; border-radius:10px;
      background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer;
    }

    .auth-status {
      margin-top:10px; min-height:22px;
      font-size:13px; color:#ffdede;
      opacity:0; transform:translateY(6px);
      transition:opacity .22s ease, transform .22s ease;
    }
    .auth-status.show { opacity:1; transform:translateY(0); }

    .login-overlay {
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      border-radius:14px; z-index:1100; opacity:1; pointer-events:auto;
    }
    .login-overlay.show { display:flex; }

    .google-btn {
      width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px; margin:8px 0 4px;
      background:linear-gradient(180deg,#fff,#f2f2f2);
      color:#000;
      border-radius:8px; border:1px solid rgba(0,0,0,0.08);
      cursor:pointer; font-weight:700;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; }

    @media (max-width:420px){
      #auth-container{ padding:16px; }
      .google-btn{ width:100%; }
    }

    /* ÏÉÅÎã® Î∞î */
    #top-bar {
      position: fixed; top: 5px; left: 5px; right: 5px;
      display: flex; flex-wrap: wrap; gap:6px 8px;
      justify-content: space-between; align-items: center;
      background: rgba(30,30,30,0.55);
      padding:6px 10px; border-radius:8px;
      font-size:12px; z-index:1000;
      border: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
      overflow: hidden;
    }
    .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden; }
    .bar-group img { width:16px; height:16px; }
    .bar-group span { white-space: nowrap; }
    #ship-img{ width:16px; height:16px; }

    #settings-btn {
      margin-left: 8px; padding: 6px 10px; border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;
      cursor: pointer; font-weight: 700;
    }
    #settings-btn:hover { filter: brightness(1.08); }

    /* ÏÉà Î≤ÑÌîÑ Î≤ÑÌäº */
    #buff-btn{
      margin-left: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      background: rgba(0,212,255,0.12);
      border: 1px solid rgba(0,212,255,0.35);
      color:#e6f5ff;
      cursor:pointer;
      font-weight:700;
      backdrop-filter: blur(4px);
    }
    #buff-btn:hover{ background: rgba(0,212,255,0.25); }

    /* ÏùòÏã¨ÎèÑ Î∞∞ÏßÄ: ÏöîÍµ¨ÏÇ¨Ìï≠ÎåÄÎ°ú ÏôÑÏ†Ñ Ïà®ÍπÄ */
    #suspicion-badge{ display:none !important; }

    /* Î≥∏Î¨∏ */
    #container {
      margin:56px auto 20px;
      width:90%; max-width:640px;
      padding:16px 20px;
      background:rgba(30,30,30,0.55);
      border-radius:10px; text-align:center;
      border:1px solid rgba(255,255,255,0.08);
    }
    h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }
    button.general {
      width:calc(100% - 32px); max-width:320px;
      padding:10px; margin:6px auto;
      font-size:13px;
      background:url('/images/button-bg.png') center/contain no-repeat;
      color:#fff; border:none; border-radius:6px; cursor:pointer;
      transition:opacity .2s; white-space: pre-line;
    }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }

    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }

    .particle {
      position:absolute; width:6px; height:6px; background:#ffd700;
      border-radius:50%; opacity:.8; animation:floatUp .8s ease-out forwards; pointer-events:none;
    }
    @keyframes floatUp { to { transform: translate(var(--dx),var(--dy)) scale(0); opacity:0; } }
    #ore { width:200px; cursor:pointer; }

    /* Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ */
    #custom-menu {
      position: fixed; display: none;
      background: rgba(30,30,30,0.90);
      border: 1px solid #555; border-radius: 6px;
      padding: 8px 0; z-index: 2000;
      font-size: 14px; color: #fff; min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }
    #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

    /* Î∞îÌÖÄ ÎÇ¥ÎπÑ */
    #bottom-nav{
      position: fixed;
      left: 50%; bottom: max(12px, env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%);
      display: flex; gap: 8px; padding: 8px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-brd);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      z-index: 1200; max-width: 96vw;
    }
    #bottom-nav .tab{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 6px; min-width: 70px; padding: 10px 12px; font-size: 13px;
      color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    #bottom-nav .tab:hover{ transform: translateY(-1px); }
    #bottom-nav .tab.active{
      color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);
      border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);
    }

    #container{ padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }
    #planets-content{ padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px)); }

    @media (max-width: 420px){
      #top-bar{ font-size:11px; padding:6px 8px; }
      #settings-btn{ padding:5px 8px; font-size:12px; }
      #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; }
      #bottom-nav .tab{ padding:10px 8px; min-width:0; }
      h1{ font-size:1.2em; }
    }

    /* ÏÇ¨Ïù¥Îìú Î©îÎâ¥ */
    #side-menu-toggle{
      position: fixed; left: 8px; bottom: calc(96px + env(safe-area-inset-bottom, 0px));
      z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;
      display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }
    #side-backdrop.show{ opacity:1; pointer-events:auto; }
    #side-menu{
      position: fixed; top: 0; left:  0; bottom:  0; width: 260px; max-width: 84vw;
      transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);
      background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);
    }
    #side-menu.open{ transform: translateX(0); }
    .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .side-item{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none;
    }
    .side-item:hover{ filter: brightness(1.08); }
    .side-item .icon{ width:18px; text-align:center; }
    .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }
    @media (max-width: 420px){
      #side-menu-toggle{ bottom: calc(88px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; }
      #side-menu{ width: 240px; }
    }

    /* ===== Ï∂úÏÑù & Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ ===== */
    #daily-overlay{
      position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);
    }
    #daily-overlay.show{ display:flex; }
    #daily-card{
      width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));
      padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);
      color:#eaf6ff;
    }
    #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    #daily-info{ margin:6px 0 10px; font-size:12px; color:#cfe6ff; min-height:36px; }
    #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

    .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }
    .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }
    .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

    /* Ïä¨Î°ØÌòï (ÏÑ∏Î°ú ÎÇôÌïò) */
    #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .slot-window{
      width:320px; height:56px; overflow:hidden; border-radius:10px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12);
    }
    .reel{ display:flex; flex-direction:column; }
    .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }
    .slot-icon{ font-size:20px; }

    /* Ïª®Ìä∏Î°§/ÌôïÎ•†/Î™©Î°ù */
    #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .spinbtn{
      padding:10px 14px; border-radius:10px; cursor:pointer;
      border:1px solid rgba(255,255,255,.14); font-weight:900;
    }
    .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }
    .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }
    #prob-toggle{
      width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff;
    }
    #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }
    #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }
    #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }

    /* Î≤ÑÌîÑ ÏÉÅÌÉú Î≥¥Í∏∞ Ïò§Î≤ÑÎ†àÏù¥ */
    #buff-overlay{
      position:fixed; inset:0; z-index:3650; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #buff-overlay.show{ display:flex; }
    #buff-card{
      width:min(480px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #buff-list{ margin-top:10px; max-height:42vh; overflow-y:auto; }
    .buff-item{
      padding:8px 8px; margin-bottom:4px; border:1px solid rgba(255,255,255,0.05);
      border-radius:10px; background:rgba(0,0,0,0.12); font-size:13px;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* ÌÜ†Ïä§Ìä∏ */
    #toast{
      position: fixed;
      left: 50%;
      bottom: calc(80px + env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%) translateY(20px);
      min-width: 220px; max-width: 92vw;
      padding: 10px 12px;
      background: rgba(10,12,20,0.85);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      color:#eaf6ff; font-weight:800; font-size:13px;
      display: none; z-index: 4000;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #toast.show{ display:block; animation: toast-pop .28s ease-out forwards; }
    #toast .t-row{ display:flex; align-items:center; gap:10px; }
    #toast .t-msg{ flex:1; }
    #toast .t-btn{
      padding: 6px 10px; border-radius: 8px; border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; font-weight:900; cursor:pointer;
    }
    @keyframes toast-pop {
      from { opacity:0; transform: translateX(-50%) translateY(20px); }
      to   { opacity:1; transform: translateX(-50%) translateY(0); }
    }

    /* ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ */
    #migrate-overlay{
      position: fixed; inset:0; z-index:3600; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #migrate-overlay.show{ display:flex; }
    #migrate-card{
      width:min(560px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #migrate-card h3{ margin:0 0 8px; font-size:18px; }
    #migrate-desc{ font-size:13px; color:#cfe6ff; line-height:1.5; }
    .warnbox{
      margin:10px 0; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,211,110,.45);
      background: rgba(255,211,110,.10); color:#ffe3a3; font-weight:700;
    }
    #migrate-progress{ margin-top:10px; font-size:13px; color:#a6e7ff; min-height:20px; }
    #migrate-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #migrate-start{
      padding:10px 14px; border-radius:10px; border:none; font-weight:900; cursor:pointer;
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018;
    }
    #migrate-start[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Ïù¥Ïö©ÏïΩÍ¥Ä & Ï†ïÏßÄ Ïò§Î≤ÑÎ†àÏù¥ */
    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px); z-index:3650;
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      width:min(620px,94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    .overlay-card h3{ margin:0 0 8px; font-size:18px; }
    .overlay-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #tos-body{
      max-height:40vh; overflow:auto; padding:10px; border:1px solid rgba(255,255,255,0.10);
      border-radius:10px; background: rgba(0,0,0,0.2); font-size:13px; color:#cfe6ff;
    }
    #tos-accept[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- Î∂ÄÌåÖ Ï§ë Ïò§Î≤ÑÎ†àÏù¥ (ÏµúÏ¥à 1ÌöåÎßå) -->
  <div id="boot-overlay" aria-hidden="false">
    <div class="card" role="status" aria-live="polite" aria-atomic="true">
      <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
        <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
        <div style="text-align:left;">
          <div style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë‚Ä¶</div>
          <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ëÏù¥ÏóêÏöî</div>
        </div>
      </div>
      <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
    </div>
  </div>

  <!-- Ïù∏Ï¶ù -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">Î°úÍ∑∏Ïù∏</button>
      <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">ÌöåÏõêÍ∞ÄÏûÖ</button>
    </div>

    <h2 id="auth-title">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</h2>
    <input type="email" id="email" placeholder="Ïù¥Î©îÏùº" autocomplete="username" />
    <input type="password" id="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
    <div id="signup-extra" style="display:none; margin-top:6px;">
      <input type="password" id="password-confirm" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏" autocomplete="new-password" />
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
        <input type="checkbox" id="tos-checkbox" /> <span>Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï©ÎãàÎã§</span>
      </label>
      <div style="margin-top:6px; font-size:12px; color:#cfe6ff; text-align:left; line-height:1.45;">
        <b>Ïù¥Ïö©ÏïΩÍ¥Ä ÏïàÎÇ¥:</b><br/>
        ¬∑ ÏπòÌåÖ/Ìïµ ÏÇ¨Ïö©, Î≤ÑÍ∑∏ ÏïÖÏö©, Í≥ÑÏ†ï ÏñëÎèÑ/ÎåÄÏó¨Îäî Í∏àÏßÄÎê©ÎãàÎã§.<br/>
        ¬∑ <u>ÏûêÏõê¬∑ÏΩîÏù∏ ÎπÑÏ†ïÏÉÅ Í∏âÏ¶ù(Ïòà: Ìïú Î≤àÏóê 10Ïñµ ÏΩîÏù∏)</u> ÌÉêÏßÄ Ïãú Í≤ΩÍ≥† ÎòêÎäî Ï¶âÏãú Ï†ïÏßÄÎê† Ïàò ÏûàÏäµÎãàÎã§.<br/>
        ¬∑ ÏûêÏÑ∏Ìïú ÎÇ¥Ïö©ÏùÄ ÏïÑÎûò ‚ÄòÏù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùò‚Äô Î™®Îã¨ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.
      </div>
      <!-- üîó Ïù¥Ïö©ÏïΩÍ¥Ä ÏûêÏÑ∏Ìûà Î≥¥Í∏∞ (inframe /privacy) -->
      <div style="margin-top:8px; text-align:left;">
        <a href="#" id="tos-more-link" style="font-size:12px; color:#9fdcff; text-decoration:underline;">
          Ïù¥Ïö©ÏïΩÍ¥Ä ÏûêÏÑ∏Ìûà Î≥¥Í∏∞
        </a>
      </div>
    </div>

    <button id="login-btn" class="primary-btn">Î°úÍ∑∏Ïù∏</button>
    <button id="signup-btn" class="ghost-btn" style="display:none">ÌöåÏõêÍ∞ÄÏûÖ</button>

    <button id="google-btn" aria-label="Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ (Í∂åÏû•)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false">
          <path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/>
          <path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/>
          <path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/>
          <path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/>
        </svg>
      </span>
      <span class="g-text">Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ <small>(Í∂åÏû•)</small></span>
    </button>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>
    <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë</div>
            <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">Î≥¥Ïïà Ïó∞Í≤∞ ¬∑ Ïù∏Ï¶ù Ï§ë‚Ä¶</div>
          </div>
        </div>
        <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
      </div>
    </div>
  </div>

  <!-- ÏÉÅÎã® Î∞î & Î©îÏù∏ Í≤åÏûÑ -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ÏûêÏõê: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ÏΩîÏù∏: 0</span>
      <img src="/images/event-icon.png" alt="EventCoin" />
      <span id="ecoins">Ïù¥Î≤§Ìä∏ÏΩîÏù∏: 0</span>
    </div>
    <div class="bar-group">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />
      <span id="ship-level">1Î†ô (20ÏΩîÏù∏)</span>
      <button id="upgrade-ship">ÏóÖÍ∑∏Î†àÏù¥Îìú</button>
      <button id="buff-btn" aria-label="ÌòÑÏû¨ Î≤ÑÌîÑ Î≥¥Í∏∞">Î≤ÑÌîÑ(0)</button>
      <span id="suspicion-badge" title="Ìïµ ÏÇ¨Ïö© ÏùòÏã¨ÎèÑ">ÏùòÏã¨ÎèÑ: 0</span>
      <button id="settings-btn" aria-label="ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô">‚öôÔ∏è ÏÑ§Ï†ï</button>
    </div>
  </div>

  <div id="container">
    <h1>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</h1>

    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="Í¥ëÏÑù" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ÏûêÏõê ‚Üí 1ÏΩîÏù∏</button>
        <button id="auto-convert-buy" class="general">ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(100ÏΩîÏù∏)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>Ï¥ù Ï¥àÎãπ ÏûêÏõê: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ÏïåÎ∞î Í≥†Ïö© (<span id="worker-cost">0</span>ÏΩîÏù∏)</button>
      <p>Ï¥ù Ï¥àÎãπ ÏΩîÏù∏: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ÏΩîÏù∏ ÏïåÎ∞î (<span id="conversion-cost">0</span>ÏΩîÏù∏)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>ÌÅ¥Î¶≠Îãπ ÏûêÏõê: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (15ÏΩîÏù∏)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <!-- Î∞îÌÖÄ ÎÇ¥ÎπÑ -->
    <nav id="bottom-nav" aria-label="Í≤åÏûÑ ÌÉ≠ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò">
      <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ü™®</span><span class="t-label">Î©îÏù∏</span></div>
      <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">üë©‚ÄçüöÄ</span><span class="t-label">Ïö∞Ï£ºÏù∏</span></div>
      <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">‚öôÔ∏è</span><span class="t-label">ÏóÖÍ∑∏Î†àÏù¥Îìú</span></div>
      <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ü™ê</span><span class="t-label">ÌñâÏÑ±</span></div>
    </nav>
  </div>

  <!-- Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
  <div id="custom-menu">
    <div class="menu-item" data-action="menu"><span>üéÆ Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></div>
    <div class="menu-item" data-action="download"><span>‚¨áÔ∏è Ïï± Îã§Ïö¥Î°úÎìú</span></div>
    <div class="menu-item" data-action="resume"><span>‚ñ∂Ô∏è Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></div>
    <div class="menu-item" data-action="rank"><span>üèÜ Îû≠ÌÇπ Î≥¥Í∏∞</span></div>
    <div class="menu-item" data-action="attendance">
      <span>üìÖ Ï∂úÏÑù Î≥¥ÏÉÅ</span>
      <span id="attendance-left">-</span>
    </div>
  </div>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <button id="side-menu-toggle" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥ Ïó¥Í∏∞" title="Î©îÎâ¥">‚ò∞</button>
  <div id="side-backdrop" aria-hidden="true"></div>
  <aside id="side-menu" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥" aria-hidden="true">
    <div class="side-header">Î©îÎâ¥</div>
    <nav class="side-items">
      <button class="side-item" data-action="menu"><span class="icon">üéÆ</span><span>Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></button>
      <button class="side-item" data-action="download"><span class="icon">‚¨áÔ∏è</span><span>Ïï± Îã§Ïö¥Î°úÎìú</span></button>
      <button class="side-item" data-action="resume"><span class="icon">‚ñ∂Ô∏è</span><span>Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></button>
      <button class="side-item" data-action="rank"><span class="icon">üèÜ</span><span>Îû≠ÌÇπ Î≥¥Í∏∞</span></button>
      <button class="side-item" data-action="attendance">
        <span><span class="icon">üìÖ</span>Ï∂úÏÑù Î≥¥ÏÉÅ</span>
        <span class="side-right" id="attendance-left-side">-</span>
      </button>
    </nav>
  </aside>

  <!-- Ï∂úÏÑù/Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="daily-overlay" aria-hidden="true">
    <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">
      <div id="daily-title">
        <span>üìÖ Ïò§ÎäòÏùò Î≥¥ÏÉÅ & Ïä¨Î°Ø</span>
        <button id="prob-toggle" title="ÌôïÎ•†/Î≥¥ÏÉÅ Ï†ïÎ≥¥">i</button>
      </div>

      <div class="tabbar">
        <button class="tbtn active" data-mode="daily">Ï∂úÏÑù Ïä¨Î°Ø(Î¨¥Î£å/Ïùº1Ìöå)</button>
        <button class="tbtn" data-mode="premium">ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø(Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1)</button>
        <button class="tbtn" data-mode="ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø(10)</button>
      </div>

      <div id="daily-info">ÌôïÏù∏ Ï§ë‚Ä¶</div>

      <div id="slot-wrap">
        <div class="slot-window">
          <div id="slot-reel" class="reel"></div>
        </div>
      </div>

      <div id="mode-row">
        <button id="spin-daily"   class="spinbtn spin-free">Î¨¥Î£å Ï∂úÏÑù ÎèåÎ¶¨Í∏∞</button>
        <button id="spin-premium" class="spinbtn spin-prem">ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎèåÎ¶¨Í∏∞(-EC 1)</button>
        <button id="spin-ecoin"   class="spinbtn spin-ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÎèåÎ¶¨Í∏∞(-EC 10)</button>
      </div>

      <div id="prob-panel"></div>
      <div id="reward-list"></div>

      <div id="daily-actions">
        <button id="daily-close">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="migrate-overlay" aria-hidden="true">
    <div id="migrate-card" role="dialog" aria-modal="true" aria-labelledby="migrate-title">
      <h3 id="migrate-title">Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞©Ïãù Î≥ÄÍ≤Ω ÏïàÎÇ¥</h3>
      <div id="migrate-desc">
        Í≤åÏûÑ ÎÇ¥ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞©ÏãùÏù¥ Î≥ÄÍ≤ΩÎêòÏñ¥ <b>Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò</b>Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.<br/>
        ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ <b>Í∏∞Ï°¥ ÏúÑÏπòÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞(ÌïòÏúÑ ÌÇ§ Ï†ÑÏ≤¥)</b>Î•º ÏÉà ÏúÑÏπòÎ°ú Ïù¥ÎèôÌïòÍ≥†, <b>ÏõêÎ≥∏ÏùÄ ÏÇ≠Ï†ú</b>Îê©ÎãàÎã§.
      </div>
      <div class="warnbox">‚ö†Ô∏è ÏßÑÌñâ Ï§ë Ï∞ΩÏùÑ Îã´Í±∞ÎÇò Ï¢ÖÎ£åÌïòÎ©¥ <b>Îç∞Ïù¥ÌÑ∞ Ïù¥Ï†Ñ Ï§ë Î¨∏Ï†ú</b>Í∞Ä Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§. Í∞ÄÎä•ÌïòÎ©¥ ÏôÑÎ£åÍπåÏßÄ Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.</div>
      <div id="migrate-progress">ÎåÄÍ∏∞ Ï§ë‚Ä¶</div>
      <div id="migrate-actions">
        <button id="migrate-start">ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏãúÏûë</button>
      </div>
    </div>
  </div>

  <!-- üìú Ïù¥Ïö©ÏïΩÍ¥Ä Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="tos-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="tos-title">
      <h3 id="tos-title">Ïù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùò</h3>
      <div id="tos-body">
        <p>Î≥∏ Í≤åÏûÑÏùÄ Í≥µÏ†ïÌïú ÌîåÎ†àÏù¥Î•º ÏúÑÌï¥ ÏπòÌåÖ¬∑Ìïµ ÏÇ¨Ïö©ÏùÑ ÏóÑÍ≤©Ìûà Í∏àÏßÄÌï©ÎãàÎã§.</p>
        <ul>
          <li>ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏¬∑ÏΩòÏÜî Ï°∞Ïûë Îì±ÏúºÎ°ú ÏûêÏõê/ÏΩîÏù∏ÏùÑ ÎπÑÏ†ïÏÉÅÏ†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇ§Îäî ÌñâÏúÑ Í∏àÏßÄ</li>
          <li>Î≤ÑÍ∑∏ ÏïÖÏö© Í∏àÏßÄ, Í≥ÑÏ†ï ÏñëÎèÑ/ÎåÄÏó¨ Í∏àÏßÄ</li>
          <li><b>ÎπÑÏ†ïÏÉÅ Í∏âÏ¶ù</b> ÏòàÏãú: Ìïú Î≤àÏóê <b>10Ïñµ ÏΩîÏù∏</b> Ïù¥ÏÉÅ Ï¶ùÍ∞Ä ‚Üí Ï¶âÏãú Ï†ïÏßÄ Í∞ÄÎä•</li>
        </ul>
        <p>ÎèôÏùò ÌõÑ ÌîåÎ†àÏù¥Î•º Í≥ÑÏÜçÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
      </div>
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;">
        <input type="checkbox" id="tos-agree" /> <span>ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï©ÎãàÎã§</span>
      </label>
      <div class="overlay-actions">
        <button id="tos-accept" class="spinbtn spin-free" disabled>ÎèôÏùòÌïòÍ≥† ÏãúÏûë</button>
      </div>
    </div>
  </div>

  <!-- üß™ Î≤ÑÌîÑ Î™©Î°ù Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="buff-overlay" aria-hidden="true">
    <div id="buff-card" role="dialog" aria-modal="true" aria-labelledby="buff-title">
      <h3 id="buff-title">ÌòÑÏû¨ Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑ</h3>
      <div id="buff-list">Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
      <div class="overlay-actions">
        <button id="buff-close" class="spinbtn">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- ‚õî Ï†ïÏßÄ Ïò§Î≤ÑÎ†àÏù¥ (Ïò§ÌÉê ÎåÄÏùë Î≤ÑÌäº Ìè¨Ìï®) -->
  <div id="ban-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="ban-title">
      <h3 id="ban-title">‚õî Í≥ÑÏ†ï Ï†ïÏßÄÎê®</h3>
      <div id="ban-desc">
        <p>Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞ò ÏùòÏã¨Ïóê Îî∞Îùº ÌîåÎ†àÏù¥Í∞Ä Ï†úÌïúÎêòÏóàÏäµÎãàÎã§.</p>
        <p>ÏùòÏã¨ÎèÑ: <b id="ban-sus-value">0</b></p>
        <p style="color:#ffd36e">‚Äª Ï†ïÏßÄ Ï§ëÏóêÎäî ÏûêÏõê/ÏΩîÏù∏Ïù¥ Ï¶ùÍ∞ÄÌïòÏßÄ ÏïäÏäµÎãàÎã§.</p>
        <div style="margin-top:8px; font-size:13px; color:#cfe6ff;">
          Ïò§ÌÉêÏúºÎ°ú ÌåêÎã®ÎêòÎ©¥ ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú <b>ÏßÄÏõêÌåÄÏóê Ï¶âÏãú Î©îÏùº</b>ÏùÑ Î≥¥ÎÇ¥Í±∞ÎÇò, <b>Ï†ïÎ≥¥ Î≥µÏÇ¨</b> ÌõÑ ÏàòÎèô Î©îÏùº Ï†ÑÏÜ°Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.
        </div>
      </div>
      <div class="overlay-actions" style="flex-wrap:wrap;">
        <button id="ban-appeal-email" class="spinbtn">üìß Ïò§ÌÉê Î©îÏùº Î≥¥ÎÇ¥Í∏∞</button>
        <button id="ban-copy-info" class="spinbtn">üìã Ï†ïÎ≥¥ Î≥µÏÇ¨</button>
        <button id="ban-ok" class="spinbtn">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- ÏÇ¨Ïö¥Îìú -->
  <audio id="sfx-start"  src="/sounds/roulette_start.mp3" preload="auto"></audio>
  <audio id="sfx-tick"   src="/sounds/roulette_tick.mp3"  preload="auto"></audio>
  <audio id="sfx-win"    src="/sounds/roulette_win.mp3"   preload="auto"></audio>

  <!-- ÌÜ†Ïä§Ìä∏ Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + Í≤åÏûÑ Î°úÏßÅ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      sendEmailVerification,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink,
      EmailAuthProvider, linkWithCredential
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, onValue, runTransaction, update, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ‚úÖ Ïù∏Ï¶ù ÎßÅÌÅ¨ ÌöåÍ∑Ä Î™©Ï†ÅÏßÄ ÏÑ§Ï†ï(ÌòÑÏû¨ ÌéòÏù¥ÏßÄÎ°ú)
    const actionCodeSettings = {
      url: location.origin + location.pathname,
      handleCodeInApp: true
    };

    /* ======================
       Í≥µÌÜµ ÏÉÅÌÉú / Í≤ΩÎ°ú
       ====================== */
    const SUPPORT_EMAIL = 'appeals@siustudio.kro.kr';

    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null;
    let localLastWrite = 0;
    let isInitialSync = false;

    let userServerKey = null;
    let userIdKey     = null;
    let userBasePath  = null;

    let dailyUnlocked = false;
    let rankingUnlocked = false;
    let bootDone = false;

    /* üîí 3Ï¥à Î∂ÄÌä∏ Ïä§ÌÇµ Ï†ÑÏö© ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ */
    const AUDIT_BOOT_TS = Date.now();
    const AUDIT_INITIAL_SKIP_MS = 3000;

    /* ÎÑ§Ìä∏ÏõåÌÅ¨ ÏßÄÏó∞ Í∞êÏßÄÏö© (ÌÜ†Ïä§Ìä∏Îäî Ïïà ÎùÑÏõÄ) */
    let initialSyncStart = 0;
    let networkUnstableShown = false;

    /* ======================
       ÌÜ†Ïä§Ìä∏ / UI Ïú†Ìã∏
       ====================== */
    let toastTimer = null;
    function showToast(message, actionText = null, onAction = null, ttlMs = 5000){
      // ÎÑ§Ìä∏ÏõåÌÅ¨ ÌÜ†Ïä§Ìä∏Îäî Î∂ÄÌåÖÏôÑÎ£å ÌõÑÎßå
      if (message && message.indexOf('ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§') !== -1) return;
      if (!bootDone && message !== 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.') return;

      const box = document.getElementById('toast');
      if(!box) return;
      clearTimeout(toastTimer);

      box.innerHTML = `
        <div class="t-row">
          <span class="t-msg">${message}</span>
          ${actionText ? `<button class="t-btn" id="toast-action">${actionText}</button>` : ``}
        </div>
      `;
      box.classList.add('show');
      box.style.display='block';

      function hideToast(){
        box.classList.remove('show');
        box.style.display='none';
      }

      if(actionText && onAction){
        const btn = document.getElementById('toast-action');
        if(btn){ btn.onclick = () => { try{ onAction(); }catch{} hideToast(); }; }
      }
      toastTimer = setTimeout(hideToast, ttlMs);
    }

    /* ======================
       Î≤ÑÌîÑ Ï†ÄÏû•/Ï†ÅÏö©/ÌëúÏãú
       ====================== */
    function buffStorageKey(){ return `siu_buffs_${uid||'anon'}`; }
    function ensureFx(){ if(!window.fx) window.fx={}; if(!window.fx.buffs) window.fx.buffs=[]; }
    function persistBuffs(){
      ensureFx();
      try {
        const now = Date.now();
        const toSave = window.fx.buffs.filter(b=>b && b.until>now);
        localStorage.setItem(buffStorageKey(), JSON.stringify(toSave));
      } catch {}
    }
    function loadBuffs(){
      ensureFx();
      try {
        const raw = localStorage.getItem(buffStorageKey());
        const arr = raw ? JSON.parse(raw) : [];
        const now = Date.now();
        window.fx.buffs = Array.isArray(arr) ? arr.filter(b=>b && b.until>now) : [];
      } catch { window.fx.buffs = []; }
    }
    function pruneExpiredBuffs(){
      ensureFx();
      const before = window.fx.buffs.length;
      const now = Date.now();
      window.fx.buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      if (window.fx.buffs.length !== before) persistBuffs();
    }
    function activeBuffFactor(kind){
      ensureFx();
      const now = Date.now();
      let factor = 1;
      (window.fx.buffs||[]).forEach(b=>{
        if(!b || now>=b.until) return;
        if (b.type==='all') factor *= (1 + b.value);
        else if (kind==='res'  && b.type==='res')  factor *= (1 + b.value);
        else if (kind==='coin' && b.type==='coin') factor *= (1 + b.value);
      });
      return factor;
    }
    function addTempBuff(type, value, dur){
      ensureFx();
      const now=Date.now();
      window.fx.buffs.push({ type, value, until: now + dur });
      persistBuffs();
      renderBuffStatus();
    }

    // Î≤ÑÌäº/Ïò§Î≤ÑÎ†àÏù¥Ïö© Î≤ÑÌîÑ Î†åÎçî
    function renderBuffStatus(){
      const btn = document.getElementById('buff-btn');
      const listEl = document.getElementById('buff-list');
      pruneExpiredBuffs();
      const now = Date.now();
      const buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      const count = buffs.length;
      if (btn) {
        btn.textContent = count > 0 ? `Î≤ÑÌîÑ(${count})` : 'Î≤ÑÌîÑ(0)';
      }
      if (listEl) {
        if (count === 0) {
          listEl.innerHTML = 'Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑÍ∞Ä ÏóÜÏäµÎãàÎã§.';
        } else {
          const names = { all:'Ï†ÑÏ≤¥', coin:'ÏΩîÏù∏', res:'ÏûêÏõê' };
          listEl.innerHTML = buffs.map(b=>{
            const leftMs = b.until - now;
            const m = Math.max(0, Math.floor(leftMs/60000));
            const s = Math.max(0, Math.floor((leftMs%60000)/1000));
            const mult = 1 + b.value;
            const multText = (Math.abs(mult - Math.round(mult)) < 1e-9) ? `x${Math.round(mult)}` : `x${(Math.round(mult*10)/10)}`;
            return `<div class="buff-item">
              <span>${names[b.type]||'Î≤ÑÌîÑ'} ${multText}</span>
              <span>${m}:${String(s).padStart(2,'0')}</span>
            </div>`;
          }).join('');
        }
      }
    }

    /* ========= Ïà´Ïûê ÌïúÍµ≠Ïãù Îã®ÏúÑ ========= */
    function formatKR(num, decimalsForUnits = 2) {
      if (num === null || num === undefined) return '0';
      if (!isFinite(num)) return String(num);
      const neg = num < 0;
      let n = Math.abs(num);
      const units = ['', 'Îßå', 'Ïñµ', 'Ï°∞', 'Í≤Ω', 'Ìï¥', 'Ïûê', 'Ïñë', 'Íµ¨', 'Í∞Ñ', 'Ï†ï', 'Ïû¨', 'Í∑π'];
      let u = 0;
      while (n >= 10000 && u < units.length - 1) { n /= 10000; u++; }
      if (u === 0) {
        const rounded = Math.round(n);
        return (neg ? '-' : '') + rounded.toLocaleString('ko-KR');
      }
      const s = n.toFixed(decimalsForUnits).replace(/\.0+$|(\.\d*[1-9])0+$/, '$1');
      return (neg ? '-' : '') + s + units[u];
    }

    /* ========= Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ & Ïú†Ìã∏ ========= */
    const defaultData = {
      resources:0, coins:0, eventCoins:0,
      clickPower:1, shipLevel:1, shipUpgradeCost:20,
      workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[],
      _lastUpdated: 0
    };
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const clickUpgradeCost=15;

    function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

    // Î≥ÄÌôò
    function convertResources(maxCount = null) {
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count > 0) {
        const resOut = count * 10;
        state.resources -= resOut;
        auditSpend('res', resOut);

        const coinMul = activeBuffFactor('coin');
        const inc = count * coinMul;
        state.coins += inc;
        auditGain('coin', inc);
      }
    }

    async function ensureInitialData(refObj) {
      try {
        await runTransaction(refObj, current => {
          if (current === null) return { ...defaultData, _lastUpdated: Date.now() };
          return current;
        });
      } catch (err) { console.error('Ï¥àÍ∏∞Ìôî Ìä∏ÎûúÏû≠ÏÖò ÏóêÎü¨:', err); }
    }

    function save() {
      if (!uid || !dataRef) return;
      if (isInitialSync) return;
      if (!window.__PLAY_ALLOWED) return;
      const now = Date.now();
      state._lastUpdated = now;
      localLastWrite = now;
      try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
      update(dataRef, { ...state }).catch(err => console.error('Ï†ÄÏû• ÏóêÎü¨:', err));
    }

    /* ========= ÏÉà ÌÇ§ Í∑úÏπô ========= */
    function encodeEmailToKey(email){
      const s = String(email||'').trim().toLowerCase();
      return s
        .replace(/\s+/g,'')
        .replace(/@/g,'_at_')
        .replace(/\./g,'_dot_')
        .replace(/[#$\[\]\/\\?%*]/g, '-')
        .replace(/[^a-z0-9_\-]/g, '-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromDisplayName(name){
      return (String(name||'').trim().toLowerCase() || 'user')
        .replace(/[^a-z0-9_\-]/g,'-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromUid(uid){
      return `user_${String(uid||'').slice(0,8) || '00000000'}`;
    }
    function makeIdKeyFromUser(user){
      if (user?.email) return encodeEmailToKey(user.email);
      if (user?.displayName) return fallbackIdFromDisplayName(user.displayName);
      return fallbackIdFromUid(user?.uid);
    }

    function isNewlyCreatedAccount(user, minutes = 5) {
      try {
        const ct = Date.parse(user?.metadata?.creationTime || '') || 0;
        const lt = Date.parse(user?.metadata?.lastSignInTime || '') || 0;
        if (!ct || !lt) return false;
        return Math.abs(lt - ct) <= minutes * 60 * 1000;
      } catch { return false; }
    }

    async function allocateServerForUser(){
      try{
        const res = await runTransaction(ref(db, 'meta/nextIndex'), cur => (cur || 0) + 1);
        const idx = res?.snapshot?.val() || 1;
        const serverNum = Math.max(1, Math.ceil(idx / 15));
        return `server${serverNum}`;
      }catch{
        return 'server1';
      }
    }

    async function planMigrationForUser(user){
      const uid = user.uid;
      const desiredId = makeIdKeyFromUser(user);
      const desiredServer = await allocateServerForUser();

      let mapping = null;
      try {
        const m = await get(ref(db, `userServerMap/${uid}`));
        mapping = m.exists() ? (m.val() || null) : null;
      } catch {}

      const legacySnap = await get(ref(db, `users/${uid}`));
      const legacyExists = legacySnap.exists();

      let srcBasePath = null;
      let server = desiredServer;

      if (mapping && mapping.server && mapping.id) {
        srcBasePath = `users/${mapping.server}/${mapping.id}`;
        server = mapping.server;
      } else if (legacyExists) {
        srcBasePath = `users/${uid}`;
      }

      const destBasePath = `users/${server}/${desiredId}`;
      const destSnap = await get(ref(db, destBasePath));
      const destExists = destSnap.exists();

      if (isNewlyCreatedAccount(user) && !legacyExists && !mapping && !destExists) {
        return { need: false, server, oldMapping: null, srcBasePath: null, destBasePath, reason: 'fresh-signup' };
      }

      if (mapping && mapping.server && mapping.id && mapping.id !== desiredId) {
        try {
          const srcSnap = await get(ref(db, srcBasePath));
          if (!srcSnap.exists()){
            return { need:false, server: mapping.server, oldMapping: mapping, srcBasePath: null, destBasePath, reason: 'rename-mapping-only' };
          }
        } catch {}
        return { need:true, server: mapping.server, oldMapping: mapping, srcBasePath, destBasePath, reason: 'rename-to-email-id' };
      }

      if (!mapping && legacyExists) {
        return { need:true, server, oldMapping: null, srcBasePath: `users/${uid}`, destBasePath, reason: 'legacy-flat' };
      }

      return { need:false, server, oldMapping: mapping || null, srcBasePath: null, destBasePath, reason: 'fresh-or-already-ok' };
    }

    function showMigrateOverlay(show=true, msg='ÎåÄÍ∏∞ Ï§ë‚Ä¶'){
      const ov = document.getElementById('migrate-overlay');
      const pr = document.getElementById('migrate-progress');
      if (pr) pr.textContent = msg || '';
      if (ov){
        ov.classList.toggle('show', !!show);
        ov.setAttribute('aria-hidden', show ? 'false':'true');
      }
    }
    function setMigrateProgress(msg){
      const pr=document.getElementById('migrate-progress');
      if(pr) pr.textContent = msg||'';
    }
    function disableMigrateStart(dis=true){
      const btn=document.getElementById('migrate-start');
      if(btn) btn.disabled=!!dis;
    }

    async function performMigration(srcBasePath, destBasePath, user){
      setMigrateProgress('1/3 Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏùΩÎäî Ï§ë‚Ä¶');
      const srcRef = ref(db, srcBasePath);

      const snap = await get(srcRef);
      if (!snap.exists()){
        setMigrateProgress('ÏÜåÏä§Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ Í±¥ÎÑàÎúÅÎãàÎã§.');
      } else {
        const payload = snap.val() || {};
        setMigrateProgress('2/3 ÏÉà ÏúÑÏπòÎ°ú Î≥µÏÇ¨ Ï§ë‚Ä¶');
        await update(ref(db), { [destBasePath]: payload });
        setMigrateProgress('3/3 ÏõêÎ≥∏ ÏÇ≠Ï†ú Ï§ë‚Ä¶');
        await update(ref(db), { [srcBasePath]: null });
      }

      await update(ref(db), {
        [`userServerMap/${user.uid}`]: {
          server: userServerKey,
          id: userIdKey,
          displayId: String(user?.email||'') || null,
          migratedAt: Date.now()
        }
      });

      setMigrateProgress('‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å! Ïû†Ïãú ÌõÑ Í≤åÏûÑÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§‚Ä¶');
    }

    /* ======================
       KST Ïú†Ìã∏ / Îç∞ÏùºÎ¶¨
       ====================== */
    function kstDate(d=new Date()){
      return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }
    function kstDayKey(d=new Date()){
      const t = kstDate(d);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextResetKST(d=new Date()){
      const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n;
    }
    function fmtLeft(ms){
      if(ms<=0) return 'ÏßÄÍ∏à Í∞ÄÎä•';
      const s=Math.floor(ms/1000);
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    /* ‚úÖ Î£∞Î†õÏö© Í∏∞Î≥∏Í∞íÏùÄ Ïú†ÏßÄÌïòÏßÄÎßå, ÏßÄÍ∏àÎ∂ÄÌÑ∞Îäî ‚ÄúÌòÑÏû¨ ÏΩîÏù∏ Í∏∞Î∞ò‚Äù Î≥¥ÏÉÅÏù¥ Ïö∞ÏÑ† */
    function calcBaseCoin(){
      const rps = state.workerCount * getWorkerPower();
      const cps = state.conversionCount;
      const rpc = state.clickPower;
      const planets = (state.ownedPlanets?.length || 0);
      const ship = (state.shipLevel || 1);
      const auto = state.autoConvertBought ? 1 : 0;
      const score =
        20 * Math.log2(1 + rps) +
        45 * Math.log2(1 + cps) +
        10 * Math.log2(1 + rpc) +
        120 * planets +
        32  * ship +
        (auto ? 20 : 0);
      const baseRaw = 50 + score;
      return Math.min(Math.max(baseRaw * 0.65, 30), 30000);
    }

    /* ====== Î£∞Î†õ ÌÖúÌîåÎ¶ø ====== */
    const TPL_DAILY = [
      { key:'coin_cur_06', type:'coin', currentCoinMul:0.6, icon:'üí∞', color:'#00E5FF', w:0.35 },
      { key:'coin_cur_07', type:'coin', currentCoinMul:0.7, icon:'üí∞', color:'#4DFFB5', w:0.25 },
      { key:'res_x2_5m',   type:'buff', bkind:'res',  bmult:1.0, bdur:5*60*1000, icon:'‚ö°',  color:'#FFA8FF', w:0.18 },
      { key:'all_x2_3m',   type:'buff', bkind:'all',  bmult:1.0, bdur:3*60*1000, icon:'üöÄ',  color:'#8AE1FF', w:0.13 },
      { key:'coinbuf_x2_3m', type:'buff', bkind:'coin', bmult:1.0, bdur:3*60*1000, icon:'ü™ô', color:'#FFD0A8', w:0.06 },
      { key:'eco_1',       type:'ecoin', val:1,       icon:'üéüÔ∏è', color:'#FFD05C', w:0.03 }
    ];

    const TPL_PREMIUM = [
      { key:'coin_cur_1',  type:'coin', currentCoinMul:1.0, icon:'üí∞', color:'#00E5FF', w:0.28 },
      { key:'coin_cur_2',  type:'coin', currentCoinMul:2.0, icon:'üí∞', color:'#4DFFB5', w:0.20 },
      { key:'coin_x5_5',   type:'coin', coinMul:5.5,       icon:'üí∞', color:'#32C6FF', w:0.09 },
      { key:'all_x2_10m',  type:'buff', bkind:'all',  bmult:1.0, bdur:10*60*1000, icon:'üöÄ', color:'#8AE1FF', w:0.18 },
      { key:'res_x3_7m',   type:'buff', bkind:'res',  bmult:2.0, bdur:7*60*1000,  icon:'‚ö°', color:'#FFA8FF', w:0.13 },
      { key:'coinbuf_x3_5m', type:'buff', bkind:'coin', bmult:2.0, bdur:5*60*1000, icon:'ü™ô', color:'#FFD0A8', w:0.09 },
      { key:'eco_3',       type:'ecoin', val:3,       icon:'üéüÔ∏è', color:'#FF9E3D', w:0.03 }
    ];

    const TPL_ECOIN = [
      { key:'coin_cur_5',  type:'coin', currentCoinMul:5.0,  icon:'üí∞', color:'#00E5FF', w:0.27 },
      { key:'coin_cur_10', type:'coin', currentCoinMul:10.0, icon:'üí∞', color:'#4DFFB5', w:0.20 },
      { key:'coin_cur_20', type:'coin', currentCoinMul:20.0, icon:'üí∞', color:'#32C6FF', w:0.12 },
      { key:'all_x3_15m',  type:'buff', bkind:'all',  bmult:2.0, bdur:15*60*1000, icon:'üöÄ', color:'#8AE1FF', w:0.16 },
      { key:'res_x5_12m',  type:'buff', bkind:'res',  bmult:4.0,  bdur:12*60*1000, icon:'‚ö°', color:'#FFA8FF', w:0.12 },
      { key:'eco_8',       type:'ecoin', val:8,       icon:'üéüÔ∏è', color:'#FFBE5C', w:0.07 },
      { key:'eco_12',      type:'ecoin', val:12,      icon:'üéüÔ∏è', color:'#FF9E3D', w:0.04 },
      { key:'eco_20',      type:'ecoin', val:20,      icon:'üéüÔ∏è', color:'#FF7AE1', w:0.02 }
    ];

    function materializeItems(tpl, mode){
      const base = calcBaseCoin();
      return tpl.map(it=>{
        if (it.type === 'coin' && typeof it.currentCoinMul === 'number') {
          const curCoins = state.coins || 0;
          const amt = Math.max(1, Math.round(curCoins * it.currentCoinMul));
          return {
            ...it,
            awardCoin: amt,
            label: `ÌòÑÏû¨ÏΩîÏù∏ √ó${it.currentCoinMul} (= ${formatKR(amt)})`,
            onWin:()=>{
              registerAuditIntent('coin', amt);
              state.coins += amt;
              auditGain('coin', amt);
            }
          };
        }
        if (it.type==='coin' && typeof it.coinMul === 'number') {
          const amt = Math.max(1, Math.round(base * it.coinMul));
          return {
            ...it,
            awardCoin: amt,
            label:`ÏΩîÏù∏ ${formatKR(amt)}`,
            onWin:()=>{
              registerAuditIntent('coin', amt);
              state.coins += amt;
              auditGain('coin', amt);
            }
          };
        }
        if (it.type==='ecoin'){
          return {
            ...it,
            awardEcoin: it.val,
            label:`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ √ó${it.val}`,
            onWin:()=>{
              registerAuditIntent('eco', it.val);
              state.eventCoins = (state.eventCoins||0) + it.val;
              auditGain('eco', it.val);
            }
          };
        }
        if (it.type==='buff'){
          const multText = `x${1+it.bmult}`;
          const minText  = `${Math.round(it.bdur/60000)}m`;
          let title = it.bkind==='all' ? `Î™®Îì† ÏÉùÏÇ∞ ${multText}`
                   : it.bkind==='coin' ? `ÏΩîÏù∏ ÏÉùÏÇ∞ ${multText}`
                   :                    `ÏûêÏõê ÏÉùÏÇ∞ ${multText}`;
          return {
            ...it,
            label:`${title} / ${minText}`,
            onWin:()=>{ addTempBuff(it.bkind, it.bmult, it.bdur); }
          };
        }
        return it;
      });
    }
    function getItemsForMode(mode){
      const tpl = mode==='daily'   ? TPL_DAILY
               : mode==='premium' ? TPL_PREMIUM
               : mode==='ecoin'   ? TPL_ECOIN
               : TPL_PREMIUM;
      return materializeItems(tpl, mode);
    }

    function playSfx(id){
      const el=document.getElementById(id);
      if (el && el.play){
        el.currentTime=0; el.play().catch(()=>{});
        return;
      }
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='triangle';
        o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;
        g.gain.setValueAtTime(.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);
        o.start(); o.stop(ctx.currentTime+.08);
      }catch{}
    }
    function startTickLoop(intv=120){
      stopTickLoop();
      startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv);
    }
    function stopTickLoop(){
      if(startTickLoop._id){
        clearInterval(startTickLoop._id);
        startTickLoop._id=null;
      }
    }

    const slotWrap = document.getElementById('slot-wrap');
    const reel = document.getElementById('slot-reel');
    function buildSlot(items){
      const rows = items.map(it=>`
        <div class="slot-item"><span class="slot-icon">${it.icon||'üéÅ'}</span>${it.label||it.key}</div>
      `).join('');
      reel.innerHTML = rows.repeat(8);
      reel.style.transform = 'translateY(0px)';
      reel.style.transition = 'none';
    }

    let isSpinning = false;

    function spinSlot(items, picked){
      const rowH=56;
      const idx = Math.max(0, items.findIndex(it=>it.key===picked.key));
      const stopRow = (items.length*6) + (idx<0?0:idx);
      const targetY = - stopRow * rowH;
      startTickLoop(90);
      playSfx('sfx-start');
      return new Promise(resolve=>{
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';
            reel.style.transform = `translateY(${targetY}px)`;
          });
        });
        reel.ontransitionend = ()=>{
          reel.ontransitionend=null;
          stopTickLoop();
          playSfx('sfx-win');
          resolve();
        };
      });
    }

    const dailyOverlay = document.getElementById('daily-overlay');
    const dailyInfo    = document.getElementById('daily-info');
    const dailyCloseBtn= document.getElementById('daily-close');
    const probPanel    = document.getElementById('prob-panel');
    const probToggle   = document.getElementById('prob-toggle');
    const rewardList   = document.getElementById('reward-list');
    const tabs = Array.from(document.querySelectorAll('.tbtn'));
    const spinDailyBtn   = document.getElementById('spin-daily');
    const spinPremiumBtn = document.getElementById('spin-premium');
    const spinEcoinBtn   = document.getElementById('spin-ecoin');

    let dailyCache = null;
    let currentMode = 'daily';
    let activeItems = [];

    /* ====== Ïù¥Î≤§Ìä∏ Ïû†Í∏à(Ï∫îÏä¨) Ïú†Ìã∏ ====== */
    let eventLockUntil = 0;
    function isEventLocked(){ return Date.now() < eventLockUntil; }
    function cancelEvents(reason='Ïù¥Î≤§Ìä∏ ÏùºÏãú Ï§ëÏßÄ'){
      eventLockUntil = Date.now() + 5*60*1000; // 5Î∂Ñ Ïû†Í∏à
      try { showToast(`üéüÔ∏è ${reason} (5Î∂Ñ)`, null, null, 5000); } catch {}
      try {
        const info = document.getElementById('daily-info');
        if (info) info.innerHTML = '‚ö†Ô∏è ÏïàÏ†Ñ Ï†êÍ≤ÄÏúºÎ°ú Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
      } catch {}
      updateSpinButtons();
    }

    function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }
    function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }
    dailyCloseBtn.onclick = closeDailyOverlay;
    probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

    function setMode(mode){
      currentMode = mode;
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
      activeItems = getItemsForMode(mode);
      slotWrap.style.display     = 'flex';
      document.getElementById('spin-daily').style.display   = (mode==='daily')? 'inline-block':'none';
      document.getElementById('spin-premium').style.display = (mode==='premium')? 'inline-block':'none';
      document.getElementById('spin-ecoin').style.display   = (mode==='ecoin')? 'inline-block':'none';
      buildSlot(activeItems);
      buildProbPanel(activeItems, mode);
      buildRewardList(activeItems);
      updateSpinButtons();
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

    function buildProbPanel(items, mode){
      const total=items.reduce((a,b)=>a+b.w,0)||1;
      const rows=items.map(it=>`
        <tr>
          <td>${it.icon||''} ${it.label||it.key}</td>
          <td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td>
        </tr>
      `).join('');
      const header = mode==='daily' ? 'Ï∂úÏÑù Ïä¨Î°Ø ÌôïÎ•†'
                  : mode==='premium' ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø ÌôïÎ•†(EC -1)'
                  : 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø ÌôïÎ•†(EC -10)';
      probPanel.innerHTML = `
        <div style="margin-bottom:6px; color:#9fdcff;">${header}</div>
        <table>${rows}</table>
      `;
    }
    function buildRewardList(items){
      rewardList.innerHTML = 'üé∞ Î≥¥ÏÉÅ Î™©Î°ù: ' + items.map(it=>`${it.icon||''} ${it.label||it.key}`).join(' ¬∑ ');
    }
    function canClaimToday(){
      const today = kstDayKey();
      return dailyCache?.lastKey !== today;
    }
    function refreshDailyInfo(canClaim){
      const today = kstDayKey();
      const streak = dailyCache?.streak || 0;
      const resetLeft = Math.max(0, nextResetKST()-kstDate());
      const leftText = canClaim ? 'ÏßÄÍ∏à Í∞ÄÎä•' : `Îã§Ïùå Ï∂úÏÑùÍπåÏßÄ ${fmtLeft(resetLeft)}`;

      if (!dailyUnlocked){
        const need = Math.max(0, 100 - (state.coins||0));
        dailyInfo.innerHTML = `üîí Ï∂úÏÑù Î≥¥ÏÉÅÏùÄ <b>100ÏΩîÏù∏</b> Î™®ÏúºÎ©¥ Ìï¥Ï†ú!<br>ÎÇ®ÏùÄ ÏΩîÏù∏: <b>${formatKR(need)}</b>`;
        spinDailyBtn.disabled = true;
        return;
      }
      dailyInfo.innerHTML = canClaim
        ? `Ïò§Îäò(${today}) Ï∂úÏÑù Ïä¨Î°Ø Í∞ÄÎä•! <b>${leftText}</b><br>Ïó∞ÏÜç ${streak}Ïùº`
        : `Ïò§Îäò(${today})ÏùÄ Ïù¥ÎØ∏ ÏôÑÎ£å. <b>${leftText}</b><br>ÌòÑÏû¨ Ïó∞ÏÜç ${streak}Ïùº`;
      spinDailyBtn.disabled = !canClaim;
    }

    async function applyPrizeTransaction(delta){
      await runTransaction(dataRef, current => {
        const cur = current || { ...defaultData };
        const next = { ...cur };
        next.coins      = (next.coins||0) + (delta.coins||0);
        next.resources  = (next.resources||0) + (delta.resources||0);
        next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);
        next._lastUpdated = Date.now();
        return next;
      });
    }
    function makeDeltaSnapshot(){
      return {
        coins: state.coins||0,
        resources: state.resources||0,
        eventCoins: state.eventCoins||0
      };
    }
    function deltaFrom(before){
      return {
        coins: (state.coins||0) - before.coins,
        resources: (state.resources||0) - before.resources,
        eventCoins: (state.eventCoins||0) - before.eventCoins
      };
    }
    function pickWeighted(items){
      const s=items.reduce((a,b)=>a+b.w,0);
      let r=Math.random()*s;
      for(const it of items){
        if((r-=it.w)<=0) return it;
      }
      return items.at(-1);
    }
    function canSpendEC(n){ return (state.eventCoins||0) >= n; }

    /* üîÅ Î≤ÑÌäº ÏÉÅÌÉú(Ïû†Í∏à Ìè¨Ìï®) */
    function updateSpinButtons(){
      const locked = isEventLocked();
      const canDaily   = dailyUnlocked && canClaimToday() && !isSpinning;
      const canPremium = canSpendEC(1)  && !isSpinning;
      const canEcoin   = canSpendEC(10) && !isSpinning;

      spinDailyBtn.disabled   = locked || !canDaily;
      spinPremiumBtn.disabled = locked || !canPremium;
      spinEcoinBtn.disabled   = locked || !canEcoin;

      if (locked && dailyInfo){
        dailyInfo.innerHTML = '‚ö†Ô∏è ÏïàÏ†Ñ Ï†êÍ≤ÄÏúºÎ°ú Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
      }
    }

    async function tryUnlockDaily(){
      if (!uid || dailyUnlocked) return;
      if ((state.coins || 0) >= 100){
        dailyUnlocked = true;
        try {
          await update(ref(db), { [`${userBasePath}/daily/unlocked`]: true });
        } catch(e){ console.warn('unlock save error', e); }
        showToast('üîì Ï∂úÏÑù Î≥¥ÏÉÅ Ïû†Í∏à Ìï¥Ï†ú!', 'ÏßÄÍ∏à Ïó¥Í∏∞', () => {
          setMode('daily'); openDailyOverlay();
        });
        refreshDailyInfo(canClaimToday());
        updateAttendanceLabels();
        updateSpinButtons();
      }
    }

    async function handleSpin(mode){
      if (!uid || !window.__PLAY_ALLOWED || isSpinning) return;
      if (!security.tosAccepted){ showTosOverlay(true); return; }
      if (security.banned){ showBanOverlay(true); return; }

      if (isEventLocked()){
        dailyInfo.innerHTML = 'Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
        updateSpinButtons();
        return;
      }

      if (mode==='daily' && !dailyUnlocked) { refreshDailyInfo(false); return; }
      if (mode==='premium' && !canSpendEC(1)) { dailyInfo.innerHTML='Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî: 1)'; return; }
      if (mode==='ecoin'   && !canSpendEC(10)){ dailyInfo.innerHTML='Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. (ÌïÑÏöî: 10)'; return; }

      setMode(mode);
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();
      if (mode==='premium') { auditSpend('eco', 1);  state.eventCoins -= 1; }
      if (mode==='ecoin')   { auditSpend('eco', 10); state.eventCoins -= 10; }

      isSpinning = true; updateSpinButtons();
      await spinSlot(activeItems, picked);
      picked.onWin();

      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta); updateUI();
        if (mode==='daily'){
          const today = kstDayKey();
          const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));
          let streak = Number(dailyCache?.streak||0);
          if (dailyCache?.lastKey === yesterday) streak+=1; else streak=1;
          await update(ref(db), {
            [`${userBasePath}/daily`]: {
              ...(dailyCache||{}),
              unlocked: true,
              lastKey: today,
              streak,
              lastClaimAt: Date.now(),
              lastPrize: picked.key
            }
          });
          dailyCache = { ...(dailyCache||{}), lastKey: today, streak, unlocked:true };
          dailyInfo.innerHTML = `üéâ ÎãπÏ≤®: <b>${picked.label}</b><br>Ïó∞ÏÜç ${streak}Ïùº`;
        } else {
          dailyInfo.innerHTML = (mode==='premium')
            ? `üéâ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎãπÏ≤®: <b>${picked.label}</b>`
            : `üéâ EC Ïä¨Î°Ø ÎãπÏ≤®: <b>${picked.label}</b>`;
        }
      }catch(e){
        console.error(e);
        dailyInfo.textContent='Î≥¥ÏÉÅ ÏßÄÍ∏â Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      }finally{
        isSpinning = false; updateSpinButtons();
      }
    }

    document.getElementById('spin-daily').onclick   = ()=>handleSpin('daily');
    document.getElementById('spin-premium').onclick = ()=>handleSpin('premium');
    document.getElementById('spin-ecoin').onclick   = ()=>handleSpin('ecoin');

    async function fetchDaily(){
      if (!uid) return;
      try{
        const snap = await get(ref(db, `${userBasePath}/daily`));
        const v = snap.exists() ? snap.val() : { lastKey:null, streak:0, unlocked:false };
        dailyCache = v;
        dailyUnlocked = v?.unlocked ? true : false;
      }catch{
        dailyCache = { lastKey:null, streak:0, unlocked:false };
        dailyUnlocked = false;
      }
    }
    async function checkDailyAndMaybeShow(){
      await fetchDaily();
      refreshDailyInfo(canClaimToday());
      setMode('daily');
      if (dailyUnlocked && canClaimToday()) openDailyOverlay();
    }

    const attMenuRight = document.getElementById('attendance-left');
    const attSideRight = document.getElementById('attendance-left-side');
    function updateAttendanceLabels(){
      if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }
      if (!dailyUnlocked){ attMenuRight.textContent='Ïû†Í∏à'; attSideRight.textContent='Ïû†Í∏à'; return; }
      const today = kstDayKey();
      const can = (dailyCache?.lastKey !== today);
      if (can){
        attMenuRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•';
        attSideRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•';
      } else{
        const left = Math.max(0, nextResetKST()-kstDate());
        const txt = fmtLeft(left);
        attMenuRight.textContent=txt; attSideRight.textContent=txt;
      }
    }
    setInterval(updateAttendanceLabels, 1000);

    function setShipImage(level) {
      const img = document.getElementById('ship-img');
      if (!img) return;
      let attempted = Math.max(1, level);
      img.onerror = function onErr() {
        if (attempted > 1) {
          attempted -= 1;
          img.src = `/images/ship-level${attempted}.png`;
        } else {
          img.onerror = null;
          img.src = `/images/ship-level1.png`;
        }
      };
      img.src = `/images/ship-level${attempted}.png`;
    }

    const authContainer = document.getElementById('auth-container');
    const authErrorEl   = document.getElementById('auth-error');
    const bootOverlay   = document.getElementById('boot-overlay');

    // Î∂ÄÌåÖ Ïò§Î≤ÑÎ†àÏù¥Îäî 'Ï≤òÏùå 1Ìöå'Îßå
    function setBootVisible(v){
      if (!bootOverlay) return;
      const seen = localStorage.getItem('boot_seen') === '1';
      if (seen) {
        bootOverlay.style.display = 'none';
        bootOverlay.setAttribute('aria-hidden','true');
        return;
      }
      bootOverlay.style.display = v ? 'flex' : 'none';
      bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');
    }

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg || '';
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';
    }

    function showGameUI() {
      try {
        authContainer.classList.add('hidden');
        try { history.replaceState(null, '', '/Í≤åÏûÑ' + (location.hash || '')); } catch {}
        setTimeout(() => {
          authContainer.style.display = 'none';
          ['top-bar','container'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.visibility = 'visible';
          });
        }, 300);
      } catch (e) { console.error('showGameUI error', e); }
    }

    /* ===========================
       Î≥¥Ïïà/ÏïΩÍ¥Ä/ÏùòÏã¨ÎèÑ
       =========================== */
    let security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
    let securityDirty = false;

    // ÏûÑÍ≥ÑÍ∞í
    const SEC_WARN_LEVEL = 20;
    const SEC_BAN_LEVEL  = 30;

    const EPS               = 1e-6;
    const HUMAN_MAX_CPS     = 12;
    const MAX_TICK_GAP_MS   = 5000;
    const RES_WEIGHT        = 0.8;
    const COIN_WEIGHT       = 1.0;
    const ECO_WEIGHT        = 1.2;

    const BAN_SPIKE_COINS = 1_000_000_000;
    const BAN_SPIKE_RES   = 100_000_000;
    const BAN_SPIKE_ECO   = 50_000;

    function renderSecurityBadge(){
      const el = document.getElementById('suspicion-badge');
      if (!el) return;
      el.classList.remove('warn','ban');
      el.textContent = `ÏùòÏã¨ÎèÑ: ${Math.round(security.suspicion)}`;
      if (security.suspicion >= SEC_BAN_LEVEL){ el.classList.add('ban'); }
      else if (security.suspicion > SEC_WARN_LEVEL){ el.classList.add('warn'); }
    }
    function showTosOverlay(show=true){
      const ov = document.getElementById('tos-overlay');
      if (ov){
        ov.classList.toggle('show', !!show);
        ov.setAttribute('aria-hidden', show?'false':'true');
      }
    }
    function showBanOverlay(show=true){
      const ov = document.getElementById('ban-overlay');
      if (ov){
        document.getElementById('ban-sus-value').textContent = Math.round(security.suspicion || 0);
        ov.classList.toggle('show', !!show);
        ov.setAttribute('aria-hidden', show?'false':'true');
      }
    }
    function markTosViolationFlag(){
      const vio = security.suspicion > SEC_WARN_LEVEL || security.banned;
      if (security.tosViolated !== vio){
        security.tosViolated = vio;
        securityDirty = true;
      }
    }
    async function loadSecurity(){
      try {
        const snap = await get(ref(db, `${userBasePath}/security`));
        if (snap.exists()){
          const v = snap.val() || {};
          security = { ...security, ...v };
        }
      } catch {}
      markTosViolationFlag();
      await saveSecurity();
    }
    async function saveSecurity(){
      if (!uid || !userBasePath) return;
      if (!securityDirty) return;
      try {
        await update(ref(db), {
          [`${userBasePath}/security`]: {
            suspicion: security.suspicion,
            banned: security.banned,
            tosAccepted: security.tosAccepted,
            tosViolated: security.tosViolated,
            fairSeconds: security.fairSeconds,
            lastWarnAt: security.lastWarnAt
          }
        });
      } catch {}
      securityDirty = false;
    }

    const SUPPORT_CTX_KEY = 'siu_support_ctx';
    function saveSupportCtx(extra = {}) {
      const ctx = {
        server: userServerKey || null,
        idKey: userIdKey || null,
        basePath: userBasePath || null,
        uid: uid || null,
        suspicion: (security && typeof security.suspicion === 'number') ? security.suspicion : null,
        banned: !!(security && security.banned),
        ts: Date.now(),
        ...extra
      };
      try { localStorage.setItem(SUPPORT_CTX_KEY, JSON.stringify(ctx)); } catch {}
      return ctx;
    }
    function readSupportCtx() {
      try {
        const raw = localStorage.getItem(SUPPORT_CTX_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function clearSupportCtx(){
      try { localStorage.removeItem(SUPPORT_CTX_KEY); } catch {}
    }
    function hideAllOverlays(){
      try{ showBanOverlay(false); }catch{}
      try{ showTosOverlay(false); }catch{}
      try{ showMigrateOverlay(false); }catch{}
      try{
        const ov = document.getElementById('daily-overlay');
        if (ov){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const bov = document.getElementById('buff-overlay');
        if (bov){ bov.classList.remove('show'); bov.setAttribute('aria-hidden','true'); }
      }catch{}
    }

    // Ìï©Î≤ï Ï¶ùÍ∞ê Ïû•Î∂Ä
    let audit = {
      last: null,
      recGain:  { res:0, coin:0, eco:0 },
      recSpend: { res:0, coin:0, eco:0 },
      lastAt: 0
    };
    function auditInit(){
      audit.last   = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.lastAt = Date.now();
    }
    function auditGain(kind, amount){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recGain[k]) audit.recGain[k] = 0;
      audit.recGain[k] += Number(amount||0);
    }
    function auditSpend(kind, amount){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recSpend[k]) audit.recSpend[k] = 0;
      audit.recSpend[k] += Number(amount||0);
    }
    function auditAdd(kind, amount){ auditGain(kind, amount); }
    function auditResetCycle(){
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.last     = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.lastAt   = Date.now();
    }

    // ÏùòÎèÑ ÌóàÏö© Ï∞Ω
    let auditIntent = { res:0, coin:0, eco:0, until:0 };
    function registerAuditIntent(kind, amount, windowMs=6000){
      const now = Date.now();
      if (auditIntent.until < now) auditIntent = { res:0, coin:0, eco:0, until: now + windowMs };
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      auditIntent[k] = (auditIntent[k] || 0) + Math.max(0, Number(amount||0));
      auditIntent.until = Math.max(auditIntent.until, now + windowMs);
    }

    // BAN ÏóîÎìúÌè¨Ïù∏Ìä∏
    let __BAN_ENDPOINT = null;
    async function __getBanEndpoint() {
      if (__BAN_ENDPOINT) return __BAN_ENDPOINT;
      try {
        const snap = await get(ref(db, 'meta/banEndpoint'));
        if (snap.exists()) __BAN_ENDPOINT = String(snap.val());
      } catch {}
      return __BAN_ENDPOINT;
    }
    async function requestAccountDisable(reason = 'auto-ban') {
      try {
        const url = await __getBanEndpoint();
        if (!url || !auth?.currentUser) return;
        const idToken = await auth.currentUser.getIdToken(true);
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            idToken,
            reason,
            suspicion: security?.suspicion ?? null
          })
        });
      } catch (e) { console.warn('ban endpoint failed', e); }
    }

    function expectedResGain(dtSec){
      const resBuff = activeBuffFactor('res');
      const workerGain = (state.workerCount * getWorkerPower()) * resBuff * dtSec;
      const clickGain  = (state.clickPower || 1) * HUMAN_MAX_CPS * resBuff * dtSec;
      return workerGain + clickGain + 0.5;
    }
    function expectedCoinGain(dtSec){
      const coinBuff = activeBuffFactor('coin');
      const convGain = (state.conversionCount || 0) * coinBuff * dtSec;
      return convGain + 2;
    }

    function adjustSuspicion(delta){
      const prev = security.suspicion;
      security.suspicion = Math.max(0, Math.min(1000, prev + delta));

      if (!security.banned && security.suspicion > SEC_WARN_LEVEL){
        const now = Date.now();
        if (!security.lastWarnAt || now - security.lastWarnAt > 60000){
          security.lastWarnAt = now;
          showToast('‚ö†Ô∏è ÏùòÏã¨ÎèÑÍ∞Ä 20ÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§. ÎπÑÏ†ïÏÉÅ Ï¶ùÍ∞ÄÍ∞Ä ÌÉêÏßÄÎêòÎ©¥ Ï†ïÏßÄÎê† Ïàò ÏûàÏñ¥Ïöî.');
          securityDirty = true;
        }
      }

      if (security.suspicion >= SEC_BAN_LEVEL && !security.banned){
        security.banned = true;
        securityDirty = true;
        requestAccountDisable('auto-ban:suspicion>=30').finally(async ()=>{
          showBanOverlay(true);
          showToast('‚õî ÏùòÏã¨ÎèÑ 30 Ïù¥ÏÉÅÏúºÎ°ú Í≥ÑÏ†ïÏù¥ Ï†ïÏßÄÎêòÏóàÏäµÎãàÎã§.');
          try { await saveSecurity(); } catch {}
          saveSupportCtx({ banned: true });
          try { await auth.signOut(); } catch {}
        });
      }

      markTosViolationFlag();
      securityDirty = true;
      renderSecurityBadge();
    }

    function auditCheck(){
      const nowGlobal = Date.now();

      // Ï≤òÏùå 3Ï¥àÎäî Í≤ÄÏÇ¨ X
      if (nowGlobal - AUDIT_BOOT_TS < AUDIT_INITIAL_SKIP_MS) {
        auditResetCycle();
        return;
      }

      if (!audit.last){ auditInit(); return; }
      let dtMs = nowGlobal - (audit.lastAt || nowGlobal);
      if (dtMs < 0) dtMs = 0;
      if (dtMs > MAX_TICK_GAP_MS) dtMs = MAX_TICK_GAP_MS;
      const dtSec = dtMs / 1000;

      const cur = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      let dr = cur.res   - audit.last.res;
      let dc = cur.coins - audit.last.coins;
      let de = cur.eco   - audit.last.eco;

      if (nowGlobal <= (auditIntent.until||0)) {
        const useRes = Math.min(Math.max(0, dr), auditIntent.res||0);
        const useCoin= Math.min(Math.max(0, dc), auditIntent.coin||0);
        const useEco = Math.min(Math.max(0, de), auditIntent.eco||0);
        dr -= useRes; dc -= useCoin; de -= useEco;
        auditIntent.res  -= useRes;
        auditIntent.coin -= useCoin;
        auditIntent.eco  -= useEco;
      } else {
        auditIntent = { res:0, coin:0, eco:0, until:0 };
      }

      // ÏïÑÏ£º ÌÅ∞ Ïä§ÌååÏù¥ÌÅ¨Îäî Î∞îÎ°ú Ï†ïÏßÄ
      if (dc >= BAN_SPIKE_COINS || dr >= BAN_SPIKE_RES || de >= BAN_SPIKE_ECO) {
        adjustSuspicion(SEC_BAN_LEVEL + 1);
        auditResetCycle();
        return;
      }

      const legRes  = (audit.recGain.res  - audit.recSpend.res);
      const legCoin = (audit.recGain.coin - audit.recSpend.coin);
      const legEco  = (audit.recGain.eco  - audit.recSpend.eco);

      const physResRoom  = expectedResGain(dtSec);
      const physCoinRoom = expectedCoinGain(dtSec);

      const unknownRes  = Math.max(0, dr - legRes);
      const unknownCoin = Math.max(0, dc - legCoin);
      const unknownEco  = Math.max(0, de - legEco);

      const spikeRes  = Math.max(0, dr - (legRes  + physResRoom));
      const spikeCoin = Math.max(0, dc - (legCoin + physCoinRoom));

      // Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÎπÑÏ†ïÏÉÅ Ï¶ùÍ∞ÄÎäî Î°§Î∞±+Ïù¥Î≤§Ìä∏ Ïû†Í∏à
      if (unknownEco > EPS) {
        const rollback = Math.min(Math.floor(unknownEco), Math.floor(state.eventCoins || 0));
        if (rollback > 0) {
          state.eventCoins -= rollback;
          save(); updateUI();
        }
        cancelEvents('ÎπÑÏ†ïÏÉÅ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ï¶ùÍ∞Ä Í∞êÏßÄ');
      }

      const mag = Math.log10(1
        + unknownRes
        + (unknownCoin * 10)
        + (unknownEco  * 20)
        + spikeRes
        + (spikeCoin * 10)
      );

      const ratioRes  = physResRoom  > 0 ? (dr - legRes) / physResRoom   : 0;
      const ratioCoin = physCoinRoom > 0 ? (dc - legCoin) / physCoinRoom : 0;
      const ratioBoost = Math.max(0, ratioRes - 1) + Math.max(0, ratioCoin - 1);

      const baseUnknown =
        (unknownRes  > EPS ? unknownRes  * RES_WEIGHT  : 0) +
        (unknownCoin > EPS ? unknownCoin * COIN_WEIGHT : 0) +
        (unknownEco  > EPS ? unknownEco  * ECO_WEIGHT  : 0);

      const baseSpike =
        (spikeRes  > EPS ? spikeRes  * 1.6 : 0) +
        (spikeCoin > EPS ? spikeCoin * 1.6 : 0);

      let score = (baseUnknown + baseSpike) * (1 + 0.6*mag + 0.8*ratioBoost);

      if (score > 0.05){
        const add = Math.min(24, Math.max(2, Math.ceil(score)));
        adjustSuspicion(add);
        security.fairSeconds = 0;
        securityDirty = true;
      } else {
        security.fairSeconds = (security.fairSeconds||0) + dtSec;
        if (security.fairSeconds >= 90 && security.suspicion > 0){
          adjustSuspicion(-1);
          security.fairSeconds = 0;
        }
        securityDirty = true;
      }

      auditResetCycle();
    }

    function buildSupportInfoText(){
      const persisted = readSupportCtx();
      const server = userServerKey || persisted?.server || '(Ïïå Ïàò ÏóÜÏùå)';
      const idKey  = userIdKey     || persisted?.idKey  || '(Ïïå Ïàò ÏóÜÏùå)';
      const path   = userBasePath  || persisted?.basePath || '(Ïïå Ïàò ÏóÜÏùå)';
      const nowKST = kstDate().toLocaleString('ko-KR');
      const uidStr = uid || persisted?.uid || '(ÎØ∏Î°úÍ∑∏Ïù∏)';
      const sus    = (typeof security?.suspicion === 'number') ? security.suspicion
                : (typeof persisted?.suspicion === 'number') ? persisted.suspicion : null;
      return [
        `ÏÑúÎ≤Ñ: ${server}`,
        `ÏïÑÏù¥ÎîîÌÇ§: ${idKey}`,
        `Realtime DB Í≤ΩÎ°ú: ${path}`,
        `UID: ${uidStr}`,
        `ÌòÑÏû¨ ÏùòÏã¨ÎèÑ: ${sus === null ? '(Ïïå Ïàò ÏóÜÏùå)' : sus}`,
        `Î∞úÏÉù ÏãúÍ∞Å(KST): ${nowKST}`
      ].join('\n');
    }
    function buildSupportMail(){
      const persisted = readSupportCtx();
      const s = userServerKey || persisted?.server || 'server?';
      const i = userIdKey     || persisted?.idKey  || 'id?';
      const subject = `[Appeal] Ïò§ÌÉê Í≤ÄÌÜ† ÏöîÏ≤≠ - ${s} / ${i}`;
      const header  = 'ÏïàÎÖïÌïòÏÑ∏Ïöî, Ïò§ÌÉêÏúºÎ°ú ÏùòÏã¨ÎêòÏñ¥ Í≤ÄÌÜ†Î•º ÏöîÏ≤≠ÎìúÎ¶ΩÎãàÎã§.\n';
      const info    = buildSupportInfoText();
      const footer  = '\n\nÏÉÅÏÑ∏ ÏÉÅÌô©:\n(Ïó¨Í∏∞Ïóê ÏÉÅÌô©ÏùÑ ÏûêÏÑ∏Ìûà Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî)\n';
      const body    = `${header}\n${info}${footer}`;
      const mailto  = `mailto:${SUPPORT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { subject, body, mailto };
    }
    async function copySupportInfo(){
      try {
        await navigator.clipboard.writeText(buildSupportInfoText());
        showToast('Î≥µÏÇ¨ ÏôÑÎ£å! Î©îÏùºÏóê Î∂ôÏó¨ÎÑ£Ïñ¥ Î≥¥ÎÇº Ïàò ÏûàÏñ¥Ïöî.', null, null, 2500);
      } catch {
        showToast('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', null, null, 2500);
      }
    }

    function updateUI() {
      pruneExpiredBuffs();
      document.getElementById('score').innerText  = `ÏûêÏõê: ${formatKR(state.resources)}`;
      document.getElementById('coins').innerText  = `ÏΩîÏù∏: ${formatKR(state.coins)}`;
      document.getElementById('ecoins').innerText = `Ïù¥Î≤§Ìä∏ÏΩîÏù∏: ${formatKR(state.eventCoins||0)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}Î†ô (${formatKR(state.shipUpgradeCost)}ÏΩîÏù∏)`;
      setShipImage(state.shipLevel);
      document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

      const clickUp = document.getElementById('click-upgrade');
      clickUp.innerText = `ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (${formatKR(clickUpgradeCost)}ÏΩîÏù∏)`; 
      clickUp.disabled  = state.coins < clickUpgradeCost;
      document.getElementById('click-power').innerText = Math.round(state.clickPower).toString();

      const autoBtn = document.getElementById('auto-convert-buy');
      autoBtn.innerHTML = state.autoConvertBought ? 'Íµ¨Îß§ ÏôÑÎ£å' : `ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(${formatKR(100)}ÏΩîÏù∏)`;
      autoBtn.disabled = state.autoConvertBought || state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ÏïåÎ∞î Í≥†Ïö© (${formatKR(getWorkerCost())}ÏΩîÏù∏)`;
      hireWork.disabled = state.coins < getWorkerCost();
      document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower() * activeBuffFactor('res')).toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ÏΩîÏù∏ ÏïåÎ∞î (${formatKR(getConversionCost())}ÏΩîÏù∏)`;
      hireConv.disabled = state.coins < getConversionCost();
      document.getElementById('coin-per-sec').innerText = (state.conversionCount * activeBuffFactor('coin')).toFixed(1);

      renderSecurityBadge();
      tryUnlockDaily();
      renderBuffStatus();

      try {
        if (uid) {
          const cachePick = {
            resources: state.resources,
            coins: state.coins,
            eventCoins: state.eventCoins,
            clickPower: state.clickPower,
            shipLevel: state.shipLevel,
            shipUpgradeCost: state.shipUpgradeCost,
            workerCount: state.workerCount,
            conversionCount: state.conversionCount,
            autoConvertBought: state.autoConvertBought,
            ownedPlanets: state.ownedPlanets
          };
          localStorage.setItem(`gd_cache_${uid}`, JSON.stringify(cachePick));
        }
      } catch {}
    }

    function renderPlanets() {
      const planets = [
        {name:'Îã¨',cost:100,requiredShipLevel:1},
        {name:'ÏàòÏÑ±',cost:500,requiredShipLevel:2},
        {name:'Í∏àÏÑ±',cost:2000,requiredShipLevel:3},
        {name:'ÏßÄÍµ¨',cost:10000,requiredShipLevel:4},
        {name:'ÌôîÏÑ±',cost:50000,requiredShipLevel:5},
        {name:'Î™©ÏÑ±',cost:250000,requiredShipLevel:6},
        {name:'ÌÜ†ÏÑ±',cost:1000000,requiredShipLevel:7},
        {name:'Ï≤úÏôïÏÑ±',cost:5000000,requiredShipLevel:8},
        {name:'Ìï¥ÏôïÏÑ±',cost:20000000,requiredShipLevel:9}
      ];
      const list = document.getElementById('planet-list');
      list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.style.margin='10px 0';
        div.innerHTML = `<strong>${p.name}</strong> ‚Äî ${formatKR(p.cost)}ÏΩîÏù∏<br>ÌïÑÏöî Î†ô: ${p.requiredShipLevel}`;
        const btn = document.createElement('button');
        btn.className='general';
        btn.textContent = owned ? 'Íµ¨Îß§ ÏôÑÎ£å' : (canBuy ? 'Íµ¨Îß§' : 'Î†ô Î∂ÄÏ°±');
        btn.disabled = owned || !canBuy;
        btn.onclick = async () => {
          if (!ensureReady()) return;
          if (state.coins >= p.cost) {
            state.coins -= p.cost;
            auditSpend('coin', p.cost);
            if (!state.ownedPlanets) state.ownedPlanets = [];
            state.ownedPlanets.push(i);
            save(); updateUI(); renderPlanets();
            if (p.name === 'ÌôîÏÑ±' && !rankingUnlocked) {
              rankingUnlocked = true;
              try { await update(ref(db), { [`${userBasePath}/meta/rankingUnlocked`]: true }); } catch{}
              showToast('üèÜ Îû≠ÌÇπ Ïû†Í∏à Ìï¥Ï†ú!', 'Î∞îÎ°ú Í∞ÄÍ∏∞', ()=>{ location.href='/ranking.html'; });
            }
            if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';
          }
        };
        div.appendChild(btn);
        list.appendChild(div);
      });
    }

    function spawnParticles(x,y) {
      for (let i=15;i>0;i--){
        const span = document.createElement('span');
        span.className='particle';
        span.style.setProperty('--dx',(Math.random()-0.5)*100+'px');
        span.style.setProperty('--dy',(Math.random()-1)*100+'px');
        span.style.left = x+'px'; span.style.top = y+'px';
        document.getElementById('ore-container').appendChild(span);
        setTimeout(()=>span.remove(),800);
      }
    }

    function ensureReady() {
      if (!window.__PLAY_ALLOWED) { showAuthStatus('PCÏóêÏÑúÎäî ÌåùÏóÖÏúºÎ°úÎßå Ïã§ÌñâÎê©ÎãàÎã§. ÌåùÏóÖÏúºÎ°ú Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.'); return false; }
      if (!uid) { showAuthStatus('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.'); return false; }
      if (isInitialSync) { showAuthStatus('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.'); return false; }
      if (!security.tosAccepted){ showTosOverlay(true); showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùòÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', true); return false; }
      if (security.banned){ showBanOverlay(true); showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞ò ÏùòÏã¨(Í≥ÑÏ†ï Ï†ïÏßÄ)ÏúºÎ°ú ÌîåÎ†àÏù¥Í∞Ä Ï†úÌïúÎêòÏóàÏäµÎãàÎã§.', true); return false; }
      showAuthStatus('');
      return true;
    }

    function wireGame() {
      document.getElementById('ore').addEventListener('click', e => {
        if (!uid || isInitialSync || !window.__PLAY_ALLOWED) return;
        if (security.banned){ showBanOverlay(true); return; }

        if (!ensureReady()) return;
        const rect = e.target.getBoundingClientRect();
        spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
        const resMul = activeBuffFactor('res');
        const inc = state.clickPower * resMul;
        state.resources += inc;
        auditAdd('res', inc);
        if (state.autoConvertBought) convertResources();
        save(); updateUI();
      });
      document.getElementById('convert-button').addEventListener('click', () => {
        if (!ensureReady()) return;
        convertResources(1); save(); updateUI();
      });
      document.getElementById('auto-convert-buy').addEventListener('click', () => {
        if (!ensureReady()) return;
        if (!state.autoConvertBought && state.coins >= 100) {
          state.coins -= 100;
          auditSpend('coin', 100);
          state.autoConvertBought = true;
          save(); updateUI();
        }
      });
      document.getElementById('hire-worker').addEventListener('click', () => {
        if (!ensureReady()) return;
        const cost = getWorkerCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          state.workerCount++;
          save(); updateUI();
        }
      });
      document.getElementById('hire-conversion').addEventListener('click', () => {
        if (!ensureReady()) return;
        const cost = getConversionCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          state.conversionCount++;
          save(); updateUI();
        }
      });
      document.getElementById('upgrade-ship').addEventListener('click', () => {
        if (!ensureReady()) return;
        if (state.coins >= state.shipUpgradeCost) {
          const cost = state.shipUpgradeCost;
          state.coins -= cost;
          auditSpend('coin', cost);
          state.shipLevel++;
          state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30);
          save(); updateUI(); renderPlanets();
        }
      });

      document.getElementById('click-upgrade').addEventListener('click', () => {
        if (!ensureReady()) return;
        if (state.coins >= clickUpgradeCost){
          state.coins -= clickUpgradeCost;
          auditSpend('coin', clickUpgradeCost);
          state.clickPower = (state.clickPower||1) + 1;
          save(); updateUI();
        }
      });

      document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }));

      // Î≤ÑÌîÑ Î≤ÑÌäº
      const buffBtn = document.getElementById('buff-btn');
      const buffOv  = document.getElementById('buff-overlay');
      const buffClose = document.getElementById('buff-close');
      if (buffBtn && buffOv) {
        buffBtn.addEventListener('click', ()=>{
          renderBuffStatus();
          buffOv.classList.add('show');
          buffOv.setAttribute('aria-hidden','false');
        });
      }
      if (buffClose && buffOv) {
        buffClose.addEventListener('click', ()=>{
          buffOv.classList.remove('show');
          buffOv.setAttribute('aria-hidden','true');
        });
      }

      // Î©îÏù∏ Î£®ÌîÑ 1Ï¥à
      window.__gameTimer = setInterval(async () => {
        if (!uid || isInitialSync) return;

        if (window.__PLAY_ALLOWED && !security.banned) {
          pruneExpiredBuffs();

          // ÏûêÏõê ÏïåÎ∞î
          let workerGain = state.workerCount * getWorkerPower() * activeBuffFactor('res');
          if (state.workerCount > 0) {
            state.resources += workerGain;
            auditAdd('res', workerGain);
          }

          // ÏΩîÏù∏ ÏïåÎ∞î
          let convGain = state.conversionCount * activeBuffFactor('coin');
          if (state.conversionCount > 0) {
            state.coins += convGain;
            auditAdd('coin', convGain);
          }

          // ÏûêÎèô Î≥ÄÌôò
          if (state.autoConvertBought) convertResources();
        }

        // 1Ï¥àÎßàÎã§ ÏùòÏã¨ÎèÑ Í≤ÄÏÇ¨
        auditCheck();
        await saveSecurity();

        if (window.__PLAY_ALLOWED) {
          save();
          updateUI();
        }
      }, 1000);
    }

    /* ======================
       Ïù∏Ï¶ù/Î∂ÄÌåÖ ÌùêÎ¶Ñ
       ====================== */
    const tabLogin  = document.getElementById('auth-tab-login');
    const tabSignup = document.getElementById('auth-tab-signup');
    const signupExtra = document.getElementById('signup-extra');
    const loginBtn  = document.getElementById('login-btn');
    const signupBtnEl = document.getElementById('signup-btn');

    let currentAuthMode = 'login';
    function setAuthMode(mode) {
      currentAuthMode = (mode === 'signup') ? 'signup' : 'login';
      if (mode === 'signup') {
        tabLogin.classList.remove('active'); tabSignup.classList.add('active');
        signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';
        signupBtnEl.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ(Ïù∏Ï¶ù Î©îÏùº Î≥¥ÎÇ¥Í∏∞)';
      } else {
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';
      }
      showAuthStatus('');
      document.getElementById('verify-info').textContent = '';
      try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}
    }

    tabLogin.addEventListener('click',  () => { hideAllOverlays(); setAuthMode('login');  showAuthStatus(''); });
    tabSignup.addEventListener('click', () => { hideAllOverlays(); setAuthMode('signup'); showAuthStatus(''); });

    document.getElementById('settings-btn').addEventListener('click', () => {
      try { history.replaceState(null, '', '/ÏÑ§Ï†ï' + (location.hash || '')); } catch {}
      location.href = '/setting.html';
    });

    function handleAuthError(err) {
      const code = err?.code || '';
      if (code === 'auth/user-disabled') {
        security.banned = true;
        securityDirty = true;
        showAuthStatus('‚õî Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞òÏúºÎ°ú Í≥ÑÏ†ïÏù¥ Ï†ïÏßÄÎêòÏóàÏäµÎãàÎã§. Ïò§ÌÉêÏúºÎ°ú ÏùòÏã¨ÎêòÎ©¥ appeals@siustudio.kro.kr Î°ú Î©îÏùºÏùÑ Î≥¥ÎÇ¥ Ï£ºÏÑ∏Ïöî.', true);
        try { saveSupportCtx({ banned: true }); } catch {}
        return true;
      }
      return false;
    }

    loginBtn.addEventListener('click', async () => {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const isPasswordProvider = user && user.providerData.some(p=>p.providerId==='password');

        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('üìß Ïù¥Î©îÏùº Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ïïº Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏûàÏñ¥Ïöî. Î∞õÏùÄ Î©îÏùºÏùò ÎßÅÌÅ¨Î°ú Ïù∏Ï¶ùÌïú Îí§ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', true);
          try { await auth.signOut(); } catch {}
          return;
        }
      } catch (err) {
        if (!handleAuthError(err)) {
          const code = (err && err.code) || '';
          const msg =
            (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials')
              ? 'ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.' :
            code === 'auth/user-not-found'         ? 'Îì±Î°ùÎêú Í≥ÑÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§. ÌöåÏõêÍ∞ÄÏûÖÏùÑ Î®ºÏ†Ä ÏßÑÌñâÌïòÏÑ∏Ïöî.' :
            code === 'auth/invalid-email'          ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
            code === 'auth/network-request-failed' ? 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.' :
            'Î°úÍ∑∏Ïù∏ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§. ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî';
          showAuthStatus(msg);
        }
      }
    });

    /* ========= Ïù¥Î©îÏùº ÎßÅÌÅ¨ ÌöåÏõêÍ∞ÄÏûÖ ========= */
    let __emailLinkMode = false;

    async function beginEmailLinkSignup() {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const agree = document.getElementById('tos-checkbox')?.checked;

      if (!email) { showAuthStatus('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      if (!agree) { showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï¥Ïïº ÌöåÏõêÍ∞ÄÏûÖ Í∞ÄÎä•Ìï©ÎãàÎã§.'); return; }

      try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        try { localStorage.setItem('signupEmail', email); } catch {}
        showAuthStatus('üìß Ïù∏Ï¶ù Î©îÏùºÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Î©îÏùºÏùò ÎßÅÌÅ¨Î•º ÎàÑÎ•¥Î©¥ Í∞ÄÏûÖÏù¥ ÏôÑÎ£åÎê©ÎãàÎã§.', false);
        document.getElementById('password')?.setAttribute('disabled','true');
        document.getElementById('password-confirm')?.setAttribute('disabled','true');
        signupBtnEl.textContent = 'Î©îÏùº Ï†ÑÏÜ°Îê® ‚Äì ÎßÅÌÅ¨Î°ú ÎèåÏïÑÏò§Î©¥ ÎπÑÎ≤à ÏÑ§Ï†ï';
      } catch (err) {
        const code = err?.code || '';
        const msg =
          code === 'auth/invalid-email' ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
          code === 'auth/missing-android-pkg-name' || code === 'auth/missing-continue-uri' || code === 'auth/unauthorized-continue-uri'
            ? 'Ïù∏Ï¶ù ÎßÅÌÅ¨ ÏÑ§Ï†ïÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. ÏΩòÏÜîÏùò Authorized domainsÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.' :
          'Ïù∏Ï¶ù Î©îÏùº Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
        showAuthStatus(msg);
      }
    }

    async function completeEmailLinkIfNeeded() {
      if (!isSignInWithEmailLink(auth, window.location.href)) return;
      __emailLinkMode = true;
      setAuthMode('signup');
      document.getElementById('auth-title').textContent = 'Ïù¥Î©îÏùº ÌôïÏù∏Îê® ‚Äì ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï';
      document.getElementById('password')?.removeAttribute('disabled');
      document.getElementById('password-confirm')?.removeAttribute('disabled');
      document.getElementById('signup-extra').style.display = 'block';
      signupBtnEl.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï ÏôÑÎ£åÌïòÍ∏∞';

      let email = null;
      try { email = localStorage.getItem('signupEmail'); } catch {}
      if (!email) email = prompt('Í∞ÄÏûÖÏóê ÏÇ¨Ïö©Ìïú Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî') || '';
      email = email.trim();
      if (!email) { showAuthStatus('Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'); return; }

      try {
        await signInWithEmailLink(auth, email, window.location.href);
        try { localStorage.setItem('signupEmail', email); } catch {}
        showAuthStatus('‚úÖ Ïù¥Î©îÏùº Ïù∏Ï¶ù ÏôÑÎ£å! Ïù¥Ï†ú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.', false);
      } catch (err) {
        const code = err?.code || '';
        const msg =
          code === 'auth/invalid-action-code' ? 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎßÅÌÅ¨ÏûÖÎãàÎã§. Îã§Ïãú ÏöîÏ≤≠Ìï¥ Ï£ºÏÑ∏Ïöî.' :
          code === 'auth/expired-action-code' ? 'ÎßÅÌÅ¨ Ïú†Ìö®Í∏∞Í∞ÑÏù¥ ÏßÄÎÇ¨ÏäµÎãàÎã§. Îã§Ïãú ÏöîÏ≤≠Ìï¥ Ï£ºÏÑ∏Ïöî.' :
          'ÎßÅÌÅ¨ ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
        showAuthStatus(msg);
      }
    }

    async function finalizePassword() {
      const email = (localStorage.getItem('signupEmail') || '').trim();
      const pw  = document.getElementById('password').value;
      const pw2 = document.getElementById('password-confirm').value;

      if (!pw || !pw2) { showAuthStatus('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      if (pw !== pw2)   { showAuthStatus('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.'); return; }
      if (!auth.currentUser) { showAuthStatus('ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. ÎßÅÌÅ¨Î•º Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.'); return; }

      try {
        await linkWithCredential(auth.currentUser, EmailAuthProvider.credential(email, pw));
        showAuthStatus('üîê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï ÏôÑÎ£å! Ïù¥Ï†ú Î°úÍ∑∏Ïù∏ ÌÉ≠ÏóêÏÑú Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.', false);
        await auth.signOut();
        setAuthMode('login');
      } catch (err) {
        const code = err?.code || '';
        const msg =
          code === 'auth/provider-already-linked' ? 'Ïù¥ÎØ∏ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ§Ï†ïÎêú Í≥ÑÏ†ïÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏Ìï¥ Ï£ºÏÑ∏Ïöî.' :
          code === 'auth/credential-already-in-use' ? 'Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ ÏûêÍ≤©Ï¶ùÎ™ÖÏûÖÎãàÎã§.' :
          code === 'auth/weak-password' ? 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÎÑàÎ¨¥ ÏïΩÌï©ÎãàÎã§.' :
          'ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
        showAuthStatus(msg);
      }
    }

    signupBtnEl?.addEventListener('click', async (e) => {
      e.preventDefault();
      if (__emailLinkMode) {
        finalizePassword();
      } else {
        beginEmailLinkSignup();
      }
    });

    // TOS ÎèôÏùò
    const tosAgree = document.getElementById('tos-agree');
    const tosAccept = document.getElementById('tos-accept');
    tosAgree?.addEventListener('change', ()=>{ tosAccept.disabled = !tosAgree.checked; });
    tosAccept?.addEventListener('click', async ()=>{
      security.tosAccepted = true; securityDirty = true;
      await saveSecurity();
      showTosOverlay(false);
      showToast('‚úÖ Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÎêòÏóàÏäµÎãàÎã§. Í≥µÏ†ïÌïú ÌîåÎ†àÏù¥Î•º Î∂ÄÌÉÅÎìúÎ†§Ïöî!', null, null, 3500);
    });

    // Ï†ïÏßÄ Ïò§Î≤ÑÎ†àÏù¥ Î≤ÑÌäºÎì§
    document.getElementById('ban-ok')?.addEventListener('click', ()=> showBanOverlay(false));
    document.getElementById('ban-appeal-email')?.addEventListener('click', ()=>{
      const { mailto } = buildSupportMail();
      location.href = mailto;
    });
    document.getElementById('ban-copy-info')?.addEventListener('click', copySupportInfo);

    // Ï†ïÍ∏∞ ÌÜ†ÌÅ∞ ÌôïÏù∏
    setInterval(async () => {
      try {
        if (auth?.currentUser) {
          await auth.currentUser.getIdToken(true);
        }
      } catch (err) {
        if (handleAuthError(err)) {
          try { await auth.signOut(); } catch {}
        }
      }
    }, 30000);

    // Îç∞Ïù¥ÌÑ∞ Î∞îÏù∏Îî©
    async function proceedWithDataBinding(){
      try {
        const rankSnap = await get(ref(db, `${userBasePath}/meta/rankingUnlocked`));
        rankingUnlocked = !!(rankSnap.exists() ? rankSnap.val() : false);
      } catch { rankingUnlocked = false; }

      dataRef = ref(db, `${userBasePath}/gameData`);
      isInitialSync = true;
      try {
        const saved = localStorage.getItem(`lastWrite_${uid}`);
        localLastWrite = saved ? parseInt(saved, 10) : 0;
      } catch { localLastWrite = 0; }

      await ensureInitialData(dataRef);
      await loadSecurity();

      saveSupportCtx({ banned: false });

      const syncStart = Date.now();
      initialSyncStart = syncStart;

      dataUnsubscribe = onValue(dataRef, async snap => {
        const server = snap.exists() ? snap.val() : null;
        const loadTime = Date.now() - syncStart;

        if (loadTime > 3000 && !networkUnstableShown) {
          networkUnstableShown = true;
        }

        if (isInitialSync) {
          state = { ...defaultData, ...(server || {}) };
          await fetchDaily();

          if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
          isInitialSync = false;
          showGameUI();

          try { localStorage.setItem('boot_seen', '1'); } catch {}

          window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();
          await checkDailyAndMaybeShow();
          updateAttendanceLabels();
          bootDone = true;
          auditInit();
          renderSecurityBadge();

          if (!security.tosAccepted){ showTosOverlay(true); }
          if (security.banned){ showBanOverlay(true); }
          return;
        }

        if (!server) {
          state = { ...defaultData };
        } else {
          const serverLast = server._lastUpdated || 0;
          if (serverLast >= (localLastWrite || 0)) {
            state = { ...defaultData, ...server };
          } else {
            // ÏñëÏ™Ω ÏàòÏ†ï Ï∂©Îèå Ïãú Î°úÏª¨ Ïö∞ÏÑ†ÏúºÎ°ú Î≥ëÌï©
            state = { ...defaultData, ...server, ...state };
            try {
              if (JSON.stringify(server) !== JSON.stringify(state)) save();
            } catch {
              save();
            }
          }
        }
        if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
      });
    }

    onAuthStateChanged(auth, async user => {
      hideAllOverlays();
      setBootVisible(false);
      showAuthStatus('');
      if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }

      if (user) {
        clearSupportCtx();
        hideAllOverlays();
        security.banned = false;

        const isPasswordProvider = (user.providerData || []).some(p => p.providerId === 'password');
        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('üìß Ïù¥Î©îÏùº Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ïïº Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏûàÏñ¥Ïöî. Î∞õÏùÄ Î©îÏùºÏùò ÎßÅÌÅ¨Î°ú Ïù∏Ï¶ùÌïú Îí§ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', true);
          try { await auth.signOut(); } catch {}
          return;
        }

        uid = user.uid;
        loadBuffs();
        renderBuffStatus();

        try {
          const cacheRaw = localStorage.getItem(`gd_cache_${uid}`);
          if (cacheRaw) {
            const cached = JSON.parse(cacheRaw);
            state = { ...defaultData, ...state, ...cached };
            showGameUI();
            updateUI();
            renderPlanets();
            bootDone = true;
          }
        } catch {}

        let plan = null;
        try {
          plan = await planMigrationForUser(user);
        } catch(e){
          console.error('planMigration error', e);
          const fallbackServer = await allocateServerForUser();
          userServerKey = fallbackServer;
          userIdKey     = makeIdKeyFromUser(user);
          userBasePath  = `users/${userServerKey}/${userIdKey}`;
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: 'plan-error-fallback'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
          return;
        }
        userServerKey = plan.server;
        userIdKey     = makeIdKeyFromUser(user);
        userBasePath  = `users/${userServerKey}/${userIdKey}`;

        saveSupportCtx({ banned: false });

        if (plan.need) {
          showMigrateOverlay(true, 'ÎåÄÍ∏∞ Ï§ë‚Ä¶');
          disableMigrateStart(false);
          const startBtn = document.getElementById('migrate-start');
          if (startBtn){
            startBtn.onclick = async ()=>{
              disableMigrateStart(true);
              try{
                await performMigration(plan.srcBasePath, plan.destBasePath, user);
                try {
                  await update(ref(db), {
                    [`userServerMap/${uid}`]: {
                      server: userServerKey,
                      id: userIdKey,
                      displayId: String(user?.email||'') || null,
                      migratedAt: Date.now(),
                      reason: plan.reason
                    }
                  });
                } catch {}
                saveSupportCtx({ banned: false });
                setTimeout(()=>{ showMigrateOverlay(false); proceedWithDataBinding(); }, 600);
              }catch(e){
                console.error('migration failed', e);
                setMigrateProgress('‚ùå ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                disableMigrateStart(false);
              }
            };
          }
        } else {
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: plan.reason || 'auto-assign'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
        }

      } else {
        uid = null; dataRef = null;
        userServerKey = null; userIdKey = null; userBasePath = null;
        dailyUnlocked = false; rankingUnlocked = false;
        bootDone = false;

        ensureFx(); window.fx.buffs = [];
        renderBuffStatus();

        security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
        securityDirty = false;
        renderSecurityBadge();

        clearSupportCtx();
        hideAllOverlays();

        state = { ...defaultData };
        localLastWrite = 0; isInitialSync = false;

        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
        setAuthMode(currentAuthMode);
      }
    });

    completeEmailLinkIfNeeded();

    // Î∂ÄÌåÖ Ïò§Î≤ÑÎ†àÏù¥ ÌéòÏùºÏÑ∏Ïù¥ÌîÑ
    setTimeout(() => {
      const stillBooting = bootOverlay && getComputedStyle(bootOverlay).display !== 'none';
      const gameHidden = document.getElementById('container')?.style.visibility !== 'visible';
      if (stillBooting && gameHidden) {
        setBootVisible(false);
        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        showAuthStatus('ÏÑ∏ÏÖò ÌôïÏù∏Ïù¥ ÏßÄÏó∞ÎêòÏñ¥ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôòÌñàÏäµÎãàÎã§.', false);
      }
    }, 4000);

    document.getElementById('google-btn').addEventListener('click', async () => {
      showAuthStatus('');
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        if (handleAuthError(err)) return;
        try {
          await signInWithRedirect(auth, provider);
        } catch (err2) {
          if (handleAuthError(err2)) return;
          showAuthStatus('Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌåùÏóÖ Ï∞®Îã® ÎòêÎäî ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        }
      }
    });

    window.addEventListener('load', () => {
      if (window.__PLAY_ALLOWED) wireGame();
      else window.__DEFER_INIT = wireGame;
      renderBuffStatus();
      renderSecurityBadge();
    });

    setInterval(renderBuffStatus, 1000);
    window.openDailyManual = function(){ checkDailyAndMaybeShow().then(()=>openDailyOverlay()); }
  </script>

  <!-- Ïö∞ÌÅ¥Î¶≠ Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
  <script>
    const customMenu = document.getElementById('custom-menu');
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    });
    customMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('.menu-item');
      const action = btn && btn.getAttribute('data-action');
      if (!action) return;
      if (action === 'menu') {
        try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
        try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
        try { window.close(); } catch {}
        setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
      }
      if (action === 'download') { location.href='/app-download.html'; }
      if (action === 'resume')   { customMenu.style.display='none'; }
      if (action === 'rank')     { location.href='/ranking.html'; }
      if (action === 'attendance'){
        customMenu.style.display='none';
        try{ window.openDailyManual(); }catch{}
      }
    });
    window.addEventListener('click', e => {
      if (!customMenu.contains(e.target)) customMenu.style.display='none';
    });
  </script>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <script>
    (function(){
      const sideToggle = document.getElementById('side-menu-toggle');
      const sideMenu   = document.getElementById('side-menu');
      const backdrop   = document.getElementById('side-backdrop');

      function openSide(){
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closeSide(){
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }

      sideToggle.addEventListener('click', openSide);
      backdrop.addEventListener('click', closeSide);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

      sideMenu.addEventListener('click', (e)=>{
        const btn = e.target.closest('.side-item');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'menu') {
          try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
          try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
          try { window.close(); } catch {}
          setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
        }
        if (action === 'download') { location.href='/app-download.html'; }
        if (action === 'rank')     { location.href='/ranking.html'; }
        if (action === 'attendance'){ try{ window.openDailyManual(); }catch{} }
        closeSide();
      });
    })();
  </script>

  <!-- ÎîîÎ≤ÑÍ∑∏ ÌÇ¨ -->
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({
      disableMenu: true,
      disableSelect: true,
      disableCopy: true,
      disableCut: true,
      disablePaste: true,
      clearIntervalWhenDevOpenTrigger: true,
      ondevtoolopen(type, next) {
        try { window.close(); } catch {}
        next();
      },
      ondevtoolclose() { console.warn('DevTools Îã´Ìûò Í∞êÏßÄÎê®'); }
    });
  </script>

  <!-- ÏõêÍ≤© ÏßÄÏõê -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; 
      });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- Firebase Ïª§Îß®Îìú(ÏÑ∏ÏÖò Ï†úÏñ¥) -->
  <script type="module">
    import { initializeApp as init2, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth as getAuth2, onAuthStateChanged as onAuthStateChanged2 } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase as getDb2, ref as ref2, query as query2, orderByChild, equalTo, onChildAdded, onValue as onValue2 } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig2 = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app2 = getApps().length ? getApp() : init2(firebaseConfig2);
    const auth2 = getAuth2(app2);
    const db2   = getDb2(app2);

    let sessionId = null;

    function setActiveSession(id){
      if (!id) return;
      sessionId = String(id);
      try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}
      bindCommands(sessionId);
      watchSessionEnd(sessionId);
    }

    function bindCommands(id){
      const cmdRef = ref2(db2, `sessions/${id}/commands`);
      onChildAdded(cmdRef, (snap) => {
        const cmd = snap.val() || {};
        try {
          if (cmd.type === 'navigate' && cmd.path){
            if (/^https?:\/\//i.test(cmd.path)) {
              const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;
              if (ok) location.assign(cmd.path);
            } else {
              location.assign(cmd.path);
            }
          }
          else if (cmd.type === 'click' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){
              el.focus?.();
              el.click?.();
              el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window }));
            }
          }
          else if (cmd.type === 'toast' && cmd.message){
            try { window.showToast && window.showToast(cmd.message); } catch {}
          }
          else if (cmd.type === 'eval' && cmd.code){
            try { eval(cmd.code); } catch {}
          }
        } catch(e){
          console.warn('command error', e);
        }
      });
    }

    function watchSessionEnd(id){
      const sessRef = ref2(db2, `sessions/${id}/meta`);
      onValue2(sessRef, (snap)=>{
        const v = snap.val();
        if (!v) return;
        if (v.ended || v.closed) {
          try { window.showToast && window.showToast('ÏõêÍ≤© ÏÑ∏ÏÖòÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.'); } catch {}
        }
      });
    }

    onAuthStateChanged2(auth2, (user)=>{
      if (!user) return;
      // ÎÇ¥ uid Î°ú Ïó∞ÎèôÎêú ÏÑ∏ÏÖò Í∞ÄÏ†∏Ïò§Í∏∞
      const q = query2(ref2(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));
      onValue2(q, (snap)=>{
        const val = snap.val();
        if (!val) return;
        const keys = Object.keys(val);
        if (keys.length) {
          setActiveSession(keys[0]);
        }
      });
    });
  </script>

</body>
</html>
