<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</title>

  <script>
    try {
      if (!sessionStorage.getItem('pmode_init')) {
        history.replaceState(null, '', '/login' + (location.hash || ''));
        sessionStorage.setItem('pmode_init', '1');
      }
    } catch (e) {}
  </script>

  <script>
    const allowedParentOrigins = [
      location.origin,
      'https://xn--989a202a4ogwtc69p.siustudio.kro.kr',
      'https://siustudio.kro.kr'
    ];
    function isAllowedRedirect(urlStr) {
      try {
        const u = new URL(urlStr);
        if (u.protocol !== 'https:') return false;
        const host = u.hostname;
        const base1 = 'xn--989a202a4ogwtc69p.siustudio.kro.kr';
        const base2 = 'siustudio.kro.kr';
        return (
          host === base1 || host === base2 ||
          host.endsWith('.' + base1) || host.endsWith('.' + base2)
        );
      } catch { return false; }
    }
    let parentOrigin     = sessionStorage.getItem('parent_origin')     || null;
    let pendingRedirect  = sessionStorage.getItem('pending_redirect')  || null;
    let pendingState     = sessionStorage.getItem('pending_state')     || null;

    function consumePendingRedirect() {
      let target = null;
      try {
        const fromStorage = sessionStorage.getItem('pending_redirect');
        if (fromStorage) {
          sessionStorage.removeItem('pending_redirect');
          target = fromStorage;
        }
      } catch {}
      if (!target && pendingRedirect) target = pendingRedirect;
      pendingRedirect = null;
      return (target && isAllowedRedirect(target)) ? target : null;
    }

    function notifyReadyToParent() {
      try {
        if (window.opener && !window.opener.closed) {
          allowedParentOrigins.forEach((o) => {
            try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}
          });
        }
      } catch {}
    }
    notifyReadyToParent();

    function notifyAuthSuccessAndExit() {
      const target = consumePendingRedirect();
      const hasParent = window.opener && !window.opener.closed && parentOrigin;
      if (hasParent) {
        try {
          window.opener.postMessage({
            type: 'auth-success', ok: true, redirect: target || undefined, receivedState: pendingState
          }, parentOrigin);
        } catch {}
        try { window.close(); } catch {}
        return;
      }
      if (target) window.location.href = target;
    }
    window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;
  </script>

  <style>
    :root{
      --glass-bg: rgba(10,12,20,0.40);
      --glass-brd: rgba(255,255,255,0.08);
      --accent: #00d4ff;
    }
    body { margin:0; padding:0; font-family:Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    img { display:block; }
    #top-bar, #container { visibility: hidden; }

    .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }

    #boot-overlay{
      position:fixed; inset:0; z-index:3000;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      backdrop-filter: blur(3px);
    }
    #boot-overlay .card{
      width:min(420px,92vw); border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));
      padding:16px;
      text-align:center; color:#e6f7ff;
      box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* ë¡œê·¸ì¸ ì¹´ë“œ */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));
      box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
      display:none;
    }
    #auth-container.hidden { opacity:0; transform: translate(-50%, -46% ) scale(.98); pointer-events:none; visibility:hidden; }
    #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }
    #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20); color:#fff; outline:none; font-size:14px; }
    #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.22); }
    #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }
    #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer; }

    .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }
    .auth-status.show { opacity:1; transform:translateY(0); }

    .login-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60)); border-radius:14px; z-index:1100; opacity:1; pointer-events:auto; }
    .login-overlay.show { display:flex; }

    .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; }

    @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

    /* ìƒë‹¨ ë°” */
    #top-bar {
      position: fixed; top: 5px; left: 5px; right: 5px;
      display: flex; flex-wrap: wrap; gap:6px 8px;
      justify-content: space-between; align-items: center;
      background: rgba(30,30,30,0.55);
      padding:6px 10px; border-radius:8px;
      font-size:12px; z-index:1000;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; }
    .bar-group img { width:16px; height:16px; }
    .bar-group span { white-space: nowrap; }
    #ship-img{ width:16px; height:16px; }

    #buff-badges { display:flex; gap:8px; align-items:center; }
    .badge{
      padding:2px 6px; border-radius:8px; font-weight:800; font-size:11px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      color:#dffaff;
    }

    #settings-btn {
      margin-left: 8px; padding: 6px 10px; border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;
      cursor: pointer; font-weight: 700; writing-mode: horizontal-tb;
    }
    #settings-btn:hover { filter: brightness(1.08); }

    /* ë³¸ë¬¸ */
    #container { margin:56px auto 20px; width:90%; max-width:640px; padding:16px 20px; background:rgba(30,30,30,0.55); border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
    h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }
    button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }

    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }

    .particle { position:absolute; width:6px; height:6px; background:#ffd700; border-radius:50%; opacity:.8; animation:floatUp .8s ease-out forwards; pointer-events:none; }
    @keyframes floatUp { to { transform: translate(var(--dx),var(--dy)) scale(0); opacity:0; } }
    #ore { width:200px; cursor:pointer; }

    /* ìš°í´ë¦­ ë©”ë‰´ */
    #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.90); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }
    #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

    /* ë°”í…€ ë‚´ë¹„ */
    #bottom-nav{
      position: fixed;
      left: 50%; bottom: max(12px, env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%);
      display: flex; gap: 8px; padding: 8px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-brd);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      z-index: 1200; max-width: 96vw;
    }
    #bottom-nav .tab{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 6px; min-width: 70px; padding: 10px 12px; font-size: 13px;
      color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06); transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    #bottom-nav .tab:hover{ transform: translateY(-1px); }
    #bottom-nav .tab.active{
      color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);
      border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);
    }

    #container{ padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }
    #planets-content{ padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px)); }

    @media (max-width: 420px){
      #top-bar{ font-size:11px; padding:6px 8px; }
      #settings-btn{ padding:5px 8px; font-size:12px; }
      #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; }
      #bottom-nav .tab{ padding:10px 8px; min-width:0; }
      h1{ font-size:1.2em; }
    }

    /* ì‚¬ì´ë“œ ë©”ë‰´ */
    #side-menu-toggle{
      position: fixed; left: 8px; bottom: calc(96px + env(safe-area-inset-bottom, 0px));
      z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;
      display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }
    #side-backdrop.show{ opacity:1; pointer-events:auto; }
    #side-menu{
      position: fixed; top: 0; left: 0; bottom: 0; width: 260px; max-width: 84vw;
      transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);
      background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);
    }
    #side-menu.open{ transform: translateX(0); }
    .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .side-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none; }
    .side-item:hover{ filter: brightness(1.08); }
    .side-item .icon{ width:18px; text-align:center; }
    .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }
    @media (max-width: 420px){ #side-menu-toggle{ bottom: calc(88px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; } #side-menu{ width: 240px; } }

    /* ===== ì¶œì„ & ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ ===== */
    #daily-overlay{
      position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);
    }
    #daily-overlay.show{ display:flex; }
    #daily-card{
      width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));
      padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);
      color:#eaf6ff;
    }
    #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    #daily-info{ margin:6px 0 10px; font-size:13px; color:#cfe6ff; min-height:36px; }
    #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

    .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }
    .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }
    .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

    /* ìŠ¬ë¡¯(ì„¸ë¡œ ë‚™í•˜) */
    #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .slot-window{ width:320px; height:56px; overflow:hidden; border-radius:10px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }
    .reel{ display:flex; flex-direction:column; }
    .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }
    .slot-icon{ font-size:20px; }

    /* ì»¨íŠ¸ë¡¤/í™•ë¥ /ëª©ë¡ */
    #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .spinbtn{ padding:10px 14px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.14); font-weight:900; }
    .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }
    .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }
    .spinbtn:disabled{ opacity:.6; cursor:not-allowed; }

    #prob-toggle{ width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff; }
    #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }
    #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }
    #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }
    #buff-countdown{ margin-top:6px; font-size:12px; color:#9fdcff; min-height:18px; }
  </style>
</head>
<body>
  <!-- ë¶€íŒ… ì¤‘ ì˜¤ë²„ë ˆì´ -->
  <div id="boot-overlay" aria-hidden="false">
    <div class="card" role="status" aria-live="polite" aria-atomic="true">
      <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
        <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>
        <div style="text-align:left;">
          <div style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
          <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
      </div>
      <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
    </div>
  </div>

  <!-- ì¸ì¦ -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">ë¡œê·¸ì¸</button>
      <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">íšŒì›ê°€ì…</button>
    </div>

    <h2 id="auth-title">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" autocomplete="username" />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <div id="signup-extra" style="display:none; margin-top:6px;">
      <input type="password" id="password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password" />
    </div>

    <button id="login-btn" class="primary-btn">ë¡œê·¸ì¸</button>
    <button id="signup-btn" class="ghost-btn" style="display:none">íšŒì›ê°€ì…</button>

    <button id="google-btn" aria-label="êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° (ê¶Œì¥)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false"><path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/><path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/><path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/></svg>
      </span>
      <span class="g-text">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° <small>(ê¶Œì¥)</small></span>
    </button>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>
    <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘</div>
            <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦</div>
          </div>
        </div>
        <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
        <div style="width:220px; margin:0 auto 10px; background:rgba(255,255,255,0.04); border-radius:8px; padding:6px;">
          <div id="overlay-progress" style="height:8px; width:0%; border-radius:6px; background:linear-gradient(90deg,#00c0ff,#0077ff); transition:width .4s ease;"></div>
        </div>
        <ol id="overlay-steps" style="list-style:none; padding:0; margin:0; font-size:13px; color:#dbefff; max-width:260px;">
          <li data-step="1" style="opacity:0.9; margin-bottom:6px;">1. ì¸ì¦ì°½ ì—´ê¸°</li>
          <li data-step="2" style="opacity:0.6; margin-bottom:6px;">2. ê¶Œí•œ ìš”ì²­</li>
          <li data-step="3" style="opacity:0.4;">3. ë¡œê·¸ì¸ ì™„ë£Œ</li>
        </ol>
        <div id="login-overlay-detail" style="font-size:12px; color:#9fbfda; margin-top:10px; min-height:20px;">ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- ìƒë‹¨ ë°” & ë©”ì¸ ê²Œì„ -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ìì›: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ì½”ì¸: 0</span>
      <!-- ì´ë²¤íŠ¸ ì½”ì¸ -->
      <img src="/images/event-icon.png" alt="EventCoin" />
      <span id="ecoins">ì´ë²¤íŠ¸ì½”ì¸: 0</span>
    </div>
    <div class="bar-group">
      <img id="ship-img" src="/images/ship-level1.png" alt="Ship" />
      <span id="ship-level">1ë ™ (20ì½”ì¸)</span>
      <button id="upgrade-ship">ì—…ê·¸ë ˆì´ë“œ</button>
      <div id="buff-badges">
        <span id="badge-res" class="badge" style="display:none;">ìì›Ã—2 00:00</span>
        <span id="badge-coin" class="badge" style="display:none;">ì½”ì¸Ã—2 00:00</span>
      </div>
      <button id="settings-btn" aria-label="ì„¤ì •ìœ¼ë¡œ ì´ë™">âš™ï¸ ì„¤ì •</button>
    </div>
  </div>

  <div id="container">
    <h1>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</h1>

    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="ê´‘ì„" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ìì› â†’ 1ì½”ì¸</button>
        <button id="auto-convert-buy" class="general">ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>ì´ ì´ˆë‹¹ ìì›: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ì•Œë°” ê³ ìš© (<span id="worker-cost">0</span>ì½”ì¸)</button>
      <p>ì´ ì´ˆë‹¹ ì½”ì¸: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ì½”ì¸ ì•Œë°” (<span id="conversion-cost">0</span>ì½”ì¸)</button>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>í´ë¦­ë‹¹ ìì›: <span id="click-power">1</span></p>
      <button id="click-upgrade" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (15ì½”ì¸)</button>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <!-- ë°”í…€ ë‚´ë¹„ -->
    <nav id="bottom-nav" aria-label="ê²Œì„ íƒ­ ë‚´ë¹„ê²Œì´ì…˜">
      <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ğŸª¨</span><span class="t-label">ë©”ì¸</span></div>
      <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">ğŸ‘©â€ğŸš€</span><span class="t-label">ìš°ì£¼ì¸</span></div>
      <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">âš™ï¸</span><span class="t-label">ì—…ê·¸ë ˆì´ë“œ</span></div>
      <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ğŸª</span><span class="t-label">í–‰ì„±</span></div>
    </nav>
  </div>

  <!-- ì»¤ìŠ¤í…€ ë©”ë‰´ -->
  <div id="custom-menu">
    <div class="menu-item" data-action="menu"><span>ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></div>
    <div class="menu-item" data-action="download"><span>â¬‡ï¸ ì•± ë‹¤ìš´ë¡œë“œ</span></div>
    <div class="menu-item" data-action="resume"><span>â–¶ï¸ ê²Œì„ ê³„ì†í•˜ê¸°</span></div>
    <div class="menu-item" data-action="rank"><span>ğŸ† ë­í‚¹ ë³´ê¸°</span></div>
    <div class="menu-item" data-action="attendance">
      <span>ğŸ“… ì¶œì„ ë³´ìƒ</span>
      <span id="attendance-left">-</span>
    </div>
  </div>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
  <button id="side-menu-toggle" aria-label="ì‚¬ì´ë“œ ë©”ë‰´ ì—´ê¸°" title="ë©”ë‰´">â˜°</button>
  <div id="side-backdrop" aria-hidden="true"></div>
  <aside id="side-menu" aria-label="ì‚¬ì´ë“œ ë©”ë‰´" aria-hidden="true">
    <div class="side-header">ë©”ë‰´</div>
    <nav class="side-items">
      <button class="side-item" data-action="menu"><span class="icon">ğŸ®</span><span>ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></button>
      <button class="side-item" data-action="download"><span class="icon">â¬‡ï¸</span><span>ì•± ë‹¤ìš´ë¡œë“œ</span></button>
      <button class="side-item" data-action="resume"><span class="icon">â–¶ï¸</span><span>ê²Œì„ ê³„ì†í•˜ê¸°</span></button>
      <button class="side-item" data-action="rank"><span class="icon">ğŸ†</span><span>ë­í‚¹ ë³´ê¸°</span></button>
      <button class="side-item" data-action="attendance">
        <span><span class="icon">ğŸ“…</span>ì¶œì„ ë³´ìƒ</span>
        <span class="side-right" id="attendance-left-side">-</span>
      </button>
    </nav>
  </aside>

  <!-- ì¶œì„/ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ -->
  <div id="daily-overlay" aria-hidden="true">
    <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">
      <div id="daily-title">
        <span>ğŸ“… ì˜¤ëŠ˜ì˜ ë³´ìƒ & ìŠ¬ë¡¯</span>
        <button id="prob-toggle" title="í™•ë¥ /ë³´ìƒ ì •ë³´">i</button>
      </div>

      <div class="tabbar">
        <button class="tbtn active" data-mode="daily">ì¶œì„ ìŠ¬ë¡¯(ë¬´ë£Œ/ì¼1íšŒ)</button>
        <button class="tbtn" data-mode="premium">í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯(ì´ë²¤íŠ¸ì½”ì¸ 1)</button>
        <button class="tbtn" data-mode="ecoin">ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯(10)</button>
      </div>

      <div id="daily-info">í™•ì¸ ì¤‘â€¦</div>

      <!-- ìŠ¬ë¡¯í˜• (ì„¸ë¡œ ë‚™í•˜) -->
      <div id="slot-wrap">
        <div class="slot-window">
          <div id="slot-reel" class="reel"></div>
        </div>
      </div>

      <div id="mode-row">
        <button id="spin-daily"   class="spinbtn spin-free">ë¬´ë£Œ ì¶œì„ ëŒë¦¬ê¸°</button>
        <button id="spin-premium" class="spinbtn spin-prem">í”„ë¦¬ë¯¸ì—„ ëŒë¦¬ê¸°(-EC 1)</button>
        <button id="spin-ecoin"   class="spinbtn spin-ecoin">ì´ë²¤íŠ¸ì½”ì¸ ëŒë¦¬ê¸°(-EC 10)</button>
      </div>

      <div id="buff-countdown"></div>
      <div id="prob-panel"></div>
      <div id="reward-list"></div>

      <div id="daily-actions">
        <button id="daily-close">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš´ë“œ -->
  <audio id="sfx-start"  src="/sounds/roulette_start.mp3" preload="auto"></audio>
  <audio id="sfx-tick"   src="/sounds/roulette_tick.mp3"  preload="auto"></audio>
  <audio id="sfx-win"    src="/sounds/roulette_win.mp3"   preload="auto"></audio>

  <!-- Firebase + ê²Œì„ ë¡œì§ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendEmailVerification, GoogleAuthProvider, signInWithPopup, signInWithRedirect } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, onValue, runTransaction, update, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== ê²Œì„ ìƒíƒœ =====
    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null;
    let localLastWrite = 0;
    let isInitialSync = false;

    // ìŠ¤í•€ ì ê¸ˆ
    let isSpinning = false;
    function setSpinLock(v){
      isSpinning = !!v;
      const b1 = document.getElementById('spin-daily');
      const b2 = document.getElementById('spin-premium');
      const b3 = document.getElementById('spin-ecoin');
      [b1,b2,b3].forEach(b => { if (!b) return; b.disabled = v || b.disabled; });
    }

    const defaultData = {
      resources:0, coins:0, eventCoins:0,
      clickPower:1, shipLevel:1, shipUpgradeCost:20,
      workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[],
      // ë²„í”„ ë§Œë£Œ ì‹œê°(ms) - 0ì´ë©´ ì—†ìŒ
      buffResUntil: 0,
      buffCoinUntil: 0
    };
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const clickUpgradeCost=15;

    let currentAuthMode = 'login';

    // ë¹„ìš©/íŒŒì›Œ
    function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }

    // ===== ë³€í™˜: ì½”ì¸ ë²„í”„Ã—2 ë°˜ì˜ =====
    function getCoinMul(){ return (Date.now() < (state.buffCoinUntil||0)) ? 2 : 1; }
    function getResMul(){  return (Date.now() < (state.buffResUntil||0))  ? 2 : 1; }

    function convertResources(maxCount = null) {
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count > 0) { 
        state.resources -= count * 10; 
        state.coins += count * getCoinMul(); // ì½”ì¸Ã—2 ë²„í”„ ì ìš©
      }
    }

    async function ensureInitialData(refPath) {
      try {
        await runTransaction(refPath, current => {
          if (current === null) return { ...defaultData, _lastUpdated: Date.now() };
          return current;
        });
      } catch (err) { console.error('ì´ˆê¸°í™” íŠ¸ëœì­ì…˜ ì—ëŸ¬:', err); }
    }

    function save() {
      if (!uid || !dataRef) return;
      if (isInitialSync) return;
      if (!window.__PLAY_ALLOWED) return;
      const now = Date.now();
      state._lastUpdated = now;
      localLastWrite = now;
      try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
      update(dataRef, { ...state }).catch(err => console.error('ì €ì¥ ì—ëŸ¬:', err));
    }

    const authContainer = document.getElementById('auth-container');
    const authErrorEl   = document.getElementById('auth-error');
    const bootOverlay   = document.getElementById('boot-overlay');

    function setBootVisible(v){
      if (!bootOverlay) return;
      bootOverlay.style.display = v ? 'flex' : 'none';
      bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');
    }

    // ë¡œê·¸ì¸ ë©ˆì¶¤ ëŒ€ë¹„: 4ì´ˆ í›„ ê°•ì œ í‘œì‹œ
    const __bootFailSafe = setTimeout(()=>{
      try { setBootVisible(false); } catch {}
      try { authContainer.style.display='block'; authContainer.classList.remove('hidden'); } catch {}
    }, 4000);

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg || '';
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';
    }

    function showLoginOverlay(show, text = 'ë¡œê·¸ì¸ ì¤‘â€¦', opts = {}) {
      const overlay = document.getElementById('login-overlay');
      if (!overlay) return;
      const title = document.getElementById('login-overlay-title');
      const sub   = document.getElementById('login-overlay-sub');
      const detail= document.getElementById('login-overlay-detail');
      const progress = document.getElementById('overlay-progress');
      const steps = Array.from(document.querySelectorAll('#overlay-steps li'));
      if (text) title.textContent = text;
      sub.textContent    = opts.subText || 'ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦';
      detail.textContent = opts.detail  || 'ë¸Œë¼ìš°ì € íŒì—… ë˜ëŠ” ìƒˆ ì°½ì—ì„œ ì¸ì¦ì°½ì´ ì—´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      steps.forEach(li => { li.removeAttribute('data-active'); li.style.opacity = 0.6; });
      function activateStep(n){ steps.forEach((li,i)=>{ if(i<n){ li.setAttribute('data-active','true'); li.style.opacity=1; } }); }
      if (show) {
        overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
        activateStep(1); progress.style.width='24%';
        overlay._t1 && clearTimeout(overlay._t1); overlay._t1=setTimeout(()=>{ activateStep(2); progress.style.width='64%'; },800);
        overlay._t2 && clearTimeout(overlay._t2); overlay._t2=setTimeout(()=>{ progress.style.width='84%'; },1700);
      } else {
        overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
        progress.style.width='0%';
        overlay._t1 && clearTimeout(overlay._t1); overlay._t2 && clearTimeout(overlay._t2);
      }
    }

    function showGameUI() {
      if (!window.__PLAY_ALLOWED) return;
      try {
        authContainer.classList.add('hidden');
        try { history.replaceState(null, '', '/ê²Œì„' + (location.hash || '')); } catch {}
        setTimeout(() => {
          authContainer.style.display = 'none';
          const lb = document.getElementById('logout-btn');
          if (lb) lb.style.display = 'block';
          ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'visible');
        }, 300);
      } catch (e) { console.error('showGameUI error', e); }
    }

    // ====== ì¶œì„(KST) ìœ í‹¸ & ë‚¨ì€ì‹œê°„ ======
    function kstDate(d=new Date()){
      return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }
    function kstDayKey(d=new Date()){
      const t = kstDate(d);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextResetKST(d=new Date()){ const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n; }
    function fmtLeft(ms){
      if(ms<=0) return 'ì§€ê¸ˆ ê°€ëŠ¥';
      const s=Math.floor(ms/1000);
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    // === ë°¸ëŸ°ìŠ¤ ìŠ¤ì½”ì–´ ===
    function calcScore(){
      const rps = state.workerCount * getWorkerPower();     // ì´ˆë‹¹ ìì›
      const cps = state.conversionCount;                    // ì´ˆë‹¹ ì½”ì¸(ì•Œë°”)
      const rpc = state.clickPower;                         // í´ë¦­ë‹¹ ìì›
      const planets = (state.ownedPlanets?.length || 0);
      const ship = (state.shipLevel || 1);
      const auto = state.autoConvertBought ? 1 : 0;

      // ì ìˆ˜: ì„±ì¥ì´ ì»¤ì§ˆìˆ˜ë¡ ì™„ë§Œíˆ ì¦ê°€í•˜ë„ë¡ ë¡œê·¸/ë£¨íŠ¸ ì‚¬ìš©
      const score =
          25 * Math.log2(1 + rps) +
          45 * Math.log2(1 + cps) +
          10 * Math.sqrt(rpc) +
          130 * planets +
          30  * ship +
          (auto ? 20 : 0);

      return Math.max(0, score);
    }

    // === ì¶œì„ ì „ìš© ì½”ì¸ ë² ì´ìŠ¤: ì´ˆë°˜ í›„í•˜ê²Œ, í›„ë°˜ ì‚´ì§ ì§œê²Œ ===
    function dailyCoinBase(){
      const coins = state.coins || 0;
      const score = calcScore();
      // ê¸°ë³¸ëŸ‰: ìŠ¤ì½”ì–´ ê¸°ë°˜ + ì†ŒëŸ‰ ë°”ë‹¥
      let base = 40 + 0.8 * score;

      // ë³´ìœ  ì½”ì¸ì— ë”°ë¥¸ ê´€ìš©ì„±(ì´ˆë°˜â†‘, í›„ë°˜â†“)
      // coins=0ì¼ ë•Œ ~0.6, coins=200kì¼ ë•Œ ~0.33, coins=2Mì¼ ë•Œ ~0.2
      const k = 200000;
      const generosity = 0.6 - (0.4 * (coins / (coins + k))); // 0.6 â†’ 0.2
      // ë³´ìœ  ì½”ì¸ ë¹„ë¡€ ë³´ì •(ë„ˆë¬´ í° ê³„ì •ì—ëŠ” ë¯¸ì„¸)
      base += generosity * Math.pow(coins+1, 0.25);

      // ì•ˆì „ í´ë¨í”„
      base = Math.round(Math.min(Math.max(base, 60), 40000));
      return base;
    }

    // === í”„ë¦¬ë¯¸ì—„/EC ìŠ¬ë¡¯ ë² ì´ìŠ¤ ===
    function premiumCoinBase(){
      const score = calcScore();
      return Math.round(Math.min(Math.max(100 + 1.6*score, 80), 60000));
    }
    function ecoinCoinBase(){
      const score = calcScore();
      return Math.round(Math.min(Math.max(300 + 2.2*score, 120), 120000));
    }

    // ====== ìŠ¬ë¡¯ í…œí”Œë¦¿ & ë¨¸í„°ë¦¬ì–¼ë¼ì´ì¦ˆ ======
    // ë²„í”„ëŠ” ìì›Ã—2(3ë¶„), ì½”ì¸Ã—2(3ë¶„)ë§Œ ì‚¬ìš©
    const TPL_DAILY = [
      { key:'coin_low',  type:'coinFlat', amtMul:0.6,  icon:'ğŸª™', color:'#7AFBFF', w:0.35 },
      { key:'coin_mid',  type:'coinFlat', amtMul:1.0,  icon:'ğŸ’°', color:'#4DFFB5', w:0.25 },
      { key:'coin_high', type:'coinFlat', amtMul:1.5,  icon:'ğŸ’°', color:'#00E5FF', w:0.10 },
      { key:'res_200',   type:'res',  val:200,         icon:'ğŸª¨', color:'#FFEA70', w:0.10 },
      { key:'buff_res',  type:'buffRes2x',  dur:3*60*1000, icon:'âš¡', color:'#FFA8FF', w:0.12 },
      { key:'buff_coin', type:'buffCoin2x', dur:3*60*1000, icon:'âš™ï¸', color:'#FFD0A8', w:0.08 }
    ];

    // EC í™•ë¥  ë‚®ì¶¤
    const TPL_PREMIUM = [
      { key:'coin_x1',   type:'coinFlat', amtMul:1.0,  icon:'ğŸ’°', color:'#00E5FF', w:0.32 },
      { key:'coin_x1_6', type:'coinFlat', amtMul:1.6,  icon:'ğŸ’°', color:'#4DFFB5', w:0.22 },
      { key:'coin_x2_4', type:'coinFlat', amtMul:2.4,  icon:'ğŸ’°', color:'#32C6FF', w:0.12 },
      { key:'res_1000',  type:'res',  val:1000,        icon:'ğŸª¨', color:'#FFEA70', w:0.16 },
      { key:'buff_res2', type:'buffRes2x',  dur:3*60*1000, icon:'âš¡', color:'#FFA8FF', w:0.12 },
      { key:'buff_coin2',type:'buffCoin2x', dur:3*60*1000, icon:'âš™ï¸', color:'#FFD0A8', w:0.10 },
      { key:'eco_3',     type:'ecoin', val:3,          icon:'ğŸŸï¸', color:'#FF9E3D', w:0.02 } // â†“
    ];

    // EC ìŠ¬ë¡¯: EC ë¦¬í„´ì€ ë‚®ì€ í™•ë¥ , ì½”ì¸/ë²„í”„ ìœ„ì£¼
    const TPL_ECOIN = [
      { key:'coin_x2',   type:'coinFlat', amtMul:2.0,  icon:'ğŸ’°', color:'#00E5FF', w:0.28 },
      { key:'coin_x3_5', type:'coinFlat', amtMul:3.5,  icon:'ğŸ’°', color:'#4DFFB5', w:0.18 },
      { key:'coin_x5',   type:'coinFlat', amtMul:5.0,  icon:'ğŸ’°', color:'#32C6FF', w:0.12 },
      { key:'buff_res3', type:'buffRes2x',  dur:3*60*1000, icon:'âš¡', color:'#8AE1FF', w:0.18 },
      { key:'buff_coin3',type:'buffCoin2x', dur:3*60*1000, icon:'ğŸš€', color:'#8AE1FF', w:0.18 },
      { key:'eco_8',     type:'ecoin', val:8,          icon:'ğŸŸï¸', color:'#FFBE5C', w:0.10 }, // â†“
      { key:'eco_12',    type:'ecoin', val:12,         icon:'ğŸŸï¸', color:'#FF9E3D', w:0.04 }, // â†“
      { key:'eco_20',    type:'ecoin', val:20,         icon:'ğŸŸï¸', color:'#FF7AE1', w:0.02 }  // â†“
    ];

    function materializeItems(tpl, mode){
      let base = mode==='daily'   ? dailyCoinBase()
              : mode==='premium' ? premiumCoinBase()
              : ecoinCoinBase();
      return tpl.map(it=>{
        if (it.type==='coinFlat'){
          const amt = Math.max(1, Math.round(base * it.amtMul));
          return { ...it, label:`ì½”ì¸ ${amt.toLocaleString()}`, onWin:()=>{ state.coins += amt; } };
        }
        if (it.type==='res'){
          return { ...it, label:`ìì› ${it.val.toLocaleString()}`, onWin:()=>{ state.resources += it.val; } };
        }
        if (it.type==='ecoin'){
          return { ...it, label:`ì´ë²¤íŠ¸ì½”ì¸ Ã—${it.val}`, onWin:()=>{ state.eventCoins = (state.eventCoins||0) + it.val; } };
        }
        if (it.type==='buffRes2x'){
          return { ...it, label:`ìì›Ã—2 / ${Math.round(it.dur/60000)}ë¶„`, onWin:()=>{ state.buffResUntil = Date.now()+it.dur; } };
        }
        if (it.type==='buffCoin2x'){
          return { ...it, label:`ì½”ì¸Ã—2 / ${Math.round(it.dur/60000)}ë¶„`, onWin:()=>{ state.buffCoinUntil = Date.now()+it.dur; } };
        }
        return it;
      });
    }

    function getItemsForMode(mode){
      const tpl = mode==='daily'   ? TPL_DAILY
               : mode==='premium' ? TPL_PREMIUM
               : mode==='ecoin'   ? TPL_ECOIN
               : TPL_PREMIUM;
      return materializeItems(tpl, mode);
    }

    // ==== SFX & ë²„í”„ ë±ƒì§€ ====
    function playSfx(id){
      const el=document.getElementById(id);
      if (el && el.play){ el.currentTime=0; el.play().catch(()=>{}); return; }
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='triangle';
        o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;
        g.gain.setValueAtTime(.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);
        o.start(); o.stop(ctx.currentTime+.08);
      }catch{}
    }
    function startTickLoop(intv=120){ stopTickLoop(); startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv); }
    function stopTickLoop(){ if(startTickLoop._id){ clearInterval(startTickLoop._id); startTickLoop._id=null; } }

    function updateBuffBadges(){
      const now = Date.now();
      const resLeft = Math.max(0, (state.buffResUntil||0) - now);
      const coinLeft= Math.max(0, (state.buffCoinUntil||0) - now);

      const badgeRes  = document.getElementById('badge-res');
      const badgeCoin = document.getElementById('badge-coin');
      const infoLine  = document.getElementById('buff-countdown');

      function fmt(ms){ const s = Math.ceil(ms/1000); const m = Math.floor(s/60); const ss = s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }

      if (resLeft>0){ badgeRes.style.display='inline-flex'; badgeRes.textContent = `ìì›Ã—2 ${fmt(resLeft)}`; } else { badgeRes.style.display='none'; }
      if (coinLeft>0){ badgeCoin.style.display='inline-flex'; badgeCoin.textContent= `ì½”ì¸Ã—2 ${fmt(coinLeft)}`; } else { badgeCoin.style.display='none'; }

      let line = [];
      if (resLeft>0) line.push(`ìì›Ã—2 ${fmt(resLeft)}`);
      if (coinLeft>0) line.push(`ì½”ì¸Ã—2 ${fmt(coinLeft)}`);
      infoLine.textContent = line.length ? `â±ï¸ ${line.join(' Â· ')}` : '';
    }

    // ===== ìŠ¬ë¡¯(ì„¸ë¡œ ë‚™í•˜ì‹) =====
    const slotWrap = document.getElementById('slot-wrap');
    const reel = document.getElementById('slot-reel');
    function buildSlot(items){
      const rows = items.map(it=>`<div class="slot-item"><span class="slot-icon">${it.icon||'ğŸ'}</span>${it.label||it.key}</div>`).join('');
      reel.innerHTML = rows.repeat(8);
      reel.style.transform = 'translateY(0px)';
      reel.style.transition = 'none';
    }
    function spinSlot(items, picked){
      const rowH=56, totalRows = items.length*8;
      const idx = items.findIndex(it=>it.key===picked.key);
      const stopRow = (items.length*6) + (idx>=0?idx:0); // ì¶©ë¶„íˆ êµ´ë¦¬ê¸°
      const targetY = - stopRow * rowH;
      startTickLoop(90);
      playSfx('sfx-start');
      return new Promise(resolve=>{
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';
            reel.style.transform = `translateY(${targetY}px)`;
          });
        });
        reel.ontransitionend = ()=>{ reel.ontransitionend=null; stopTickLoop(); playSfx('sfx-win'); resolve(); };
      });
    }

    // ===== ì¶œì„ ì €ì¥/í‘œì‹œ =====
    const dailyOverlay = document.getElementById('daily-overlay');
    const dailyInfo    = document.getElementById('daily-info');
    const dailyCloseBtn= document.getElementById('daily-close');
    const probPanel    = document.getElementById('prob-panel');
    const probToggle   = document.getElementById('prob-toggle');
    const rewardList   = document.getElementById('reward-list');

    const tabs = Array.from(document.querySelectorAll('.tbtn'));
    const spinDailyBtn   = document.getElementById('spin-daily');
    const spinPremiumBtn = document.getElementById('spin-premium');
    const spinEcoinBtn   = document.getElementById('spin-ecoin');

    let dailyCache = null;
    let currentMode = 'daily';
    let activeItems = [];

    function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }
    function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }
    dailyCloseBtn.onclick = closeDailyOverlay;

    probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

    function setMode(mode){
      currentMode = mode;
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
      activeItems = getItemsForMode(mode);

      // ìŠ¬ë¡¯ë§Œ ì‚¬ìš©
      slotWrap.style.display     = 'flex';
      spinDailyBtn.style.display   = (mode==='daily')? 'inline-block':'none';
      spinPremiumBtn.style.display = (mode==='premium')? 'inline-block':'none';
      spinEcoinBtn.style.display   = (mode==='ecoin')? 'inline-block':'none';

      buildSlot(activeItems);
      buildProbPanel(activeItems, mode);
      buildRewardList(activeItems);
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

    function buildProbPanel(items, mode){
      const total=items.reduce((a,b)=>a+b.w,0);
      const rows=items.map(it=>`<tr><td>${it.icon||''} ${it.label||it.key}</td><td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td></tr>`).join('');
      const header = mode==='daily' ? 'ì¶œì„ ìŠ¬ë¡¯ í™•ë¥ '
                  : mode==='premium' ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ í™•ë¥ (EC -1)'
                  : 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ í™•ë¥ (EC -10)';
      probPanel.innerHTML = `<div style="margin-bottom:6px; color:#9fdcff;">${header}</div><table>${rows}</table>`;
    }
    function buildRewardList(items){
      rewardList.innerHTML = 'ğŸ° ë³´ìƒ ëª©ë¡: ' + items.map(it=>`${it.icon||''} ${it.label||it.key}`).join(' Â· ');
    }

    function refreshDailyInfo(canClaim){
      const today = kstDayKey();
      const streak = dailyCache?.streak || 0;
      const resetLeft = Math.max(0, nextResetKST()-kstDate());
      const leftText = canClaim ? 'ì§€ê¸ˆ ê°€ëŠ¥' : `ë‹¤ìŒ ì¶œì„ê¹Œì§€ ${fmtLeft(resetLeft)}`;
      dailyInfo.innerHTML = canClaim
        ? `ì˜¤ëŠ˜(${today}) ì¶œì„ ìŠ¬ë¡¯ ê°€ëŠ¥! <b>${leftText}</b><br>ì—°ì† ${streak}ì¼`
        : `ì˜¤ëŠ˜(${today})ì€ ì´ë¯¸ ì™„ë£Œ. <b>${leftText}</b><br>í˜„ì¬ ì—°ì† ${streak}ì¼`;
      spinDailyBtn.disabled = !canClaim || isSpinning;
    }

    async function applyPrizeTransaction(delta){
      await runTransaction(dataRef, current => {
        const cur = current || { ...defaultData };
        const next = { ...cur };
        next.coins      = (next.coins||0) + (delta.coins||0);
        next.resources  = (next.resources||0) + (delta.resources||0);
        next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);
        next.buffResUntil  = state.buffResUntil || 0;
        next.buffCoinUntil = state.buffCoinUntil || 0;
        next._lastUpdated = Date.now();
        return next;
      });
    }

    function makeDeltaSnapshot(){
      return { coins: state.coins||0, resources: state.resources||0, eventCoins: state.eventCoins||0 };
    }
    function deltaFrom(before){
      return {
        coins: (state.coins||0) - before.coins,
        resources: (state.resources||0) - before.resources,
        eventCoins: (state.eventCoins||0) - before.eventCoins
      };
    }

    function pickWeighted(items){ const s=items.reduce((a,b)=>a+b.w,0); let r=Math.random()*s; for(const it of items){ if((r-=it.w)<=0) return it; } return items.at(-1); }
    function canSpendEC(n){ return (state.eventCoins||0) >= n; }

    // ==== ìŠ¤í•€ ë²„íŠ¼ ====
    spinDailyBtn.onclick = async ()=>{
      if (isSpinning) return;
      if (!window.__PLAY_ALLOWED) { dailyInfo.innerHTML='ëª¨ë°”ì¼ ë˜ëŠ” íŒì—…ì—ì„œë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'; return; }
      if (!uid) { dailyInfo.innerHTML='ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'; return; }

      const today = kstDayKey(); 
      const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));
      if (dailyCache?.lastKey === today) { refreshDailyInfo(false); return; }

      setMode('daily');
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();

      setSpinLock(true);
      try{
        await spinSlot(activeItems, picked);
        picked.onWin();

        let streak = Number(dailyCache?.streak||0);
        if (dailyCache?.lastKey === yesterday) streak+=1; else streak=1;

        // 10ì—°ì† ë³´ë„ˆìŠ¤
        if (streak % 10 === 0) {
          state.eventCoins = (state.eventCoins || 0) + 1;
        }

        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta);
        await update(ref(db, `users/${uid}/daily`), { lastKey: today, streak, lastClaimAt: Date.now(), lastPrize: picked.key });
        dailyCache = { lastKey: today, streak };
        updateUI();
        dailyInfo.innerHTML = `ğŸ‰ ë‹¹ì²¨: <b>${picked.label}</b>${(streak % 10 === 0) ? ' + ğŸ <b>10ì—°ì† ë³´ë„ˆìŠ¤: EC Ã—1</b>' : ''}<br>ì—°ì† ${streak}ì¼`;

        refreshDailyInfo(false);
      } catch(e){
        console.error(e);
        dailyInfo.textContent='ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      } finally{
        setSpinLock(false);
      }
    };

    // í”„ë¦¬ë¯¸ì—„(EC -1)
    spinPremiumBtn.onclick = async ()=>{
      if (isSpinning) return;
      if (!window.__PLAY_ALLOWED) { dailyInfo.innerHTML='ëª¨ë°”ì¼ ë˜ëŠ” íŒì—…ì—ì„œë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'; return; }
      if (!uid) { dailyInfo.innerHTML='ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'; return; }
      if (!canSpendEC(1)) { dailyInfo.innerHTML='ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 1)'; return; }

      setMode('premium');
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();
      state.eventCoins -= 1;

      setSpinLock(true);
      try{
        await spinSlot(activeItems, picked);
        picked.onWin();

        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta);
        updateUI();
        dailyInfo.innerHTML=`ğŸ‰ í”„ë¦¬ë¯¸ì—„ ë‹¹ì²¨: <b>${picked.label}</b>`;
      } catch(e){
        console.error(e); dailyInfo.textContent='ì§€ê¸‰ ì˜¤ë¥˜';
      } finally{
        setSpinLock(false);
      }
    };

    // ì´ë²¤íŠ¸ì½”ì¸(EC -10)
    spinEcoinBtn.onclick = async ()=>{
      if (isSpinning) return;
      if (!window.__PLAY_ALLOWED) { dailyInfo.innerHTML='ëª¨ë°”ì¼ ë˜ëŠ” íŒì—…ì—ì„œë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'; return; }
      if (!uid) { dailyInfo.innerHTML='ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'; return; }
      if (!canSpendEC(10)) { dailyInfo.innerHTML='ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: 10)'; return; }

      setMode('ecoin');
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();
      state.eventCoins -= 10;

      setSpinLock(true);
      try{
        await spinSlot(activeItems, picked);
        picked.onWin();

        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta);
        updateUI();
        dailyInfo.innerHTML=`ğŸ‰ EC ìŠ¬ë¡¯ ë‹¹ì²¨: <b>${picked.label}</b>`;
      } catch(e){
        console.error(e); dailyInfo.textContent='ì§€ê¸‰ ì˜¤ë¥˜';
      } finally{
        setSpinLock(false);
      }
    };

    // ===== ë°ì´í„° & ì¶œì„ ìºì‹œ =====
    async function fetchDaily(){
      if (!uid) return;
      const dailyRef = ref(db, `users/${uid}/daily`);
      try{
        const snap = await get(dailyRef);
        dailyCache = snap.exists() ? snap.val() : { lastKey:null, streak:0 };
      }catch{ dailyCache = { lastKey:null, streak:0 }; }
    }
    async function checkDailyAndMaybeShow(){
      await fetchDaily();
      const today = kstDayKey();
      const canClaim = dailyCache?.lastKey !== today;
      refreshDailyInfo(canClaim);
      setMode('daily');
      if (canClaim) openDailyOverlay();
    }
    function openDailyManual(){ checkDailyAndMaybeShow().then(()=>openDailyOverlay()); }
    window.openDailyManual = openDailyManual;

    // ===== ë©”ë‰´ì— "ë‚¨ì€ ì‹œê°„" í‘œì‹œ =====
    const attMenuRight = document.getElementById('attendance-left');
    const attSideRight = document.getElementById('attendance-left-side');
    function updateAttendanceLabels(){
      if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }
      const today = kstDayKey();
      const can = (dailyCache?.lastKey !== today);
      if (can){ attMenuRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; attSideRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; }
      else{
        const left = Math.max(0, nextResetKST()-kstDate());
        const txt = fmtLeft(left);
        attMenuRight.textContent=txt; attSideRight.textContent=txt;
      }
    }
    setInterval(updateAttendanceLabels, 1000);

    // ===== ê²Œì„ UI =====
    function updateUI() {
      document.getElementById('score').innerText  = `ìì›: ${Math.floor(state.resources)}`;
      document.getElementById('coins').innerText  = `ì½”ì¸: ${Math.floor(state.coins)}`;
      document.getElementById('ecoins').innerText = `ì´ë²¤íŠ¸ì½”ì¸: ${Math.floor(state.eventCoins||0)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}ë ™ (${state.shipUpgradeCost}ì½”ì¸)`;
      document.getElementById('ship-img').src = `/images/ship-level${state.shipLevel}.png`;
      document.getElementById('upgrade-ship').disabled = state.coins < state.shipUpgradeCost;

      const clickUp = document.getElementById('click-upgrade');
      clickUp.innerText = `í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (${clickUpgradeCost}ì½”ì¸)`;
      clickUp.disabled = state.coins < clickUpgradeCost;
      document.getElementById('click-power').innerText = state.clickPower;

      const autoBtn = document.getElementById('auto-convert-buy');
      autoBtn.innerHTML = state.autoConvertBought ? 'êµ¬ë§¤ ì™„ë£Œ' : 'ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)';
      autoBtn.disabled = state.autoConvertBought || state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ì•Œë°” ê³ ìš© (${getWorkerCost()}ì½”ì¸)`;
      hireWork.disabled = state.coins < getWorkerCost();
      document.getElementById('resource-per-sec').innerText = (state.workerCount * getWorkerPower() * getResMul()).toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ì½”ì¸ ì•Œë°” (${getConversionCost()}ì½”ì¸)`;
      hireConv.disabled = state.coins < getConversionCost();
      document.getElementById('coin-per-sec').innerText = Math.floor(state.conversionCount * getCoinMul());

      updateBuffBadges();
    }

    function renderPlanets() {
      const planets = [
        {name:'ë‹¬',cost:100,requiredShipLevel:1},{name:'ìˆ˜ì„±',cost:500,requiredShipLevel:2},{name:'ê¸ˆì„±',cost:2000,requiredShipLevel:3},
        {name:'ì§€êµ¬',cost:10000,requiredShipLevel:4},{name:'í™”ì„±',cost:50000,requiredShipLevel:5},{name:'ëª©ì„±',cost:250000,requiredShipLevel:6},
        {name:'í† ì„±',cost:1000000,requiredShipLevel:7},{name:'ì²œì™•ì„±',cost:5000000,requiredShipLevel:8},{name:'í•´ì™•ì„±',cost:20000000,requiredShipLevel:9}
      ];
      const list = document.getElementById('planet-list'); list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.style.margin='10px 0';
        div.innerHTML = `<strong>${p.name}</strong> â€” ${p.cost.toLocaleString()}ì½”ì¸<br>í•„ìš” ë ™: ${p.requiredShipLevel}`;
        const btn = document.createElement('button'); btn.className='general';
        btn.textContent = owned ? 'êµ¬ë§¤ ì™„ë£Œ' : (canBuy ? 'êµ¬ë§¤' : 'ë ™ ë¶€ì¡±'); btn.disabled = owned || !canBuy;
        btn.onclick = () => {
          if (!ensureReady()) return;
          if (state.coins >= p.cost) {
            state.coins -= p.cost; if (!state.ownedPlanets) state.ownedPlanets = []; state.ownedPlanets.push(i);
            save(); updateUI(); renderPlanets();
            if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';
          }
        };
        div.appendChild(btn); list.appendChild(div);
      });
    }

    function spawnParticles(x,y) {
      for (let i=0;i<15;i++){
        const span = document.createElement('span');
        span.className='particle';
        span.style.setProperty('--dx',(Math.random()-0.5)*100+'px');
        span.style.setProperty('--dy',(Math.random()-1)*100+'px');
        span.style.left = x+'px'; span.style.top = y+'px';
        document.getElementById('ore-container').appendChild(span);
        setTimeout(()=>span.remove(),800);
      }
    }

    function ensureReady() {
      if (!window.__PLAY_ALLOWED) { showAuthStatus('PCì—ì„œëŠ” íŒì—…ìœ¼ë¡œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. íŒì—…ìœ¼ë¡œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return false; }
      if (!uid) { showAuthStatus('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'); return false; }
      if (isInitialSync) { showAuthStatus('ë°ì´í„° ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'); return false; }
      showAuthStatus(''); return true;
    }

    // ===== ì´ˆê¸°í™” =====
    function wireGame() {
      document.getElementById('ore').addEventListener('click', e => {
        if (!ensureReady()) return;
        const rect = e.target.getBoundingClientRect();
        spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
        // ìì›Ã—2 ë²„í”„ ì ìš©
        state.resources += state.clickPower * getResMul();
        if (state.autoConvertBought) convertResources();
        save(); updateUI();
      });

      document.getElementById('convert-button').addEventListener('click', () => { if (!ensureReady()) return; convertResources(1); save(); updateUI(); });
      document.getElementById('auto-convert-buy').addEventListener('click', () => { if (!ensureReady()) return; if (!state.autoConvertBought && state.coins >= 100) { state.coins -= 100; state.autoConvertBought = true; save(); updateUI(); } });
      document.getElementById('hire-worker').addEventListener('click', () => { if (!ensureReady()) return; const cost = getWorkerCost(); if (state.coins >= cost) { state.coins -= cost; state.workerCount++; save(); updateUI(); } });
      document.getElementById('hire-conversion').addEventListener('click', () => { if (!ensureReady()) return; const cost = getConversionCost(); if (state.coins >= cost) { state.coins -= cost; state.conversionCount++; save(); updateUI(); } });
      document.getElementById('upgrade-ship').addEventListener('click', () => { if (!ensureReady()) return; if (state.coins >= state.shipUpgradeCost) { state.coins -= state.shipUpgradeCost; state.shipLevel++; state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30); save(); updateUI(); renderPlanets(); } });

      document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }));

      // 1ì´ˆ ë£¨í”„
      window.__gameTimer = setInterval(() => {
        if (!uid || isInitialSync || !window.__PLAY_ALLOWED) return;

        let workerGain = state.workerCount * getWorkerPower() * getResMul(); // ìì›Ã—2 ë°˜ì˜
        if (state.workerCount > 0) state.resources += workerGain;

        let convGain = state.conversionCount * getCoinMul(); // ì½”ì¸Ã—2 ë°˜ì˜
        if (state.conversionCount > 0) state.coins += convGain;

        if (state.autoConvertBought) convertResources();

        // ë²„í”„ ë±ƒì§€ ì—…ë°ì´íŠ¸
        updateBuffBadges();

        save(); updateUI();
      }, 1000);
    }

    onAuthStateChanged(auth, async user => {
      clearTimeout(__bootFailSafe);
      setBootVisible(false);
      showAuthStatus('');
      if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }

      if (user) {
        if (!user.emailVerified) {
          try { showLoginOverlay(false); } catch {}
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¸ì¦ ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
          try { await signOut(auth); } catch {}
          authContainer.style.display = 'block';
          return;
        }

        uid = user.uid;
        dataRef = ref(db, `users/${uid}/gameData`);
        isInitialSync = true;
        try {
          const saved = localStorage.getItem(`lastWrite_${uid}`);
          localLastWrite = saved ? parseInt(saved, 10) : 0;
        } catch { localLastWrite = 0; }

        await ensureInitialData(dataRef);

        dataUnsubscribe = onValue(dataRef, async snap => {
          const server = snap.exists() ? snap.val() : null;
          if (!server) {
            if (isInitialSync) {
              state = { ...defaultData };
              if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
              isInitialSync = false;
              showGameUI();
              window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();
              await checkDailyAndMaybeShow();
              updateAttendanceLabels();
            } else {
              state = { ...defaultData };
              if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
            }
            return;
          }

          const serverLast = server._lastUpdated || 0;
          if (isInitialSync) {
            state = { ...defaultData, ...server };
            if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
            isInitialSync = false;
            showGameUI();
            window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();
            await checkDailyAndMaybeShow();
            updateAttendanceLabels();
            return;
          }

          if (serverLast >= (localLastWrite || 0)) {
            state = { ...defaultData, ...server };
          } else {
            state = { ...defaultData, ...server, ...state };
            try { if (JSON.stringify(server) !== JSON.stringify(state)) save(); }
            catch { save(); }
          }
          if (window.__PLAY_ALLOWED) { updateUI(); renderPlanets(); }
        });

      } else {
        try { showLoginOverlay(false); } catch {}
        uid = null; dataRef = null;
        state = { ...defaultData };
        localLastWrite = 0; isInitialSync = false;

        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        const lb = document.getElementById('logout-btn');
        if (lb) lb.style.display = 'none';
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');

        setAuthMode(currentAuthMode);
      }
    });

    const tabLogin  = document.getElementById('auth-tab-login');
    const tabSignup = document.getElementById('auth-tab-signup');
    const signupExtra = document.getElementById('signup-extra');
    const loginBtn  = document.getElementById('login-btn');
    const signupBtnEl = document.getElementById('signup-btn');

    function setAuthMode(mode) {
      currentAuthMode = (mode === 'signup') ? 'signup' : 'login';
      if (mode === 'signup') {
        tabLogin.classList.remove('active'); tabSignup.classList.add('active');
        signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';
      } else {
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';
      }
      showAuthStatus(''); document.getElementById('verify-info').textContent = '';
      try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}
    }
    tabLogin.addEventListener('click',  () => setAuthMode('login'));
    tabSignup.addEventListener('click', () => setAuthMode('signup'));

    document.getElementById('settings-btn').addEventListener('click', () => {
      try { history.replaceState(null, '', '/ì„¤ì •' + (location.hash || '')); } catch {}
      location.href = '/setting.html';
    });

    loginBtn.addEventListener('click', async () => {
      showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        showLoginOverlay(true, 'ë¡œê·¸ì¸ ì¤‘â€¦ ì ì‹œë§Œìš”');
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        if (user && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showLoginOverlay(false);
          showAuthStatus('ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¸ì¦ ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
          await signOut(auth);
        }
      } catch (err) {
        showLoginOverlay(false);
        const code = err && err.code || '';
        const msg = (
          code === 'auth/wrong-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
          code === 'auth/user-not-found' ? 'ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ë¨¼ì € ì§„í–‰í•˜ì„¸ìš”.' :
          code === 'auth/invalid-email' ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
          code === 'auth/network-request-failed' ? 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.' :
          err.message || 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        );
        showAuthStatus(msg);
      }
    });

    signupBtnEl?.addEventListener('click', async (e) => {
      e.preventDefault(); showAuthStatus('');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('password-confirm').value;
      if (!email || !password || !passwordConfirm) { showAuthStatus('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if (password !== passwordConfirm) { showAuthStatus('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      try {
        showLoginOverlay(true, 'ê³„ì • ìƒì„± ì¤‘â€¦');
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        try { await sendEmailVerification(user); } catch {}
        showLoginOverlay(false);
        showAuthStatus('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼ í™•ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.', false);
        await signOut(auth);
      } catch (err) {
        showLoginOverlay(false);
        const code = err && err.code || '';
        const msg = (
          code === 'auth/email-already-in-use' ? 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' :
          code === 'auth/invalid-email' ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
          code === 'auth/weak-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.' :
          err.message || 'íšŒì›ê°€ì… ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        );
        showAuthStatus(msg);
      }
    });

    const _lb = document.getElementById('logout-btn');
    if (_lb) _lb.addEventListener('click', () => signOut(auth));

    window.addEventListener('load', () => {
      if (window.__PLAY_ALLOWED) wireGame();
      else window.__DEFER_INIT = wireGame;
    });

    window.openDailyManual = function(){ checkDailyAndMaybeShow().then(()=>openDailyOverlay()); }
  </script>

  <!-- ìš°í´ë¦­ ì»¤ìŠ¤í…€ ë©”ë‰´ -->
  <script>
    const customMenu = document.getElementById('custom-menu');
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    });
    customMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('.menu-item');
      const action = btn && btn.getAttribute('data-action');
      if (!action) return;
      if (action === 'menu') {
        try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
        try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
        try { window.close(); } catch {}
        setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
      }
      if (action === 'download') { location.href='/app-download.html'; }
      if (action === 'resume')   { customMenu.style.display='none'; }
      if (action === 'rank')     { location.href='/ranking.html'; }
      if (action === 'attendance'){
        customMenu.style.display='none';
        try{ 
          if (window.openDailyManual) window.openDailyManual(); 
          else setTimeout(()=>{ window.openDailyManual && window.openDailyManual(); }, 200);
        }catch{} 
      }
    });
    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display='none'; });
  </script>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ (ì•ˆì „ ë°”ì¸ë”©) -->
  <script>
    function __bindSideMenu(){
      const sideToggle = document.getElementById('side-menu-toggle');
      const sideMenu   = document.getElementById('side-menu');
      const backdrop   = document.getElementById('side-backdrop');

      if (!sideToggle || !sideMenu || !backdrop) return false;

      sideToggle.style.pointerEvents = 'auto';

      function openSide(){
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closeSide(){
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }

      sideToggle.replaceWith(sideToggle.cloneNode(true));
      backdrop.replaceWith(backdrop.cloneNode(true));
      const _sideToggle = document.getElementById('side-menu-toggle');
      const _backdrop   = document.getElementById('side-backdrop');

      _sideToggle.addEventListener('click', openSide);
      _backdrop.addEventListener('click', closeSide);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

      document.getElementById('side-menu').addEventListener('click', (e)=>{
        const btn = e.target.closest('.side-item');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'menu') {
          try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
          try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
          try { window.close(); } catch {}
          setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
        }
        if (action === 'download') { location.href='/app-download.html'; }
        if (action === 'rank')     { location.href='/ranking.html'; }
        if (action === 'attendance'){
          try{ 
            if (window.openDailyManual) window.openDailyManual(); 
            else setTimeout(()=>{ window.openDailyManual && window.openDailyManual(); }, 200);
          }catch{}
        }
        if (action === 'resume')   { /* ë‹«ê¸°ë§Œ */ }
        closeSide();
      });

      return true;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      if (!__bindSideMenu()){
        setTimeout(__bindSideMenu, 0);
        setTimeout(__bindSideMenu, 300);
        setTimeout(__bindSideMenu, 1000);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({
      disableMenu: false,
      disableSelect: true,
      disableCopy: true,
      disableCut: true,
      disablePaste: true,
      clearIntervalWhenDevOpenTrigger: true,
      ondevtoolopen(type, next) {
        try { window.close(); } catch {}
        next();
      },
      ondevtoolclose() { console.warn('DevTools ë‹«í˜ ê°ì§€ë¨'); }
    });
  </script>

  <!-- ì›ê²© ì œì–´ -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- Firebase ì»¤ë§¨ë“œ(ì„¸ì…˜ ì œì–´) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, query, orderByChild, equalTo, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app2 = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth2 = getAuth(app2);
    const db2   = getDatabase(app2);

    let sessionId = null;

    function setActiveSession(id){
      if (!id) return;
      sessionId = String(id);
      try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}
      bindCommands(sessionId);
      watchSessionEnd(sessionId);
    }

    function bindCommands(id){
      const cmdRef = ref(db2, `sessions/${id}/commands`);
      onChildAdded(cmdRef, (snap) => {
        const cmd = snap.val() || {};
        try {
          if (cmd.type === 'navigate' && cmd.path){
            if (/^https?:\/\//i.test(cmd.path)) {
              const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;
              if (ok) location.assign(cmd.path);
            } else { location.assign(cmd.path); }
          }
          else if (cmd.type === 'click' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){
              el.focus?.(); el.click?.();
              el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window })); }
          }
          else if (cmd.type === 'highlight' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){ const prev = el.style.outline; el.style.outline = '3px solid #00e5ff'; setTimeout(()=>{ el.style.outline = prev; }, 1800); }
          }
        } catch (e) { /* noop */ }
      });
    }

    function watchSessionEnd(id){
      const statusRef = ref(db2, `sessions/${id}/meta/status`);
      onValue(statusRef, (snap) => {
        if (snap.val() === 'ended') {
          try { sessionStorage.removeItem('cobrowse_session_id'); } catch {}
        }
      });
    }

    try { sessionId = sessionStorage.getItem('cobrowse_session_id') || null; } catch {}
    if (sessionId) {
      setActiveSession(sessionId);
    } else {
      onAuthStateChanged(auth2, (user) => {
        if (!user) return;
        const q = query(ref(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));
        onValue(q, (snap) => {
          let latestId = null, latestAt = 0;
          snap.forEach(child => {
            const v = child.val();
            const st = v?.meta?.status;
            const created = v?.meta?.createdAt || 0;
            if (st === 'active' && created > latestAt) { latestAt = created; latestId = child.key; }
          });
          if (latestId) setActiveSession(latestId);
        }, { onlyOnce: true });
      });
    }
  </script>

  <!-- Popup Enforcement (ê°„ì†Œ) -->
  <script>
    (function(){
      const gate = document.getElementById('popup-gate');
      if (!gate) {
        window.__PLAY_ALLOWED = (function(){
          function isMobileStrict(){
            try { if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') return navigator.userAgentData.mobile; } catch {}
            const ua = navigator.userAgent || '';
            if (/(Android|iPhone|iPad|iPod|Windows Phone|BlackBerry|IEMobile|Mobile)/i.test(ua)) return true;
            if (/Mac/.test(navigator.platform || '') && (navigator.maxTouchPoints || 0) > 1) return true;
            const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
            const canHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
            return (coarse && !canHover);
          }
          function isPopup(){ try { if (window.opener && !window.opener.closed) return true; } catch {} try { if (['gameWindow','siuGame','popup'].includes(window.name)) return true; } catch {} return false; }
          return isMobileStrict() || isPopup();
        })();
        if (window.__PLAY_ALLOWED){ ['top-bar','container'].forEach(id => { const el=document.getElementById(id); if(el) el.style.visibility='visible'; }); }
        return;
      }
    })();
  </script>
</body>
</html>
