<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</title>

  <!-- ÏµúÏ¥à Ï†ëÏÜç Ïãú /loginÏúºÎ°ú ÌïúÎ≤àÎßå ÎùºÏö∞ÌåÖ (ÏõπÎ∑∞/ÏûÑÎ≤†ÎîîÎìú Ïï±ÏùÄ Ï£ºÏÜå Î≥ÄÍ≤Ω ÏÉùÎûµ) -->
  <script>
    const __isEmbeddedApp__ = (() => {
      try {
        const ua = (navigator.userAgent || '').toLowerCase();
        if (ua.includes('; wv') || ua.includes(' wv)') || ua.includes('wv)') || /\bwv\b/.test(ua)) return true;
        if (/(iphone|ipad|ipod).+applewebkit(?!.*safari)/i.test(navigator.userAgent || '')) return true;
        if (window.ReactNativeWebView || window.flutter_inappwebview || window.AndroidBridge) return true;
        if (window.Capacitor && window.Capacitor.isNativePlatform) return true;
        if (window.webkit && window.webkit.messageHandlers) return true;
      } catch {}
      return false;
    })();

    try {
      document.documentElement.dataset.embeddedApp = __isEmbeddedApp__ ? '1' : '0';
      window.__IS_EMBEDDED_APP = __isEmbeddedApp__;
    } catch {}

    try {
      if (!__isEmbeddedApp__ && !sessionStorage.getItem('pmode_init')) {
        history.replaceState(null, '', '/login' + (location.hash || ''));
        sessionStorage.setItem('pmode_init', '1');
      }
    } catch (e) {}
  </script>

  <!-- ÌåùÏóÖ/Î¶¨Îã§Ïù¥Î†âÌä∏ Î∂ÄÎ™® Î≥¥Ïïà ÏïåÎ¶º/ÌóàÏö© ÎèÑÎ©îÏù∏ -->
  <script>
    const allowedParentOrigins = [
      location.origin,
      'https://xn--989a202a4ogwtc69p.siustudio.me',
      'https://siustudio.me'
    ];
    function isAllowedRedirect(urlStr) {
      try {
        const u = new URL(urlStr);
        if (u.protocol !== 'https:') return false;
        const host = u.hostname;
        const base1 = 'xn--989a202a4ogwtc69p.siustudio.me';
        const base2 = 'siustudio.me';
        return (host === base1 || host === base2 ||
          host.endsWith('.' + base1) || host.endsWith('.' + base2));
      } catch { return false; }
    }
    let parentOrigin     = sessionStorage.getItem('parent_origin')     || null;
    let pendingRedirect  = sessionStorage.getItem('pending_redirect')  || null;
    let pendingState     = sessionStorage.getItem('pending_state')     || null;

    function consumePendingRedirect() {
      let target = null;
      try {
        const fromStorage = sessionStorage.getItem('pending_redirect');
        if (fromStorage) {
          sessionStorage.removeItem('pending_redirect');
          target = fromStorage;
        }
      } catch {}
      if (!target && pendingRedirect) target = pendingRedirect;
      pendingRedirect = null;
      return (target && isAllowedRedirect(target)) ? target : null;
    }

    function notifyReadyToParent() {
      try {
        if (window.opener && !window.opener.closed) {
          allowedParentOrigins.forEach((o) => {
            try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}
          });
        }
      } catch {}
    }
    notifyReadyToParent();

    function notifyAuthSuccessAndExit() {
      const target = consumePendingRedirect();
      const hasParent = window.opener && !window.opener.closed && parentOrigin;
      if (hasParent) {
        try {
          window.opener.postMessage({
            type: 'auth-success', ok: true, redirect: target || undefined, receivedState: pendingState
          }, parentOrigin);
        } catch {}
        try { window.close(); } catch {}
        return;
      }
      if (target) window.location.href = target;
    }
    window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;
  </script>

  <style>
    :root{
      --glass-bg: rgba(10,12,20,0.40);
      --glass-brd: rgba(255,255,255,0.08);
      --accent: #00d4ff;
      --bottom-stack-space: calc(220px + env(safe-area-inset-bottom, 0px));
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100vh;
    }
    body {
      font-family:Inter, Arial, sans-serif;
      background:url('/images/space-bg.jpg') center center / cover no-repeat fixed;
      color:#fff;
    }
    #snow-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:5;
      mix-blend-mode:screen;
    }
    .snowflake{
      position:absolute;
      top:-6px;
      width:4px;
      height:4px;
      background:rgba(255,255,255,0.9);
      border-radius:50%;
      box-shadow:0 0 6px rgba(255,255,255,0.55);
      animation: snowFall linear infinite;
      opacity:0.7;
    }
    @keyframes snowFall {
      0%   { transform: translate3d(0, -10px, 0); opacity:0; }
      10%  { opacity:0.9; }
      100% { transform: translate3d(var(--drift, 0px), 110vh, 0); opacity:0.95; }
    }
    body.game-hard-blocked #top-bar,
    body.game-hard-blocked #container { filter: grayscale(0.65); pointer-events:none; user-select:none; opacity:0.55; }
    body.game-hard-blocked #top-bar { opacity:0.35; }
    #container .hard-block-disabled,
    #top-bar .hard-block-disabled { pointer-events:none !important; opacity:0.5; }
    img { display:block; }

    /* Î∂ÄÌåÖ/Ïä§ÌîºÎÑà */
    #top-bar, #container { visibility: hidden; }
    .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #boot-overlay{
      position:fixed; inset:0; z-index:3000;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      backdrop-filter: blur(3px);
    }
    #boot-overlay .card{
      width:min(420px,92vw); border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));
      padding:16px; text-align:center; color:#e6f7ff;
      box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* Î°úÍ∑∏Ïù∏ Ïπ¥Îìú */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));
      box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
      display:none;
      max-height: min(92vh, 760px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #auth-container.hidden { opacity:0; transform: translate(-50%, -46%) scale(.98); pointer-events:none; visibility:hidden; }
    #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }
    .gtranslate_wrapper{ display:none !important; }
    #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20); color:#fff; outline:none; font-size:14px; }
    #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.22); }
    #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }
    #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer; }
    #auth-container .policy-consent { margin-top:8px; display:flex; flex-direction:column; gap:6px; text-align:left; font-size:13px; color:#e3f3ff; }
    #auth-container .policy-consent label { display:flex; gap:8px; align-items:flex-start; line-height:1.45; }
    #auth-container .policy-consent input[type="checkbox"] { margin-top:3px; }
    #auth-container .policy-consent .policy-link { background:none; border:none; color:#9fdcff; padding:0; margin-left:6px; font-size:12px; text-decoration:underline; cursor:pointer; }
    #auth-container .policy-consent .policy-link:focus { outline:1px dashed rgba(159,220,255,0.7); outline-offset:2px; }
    .code-details-toggle {
      margin-top:8px;
      font-size:12px;
      color:#9fdcff;
      background:none;
      border:none;
      padding:0;
      cursor:pointer;
      text-decoration:underline;
    }
    .code-details {
      margin-top:8px;
      font-size:0.9rem;
      color:#ccc;
      display:none;
      text-align:left;
    }

    .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }
    .auth-status.show { opacity:1; transform:translateY(0); }

    .login-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60)); border-radius:14px; z-index:1100; opacity:1; pointer-events:auto; }
    .login-overlay.show { display:flex; }

    #policy-overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(5,10,20,0.78); backdrop-filter:blur(6px);
      z-index:2600; opacity:0; pointer-events:none; transition:opacity .24s ease;
      padding:20px;
    }
    #policy-overlay.show { opacity:1; pointer-events:auto; }
    #policy-overlay .policy-modal {
      width:min(840px, 96vw);
      background:linear-gradient(180deg, rgba(13,18,30,0.92), rgba(8,12,22,0.96));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      box-shadow:0 24px 70px rgba(0,0,0,0.55);
      padding:18px 20px 20px;
      display:flex; flex-direction:column; gap:14px; color:#e8f6ff;
      max-height: min(92vh, 820px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #policy-overlay .policy-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #policy-overlay .policy-header h3 { margin:0; font-size:18px; color:#f0fbff; }
    #policy-overlay .policy-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #policy-overlay button.policy-close,
    #policy-overlay a.policy-open-new {
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; border-radius:8px; font-size:13px; font-weight:600;
      border:1px solid rgba(159,220,255,0.35); background:rgba(0,166,255,0.10);
      color:#d9f2ff; cursor:pointer; text-decoration:none;
    }
    #policy-overlay button.policy-close:hover,
    #policy-overlay a.policy-open-new:hover { background:rgba(0,166,255,0.20); }
    #policy-overlay button.policy-close { background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.18); }
    #policy-overlay button.policy-close:hover { background:rgba(0,0,0,0.35); }
    #policy-overlay iframe {
      width:100%; height:70vh; border:none; border-radius:12px;
      background:#ffffff; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    #policy-overlay .policy-foot { font-size:12px; color:#bcd8ee; text-align:right; }
    @media (max-width:600px) {
      #policy-overlay iframe { height:60vh; }
      #policy-overlay .policy-actions { width:100%; justify-content:flex-end; }
    }

    .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; }
    html[data-embedded-app="1"] #google-btn { display:none !important; }
    html[data-embedded-app="0"] #btnGoogleLoginCode,
    html[data-embedded-app="0"] #codeArea { display:none !important; }

    @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

    /* ÏÉÅÎã® Î∞î */
    #top-bar {
      position: fixed; top: 5px; left: 5px; right: 5px;
      display: flex; flex-wrap: wrap; gap:6px 8px;
      justify-content: space-between; align-items: center;
      background: rgba(30,30,30,0.55);
      padding:6px 10px; border-radius:8px;
      font-size:12px; z-index:1000;
      border: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
      overflow: hidden;
    }
    .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden; }
    .bar-group img { width:16px; height:16px; }
    .bar-group span { white-space: nowrap; }
    #ship-img{
      width:140px; max-width:60vw;
      height:auto;
      margin:0 auto 10px;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,0.35));
    }
    .ship-panel{
      margin:0 auto;
      padding:16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(5,9,18,0.55));
      box-shadow: 0 18px 44px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05);
      max-width:360px;
      display:flex;
      flex-direction:column;
      gap:12px;
      text-align:center;
    }
    .ship-panel h2{
      margin:0;
      font-size:18px;
      color:#e9f7ff;
    }
    .ship-panel p{
      margin:0;
      color:#bcd8ee;
      font-size:13px;
      line-height:1.5;
    }
    .ship-panel .ship-status{
      font-size:15px;
      font-weight:700;
      color:var(--accent);
    }
    .ship-panel .general{
      width:100%;
      max-width:none;
    }
    .ship-ec-tabs{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:4px;
    }
    .ship-ec-tab{
      flex:1;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      color:#e8f6ff;
      cursor:pointer;
      font-weight:700;
      transition:all .18s ease;
    }
    .ship-ec-tab.active{
      background:linear-gradient(90deg,#00c0ff,#0077ff);
      color:#00101b;
      border-color:rgba(0,180,255,0.55);
      box-shadow:0 8px 22px rgba(0,160,255,0.22);
    }
    .ship-ec-panel{ display:none; text-align:left; }
    .ship-ec-panel.active{ display:block; }
    .ship-ec-note{ margin:6px 0 8px; color:#cde8ff; font-size:12px; }
    .ship-enhance-info{ margin-top:-4px; font-size:13px; color:#c6e7ff; }
    .ship-enhance-status{ min-height:22px; font-size:13px; color:#dbe9ff; transition:color .2s ease; }
    .ship-enhance-status[data-tone="success"]{ color:#8ef7c2; }
    .ship-enhance-status[data-tone="warn"]{ color:#ffb7b7; }
    .ship-panel.enhancing #ship-img{ animation: drumPulse .38s ease-in-out infinite; }
    .ship-panel.success-glow{ box-shadow:0 0 0 0 rgba(0,212,255,0.22), 0 16px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05); }
    .ship-panel.fail-shake{ animation: shipShake .36s ease; }
    @keyframes drumPulse{ 0%{ transform:scale(1); } 50%{ transform:scale(1.04); } 100%{ transform:scale(1); } }
    @keyframes shipShake{ 0%,100%{ transform:translateX(0); } 20%{ transform:translateX(-6px); } 40%{ transform:translateX(6px); } 60%{ transform:translateX(-4px); } 80%{ transform:translateX(4px); } }

    #settings-btn {
      margin-left: 8px; padding: 6px 10px; border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;
      cursor: pointer; font-weight: 700;
    }
    #settings-btn:hover { filter: brightness(1.08); }
    #guest-login-btn {
      display: none;
      margin-left: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(0,180,255,0.18), rgba(0,120,255,0.24));
      border: 1px solid rgba(0,200,255,0.45);
      color: #001624;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,140,255,0.18);
    }
    #guest-login-btn:hover { filter: brightness(1.08); }

    /* ÏÉà Î≤ÑÌîÑ Î≤ÑÌäº */
    #buff-btn{
      margin-left: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      background: rgba(0,212,255,0.12);
      border: 1px solid rgba(0,212,255,0.35);
      color:#e6f5ff;
      cursor:pointer;
      font-weight:700;
      backdrop-filter: blur(4px);
    }
    #buff-btn:hover{ background: rgba(0,212,255,0.25); }

    /* ÏùòÏã¨ÎèÑ Î∞∞ÏßÄ: ÏöîÍµ¨ÏÇ¨Ìï≠ÎåÄÎ°ú ÏôÑÏ†Ñ Ïà®ÍπÄ */
    #suspicion-badge{ display:none !important; }

    /* Î≥∏Î¨∏ */
    .page-shell{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(260px, 360px);
      gap:12px;
      width:min(1200px, 96vw);
      margin:80px auto 32px;
      padding:0 6px;
      box-sizing:border-box;
      align-items:flex-start;
    }
    .game-area{ min-width:0; }
    .ad-area{
      position:sticky;
      top:64px;
      align-self:flex-start;
      margin-bottom: calc(140px + env(safe-area-inset-bottom, 0px));
    }
    #container { margin:0; width:100%; max-width:none; padding:16px 20px; background:rgba(30,30,30,0.55); border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.08); box-sizing:border-box; }
    h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }
    button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }

    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }

    #planets-content .planet-tabbar {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:6px 0 12px;
    }
    #planets-content .planet-subtab {
      padding:8px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.05);
      color:#e6f7ff;
      cursor:pointer;
      font-weight:700;
    }
    #planets-content .planet-subtab.active {
      background:linear-gradient(90deg, rgba(0,212,255,0.35), rgba(0,119,255,0.35));
      border-color:rgba(0,212,255,0.6);
      box-shadow:0 6px 16px rgba(0,160,255,0.18);
    }
    #planets-content .planet-panel { display:none; }
    #planets-content .planet-panel.active { display:block; }
    #planets-content .planet-card,
    #planets-content .planet-info-box {
      margin:10px 0;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      text-align:left;
    }
    #planets-content .planet-card strong { display:block; margin-bottom:4px; }
    #planets-content .planet-card .planet-actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    #planets-content .planet-card button.general { width:auto; padding:10px 14px; margin:0; }

    .ore-frag {
      position: absolute;
      width: 46px;
      height: 46px;
      pointer-events: none;
      opacity: .95;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.45));
      transform: translate(-50%, -50%) scale(var(--start-scale, .55)) rotate(var(--start-rot, 0deg));
      animation: oreScatter .72s ease-out forwards;
    }
    @keyframes oreScatter {
      0% {
        opacity: .95;
        transform: translate(-50%, -50%) scale(var(--start-scale, .55)) rotate(var(--start-rot, 0deg));
      }
      100% {
        opacity: 0;
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(var(--end-scale, .28)) rotate(var(--rot, 0deg));
      }
    }
    #ore { width:200px; cursor:pointer; }

    /* Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ */
    #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.90); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }
    .count-badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; padding:2px 6px; border-radius:999px; background:#ff7a9a; color:#fff; font-size:11px; font-weight:700; }
    .count-badge.hidden { display:none; }
    #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

    /* Î∞îÌÖÄ ÎÇ¥ÎπÑ */
    #bottom-nav{
      position: fixed;
      left: 50%; bottom: calc(86px + env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%);
      display: flex; gap: 8px; padding: 8px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-brd);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      z-index: 1200; max-width: 96vw;
      width: min(720px, calc(100% - 24px));
      flex-wrap: nowrap;
      transition: opacity .22s ease, transform .15s ease;
    }
    #bottom-nav.nav-locked{ position: absolute; z-index: 0; }
    #bottom-nav-guard{ width:100%; height:1px; margin:0; padding:0; position:relative; pointer-events:none; }
    #bottom-nav .tab{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 5px; min-width: 0; padding: 10px 10px; font-size: 13px;
      color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06); transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
      flex: 1 1 0;
      white-space: nowrap;
    }
    #bottom-nav .tab:hover{ transform: translateY(-1px); }
    #bottom-nav .tab.active{
      color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);
      border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);
    }
    .event-panel{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px; align-items:flex-start; }
    .event-card{ background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:12px; box-shadow:0 8px 26px rgba(0,0,0,0.35); }
    .event-card h3{ margin:0 0 8px; font-size:16px; display:flex; gap:8px; align-items:center; }
    .event-stats{ display:flex; flex-direction:column; gap:6px; font-size:14px; }
    .event-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .event-actions button{ flex:1 1 150px; }
    .event-hint{ margin:10px 0 0; font-size:12px; color:#ffdede; opacity:0.92; }
    .christmas-launch{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #christmas-start{ flex: 0 0 auto; }
    #christmas-launch-hint{ font-size:13px; color:#cfe6ff; opacity:0.9; }
    #christmas-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:12px; background:rgba(0,0,0,0.78); backdrop-filter:blur(10px); z-index:2000; }
    #christmas-overlay.show{ display:flex; }
    .christmas-modal{ position:relative; width:min(1600px, 98vw); height:min(98vh, 1100px); padding:0; background:rgba(2,6,12,0.60); border-radius:18px; border:1px solid rgba(255,255,255,0.10); box-shadow:0 24px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.06); display:flex; flex-direction:column; overflow:hidden; }
    #christmas-overlay iframe{ flex:1; width:100%; min-height:0; border:none; border-radius:16px; background:#000; box-shadow:0 16px 40px rgba(0,0,0,0.38), inset 0 1px 0 rgba(255,255,255,0.05); }
    #christmas-close{ position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:50%; border:1px solid rgba(255,255,255,0.28); background:rgba(0,0,0,0.55); color:#e6f7ff; font-size:18px; cursor:pointer; box-shadow:0 12px 26px rgba(0,0,0,0.35); backdrop-filter:blur(8px); z-index:5; display:flex; align-items:center; justify-content:center; }
    #christmas-close:hover{ background:rgba(255,255,255,0.18); }
    .tree-status{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .tree-figure{ width:120px; height:120px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; background:rgba(0,0,0,0.25); object-fit:contain; }
    .tree-rewards{ margin:10px 0; padding:10px; border-radius:10px; background:rgba(0,0,0,0.25); border:1px dashed rgba(255,255,255,0.14); font-size:13px; line-height:1.5; }
    .tree-rewards strong{ color:#ffe08a; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.08); font-size:13px; }
    .pill img{ width:18px; height:18px; }
    #permanent-buffs{ margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.08); font-size:13px; color:#cfe6ff; line-height:1.45; }

    #container{ padding-bottom: var(--bottom-stack-space); }
    #planets-content{ padding-bottom: var(--bottom-stack-space); }
    #upgrades-content{ padding-bottom: calc(var(--bottom-stack-space) + 20px); }

    @media (max-width: 1024px){
      .page-shell{ grid-template-columns: minmax(0, 1fr) minmax(240px, 320px); }
    }
    @media (max-width: 900px){
      .page-shell{ grid-template-columns: 1fr; margin-top:78px; }
      .ad-area{
        position:relative;
        top:auto;
        width:100%;
        margin-bottom: calc(160px + env(safe-area-inset-bottom, 0px));
      }
      .coupang-inline{ justify-content:flex-start; }
      .coupang-card{ width:min(520px, 94vw); }
    }
    @media (max-width: 420px){
      #top-bar{ font-size:11px; padding:6px 8px; }
      #settings-btn{ padding:5px 8px; font-size:12px; }
      #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; bottom: calc(86px + env(safe-area-inset-bottom, 10px)); padding: 6px; }
      #bottom-nav .tab{ padding:9px 8px; min-width:0; font-size:12px; }
      h1{ font-size:1.2em; }
    }

    @media (max-width: 600px){
      #bottom-nav{ gap:6px; padding:6px; }
      #bottom-nav .tab{ padding:9px 8px; font-size:12px; }
    }

    @media (max-width: 420px){
      #bottom-nav .tab{ padding:8px 6px; font-size:11px; gap:4px; }
    }

    /* ÏÇ¨Ïù¥Îìú Î©îÎâ¥ */
    #side-menu-toggle{
      position: fixed; left: 8px; bottom: calc(18px + env(safe-area-inset-bottom, 0px));
      z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;
      display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }
    #side-backdrop.show{ opacity:1; pointer-events:auto; }
    #side-menu{
      position: fixed; top: 0; left:  0; bottom:  0; width: 260px; max-width: 84vw;
      transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);
      background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);
    }
    #side-menu.open{ transform: translateX(0); }
    .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .side-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none; }
    .side-item:hover{ filter: brightness(1.08); }
    .side-item .icon{ width:18px; text-align:center; }
    .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }
    @media (max-width: 420px){ #side-menu-toggle{ bottom: calc(18px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; } #side-menu{ width: 240px; } }

    /* ===== Ï∂úÏÑù & Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ ===== */
    #daily-overlay{
      position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);
    }
    #daily-overlay.show{ display:flex; }
    #daily-card{
      width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));
      padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);
      color:#eaf6ff;
    }
    #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    #daily-info{ margin:6px 0 10px; font-size:12px; color:#cfe6ff; min-height:36px; }
    #slot-access-info{ margin:4px 0 10px; font-size:11px; color:#a8dcff; line-height:1.5; }
    #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

    /* ÌÄòÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ */
    #quest-overlay{
      position:fixed; inset:0; z-index:3600;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(4,8,16,0.55), rgba(4,8,16,0.78));
      backdrop-filter: blur(6px);
      opacity:0; pointer-events:none; transition:opacity .22s ease;
      padding:18px;
    }
    #quest-overlay.show{ opacity:1; pointer-events:auto; }
    #quest-card{
      width:min(680px, 96vw);
      background: linear-gradient(180deg, rgba(18,24,36,0.95), rgba(10,16,28,0.96));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(0,0,0,0.45);
      color:#e6f4ff;
      display:flex; flex-direction:column; gap:12px;
      padding:18px 20px 20px;
      max-height:92vh;
      overflow:hidden;
    }
    #quest-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; touch-action:none; user-select:none; cursor:grab; }
    #quest-head h3{ margin:0; font-size:20px; }
    #quest-close{ border:none; background:rgba(255,255,255,0.08); color:#f2fbff; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:14px; }
    #quest-close:hover{ background:rgba(255,255,255,0.15); }
    .quest-body{ flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-right:4px; max-height:calc(92vh - 84px); touch-action:pan-y; }
    .quest-tabbar{ display:flex; gap:8px; }
    .qtab{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); color:#dff2ff; font-weight:700; cursor:pointer; }
    .qtab.active{ background:linear-gradient(120deg, rgba(0,214,255,0.18), rgba(0,122,255,0.24)); border-color:rgba(0,214,255,0.45); color:#001018; text-shadow:0 1px 10px rgba(0,214,255,0.35); }
    #quest-panels{ display:flex; flex-direction:column; gap:12px; }
    .quest-panel{ display:none; flex-direction:column; gap:10px; }
    .quest-panel.active{ display:flex; }
    .quest-desc{ margin:0; color:#cfe6ff; font-size:13px; }
    .quest-list{ display:flex; flex-direction:column; gap:10px; }
    .quest-item{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); }
    .quest-item.done{ border-color:rgba(0,214,255,0.40); box-shadow:0 0 0 1px rgba(0,214,255,0.12); }
    .quest-title{ font-weight:800; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .quest-progress{ position:relative; margin-top:8px; background:rgba(255,255,255,0.08); height:12px; border-radius:999px; overflow:hidden; }
    .quest-bar{ position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #00c6ff, #7cf7ff); box-shadow:0 0 14px rgba(0,214,255,0.45); }
    .quest-numbers{ margin-top:6px; color:#c5e6ff; font-size:12px; display:flex; justify-content:space-between; align-items:center; }
    .quest-summary{ padding:10px 12px; background:rgba(255,255,255,0.06); border-radius:12px; border:1px solid rgba(255,255,255,0.08); color:#e9f6ff; font-size:13px; }

    /* ===== Ïö∞Ìé∏Ìï® Ïò§Î≤ÑÎ†àÏù¥ ===== */
    #mail-overlay{
      position:fixed; inset:0; z-index:3600;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(4,8,16,0.55), rgba(4,8,16,0.78));
      backdrop-filter: blur(6px);
      opacity:0; pointer-events:none; transition:opacity .22s ease;
      padding:18px;
    }
    #mail-overlay.show{ opacity:1; pointer-events:auto; }
    #mail-card{
      width:min(860px, 96vw);
      background: linear-gradient(180deg, rgba(18,24,36,0.95), rgba(10,16,28,0.96));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(0,0,0,0.45);
      color:#e6f4ff;
      display:flex; flex-direction:column; gap:16px;
      padding:20px 22px;
      max-height:92vh;
    }
    #mail-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #mail-head h3{ margin:0; font-size:20px; }
    #mail-close{
      border:none; background:rgba(255,255,255,0.08);
      color:#f2fbff; border-radius:8px; padding:6px 10px;
      cursor:pointer; font-size:14px;
    }
    #mail-close:hover{ background:rgba(255,255,255,0.15); }
    #mail-content{ display:flex; gap:16px; flex-wrap:wrap; }
    #mail-list{
      flex:1 1 280px; max-height:360px; overflow-y:auto;
      display:flex; flex-direction:column; gap:8px;
    }
    .mail-item{
      display:flex; flex-direction:column; gap:6px;
      padding:10px 12px; border-radius:12px; text-align:left;
      border:1px solid rgba(159,220,255,0.18);
      background:rgba(255,255,255,0.04);
      color:#e8f7ff; cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .mail-item:hover{ transform:translateY(-2px); }
    .mail-item.unread{ border-color:rgba(0,212,255,0.45); background:rgba(0,212,255,0.14); }
    .mail-item.selected{ box-shadow:0 0 0 2px rgba(0,212,255,0.55); }
    .mail-item .mail-subject{ font-weight:700; font-size:14px; color:#f5fbff; }
    .mail-item .mail-preview{ font-size:12px; color:#b7d8ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .mail-item .mail-meta{ display:flex; justify-content:space-between; gap:8px; font-size:11px; color:#8fb9ff; }
    #mail-detail{
      flex:2 1 360px; min-height:280px; max-height:360px;
      background:rgba(8,12,20,0.55);
      border:1px solid rgba(159,220,255,0.18);
      border-radius:12px; padding:16px;
      overflow:auto; display:flex; flex-direction:column; gap:12px;
    }
    #mail-detail h4{ margin:0; font-size:16px; }
    #mail-detail .mail-meta-line{ font-size:12px; color:#9fc8ff; margin-top:4px; }
    #mail-detail .mail-body{ white-space:pre-wrap; line-height:1.6; color:#d8ecff; }
    .mail-empty{ text-align:center; color:#9fc8ff; margin:40px auto; font-size:14px; }
    #mail-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:auto; }
    #mail-actions button{
      border:none; border-radius:10px; padding:10px 14px; font-weight:700;
      cursor:pointer; color:#00121a;
      background:linear-gradient(90deg,#00c0ff,#00a2ff);
    }
    #mail-actions button.secondary{
      background:rgba(0,0,0,0.25); color:#e6f4ff; border:1px solid rgba(159,220,255,0.30);
    }
    #mail-actions button:disabled{ opacity:0.55; cursor:not-allowed; }
    #mail-rewards{ font-size:13px; color:#cfe6ff; display:flex; flex-direction:column; gap:4px; }
    #mail-rewards span{ display:flex; align-items:center; gap:6px; }
    #mail-compose-section{
      border-top:1px solid rgba(159,220,255,0.18);
      padding-top:12px; display:none; flex-direction:column; gap:10px;
    }
    #mail-compose-section.show{ display:flex; }
    #mail-compose-section h4{ margin:0; font-size:15px; }
    #mail-compose-section .mail-hint{ margin:0; font-size:12px; color:#90baff; }
    .mail-field{ display:flex; flex-direction:column; gap:4px; font-size:12px; color:#cfe6ff; }
    #mail-compose-section input,
    #mail-compose-section textarea,
    #mail-compose-section select{
      background:rgba(6,10,20,0.55);
      border:1px solid rgba(159,220,255,0.25);
      border-radius:10px;
      color:#e9f6ff;
      padding:8px 10px;
      font-size:13px;
    }
    #mail-compose-section textarea{ min-height:90px; resize:vertical; }
    .mail-compose-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; }
    #mail-compose-send{
      align-self:flex-end;
      border:none; border-radius:10px;
      padding:10px 16px; font-weight:700; font-size:13px;
      color:#00121a; cursor:pointer;
      background:linear-gradient(90deg,#00f2ff,#00b6ff);
      box-shadow:0 10px 24px rgba(0,160,255,0.22);
    }
    #mail-compose-send:hover{ filter:brightness(1.05); }

    /* ===== ÏÉÅÏ†ê Ïò§Î≤ÑÎ†àÏù¥ ===== */
    #shop-overlay{
      position:fixed; inset:0; z-index:3650;
      display:none; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(4,8,16,0.58), rgba(4,8,16,0.82));
      backdrop-filter:blur(7px);
      padding:20px;
    }
    #shop-overlay.show{ display:flex; }
    #shop-overlay .shop-card{
      width:min(960px,96vw); height:min(720px,92vh);
      background:linear-gradient(180deg, rgba(18,24,36,0.95), rgba(8,12,22,0.97));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 30px 70px rgba(0,0,0,0.52);
      padding:18px 20px;
      display:flex; flex-direction:column; gap:14px;
      color:#e6f7ff;
    }
    #shop-overlay .shop-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #shop-overlay h3{ margin:0; font-size:18px; color:#f0fbff; }
    #shop-overlay p{ margin:0; font-size:13px; color:#bed9f5; }
    #shop-close{
      border:none; border-radius:8px; padding:6px 12px;
      background:rgba(0,0,0,0.25); color:#d9f2ff; font-weight:600; cursor:pointer;
      transition:background .18s ease;
    }
    #shop-close:hover{ background:rgba(0,0,0,0.38); }
    #shop-frame{
      flex:1 1 auto; width:100%; border:none; border-radius:12px;
      background:#ffffff; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    @media (max-width:720px){
      #shop-overlay .shop-card{ padding:16px; border-radius:14px; }
      #shop-frame{ border-radius:10px; }
    }
    @media (max-width:720px){
      #mail-card{ max-height:94vh; }
      #mail-list{ max-height:240px; }
      #mail-detail{ min-height:200px; max-height:260px; }
    }

    .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }
    .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }
    .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

    /* Ïä¨Î°ØÌòï (ÏÑ∏Î°ú ÎÇôÌïò) */
    #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .slot-window{ width:320px; height:56px; overflow:hidden; border-radius:10px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }
    .reel{ display:flex; flex-direction:column; }
    .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }
    .slot-icon{ font-size:20px; }

    /* Ïª®Ìä∏Î°§/ÌôïÎ•†/Î™©Î°ù */
    #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .spinbtn{ padding:10px 14px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.14); font-weight:900; }
    .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }
    .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }
    #prob-toggle{ width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff; }
    #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }
    #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }
    #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }
    
    /* Î≤ÑÌîÑ ÏÉÅÌÉú Î≥¥Í∏∞ Ïò§Î≤ÑÎ†àÏù¥ */
    #buff-overlay{
      position:fixed; inset:0; z-index:3650; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #buff-overlay.show{ display:flex; }
    #buff-card{
      width:min(480px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #buff-list{ margin-top:10px; max-height:42vh; overflow-y:auto; }
    .buff-item{
      padding:8px 8px; margin-bottom:4px; border:1px solid rgba(255,255,255,0.05);
      border-radius:10px; background:rgba(0,0,0,0.12); font-size:13px;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* Î≤ÑÌîÑ ÏÉÅÌÉú Ïù¥Î¶Ñ+ÏûîÏó¨ (Í∏∞Ï°¥ spanÎåÄÏã† Ïò§Î≤ÑÎ†àÏù¥ÏóêÏÑú ÌëúÏãúÌïòÎØÄÎ°ú ÏµúÏÜåÌôî) */
    #buff-status{ display:none; }

    /* ÌÜ†Ïä§Ìä∏ */
    #toast{
      position: fixed;
      left: 50%;
      bottom: calc(80px + env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%) translateY(20px);
      min-width: 220px; max-width: 92vw;
      padding: 10px 12px;
      background: rgba(10,12,20,0.85);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      color:#eaf6ff; font-weight:800; font-size:13px;
      display: none; z-index: 4000;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #toast.show{ display:block; animation: toast-pop .28s ease-out forwards; }
    #toast .t-row{ display:flex; align-items:center; gap:10px; }
    #toast .t-msg{ flex:1; }
    #toast .t-btn{
      padding: 6px 10px; border-radius: 8px; border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; font-weight:900; cursor:pointer;
    }
    @keyframes toast-pop {
      from { opacity:0; transform: translateX(-50%) translateY(20px); }
      to   { opacity:1; transform: translateX(-50%) translateY(0); }
    }

    /* ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ */
    #migrate-overlay{
      position: fixed; inset:0; z-index:3600; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #migrate-overlay.show{ display:flex; }
    #migrate-card{
      width:min(560px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #migrate-card h3{ margin:0 0 8px; font-size:18px; }
    #migrate-desc{ font-size:13px; color:#cfe6ff; line-height:1.5; }
    .warnbox{
      margin:10px 0; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,211,110,.45);
      background: rgba(255,211,110,.10); color:#ffe3a3; font-weight:700;
    }
    #migrate-progress{ margin-top:10px; font-size:13px; color:#a6e7ff; min-height:20px; }
    #migrate-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #migrate-start{ padding:10px 14px; border-radius:10px; border:none; font-weight:900; cursor:pointer;
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    #migrate-start[disabled]{ opacity:.6; cursor:not-allowed; }

    /* PC ÌåùÏóÖ ÏïàÎÇ¥ Í≤åÏù¥Ìä∏ */
    #popup-gate {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(2,6,12,0.70), rgba(2,6,12,0.85));
      backdrop-filter: blur(4px);
      z-index: 3700;
    }
    #popup-gate.show { display: flex; }
    #popup-gate .gate-card {
      width: min(520px, 92vw);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(10,12,18,0.66));
      padding: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
      color: #eaf6ff;
      text-align: center;
    }
    #popup-gate .gate-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
    }
    #popup-gate .gate-card p {
      margin: 6px 0;
      font-size: 14px;
      color: #cfe6ff;
      line-height: 1.6;
    }
    #popup-gate-count {
      font-weight: 800;
      color: #ffd36e;
    }
    .admin-login {
      margin-top: 18px;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(6, 10, 18, 0.72);
      text-align: left;
      display: none;
    }
    .admin-login.show { display: block; }
    .admin-login h4 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #ffe18a;
    }
    .admin-login p {
      margin: 4px 0 10px;
      font-size: 13px;
      color: #dde9ff;
      line-height: 1.5;
    }
    .admin-login input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-size: 13px;
      outline: none;
    }
    .admin-login input:focus {
      border-color: rgba(255,209,110,0.65);
      box-shadow: 0 8px 22px rgba(255,209,110,0.12);
    }
    .admin-login .admin-submit {
      width: 100%;
      margin-top: 2px;
      background: linear-gradient(90deg,#ffd866,#f7b733);
      color: #2d1b00;
      border: none;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .admin-login .admin-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .admin-login .admin-error {
      min-height: 16px;
      margin: 6px 0 0;
      font-size: 12px;
      color: #ff9a9a;
    }
    .admin-login .admin-progress {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      background: #ffe26a;
      color: #2d1b00;
      font-weight: 700;
      display: none;
    }
    .admin-login .admin-progress.show { display: block; }

    #session-lock-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(2,6,12,0.70), rgba(2,6,12,0.86));
      backdrop-filter: blur(6px);
      z-index: 4000;
    }
    #session-lock-overlay.show { display: flex; }
    #session-lock-overlay .lock-card {
      width: min(420px, 92vw);
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(6,8,14,0.72));
      box-shadow: 0 22px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
      text-align: center;
      color: #eaf6ff;
    }
    #js-hard-block-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: linear-gradient(180deg, rgba(2,4,10,0.85), rgba(3,6,16,0.92));
      backdrop-filter: blur(6px);
      z-index: 5000;
    }
    #js-hard-block-overlay.show { display: flex; }
    #js-hard-block-overlay .block-card {
      width: min(420px, 94vw);
      padding: 22px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(10,12,22,0.96), rgba(4,6,12,0.98));
      box-shadow: 0 28px 70px rgba(0,0,0,0.65), inset 0 1px 0 rgba(255,255,255,0.03);
      color: #e8f6ff;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #js-hard-block-overlay .block-card h3 {
      margin: 0;
      font-size: 19px;
      color: #ffb6c1;
    }
    #js-hard-block-overlay .block-card p {
      margin: 0;
      font-size: 14px;
      color: #d2e8ff;
      line-height: 1.5;
    }
    #js-hard-block-overlay .block-card .device-label {
      font-size: 13px;
      color: #8fb9ff;
    }
    #js-hard-block-overlay .block-card .error-code {
      font-size: 12px;
      color: #ff9f9f;
      margin-top: 2px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    #js-hard-block-overlay .block-card button {
      margin-top: 4px;
      border: none;
      border-radius: 10px;
      padding: 11px;
      font-weight: 700;
      background: linear-gradient(90deg,#ff7c7c,#ff416c);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(255,65,108,0.35);
    }
    #session-lock-overlay .lock-card h3 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    #session-lock-overlay .lock-card p {
      margin: 6px 0;
      font-size: 13px;
      color: #d8ecff;
    }
    #session-lock-overlay .lock-card .lock-note {
      font-size: 12px;
      color: #9ec9ff;
      margin-top: 4px;
    }
    #session-lock-overlay .lock-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    #session-lock-overlay .lock-status {
      min-height: 18px;
      font-size: 13px;
      color: #ffdede;
      margin-top: 12px;
    }
    #session-lock-overlay .admin-login {
      margin-top: 18px;
    }

    /* Ïø†Ìå° Í¥ëÍ≥† Ïπ¥Îìú */
    .coupang-inline {
      position: relative;
      display: flex;
      justify-content: center;
      padding: 0;
      margin: 0;
      width: 100%;
      pointer-events: auto;
    }
    .coupang-card {
      width: min(360px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.35));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.32), inset 0 1px 0 rgba(255,255,255,0.08);
      color: #eaf6ff;
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: left;
      padding: 10px 12px 12px;
      pointer-events: auto;
    }
    .coupang-inline .coupang-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .coupang-inline .coupang-title,
    #coupang-focus-overlay .coupang-title {
      font-weight: 800;
      letter-spacing: 0.3px;
      font-size: 14px;
    }
    .coupang-label {
      background: rgba(0,212,255,0.15);
      color: #b2edff;
      border: 1px solid rgba(0,212,255,0.35);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .coupang-slot {
      width: 100%;
      min-height: 96px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: rgba(0,0,0,0.25);
      border: 1px dashed rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 4px;
    }
    .coupang-slot iframe {
      width: 100%;
      height: 96px;
      border: none;
      display: block;
    }
    .coupang-note {
      margin: 0;
      font-size: 11px;
      color: #bcd8ee;
      opacity: 0.9;
      line-height: 1.5;
    }

    /* ÌÉ≠ Î≥µÍ∑Ä Í¥ëÍ≥† Ïò§Î≤ÑÎ†àÏù¥ */
    #coupang-focus-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2,6,12,0.78);
      backdrop-filter: blur(4px);
      z-index: 3800;
      padding: 18px;
    }
    #coupang-focus-overlay.show {
      display: flex;
    }
    #coupang-focus-overlay .ad-modal {
      width: min(620px, 94vw);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(6,8,16,0.94));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 24px 70px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: #eaf6ff;
    }
    #coupang-focus-overlay .ad-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    #coupang-focus-overlay .title-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #coupang-overlay-close {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.28);
      color: #eaf6ff;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    #coupang-overlay-close:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.4);
    }
    #coupang-focus-overlay .coupang-slot {
      min-height: 160px;
      background: rgba(0,0,0,0.35);
      border-radius: 12px;
    }

    /* Ïù¥Ïö©ÏïΩÍ¥Ä & Ï†ïÏßÄ Ïò§Î≤ÑÎ†àÏù¥ */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px); z-index:3650; }
    .overlay.show{ display:flex; }
    .overlay-card{ width:min(620px,94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08); color:#eaf6ff; }
    .overlay-card h3{ margin:0 0 8px; font-size:18px; }
    .overlay-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #tos-body{ max-height:40vh; overflow:auto; padding:10px; border:1px solid rgba(255,255,255,0.10);
      border-radius:10px; background: rgba(0,0,0,0.2); font-size:13px; color:#cfe6ff; }
    #tos-accept[disabled]{ opacity:.6; cursor:not-allowed; }
</style>

  <script src="language.js"></script>
  <script src="https://cdn.gtranslate.net/widgets/latest/popup.js" defer></script>
</head>
<body>
  <div id="snow-layer" aria-hidden="true"></div>
  <div class="gtranslate_wrapper" aria-hidden="true"></div>
  <!-- PC ÌåùÏóÖ ÏïàÎÇ¥ Í≤åÏù¥Ìä∏ -->
  <div id="popup-gate" aria-hidden="true">
    <div class="gate-card" role="alertdialog" aria-modal="true" aria-labelledby="popup-gate-title">
      <h3 id="popup-gate-title">PCÏóêÏÑúÎäî ÌåùÏóÖ ÌóàÏö©Ïù¥ ÌïÑÏöîÌï¥Ïöî</h3>
      <p>Ïª¥Ìì®ÌÑ∞ÏóêÏÑú Í≤åÏûÑÏùÑ Ïã§ÌñâÌï† ÎïåÎäî <b>ÌåùÏóÖÏùÑ ÌóàÏö©</b>Ìï¥Ïïº ÏÉà Ï∞ΩÏúºÎ°ú Ïó¥ Ïàò ÏûàÏñ¥Ïöî.</p>
      <p>ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏñ¥ <span style="white-space:nowrap;">Í≤åÏûÑÏùÑ ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§.</span></p>
      <p><span id="popup-gate-count">5</span>Ï¥à ÌõÑ Î©îÎâ¥ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.</p>
      <div class="overlay-actions" style="justify-content:center; margin-top:16px;">
        <button id="popup-gate-back" class="spinbtn" type="button">Î∞îÎ°ú Ïù¥ÎèôÌïòÍ∏∞</button>
      </div>
      <div id="admin-login" class="admin-login" aria-hidden="true">
        <h4>Í¥ÄÎ¶¨Ïûê ÌôïÏù∏</h4>
        <p>Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù ÌõÑ ÌòÑÏû¨ Ï∞ΩÏóêÏÑúÎèÑ Í≤åÏûÑÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
        <input type="text" id="admin-id" placeholder="ÏïÑÏù¥Îîî" autocomplete="off" />
        <input type="password" id="admin-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="off" />
        <button id="admin-submit" class="spinbtn admin-submit" type="button">ÌôïÏù∏</button>
        <p id="admin-error" class="admin-error" role="status" aria-live="polite"></p>
        <div id="admin-progress" class="admin-progress" role="status" aria-live="assertive"></div>
      </div>
    </div>
  </div>

  <div id="session-lock-overlay" aria-hidden="true">
    <div class="lock-card" role="alertdialog" aria-modal="true" aria-labelledby="session-lock-title">
      <h3 id="session-lock-title">Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù∏ Ï∞ΩÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§</h3>
      <p id="session-lock-desc">
        Í∞ôÏùÄ Í≥ÑÏ†ïÏù¥ Ïó¨Îü¨ Ï∞ΩÏù¥ÎÇò Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú ÎèôÏãúÏóê Ïó¥Î¶¨Î©¥ Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞òÏúºÎ°ú Í∞ÑÏ£ºÎê† Ïàò ÏûàÏñ¥Ïöî.
        Ïò§ÌÉêÏùÑ ÌîºÌïòÍ∏∞ ÏúÑÌï¥ Ìïú Î≤àÏóê ÌïòÎÇòÏùò Ï∞ΩÎßå ÌóàÏö©ÌïòÍ≥† ÏûàÏúºÎãà ÎÑàÍ∑∏ÎüΩÍ≤å ÏñëÌï¥ Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§.
      </p>
      <p id="session-lock-status" class="lock-status" role="status" aria-live="polite"></p>
      <p id="session-lock-note" class="lock-note">Îã§Î•∏ Ï∞ΩÏùÑ Îã´ÏùÄ Îí§ ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú Îã§Ïãú ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.</p>
      <div class="lock-actions">
        <button id="session-lock-retry" class="spinbtn" type="button">Îã§Ïãú ÏãúÎèÑ</button>
        <button id="session-lock-remote-logout" class="ghost-btn" type="button" style="display:none">ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ</button>
        <button id="session-lock-admin-toggle" class="ghost-btn" type="button">Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù</button>
      </div>
      <div id="session-lock-admin" class="admin-login" aria-hidden="true">
        <h4>Í¥ÄÎ¶¨Ïûê ÌôïÏù∏</h4>
        <p>Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌïòÎ©¥ Ïó¨Îü¨ Ï∞ΩÏóêÏÑúÎèÑ ÌîåÎ†àÏù¥Î•º Í≥ÑÏÜçÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
        <input type="text" id="session-admin-id" placeholder="ÏïÑÏù¥Îîî" autocomplete="off" />
        <input type="password" id="session-admin-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="off" />
        <button id="session-admin-submit" class="spinbtn admin-submit" type="button">ÌôïÏù∏</button>
        <p id="session-admin-error" class="admin-error" role="status" aria-live="polite"></p>
        <div id="session-admin-progress" class="admin-progress" role="status" aria-live="assertive"></div>
      </div>
    </div>
  </div>

  <div id="coupang-focus-overlay" aria-hidden="true">
    <div class="ad-modal" role="dialog" aria-modal="true" aria-labelledby="coupang-overlay-title">
      <div class="ad-header">
        <div class="title-wrap">
          <span class="coupang-label">Í¥ëÍ≥†</span>
          <span id="coupang-overlay-title" class="coupang-title">Ïû†Ïãú ÎëòÎü¨Î≥¥Í≥† Í∞ÄÏÑ∏Ïöî</span>
        </div>
        <button id="coupang-overlay-close" aria-label="Í¥ëÍ≥† Îã´Í∏∞">‚úï</button>
      </div>
      <div id="coupang-overlay-slot" class="coupang-slot" aria-hidden="false">
        <iframe
          src="https://ads-partners.coupang.com/widgets.html?id=950028&template=carousel&trackingCode=AF4259209&subId=&width=680&height=96&tsource="
          width="680"
          height="96"
          frameborder="0"
          scrolling="no"
          referrerpolicy="unsafe-url"
          browsingtopics
          title="Ïø†Ìå° Í¥ëÍ≥†"
          loading="lazy"></iframe>
      </div>
      <p class="coupang-note">‚Äª Î≥∏ ÎßÅÌÅ¨Î•º ÌÜµÌï¥ Íµ¨Îß§ Ïãú ÏÜåÏ†ïÏùò ÏàòÏàòÎ£åÎ•º Î∞õÏäµÎãàÎã§.</p>
    </div>
  </div>

  <div id="js-hard-block-overlay" aria-hidden="true">
    <div class="block-card" role="alertdialog" aria-modal="true" aria-labelledby="js-hard-block-title">
      <h3 id="js-hard-block-title">Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Ïã§ÌñâÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§</h3>
      <p id="js-hard-block-desc">Î≥¥ÏïàÏùÑ ÏúÑÌï¥ ÌòÑÏû¨ Ï∞ΩÏùò Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§ÌñâÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.</p>
      <p id="js-hard-block-device" class="device-label" role="status" aria-live="polite"></p>
      <p id="js-hard-block-error" class="error-code" role="status" aria-live="assertive"></p>
      <button id="js-hard-block-reload" type="button">ÏÉàÎ°úÍ≥†Ïπ®</button>
    </div>
  </div>

  <!-- Î∂ÄÌåÖ Ï§ë Ïò§Î≤ÑÎ†àÏù¥ (ÏµúÏ¥à 1ÌöåÎßå) -->
  <div id="boot-overlay" aria-hidden="false">
    <div class="card" role="status" aria-live="polite" aria-atomic="true">
      <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
        <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
        <div style="text-align:left;">
          <div style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë‚Ä¶</div>
          <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ëÏù¥ÏóêÏöî</div>
        </div>
      </div>
      <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
    </div>
  </div>

  <!-- Ïù∏Ï¶ù -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">Î°úÍ∑∏Ïù∏</button>
      <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">ÌöåÏõêÍ∞ÄÏûÖ</button>
    </div>

    <h2 id="auth-title">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</h2>
    <input type="email" id="email" placeholder="Ïù¥Î©îÏùº" autocomplete="username" />
    <input type="password" id="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
    <div id="signup-extra" style="display:none; margin-top:6px;">
      <input type="password" id="password-confirm" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏" autocomplete="new-password" />
      <div class="policy-consent">
        <label class="policy-consent-item">
          <input type="checkbox" id="tos-checkbox" />
          <span>
            Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï©ÎãàÎã§
            <button type="button" id="tos-more-link" class="policy-link" data-policy="terms">ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</button>
          </span>
        </label>
        <label class="policy-consent-item">
          <input type="checkbox" id="privacy-checkbox" />
          <span>
            Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®Ïóê ÎèôÏùòÌï©ÎãàÎã§
            <button type="button" id="privacy-more-link" class="policy-link" data-policy="privacy">ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</button>
          </span>
        </label>
      </div>
      <div style="margin-top:6px; font-size:12px; color:#cfe6ff; text-align:left; line-height:1.45;">
        <b>ÏïàÎÇ¥:</b><br/>
        ¬∑ ÏπòÌåÖ/Ìïµ ÏÇ¨Ïö©, Î≤ÑÍ∑∏ ÏïÖÏö©, Í≥ÑÏ†ï ÏñëÎèÑ/ÎåÄÏó¨Îäî Í∏àÏßÄÎê©ÎãàÎã§.<br/>
        ¬∑ <u>ÏûêÏõê¬∑ÏΩîÏù∏ ÎπÑÏ†ïÏÉÅ Í∏âÏ¶ù(Ïòà: Ìïú Î≤àÏóê 10Ïñµ ÏΩîÏù∏)</u> ÌÉêÏßÄ Ïãú Í≤ΩÍ≥† ÎòêÎäî Ï¶âÏãú Ï†ïÏßÄÎê† Ïàò ÏûàÏäµÎãàÎã§.<br/>
        ¬∑ ÏïΩÍ¥Ä Î∞è Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®ÏùÑ Î∞òÎìúÏãú ÌôïÏù∏ÌïòÍ≥† ÎèôÏùòÌï¥ Ï£ºÏÑ∏Ïöî.
      </div>
    </div>

    <button id="login-btn" class="primary-btn">Î°úÍ∑∏Ïù∏</button>
    <button id="signup-btn" class="ghost-btn" style="display:none">ÌöåÏõêÍ∞ÄÏûÖ</button>
    <button id="guest-start-btn" class="ghost-btn" style="margin-top:10px;">Í≤åÏä§Ìä∏Î°ú ÏãúÏûëÌïòÍ∏∞</button>

    <button id="google-btn" aria-label="Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ (Í∂åÏû•)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false"><path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/><path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/><path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/></svg>
      </span>
      <span class="g-text">Íµ¨Í∏ÄÎ°ú Í≥ÑÏÜçÌïòÍ∏∞ <small>(Í∂åÏû•)</small></span>
    </button>

    <button id="btnGoogleLoginCode" aria-label="Íµ¨Í∏Ä ÏΩîÎìú Î°úÍ∑∏Ïù∏(Ïï± Ï†ÑÏö©)" class="google-btn" type="button">
      <span class="g-icon" aria-hidden="true">üîë</span>
      <span class="g-text">Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏(ÏΩîÎìú) <small>Ïï±(WebView) Ï†ÑÏö©</small></span>
    </button>

    <div id="codeArea" style="display:none; margin-top: 8px;">
      <button id="codeDetailsToggle" class="code-details-toggle" type="button">ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</button>
      <div id="codeDetails" class="code-details" aria-live="polite">
        <p id="codeInfoText">Ïï± Ï†ÑÏö© ÏΩîÎìú Î°úÍ∑∏Ïù∏ÏùÑ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§...</p>
        <p id="codeStatus" style="color:#aaa; margin-top:4px;"></p>
      </div>
    </div>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>
    <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">üîí</div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px;">Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë</div>
            <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">Î≥¥Ïïà Ïó∞Í≤∞ ¬∑ Ïù∏Ï¶ù Ï§ë‚Ä¶</div>
          </div>
        </div>
        <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
      </div>
    </div>

  </div>

  <div id="policy-overlay" aria-hidden="true">
    <div class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="policy-title">
      <div class="policy-header">
        <h3 id="policy-title">Ï†ïÏ±Ö ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</h3>
        <div class="policy-actions">
          <a id="policy-open-new" class="policy-open-new" href="/privacy" target="_blank" rel="noopener">ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞</a>
          <button type="button" id="policy-close" class="policy-close">Îã´Í∏∞</button>
        </div>
      </div>
      <iframe id="policy-frame" title="Ï†ïÏ±Ö ÏÉÅÏÑ∏" loading="lazy"></iframe>
      <div class="policy-foot">ÌîÑÎ†àÏûÑ ÎÇ¥ Î¨∏ÏÑúÍ∞Ä Î≥¥Ïù¥ÏßÄ ÏïäÏúºÎ©¥ ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.</div>
    </div>
  </div>

  <!-- ÏÉÅÎã® Î∞î & Î©îÏù∏ Í≤åÏûÑ -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ÏûêÏõê: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ÏΩîÏù∏: 0</span>
      <img src="/images/event-icon.png" alt="EventCoin" />
      <span id="ecoins">Ïù¥Î≤§Ìä∏ÏΩîÏù∏: 0</span>
    </div>
    <div class="bar-group">
      <!-- Î≤ÑÌîÑ Î≤ÑÌäºÏúºÎ°ú ÍµêÏ≤¥ -->
      <button id="buff-btn" aria-label="ÌòÑÏû¨ Î≤ÑÌîÑ Î≥¥Í∏∞">Î≤ÑÌîÑ(0)</button>
      <span id="suspicion-badge" title="Ìïµ ÏÇ¨Ïö© ÏùòÏã¨ÎèÑ">ÏùòÏã¨ÎèÑ: 0</span>
      <button id="guest-login-btn" type="button" aria-label="Í≤åÏä§Ìä∏ÏóêÏÑú Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô">üîê Î°úÍ∑∏Ïù∏</button>
      <button id="settings-btn" aria-label="ÏÑ§Ï†ïÏúºÎ°ú Ïù¥Îèô">‚öôÔ∏è ÏÑ§Ï†ï</button>
    </div>
  </div>

  <div class="page-shell">
    <div class="game-area">
      <div id="container">
        <h1>üåå ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ: Ïö∞Ï£º ÏÉùÏ°¥ ÌÅ¥Î¶≠Ïª§ üåå</h1>

        <div id="main-content" class="tab-content active">
          <div id="ore-container" style="position:relative; display:inline-block;">
            <img src="/images/ore.png" id="ore" alt="Í¥ëÏÑù" />
          </div>
          <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
            <button id="convert-button" class="general">10ÏûêÏõê ‚Üí 1ÏΩîÏù∏</button>
            <button id="auto-convert-buy" class="general">ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(100ÏΩîÏù∏)</button>
          </div>
        </div>

        <div id="workers-content" class="tab-content">
          <p>Ï¥ù Ï¥àÎãπ ÏûêÏõê: <span id="resource-per-sec">0</span></p>
          <button id="hire-worker" class="general">ÏïåÎ∞î Í≥†Ïö© (<span id="worker-cost">0</span>ÏΩîÏù∏)</button>
          <button id="hire-worker-ec" class="general">ÏïåÎ∞î +10Î†ô (1EC)</button>
          <p>Ï¥ù Ï¥àÎãπ ÏΩîÏù∏: <span id="coin-per-sec">0</span></p>
          <button id="hire-conversion" class="general">ÏΩîÏù∏ ÏïåÎ∞î (<span id="conversion-cost">0</span>ÏΩîÏù∏)</button>
          <button id="hire-conversion-ec" class="general">ÏΩîÏù∏ ÏïåÎ∞î +10Î†ô (1EC)</button>
        </div>

        <div id="ship-content" class="tab-content">
          <div class="ship-panel" aria-live="polite">
            <h2>Ïö∞Ï£ºÏÑ† Ï†úÏñ¥Ïã§</h2>
            <img id="ship-img" src="/images/ship-level1.png" alt="Ïö∞Ï£ºÏÑ†" />
        <div class="ship-status" id="ship-level">1Î†ô (20ÏΩîÏù∏)</div>
        <div class="ship-enhance-info">Í∞ïÌôî ÏÑ±Í≥µ ÌôïÎ•†: <strong id="ship-success-rate">100%</strong></div>
        <p>Ïö∞Ï£ºÏÑ†ÏùÑ ÏóÖÍ∑∏Î†àÏù¥ÎìúÌï¥ Îçî Î®º ÌñâÏÑ±Í≥º ÏÉàÎ°úÏö¥ ÏΩòÌÖêÏ∏†Î•º Í∞úÎ∞©ÌïòÏÑ∏Ïöî.</p>
        <button id="upgrade-ship" class="general">Ïö∞Ï£ºÏÑ† ÏóÖÍ∑∏Î†àÏù¥Îìú (ÏΩîÏù∏)</button>
        <div class="ship-ec-tabs" role="tablist" aria-label="Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í∞ïÌôî Î∞©Ïãù ÏÑ†ÌÉù">
          <button class="ship-ec-tab active" data-ship-ec-tab="guaranteed" role="tab" aria-selected="true">ÌôïÏ†ï Í∞ïÌôî</button>
          <button class="ship-ec-tab" data-ship-ec-tab="challenge" role="tab" aria-selected="false">1Í∞ú ÎèÑÏ†Ñ</button>
        </div>
        <div class="ship-ec-panel active" data-ship-ec-panel="guaranteed" role="tabpanel" aria-label="Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÌôïÏ†ï Í∞ïÌôî">
          <p class="ship-ec-note">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ÏùÑ Î™®ÏïÑ ÏúÑÌóò ÏóÜÏù¥ Î∞îÎ°ú Í∞ïÌôî!</p>
          <button id="upgrade-ship-ec" class="general">Ïö∞Ï£ºÏÑ† ÌôïÏ†ï ÏóÖÍ∑∏Î†àÏù¥Îìú (Ïù¥Î≤§Ìä∏ÏΩîÏù∏)</button>
        </div>
        <div class="ship-ec-panel" data-ship-ec-panel="challenge" role="tabpanel" aria-label="Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞ú ÎèÑÏ†Ñ">
          <p class="ship-ec-note">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞úÎ°ú ÌôïÎ•† ÎèÑÏ†ÑÏùÑ Ìï† Ïàò ÏûàÏñ¥Ïöî.</p>
          <button id="upgrade-ship-ec-risk" class="general">Ïö∞Ï£ºÏÑ† ÏóÖÍ∑∏Î†àÏù¥Îìú ÎèÑÏ†Ñ (Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞ú)</button>
        </div>
        <div class="ship-enhance-status" id="ship-upgrade-status" aria-live="polite">Ï≤´ Í∞ïÌôîÎäî 100% ÏÑ±Í≥µ! Î†àÎ≤®Ïù¥ Ïò§Î•ºÏàòÎ°ù ÌôïÎ•†Ïù¥ ÎÇÆÏïÑÏßëÎãàÎã§.</div>
      </div>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>ÌÅ¥Î¶≠Îãπ ÏûêÏõê: <span id="click-power">1</span></p>
      <div class="upgrade-actions">
        <button id="click-upgrade" class="general">ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (15ÏΩîÏù∏)</button>
        <button id="click-upgrade-ec" class="general">ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú +10Î†ô (1EC)</button>
      </div>
    </div>

    <div id="planets-content" class="tab-content">
      <div class="planet-tabbar" role="tablist" aria-label="ÌñâÏÑ± ÏÑ∏Î∂Ä ÌÉ≠">
        <button class="planet-subtab active" data-planet-tab="explore" role="tab" aria-selected="true">üõ∞Ô∏è ÌÉêÏÇ¨</button>
        <button class="planet-subtab" data-planet-tab="purchase" role="tab" aria-selected="false">üõí Íµ¨Îß§</button>
      </div>
      <div id="planet-explore-panel" class="planet-panel active" role="tabpanel" aria-label="ÌñâÏÑ± ÌÉêÏÇ¨ Î™©Î°ù"></div>
      <div id="planet-purchase-panel" class="planet-panel" role="tabpanel" aria-label="ÌñâÏÑ± Íµ¨Îß§ Î™©Î°ù"></div>
    </div>

    <div id="christmas-content" class="tab-content">
      <div class="event-panel">
        <div class="event-card">
          <h3>üéÑ 2025 ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î≤§Ìä∏</h3>
          <div class="event-stats">
            <div class="pill"><img src="/images/santa-piece.png" alt="ÏÇ∞ÌÉÄ Ï°∞Í∞Å" /> ÏÇ∞ÌÉÄ Ï°∞Í∞Å: <span id="santa-pieces">0</span></div>
            <div class="pill"><img src="/images/santa-coin.png" alt="ÏÇ∞ÌÉÄ Ïù¥Î≤§Ìä∏ ÏΩîÏù∏" /> ÏÇ∞ÌÉÄ Ïù¥Î≤§Ìä∏ÏΩîÏù∏: <span id="santa-coins">0</span></div>
            <div class="pill"><img src="/images/event-icon.png" alt="Ïù¥Î≤§Ìä∏ÏΩîÏù∏" /> Ïù¥Î≤§Ìä∏ÏΩîÏù∏: <span id="event-coins-inline">0</span></div>
          </div>
          <div class="event-actions">
            <button id="craft-santa-coin" class="general" type="button">ÏÇ∞ÌÉÄÏΩîÏù∏ Ï†úÏûë (Ï°∞Í∞Å 10Í∞ú)</button>
            <button id="convert-ecoin-to-santacoin" class="general" type="button">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ‚Üí ÏÇ∞ÌÉÄÏΩîÏù∏ (3:1)</button>
            <button id="christmas-upgrade" class="general" type="button">Ìä∏Î¶¨ Í∞ïÌôî</button>
          </div>
          <p class="event-hint">‚Äª ÏÇ∞ÌÉÄ Ï°∞Í∞ÅÏúºÎ°ú ÏñªÎäî ÏÇ∞ÌÉÄÏΩîÏù∏ÏùÄ ÏßÅÏ†ë Ï†úÏûëÌï¥Ïïº Ìï¥Ïöî.</p>
          <div class="tree-status">
            <img id="tree-image" class="tree-figure" src="/images/tree1.png" alt="ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ìä∏Î¶¨" />
            <div>
              <div>ÌòÑÏû¨ Ìä∏Î¶¨ Î†àÎ≤®: <strong id="tree-level">0</strong> / 6</div>
              <div>Îã§Ïùå Í∞ïÌôî ÌïÑÏöî ÏÇ∞ÌÉÄÏΩîÏù∏: <strong id="tree-cost">-</strong></div>
            </div>
          </div>
          <div class="tree-rewards" id="tree-rewards">ÌäπÎ≥Ñ Î≥¥ÏÉÅ ÏïàÎÇ¥</div>
        </div>

        <div class="event-card">
          <h3>üéß Î¶¨Îì¨Í≤åÏûÑ (ÏÇ∞ÌÉÄ Ï°∞Í∞Å ÌöçÎìù)</h3>
          <p style="margin:6px 0 10px; color:#cfe6ff;">ÌÅ¨Î¶¨Ïä§ÎßàÏä§ ÌÖåÎßà Ï†ÄÏûëÍ∂å Î¨¥Î£å ÏùåÏïÖ 10Í≥°ÏùÑ Ï§ÄÎπÑÌñàÏñ¥Ïöî. Í≥°ÏùÑ ÏôÑÏ£ºÌïòÍ≥† Ìïú Î≤àÎèÑ ÌãÄÎ¶¨ÏßÄ ÏïäÏúºÎ©¥ <b>ÏÇ∞ÌÉÄ Ï°∞Í∞Å 5Í∞ú</b>Î•º ÌöçÎìùÌï©ÎãàÎã§.</p>
          <div class="christmas-launch">
            <button id="christmas-start" class="general" type="button">Î¶¨Îì¨Í≤åÏûÑ ÏãúÏûëÌïòÍ∏∞</button>
            <div id="christmas-launch-hint">Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÏïÑÎûò Ïù∏ÌîÑÎ†àÏûÑÏóêÏÑú Î∞îÎ°ú Î¶¨Îì¨Í≤åÏûÑÏù¥ Ïã§ÌñâÎèºÏöî.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="christmas-overlay" aria-hidden="true">
      <div class="christmas-modal" role="dialog" aria-modal="true" aria-label="ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Î¶¨Îì¨Í≤åÏûÑ">
        <button id="christmas-close" type="button" aria-label="Î¶¨Îì¨Í≤åÏûÑ Îã´Í∏∞">‚úï</button>
        <iframe id="christmas-frame" title="ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Î¶¨Îì¨Í≤åÏûÑ" src="about:blank" data-src="Christmas.html" loading="lazy" allowfullscreen></iframe>
      </div>
    </div>

    <!-- Î∞îÌÖÄ ÎÇ¥ÎπÑ -->
    <nav id="bottom-nav" aria-label="Í≤åÏûÑ ÌÉ≠ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò">
      <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ü™®</span><span class="t-label">Î©îÏù∏</span></div>
      <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">üë©‚ÄçüöÄ</span><span class="t-label">Ïö∞Ï£ºÏù∏</span></div>
      <div class="tab"        data-tab="ship"     role="button" tabindex="0"><span class="t-icon">üöÄ</span><span class="t-label">Ïö∞Ï£ºÏÑ†</span></div>
      <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">‚öôÔ∏è</span><span class="t-label">ÏóÖÍ∑∏Î†àÏù¥Îìú</span></div>
      <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ü™ê</span><span class="t-label">ÌñâÏÑ±</span></div>
      <div class="tab"        data-tab="christmas" role="button" tabindex="0"><span class="t-icon">üéÑ</span><span class="t-label">ÌÅ¨Î¶¨Ïä§ÎßàÏä§</span></div>
    </nav>
    </div>
    </div>
    <aside class="ad-area" aria-label="Ïä§Ìè∞ÏÑú ÏòÅÏó≠">
      <div id="bottom-nav-guard" aria-hidden="true"></div>
      <section id="coupang-inline" class="coupang-inline" aria-label="Ïø†Ìå° Í¥ëÍ≥†">
        <div class="coupang-card">
          <div class="coupang-head">
            <span class="coupang-label">Í¥ëÍ≥†</span>
            <span class="coupang-title">Ïò§ÎäòÏùò Ï∂îÏ≤ú ÏïÑÏù¥ÌÖú</span>
          </div>
          <div id="coupang-inline-slot" class="coupang-slot" aria-hidden="false">
            <iframe
              src="https://ads-partners.coupang.com/widgets.html?id=950028&template=carousel&trackingCode=AF4259209&subId=&width=680&height=96&tsource="
              width="680"
              height="96"
              frameborder="0"
              scrolling="no"
              referrerpolicy="unsafe-url"
              browsingtopics
              title="Ïø†Ìå° Í¥ëÍ≥†"
              loading="lazy"></iframe>
          </div>
          <p class="coupang-note">‚Äª Î≥∏ ÎßÅÌÅ¨Î•º ÌÜµÌï¥ Íµ¨Îß§ Ïãú ÏÜåÏ†ïÏùò ÏàòÏàòÎ£åÎ•º Î∞õÏäµÎãàÎã§.</p>
        </div>
      </section>
    </aside>
  </div>

  <!-- Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
    <div id="custom-menu">
      <div class="menu-item" data-action="menu"><span>üéÆ Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></div>
      <div class="menu-item" data-action="download"><span>‚¨áÔ∏è Ïï± Îã§Ïö¥Î°úÎìú</span></div>
      <div class="menu-item" data-action="shop"><span>üöÄ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨</span></div>
      <div class="menu-item" data-action="resume"><span>‚ñ∂Ô∏è Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></div>
      <div class="menu-item" data-action="rank"><span>üèÜ Îû≠ÌÇπ Î≥¥Í∏∞</span></div>
      <div class="menu-item" data-action="mail">
        <span>‚úâÔ∏è Ïö∞Ìé∏Ìï®</span>
        <span class="count-badge hidden" id="mail-unread-badge">0</span>
      </div>
      <div class="menu-item" data-action="quests">
        <span>üóíÔ∏è ÌÄòÏä§Ìä∏</span>
        <span class="count-badge hidden" id="quest-badge">!</span>
      </div>
      <div class="menu-item" data-action="attendance">
        <span>üìÖ Ï∂úÏÑù Î≥¥ÏÉÅ</span>
        <span id="attendance-left">-</span>
    </div>
  </div>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <button id="side-menu-toggle" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥ Ïó¥Í∏∞" title="Î©îÎâ¥">‚ò∞</button>
  <div id="side-backdrop" aria-hidden="true"></div>
  <aside id="side-menu" aria-label="ÏÇ¨Ïù¥Îìú Î©îÎâ¥" aria-hidden="true">
    <div class="side-header">Î©îÎâ¥</div>
    <nav class="side-items">
      <button class="side-item" data-action="menu"><span class="icon">üéÆ</span><span>Í≤åÏûÑ Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</span></button>
      <button class="side-item" data-action="download"><span class="icon">‚¨áÔ∏è</span><span>Ïï± Îã§Ïö¥Î°úÎìú</span></button>
      <button class="side-item" data-action="shop"><span class="icon">üõí</span><span>Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨</span></button>
      <button class="side-item" data-action="resume"><span class="icon">‚ñ∂Ô∏è</span><span>Í≤åÏûÑ Í≥ÑÏÜçÌïòÍ∏∞</span></button>
      <button class="side-item" data-action="rank"><span class="icon">üèÜ</span><span>Îû≠ÌÇπ Î≥¥Í∏∞</span></button>
      <button class="side-item" data-action="mail">
        <span><span class="icon">‚úâÔ∏è</span>Ïö∞Ìé∏Ìï®</span>
        <span class="side-right" id="mail-unread-side">-</span>
      </button>
      <button class="side-item" data-action="quests">
        <span><span class="icon">üóíÔ∏è</span>ÌÄòÏä§Ìä∏</span>
        <span class="side-right" id="quest-status-side">-</span>
      </button>
      <button class="side-item" data-action="attendance">
        <span><span class="icon">üìÖ</span>Ï∂úÏÑù Î≥¥ÏÉÅ</span>
        <span class="side-right" id="attendance-left-side">-</span>
      </button>
    </nav>
  </aside>

  <div id="mail-overlay" aria-hidden="true">
    <div id="mail-card" role="dialog" aria-modal="true" aria-labelledby="mail-title">
      <div id="mail-head">
        <h3 id="mail-title">‚úâÔ∏è Ïö∞Ìé∏Ìï®</h3>
        <button id="mail-close" aria-label="Ïö∞Ìé∏Ìï® Îã´Í∏∞">‚úï</button>
      </div>
      <div id="mail-content">
        <div id="mail-list" role="listbox" aria-label="Î∞õÏùÄ Ïö∞Ìé∏ Î™©Î°ù"></div>
        <div id="mail-detail" role="region" aria-live="polite"></div>
      </div>
      <div id="mail-compose-section" aria-live="polite">
        <h4>Í¥ÄÎ¶¨Ïûê Ïö∞Ìé∏ Î≥¥ÎÇ¥Í∏∞</h4>
        <p class="mail-hint">ÌòÑÏû¨ ÏûëÏÑ±Ìïú Ïö∞Ìé∏ÏùÄ Îì±Î°ùÎêú Î™®Îì† Ïú†Ï†ÄÏùò Ïö∞Ìé∏Ìï®ÏúºÎ°ú Î∞úÏÜ°Îê©ÎãàÎã§.</p>
        <label class="mail-field">
          <span>ÏàòÏã† ÎåÄÏÉÅ</span>
          <input type="text" id="mail-compose-target" value="Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)" autocomplete="off" readonly />
        </label>
        <label class="mail-field">
          <span>Ï†úÎ™©</span>
          <input type="text" id="mail-compose-subject" maxlength="80" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
        </label>
        <label class="mail-field">
          <span>ÎÇ¥Ïö©</span>
          <textarea id="mail-compose-body" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
        </label>
        <div class="mail-compose-grid">
          <label class="mail-field">
            <span>ÏûêÏõê</span>
            <input type="number" id="mail-compose-res" min="0" step="1" value="0" />
          </label>
          <label class="mail-field">
            <span>ÏΩîÏù∏</span>
            <input type="number" id="mail-compose-coin" min="0" step="1" value="0" />
          </label>
          <label class="mail-field">
            <span>Ïù¥Î≤§Ìä∏ÏΩîÏù∏</span>
            <input type="number" id="mail-compose-ecoin" min="0" step="1" value="0" />
          </label>
        </div>
        <div class="mail-compose-grid">
          <label class="mail-field">
            <span>Î≤ÑÌîÑ Ï¢ÖÎ•ò</span>
            <select id="mail-compose-buff-type">
              <option value="">ÏóÜÏùå</option>
              <option value="all">Ï†ÑÏ≤¥ ÏÉùÏÇ∞</option>
              <option value="coin">ÏΩîÏù∏ ÏÉùÏÇ∞</option>
              <option value="res">ÏûêÏõê ÏÉùÏÇ∞</option>
            </select>
          </label>
          <label class="mail-field">
            <span>Î≤ÑÌîÑ Î∞∞Ïú®(xN)</span>
            <input type="number" id="mail-compose-buff-mult" min="0" step="0.1" value="1" />
          </label>
          <label class="mail-field">
            <span>Î≤ÑÌîÑ ÏßÄÏÜç(Î∂Ñ)</span>
            <input type="number" id="mail-compose-buff-min" min="0" step="1" value="0" />
          </label>
        </div>
        <button id="mail-compose-send" type="button">üì® Ïö∞Ìé∏ Î∞úÏÜ°</button>
      </div>
    </div>
  </div>

  <div id="shop-overlay" aria-hidden="true">
    <div class="shop-card" role="dialog" aria-modal="true" aria-labelledby="shop-title">
      <div class="shop-head">
        <h3 id="shop-title">üõí Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨</h3>
        <button id="shop-close" aria-label="ÏÉÅÏ†ê Îã´Í∏∞">‚úï</button>
      </div>
      <p>ÌéòÏù¥Ïï± Í≤∞Ï†ú Î™®ÎìàÏùÑ ÌÜµÌï¥ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Îì±ÏùÑ Íµ¨Îß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
      <iframe id="shop-frame" title="ÌÉúÏñëÍ≥Ñ Ï†ïÎ≥µ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨" loading="lazy" src="about:blank" allow="payment *"></iframe>
    </div>
  </div>

  <!-- Ï∂úÏÑù/Ïä¨Î°Ø Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="daily-overlay" aria-hidden="true">
    <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">
      <div id="daily-title">
        <span>üìÖ Ïò§ÎäòÏùò Î≥¥ÏÉÅ & Ïä¨Î°Ø</span>
        <button id="prob-toggle" title="ÌôïÎ•†/Î≥¥ÏÉÅ Ï†ïÎ≥¥">i</button>
      </div>

      <div class="tabbar">
        <button class="tbtn active" data-mode="daily">Ï∂úÏÑù Ïä¨Î°Ø(Î¨¥Î£å/Ïùº1Ìöå)</button>
        <button class="tbtn" data-mode="premium">ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø(ÏùºÏùº ÌÄòÏä§Ìä∏)</button>
        <button class="tbtn" data-mode="ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø(Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏)</button>
      </div>

      <div id="daily-info">ÌôïÏù∏ Ï§ë‚Ä¶</div>
      <div id="slot-access-info"></div>

      <div id="slot-wrap">
        <div class="slot-window">
          <div id="slot-reel" class="reel"></div>
        </div>
      </div>

      <div id="mode-row">
        <button id="spin-daily"   class="spinbtn spin-free">Î¨¥Î£å Ï∂úÏÑù ÎèåÎ¶¨Í∏∞</button>
        <button id="spin-premium" class="spinbtn spin-prem">ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎèåÎ¶¨Í∏∞(ÏùºÏùº ÌÄòÏä§Ìä∏)</button>
        <button id="spin-ecoin"   class="spinbtn spin-ecoin">Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÎèåÎ¶¨Í∏∞(Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏)</button>
      </div>

      <div id="prob-panel"></div>
      <div id="reward-list"></div>

      <div id="daily-actions">
        <button id="daily-close">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- üî∂ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="migrate-overlay" aria-hidden="true">
    <div id="migrate-card" role="dialog" aria-modal="true" aria-labelledby="migrate-title">
      <h3 id="migrate-title">Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞©Ïãù Î≥ÄÍ≤Ω ÏïàÎÇ¥</h3>
      <div id="migrate-desc">
        Í≤åÏûÑ ÎÇ¥ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞©ÏãùÏù¥ Î≥ÄÍ≤ΩÎêòÏñ¥ <b>Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò</b>Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.<br/>
        ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ <b>Í∏∞Ï°¥ ÏúÑÏπòÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞(ÌïòÏúÑ ÌÇ§ Ï†ÑÏ≤¥)</b>Î•º ÏÉà ÏúÑÏπòÎ°ú Ïù¥ÎèôÌïòÍ≥†, <b>ÏõêÎ≥∏ÏùÄ ÏÇ≠Ï†ú</b>Îê©ÎãàÎã§.
      </div>
      <div class="warnbox">‚ö†Ô∏è ÏßÑÌñâ Ï§ë Ï∞ΩÏùÑ Îã´Í±∞ÎÇò Ï¢ÖÎ£åÌïòÎ©¥ <b>Îç∞Ïù¥ÌÑ∞ Ïù¥Ï†Ñ Ï§ë Î¨∏Ï†ú</b>Í∞Ä Î∞úÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§. Í∞ÄÎä•ÌïòÎ©¥ ÏôÑÎ£åÍπåÏßÄ Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.</div>
      <div id="migrate-progress">ÎåÄÍ∏∞ Ï§ë‚Ä¶</div>
      <div id="migrate-actions">
        <button id="migrate-start">ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏãúÏûë</button>
      </div>
    </div>
  </div>

  <!-- üóíÔ∏è ÌÄòÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="quest-overlay" aria-hidden="true">
    <div id="quest-card" role="dialog" aria-modal="true" aria-labelledby="quest-title">
      <div id="quest-head">
        <h3 id="quest-title">üóíÔ∏è ÌÄòÏä§Ìä∏</h3>
        <button id="quest-close" aria-label="ÌÄòÏä§Ìä∏ Îã´Í∏∞">‚úï</button>
      </div>
      <div class="quest-body">
        <div class="quest-tabbar">
          <button class="qtab active" data-qtab="daily">ÏùºÏùº ÌÄòÏä§Ìä∏</button>
          <button class="qtab" data-qtab="weekly">Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏</button>
        </div>
        <div id="quest-panels">
          <div class="quest-panel active" data-panel="daily">
            <p class="quest-desc">Îß§Ïùº 00:00(KST) Ï¥àÍ∏∞Ìôî ¬∑ ÏÑ±Ïû•ÎèÑÏóê Îî∞Îùº Î™©ÌëúÍ∞Ä ÏÉÅÏäπÌïòÎ©∞ Î™®Îì† Í≥ºÏ†úÎ•º ÏôÑÎ£åÌïòÎ©¥ <b>ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø</b> 1ÌöåÍ∞Ä Ïó¥Î¶ΩÎãàÎã§.</p>
            <div id="quest-daily-list" class="quest-list"></div>
            <div class="quest-summary" id="quest-daily-summary"></div>
          </div>
          <div class="quest-panel" data-panel="weekly">
            <p class="quest-desc">Îß§Ï£º ÏùºÏöîÏùº 12:00(KST) Ï¥àÍ∏∞Ìôî ¬∑ ÏÑ±Ïû•ÎèÑÍ∞Ä ÎÜíÏùÑÏàòÎ°ù Î™©ÌëúÍ∞Ä Ïª§ÏßÄÎ©∞ Î™®Îì† Í≥ºÏ†úÎ•º ÏôÑÎ£åÌïòÎ©¥ <b>Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø</b> 1ÌöåÍ∞Ä Ïó¥Î¶ΩÎãàÎã§.</p>
            <div id="quest-weekly-list" class="quest-list"></div>
            <div class="quest-summary" id="quest-weekly-summary"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üìú Ïù¥Ïö©ÏïΩÍ¥Ä Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="tos-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="tos-title">
      <h3 id="tos-title">Ïù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùò</h3>
      <div id="tos-body">
        <p>Î≥∏ Í≤åÏûÑÏùÄ Í≥µÏ†ïÌïú ÌîåÎ†àÏù¥Î•º ÏúÑÌï¥ ÏπòÌåÖ¬∑Ìïµ ÏÇ¨Ïö©ÏùÑ ÏóÑÍ≤©Ìûà Í∏àÏßÄÌï©ÎãàÎã§.</p>
        <ul>
          <li>ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏¬∑ÏΩòÏÜî Ï°∞Ïûë Îì±ÏúºÎ°ú ÏûêÏõê/ÏΩîÏù∏ÏùÑ ÎπÑÏ†ïÏÉÅÏ†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÏãúÌÇ§Îäî ÌñâÏúÑ Í∏àÏßÄ</li>
          <li>Î≤ÑÍ∑∏ ÏïÖÏö© Í∏àÏßÄ, Í≥ÑÏ†ï ÏñëÎèÑ/ÎåÄÏó¨ Í∏àÏßÄ</li>
          <li><b>ÎπÑÏ†ïÏÉÅ Í∏âÏ¶ù</b> ÏòàÏãú: Ìïú Î≤àÏóê <b>10Ïñµ ÏΩîÏù∏</b> Ïù¥ÏÉÅ Ï¶ùÍ∞Ä ‚Üí Ï¶âÏãú Ï†ïÏßÄ Í∞ÄÎä•</li>
        </ul>
        <p>ÎèôÏùò ÌõÑ ÌîåÎ†àÏù¥Î•º Í≥ÑÏÜçÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
      </div>
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;">
        <input type="checkbox" id="tos-agree" /> <span>ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï©ÎãàÎã§</span>
      </label>
      <div class="overlay-actions">
        <button id="tos-accept" class="spinbtn spin-free" disabled>ÎèôÏùòÌïòÍ≥† ÏãúÏûë</button>
      </div>
    </div>
  </div>

  <!-- üß™ Î≤ÑÌîÑ Î™©Î°ù Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="buff-overlay" aria-hidden="true">
    <div id="buff-card" role="dialog" aria-modal="true" aria-labelledby="buff-title">
      <h3 id="buff-title">ÌòÑÏû¨ Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑ</h3>
      <div id="buff-list">Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
      <div id="permanent-buffs"></div>
      <div class="overlay-actions">
        <button id="buff-close" class="spinbtn">Îã´Í∏∞</button>
      </div>
    </div>
  </div>

  <!-- ÏÇ¨Ïö¥Îìú -->
  <audio id="sfx-start"    src="/sounds/roulette_start.mp3" preload="auto"></audio>
  <audio id="sfx-tick"     src="/sounds/roulette_tick.mp3"  preload="auto"></audio>
  <audio id="sfx-win"      src="/sounds/roulette_win.mp3"   preload="auto"></audio>
  <audio id="sfx-coin"     src="/sounds/coin.mp3"          preload="auto"></audio>
  <audio id="sfx-pickaxe"  src="/sounds/pickaxe.mp3"       preload="auto"></audio>

  <!-- ÌÜ†Ïä§Ìä∏ Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + Í≤åÏûÑ Î°úÏßÅ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      sendEmailVerification,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, signInWithCustomToken,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, onValue, runTransaction, update, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
        authDomain: "siu-studio.firebaseapp.com",
        databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

      const AUTH_BASE_URL = 'https://applogin-chi.vercel.app';

      // üéÑ ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î≤§Ìä∏ ÌÉ≠ ÎÖ∏Ï∂ú ÌÜ†Í∏Ä
      const eventopen = true;

      function applyEventVisibility() {
        const christmasTab = document.querySelector('#bottom-nav .tab[data-tab="christmas"]');
        const christmasContent = document.getElementById('christmas-content');
        if (!eventopen) {
          christmasTab?.remove();
          christmasContent?.remove();
        }
      }

      applyEventVisibility();

      let currentCode = null;
      let pollTimer = null;

    class SessionLogger {
      constructor() {
        this.fileHandle = null;
        this.queue = [];
        this.ready = false;
        this.supportsFsAccess = !!(navigator?.storage?.getDirectory);
        this.fallbackKey = 'siu_session_log_fallback';
        this.init();
      }

      async init() {
        if (this.supportsFsAccess) {
          try {
            const root = await navigator.storage.getDirectory();
            const dir = await root.getDirectoryHandle('logs', { create: true });
            const name = `session-${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
            this.fileHandle = await dir.getFileHandle(name, { create: true });
          } catch (err) {
            console.warn('ÏÑ∏ÏÖò Î°úÍ∑∏ ÌååÏùºÏùÑ ÏÉùÏÑ±ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err);
            this.fileHandle = null;
          }
        }
        this.ready = true;
        if (this.queue.length) {
          const pending = [...this.queue];
          this.queue.length = 0;
          for (const line of pending) {
            await this._write(line);
          }
        }
        this.log('ÏÑ∏ÏÖò Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
      }

      async _write(line) {
        if (this.fileHandle) {
          try {
            const file = await this.fileHandle.getFile();
            const writable = await this.fileHandle.createWritable({ keepExistingData: true });
            await writable.seek(file.size);
            await writable.write(line);
            await writable.close();
            return;
          } catch (err) {
            console.warn('ÌååÏùº Î°úÍ∑∏ Í∏∞Î°ùÏóê Ïã§Ìå®ÌïòÏó¨ fallback ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.', err);
            this.fileHandle = null;
          }
        }
        try {
          const prev = localStorage.getItem(this.fallbackKey) || '';
          const next = (prev + line).slice(-20000);
          localStorage.setItem(this.fallbackKey, next);
        } catch {}
      }

      async log(message) {
        const line = `[${new Date().toISOString()}] ${message}\n`;
        if (!this.ready) {
          this.queue.push(line);
          return;
        }
        await this._write(line);
      }
    }

    class RecoveryManager {
      constructor(logger, snapshotProvider) {
        this.logger = logger;
        this.snapshotProvider = snapshotProvider;
        this.key = 'siu_recovery_points_v1';
        this.interval = 180000; // 3Î∂Ñ
        this.maxPoints = 20;
        this.timer = null;
      }

      start() {
        this.stop();
        this.safeCreate('initial-visit');
        this.timer = setInterval(() => this.safeCreate('interval'), this.interval);
      }

      stop() {
        if (this.timer) {
          clearInterval(this.timer);
          this.timer = null;
        }
      }

      resume() {
        if (this.timer) return;
        this.safeCreate('resume');
        this.timer = setInterval(() => this.safeCreate('interval'), this.interval);
      }

      safeCreate(reason) {
        try {
          this.createPoint(reason);
        } catch (err) {
          this.logger?.log?.(`Î≥µÍµ¨ ÏßÄÏ†ê ÏÉùÏÑ± Ïã§Ìå®(${reason}): ${err?.message || err}`);
        }
      }

      createPoint(reason = 'auto') {
        if (typeof localStorage === 'undefined') return;
        const payload = {
          ts: Date.now(),
          reason,
          localStorage: this.snapshotLocalStorage(),
          state: this.snapshotState()
        };
        let points = [];
        try {
          const raw = localStorage.getItem(this.key);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) points = parsed;
          }
        } catch {}
        points.unshift(payload);
        if (points.length > this.maxPoints) points = points.slice(0, this.maxPoints);
        try {
          localStorage.setItem(this.key, JSON.stringify(points));
          this.logger?.log?.(`Î≥µÍµ¨ ÏßÄÏ†êÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§. (${reason})`);
        } catch (err) {
          this.logger?.log?.(`Î≥µÍµ¨ ÏßÄÏ†ê Ï†ÄÏû• Ïã§Ìå®: ${err?.message || err}`);
        }
      }

      snapshotLocalStorage() {
        const snapshot = {};
        if (typeof localStorage === 'undefined') return snapshot;
        try {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key) snapshot[key] = localStorage.getItem(key);
          }
        } catch (err) {
          this.logger?.log?.(`localStorage Ïä§ÎÉÖÏÉ∑ Ïã§Ìå®: ${err?.message || err}`);
        }
        return snapshot;
      }

      snapshotState() {
        if (typeof this.snapshotProvider !== 'function') return null;
        try {
          const src = this.snapshotProvider();
          if (!src || typeof src !== 'object') return null;
          return JSON.parse(JSON.stringify(src));
        } catch (err) {
          this.logger?.log?.(`Í≤åÏûÑ ÏÉÅÌÉú Ïä§ÎÉÖÏÉ∑ Ïã§Ìå®: ${err?.message || err}`);
          return null;
        }
      }
    }

    const sessionLogger = new SessionLogger();
    window.__SESSION_LOGGER__ = sessionLogger;

    const describeReason = (reason) => {
      if (!reason) return 'no reason';
      if (typeof reason === 'string') return reason.slice(0, 400);
      if (reason instanceof Error) {
        return `${reason.name || 'Error'}: ${(reason.message || '').slice(0, 400)}`;
      }
      try {
        return JSON.stringify(reason).slice(0, 400);
      } catch {
        return String(reason).slice(0, 400);
      }
    };

    sessionLogger.log('Í≤åÏûÑ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏãúÏûë');

    window.addEventListener('error', (event) => {
      sessionLogger.log(`window error: ${event?.message || 'unknown'} (${event?.filename || 'n/a'}:${event?.lineno || 0})`);
    });
    window.addEventListener('unhandledrejection', (event) => {
      sessionLogger.log(`unhandled rejection: ${describeReason(event?.reason)}`);
    });

    /* ======================
       Í≥µÌÜµ ÏÉÅÌÉú / Í≤ΩÎ°ú
       ====================== */
    const SUPPORT_EMAIL = 'appeals@siustudio.me';
    const perkState = {
      tier: 0,
      resourceMult: 1,
      coinMult: 1,
      productionMult: 1
    };
    function resetPerkState(){
      perkState.tier = 0;
      perkState.resourceMult = 1;
      perkState.coinMult = 1;
      perkState.productionMult = 1;
    }

    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null;
    let localLastWrite = 0;
    let lastSyncedServerStamp = 0;
    let isInitialSync = false;

    let userServerKey = null;
    let userIdKey     = null;
    let userBasePath  = null;

    let dailyUnlocked = false;
    let rankingUnlocked = false;
    let bootDone = false;

    const recoveryManager = new RecoveryManager(sessionLogger, () => state);
    window.__RECOVERY_MANAGER__ = recoveryManager;
    recoveryManager.start();

    const GUEST_PROFILE_KEY = 'siu_guest_profile_v1';
    let guestMode = false;
    let guestTransferPreference = 'none';
    let guestAutoStartSuppressed = false;
    let pendingGuestCleanup = false;
    let pendingGuestRemovalNotice = false;

    function readGuestProfile() {
      try {
        const raw = localStorage.getItem(GUEST_PROFILE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function hasGuestProfile() {
      try {
        const profile = readGuestProfile();
        return !!(profile && typeof profile === 'object' && profile.state);
      } catch { return false; }
    }
    function clearGuestProfile() {
      try { localStorage.removeItem(GUEST_PROFILE_KEY); } catch {}
      try { localStorage.removeItem('siu_buffs_guest'); } catch {}
    }

    const MAIL_ADMIN_EMAIL = 'siu46852579@gmail.com';
    let mailboxRef = null;
    let mailboxUnsubscribe = null;
    let perkUnsubscribe = null;
    let mailboxCache = [];
    let selectedMailId = null;

    function subscribePickaxePerk(serverKey, userIdKey){
      if (perkUnsubscribe) {
        try { perkUnsubscribe(); } catch {}
        perkUnsubscribe = null;
      }
      if (!serverKey || !userIdKey) {
        resetPerkState();
        return;
      }
      const perkRef = ref(db, `users/${serverKey}/${userIdKey}/perks/pickaxe`);
      perkUnsubscribe = onValue(perkRef, snap => {
        if (!snap.exists()) {
          resetPerkState();
          return;
        }
        const val = snap.val() || {};
        perkState.tier = Number(val.tier || 0) || 0;
        perkState.resourceMult = Number(val.resourceMult || 1) || 1;
        perkState.coinMult = Number(val.coinMult || 1) || 1;
        perkState.productionMult = Number(val.productionMult || 1) || 1;
        if (val.src) {
          console.debug?.('[perk] pickaxe perk updated from', val.src, perkState);
        }
      }, err => {
        console.warn('pickaxe perk listen error', err);
        resetPerkState();
      });
    }

    
    /* üîí 3Ï¥à Î∂ÄÌä∏ Ïä§ÌÇµ Ï†ÑÏö© ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ (ÏöîÏ≤≠ÏÇ¨Ìï≠) */
    const AUDIT_BOOT_TS = Date.now();
    const AUDIT_INITIAL_SKIP_MS = 3000;

    /* üîí Ïù¥ÌõÑÏóêÎäî Îçî Ïù¥ÏÉÅ Í≤ÄÏÇ¨ Î©àÏ∂îÎäî freeze Ïïà ÏîÄ (Í∏∞Ï°¥ auditFreezeÎäî ÎçîÎØ∏) */
    function auditFreeze(ms = 0) {
      // ÏöîÏ≤≠: "Ï≤òÏùå 3Ï¥àÎßå Í≤ÄÏÇ¨ Ïïà ÌïòÍ≤å" ‚Üí ÎÇòÎ®∏ÏßÄ ÏãúÍ∞ÑÏóêÎäî Î¨¥Ï°∞Í±¥ Í≤ÄÏÇ¨
      // Í∑∏ÎûòÏÑú Ïó¨Í∏∞ÏÑúÎäî ÏïÑÎ¨¥ Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
    }

    /* ÎÑ§Ìä∏ÏõåÌÅ¨ ÏßÄÏó∞ Í∞êÏßÄÏö© (ÌÜ†Ïä§Ìä∏Îäî Ïïà ÎùÑÏõÄ) */
    let initialSyncStart = 0;
    let networkUnstableShown = false;

    /* ======================
       ÌÜ†Ïä§Ìä∏ / UI Ïú†Ìã∏
       ====================== */
    let toastTimer = null;
    function showToast(message, actionText = null, onAction = null, ttlMs = 5000){
      if (message && message.indexOf('ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§') !== -1) return;
      if (!bootDone && message !== 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.') return;
      const box = document.getElementById('toast');
      if(!box) return;
      clearTimeout(toastTimer);
      box.innerHTML = `<div class="t-row">
        <span class="t-msg">${message}</span>
        ${actionText ? `<button class="t-btn" id="toast-action">${actionText}</button>` : ``}
      </div>`;
      box.classList.add('show');
      box.style.display='block';
      function hideToast(){ box.classList.remove('show'); box.style.display='none'; }
      if(actionText && onAction){
        const btn = document.getElementById('toast-action');
        if(btn){ btn.onclick = () => { try{ onAction(); }catch{} hideToast(); }; }
      }
      toastTimer = setTimeout(hideToast, ttlMs);
    }

    function copyTextToClipboard(text) {
      if (!text) return Promise.reject(new Error('empty'));
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve, reject) => {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          textarea.style.pointerEvents = 'none';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          const ok = document.execCommand('copy');
          textarea.remove();
          if (ok) resolve();
          else reject(new Error('copy-failed'));
        } catch (err) {
          reject(err);
        }
      });
    }

    window.addEventListener('shop-open-error', (event) => {
      const detail = event?.detail || {};
      const msg = detail.message || 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨Î•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
      const manualMessage = detail.copyUrl ? (detail.manualMessage || 'ÌÅ¨Î°¨ÏóêÏÑú Îã§Ïùå ÏÇ¨Ïù¥Ìä∏Î°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî') : null;
      const toastMessage = manualMessage ? `${msg}\n${manualMessage}` : msg;

      const copyAction = detail.copyUrl ? () => {
        copyTextToClipboard(detail.copyUrl)
          .then(() => {
            showToast('ÏÉÅÏ†ê Ï£ºÏÜåÎ•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§. ÌÅ¨Î°¨ÏóêÏÑú Î∂ôÏó¨ÎÑ£Ïñ¥ Ïù¥ÎèôÌï¥Ï£ºÏÑ∏Ïöî!', null, null, 3600);
          })
          .catch(() => {
            try {
              prompt('ÏïÑÎûò Ï£ºÏÜåÎ•º Í∏∏Í≤å ÎàåÎü¨ Î≥µÏÇ¨Ìïú Îí§ ÌÅ¨Î°¨ Ï£ºÏÜåÏ∞ΩÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.', detail.copyUrl);
            } catch {}
          });
      } : null;

      showToast(toastMessage, detail.copyUrl ? 'Ï£ºÏÜå Î≥µÏÇ¨' : null, copyAction, detail.copyUrl ? 8000 : 3600);

      if (manualMessage && detail.alert !== false) {
        try {
          alert(`${manualMessage}\n${detail.copyUrl}`);
        } catch {}
      }
    });

    function maybeNotifyGuestRemoval() {
      if (!pendingGuestRemovalNotice || !bootDone) return;
      showToast('üëã Í≤åÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏñ¥Ïöî. Î°úÍ∑∏Ïù∏Ìïú Í≥ÑÏ†ïÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å ÌîåÎ†àÏù¥Î•º Ïù¥Ïñ¥Í∞ÄÏÑ∏Ïöî!', null, null, 4200);
      pendingGuestRemovalNotice = false;
    }

    /* ======================
       Î≤ÑÌîÑ Ï†ÄÏû•/Ï†ÅÏö©/ÌëúÏãú
       ====================== */
    function buffStorageKey(){ return guestMode ? 'siu_buffs_guest' : `siu_buffs_${uid||'anon'}`; }
    function ensureFx(){ if(!window.fx) window.fx={}; if(!window.fx.buffs) window.fx.buffs=[]; }
    function persistBuffs(){
      ensureFx();
      try {
        const now = Date.now();
        const toSave = window.fx.buffs.filter(b=>b && b.until>now);
        localStorage.setItem(buffStorageKey(), JSON.stringify(toSave));
      } catch {}
    }
    function loadBuffs(){
      ensureFx();
      try {
        const raw = localStorage.getItem(buffStorageKey());
        const arr = raw ? JSON.parse(raw) : [];
        const now = Date.now();
        window.fx.buffs = Array.isArray(arr) ? arr.filter(b=>b && b.until>now) : [];
      } catch { window.fx.buffs = []; }
    }
    function pruneExpiredBuffs(){
      ensureFx();
      const before = window.fx.buffs.length;
      const now = Date.now();
      window.fx.buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      if (window.fx.buffs.length !== before) persistBuffs();
    }
    function activeBuffFactor(kind){
      ensureFx();
      const now = Date.now();
      let factor = 1;
      (window.fx.buffs||[]).forEach(b=>{
        if(!b || now>=b.until) return;
        if (b.type==='all') factor *= (1 + b.value);
        else if (kind==='res'  && b.type==='res')  factor *= (1 + b.value);
        else if (kind==='coin' && b.type==='coin') factor *= (1 + b.value);
      });
      return factor;
    }
    function addTempBuff(type, value, dur){
      ensureFx();
      const now=Date.now();
      window.fx.buffs.push({ type, value, until: now + dur });
      persistBuffs();
      renderBuffStatus();
    }

    // üëâ Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞: Î≤ÑÌäº/Ïò§Î≤ÑÎ†àÏù¥Ïö© Î≤ÑÌîÑ Î†åÎçî
    function unlockedTreeBuffs(){
      const lv = Math.max(0, Math.min(christmasTreeRewards.length, state.christmasTreeLevel || 0));
      return christmasTreeRewards.slice(0, lv).map((r, idx) => `Lv.${idx + 1}: ${r.reward}`);
    }

    function renderPermanentBuffs(){
      const perm = document.getElementById('permanent-buffs');
      if (!perm) return;
      const buffs = unlockedTreeBuffs();
      const ecoMult = aggregateTreeMultiplier('event');
      const resMult = aggregateTreeMultiplier('res');
      const coinMult = aggregateTreeMultiplier('coin');
      const clickMult = aggregateTreeMultiplier('click');
      const workerMult = aggregateTreeMultiplier('worker');
      const multTexts = [];
      if (ecoMult > 1) multTexts.push(`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÌöçÎìù x${ecoMult.toFixed(2).replace(/\.00$/, '')}`);
      if (resMult > 1) multTexts.push(`ÏûêÏõê ÏÉùÏÇ∞ x${resMult.toFixed(2).replace(/\.00$/, '')}`);
      if (coinMult > 1) multTexts.push(`ÏΩîÏù∏ ÏÉùÏÇ∞ x${coinMult.toFixed(2).replace(/\.00$/, '')}`);
      if (clickMult > 1) multTexts.push(`ÌÅ¥Î¶≠ Ï±ÑÍµ¥ x${clickMult.toFixed(2).replace(/\.00$/, '')}`);
      if (workerMult > 1) multTexts.push(`ÏïåÎ∞î Ìö®Ïú® x${workerMult.toFixed(2).replace(/\.00$/, '')}`);
      const list = buffs.map(b => `<li>${escapeHTML(b)}</li>`).join('');
      const multInfo = multTexts.length ? `<div style="margin-top:6px;">Ï†ÅÏö© Î∞∞Ïú®: ${multTexts.map(escapeHTML).join(' ¬∑ ')}</div>` : '';
      perm.innerHTML = buffs.length
        ? `<div style="font-weight:700; margin-bottom:4px;">üéÅ ÏòÅÍµ¨ Î≤ÑÌîÑ</div><ul style="margin:0 0 6px 18px; padding:0;">${list}</ul>${multInfo}`
        : '<div style="font-weight:700; margin-bottom:4px;">üéÅ ÏòÅÍµ¨ Î≤ÑÌîÑ</div><div>ÌôúÏÑ±ÌôîÎêú ÏòÅÍµ¨ Î≤ÑÌîÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    }

    function renderBuffStatus(){
      const btn = document.getElementById('buff-btn');
      const listEl = document.getElementById('buff-list');
      pruneExpiredBuffs();
      const now = Date.now();
      const buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      const count = buffs.length;
      if (btn) {
        btn.textContent = count > 0 ? `Î≤ÑÌîÑ(${count})` : 'Î≤ÑÌîÑ(0)';
      }
      if (listEl) {
        if (count === 0) {
          listEl.innerHTML = 'Ï†ÅÏö© Ï§ëÏù∏ Î≤ÑÌîÑÍ∞Ä ÏóÜÏäµÎãàÎã§.';
        } else {
          const names = { all:'Ï†ÑÏ≤¥', coin:'ÏΩîÏù∏', res:'ÏûêÏõê' };
          listEl.innerHTML = buffs.map(b=>{
            const leftMs = b.until - now;
            const m = Math.max(0, Math.floor(leftMs/60000));
            const s = Math.max(0, Math.floor((leftMs%60000)/1000));
            const mult = 1 + b.value;
            const multText = (Math.abs(mult - Math.round(mult)) < 1e-9) ? `x${Math.round(mult)}` : `x${(Math.round(mult*10)/10)}`;
            return `<div class="buff-item"><span>${names[b.type]||'Î≤ÑÌîÑ'} ${multText}</span><span>${m}:${String(s).padStart(2,'0')}</span></div>`;
          }).join('');
        }
      }
      renderPermanentBuffs();
    }

    /* ========= Ïà´Ïûê ÌïúÍµ≠Ïãù Îã®ÏúÑ ========= */
    function formatKR(num, decimalsForUnits = 2) {
      if (num === null || num === undefined) return '0';
      if (!isFinite(num)) return String(num);
      const neg = num < 0;
      let n = Math.abs(num);
      const units = ['', 'Îßå', 'Ïñµ', 'Ï°∞', 'Í≤Ω', 'Ìï¥', 'Ïûê', 'Ïñë', 'Íµ¨', 'Í∞Ñ', 'Ï†ï', 'Ïû¨', 'Í∑π'];
      let u = 0;
      while (n >= 10000 && u < units.length - 1) { n /= 10000; u++; }
      if (u === 0) {
        const rounded = Math.round(n);
        return (neg ? '-' : '') + rounded.toLocaleString('ko-KR');
      }
      const s = n.toFixed(decimalsForUnits).replace(/\.0+$|(\.\d*[1-9])0+$/, '$1');
      return (neg ? '-' : '') + s + units[u];
    }

    function escapeHTML(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatMailDate(ts) {
      if (!ts) return '';
      try {
        return new Date(ts).toLocaleString('ko-KR');
      } catch { return ''; }
    }

    function updateMailBadges() {
      const unread = mailboxCache.filter(m => !m.readAt).length;
      const badge = document.getElementById('mail-unread-badge');
      if (badge) {
        if (unread > 0) {
          badge.textContent = unread > 99 ? '99+' : String(unread);
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
      const side = document.getElementById('mail-unread-side');
      if (side) {
        if (unread > 0) {
          side.textContent = unread > 99 ? '99+' : String(unread);
          side.style.opacity = '1';
        } else {
          side.textContent = '-';
          side.style.opacity = '0.65';
        }
      }
    }

    function generateMailId() {
      return `mail_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    }

    function buildMailRewardsHtml(mail) {
      const rewards = mail?.rewards;
      const rows = [];
      const resAmt = Number(rewards?.resources ?? rewards?.res ?? 0);
      if (resAmt > 0) rows.push(`<span>ü™® ÏûêÏõê +${formatKR(resAmt)}</span>`);
      const coinAmt = Number(rewards?.coins ?? rewards?.coin ?? 0);
      if (coinAmt > 0) rows.push(`<span>üí∞ ÏΩîÏù∏ +${formatKR(coinAmt)}</span>`);
      const ecoAmt = Number(rewards?.eventCoins ?? rewards?.eco ?? rewards?.ecoins ?? 0);
      if (ecoAmt > 0) rows.push(`<span>üéüÔ∏è Ïù¥Î≤§Ìä∏ÏΩîÏù∏ +${formatKR(ecoAmt)}</span>`);
      const buffList = Array.isArray(rewards?.buffs)
        ? rewards.buffs
        : rewards?.buff ? [rewards.buff] : [];
      buffList.forEach(b => {
        if (!b) return;
        const type = b.type || b.kind;
        const mult = Number(b.value ?? b.mult ?? b.bmult ?? 0);
        const durMs = Number(b.duration ?? b.durationMs ?? b.dur ?? 0);
        if (!type || mult <= 0 || durMs <= 0) return;
        const minutes = Math.max(1, Math.round(durMs / 60000));
        rows.push(`<span>üöÄ Î≤ÑÌîÑ(${type}) √ó${(1 + mult).toFixed(2)} / ${minutes}Î∂Ñ</span>`);
      });
      if (!rows.length) return '<span>Î≥¥ÏÉÅ ÏóÜÏùå</span>';
      return rows.join('');
    }

    function renderMailList() {
      const listEl = document.getElementById('mail-list');
      if (!listEl) return;
      if (!mailboxCache.length) {
        listEl.innerHTML = '<div class="mail-empty">Î∞õÏùÄ Ïö∞Ìé∏Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
        return;
      }
      const html = mailboxCache.map(mail => {
        const unread = !mail.readAt;
        const selected = selectedMailId === mail.id;
        const preview = escapeHTML((mail.body || '').replace(/\s+/g, ' ').trim().slice(0, 40));
        const sent = formatMailDate(mail.sentAt);
        return `
          <button type="button" class="mail-item${unread ? ' unread' : ''}${selected ? ' selected' : ''}" data-mail-id="${mail.id}">
            <div class="mail-subject">${escapeHTML(mail.subject || 'Ï†úÎ™© ÏóÜÏùå')}</div>
            <div class="mail-preview">${preview || 'ÎÇ¥Ïö© ÏóÜÏùå'}</div>
            <div class="mail-meta"><span>${escapeHTML(mail.from || 'ÏãúÏä§ÌÖú')}</span><span>${sent}</span></div>
          </button>`;
      }).join('');
      listEl.innerHTML = html;
      Array.from(listEl.querySelectorAll('.mail-item')).forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-mail-id');
          selectMail(id);
        });
      });
    }

    function renderMailDetail(mail) {
      const detail = document.getElementById('mail-detail');
      if (!detail) return;
      if (!mail) {
        detail.innerHTML = '<div class="mail-empty">Ïö∞Ìé∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>';
        return;
      }
      const sent = formatMailDate(mail.sentAt);
      const read = mail.readAt ? formatMailDate(mail.readAt) : null;
      const claimed = mail.claimedAt ? formatMailDate(mail.claimedAt) : null;
      const bodyHtml = escapeHTML(mail.body || '').replace(/\n/g, '<br/>');
      const rewardsHtml = buildMailRewardsHtml(mail);
      const hasRewards = !!mail.rewards && rewardsHtml !== '<span>Î≥¥ÏÉÅ ÏóÜÏùå</span>';
      const statusParts = [`Î∞úÏÜ°: ${sent || '-'}`];
      if (read) statusParts.push(`ÏùΩÏùå: ${read}`);
      if (claimed) statusParts.push(`Î≥¥ÏÉÅ ÏàòÎ†π: ${claimed}`);
      const claimDisabled = !hasRewards || !!mail.claimedAt;
      const claimLabel = mail.claimedAt ? 'ÏàòÎ†π ÏôÑÎ£å' : 'Î≥¥ÏÉÅ Î∞õÍ∏∞';
      detail.innerHTML = `
        <div>
          <h4>${escapeHTML(mail.subject || 'Ï†úÎ™© ÏóÜÏùå')}</h4>
          <div class="mail-meta-line">Î≥¥ÎÇ∏ ÏÇ¨Îûå: ${escapeHTML(mail.from || 'ÏãúÏä§ÌÖú')} ‚Ä¢ ${statusParts.join(' ‚Ä¢ ')}</div>
        </div>
        <div class="mail-body">${bodyHtml || 'ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.'}</div>
        <div id="mail-rewards">${rewardsHtml}</div>
        <div id="mail-actions">
          <button type="button" class="secondary" id="mail-delete-btn">ÏÇ≠Ï†ú</button>
          <button type="button" id="mail-claim-btn" ${claimDisabled ? 'disabled' : ''}>${claimLabel}</button>
        </div>`;
      detail.querySelector('#mail-delete-btn')?.addEventListener('click', () => deleteMail(mail.id));
      if (!claimDisabled) {
        detail.querySelector('#mail-claim-btn')?.addEventListener('click', () => claimMailReward(mail.id));
      }
    }

    function selectMail(mailId) {
      if (!mailId) {
        selectedMailId = null;
        renderMailList();
        renderMailDetail(null);
        updateMailBadges();
        return;
      }
      let mail = mailboxCache.find(m => m.id === mailId);
      if (!mail) {
        selectedMailId = null;
        renderMailList();
        renderMailDetail(null);
        updateMailBadges();
        return;
      }
      selectedMailId = mailId;
      if (!mail.readAt) {
        const now = Date.now();
        mailboxCache = mailboxCache.map(m => m.id === mailId ? { ...m, readAt: m.readAt || now } : m);
        mail = mailboxCache.find(m => m.id === mailId) || mail;
        markMailAsRead(mailId);
      }
      renderMailList();
      renderMailDetail(mail);
      updateMailBadges();
    }

    async function markMailAsRead(mailId) {
      if (!uid || !userBasePath) return;
      try {
        await update(ref(db), { [`${userBasePath}/mailbox/${mailId}/readAt`]: Date.now() });
      } catch (err) {
        console.warn('markMailAsRead Ïã§Ìå®', err);
      }
    }

    function applyMailRewards(mail) {
      if (!mail?.rewards) return [];
      const rewards = mail.rewards || {};
      const applied = [];
      const resAmt = Math.max(0, Math.floor(Number(rewards.resources ?? rewards.res ?? 0)));
      if (resAmt > 0) {
        const finalResAmt = resAmt * (perkState.resourceMult || 1);
        registerAuditIntent('res', finalResAmt, 8000);
        state.resources += finalResAmt;
        auditAdd('res', finalResAmt);
        applied.push(`ÏûêÏõê ${formatKR(finalResAmt)}`);
      }
      const coinAmt = Math.max(0, Math.floor(Number(rewards.coins ?? rewards.coin ?? 0)));
      if (coinAmt > 0) {
        const finalCoinAmt = coinAmt * (perkState.coinMult || 1);
        registerAuditIntent('coin', finalCoinAmt, 8000);
        state.coins += finalCoinAmt;
        auditGain('coin', finalCoinAmt);
        applied.push(`ÏΩîÏù∏ ${formatKR(finalCoinAmt)}`);
      }
      const ecoAmt = Math.max(0, Math.floor(Number(rewards.eventCoins ?? rewards.eco ?? rewards.ecoins ?? 0)));
      if (ecoAmt > 0) {
        registerAuditIntent('eco', ecoAmt, 8000);
        const ecoFinal = addEventCoins(ecoAmt, 'mail');
        applied.push(`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ${formatKR(ecoFinal)}`);
      }
      const buffList = Array.isArray(rewards.buffs)
        ? rewards.buffs
        : rewards.buff ? [rewards.buff] : [];
      buffList.forEach(b => {
        if (!b) return;
        const type = b.type || b.kind;
        const mult = Number(b.value ?? b.mult ?? b.bmult ?? 0);
        const durMs = Number(b.duration ?? b.durationMs ?? b.dur ?? 0);
        if (!type || mult <= 0 || durMs <= 0) return;
        addTempBuff(type, mult, durMs);
        const minutes = Math.max(1, Math.round(durMs / 60000));
        applied.push(`Î≤ÑÌîÑ(${type}) x${(1 + mult).toFixed(2)} / ${minutes}Î∂Ñ`);
      });
      if (applied.length > 0) {
        save();
        updateUI();
        renderPlanets();
      }
      return applied;
    }

    async function claimMailReward(mailId) {
      if (!uid || !userBasePath) {
        if (!requireLoginForFeature()) return;
        showToast('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.', null, null, 2800);
        return;
      }
      const mailPath = ref(db, `${userBasePath}/mailbox/${mailId}`);
      let alreadyClaimed = false;
      try {
        const res = await runTransaction(mailPath, current => {
          if (!current) return current;
          if (current.claimedAt) { alreadyClaimed = true; return current; }
          const next = { ...current };
          const now = Date.now();
          next.claimedAt = now;
          if (!next.readAt) next.readAt = now;
          return next;
        });
        if (!res.snapshot.exists()) {
          showToast('Ïö∞Ìé∏Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.', null, null, 2600);
          return;
        }
        if (alreadyClaimed) {
          showToast('Ïù¥ÎØ∏ ÏàòÎ†πÌïú Ïö∞Ìé∏ÏûÖÎãàÎã§.', null, null, 2600);
          return;
        }
        const finalMail = { id: mailId, ...(res.snapshot.val() || {}) };
        const rewards = applyMailRewards(finalMail);
        mailboxCache = mailboxCache.map(m => m.id === mailId ? { ...m, readAt: finalMail.readAt, claimedAt: finalMail.claimedAt } : m);
        renderMailList();
        renderMailDetail(mailboxCache.find(m => m.id === mailId) || finalMail);
        updateMailBadges();
        if (rewards && rewards.length) {
          showToast(`üéÅ Î≥¥ÏÉÅÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§! (${rewards.join(', ')})`, null, null, 4200);
        } else {
          showToast('Î≥¥ÏÉÅÏùÑ ÌôïÏù∏ÌñàÏäµÎãàÎã§.', null, null, 3200);
        }
      } catch (err) {
        console.error('claimMailReward Ïò§Î•ò', err);
        showToast('Î≥¥ÏÉÅ ÏàòÎ†πÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', null, null, 3200);
      }
    }

    async function deleteMail(mailId) {
      if (!uid || !userBasePath) {
        if (!requireLoginForFeature()) return;
        showToast('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.', null, null, 2800);
        return;
      }
      const ok = confirm('Ìï¥Îãπ Ïö∞Ìé∏ÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî? Î≥¥ÏÉÅÏùÑ Î∞õÏïòÎã§Î©¥ ÏÇ≠Ï†úÌï¥ÎèÑ ÏïàÏ†ÑÌï©ÎãàÎã§.');
      if (!ok) return;
      try {
        await update(ref(db), { [`${userBasePath}/mailbox/${mailId}`]: null });
        mailboxCache = mailboxCache.filter(m => m.id !== mailId);
        if (selectedMailId === mailId) {
          selectedMailId = null;
          renderMailDetail(null);
        }
        renderMailList();
        updateMailBadges();
        showToast('Ïö∞Ìé∏ÏùÑ ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.', null, null, 2600);
      } catch (err) {
        console.error('deleteMail Ïò§Î•ò', err);
        showToast('Ïö∞Ìé∏ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', null, null, 3000);
      }
    }

    function openMailOverlay() {
      if (!uid) {
        if (!requireLoginForFeature()) return;
      }
      const overlay = document.getElementById('mail-overlay');
      if (!overlay) return;
      hideAllOverlays();
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
      if (!selectedMailId && mailboxCache.length) {
        selectMail(mailboxCache[0].id);
      } else {
        renderMailList();
        const current = selectedMailId ? mailboxCache.find(m => m.id === selectedMailId) : null;
        renderMailDetail(current);
      }
      updateMailBadges();
      const targetInput = document.getElementById('mail-compose-target');
      if (targetInput) {
        targetInput.value = 'Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)';
      }
    }

    function closeMailOverlay() {
      const overlay = document.getElementById('mail-overlay');
      if (!overlay) return;
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function updateMailComposeVisibility(user) {
      const section = document.getElementById('mail-compose-section');
      if (!section) return;
      const isAdmin = !!user && String(user.email || '').toLowerCase() === MAIL_ADMIN_EMAIL;
      section.classList.toggle('show', isAdmin);
      if (isAdmin) {
        const targetInput = document.getElementById('mail-compose-target');
        if (targetInput) targetInput.value = 'Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)';
      }
    }

    async function fetchAllUserBasePaths() {
      const targets = new Set();
      const baseKeys = ['gameData', 'mailbox', 'security', 'daily'];

      try {
        const mapSnap = await get(ref(db, 'userServerMap'));
        if (mapSnap.exists()) {
          const mapVal = mapSnap.val() || {};
          Object.values(mapVal).forEach(entry => {
            const server = entry?.server;
            const id = entry?.id;
            if (typeof server === 'string' && server && typeof id === 'string' && id) {
              targets.add(`users/${server}/${id}`);
            }
          });
        }
      } catch (err) {
        console.warn('fetchAllUserBasePaths map Ïò§Î•ò', err);
      }

      try {
        const usersSnap = await get(ref(db, 'users'));
        if (usersSnap.exists()) {
          const collectNode = (node, parts = []) => {
            if (!node || typeof node !== 'object') return;
            const hasCoreData = baseKeys.some(k => Object.prototype.hasOwnProperty.call(node, k));
            const hasMetaOnly = parts.length >= 2 && Object.prototype.hasOwnProperty.call(node, 'meta');
            const isUserNode = hasCoreData || hasMetaOnly;
            if (isUserNode && parts.length > 0) {
              targets.add(`users/${parts.join('/')}`);
              return;
            }
            if (parts.length >= 2) return;
            for (const [childKey, childVal] of Object.entries(node)) {
              if (!childKey || !childVal || typeof childVal !== 'object') continue;
              collectNode(childVal, [...parts, childKey]);
            }
          };
          collectNode(usersSnap.val() || {}, []);
        }
      } catch (err) {
        console.warn('fetchAllUserBasePaths users Ïò§Î•ò', err);
      }

      return Array.from(targets);
    }

    async function sendAdminMail() {
      if (!auth?.currentUser || String(auth.currentUser.email || '').toLowerCase() !== MAIL_ADMIN_EMAIL) {
        showToast('Ïö∞Ìé∏ Î∞úÏÜ° Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.', null, null, 3200);
        return;
      }
      const targetInput = document.getElementById('mail-compose-target');
      const subjectInput = document.getElementById('mail-compose-subject');
      const bodyInput = document.getElementById('mail-compose-body');
      const resInput = document.getElementById('mail-compose-res');
      const coinInput = document.getElementById('mail-compose-coin');
      const ecoInput = document.getElementById('mail-compose-ecoin');
      const buffTypeSel = document.getElementById('mail-compose-buff-type');
      const buffMultInput = document.getElementById('mail-compose-buff-mult');
      const buffMinInput = document.getElementById('mail-compose-buff-min');

      if (!subjectInput || !bodyInput) return;

      const subject = subjectInput.value.trim() || 'Ï†úÎ™© ÏóÜÏùå';
      const body = bodyInput.value.trim();
      const resAmt = Math.max(0, Math.floor(Number(resInput?.value ?? 0)));
      const coinAmt = Math.max(0, Math.floor(Number(coinInput?.value ?? 0)));
      const ecoAmt = Math.max(0, Math.floor(Number(ecoInput?.value ?? 0)));
      const buffType = buffTypeSel?.value || '';
      const buffMultRaw = Number(buffMultInput?.value ?? 0);
      const buffMinutes = Math.max(0, Math.floor(Number(buffMinInput?.value ?? 0)));

      const rewards = {};
      let rewardCount = 0;
      if (resAmt > 0) { rewards.resources = resAmt; rewardCount++; }
      if (coinAmt > 0) { rewards.coins = coinAmt; rewardCount++; }
      if (ecoAmt > 0) { rewards.eventCoins = ecoAmt; rewardCount++; }
      if (buffType && buffMultRaw > 1 && buffMinutes > 0) {
        rewards.buffs = [{ type: buffType, value: buffMultRaw - 1, duration: buffMinutes * 60000 }];
        rewardCount++;
      }

      const payload = {
        subject,
        body,
        from: MAIL_ADMIN_EMAIL,
        sentAt: Date.now()
      };
      if (rewardCount > 0) payload.rewards = rewards;

      const recipients = await fetchAllUserBasePaths();
      if (!recipients.length) {
        showToast('Î∞úÏÜ° ÎåÄÏÉÅ ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', null, null, 3600);
        if (targetInput) targetInput.value = 'Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)';
        return;
      }

      const updates = {};
      recipients.forEach(path => {
        if (!path) return;
        updates[`${path}/mailbox/${generateMailId()}`] = { ...payload };
      });

      if (!Object.keys(updates).length) {
        showToast('Î∞úÏÜ° ÎåÄÏÉÅ ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', null, null, 3600);
        if (targetInput) targetInput.value = 'Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)';
        return;
      }

      const sendBtn = document.getElementById('mail-compose-send');
      if (sendBtn) sendBtn.disabled = true;

      try {
        await update(ref(db), updates);
        const count = recipients.length;
        showToast(`Ïö∞Ìé∏ÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§. (Ï¥ù ${count}Î™Ö)`, null, null, 3200);
        if (targetInput) targetInput.value = 'Î™®Îì† Ïú†Ï†Ä (ÏûêÎèô Î∞úÏÜ°)';
      } catch (err) {
        console.error('sendAdminMail Ïò§Î•ò', err);
        showToast('Ïö∞Ìé∏ Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', null, null, 3600);
      } finally {
        if (sendBtn) sendBtn.disabled = false;
      }
    }

    document.getElementById('mail-close')?.addEventListener('click', closeMailOverlay);
    document.getElementById('mail-compose-send')?.addEventListener('click', sendAdminMail);
    document.getElementById('mail-overlay')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeMailOverlay();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMailOverlay();
    });
    renderMailList();
    renderMailDetail(null);
    updateMailBadges();
    window.openMailOverlay = openMailOverlay;
    window.closeMailOverlay = closeMailOverlay;

    /* ========= Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ & Ïú†Ìã∏ ========= */
    const defaultData = {
      resources:0, coins:0, eventCoins:0,
      clickPower:1, shipLevel:1, shipUpgradeCost:20, clickUpgradeCost:15,
      workerCount:0, conversionCount:0, autoConvertBought:false, autoConvertEnabled:false, ownedPlanets:[], discoveredPlanets:[], planetExploration:null,
      santaPieces:0, santaCoins:0, christmasTreeLevel:0,
      quests: { daily:{}, weekly:{} },
      _lastUpdated: 0
    };

    const shipEnhanceBaseMsg = 'Ï≤´ Í∞ïÌôîÎäî 100% ÏÑ±Í≥µ! Î†àÎ≤®Ïù¥ Ïò§Î•ºÏàòÎ°ù ÌôïÎ•†Ïù¥ ÎÇÆÏïÑÏßëÎãàÎã§.';
    let shipEnhanceMessage = shipEnhanceBaseMsg;
    let shipEnhanceTone = 'info';
    let shipEnhanceInProgress = false;

    function getShipSuccessRate(level = state.shipLevel) {
      const lv = Math.max(1, level || 1);
      const rate = Math.max(1, 100 - (lv - 1) * 8);
      return Math.round(rate);
    }

    function getShipEventUpgradeOffer() {
      const rate = getShipSuccessRate();
      if (rate <= 5) {
        return { cost: 90, guaranteed: true };
      }
      if (rate <= 10) {
        return { cost: 12, guaranteed: true };
      }
      if (rate <= 20) {
        return { cost: 7, guaranteed: true };
      }
      return { cost: 1, guaranteed: false };
    }

    function setShipEnhanceStatus(message, tone = 'info') {
      shipEnhanceMessage = message;
      shipEnhanceTone = tone;
      const statusEl = document.getElementById('ship-upgrade-status');
      if (statusEl) {
        statusEl.innerText = message;
        statusEl.dataset.tone = tone;
      }
    }

    const christmasTreeRewards = [
      { cost: 5, reward: '2025 ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ÌöçÎìù x2 ÏòÅÍµ¨ Ï†ÅÏö©', effects: { event: 2 } },
      { cost: 10, reward: 'ÏûêÏõê ÏÉùÏÇ∞ x2 ÏòÅÍµ¨', effects: { res: 2 } },
      { cost: 25, reward: 'ÏΩîÏù∏ ÏÉùÏÇ∞ x2 ÏòÅÍµ¨', effects: { coin: 2 } },
      { cost: 60, reward: 'ÌÅ¥Î¶≠ Ï±ÑÍµ¥ x2 ÏòÅÍµ¨', effects: { click: 2 } },
      { cost: 120, reward: 'ÏïåÎ∞î Ìö®Ïú® x1.5 ÏòÅÍµ¨', effects: { worker: 1.5 } },
      { cost: 200, reward: '2025 ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ï∂îÍ∞Ä Î∞∞Ïú® & Ï†Ñ ÏÉùÏÇ∞ x2 ÏòÅÍµ¨', effects: { res: 2, coin: 2, event: 2 } }
    ];
    function withAutoConvertDefaults(rawState) {
      const merged = { ...defaultData, ...(rawState || {}) };
      if (typeof merged.autoConvertEnabled !== 'boolean') {
        merged.autoConvertEnabled = !!merged.autoConvertBought;
      }
      return merged;
    }
    function writeGuestProfile(profile) {
      try { localStorage.setItem(GUEST_PROFILE_KEY, JSON.stringify(profile)); }
      catch (err) { console.warn('guest profile save error', err); }
    }
    function persistGuestProfile() {
      if (!guestMode) return;
      try {
        const now = Date.now();
        const snapshot = JSON.parse(JSON.stringify({ ...state }));
        if (!snapshot || typeof snapshot !== 'object') return;
        if (!snapshot._lastUpdated) snapshot._lastUpdated = now;
        writeGuestProfile({
          state: snapshot,
          rankingUnlocked: !!rankingUnlocked,
          lastSavedAt: now
        });
      } catch (err) {
        console.warn('guest persist failed', err);
      }
    }
    function applyGuestProfile(profile) {
      const rawState = (profile && typeof profile === 'object' && profile.state && typeof profile.state === 'object')
        ? profile.state
        : null;
      state = withAutoConvertDefaults(rawState);
      rankingUnlocked = !!(profile && profile.rankingUnlocked);
    }
    function loadGuestProfileIntoState() {
      const profile = readGuestProfile();
      applyGuestProfile(profile || {});
    }
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const initialClickUpgradeCost=15, clickUpgradeIncrement=3;

    function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }
    function ensureClickUpgradeCost(){
      const sanitized = Math.max(1, Math.round(state.clickUpgradeCost ?? initialClickUpgradeCost));
      if (state.clickUpgradeCost !== sanitized) state.clickUpgradeCost = sanitized;
      return sanitized;
    }
    function getNextClickUpgradeCost(currentCost){
      const base = currentCost ?? initialClickUpgradeCost;
      return Math.max(1, Math.round(base + clickUpgradeIncrement));
    }
    function applyClickUpgrades(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      let cost = ensureClickUpgradeCost();
      for (let i = 0; i < count; i++) {
        state.clickPower = (state.clickPower||1) + 1;
        cost = getNextClickUpgradeCost(cost);
      }
      state.clickUpgradeCost = cost;
    }
    function hireWorkersBulk(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      state.workerCount += count;
      applyQuestProgress('worker', count);
    }
    function hireConversionsBulk(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      state.conversionCount += count;
    }

    function isOffline(){
      try { return navigator.onLine === false; }
      catch { return false; }
    }

    function isBackgrounded(){
      try { return document.visibilityState === 'hidden'; }
      catch { return false; }
    }

    // üîÑ Î≥ÄÌôò(Ï¶ùÍ∞Ä/ÏßÄÏ∂ú Ïû•Î∂Ä Î∞òÏòÅ)
    function convertResources(maxCount = null, source = 'manual') {
      if (window.__CHRISTMAS_BLOCK_COINS) return false;
      if (isOffline()) return false;
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count <= 0) return false;

      const resOut = count * 10;
      state.resources -= resOut;
      auditSpend('res', resOut);

      const coinMul = activeBuffFactor('coin') * aggregateTreeMultiplier('coin');
      const perkCoinMul = perkState.coinMult || 1;
      const inc = count * coinMul * perkCoinMul;
      state.coins += inc;
      auditGain('coin', inc, source === 'manual' ? 'manual' : 'auto');
      applyQuestProgress('convert', count);
      playSfx('sfx-coin');
      return true;
    }

    function aggregateTreeMultiplier(kind) {
      const lv = Math.max(0, Math.min(christmasTreeRewards.length, state.christmasTreeLevel || 0));
      let mult = 1;
      for (let i = 0; i < lv; i++) {
        const eff = christmasTreeRewards[i]?.effects || {};
        if (eff.all) mult *= eff.all;
        if (kind === 'res' && eff.res) mult *= eff.res;
        if (kind === 'coin' && eff.coin) mult *= eff.coin;
        if (kind === 'click' && eff.click) mult *= eff.click;
        if (kind === 'worker' && eff.worker) mult *= eff.worker;
        if (kind === 'event' && eff.event) mult *= eff.event;
      }
      return mult;
    }

    function addEventCoins(amount, source = 'reward') {
      const base = Math.max(0, Math.floor(amount || 0));
      if (!base) return 0;
      const mult = aggregateTreeMultiplier('event');
      const finalAmt = Math.max(0, Math.floor(base * mult));
      state.eventCoins = (state.eventCoins || 0) + finalAmt;
      auditGain('eco', finalAmt, source);
      return finalAmt;
    }

    function attachHoldRepeat(target, action, options = {}) {
      const btn = typeof target === 'string' ? document.getElementById(target) : target;
      if (!btn) return;

      const initialDelay = options.initialDelay ?? 350;
      const repeatInterval = options.repeatInterval ?? 90;
      let holdTimeout = null;
      let repeatTimer = null;
      let pointerActive = false;

      const clearTimers = () => {
        if (holdTimeout) { clearTimeout(holdTimeout); holdTimeout = null; }
        if (repeatTimer) { clearInterval(repeatTimer); repeatTimer = null; }
      };

      const invoke = () => {
        const result = action();
        return result !== false;
      };

      const stop = () => {
        pointerActive = false;
        clearTimers();
      };

      const start = ev => {
        if (ev.button !== undefined && ev.button !== 0) return;
        pointerActive = true;
        if (!invoke()) {
          pointerActive = false;
          return;
        }
        clearTimers();
        holdTimeout = setTimeout(() => {
          repeatTimer = setInterval(() => {
            if (!invoke()) stop();
          }, repeatInterval);
        }, initialDelay);
        ev.preventDefault();
      };

      btn.addEventListener('pointerdown', start);
      btn.addEventListener('pointerup', stop);
      btn.addEventListener('pointerleave', stop);
      btn.addEventListener('pointercancel', stop);
      btn.addEventListener('contextmenu', ev => {
        if (pointerActive) ev.preventDefault();
      });
      btn.addEventListener('click', ev => {
        if (ev.detail !== 0) return; // ÌÇ§Î≥¥Îìú ÌÅ¥Î¶≠ Ïô∏ÏóêÎäî pointerdownÏúºÎ°ú Ï≤òÎ¶¨
        invoke();
      });
      btn.addEventListener('keydown', ev => {
        if (ev.key === ' ' || ev.key === 'Enter') {
          ev.preventDefault();
          invoke();
        }
      });
    }

    async function ensureInitialData(refObj) {
      try {
        await runTransaction(refObj, current => {
          if (current === null) return { ...defaultData, _lastUpdated: Date.now() };
          return current;
        });
      } catch (err) { console.error('Ï¥àÍ∏∞Ìôî Ìä∏ÎûúÏû≠ÏÖò ÏóêÎü¨:', err); }
    }

    const SAVE_DEBOUNCE_MS = 450;
    let saveTimer = null;
    let lastSaveAt = 0;

    function performSaveNow() {
      if (!window.__PLAY_ALLOWED) return;
      const now = Date.now();
      state._lastUpdated = now;
      sessionLogger?.log?.('Ï†ÄÏû• Î£®Ìã¥Ïù¥ Ìò∏Ï∂úÎêòÏóàÏäµÎãàÎã§.');
      if (guestMode) {
        persistGuestProfile();
        recoveryManager?.safeCreate?.('guest-save');
        sessionLogger?.log?.('Í≤åÏä§Ìä∏ ÌîÑÎ°úÌïÑÏùÑ Ï†ÄÏû•ÌñàÏäµÎãàÎã§.');
        lastSaveAt = now;
        return;
      }
      if (!uid || !dataRef) return;
      if (isInitialSync) return;
      localLastWrite = now;
      lastSaveAt = now;
      try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
      update(dataRef, { ...state })
        .then(() => sessionLogger?.log?.('Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å'))
        .catch(err => {
          console.error('Ï†ÄÏû• ÏóêÎü¨:', err);
          sessionLogger?.log?.(`Ï†ÄÏû• ÏóêÎü¨: ${err?.message || err}`);
        });
      recoveryManager?.safeCreate?.('sync-save');
    }

    function save(forceImmediate = false) {
      if (forceImmediate) {
        if (saveTimer) { clearTimeout(saveTimer); saveTimer = null; }
        performSaveNow();
        return;
      }
      const now = Date.now();
      const elapsed = now - lastSaveAt;
      if (elapsed >= SAVE_DEBOUNCE_MS) {
        if (saveTimer) { clearTimeout(saveTimer); saveTimer = null; }
        performSaveNow();
        return;
      }
      if (saveTimer) return;
      saveTimer = setTimeout(() => {
        saveTimer = null;
        performSaveNow();
      }, SAVE_DEBOUNCE_MS - elapsed);
    }

    window.addEventListener('pagehide', () => {
      sessionLogger?.log?.('pagehide Ïù¥Î≤§Ìä∏ Í∞êÏßÄ, Ï¶âÏãú Ï†ÄÏû•Ìï©ÎãàÎã§.');
      save(true);
      recoveryManager?.safeCreate?.('pagehide');
      recoveryManager?.stop?.();
    });
    document.addEventListener('visibilitychange', () => {
      sessionLogger?.log?.(`visibilitychange: ${document.visibilityState}`);
      if (document.visibilityState === 'hidden') {
        recoveryManager?.safeCreate?.('hidden');
        save(true);
      } else if (document.visibilityState === 'visible') {
        recoveryManager?.resume?.();
      }
    });

    /* ========= ÏÉà ÌÇ§ Í∑úÏπô ========= */
    function encodeEmailToKey(email){
      const s = String(email||'').trim().toLowerCase();
      return s
        .replace(/\s+/g,'')
        .replace(/@/g,'_at_')
        .replace(/\./g,'_dot_')
        .replace(/[#$\[\]\/\\?%*]/g, '-')
        .replace(/[^a-z0-9_\-]/g, '-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromDisplayName(name){
      return (String(name||'').trim().toLowerCase() || 'user')
        .replace(/[^a-z0-9_\-]/g,'-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromUid(uid){
      return `user_${String(uid||'').slice(0,8) || '00000000'}`;
    }
    function makeIdKeyFromUser(user){
      if (user?.email) return encodeEmailToKey(user.email);
      if (user?.displayName) return fallbackIdFromDisplayName(user.displayName);
      return fallbackIdFromUid(user?.uid);
    }

    function isNewlyCreatedAccount(user, minutes = 5) {
      try {
        const ct = Date.parse(user?.metadata?.creationTime || '') || 0;
        const lt = Date.parse(user?.metadata?.lastSignInTime || '') || 0;
        if (!ct || !lt) return false;
        return Math.abs(lt - ct) <= minutes * 60 * 1000;
      } catch { return false; }
    }

    async function allocateServerForUser(){
      try{
        const res = await runTransaction(ref(db, 'meta/nextIndex'), cur => (cur || 0) + 1);
        const idx = res?.snapshot?.val() || 1;
        const serverNum = Math.max(1, Math.ceil(idx / 15));
        return `server${serverNum}`;
      }catch{
        return 'server1';
      }
    }

    async function planMigrationForUser(user){
      const uid = user.uid;
      const desiredId = makeIdKeyFromUser(user);
      const desiredServer = await allocateServerForUser();

      let mapping = null;
      try {
        const m = await get(ref(db, `userServerMap/${uid}`));
        mapping = m.exists() ? (m.val() || null) : null;
      } catch {}

      const legacySnap = await get(ref(db, `users/${uid}`));
      const legacyExists = legacySnap.exists();

      let srcBasePath = null;
      let server = desiredServer;

      if (mapping && mapping.server && mapping.id) {
        srcBasePath = `users/${mapping.server}/${mapping.id}`;
        server = mapping.server;
      } else if (legacyExists) {
        srcBasePath = `users/${uid}`;
      }

      const destBasePath = `users/${server}/${desiredId}`;
      const destSnap = await get(ref(db, destBasePath));
      const destExists = destSnap.exists();

      if (isNewlyCreatedAccount(user) && !legacyExists && !mapping && !destExists) {
        return { need: false, server, oldMapping: null, srcBasePath: null, destBasePath, reason: 'fresh-signup' };
      }

      if (mapping && mapping.server && mapping.id && mapping.id !== desiredId) {
        try {
          const srcSnap = await get(ref(db, srcBasePath));
          if (!srcSnap.exists()){
            return { need:false, server: mapping.server, oldMapping: mapping, srcBasePath: null, destBasePath, reason: 'rename-mapping-only' };
          }
        } catch {}
        return { need:true, server: mapping.server, oldMapping: mapping, srcBasePath, destBasePath, reason: 'rename-to-email-id' };
      }

      if (!mapping && legacyExists) {
        return { need:true, server, oldMapping: null, srcBasePath: `users/${uid}`, destBasePath, reason: 'legacy-flat' };
      }

      return { need:false, server, oldMapping: mapping || null, srcBasePath: null, destBasePath, reason: 'fresh-or-already-ok' };
    }

    function showMigrateOverlay(show=true, msg='ÎåÄÍ∏∞ Ï§ë‚Ä¶'){
      const ov = document.getElementById('migrate-overlay');
      const pr = document.getElementById('migrate-progress');
      if (pr) pr.textContent = msg || '';
      if (ov){
        ov.classList.toggle('show', !!show);
        ov.setAttribute('aria-hidden', show ? 'false':'true');
      }
    }
    function setMigrateProgress(msg){ const pr=document.getElementById('migrate-progress'); if(pr) pr.textContent = msg||''; }
    function disableMigrateStart(dis=true){ const btn=document.getElementById('migrate-start'); if(btn) btn.disabled=!!dis; }

    async function performMigration(srcBasePath, destBasePath, user){
      setMigrateProgress('1/3 Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏùΩÎäî Ï§ë‚Ä¶');
      const srcRef = ref(db, srcBasePath);
      const destRef = ref(db, destBasePath);

      const snap = await get(srcRef);
      if (!snap.exists()){
        setMigrateProgress('ÏÜåÏä§Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ Í±¥ÎÑàÎúÅÎãàÎã§.');
      } else {
        const payload = snap.val() || {};
        setMigrateProgress('2/3 ÏÉà ÏúÑÏπòÎ°ú Î≥µÏÇ¨ Ï§ë‚Ä¶');
        await update(ref(db), { [destBasePath]: payload });
        setMigrateProgress('3/3 ÏõêÎ≥∏ ÏÇ≠Ï†ú Ï§ë‚Ä¶');
        await update(ref(db), { [srcBasePath]: null });
      }
      const displayEmail = String(user?.email || '').trim();
      await update(ref(db), {
        [`userServerMap/${user.uid}`]: {
          server: userServerKey,
          id: userIdKey,
          displayId: displayEmail || null,
          migratedAt: Date.now()
        }
      });
      setMigrateProgress('‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å! Ïû†Ïãú ÌõÑ Í≤åÏûÑÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§‚Ä¶');
    }

    /* ======================
       KST Ïú†Ìã∏ / Îç∞ÏùºÎ¶¨
       ====================== */
    function kstDate(d=new Date()){
      return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }
    function kstDayKey(d=new Date()){
      const t = kstDate(d);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextResetKST(d=new Date()){ const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n; }
    function fmtLeft(ms){
      if(ms<=0) return 'ÏßÄÍ∏à Í∞ÄÎä•';
      const s=Math.floor(ms/1000);
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    const BASE_DAILY_QUESTS = [
      { id:'collect_res',       title:'ÏûêÏõê 1,200 Ï±ÑÏßë',                unit:'res',         target:1200 },
      { id:'convert_ore',       title:'ÏûêÏõê Î≥ÄÌôò(ÏûêÎèô Ìè¨Ìï®) 25Ìöå',      unit:'convert',     target:25 },
      { id:'hire_workers',      title:'ÏïåÎ∞î 3Î™Ö Í≥†Ïö©',                  unit:'worker',      target:3 },
      { id:'ship_upgrade',      title:'Ïö∞Ï£ºÏÑ† 1Ìöå ÏóÖÍ∑∏Î†àÏù¥Îìú(Ï§ëÍ∞Ñ)',     unit:'ship',        target:1 },
      { id:'coin_manual_daily', title:'ÏßÅÏ†ë Ï†ÑÌôòÏúºÎ°ú ÏΩîÏù∏ 2,400 ÌöçÎìù',   unit:'coin_manual', target:2400 },
      { id:'coin_worker_daily', title:'ÏïåÎ∞îÎ°ú ÏΩîÏù∏ 3,200 ÌöçÎìù',          unit:'coin_worker', target:3200 }
    ];
    const BASE_WEEKLY_QUESTS = [
      { id:'coin_manual_weekly', title:'ÏßÅÏ†ë Ï†ÑÌôòÏúºÎ°ú ÏΩîÏù∏ 45,000 ÌöçÎìù', unit:'coin_manual', target:45000 },
      { id:'coin_worker_weekly', title:'ÏïåÎ∞îÎ°ú ÏΩîÏù∏ 60,000 ÌöçÎìù',        unit:'coin_worker', target:60000 },
      { id:'upgrade_ship',       title:'Ïö∞Ï£ºÏÑ† 4Ìöå ÏóÖÍ∑∏Î†àÏù¥Îìú',          unit:'ship',        target:4 },
      { id:'explore_planet',     title:'ÏÉà ÌñâÏÑ± 2Í∞ú Ï†ïÎ≥µ',               unit:'planet',      target:2 },
      { id:'bulk_convert',       title:'ÏûêÏõê Î≥ÄÌôò(ÏûêÎèô Ìè¨Ìï®) 120Ìöå',     unit:'convert',     target:120 }
    ];

    function computeQuestDifficultySnapshot(kind){
      const planets     = state.ownedPlanets?.length || 0;
      const ship        = Math.max(1, state.shipLevel || 1);
      const workers     = state.workerCount || 0;
      const converters  = state.conversionCount || 0;
      const auto        = (state.autoConvertBought && state.autoConvertEnabled) ? 1 : 0;
      const wealthScore = Math.log10(Math.max(1, (state.coins||0) + (state.resources||0)));
      let raw = 1 + (workers * 0.05) + (converters * 0.08) + (ship * 0.12) + (planets * 0.28) + (auto * 0.25) + (wealthScore * 0.18);
      if (kind === 'weekly') raw += planets * 0.12 + ship * 0.08 + converters * 0.05;
      const cap = kind === 'weekly' ? 4.6 : 3.2;
      return Math.min(cap, raw);
    }

    function weeklyAnchor(d=new Date()){
      const t = kstDate(d);
      const day = t.getDay(); // 0: Sun
      const anchor = new Date(t);
      anchor.setHours(12,0,0,0);
      anchor.setDate(anchor.getDate() - day);
      if (day === 0 && t < anchor) anchor.setDate(anchor.getDate() - 7);
      return anchor;
    }
    function weeklyKey(d=new Date()){
      const a = weeklyAnchor(d);
      const y=a.getFullYear(), m=String(a.getMonth()+1).padStart(2,'0'), day=String(a.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}@12`;
    }
    function nextWeeklyReset(d=new Date()){
      const a = weeklyAnchor(d);
      const n = new Date(a);
      n.setDate(a.getDate()+7);
      return n;
    }

    function ensureQuestBuckets(){
      if (!state.quests || typeof state.quests !== 'object') state.quests = {};
      if (!state.quests.daily || typeof state.quests.daily !== 'object') state.quests.daily = {};
      if (!state.quests.weekly || typeof state.quests.weekly !== 'object') state.quests.weekly = {};
      if (!state.quests.daily.progress || typeof state.quests.daily.progress !== 'object') state.quests.daily.progress = {};
      if (!state.quests.weekly.progress || typeof state.quests.weekly.progress !== 'object') state.quests.weekly.progress = {};
    }
    function syncQuestPeriods(){
      ensureQuestBuckets();
      const dKey = kstDayKey();
      const wKey = weeklyKey();
      if (state.quests.daily.key !== dKey) {
        state.quests.daily = { key:dKey, progress:{}, completed:false, premiumUsed:false, completedAt:0, difficulty: computeQuestDifficultySnapshot('daily') };
      }
      if (state.quests.weekly.key !== wKey) {
        state.quests.weekly = { key:wKey, progress:{}, completed:false, ecoinUsed:false, completedAt:0, difficulty: computeQuestDifficultySnapshot('weekly') };
      }
      if (!state.quests.daily.progress) state.quests.daily.progress = {};
      if (!state.quests.weekly.progress) state.quests.weekly.progress = {};
      if (!state.quests.daily.difficulty) state.quests.daily.difficulty = computeQuestDifficultySnapshot('daily');
      if (!state.quests.weekly.difficulty) state.quests.weekly.difficulty = computeQuestDifficultySnapshot('weekly');
    }
    function questDifficulty(kind){
      syncQuestPeriods();
      const bucket = state?.quests?.[kind];
      return Math.max(1, bucket?.difficulty || 1);
    }
    function questUnitScale(task, kind){
      if (!task || (task.unit!=='coin_manual' && task.unit!=='coin_worker')) return 1;
      const wealth = Math.log10(Math.max(10, (state.coins||0) + (state.resources||0)));
      const clickScore = Math.max(1, state.clickPower || 1);
      const workerScore = Math.max(1, state.conversionCount || 0);
      let scale = 1 + (wealth * 0.25);
      if (task.unit === 'coin_manual') scale += Math.min(2.4, clickScore * 0.15);
      if (task.unit === 'coin_worker') scale += Math.min(3.0, workerScore * 0.22);
      const cap = kind === 'weekly' ? 4.8 : 3.6;
      return Math.min(cap, scale);
    }
    function isPlanetQuestFinished(target){
      const progress = state?.quests?.weekly?.progress?.explore_planet || 0;
      return allPlanetsPurchased() || progress >= Math.max(0, target || 0);
    }

    function questTasks(kind){
      const base = kind === 'weekly' ? BASE_WEEKLY_QUESTS : BASE_DAILY_QUESTS;
      const diff = questDifficulty(kind);
      const scaled = base.map(task => ({
        ...task,
        target: Math.max(task.target, Math.round(task.target * diff * questUnitScale(task, kind)))
      }));
      if (kind !== 'weekly') return scaled;
      return scaled.filter(task => !(task.id === 'explore_planet' && isPlanetQuestFinished(task.target)));
    }
    function questProgress(kind){ syncQuestPeriods(); return state?.quests?.[kind]?.progress || {}; }
    function isQuestComplete(kind){
      const tasks = questTasks(kind);
      const prog = questProgress(kind);
      return tasks.every(t => (prog[t.id] || 0) >= t.target);
    }
    function questRewardAvailable(kind){
      syncQuestPeriods();
      if (kind === 'daily') return isQuestComplete('daily') && !state.quests.daily.premiumUsed;
      if (kind === 'weekly') return isQuestComplete('weekly') && !state.quests.weekly.ecoinUsed;
      return false;
    }

    function applyQuestProgress(kind, amount = 1){
      syncQuestPeriods();
      const delta = Math.max(0, Number(amount) || 0);
      if (!delta) return;

      ['daily','weekly'].forEach(type => {
        const qs = state.quests[type];
        if (!qs.progress) qs.progress = {};
        const tasks = questTasks(type).filter(t => t.unit === kind);
        if (!tasks.length) return;

        tasks.forEach(task => {
          const prev = Number(qs.progress?.[task.id] || 0);
          const next = Math.min(task.target, prev + delta);
          qs.progress[task.id] = next;
        });

        const finished = isQuestComplete(type);
        if (finished && !qs.completed){
          qs.completed = true;
          qs.completedAt = Date.now();
          const msg = type === 'daily'
            ? '‚úÖ ÏùºÏùº ÌÄòÏä§Ìä∏ ÏôÑÎ£å! ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°ØÏù¥ Ïó¥Î†∏Ïñ¥Ïöî.'
            : 'üåü Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ ÏôÑÎ£å! Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°ØÏù¥ Ïó¥Î†∏Ïñ¥Ïöî.';
          showToast(msg, 'Î∞îÎ°ú Î≥¥Í∏∞', () => { try { openQuestOverlay(); } catch {} }, 5200);
        }
      });

      renderQuestUI();
      updateSpinButtons();
    }

    /* ‚úÖ Î£∞Î†õÏö© Í∏∞Î≥∏Í∞íÏùÄ Ïú†ÏßÄÌïòÏßÄÎßå, ÏßÄÍ∏àÎ∂ÄÌÑ∞Îäî ‚ÄúÌòÑÏû¨ ÏΩîÏù∏ Í∏∞Î∞ò‚Äù Î≥¥ÏÉÅÏù¥ Ïö∞ÏÑ† */
    function calcBaseCoin(){
      const rps = state.workerCount * getWorkerPower();
      const cps = state.conversionCount;
      const rpc = state.clickPower;
      const planets = (state.ownedPlanets?.length || 0);
      const ship = (state.shipLevel || 1);
      const auto = (state.autoConvertBought && state.autoConvertEnabled) ? 1 : 0;
      const score =
        20 * Math.log2(1 + rps) +
        45 * Math.log2(1 + cps) +
        10 * Math.log2(1 + rpc) +
        120 * planets +
        32  * ship +
        (auto ? 20 : 0);
      const baseRaw = 50 + score;
      return Math.min(Math.max(baseRaw * 0.65, 30), 30000);
    }

    /* ====== Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ Î£∞Î†õ ÌÖúÌîåÎ¶ø ====== */
    const ROULETTE_AUDIT_WINDOW_MS = 15000;

    const TPL_DAILY = [
      { key:'coin_cur_06', type:'coin', currentCoinMul:0.6, icon:'üí∞', color:'#00E5FF', w:0.35 },
      { key:'coin_cur_07', type:'coin', currentCoinMul:0.7, icon:'üí∞', color:'#4DFFB5', w:0.25 },
      { key:'res_x2_5m',   type:'buff', bkind:'res',  bmult:1.0, bdur:5*60*1000, icon:'‚ö°',  color:'#FFA8FF', w:0.18 },
      { key:'all_x2_3m',   type:'buff', bkind:'all',  bmult:1.0, bdur:3*60*1000, icon:'üöÄ',  color:'#8AE1FF', w:0.13 },
      { key:'coinbuf_x2_3m', type:'buff', bkind:'coin', bmult:1.0, bdur:3*60*1000, icon:'ü™ô', color:'#FFD0A8', w:0.06 },
      { key:'eco_1',       type:'ecoin', val:1,       icon:'üéüÔ∏è', color:'#FFD05C', w:0.03 }
    ];

    const TPL_PREMIUM = [
      { key:'coin_cur_1',  type:'coin', currentCoinMul:1.4, icon:'üí∞', color:'#00E5FF', w:0.26 },
      { key:'coin_cur_2',  type:'coin', currentCoinMul:2.8, icon:'üí∞', color:'#4DFFB5', w:0.20 },
      { key:'coin_x5_5',   type:'coin', coinMul:7.5,       icon:'üí∞', color:'#32C6FF', w:0.10 },
      { key:'all_x2_10m',  type:'buff', bkind:'all',  bmult:1.4, bdur:12*60*1000, icon:'üöÄ', color:'#8AE1FF', w:0.18 },
      { key:'res_x3_7m',   type:'buff', bkind:'res',  bmult:2.6, bdur:9*60*1000,  icon:'‚ö°', color:'#FFA8FF', w:0.12 },
      { key:'coinbuf_x3_5m', type:'buff', bkind:'coin', bmult:2.5, bdur:7*60*1000, icon:'ü™ô', color:'#FFD0A8', w:0.09 },
      { key:'eco_3',       type:'ecoin', val:5,       icon:'üéüÔ∏è', color:'#FF9E3D', w:0.05 }
    ];

    const TPL_ECOIN = [
      { key:'coin_cur_5',  type:'coin', currentCoinMul:7.0,  icon:'üí∞', color:'#00E5FF', w:0.26 },
      { key:'coin_cur_10', type:'coin', currentCoinMul:14.0, icon:'üí∞', color:'#4DFFB5', w:0.20 },
      { key:'coin_cur_20', type:'coin', currentCoinMul:28.0, icon:'üí∞', color:'#32C6FF', w:0.12 },
      { key:'all_x3_15m',  type:'buff', bkind:'all',  bmult:2.5, bdur:18*60*1000, icon:'üöÄ', color:'#8AE1FF', w:0.16 },
      { key:'res_x5_12m',  type:'buff', bkind:'res',  bmult:4.5,  bdur:15*60*1000, icon:'‚ö°', color:'#FFA8FF', w:0.11 },
      { key:'eco_8',       type:'ecoin', val:12,      icon:'üéüÔ∏è', color:'#FFBE5C', w:0.07 },
      { key:'eco_12',      type:'ecoin', val:18,      icon:'üéüÔ∏è', color:'#FF9E3D', w:0.05 },
      { key:'eco_20',      type:'ecoin', val:28,      icon:'üéüÔ∏è', color:'#FF7AE1', w:0.03 }
    ];

    function materializeItems(tpl, mode){
      const base = calcBaseCoin();
      return tpl.map(it=>{
        if (it.type === 'coin' && typeof it.currentCoinMul === 'number') {
          const curCoins = state.coins || 0;
          const amt = Math.max(1, Math.round(curCoins * it.currentCoinMul));
          return {
            ...it,
            awardCoin: amt,
            label: `ÌòÑÏû¨ÏΩîÏù∏ √ó${it.currentCoinMul} (= ${formatKR(amt)})`,
            onWin:()=>{
              const finalAmt = amt * (perkState.coinMult || 1);
              registerAuditIntent('coin', finalAmt, ROULETTE_AUDIT_WINDOW_MS);
              state.coins += finalAmt;
              auditGain('coin', finalAmt);
            }
          };
        }
        if (it.type==='coin' && typeof it.coinMul === 'number') {
          const amt = Math.max(1, Math.round(base * it.coinMul));
          return {
            ...it,
            awardCoin: amt,
            label:`ÏΩîÏù∏ ${formatKR(amt)}`,
            onWin:()=>{
              const finalAmt = amt * (perkState.coinMult || 1);
              registerAuditIntent('coin', finalAmt, ROULETTE_AUDIT_WINDOW_MS);
              state.coins += finalAmt;
              auditGain('coin', finalAmt);
            }
          };
        }
        if (it.type==='ecoin'){
          return {
            ...it,
            awardEcoin: it.val,
            label:`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ √ó${it.val}`,
            onWin:()=>{
              registerAuditIntent('eco', it.val, ROULETTE_AUDIT_WINDOW_MS);
              const gained = addEventCoins(it.val, 'slot');
              auditGain('eco', gained);
            }
          };
        }
        if (it.type==='buff'){
          const multText = `x${1+it.bmult}`;
          const minText  = `${Math.round(it.bdur/60000)}m`;
          let title = it.bkind==='all' ? `Î™®Îì† ÏÉùÏÇ∞ ${multText}`
                   : it.bkind==='coin' ? `ÏΩîÏù∏ ÏÉùÏÇ∞ ${multText}`
                   :                    `ÏûêÏõê ÏÉùÏÇ∞ ${multText}`;
          return { ...it, label:`${title} / ${minText}`, onWin:()=>{ addTempBuff(it.bkind, it.bmult, it.bdur); } };
        }
        return it;
      });
    }
    function getItemsForMode(mode){
      const tpl = mode==='daily'   ? TPL_DAILY
               : mode==='premium' ? TPL_PREMIUM
               : mode==='ecoin'   ? TPL_ECOIN
               : TPL_PREMIUM;
      return materializeItems(tpl, mode);
    }

    function playSfx(id){
      if (isOffline() || isBackgrounded()) return;
      const el=document.getElementById(id);
      if (el && el.play){ el.currentTime=0; el.play().catch(()=>{}); return; }
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='triangle';
        o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;
        g.gain.setValueAtTime(.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);
        o.start(); o.stop(ctx.currentTime+.08);
      }catch{}
    }
    function startTickLoop(intv=120){ stopTickLoop(); startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv); }
    function stopTickLoop(){ if(startTickLoop._id){ clearInterval(startTickLoop._id); startTickLoop._id=null; } }

    const slotWrap = document.getElementById('slot-wrap');
    const reel = document.getElementById('slot-reel');
    function buildSlot(items){
      const rows = items.map(it=>`<div class="slot-item"><span class="slot-icon">${it.icon||'üéÅ'}</span>${it.label||it.key}</div>`).join('');
      reel.innerHTML = rows.repeat(8);
      reel.style.transform = 'translateY(0px)';
      reel.style.transition = 'none';
    }

    let isSpinning = false;
    let lastRouletteAwardAt = 0;

    function spinSlot(items, picked){
      const rowH=56;
      const idx = Math.max(0, items.findIndex(it=>it.key===picked.key));
      const stopRow = (items.length*6) + (idx<0?0:idx);
      const targetY = - stopRow * rowH;
      startTickLoop(90);
      playSfx('sfx-start');
      return new Promise(resolve=>{
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';
            reel.style.transform = `translateY(${targetY}px)`;
          });
        });
        reel.ontransitionend = ()=>{ reel.ontransitionend=null; stopTickLoop(); playSfx('sfx-win'); resolve(); };
      });
    }

    const dailyOverlay = document.getElementById('daily-overlay');
    const dailyInfo    = document.getElementById('daily-info');
    const dailyCloseBtn= document.getElementById('daily-close');
    const probPanel    = document.getElementById('prob-panel');
    const probToggle   = document.getElementById('prob-toggle');
    const rewardList   = document.getElementById('reward-list');
    const tabs = Array.from(document.querySelectorAll('.tbtn'));
    const spinDailyBtn   = document.getElementById('spin-daily');
    const spinPremiumBtn = document.getElementById('spin-premium');
    const spinEcoinBtn   = document.getElementById('spin-ecoin');
    const questOverlay   = document.getElementById('quest-overlay');
    const questCard      = document.getElementById('quest-card');
    const questHead      = document.getElementById('quest-head');
    const questCloseBtn  = document.getElementById('quest-close');
    const questTabs      = Array.from(document.querySelectorAll('.qtab'));
    const questPanels    = {
      daily: document.querySelector('.quest-panel[data-panel="daily"]'),
      weekly: document.querySelector('.quest-panel[data-panel="weekly"]')
    };
    const questDailyList   = document.getElementById('quest-daily-list');
    const questWeeklyList  = document.getElementById('quest-weekly-list');
    const questDailySummary= document.getElementById('quest-daily-summary');
    const questWeeklySummary= document.getElementById('quest-weekly-summary');
    const questBadge       = document.getElementById('quest-badge');
    const questSideStatus  = document.getElementById('quest-status-side');
    const questBody        = document.querySelector('.quest-body');
    const slotAccessInfo   = document.getElementById('slot-access-info');

    let dailyCache = null;
    let currentMode = 'daily';
    let activeItems = [];

    /* ====== üîí Ïù¥Î≤§Ìä∏ Ïû†Í∏à(Ï∫îÏä¨) Ïú†Ìã∏ ====== */
    let eventLockUntil = 0;
    function isEventLocked(){ return Date.now() < eventLockUntil; }
    function cancelEvents(reason='Ïù¥Î≤§Ìä∏ ÏùºÏãú Ï§ëÏßÄ'){
      eventLockUntil = Date.now() + 5*60*1000; // 5Î∂Ñ Ïû†Í∏à
      try { showToast(`üéüÔ∏è ${reason} (5Î∂Ñ)`, null, null, 5000); } catch {}
      try {
        const info = document.getElementById('daily-info');
        if (info) info.innerHTML = '‚ö†Ô∏è ÏïàÏ†Ñ Ï†êÍ≤ÄÏúºÎ°ú Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
      } catch {}
      updateSpinButtons();
    }

    function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }
    function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }
    dailyCloseBtn.onclick = closeDailyOverlay;
    probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

    function setMode(mode){
      currentMode = mode;
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
      activeItems = getItemsForMode(mode);
      slotWrap.style.display     = 'flex';
      document.getElementById('spin-daily').style.display   = (mode==='daily')? 'inline-block':'none';
      document.getElementById('spin-premium').style.display = (mode==='premium')? 'inline-block':'none';
      document.getElementById('spin-ecoin').style.display   = (mode==='ecoin')? 'inline-block':'none';
      buildSlot(activeItems);
      buildProbPanel(activeItems, mode);
      buildRewardList(activeItems);
      updateSpinButtons();
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

    function setQuestTab(tab){
      questTabs.forEach(b=>b.classList.toggle('active', b.dataset.qtab===tab));
      Object.entries(questPanels).forEach(([key, panel]) => {
        if (!panel) return;
        panel.classList.toggle('active', key === tab);
      });
    }
    questTabs.forEach(b=>b.addEventListener('click', ()=>setQuestTab(b.dataset.qtab)));

    function buildQuestList(kind, container){
      if (!container) return;
      const tasks = questTasks(kind);
      const prog  = questProgress(kind);
      const rows = tasks.map(task => {
        const cur = Math.min(task.target, prog[task.id] || 0);
        const pct = Math.min(100, (cur / task.target) * 100);
        const done = cur >= task.target;
        const curText = (task.unit === 'coin' || task.unit === 'res') ? formatKR(Math.floor(cur)) : Math.floor(cur);
        const targetText = (task.unit === 'coin' || task.unit === 'res') ? formatKR(task.target) : task.target;
        return `<div class="quest-item ${done?'done':''}">
          <div class="quest-title">${done ? '‚úÖ' : '‚ñ´Ô∏è'} ${task.title}</div>
          <div class="quest-progress"><div class="quest-bar" style="width:${pct}%"></div></div>
          <div class="quest-numbers"><span>${curText} / ${targetText}</span><span>${pct.toFixed(0)}%</span></div>
        </div>`;
      }).join('');
      container.innerHTML = rows || '<div class="quest-item">ÌÄòÏä§Ìä∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>';
    }

    function questResetText(kind){
      const now = kstDate();
      const resetAt = kind === 'daily' ? nextResetKST(now) : nextWeeklyReset(now);
      const left = Math.max(0, resetAt - now);
      const label = kind === 'daily' ? 'Îã§Ïùå Ï¥àÍ∏∞ÌôîÍπåÏßÄ' : 'Îã§Ïùå Ï£ºÍ∞Ñ Ï¥àÍ∏∞ÌôîÍπåÏßÄ';
      return `${label} ${fmtLeft(left)}`;
    }

    function renderQuestSummaries(){
      if (questDailySummary){
        const ready = questRewardAvailable('daily');
        const done  = isQuestComplete('daily');
        const used  = !!state.quests?.daily?.premiumUsed;
        const msg = ready ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø 1Ìöå ÏÇ¨Ïö© Í∞ÄÎä•!'
          : done && used ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°ØÏùÑ Ïò§Îäò Ïù¥ÎØ∏ ÏÇ¨Ïö©ÌñàÏñ¥Ïöî.'
          : 'Î™®Îì† Í≥ºÏ†úÎ•º ÏôÑÎ£åÌï¥ ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°ØÏùÑ Ïó¥Ïñ¥Î≥¥ÏÑ∏Ïöî.';
        questDailySummary.innerHTML = `${msg}<br>${questResetText('daily')}`;
      }
      if (questWeeklySummary){
        const ready = questRewardAvailable('weekly');
        const done  = isQuestComplete('weekly');
        const used  = !!state.quests?.weekly?.ecoinUsed;
        const msg = ready ? 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø 1Ìöå ÏÇ¨Ïö© Í∞ÄÎä•!'
          : done && used ? 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°ØÏùÑ Ïù¥Î≤à Ï£º Ïù¥ÎØ∏ ÏÇ¨Ïö©ÌñàÏñ¥Ïöî.'
          : 'Î™®Îì† Í≥ºÏ†úÎ•º ÏôÑÎ£åÌï¥ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°ØÏùÑ Ïó¥Ïñ¥Î≥¥ÏÑ∏Ïöî.';
        questWeeklySummary.innerHTML = `${msg}<br>${questResetText('weekly')}`;
      }
    }

    function renderQuestBadges(){
      const dailyReady = questRewardAvailable('daily');
      const weeklyReady = questRewardAvailable('weekly');
      if (questBadge){
        const visible = dailyReady || weeklyReady;
        questBadge.classList.toggle('hidden', !visible);
        questBadge.textContent = visible ? '!' : '¬∑';
      }
      if (questSideStatus){
        const label = dailyReady && weeklyReady ? 'Îëê Ïä¨Î°Ø Ï§ÄÎπÑ'
          : dailyReady ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ï§ÄÎπÑ'
          : weeklyReady ? 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ï§ÄÎπÑ'
          : 'ÏßÑÌñâ Ï§ë';
        questSideStatus.textContent = label;
      }
    }

    function renderSlotAccess(){
      if (!slotAccessInfo) return;
      const dailyReady = questRewardAvailable('daily');
      const weeklyReady = questRewardAvailable('weekly');
      const dailyDone = isQuestComplete('daily');
      const weeklyDone = isQuestComplete('weekly');
      const dailyUsed = !!state.quests?.daily?.premiumUsed;
      const weeklyUsed = !!state.quests?.weekly?.ecoinUsed;
      const dailyText = dailyReady ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø ÏÇ¨Ïö© Í∞ÄÎä• (ÏùºÏùº ÌÄòÏä§Ìä∏ ÏôÑÎ£å)'
        : dailyDone && dailyUsed ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø Ïò§Îäò ÏÇ¨Ïö© ÏôÑÎ£å'
        : 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø: ÏùºÏùº ÌÄòÏä§Ìä∏ ÏôÑÎ£å ÌïÑÏöî';
      const weeklyText = weeklyReady ? 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø ÏÇ¨Ïö© Í∞ÄÎä• (Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ ÏôÑÎ£å)'
        : weeklyDone && weeklyUsed ? 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø Ïù¥Î≤à Ï£º ÏÇ¨Ïö© ÏôÑÎ£å'
        : 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø: Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ ÏôÑÎ£å ÌïÑÏöî';
      slotAccessInfo.innerHTML = `${dailyText}<br>${weeklyText}`;
    }

    function renderQuestUI(){
      syncQuestPeriods();
      buildQuestList('daily', questDailyList);
      buildQuestList('weekly', questWeeklyList);
      renderQuestSummaries();
      renderQuestBadges();
      renderSlotAccess();
    }

    function openQuestOverlay(){
      renderQuestUI();
      setQuestTab('daily');
      if (questBody){ questBody.scrollTo({ top: 0, behavior: 'auto' }); }
      if (!questOverlay) return;
      questOverlay.classList.add('show');
      questOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeQuestOverlay(){
      if (!questOverlay) return;
      if (questCard){ questCard.style.transform=''; questCard.style.transition=''; }
      questOverlay.classList.remove('show');
      questOverlay.setAttribute('aria-hidden', 'true');
    }
    questCloseBtn?.addEventListener('click', closeQuestOverlay);
    questOverlay?.addEventListener('click', (e) => { if (e.target === questOverlay) closeQuestOverlay(); });
    window.openQuestOverlay = openQuestOverlay;

    function enableQuestDragClose(){
      if (!questCard || !questHead) return;
      let startY = 0;
      let currentY = 0;
      let dragging = false;

      const resetPosition = () => {
        questCard.style.transition = 'transform .22s ease';
        questCard.style.transform = 'translateY(0)';
        setTimeout(() => { questCard.style.transition = ''; }, 240);
      };

      const onPointerDown = (ev) => {
        const y = ev.clientY ?? ev.touches?.[0]?.clientY;
        if (y === undefined) return;
        dragging = true;
        startY = y;
        currentY = y;
        questCard.style.transition = 'none';
      };

      const onPointerMove = (ev) => {
        if (!dragging) return;
        const y = ev.clientY ?? ev.touches?.[0]?.clientY;
        if (y === undefined) return;
        currentY = y;
        const delta = Math.max(0, currentY - startY);
        questCard.style.transform = `translateY(${Math.min(delta, 160)}px)`;
      };

      const onPointerUp = () => {
        if (!dragging) return;
        const delta = Math.max(0, currentY - startY);
        dragging = false;
        if (delta > 120) {
          questCard.style.transition = 'transform .18s ease';
          questCard.style.transform = 'translateY(160px)';
          setTimeout(() => closeQuestOverlay(), 140);
          return;
        }
        resetPosition();
      };

      ['pointerdown','touchstart'].forEach(evt => questHead.addEventListener(evt, onPointerDown, { passive: true }));
      ['pointermove','touchmove'].forEach(evt => questOverlay?.addEventListener(evt, onPointerMove, { passive: true }));
      ['pointerup','pointercancel','touchend','touchcancel'].forEach(evt => questOverlay?.addEventListener(evt, onPointerUp, { passive: true }));
    }
    enableQuestDragClose();

    function buildProbPanel(items, mode){
      const total=items.reduce((a,b)=>a+b.w,0)||1;
      const rows=items.map(it=>`<tr><td>${it.icon||''} ${it.label||it.key}</td><td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td></tr>`).join('');
      const header = mode==='daily' ? 'Ï∂úÏÑù Ïä¨Î°Ø ÌôïÎ•†'
                  : mode==='premium' ? 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°Ø ÌôïÎ•†(ÏùºÏùº ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅ)'
                  : 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø ÌôïÎ•†(Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅ)';
      probPanel.innerHTML = `<div style="margin-bottom:6px; color:#9fdcff;">${header}</div><table>${rows}</table>`;
    }
    function buildRewardList(items){
      rewardList.innerHTML = 'üé∞ Î≥¥ÏÉÅ Î™©Î°ù: ' + items.map(it=>`${it.icon||''} ${it.label||it.key}`).join(' ¬∑ ');
    }
    function canClaimToday(){
      const today = kstDayKey();
      return dailyCache?.lastKey !== today;
    }
    function refreshDailyInfo(canClaim){
      const today = kstDayKey();
      const streak = dailyCache?.streak || 0;
      const resetLeft = Math.max(0, nextResetKST()-kstDate());
      const leftText = canClaim ? 'ÏßÄÍ∏à Í∞ÄÎä•' : `Îã§Ïùå Ï∂úÏÑùÍπåÏßÄ ${fmtLeft(resetLeft)}`;

      if (!dailyUnlocked){
        const need = Math.max(0, 100 - (state.coins||0));
        dailyInfo.innerHTML = `üîí Ï∂úÏÑù Î≥¥ÏÉÅÏùÄ <b>100ÏΩîÏù∏</b> Î™®ÏúºÎ©¥ Ìï¥Ï†ú!<br>ÎÇ®ÏùÄ ÏΩîÏù∏: <b>${formatKR(need)}</b>`;
        spinDailyBtn.disabled = true;
        return;
      }
      dailyInfo.innerHTML = canClaim
        ? `Ïò§Îäò(${today}) Ï∂úÏÑù Ïä¨Î°Ø Í∞ÄÎä•! <b>${leftText}</b><br>Ïó∞ÏÜç ${streak}Ïùº`
        : `Ïò§Îäò(${today})ÏùÄ Ïù¥ÎØ∏ ÏôÑÎ£å. <b>${leftText}</b><br>ÌòÑÏû¨ Ïó∞ÏÜç ${streak}Ïùº`;
      spinDailyBtn.disabled = !canClaim;
    }

    async function applyPrizeTransaction(delta){
      await runTransaction(dataRef, current => {
        const cur = current || { ...defaultData };
        const next = { ...cur };
        next.coins      = (next.coins||0) + (delta.coins||0);
        next.resources  = (next.resources||0) + (delta.resources||0);
        next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);
        next._lastUpdated = Date.now();
        return next;
      });
    }
    function makeDeltaSnapshot(){
      return { coins: state.coins||0, resources: state.resources||0, eventCoins: state.eventCoins||0 };
    }
    function deltaFrom(before){
      return {
        coins: (state.coins||0) - before.coins,
        resources: (state.resources||0) - before.resources,
        eventCoins: (state.eventCoins||0) - before.eventCoins
      };
    }
    function pickWeighted(items){ const s=items.reduce((a,b)=>a+b.w,0); let r=Math.random()*s; for(const it of items){ if((r-=it.w)<=0) return it; } return items.at(-1); }
    function canSpendEC(n){ return (state.eventCoins||0) >= n; }

    /* üîÅ Î≤ÑÌäº ÏÉÅÌÉú(Ïû†Í∏à Ìè¨Ìï®) */
    function updateSpinButtons(){
      const locked = isEventLocked();
      const canDaily   = dailyUnlocked && canClaimToday() && !isSpinning;
      const canPremium = questRewardAvailable('daily')  && !isSpinning;
      const canEcoin   = questRewardAvailable('weekly') && !isSpinning;

      spinDailyBtn.disabled   = locked || !canDaily;
      spinPremiumBtn.disabled = locked || !canPremium;
      spinEcoinBtn.disabled   = locked || !canEcoin;

      if (locked && dailyInfo){
        dailyInfo.innerHTML = '‚ö†Ô∏è ÏïàÏ†Ñ Ï†êÍ≤ÄÏúºÎ°ú Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
      }

      renderSlotAccess();
    }

    async function tryUnlockDaily(){
      if (!uid || dailyUnlocked) return;
      if ((state.coins || 0) >= 100){
        dailyUnlocked = true;
        try {
          await update(ref(db), { [`${userBasePath}/daily/unlocked`]: true });
        } catch(e){ console.warn('unlock save error', e); }
        showToast('üîì Ï∂úÏÑù Î≥¥ÏÉÅ Ïû†Í∏à Ìï¥Ï†ú!', 'ÏßÄÍ∏à Ïó¥Í∏∞', () => {
          setMode('daily'); openDailyOverlay();
        });
        refreshDailyInfo(canClaimToday());
        updateAttendanceLabels();
        updateSpinButtons();
      }
    }

    async function handleSpin(mode){
      if (!uid || !window.__PLAY_ALLOWED || isSpinning) return;
      if (!security.tosAccepted){ showTosOverlay(true); return; }
      if (security.banned){ return; }

      if (isEventLocked()){
        dailyInfo.innerHTML = 'Ïù¥Î≤§Ìä∏Í∞Ä ÏùºÏãú Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
        updateSpinButtons();
        return;
      }

      if (mode==='daily' && !dailyUnlocked) { refreshDailyInfo(false); return; }
      if (mode==='premium' && !questRewardAvailable('daily')) {
        dailyInfo.innerHTML='ÌîÑÎ¶¨ÎØ∏ÏóÑ Ïä¨Î°ØÏùÄ ÏùºÏùº ÌÄòÏä§Ìä∏ ÏôÑÎ£å ÌõÑ ÌïòÎ£® 1ÌöåÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
        renderSlotAccess();
        return;
      }
      if (mode==='ecoin'   && !questRewardAvailable('weekly')){
        dailyInfo.innerHTML='Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°ØÏùÄ Ï£ºÍ∞Ñ ÌÄòÏä§Ìä∏ ÏôÑÎ£å ÌõÑ Ï£º 1ÌöåÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
        renderSlotAccess();
        return;
      }

      setMode(mode);
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();

      isSpinning = true; updateSpinButtons();
      await spinSlot(activeItems, picked);
      picked.onWin();
      lastRouletteAwardAt = Date.now();

      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta); updateUI();
        if (mode==='daily'){
          const today = kstDayKey(); const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));
          let streak = Number(dailyCache?.streak||0);
          if (dailyCache?.lastKey === yesterday) streak+=1; else streak=1;
          await update(ref(db), {
            [`${userBasePath}/daily`]: { ...(dailyCache||{}), unlocked: true, lastKey: today, streak, lastClaimAt: Date.now(), lastPrize: picked.key }
          });
          dailyCache = { ...(dailyCache||{}), lastKey: today, streak, unlocked:true };
          dailyInfo.innerHTML = `üéâ ÎãπÏ≤®: <b>${picked.label}</b><br>Ïó∞ÏÜç ${streak}Ïùº`;
        } else {
          if (mode==='premium'){
            state.quests.daily.premiumUsed = true;
            dailyInfo.innerHTML = `üéâ ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎãπÏ≤®: <b>${picked.label}</b><br>ÏùºÏùº ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅ ÏÇ¨Ïö© ÏôÑÎ£å`;
          } else {
            state.quests.weekly.ecoinUsed = true;
            dailyInfo.innerHTML = `üéâ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ïä¨Î°Ø ÎãπÏ≤®: <b>${picked.label}</b><br>Ï£ºÍ∞Ñ Î≥¥ÏÉÅ ÏÇ¨Ïö© ÏôÑÎ£å`;
          }
          renderQuestUI();
          save();
        }
      }catch(e){
        console.error(e);
        dailyInfo.textContent='Î≥¥ÏÉÅ ÏßÄÍ∏â Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      }finally{
        isSpinning = false; updateSpinButtons();
      }
    }

    document.getElementById('spin-daily').onclick   = ()=>handleSpin('daily');
    document.getElementById('spin-premium').onclick = ()=>handleSpin('premium');
    document.getElementById('spin-ecoin').onclick   = ()=>handleSpin('ecoin');

    async function fetchDaily(){
      if (!uid) return;
      try{
        const snap = await get(ref(db, `${userBasePath}/daily`));
        const v = snap.exists() ? snap.val() : { lastKey:null, streak:0, unlocked:false };
        dailyCache = v;
        dailyUnlocked = v?.unlocked ? true : false;
      }catch{
        dailyCache = { lastKey:null, streak:0, unlocked:false }; dailyUnlocked = false;
      }
    }
    async function checkDailyAndMaybeShow(){
      await fetchDaily();
      refreshDailyInfo(canClaimToday());
      setMode('daily');
      if (dailyUnlocked && canClaimToday()) openDailyOverlay();
    }

    const attMenuRight = document.getElementById('attendance-left');
    const attSideRight = document.getElementById('attendance-left-side');
    function updateAttendanceLabels(){
      if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }
      if (!dailyUnlocked){ attMenuRight.textContent='Ïû†Í∏à'; attSideRight.textContent='Ïû†Í∏à'; return; }
      const today = kstDayKey();
      const can = (dailyCache?.lastKey !== today);
      if (can){ attMenuRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•'; attSideRight.textContent='ÏßÄÍ∏à Í∞ÄÎä•'; }
      else{
        const left = Math.max(0, nextResetKST()-kstDate());
        const txt = fmtLeft(left);
        attMenuRight.textContent=txt; attSideRight.textContent=txt;
      }
    }
    setInterval(updateAttendanceLabels, 1000);

    let lastShipImageLevel = null;
    function setShipImage(level) {
      const img = document.getElementById('ship-img');
      if (!img) return;
      const normalized = Math.max(1, level);
      if (lastShipImageLevel === normalized) return;
      let attempted = normalized;
      img.onerror = function onErr() {
        if (attempted > 1) {
          attempted -= 1;
          img.src = `/images/ship-level${attempted}.png`;
        } else {
          img.onerror = null;
          img.src = `/images/ship-level1.png`;
        }
      };
      img.src = `/images/ship-level${attempted}.png`;
      lastShipImageLevel = normalized;
    }

    const authContainer = document.getElementById('auth-container');
    const authErrorEl   = document.getElementById('auth-error');
    const bootOverlay   = document.getElementById('boot-overlay');

    // ‚òÖ Î∂ÄÌåÖ Ïò§Î≤ÑÎ†àÏù¥Îäî 'Ï≤òÏùå 1Ìöå'Îßå
    function setBootVisible(v){
      if (!bootOverlay) return;
      const seen = localStorage.getItem('boot_seen') === '1';
      if (seen) {
        bootOverlay.style.display = 'none';
        bootOverlay.setAttribute('aria-hidden','true');
        return;
      }
      bootOverlay.style.display = v ? 'flex' : 'none';
      bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');
    }

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg || '';
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';
    }

    function refreshGuestButton() {
      if (!guestStartBtn) return;
      guestStartBtn.textContent = hasGuestProfile() ? 'Í≤åÏä§Ìä∏Î°ú Í≥ÑÏÜçÌïòÍ∏∞' : 'Í≤åÏä§Ìä∏Î°ú ÏãúÏûëÌïòÍ∏∞';
    }

    function updateGuestUiState() {
      if (guestLoginBtn) {
        guestLoginBtn.style.display = guestMode ? 'inline-flex' : 'none';
      }
    }

    function showGameUI() {
      try {
        authContainer.classList.add('hidden');
        try { history.replaceState(null, '', '/Í≤åÏûÑ' + (location.hash || '')); } catch {}
        setTimeout(() => {
          authContainer.style.display = 'none';
          ['top-bar','container'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.visibility = 'visible';
          });
        }, 300);
      } catch (e) { console.error('showGameUI error', e); }
    }

    function startGuestMode() {
      try {
        hideAllOverlays();
        guestMode = true;
        guestTransferPreference = 'none';
        guestAutoStartSuppressed = false;
        loadGuestProfileIntoState();
        security.tosAccepted = true;
        security.banned = false;
        securityDirty = false;
        ensureFx();
        loadBuffs();
        renderBuffStatus();
        renderSecurityBadge();
        setBootVisible(false);
        bootDone = true;
        showAuthStatus('');
        showGameUI();
        updateUI();
        auditInit();
        renderPlanets();
        updateMailBadges();
        refreshGuestButton();
        updateGuestUiState();
        persistGuestProfile();
      } catch (err) {
        console.error('guest start failed', err);
      }
    }

    /* ===========================
       ‚ö†Ô∏è Î≥¥Ïïà/ÏïΩÍ¥Ä/ÏùòÏã¨ÎèÑ (Í∞ïÌôîÌåê)
       =========================== */
    let security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
    let securityDirty = false;

    const TOS_ACCEPT_PREFIX = 'siu_tos_ok_';
    function markLocalTosAccepted(id) {
      if (!id) return;
      try { localStorage.setItem(`${TOS_ACCEPT_PREFIX}${id}`, '1'); } catch {}
    }
    function hasLocalTosAccepted(id) {
      if (!id) return false;
      try { return localStorage.getItem(`${TOS_ACCEPT_PREFIX}${id}`) === '1'; }
      catch { return false; }
    }

    // ÏûÑÍ≥ÑÍ∞í
    const SEC_WARN_LEVEL = 20;
    const SEC_BAN_LEVEL  = 30;

    const EPS               = 1e-6;
    const UNKNOWN_THRESH    = 0.05;
    const HUMAN_MAX_CPS     = 12;
    const MAX_TICK_GAP_MS   = 5000;
    const RES_WEIGHT        = 0.8;
    const COIN_WEIGHT       = 1.0;
    const ECO_WEIGHT        = 1.2;

    const BAN_SPIKE_COINS = 1_000_000_000;
    const BAN_SPIKE_RES   = 100_000_000;
    const BAN_SPIKE_ECO   = 50_000;

    function renderSecurityBadge(){
      const el = document.getElementById('suspicion-badge');
      if (!el) return;
      el.classList.remove('warn','ban');
      el.textContent = `ÏùòÏã¨ÎèÑ: ${Math.round(security.suspicion)}`;
      if (security.suspicion >= SEC_BAN_LEVEL){ el.classList.add('ban'); }
      else if (security.suspicion > SEC_WARN_LEVEL){ el.classList.add('warn'); }
    }
    function showTosOverlay(show=true){
      const ov = document.getElementById('tos-overlay');
      if (ov){ ov.classList.toggle('show', !!show); ov.setAttribute('aria-hidden', show?'false':'true'); }
    }
    function markTosViolationFlag(){
      const vio = security.suspicion > SEC_WARN_LEVEL || security.banned;
      if (security.tosViolated !== vio){ security.tosViolated = vio; securityDirty = true; }
    }
    async function loadSecurity(){
      try {
        const snap = await get(ref(db, `${userBasePath}/security`));
        if (snap.exists()){
          const v = snap.val() || {};
          security = { ...security, ...v };
        }
      } catch {}
      if (uid) {
        if (security.tosAccepted) {
          markLocalTosAccepted(uid);
        } else if (hasLocalTosAccepted(uid)) {
          security.tosAccepted = true;
          securityDirty = true;
        }
      }
      markTosViolationFlag();
      await saveSecurity();
    }
    async function saveSecurity(){
      if (!uid || !userBasePath) return;
      if (!securityDirty) return;
      try {
        await update(ref(db), { [`${userBasePath}/security`]: {
          suspicion: security.suspicion,
          banned: security.banned,
          tosAccepted: security.tosAccepted,
          tosViolated: security.tosViolated,
          fairSeconds: security.fairSeconds,
          lastWarnAt: security.lastWarnAt
        }});
      } catch {}
      securityDirty = false;
    }

    const SUPPORT_CTX_KEY = 'siu_support_ctx';
    function saveSupportCtx(extra = {}) {
      const ctx = {
        server: userServerKey || null,
        idKey: userIdKey || null,
        basePath: userBasePath || null,
        uid: uid || null,
        suspicion: (security && typeof security.suspicion === 'number') ? security.suspicion : null,
        banned: !!(security && security.banned),
        ts: Date.now(),
        ...extra
      };
      try { localStorage.setItem(SUPPORT_CTX_KEY, JSON.stringify(ctx)); } catch {}
      return ctx;
    }
    function readSupportCtx() {
      try {
        const raw = localStorage.getItem(SUPPORT_CTX_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function clearSupportCtx(){
      try { localStorage.removeItem(SUPPORT_CTX_KEY); } catch {}
    }
    function hideAllOverlays(){
      try{ showTosOverlay(false); }catch{}
      try{ showMigrateOverlay(false); }catch{}
      try{ closeMailOverlay(); }catch{}
      try{ closeShopOverlay(); }catch{}
      try{
        const ov = document.getElementById('daily-overlay');
        if (ov){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const pov = document.getElementById('policy-overlay');
        if (pov){ pov.classList.remove('show'); pov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const bov = document.getElementById('buff-overlay');
        if (bov){ bov.classList.remove('show'); bov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const qov = document.getElementById('quest-overlay');
        if (qov){ qov.classList.remove('show'); qov.setAttribute('aria-hidden','true'); }
      }catch{}
    }

    // === Ìï©Î≤ï Ï¶ùÍ∞ê Ïû•Î∂Ä ===
    let audit = {
      last: null,
      recGain:  { res:0, coin:0, eco:0 },
      recSpend: { res:0, coin:0, eco:0 },
      lastAt: 0
    };
    function auditInit(){
      audit.last   = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.lastAt = Date.now();
    }
    function trackCoinQuestProgress(amount, source = 'generic'){
      const delta = Math.max(0, Number(amount) || 0);
      if (!delta) return;
      if (source === 'worker') { applyQuestProgress('coin_worker', delta); return; }
      if (source === 'manual') { applyQuestProgress('coin_manual', delta); return; }
      applyQuestProgress('coin', delta);
    }
    function auditGain(kind, amount, source = 'generic'){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recGain[k]) audit.recGain[k] = 0;
      audit.recGain[k] += Number(amount||0);
      if (k === 'res') applyQuestProgress('res', amount);
      if (k === 'coin') trackCoinQuestProgress(amount, source);
    }
    function auditSpend(kind, amount){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recSpend[k]) audit.recSpend[k] = 0;
      audit.recSpend[k] += Number(amount||0);
    }
    function auditAdd(kind, amount, source = 'generic'){ auditGain(kind, amount, source); }
    function auditResetCycle(){
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.last     = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.lastAt   = Date.now();
    }

    // ÏùòÎèÑ ÌóàÏö© Ï∞Ω
    let auditIntent = { res:0, coin:0, eco:0, until:0 };
    function registerAuditIntent(kind, amount, windowMs=6000){
      const now = Date.now();
      if (auditIntent.until < now) auditIntent = { res:0, coin:0, eco:0, until: now + windowMs };
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      auditIntent[k] = (auditIntent[k] || 0) + Math.max(0, Number(amount||0));
      auditIntent.until = Math.max(auditIntent.until, now + windowMs);
    }

    // BAN ÏóîÎìúÌè¨Ïù∏Ìä∏
    let __BAN_ENDPOINT = null;
    async function __getBanEndpoint() {
      if (__BAN_ENDPOINT) return __BAN_ENDPOINT;
      try {
        const snap = await get(ref(db, 'meta/banEndpoint'));
        if (snap.exists()) __BAN_ENDPOINT = String(snap.val());
      } catch {}
      return __BAN_ENDPOINT;
    }
    async function requestAccountDisable(reason = 'auto-ban') {
      try {
        const url = await __getBanEndpoint();
        if (!url || !auth?.currentUser) return;
        const idToken = await auth.currentUser.getIdToken(true);
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            idToken,
            reason,
            suspicion: security?.suspicion ?? null
          })
        });
      } catch (e) { console.warn('ban endpoint failed', e); }
    }

    function expectedResGain(dtSec){
      const resBuff = activeBuffFactor('res');
      const workerGain = (state.workerCount * getWorkerPower()) * resBuff * dtSec;
      const clickGain  = (state.clickPower || 1) * HUMAN_MAX_CPS * resBuff * dtSec;
      return workerGain + clickGain + 0.5;
    }
    function expectedCoinGain(dtSec){
      const coinBuff = activeBuffFactor('coin');
      const convGain = (state.conversionCount || 0) * coinBuff * dtSec;
      return convGain + 2;
    }

    function adjustSuspicion(delta){
      const prev = security.suspicion;
      security.suspicion = Math.max(0, Math.min(1000, prev + delta));

      if (!security.banned && security.suspicion > SEC_WARN_LEVEL){
        const now = Date.now();
        if (!security.lastWarnAt || now - security.lastWarnAt > 60000){
          security.lastWarnAt = now;
          showToast('‚ö†Ô∏è ÏùòÏã¨ÎèÑÍ∞Ä 20ÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§. ÎπÑÏ†ïÏÉÅ Ï¶ùÍ∞ÄÍ∞Ä ÌÉêÏßÄÎêòÎ©¥ Ï†ïÏßÄÎê† Ïàò ÏûàÏñ¥Ïöî.');
          securityDirty = true;
        }
      }

      if (security.suspicion >= SEC_BAN_LEVEL && !security.banned){
        security.banned = true;
        securityDirty = true;
        requestAccountDisable('auto-ban:suspicion>=30').finally(async ()=>{
          return;
          showToast('‚õî ÏùòÏã¨ÎèÑ 30 Ïù¥ÏÉÅÏúºÎ°ú Í≥ÑÏ†ïÏù¥ Ï†ïÏßÄÎêòÏóàÏäµÎãàÎã§.');
          try { await saveSecurity(); } catch {}
          saveSupportCtx({ banned: true });
          try { await auth.signOut(); } catch {}
        });
      }

      markTosViolationFlag();
      securityDirty = true;
      renderSecurityBadge();
    }

    function auditCheck(){
      const nowGlobal = Date.now();

      // ‚úÖ ÏöîÏ≤≠ÏÇ¨Ìï≠: "Ï≤òÏùå 3Ï¥àÎßå Í≤ÄÏÇ¨ÌïòÏßÄ ÏïäÍ≤å"
      // ‚Üí Ï¥àÍ∏∞ Î∂ÄÌåÖ ÏãúÏûë ÏãúÍ∞Å(AUDIT_BOOT_TS)Î°úÎ∂ÄÌÑ∞ 3Ï¥àÍ∞Ä ÏßÄÎÇòÍ∏∞ Ï†ÑÏù¥Î©¥ Í≤ÄÏÇ¨ Ïä§ÌÇµ
      if (nowGlobal - AUDIT_BOOT_TS < AUDIT_INITIAL_SKIP_MS) {
        auditResetCycle();
        return;
      }

      if (!audit.last){ auditInit(); return; }
      const now = nowGlobal;
      let dtMs = now - (audit.lastAt || now);
      if (dtMs < 0) dtMs = 0;
      if (dtMs > MAX_TICK_GAP_MS) dtMs = MAX_TICK_GAP_MS;
      const dtSec = dtMs / 1000;

      const cur = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      let dr = cur.res   - audit.last.res;
      let dc = cur.coins - audit.last.coins;
      let de = cur.eco   - audit.last.eco;

      if (now <= (auditIntent.until||0)) {
        const useRes = Math.min(Math.max(0, dr), auditIntent.res||0);
        const useCoin= Math.min(Math.max(0, dc), auditIntent.coin||0);
        const useEco = Math.min(Math.max(0, de), auditIntent.eco||0);
        dr -= useRes; dc -= useCoin; de -= useEco;
        auditIntent.res  -= useRes;
        auditIntent.coin -= useCoin;
        auditIntent.eco  -= useEco;
      } else {
        auditIntent = { res:0, coin:0, eco:0, until:0 };
      }

      if (dc >= BAN_SPIKE_COINS || dr >= BAN_SPIKE_RES || de >= BAN_SPIKE_ECO) {
        adjustSuspicion(SEC_BAN_LEVEL + 1);
        auditResetCycle();
        return;
      }

      const legRes  = (audit.recGain.res  - audit.recSpend.res);
      const legCoin = (audit.recGain.coin - audit.recSpend.coin);
      const legEco  = (audit.recGain.eco  - audit.recSpend.eco);

      const physResRoom  = expectedResGain(dtSec);
      const physCoinRoom = expectedCoinGain(dtSec);

      const unknownRes  = Math.max(0, dr - legRes);
      const unknownCoin = Math.max(0, dc - legCoin);
      const unknownEco  = Math.max(0, de - legEco);

      const spikeRes  = Math.max(0, dr - (legRes  + physResRoom));
      const spikeCoin = Math.max(0, dc - (legCoin + physCoinRoom));

      if (unknownEco > EPS) {
        const rollback = Math.min(Math.floor(unknownEco), Math.floor(state.eventCoins || 0));
        if (rollback > 0) {
          state.eventCoins -= rollback;
          save(); updateUI();
        }
        cancelEvents('ÎπÑÏ†ïÏÉÅ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Ï¶ùÍ∞Ä Í∞êÏßÄ');
      }

      const mag = Math.log10(1
        + unknownRes
        + (unknownCoin * 10)
        + (unknownEco  * 20)
        + spikeRes
        + (spikeCoin * 10)
      );

      const ratioRes  = physResRoom  > 0 ? (dr - legRes) / physResRoom   : 0;
      const ratioCoin = physCoinRoom > 0 ? (dc - legCoin) / physCoinRoom : 0;
      const ratioBoost = Math.max(0, ratioRes - 1) + Math.max(0, ratioCoin - 1);

      const baseUnknown =
        (unknownRes  > EPS ? unknownRes  * RES_WEIGHT  : 0) +
        (unknownCoin > EPS ? unknownCoin * COIN_WEIGHT : 0) +
        (unknownEco  > EPS ? unknownEco  * ECO_WEIGHT  : 0);

      const baseSpike =
        (spikeRes  > EPS ? spikeRes  * 1.6 : 0) +
        (spikeCoin > EPS ? spikeCoin * 1.6 : 0);

      let score = (baseUnknown + baseSpike) * (1 + 0.6*mag + 0.8*ratioBoost);
      if (lastRouletteAwardAt && (now - lastRouletteAwardAt) < 12000) {
        const ecoSafe = unknownEco <= EPS;
        const spikeSafe = spikeRes <= EPS && spikeCoin <= EPS;
        score *= ecoSafe && spikeSafe ? 0.35 : 0.6;
      }

      if (score > UNKNOWN_THRESH){
        const add = Math.min(24, Math.max(2, Math.ceil(score)));
        adjustSuspicion(add);
        security.fairSeconds = 0;
        securityDirty = true;
      } else {
        security.fairSeconds = (security.fairSeconds||0) + dtSec;
        if (security.fairSeconds >= 90 && security.suspicion > 0){
          adjustSuspicion(-1);
          security.fairSeconds = 0;
        }
        securityDirty = true;
      }

      auditResetCycle();
    }

    function buildSupportInfoText(){
      const persisted = readSupportCtx();
      const server = userServerKey || persisted?.server || '(Ïïå Ïàò ÏóÜÏùå)';
      const idKey  = userIdKey     || persisted?.idKey  || '(Ïïå Ïàò ÏóÜÏùå)';
      const path   = userBasePath  || persisted?.basePath || '(Ïïå Ïàò ÏóÜÏùå)';
      const nowKST = kstDate().toLocaleString('ko-KR');
      const uidStr = uid || persisted?.uid || '(ÎØ∏Î°úÍ∑∏Ïù∏)';
      const sus    = (typeof security?.suspicion === 'number') ? security.suspicion
                : (typeof persisted?.suspicion === 'number') ? persisted.suspicion : null;
      return [
        `ÏÑúÎ≤Ñ: ${server}`,
        `ÏïÑÏù¥ÎîîÌÇ§: ${idKey}`,
        `Realtime DB Í≤ΩÎ°ú: ${path}`,
        `UID: ${uidStr}`,
        `ÌòÑÏû¨ ÏùòÏã¨ÎèÑ: ${sus === null ? '(Ïïå Ïàò ÏóÜÏùå)' : sus}`,
        `Î∞úÏÉù ÏãúÍ∞Å(KST): ${nowKST}`
      ].join('\n');
    }
    function buildSupportMail(){
      const persisted = readSupportCtx();
      const s = userServerKey || persisted?.server || 'server?';
      const i = userIdKey     || persisted?.idKey  || 'id?';
      const subject = `[Appeal] Ïò§ÌÉê Í≤ÄÌÜ† ÏöîÏ≤≠ - ${s} / ${i}`;
      const header  = 'ÏïàÎÖïÌïòÏÑ∏Ïöî, Ïò§ÌÉêÏúºÎ°ú ÏùòÏã¨ÎêòÏñ¥ Í≤ÄÌÜ†Î•º ÏöîÏ≤≠ÎìúÎ¶ΩÎãàÎã§.\n';
      const info    = buildSupportInfoText();
      const footer  = '\n\nÏÉÅÏÑ∏ ÏÉÅÌô©:\n(Ïó¨Í∏∞Ïóê ÏÉÅÌô©ÏùÑ ÏûêÏÑ∏Ìûà Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî)\n';
      const body    = `${header}\n${info}${footer}`;
      const mailto  = `mailto:${SUPPORT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { subject, body, mailto };
    }
    async function copySupportInfo(){
      try {
        await navigator.clipboard.writeText(buildSupportInfoText());
        showToast('Î≥µÏÇ¨ ÏôÑÎ£å! Î©îÏùºÏóê Î∂ôÏó¨ÎÑ£Ïñ¥ Î≥¥ÎÇº Ïàò ÏûàÏñ¥Ïöî.', null, null, 2500);
      } catch {
        showToast('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', null, null, 2500);
      }
    }

    const scheduleUiFrame = typeof requestAnimationFrame === 'function'
      ? cb => requestAnimationFrame(cb)
      : cb => setTimeout(cb, 16);

    function renderChristmasUI() {
      const piecesEl = document.getElementById('santa-pieces');
      const coinsEl = document.getElementById('santa-coins');
      const eventInline = document.getElementById('event-coins-inline');
      if (piecesEl) piecesEl.innerText = formatKR(Math.floor(state.santaPieces || 0));
      if (coinsEl) coinsEl.innerText = formatKR(Math.floor(state.santaCoins || 0));
      if (eventInline) eventInline.innerText = formatKR(state.eventCoins || 0);

      const treeLv = Math.max(0, state.christmasTreeLevel || 0);
      const treeMax = christmasTreeRewards.length;
      const treeLevelEl = document.getElementById('tree-level');
      if (treeLevelEl) treeLevelEl.innerText = treeLv.toString();

      const nextReward = christmasTreeRewards[treeLv];
      const costEl = document.getElementById('tree-cost');
      if (costEl) costEl.innerText = nextReward ? `${nextReward.cost}` : 'MAX';

      const treeImg = document.getElementById('tree-image');
      if (treeImg) {
        const imgLv = Math.max(1, Math.min(treeMax, treeLv || 1));
        treeImg.src = `/images/tree${imgLv}.png`;
        treeImg.alt = `ÌÅ¨Î¶¨Ïä§ÎßàÏä§ Ìä∏Î¶¨ Î†àÎ≤® ${imgLv}`;
      }

      const unlockedBuffs = christmasTreeRewards.slice(0, treeLv).map((r, idx) => `<li>Lv.${idx + 1}: ${escapeHTML(r.reward)}</li>`);
      const rewardBox = document.getElementById('tree-rewards');
      if (rewardBox) {
        const upcoming = nextReward ? `<div style="margin-top:6px;">Îã§Ïùå Î≥¥ÏÉÅ: <strong>${escapeHTML(nextReward.reward)}</strong></div>` : '<div style="margin-top:6px;">Î™®Îì† Î≥¥ÏÉÅÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!</div>';
        rewardBox.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Ìï¥Ï†úÎêú Î≥¥ÏÉÅ</div>${unlockedBuffs.length ? `<ul style="margin:0 0 6px 18px; padding:0;">${unlockedBuffs.join('')}</ul>` : '<div>ÏïÑÏßÅ Ìï¥Ï†úÎêú Î≥¥ÏÉÅÏù¥ ÏóÜÏñ¥Ïöî.</div>'}${upcoming}`;
      }

      renderPermanentBuffs();
    }

    function renderUIContents() {
      pruneExpiredBuffs();
      syncQuestPeriods();
      document.getElementById('score').innerText  = `ÏûêÏõê: ${formatKR(state.resources)}`;
      document.getElementById('coins').innerText  = `ÏΩîÏù∏: ${formatKR(state.coins)}`;
      document.getElementById('ecoins').innerText = `Ïù¥Î≤§Ìä∏ÏΩîÏù∏: ${formatKR(state.eventCoins||0)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}Î†ô (${formatKR(state.shipUpgradeCost)}ÏΩîÏù∏)`;
      setShipImage(state.shipLevel);
      const successRate = getShipSuccessRate();
      const rateEl = document.getElementById('ship-success-rate');
      if (rateEl) rateEl.innerText = `${successRate}%`;
      const shipBtn = document.getElementById('upgrade-ship');
      const shipBtnEc = document.getElementById('upgrade-ship-ec');
      const shipBtnEcRisk = document.getElementById('upgrade-ship-ec-risk');
      const ecoOffer = getShipEventUpgradeOffer();
      if (shipBtn) {
        shipBtn.innerText = `Ïö∞Ï£ºÏÑ† ÏóÖÍ∑∏Î†àÏù¥Îìú (${formatKR(state.shipUpgradeCost)}ÏΩîÏù∏)`;
        shipBtn.disabled = shipEnhanceInProgress || state.coins < state.shipUpgradeCost;
      }
      if (shipBtnEc) {
        const ecoText = ecoOffer.guaranteed
          ? `ÌôïÏ†ï Í∞ïÌôî (${formatKR(ecoOffer.cost)} Ïù¥Î≤§Ìä∏ÏΩîÏù∏)`
          : 'ÌôïÏ†ï Í∞ïÌôî (ÌòÑÏû¨ ÌôïÏ†ï Í∞ïÌôî Î∂àÍ∞Ä)';
        shipBtnEc.innerText = ecoText;
        shipBtnEc.disabled = shipEnhanceInProgress || !ecoOffer.guaranteed || !canSpendEC(ecoOffer.cost);
      }
      if (shipBtnEcRisk) {
        shipBtnEcRisk.innerText = `ÌôïÎ•† ÎèÑÏ†Ñ (Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞ú, ÏÑ±Í≥µ ÌôïÎ•† ${successRate}%)`;
        shipBtnEcRisk.disabled = shipEnhanceInProgress || !canSpendEC(1);
      }
      const shipStatusEl = document.getElementById('ship-upgrade-status');
      if (shipStatusEl) {
        shipStatusEl.innerText = shipEnhanceMessage;
        shipStatusEl.dataset.tone = shipEnhanceTone;
      }

      const clickUp = document.getElementById('click-upgrade');
      const clickUpEc = document.getElementById('click-upgrade-ec');
      const clickCost = ensureClickUpgradeCost();
      clickUp.innerText = `ÌÅ¥Î¶≠ ÏóÖÍ∑∏Î†àÏù¥Îìú (${formatKR(clickCost)}ÏΩîÏù∏)`;
      clickUp.disabled  = (state.coins < clickCost) && !canSpendEC(1);
      if (clickUpEc) {
        clickUpEc.disabled = !canSpendEC(1);
      }
      document.getElementById('click-power').innerText = Math.round(state.clickPower).toString();

      const autoBtn = document.getElementById('auto-convert-buy');
      if (state.autoConvertBought) {
        const status = state.autoConvertEnabled ? 'ON' : 'OFF';
        autoBtn.innerHTML = `ÏûêÎèôÎ≥ÄÌôò ${status}`;
        autoBtn.setAttribute('aria-pressed', state.autoConvertEnabled ? 'true' : 'false');
      } else {
        autoBtn.innerHTML = `ÏûêÎèôÎ≥ÄÌôò Íµ¨Îß§<br>(${formatKR(100)}ÏΩîÏù∏)`;
        autoBtn.removeAttribute('aria-pressed');
      }
      autoBtn.disabled = !state.autoConvertBought && state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ÏïåÎ∞î Í≥†Ïö© (${formatKR(getWorkerCost())}ÏΩîÏù∏)`;
      hireWork.disabled = state.coins < getWorkerCost();
      const hireWorkEc = document.getElementById('hire-worker-ec');
      if (hireWorkEc) {
        hireWorkEc.disabled = !canSpendEC(1);
      }
      const resPerSec = state.workerCount * getWorkerPower() * activeBuffFactor('res') * aggregateTreeMultiplier('res') * aggregateTreeMultiplier('worker');
      document.getElementById('resource-per-sec').innerText = resPerSec.toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ÏΩîÏù∏ ÏïåÎ∞î (${formatKR(getConversionCost())}ÏΩîÏù∏)`;
      hireConv.disabled = state.coins < getConversionCost();
      const hireConvEc = document.getElementById('hire-conversion-ec');
      if (hireConvEc) {
        hireConvEc.disabled = !canSpendEC(1);
      }
      const coinPerSec = state.conversionCount * activeBuffFactor('coin') * aggregateTreeMultiplier('coin') * aggregateTreeMultiplier('worker');
      document.getElementById('coin-per-sec').innerText = coinPerSec.toFixed(1);

      renderChristmasUI();

      renderSecurityBadge();
      tryUnlockDaily();
      renderBuffStatus();
      renderQuestUI();
      updateSpinButtons();

      try {
        if (uid) {
      const cachePick = {
        resources: state.resources,
        coins: state.coins,
        eventCoins: state.eventCoins,
        clickPower: state.clickPower,
        clickUpgradeCost: state.clickUpgradeCost,
        shipLevel: state.shipLevel,
        shipUpgradeCost: state.shipUpgradeCost,
        workerCount: state.workerCount,
        conversionCount: state.conversionCount,
        autoConvertBought: state.autoConvertBought,
        autoConvertEnabled: state.autoConvertEnabled,
        ownedPlanets: state.ownedPlanets,
        discoveredPlanets: state.discoveredPlanets
      };
          localStorage.setItem(`gd_cache_${uid}`, JSON.stringify(cachePick));
        }
      } catch {}
    }

    let uiRenderScheduled = false;
    let uiRenderDirty = false;
    function updateUI(forceImmediate = false) {
      if (forceImmediate) {
        uiRenderDirty = false;
        uiRenderScheduled = false;
        renderUIContents();
        return;
      }
      uiRenderDirty = true;
      if (uiRenderScheduled) return;
      uiRenderScheduled = true;
      scheduleUiFrame(() => {
        uiRenderScheduled = false;
        if (!uiRenderDirty) return;
        uiRenderDirty = false;
        renderUIContents();
      });
    }

    const PLANET_EXPLORATION_SCHEDULE_MS = [
      30000,
      60000,
      120000,
      180000,
      300000,
      420000,
      600000,
      780000,
      900000,
      3600000,
      10800000
    ];

    function getPlanetExplorationDurationMsForIndex(index) {
      const scheduleIndex = Math.min(index, PLANET_EXPLORATION_SCHEDULE_MS.length - 1);
      return PLANET_EXPLORATION_SCHEDULE_MS[scheduleIndex];
    }

    function getCompletedExplorationCount() {
      const owned = state.ownedPlanets?.length || 0;
      const discovered = state.discoveredPlanets?.length || 0;
      return Math.max(owned, discovered);
    }

    function getNextPlanetExplorationDurationMs() {
      const completed = getCompletedExplorationCount();
      return getPlanetExplorationDurationMsForIndex(completed);
    }

    function formatPlanetDuration(ms) {
      const totalSeconds = Math.max(0, Math.ceil(ms / 1000));
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      if (hours > 0) return `${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ`;
      if (minutes > 0) return `${minutes}Î∂Ñ ${seconds}Ï¥à`;
      return `${seconds}Ï¥à`;
    }

    function formatPlanetCountdown(exp) {
      const remaining = exp ? (exp.endsAt - Date.now()) : 0;
      return formatPlanetDuration(remaining);
    }

    function addDiscoveredPlanet(planetIndex) {
      if (!state.discoveredPlanets) state.discoveredPlanets = [];
      if (!state.discoveredPlanets.includes(planetIndex)) state.discoveredPlanets.push(planetIndex);
    }

    function removeDiscoveredPlanet(planetIndex) {
      if (!state.discoveredPlanets) return;
      state.discoveredPlanets = state.discoveredPlanets.filter((idx) => idx !== planetIndex);
    }

    function completePlanetAcquisition(planetIndex) {
      if (!state.ownedPlanets) state.ownedPlanets = [];
      if (state.ownedPlanets.includes(planetIndex)) return false;
      state.ownedPlanets.push(planetIndex);
      removeDiscoveredPlanet(planetIndex);
      applyQuestProgress('planet', 1);
      const planet = PLANET_CATALOG[planetIndex];
      if (planet?.name === 'ÌôîÏÑ±' && !rankingUnlocked) {
        rankingUnlocked = true;
        if (uid && userBasePath) {
          try {
            update(ref(db, `${userBasePath}/meta`), { rankingUnlocked: true }).catch(() => {});
          } catch {}
        }
        showToast('üèÜ Îû≠ÌÇπ Ïû†Í∏à Ìï¥Ï†ú!', 'Î∞îÎ°ú Í∞ÄÍ∏∞', () => {
          if (!requireLoginForFeature()) return;
          location.href = '/ranking.html';
        });
      }
      if (state.ownedPlanets.length === PLANET_CATALOG.length) window.location.href = '/ending.html';
      return true;
    }

    function finalizePlanetExplorationIfReady() {
      const exp = state.planetExploration;
      if (!exp) return false;
      if (Date.now() < (exp.endsAt || 0)) return false;
      state.planetExploration = null;
      addDiscoveredPlanet(exp.planetIndex);
      showToast(`ü™ê ${PLANET_CATALOG[exp.planetIndex]?.name || 'ÌñâÏÑ±'} ÌÉêÏÇ¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú Íµ¨Îß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.`, null, null, 3200);
      save();
      return true;
    }

    function getPlanetExplorationRemainingMs(exp = state.planetExploration) {
      if (!exp) return 0;
      return Math.max(0, (exp.endsAt || 0) - Date.now());
    }

    function promptAcceleratePlanetExploration() {
      if (!ensureReady()) return;
      const exp = state.planetExploration;
      const remainingMs = getPlanetExplorationRemainingMs(exp);
      if (!exp || remainingMs <= 0) {
        showToast('Í∞ÄÏÜçÌï† ÌÉêÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', null, null, 2400);
        return;
      }

      const remainingMinutes = Math.max(1, Math.ceil(remainingMs / 60000));
      const input = prompt(`ÏñºÎßàÎÇò Í∞ÄÏÜçÌï†ÍπåÏöî? ÏµúÎåÄ ${remainingMinutes}Î∂ÑÍπåÏßÄ Í∞ÄÎä•Ìï©ÎãàÎã§. (10Î∂ÑÎãπ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞ú)`, `${Math.min(remainingMinutes, 10)}`);
      if (input === null) return;
      const minutes = Math.floor(Number(input));
      if (!minutes || minutes < 1) {
        showToast('1Î∂Ñ Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', null, null, 2400);
        return;
      }

      const clampedMinutes = Math.min(remainingMinutes, minutes);
      const coinCost = Math.ceil(clampedMinutes / 10);
      if ((state.eventCoins || 0) < coinCost) {
        showToast('Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.', null, null, 2400);
        return;
      }

      const reductionMinutes = Math.min(remainingMinutes, coinCost * 10);
      const reductionMs = reductionMinutes * 60000;
      const overkillMinutes = reductionMinutes - clampedMinutes;
      const newRemainingMs = Math.max(0, remainingMs - reductionMs);
      let confirmMsg = `Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ${coinCost}Í∞úÎ•º ÏÇ¨Ïö©Ìï¥ ${reductionMinutes}Î∂ÑÏùÑ Îã®Ï∂ïÌï©ÎãàÎã§. Í∞ÄÏÜç ÌõÑ ÎÇ®ÏùÄ ÏãúÍ∞ÑÏùÄ ${formatPlanetDuration(newRemainingMs)}ÏûÖÎãàÎã§. ÏßÑÌñâÌï†ÍπåÏöî?`;
      if (overkillMinutes > 0) {
        confirmMsg = `Í∞ÄÏÜçÏùÄ 10Î∂Ñ Îã®ÏúÑÎ°ú Ï†ÅÏö©Îê©ÎãàÎã§. ÏûÖÎ†•Ìïú ${clampedMinutes}Î∂Ñ ÎåÄÏã† ${reductionMinutes}Î∂ÑÏù¥ Îã®Ï∂ïÎêòÏñ¥ ${overkillMinutes}Î∂ÑÎßåÌÅº Îçî ÏÇ¨Ïö©Îê©ÎãàÎã§. Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ${coinCost}Í∞úÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÎÇ®ÏùÄ ÏãúÍ∞ÑÏùÄ ${formatPlanetDuration(newRemainingMs)}ÏûÖÎãàÎã§. ÏßÑÌñâÌï†ÍπåÏöî?`;
      }
      if (!confirm(confirmMsg)) return;

      state.eventCoins -= coinCost;
      auditSpend('eco', coinCost);
      state.planetExploration.endsAt = Math.max(Date.now(), state.planetExploration.endsAt - reductionMs);
      save();
      updateUI(true);
      renderPlanets();
      showToast('‚è±Ô∏è ÌÉêÏÇ¨ ÏÜçÎèÑÎ•º ÎÜíÏòÄÏäµÎãàÎã§!', null, null, 2600);
    }

    function purchaseDiscoveredPlanet(planetIndex) {
      if (!ensureReady()) return;
      const planet = PLANET_CATALOG[planetIndex];
      if (!planet) return;
      if (state.ownedPlanets && state.ownedPlanets.includes(planetIndex)) return;
      if (!state.discoveredPlanets || !state.discoveredPlanets.includes(planetIndex)) {
        showToast('Î®ºÏ†Ä ÌÉêÏÇ¨Î•º ÏôÑÎ£åÌï¥Ïïº Íµ¨Îß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.', null, null, 2600);
        return;
      }
      if (state.shipLevel < planet.requiredShipLevel) {
        showToast('Ïö∞Ï£ºÏÑ† Î†àÎ≤®Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Ïö∞Ï£ºÏÑ†ÏùÑ Î®ºÏ†Ä Í∞ïÌôîÌïòÏÑ∏Ïöî.', null, null, 2600);
        return;
      }
      if (state.coins < planet.cost) {
        showToast('ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.', null, null, 2200);
        return;
      }
      state.coins -= planet.cost;
      auditSpend('coin', planet.cost);
      completePlanetAcquisition(planetIndex);
      save();
      updateUI(true);
      renderPlanets();
      showToast(`ü™ê ${planet.name} Íµ¨Îß§ ÏôÑÎ£å!`, null, null, 3000);
    }

    const PLANET_CATALOG = [
      {name:'Îã¨', cost:100, requiredShipLevel:1},
      {name:'ÏàòÏÑ±', cost:500, requiredShipLevel:2},
      {name:'Í∏àÏÑ±', cost:2000, requiredShipLevel:3},
      {name:'ÏßÄÍµ¨', cost:10000, requiredShipLevel:4},
      {name:'ÌôîÏÑ±', cost:50000, requiredShipLevel:5},
      {name:'Î™©ÏÑ±', cost:250000, requiredShipLevel:6},
      {name:'ÌÜ†ÏÑ±', cost:1000000, requiredShipLevel:7},
      {name:'Ï≤úÏôïÏÑ±', cost:5000000, requiredShipLevel:8},
      {name:'Ìï¥ÏôïÏÑ±', cost:20000000, requiredShipLevel:9},
      {name:'ÏÑ∏Î†àÏä§', cost:80000000, requiredShipLevel:10},
      {name:'ÌÉÄÏù¥ÌÉÑ', cost:250000000, requiredShipLevel:11},
      {name:'Í∞ÄÎãàÎ©îÎç∞', cost:750000000, requiredShipLevel:12},
      {name:'ÏóêÏö∞Î°úÌåå', cost:1800000000, requiredShipLevel:13},
      {name:'Ìä∏Î¶¨ÌÜ§', cost:4200000000, requiredShipLevel:14},
      {name:'Ïπ¥Î°†', cost:9000000000, requiredShipLevel:15},
      {name:'Ìä∏ÎùºÌîºÏä§Ìä∏-1e', cost:22000000000, requiredShipLevel:16},
      {name:'ÌîÑÎ°úÏãúÎßà b', cost:52000000000, requiredShipLevel:17},
      {name:'Í∏ÄÎ¶¨Ï†ú 581g', cost:125000000000, requiredShipLevel:18}
    ];

    function allPlanetsPurchased(){
      return (state.ownedPlanets?.length || 0) >= PLANET_CATALOG.length;
    }

    let planetSubTab = 'explore';

    function setPlanetSubTab(mode = 'explore') {
      planetSubTab = mode === 'purchase' ? 'purchase' : 'explore';
      const activePanelId = planetSubTab === 'purchase' ? 'planet-purchase-panel' : 'planet-explore-panel';

      document.querySelectorAll('#planets-content .planet-subtab').forEach(btn => {
        const active = btn.dataset.planetTab === planetSubTab;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      document.querySelectorAll('#planets-content .planet-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === activePanelId);
      });
    }

    function getPlanetExplorationCost(planet) {
      if (!planet) return 0;
      const ratioCost = Math.floor(planet.cost * 0.05);
      return Math.max(50, ratioCost);
    }

    function renderPlanets() {
      finalizePlanetExplorationIfReady();
      const planets = PLANET_CATALOG;
      const explorePanel = document.getElementById('planet-explore-panel');
      const purchasePanel = document.getElementById('planet-purchase-panel');
      if (!explorePanel || !purchasePanel) return;
      explorePanel.innerHTML = '';
      purchasePanel.innerHTML = '';

      const exploration = state.planetExploration;
      const hasActiveExploration = exploration && Date.now() < (exploration.endsAt || 0);

      const info = document.createElement('div');
      info.className = 'planet-info-box';
      if (hasActiveExploration) {
        const target = planets[exploration.planetIndex];
        const infoText = document.createElement('div');
        infoText.textContent = `${target?.name || 'ÌñâÏÑ±'} ÌÉêÏÇ¨ ÏßÑÌñâ Ï§ë ¬∑ ÎÇ®ÏùÄ ÏãúÍ∞Ñ ${formatPlanetCountdown(exploration)}`;
        info.appendChild(infoText);

        const accelBtn = document.createElement('button');
        accelBtn.className = 'general';
        accelBtn.style.marginTop = '10px';
        accelBtn.textContent = 'ÌÉêÏÇ¨ Í∞ÄÏÜç (10Î∂ÑÎãπ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞ú)';
        accelBtn.disabled = !state.eventCoins;
        accelBtn.onclick = () => promptAcceleratePlanetExploration();
        info.appendChild(accelBtn);
      } else {
        info.textContent = `Îã§Ïùå ÌÉêÏÇ¨ ÏÜåÏöî ÏãúÍ∞Ñ: ${formatPlanetDuration(getNextPlanetExplorationDurationMs())} ¬∑ ÌÉêÏÇ¨ ÎπÑÏö©ÏùÄ Í∞Å ÌñâÏÑ± Íµ¨Îß§Í∞ÄÏùò 5%ÏûÖÎãàÎã§.`;
      }
      explorePanel.appendChild(info);

      planets.forEach((p, i) => {
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const discovered = state.discoveredPlanets && state.discoveredPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        const exploringThis = !!(exploration && exploration.planetIndex === i);
        const activeCountdown = exploringThis && hasActiveExploration;
        const otherExploring = hasActiveExploration && !exploringThis;
        const exploreCost = getPlanetExplorationCost(p);
        const durationText = formatPlanetDuration(getNextPlanetExplorationDurationMs());

        const div = document.createElement('div');
        div.className = 'planet-card';
        div.innerHTML = `<strong>${p.name}</strong><div>ÌÉêÏÇ¨ ÎπÑÏö©: ${formatKR(exploreCost)}ÏΩîÏù∏ ¬∑ ÌÉêÏÇ¨ ÏãúÍ∞Ñ: ${durationText}</div><div>ÌïÑÏöî Î†ô: ${p.requiredShipLevel}</div>`;

        const actions = document.createElement('div');
        actions.className = 'planet-actions';
        const btn = document.createElement('button');
        btn.className='general';
        if (owned) {
          btn.textContent = 'Ï†ïÎ≥µ ÏôÑÎ£å';
          btn.disabled = true;
        } else if (discovered && !canBuy) {
          btn.textContent = 'Î†ô Î∂ÄÏ°± (Íµ¨Îß§ ÌÉ≠)';
          btn.disabled = true;
        } else if (discovered) {
          btn.textContent = 'ÌÉêÏÇ¨ ÏôÑÎ£å (Íµ¨Îß§ ÌÉ≠ÏóêÏÑú ÏßÑÌñâ)';
          btn.disabled = true;
        } else if (activeCountdown) {
          btn.textContent = `ÌÉêÏÇ¨ Ï§ë (${formatPlanetCountdown(exploration)})`;
          btn.disabled = true;
        } else if (otherExploring) {
          btn.textContent = 'Îã§Î•∏ ÌÉêÏÇ¨ ÏßÑÌñâ Ï§ë';
          btn.disabled = true;
        } else if (!canBuy) {
          btn.textContent = 'Î†ô Î∂ÄÏ°±';
          btn.disabled = true;
        } else {
          btn.textContent = `ÌÉêÏÇ¨ ÏãúÏûë (${formatKR(exploreCost)}ÏΩîÏù∏)`;
          btn.disabled = state.coins < exploreCost;
        }

        btn.onclick = () => {
          if (!ensureReady()) return;
          if (owned || discovered) return;
          if (!canBuy) {
            showToast('Ïö∞Ï£ºÏÑ† Î†àÎ≤®Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Ïö∞Ï£ºÏÑ†ÏùÑ Î®ºÏ†Ä Í∞ïÌôîÌïòÏÑ∏Ïöî.', null, null, 2600);
            return;
          }
          if (state.coins < exploreCost) {
            showToast('ÌÉêÏÇ¨ ÎπÑÏö©Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.', null, null, 2400);
            return;
          }
          const active = state.planetExploration && Date.now() < (state.planetExploration.endsAt || 0);
          if (active) {
            showToast('Îã§Î•∏ ÌñâÏÑ± ÌÉêÏÇ¨Í∞Ä ÎÅùÎÇ† ÎïåÍπåÏßÄ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.', null, null, 2400);
            return;
          }
          const now = Date.now();
          const durationMs = getNextPlanetExplorationDurationMs();
          state.coins -= exploreCost;
          auditSpend('coin', exploreCost);
          state.planetExploration = {
            planetIndex: i,
            startedAt: now,
            endsAt: now + durationMs,
            durationMs
          };
          save();
          updateUI(true);
          renderPlanets();
          showToast(`üõ∞Ô∏è ${p.name} ÌÉêÏÇ¨Î•º ÏãúÏûëÌñàÏäµÎãàÎã§! (${formatPlanetDuration(durationMs)})`, null, null, 3200);
        };
        actions.appendChild(btn);
        div.appendChild(actions);
        explorePanel.appendChild(div);
      });

      const purchaseInfo = document.createElement('div');
      purchaseInfo.className = 'planet-info-box';
      purchaseInfo.textContent = 'ÌÉêÏÇ¨Î•º ÏôÑÎ£åÌïú ÌñâÏÑ±ÏùÄ Ïó¨Í∏∞ÏÑú ÏΩîÏù∏ÏùÑ ÏßÄÎ∂àÌï¥ Ï†ïÎ≥µÌï† Ïàò ÏûàÏäµÎãàÎã§.';
      purchasePanel.appendChild(purchaseInfo);

      let hasPurchaseCandidate = false;
      planets.forEach((p, i) => {
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const discovered = state.discoveredPlanets && state.discoveredPlanets.includes(i);
        if (!owned && !discovered) return;

        const canBuy = state.shipLevel >= p.requiredShipLevel;
        const div = document.createElement('div');
        div.className = 'planet-card';
        div.innerHTML = `<strong>${p.name}</strong><div>Íµ¨Îß§ ÎπÑÏö©: ${formatKR(p.cost)}ÏΩîÏù∏</div><div>ÌïÑÏöî Î†ô: ${p.requiredShipLevel}</div>`;

        const actions = document.createElement('div');
        actions.className = 'planet-actions';
        const btn = document.createElement('button');
        btn.className = 'general';

        if (owned) {
          btn.textContent = 'Íµ¨Îß§ ÏôÑÎ£å';
          btn.disabled = true;
        } else if (!canBuy) {
          btn.textContent = 'Î†ô Î∂ÄÏ°± (Íµ¨Îß§)';
          btn.disabled = true;
        } else {
          btn.textContent = `Íµ¨Îß§ (${formatKR(p.cost)}ÏΩîÏù∏)`;
          btn.disabled = state.coins < p.cost;
          btn.onclick = () => purchaseDiscoveredPlanet(i);
        }

        actions.appendChild(btn);
        div.appendChild(actions);
        purchasePanel.appendChild(div);
        hasPurchaseCandidate = true;
      });

      if (!hasPurchaseCandidate) {
        const empty = document.createElement('div');
        empty.className = 'planet-card';
        empty.textContent = 'ÌÉêÏÇ¨Î•º ÏôÑÎ£åÌïú ÌñâÏÑ±Ïù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÌÉêÏÇ¨ ÌÉ≠ÏóêÏÑú ÌÉêÏÇ¨Î•º ÏßÑÌñâÌïòÏÑ∏Ïöî.';
        purchasePanel.appendChild(empty);
      }
    }

    const oreParticlePool = [];
    const ORE_PARTICLES_PER_CLICK = 8;
    const ORE_PARTICLE_POOL_LIMIT = 120;
    let activeOreParticles = 0;

    function createOreParticle() {
      const frag = document.createElement('img');
      frag.src = '/images/ore.png';
      frag.alt = '';
      frag.className = 'ore-frag';
      frag.addEventListener('animationend', () => {
        frag.remove();
        activeOreParticles = Math.max(0, activeOreParticles - 1);
        if (oreParticlePool.length < ORE_PARTICLE_POOL_LIMIT) {
          oreParticlePool.push(frag);
        }
      });
      return frag;
    }

    function spawnParticles(x,y) {
      const container = document.getElementById('ore-container');
      if (!container) return;
      const available = Math.max(0, ORE_PARTICLE_POOL_LIMIT - activeOreParticles);
      const count = Math.min(ORE_PARTICLES_PER_CLICK, available);
      for (let i = 0; i < count; i++){
        const frag = oreParticlePool.pop() || createOreParticle();
        const dx = (Math.random() - 0.5) * 220;
        const dy = (Math.random() - 0.5) * 200;
        const startScale = 0.45 + Math.random() * 0.25;
        const endScale = startScale * (0.35 + Math.random() * 0.25);
        const startRot = (Math.random() - 0.5) * 20;
        const rot = (Math.random() - 0.5) * 260;
        frag.style.setProperty('--dx', `${dx}px`);
        frag.style.setProperty('--dy', `${dy}px`);
        frag.style.setProperty('--start-scale', startScale.toFixed(2));
        frag.style.setProperty('--end-scale', endScale.toFixed(2));
        frag.style.setProperty('--start-rot', `${startRot.toFixed(2)}deg`);
        frag.style.setProperty('--rot', `${rot.toFixed(2)}deg`);
        frag.style.left = x+'px';
        frag.style.top = y+'px';
        frag.style.animation = 'none';
        // restart animation (force reflow)
        void frag.offsetWidth;
        frag.style.animation = '';
        container.appendChild(frag);
        activeOreParticles++;
      }
    }

    function ensureReady() {
      if (!window.__PLAY_ALLOWED) { showAuthStatus('PCÏóêÏÑúÎäî ÌåùÏóÖÏúºÎ°úÎßå Ïã§ÌñâÎê©ÎãàÎã§. ÌåùÏóÖÏúºÎ°ú Îã§Ïãú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî.'); return false; }
      if (!uid && !guestMode) { showAuthStatus('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.'); return false; }
      if (!guestMode && isInitialSync) { showAuthStatus('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.'); return false; }
      if (!guestMode && !security.tosAccepted){ showTosOverlay(true); showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥Ä ÎèôÏùòÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.', true); return false; }
      if (!guestMode && security.banned){ showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞ò ÏùòÏã¨(Í≥ÑÏ†ï Ï†ïÏßÄ)ÏúºÎ°ú ÌîåÎ†àÏù¥Í∞Ä Ï†úÌïúÎêòÏóàÏäµÎãàÎã§.', true); return false; }
      showAuthStatus(''); return true;
    }

    (function prepareHardShutdown(){
      if (typeof window.__HARD_SHUTDOWN_GAME === 'function') return;
      let applied = false;
      const disableInteractiveAreas = () => {
        const selectors = [
          '#container button', '#container a', '#container input', '#container select', '#container textarea',
          '#container [role="button"]', '#top-bar button', '#top-bar a', '#top-bar [role="button"]'
        ];
        try {
          document.querySelectorAll(selectors.join(',')).forEach((el) => {
            try {
              if ('disabled' in el) el.disabled = true;
              el.classList.add('hard-block-disabled');
              el.setAttribute('aria-disabled', 'true');
            } catch {}
          });
        } catch {}
      };
      window.__HARD_SHUTDOWN_GAME = (info) => {
        if (applied) return;
        applied = true;
        try { window.__PLAY_ALLOWED = false; } catch {}
        try { window.__PLAY_BASE_ALLOWED = false; } catch {}
        try {
          if (window.__gameTimer) {
            clearInterval(window.__gameTimer);
            window.__gameTimer = null;
          }
        } catch {}
        disableInteractiveAreas();
        try { document.body.classList.add('game-hard-blocked'); } catch {}
        try {
          const msg = info?.message || 'Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Ïã§ÌñâÏù¥ Í∞êÏßÄÎêòÏñ¥ ÌòÑÏû¨ Ï∞ΩÏùò ÎèôÏûëÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.';
          showAuthStatus(msg, true);
        } catch {}
      };
    })();

    function wireGame() {
      document.getElementById('ore').addEventListener('click', e => {
        if (!window.__PLAY_ALLOWED) return;
        if (!guestMode && (!uid || isInitialSync)) return;
        if (security.banned){ return; }

        if (!ensureReady()) return;
        const rect = e.target.getBoundingClientRect();
        spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
        const resMul = activeBuffFactor('res') * aggregateTreeMultiplier('res');
        const clickMul = aggregateTreeMultiplier('click');
        const perkResMul = perkState.resourceMult || 1;
        const inc = state.clickPower * resMul * perkResMul * clickMul;
        state.resources += inc;
        auditAdd('res', inc);
        playSfx('sfx-pickaxe');
        if (state.autoConvertBought && state.autoConvertEnabled) convertResources(null, 'auto');
        save(); updateUI();
      });
      attachHoldRepeat('convert-button', () => {
        if (!ensureReady()) return false;
        if (!convertResources(1, 'manual')) return false;
        save(); updateUI();
        return true;
      });
      document.getElementById('auto-convert-buy').addEventListener('click', () => {
        if (!ensureReady()) return;
        if (!state.autoConvertBought) {
          if (state.coins < 100) return;
          state.coins -= 100;
          auditSpend('coin', 100);
          state.autoConvertBought = true;
          state.autoConvertEnabled = true;
        } else {
          state.autoConvertEnabled = !state.autoConvertEnabled;
        }
        save(); updateUI();
      });

      const christmasOverlay = document.getElementById('christmas-overlay');
      const christmasFrame = document.getElementById('christmas-frame');
      const christmasStartBtn = document.getElementById('christmas-start');
      const christmasCloseBtn = document.getElementById('christmas-close');
      let christmasGameBlockSnapshot = null;

      function setChristmasGameBlock(active) {
        if (active) {
          if (christmasGameBlockSnapshot) return;
          const hadHardBlock = document.body.classList.contains('game-hard-blocked');
          const prevCoinBlock = !!window.__CHRISTMAS_BLOCK_COINS;
          christmasGameBlockSnapshot = { hadHardBlock, prevCoinBlock };
          try { window.__PLAY_BLOCKED_BY_CHRISTMAS = true; } catch {}
          try { window.__CHRISTMAS_BLOCK_COINS = true; } catch {}
          try { document.body.classList.add('christmas-focus'); } catch {}
          if (hadHardBlock) return;
          try { document.body.classList.remove('game-hard-blocked'); } catch {}
          return;
        }

        if (!christmasGameBlockSnapshot) return;
        const { hadHardBlock, prevCoinBlock } = christmasGameBlockSnapshot;
        christmasGameBlockSnapshot = null;
        try { window.__PLAY_BLOCKED_BY_CHRISTMAS = false; } catch {}
        try { window.__CHRISTMAS_BLOCK_COINS = prevCoinBlock; } catch {}
        try { document.body.classList.remove('christmas-focus'); } catch {}
        if (hadHardBlock) return;
        try { document.body.classList.remove('game-hard-blocked'); } catch {}
      }

      function openChristmasOverlay() {
        if (!christmasOverlay || !christmasFrame) return;
        const src = christmasFrame.dataset.src;
        if (src && (!christmasFrame.src || christmasFrame.src === 'about:blank')) {
          christmasFrame.src = src;
        }
        christmasOverlay.classList.add('show');
        christmasOverlay.setAttribute('aria-hidden', 'false');
        setChristmasGameBlock(true);
        try { christmasOverlay.scrollIntoView({ behavior:'smooth', block:'center' }); } catch {}
      }

      function closeChristmasOverlay() {
        if (!christmasOverlay || !christmasFrame) return;
        christmasOverlay.classList.remove('show');
        christmasOverlay.setAttribute('aria-hidden', 'true');
        christmasFrame.src = 'about:blank';
        setChristmasGameBlock(false);
      }

      christmasStartBtn?.addEventListener('click', () => {
        if (!ensureReady()) return;
        openChristmasOverlay();
      });

      christmasCloseBtn?.addEventListener('click', () => {
        closeChristmasOverlay();
      });

      document.getElementById('craft-santa-coin')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        if ((state.santaPieces || 0) < 10) {
          showToast('ÏÇ∞ÌÉÄ Ï°∞Í∞ÅÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Î¶¨Îì¨Í≤åÏûÑÏùÑ ÌîåÎ†àÏù¥Ìï¥ Î≥¥ÏÑ∏Ïöî!', null, null, 2600);
          return;
        }
        state.santaPieces -= 10;
        state.santaCoins = (state.santaCoins || 0) + 1;
        showToast('üéÖ ÏÇ∞ÌÉÄ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞úÎ•º Ï†úÏûëÌñàÏäµÎãàÎã§!', null, null, 2400);
        save(); updateUI();
      });

      document.getElementById('convert-ecoin-to-santacoin')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        if (!canSpendEC(3)) {
          showToast('Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.', null, null, 2400);
          return;
        }
        state.eventCoins -= 3;
        state.santaCoins = (state.santaCoins || 0) + 1;
        auditSpend('eco', 3);
        showToast('Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 3Í∞úÎ•º ÏÇ∞ÌÉÄ Ïù¥Î≤§Ìä∏ÏΩîÏù∏ 1Í∞úÎ°ú ÍµêÌôòÌñàÏñ¥Ïöî.', null, null, 2400);
        save(); updateUI();
      });

      document.getElementById('christmas-upgrade')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        const lv = Math.max(0, state.christmasTreeLevel || 0);
        const next = christmasTreeRewards[lv];
        if (!next) {
          showToast('ÏµúÎåÄ Ìä∏Î¶¨ Î†àÎ≤®ÏûÖÎãàÎã§!', null, null, 2200);
          return;
        }
        if ((state.santaCoins || 0) < next.cost) {
          showToast('ÏÇ∞ÌÉÄ Ïù¥Î≤§Ìä∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï¥Ïöî.', null, null, 2400);
          return;
        }
        state.santaCoins -= next.cost;
        state.christmasTreeLevel = lv + 1;
        showToast(`Ìä∏Î¶¨ Lv.${lv + 1} Îã¨ÏÑ±! ${next.reward}`, null, null, 3200);
        renderBuffStatus();
        save(); updateUI();
      });
      attachHoldRepeat('hire-worker', () => {
        if (!ensureReady()) return false;
        const cost = getWorkerCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          hireWorkersBulk(1);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-worker-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        hireWorkersBulk(10);
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-conversion', () => {
        if (!ensureReady()) return false;
        const cost = getConversionCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          hireConversionsBulk(1);
        } else if (canSpendEC(1)) {
          state.eventCoins -= 1;
          auditSpend('eco', 1);
          hireConversionsBulk(10);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-conversion-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        hireConversionsBulk(10);
        save(); updateUI();
        return true;
      });
      function attemptShipUpgrade(payment, options = {}) {
        if (!ensureReady()) return false;
        if (shipEnhanceInProgress) return false;

        const cost = state.shipUpgradeCost;
        const ecoOffer = getShipEventUpgradeOffer();
        const mode = options.mode || 'auto';
        let paidWith = null;
        let guaranteed = false;
        let ecoCostUsed = 0;

        if (payment === 'coin') {
          if (state.coins < cost) return false;
          state.coins -= cost;
          auditSpend('coin', cost);
          paidWith = 'coin';
        } else if (payment === 'eco') {
          const canGuarantee = ecoOffer.guaranteed && canSpendEC(ecoOffer.cost);
          const canRiskAttempt = canSpendEC(1);

          if (mode === 'guaranteed') {
            if (!canGuarantee) return false;
            ecoCostUsed = ecoOffer.cost;
            guaranteed = true;
          } else if (mode === 'risk') {
            if (!canRiskAttempt) return false;
            ecoCostUsed = 1;
            guaranteed = false;
          } else {
            if (!canGuarantee && !canRiskAttempt) return false;

            if (ecoOffer.guaranteed) {
              let useGuaranteed = canGuarantee;
              if (canGuarantee && canRiskAttempt) {
                useGuaranteed = confirm(`Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ${formatKR(ecoOffer.cost)}Í∞úÎ°ú ÌôïÏ†ï Í∞ïÌôîÌï†ÍπåÏöî? 1Í∞úÎ°ú ÌôïÎ•† ÎèÑÏ†ÑÌïòÎ†§Î©¥ Ï∑®ÏÜåÎ•º ÎàÑÎ•¥ÏÑ∏Ïöî.`);
              }
              ecoCostUsed = useGuaranteed ? ecoOffer.cost : 1;
              guaranteed = useGuaranteed && ecoOffer.guaranteed;
            } else {
              if (!canSpendEC(ecoOffer.cost)) return false;
              ecoCostUsed = ecoOffer.cost;
            }
          }

          state.eventCoins -= ecoCostUsed;
          auditSpend('eco', ecoCostUsed);
          paidWith = 'eco';
        } else {
          return false;
        }

        const chance = guaranteed ? 100 : getShipSuccessRate();
        const shipPanel = document.querySelector('.ship-panel');
        shipEnhanceInProgress = true;
        shipPanel?.classList.add('enhancing');
        setShipEnhanceStatus(`ÎëêÍµ¨ÎëêÍµ¨... Í∞ïÌôî Ï§ÄÎπÑ Ï§ë! (${guaranteed ? 'ÌôïÏ†ï Í∞ïÌôî' : `ÏÑ±Í≥µ ÌôïÎ•† ${chance}%`})`, 'info');
        playSfx('sfx-start');
        updateUI();

        setTimeout(() => {
          const success = guaranteed || Math.random() * 100 < chance;
          shipPanel?.classList.remove('enhancing');

          if (success) {
            state.shipLevel++;
            state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30);
            applyQuestProgress('ship', 1);
            playSfx('sfx-win');
            shipPanel?.classList.add('success-glow');
            setTimeout(() => shipPanel?.classList.remove('success-glow'), 820);
            const resultMsg = guaranteed
              ? `ÏÑ±Í≥µ! Ïö∞Ï£ºÏÑ† ${state.shipLevel}Î†ô Îã¨ÏÑ± (Ïù¥Î≤§Ìä∏ÏΩîÏù∏ÏúºÎ°ú ÌôïÏ†ï Í∞ïÌôî)`
              : `ÏÑ±Í≥µ! Ïö∞Ï£ºÏÑ† ${state.shipLevel}Î†ô Îã¨ÏÑ± (ÎèÑÏ†Ñ ÌôïÎ•† ${chance}%)`;
            setShipEnhanceStatus(resultMsg, 'success');
          } else {
            shipPanel?.classList.add('fail-shake');
            setTimeout(() => shipPanel?.classList.remove('fail-shake'), 720);
            const paymentText = paidWith === 'eco' ? `Ïù¥Î≤§Ìä∏ÏΩîÏù∏ ${formatKR(ecoCostUsed)}Í∞ú` : `${formatKR(cost)}ÏΩîÏù∏`;
            setShipEnhanceStatus(`Ïã§Ìå®... ${paymentText}Ïù¥(Í∞Ä) ÏÜåÎ™®ÎêêÏäµÎãàÎã§. ÌôïÎ•†ÏùÄ Ïú†ÏßÄÎèºÏöî! (ÏÑ±Í≥µ ÌôïÎ•† ${chance}%)`, 'warn');
          }

          shipEnhanceInProgress = false;
          save(); updateUI(); renderPlanets();
        }, 1100);

        return true;
      }

      attachHoldRepeat('upgrade-ship', () => attemptShipUpgrade('coin'));
      attachHoldRepeat('upgrade-ship-ec', () => attemptShipUpgrade('eco', { mode: 'guaranteed' }));
      attachHoldRepeat('upgrade-ship-ec-risk', () => attemptShipUpgrade('eco', { mode: 'risk' }));

      document.querySelectorAll('.ship-ec-tab').forEach(tab => tab.addEventListener('click', () => {
        const targetTab = tab.dataset.shipEcTab;
        document.querySelectorAll('.ship-ec-tab').forEach(t => {
          const isActive = t === tab;
          t.classList.toggle('active', isActive);
          t.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        document.querySelectorAll('.ship-ec-panel').forEach(panel => {
          panel.classList.toggle('active', panel.dataset.shipEcPanel === targetTab);
        });
      }));

      attachHoldRepeat('click-upgrade', () => {
        if (!ensureReady()) return false;
        const cost = ensureClickUpgradeCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          applyClickUpgrades(1);
        } else if (canSpendEC(1)) {
          state.eventCoins -= 1;
          auditSpend('eco', 1);
          applyClickUpgrades(10);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('click-upgrade-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        applyClickUpgrades(10);
        save(); updateUI();
        return true;
      });

      let updateBottomNavLock = null;

      document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'auto' });

        // ÌÉ≠ Ï†ÑÌôò Ïãú Î†àÏù¥ÏïÑÏõÉÏù¥ Î∞îÎÄåÏñ¥ÎèÑ Í¥ëÍ≥†ÏôÄ ÌïòÎã® ÎÇ¥ÎπÑÍ∞Ä Í≤πÏπòÏßÄ ÏïäÎèÑÎ°ù Ï¶âÏãú Ïû¨Í≥ÑÏÇ∞
        if (typeof updateBottomNavLock === 'function') {
          requestAnimationFrame(() => updateBottomNavLock && updateBottomNavLock());
        }
      }));

      document.querySelectorAll('#planets-content .planet-subtab').forEach(btn => btn.addEventListener('click', () => {
        setPlanetSubTab(btn.dataset.planetTab);
      }));
      setPlanetSubTab(planetSubTab);

      // ÌïòÎã® ÎÇ¥ÎπÑÍ∞Ä Í¥ëÍ≥† ÏòÅÏó≠ÏùÑ ÎçÆÏßÄ ÏïäÎèÑÎ°ù Í∞ÄÎìú ÏßÄÏ†êÏóêÏÑú Î©àÏ∂§
      const bottomNav = document.getElementById('bottom-nav');
      const bottomNavGuard = document.getElementById('bottom-nav-guard');
      if (bottomNav && bottomNavGuard) {
        const defaultBottom = parseFloat(getComputedStyle(bottomNav).bottom) || 0;
        const navStopGap = 12;
        const singleColumnQuery = window.matchMedia('(max-width: 900px)');
        let navLocked = false;

        const lockNavToGuard = () => {
          const guardRect = bottomNavGuard.getBoundingClientRect();
          const stopTop = window.scrollY + guardRect.top - bottomNav.offsetHeight - navStopGap;
          bottomNav.classList.add('nav-locked');
          bottomNav.style.position = 'absolute';
          bottomNav.style.top = `${stopTop}px`;
          bottomNav.style.bottom = '';
          bottomNav.style.zIndex = '0';
          navLocked = true;
        };

        const unlockNav = () => {
          if (!navLocked) return;
          bottomNav.classList.remove('nav-locked');
          bottomNav.style.position = '';
          bottomNav.style.top = '';
          bottomNav.style.bottom = '';
          bottomNav.style.zIndex = '';
          navLocked = false;
        };

        updateBottomNavLock = () => {
          const guardTop = bottomNavGuard.getBoundingClientRect().top;
          const shouldLock = singleColumnQuery.matches && guardTop <= (window.innerHeight - defaultBottom);
          if (shouldLock) {
            lockNavToGuard();
          } else {
            unlockNav();
          }
        };

        singleColumnQuery.addEventListener('change', updateBottomNavLock);
        ['scroll', 'resize'].forEach(evt => window.addEventListener(evt, updateBottomNavLock, { passive: true }));
        updateBottomNavLock();
      }

      // Î≤ÑÌîÑ Î≤ÑÌäº Ïò§Ìîà
      const buffBtn = document.getElementById('buff-btn');
      const buffOv  = document.getElementById('buff-overlay');
      const buffClose = document.getElementById('buff-close');
      if (buffBtn && buffOv) {
        buffBtn.addEventListener('click', ()=>{
          renderBuffStatus();
          buffOv.classList.add('show');
          buffOv.setAttribute('aria-hidden','false');
        });
      }
      if (buffClose && buffOv) {
        const closeBuffOverlay = () => {
          buffOv.classList.remove('show');
          buffOv.setAttribute('aria-hidden','true');
        };

        const openAdminFromBuff = () => {
          let opened = false;
          if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.openAdminPanel === 'function') {
            try {
              window.__SESSION_LOCK__.openAdminPanel({ message: 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù ÌõÑ Í∞úÎ∞úÏûê ÎèÑÍµ¨ Ïû†Í∏àÏùÑ Ìï¥Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.' });
              opened = true;
            } catch (err) {
              console.warn('Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Ìå®ÎÑêÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.', err);
            }
          }
          return opened;
        };

        let adminHoldTimer = null;
        let adminHoldTriggered = false;
        let suppressCloseClick = false;

        const startAdminHold = () => {
          if (adminHoldTimer) {
            clearTimeout(adminHoldTimer);
            adminHoldTimer = null;
          }
          adminHoldTriggered = false;
          adminHoldTimer = setTimeout(() => {
            adminHoldTimer = null;
            if (openAdminFromBuff()) {
              adminHoldTriggered = true;
              suppressCloseClick = true;
            }
          }, 20000);
        };

        const cancelAdminHold = () => {
          if (adminHoldTimer) {
            clearTimeout(adminHoldTimer);
            adminHoldTimer = null;
          }
          const wasTriggered = adminHoldTriggered;
          adminHoldTriggered = false;
          return wasTriggered;
        };

        const finishAdminHold = (event) => {
          if (cancelAdminHold()) {
            event.preventDefault();
            event.stopPropagation();
          }
        };

        buffClose.addEventListener('mousedown', startAdminHold);
        buffClose.addEventListener('touchstart', startAdminHold, { passive: true });
        ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach((type) => {
          buffClose.addEventListener(type, finishAdminHold);
        });

        buffClose.addEventListener('click', (event) => {
          if (suppressCloseClick) {
            event.preventDefault();
            event.stopPropagation();
            suppressCloseClick = false;
            return;
          }
          cancelAdminHold();
          closeBuffOverlay();
        });
      }

      // Î©îÏù∏ Î£®ÌîÑ (Î¶¨ÏÜåÏä§ Î∞è UI Í∞±Ïã† Ï†ÑÏö©)
      window.__gameTimer = setInterval(() => {
        if (!guestMode && (!uid || isInitialSync)) return;

        if (window.__PLAY_ALLOWED && !security.banned) {
          const offline = isOffline();
          const coinBlocked = !!window.__CHRISTMAS_BLOCK_COINS;
          pruneExpiredBuffs();

          // ÏûêÏõê ÏïåÎ∞î
          const prodMul = perkState.productionMult || 1;
          const perkResMul = perkState.resourceMult || 1;
          const perkCoinMul = perkState.coinMult || 1;

          let workerGain = state.workerCount * getWorkerPower() * activeBuffFactor('res') * aggregateTreeMultiplier('res') * aggregateTreeMultiplier('worker');
          if (!coinBlocked && state.workerCount > 0) {
            const finalWorkerGain = workerGain * prodMul * perkResMul;
            state.resources += finalWorkerGain;
            auditAdd('res', finalWorkerGain);
          }

          // ÏΩîÏù∏ ÏïåÎ∞î
          let convGain = state.conversionCount * activeBuffFactor('coin') * aggregateTreeMultiplier('coin') * aggregateTreeMultiplier('worker');
          if (!coinBlocked && !offline && state.conversionCount > 0) {
            const finalConvGain = convGain * prodMul * perkCoinMul;
            state.coins += finalConvGain;
            auditAdd('coin', finalConvGain, 'worker');
          }

          // ÏûêÎèô Î≥ÄÌôò
          if (!coinBlocked && !offline && state.autoConvertBought && state.autoConvertEnabled) convertResources(null, 'auto');
        }

        // ‚úÖ ÏùòÏã¨ÎèÑ Í≤ÄÏÇ¨Îäî 1Ï¥àÎßàÎã§ Î≥ÑÎèÑÎ°ú Ïú†ÏßÄ
        auditCheck();

        renderPlanets();
        if (window.__PLAY_ALLOWED) {
          updateUI();
        }
      }, 1000);

      // Î≥¥Ïïà/ÏÉÅÌÉú Ï†ÄÏû•ÏùÄ 5Ï¥à Ï£ºÍ∏∞Î°ú Î∂ÑÎ¶¨ÌïòÏó¨ ÎÑ§Ìä∏ÏõåÌÅ¨ Î∂ÄÌïò ÏôÑÌôî
      window.__saveTimer = setInterval(async () => {
        if (!guestMode && (!uid || isInitialSync)) return;
        await saveSecurity();
        if (window.__PLAY_ALLOWED) {
          save();
        }
      }, 5000);
    }

    window.addEventListener('message', (event) => {
      if (event.origin && event.origin !== window.location.origin) return;
      const data = event.data || {};
      if (data.type === 'christmas-clear' && data.pieces) {
        const gain = Math.max(0, Math.floor(data.pieces));
        state.santaPieces = (state.santaPieces || 0) + gain;
        renderBuffStatus();
        save(); updateUI();
        showToast(`üéÖ ÏÇ∞ÌÉÄ Ï°∞Í∞Å ${gain}Í∞ú ÌöçÎìù! ÏÇ∞ÌÉÄÏΩîÏù∏ÏùÄ ÏßÅÏ†ë Ï†úÏûëÌï¥ Ï£ºÏÑ∏Ïöî.`, null, null, 3200);
      }
    });

    /* ======================
       Ïù∏Ï¶ù/Î∂ÄÌåÖ ÌùêÎ¶Ñ
       ====================== */
    const tabLogin  = document.getElementById('auth-tab-login');
    const tabSignup = document.getElementById('auth-tab-signup');
    const signupExtra = document.getElementById('signup-extra');
    const loginBtn  = document.getElementById('login-btn');
    const signupBtnEl = document.getElementById('signup-btn');
    const guestStartBtn = document.getElementById('guest-start-btn');
    const guestLoginBtn = document.getElementById('guest-login-btn');
    const tosCheckbox = document.getElementById('tos-checkbox');
    const privacyCheckbox = document.getElementById('privacy-checkbox');
    const verifyInfoEl = document.getElementById('verify-info');

    function updateSignupAvailability() {
      if (!signupBtnEl) return;
      const allow = !!tosCheckbox?.checked && !!privacyCheckbox?.checked;
      signupBtnEl.disabled = !allow;
    }

    let currentAuthMode = 'login';
    function setAuthMode(mode) {
      currentAuthMode = (mode === 'signup') ? 'signup' : 'login';
      if (mode === 'signup') {
        tabLogin.classList.remove('active'); tabSignup.classList.add('active');
        signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';
        signupBtnEl.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
      } else {
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';
        signupBtnEl.disabled = false;
      }
      showAuthStatus('');
      if (verifyInfoEl) {
        verifyInfoEl.textContent = '';
        verifyInfoEl.classList.remove('show');
      }
      try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}
      updateSignupAvailability();
    }

    const LOGIN_PROMPT_MESSAGE = 'Îû≠ÌÇπÏù¥Îûë Ïö∞Ìé∏Ìï®Îì± Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§Îäî Î°úÍ∑∏Ïù∏ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§! Î°úÍ∑∏Ïù∏ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
    const GUEST_OVERWRITE_PROMPT = 'Ïù¥ Í∏∞Í∏∞Ïóê Ï†ÄÏû•Îêú Í≤åÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ÌïòÎ©¥ Í≥ÑÏ†ï Îç∞Ïù¥ÌÑ∞Ïóê ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå? ÌôïÏù∏ÏùÑ ÎàÑÎ•¥Î©¥ ÎçÆÏñ¥Ïì∞Í∏∞, Ï∑®ÏÜåÎ•º ÎàÑÎ•¥Î©¥ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§.';

    function showLoginScreen() {
      hideAllOverlays();
      authContainer.style.display = 'block';
      authContainer.classList.remove('hidden');
      ['top-bar','container'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.visibility = 'hidden';
      });
      setAuthMode('login');
      showAuthStatus('');
      refreshGuestButton();
      updateGuestUiState();
    }

    function requireLoginForFeature() {
      if (uid) return true;
      if (guestMode) {
        const wantsLogin = confirm(LOGIN_PROMPT_MESSAGE);
        if (wantsLogin) {
          try { persistGuestProfile(); } catch {}
          guestAutoStartSuppressed = true;
          guestMode = false;
          updateGuestUiState();
          showLoginScreen();
        }
        return false;
      }
      showAuthStatus('Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©ÌïòÏÑ∏Ïöî.');
      return false;
    }
    window.requireLoginForFeature = requireLoginForFeature;

    tabLogin.addEventListener('click',  () => { hideAllOverlays(); setAuthMode('login');  showAuthStatus(''); });
    tabSignup.addEventListener('click', () => { hideAllOverlays(); setAuthMode('signup'); showAuthStatus(''); });

    guestStartBtn?.addEventListener('click', () => {
      startGuestMode();
    });

    guestLoginBtn?.addEventListener('click', () => {
      if (guestMode) {
        try { persistGuestProfile(); } catch {}
      }
      guestAutoStartSuppressed = true;
      guestMode = false;
      updateGuestUiState();
      showLoginScreen();
    });

    document.getElementById('settings-btn').addEventListener('click', () => {
      try { history.replaceState(null, '', '/ÏÑ§Ï†ï' + (location.hash || '')); } catch {}
      location.href = '/setting.html';
    });

    function handleAuthError(err) {
      const code = err?.code || '';
      if (code === 'auth/user-disabled') {
        security.banned = true;
        securityDirty = true;
        showAuthStatus('‚õî Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞òÏúºÎ°ú Í≥ÑÏ†ïÏù¥ Ï†ïÏßÄÎêòÏóàÏäµÎãàÎã§. Ïò§ÌÉêÏúºÎ°ú ÏùòÏã¨ÎêòÎ©¥ appeals@siustudio.me Î°ú Î©îÏùºÏùÑ Î≥¥ÎÇ¥ Ï£ºÏÑ∏Ïöî.', true);
        try { saveSupportCtx({ banned: true }); } catch {}
        return true;
      }
      return false;
    }

    loginBtn.addEventListener('click', async () => {
      showAuthStatus('');
      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const isPasswordProvider = user && user.providerData.some(p=>p.providerId==='password');

        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('üìß Ïù¥Î©îÏùº Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ïïº Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏûàÏñ¥Ïöî. Î∞õÏùÄ Î©îÏùºÏùò ÎßÅÌÅ¨Î°ú Ïù∏Ï¶ùÌïú Îí§ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', true);
          try { await auth.signOut(); } catch {}
          return;
        }
      } catch (err) {
        if (!handleAuthError(err)) {
          const code = (err && err.code) || '';
          const msg =
            (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials')
              ? 'ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.' :
            code === 'auth/user-not-found'         ? 'Îì±Î°ùÎêú Í≥ÑÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§. ÌöåÏõêÍ∞ÄÏûÖÏùÑ Î®ºÏ†Ä ÏßÑÌñâÌïòÏÑ∏Ïöî.' :
            code === 'auth/invalid-email'          ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
            code === 'auth/network-request-failed' ? 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.' :
            'Î°úÍ∑∏Ïù∏ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§. ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî';
          showAuthStatus(msg);
        }
        guestTransferPreference = 'none';
      }
    });

    async function handleSignup() {
      showAuthStatus('');
      if (verifyInfoEl) {
        verifyInfoEl.textContent = '';
        verifyInfoEl.classList.remove('show');
      }

      const email = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      const pw2 = document.getElementById('password-confirm').value;
      const agreeTerms = document.getElementById('tos-checkbox')?.checked;
      const agreePrivacy = document.getElementById('privacy-checkbox')?.checked;

      if (!email) { showAuthStatus('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      if (!pw || !pw2) { showAuthStatus('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.'); return; }
      if (pw !== pw2) { showAuthStatus('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.'); return; }
      if (!agreeTerms || !agreePrivacy) {
        showAuthStatus('Ïù¥Ïö©ÏïΩÍ¥ÄÍ≥º Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®Ïóê Î™®Îëê ÎèôÏùòÌï¥Ïïº ÌöåÏõêÍ∞ÄÏûÖ Í∞ÄÎä•Ìï©ÎãàÎã§.');
        return;
      }

      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }

      signupBtnEl.disabled = true;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        try { await sendEmailVerification(cred.user); } catch {}
        showAuthStatus('');
        if (verifyInfoEl) {
          verifyInfoEl.textContent = '‚úÖ Í≥ÑÏ†ïÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°Îêú Ïù∏Ï¶ù ÎßÅÌÅ¨Î•º ÌôïÏù∏Ìïú ÌõÑ Î°úÍ∑∏Ïù∏Ìï¥ Ï£ºÏÑ∏Ïöî.';
          verifyInfoEl.classList.add('show');
        }
        try { await auth.signOut(); } catch {}
        setAuthMode('login');
      } catch (err) {
        const code = err?.code || '';
        const msg =
          code === 'auth/email-already-in-use' ? 'Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïù¥Î©îÏùºÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞Î•º Ïù¥Ïö©Ìï¥ Ï£ºÏÑ∏Ïöî.' :
          code === 'auth/invalid-email' ? 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' :
          code === 'auth/weak-password' ? 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÎÑàÎ¨¥ ÏïΩÌï©ÎãàÎã§.' :
          code === 'auth/network-request-failed' ? 'ÎÑ§Ìä∏ÏõåÌÅ¨Í∞Ä Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.' :
          'ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
        showAuthStatus(msg);
        guestTransferPreference = 'none';
      } finally {
        updateSignupAvailability();
      }
    }

    signupBtnEl?.addEventListener('click', async (e) => {
      e.preventDefault();
      await handleSignup();
    });

    tosCheckbox?.addEventListener('change', updateSignupAvailability);
    privacyCheckbox?.addEventListener('change', updateSignupAvailability);
    updateSignupAvailability();
    refreshGuestButton();
    updateGuestUiState();

    // TOS ÎèôÏùò
    const tosAgree = document.getElementById('tos-agree');
    const tosAccept = document.getElementById('tos-accept');
    tosAgree?.addEventListener('change', ()=>{ tosAccept.disabled = !tosAgree.checked; });
    tosAccept?.addEventListener('click', async ()=>{
      security.tosAccepted = true; securityDirty = true;
      if (uid) markLocalTosAccepted(uid);
      await saveSecurity();
      showTosOverlay(false);
      showToast('‚úÖ Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÎêòÏóàÏäµÎãàÎã§. Í≥µÏ†ïÌïú ÌîåÎ†àÏù¥Î•º Î∂ÄÌÉÅÎìúÎ†§Ïöî!', null, null, 3500);
    });

    // Ï†ïÏßÄ Ïò§Î≤ÑÎ†àÏù¥ Î≤ÑÌäºÎì§
    document.getElementById('ban-appeal-email')?.addEventListener('click', ()=>{
      const { mailto } = buildSupportMail();
      location.href = mailto;
    });
    document.getElementById('ban-copy-info')?.addEventListener('click', copySupportInfo);

    // Ï†ïÍ∏∞ ÌÜ†ÌÅ∞ ÌôïÏù∏
    setInterval(async () => {
      try {
        if (auth?.currentUser) {
          await auth.currentUser.getIdToken(true);
        }
      } catch (err) {
        if (handleAuthError(err)) {
          try { await auth.signOut(); } catch {}
        }
      }
    }, 30000);

    // Îç∞Ïù¥ÌÑ∞ Î∞îÏù∏Îî©
    async function proceedWithDataBinding(){
      if (mailboxUnsubscribe) { try { mailboxUnsubscribe(); } catch {} mailboxUnsubscribe = null; }
      mailboxCache = [];
      selectedMailId = null;
      renderMailList();
      renderMailDetail(null);
      updateMailBadges();
      mailboxRef = ref(db, `${userBasePath}/mailbox`);
      mailboxUnsubscribe = onValue(mailboxRef, snap => {
        const raw = snap.exists() ? snap.val() : {};
        const entries = Object.entries(raw || {}).map(([id, mail]) => ({ id, ...(mail || {}) }));
        entries.sort((a, b) => (b.sentAt || 0) - (a.sentAt || 0));
        mailboxCache = entries;
        if (selectedMailId && !mailboxCache.some(m => m.id === selectedMailId)) {
          selectedMailId = null;
        }
        renderMailList();
        const current = selectedMailId ? mailboxCache.find(m => m.id === selectedMailId) : null;
        renderMailDetail(current || null);
        updateMailBadges();
      });
      updateMailComposeVisibility(auth.currentUser || null);

      try {
        const rankSnap = await get(ref(db, `${userBasePath}/meta/rankingUnlocked`));
        rankingUnlocked = !!(rankSnap.exists() ? rankSnap.val() : false);
      } catch { rankingUnlocked = false; }

      dataRef = ref(db, `${userBasePath}/gameData`);
      const shouldApplyGuest = guestTransferPreference === 'overwrite' && hasGuestProfile();
      const guestProfile = shouldApplyGuest ? readGuestProfile() : null;
      isInitialSync = true;
      try {
        const saved = localStorage.getItem(`lastWrite_${uid}`);
        localLastWrite = saved ? parseInt(saved, 10) : 0;
      } catch { localLastWrite = 0; }

      await ensureInitialData(dataRef);
      await loadSecurity();

      saveSupportCtx({ banned: false });

      if (shouldApplyGuest && guestProfile && guestProfile.state) {
        try {
          const now = Date.now();
          const merged = withAutoConvertDefaults(guestProfile.state || {});
          merged._lastUpdated = now;
          await update(dataRef, { ...merged });
          localLastWrite = now;
          try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
          try { localStorage.setItem(`gd_cache_${uid}`, JSON.stringify(merged)); } catch {}
          if (guestProfile.rankingUnlocked && uid && userBasePath) {
            try { await update(ref(db), { [`${userBasePath}/meta/rankingUnlocked`]: true }); }
            catch {}
            rankingUnlocked = true;
          }
        } catch (err) {
          console.error('guest data merge failed', err);
        }
        guestTransferPreference = 'none';
      } else {
        guestTransferPreference = 'none';
      }

      if (pendingGuestCleanup) {
        clearGuestProfile();
        refreshGuestButton();
        pendingGuestRemovalNotice = true;
        pendingGuestCleanup = false;
      }

      const syncStart = Date.now();
      initialSyncStart = syncStart;

      dataUnsubscribe = onValue(dataRef, async snap => {
        const server = snap.exists() ? snap.val() : null;
        const rawStamp = Number(server?._lastUpdated);
        const serverStamp = Number.isFinite(rawStamp) ? rawStamp : 0;
        const loadTime = Date.now() - syncStart;

        // Ïù¥Ï†Ñ ÏΩîÎìúÏóêÏÑú Ïó¨Í∏∞ÏÑú auditFreeze(...) ÌïòÎçò Í±∞ Ï†ÑÎ∂Ä Ï†úÍ±∞
        if (loadTime > 3000 && !networkUnstableShown) {
          networkUnstableShown = true;
        }

        if (isInitialSync) {
          state = withAutoConvertDefaults(server);

          // Ïù¥ Î∂ÄÎ∂ÑÎèÑ Ïù¥Ï†ú freeze Ïïà Ìï®
          await fetchDaily();

          if (window.__PLAY_ALLOWED) { updateUI(true); renderPlanets(); }
          isInitialSync = false;
          showGameUI();

          try { localStorage.setItem('boot_seen', '1'); } catch {}

          window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();
          await checkDailyAndMaybeShow();
          updateAttendanceLabels();
          bootDone = true;
          lastSyncedServerStamp = serverStamp || 0;
          auditInit();
          renderSecurityBadge();
          maybeNotifyGuestRemoval();

          if (!security.tosAccepted){ showTosOverlay(true); }
          if (security.banned){ return; }
          return;
        }

        if (!server) {
          state = withAutoConvertDefaults();
        } else {
          const serverLast = serverStamp;
          if (serverLast >= (localLastWrite || 0)) {
            state = withAutoConvertDefaults(server);
          } else {
            state = withAutoConvertDefaults({ ...server, ...state });
            try { if (JSON.stringify(server) !== JSON.stringify(state)) save(true); }
            catch { save(true); }
          }
        }
        const prevSynced = lastSyncedServerStamp || 0;
        const isNewServerState = serverStamp && serverStamp !== prevSynced;
        const remoteMutation = isNewServerState && serverStamp > (localLastWrite || 0);
        if (window.__PLAY_ALLOWED) { updateUI(true); renderPlanets(); }
        if (remoteMutation) {
          auditInit();
          auditIntent = { res:0, coin:0, eco:0, until:0 };
          localLastWrite = serverStamp;
          try { localStorage.setItem(`lastWrite_${uid}`, String(serverStamp)); } catch {}
        }
        lastSyncedServerStamp = serverStamp || prevSynced;
      });
    }

    onAuthStateChanged(auth, async user => {
      sessionLogger?.log?.(user
        ? `Ïù∏Ï¶ù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏: ${(user.email || user.uid || 'unknown')}`
        : 'Ïù∏Ï¶ùÏù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.');
      hideAllOverlays();
      setBootVisible(false);
      showAuthStatus('');
      if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }
      if (mailboxUnsubscribe) { try{ mailboxUnsubscribe(); }catch{} mailboxUnsubscribe=null; }
      subscribePickaxePerk(null, null);
      mailboxRef = null;
      mailboxCache = [];
      selectedMailId = null;
      renderMailList();
      renderMailDetail(null);
      updateMailBadges();
      closeMailOverlay();
      updateMailComposeVisibility(null);

      if (user) {
        guestMode = false;
        guestAutoStartSuppressed = false;
        clearSupportCtx();
        hideAllOverlays();
        security.banned = false;
        updateGuestUiState();

        if (hasGuestProfile()) {
          pendingGuestCleanup = true;
        }

        const isPasswordProvider = (user.providerData || []).some(p => p.providerId === 'password');
        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('üìß Ïù¥Î©îÏùº Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌï¥Ïïº Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏûàÏñ¥Ïöî. Î∞õÏùÄ Î©îÏùºÏùò ÎßÅÌÅ¨Î°ú Ïù∏Ï¶ùÌïú Îí§ Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', true);
          try { await auth.signOut(); } catch {}
          return;
        }

        uid = user.uid;
        window.__CURRENT_USER_EMAIL = user.email || '';
        try {
          window.__DEVTOOL_GUARD?.onAuthEmailChange?.(window.__CURRENT_USER_EMAIL);
        } catch {}
        window.__CURRENT_USER_UID = uid;
        if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.activate === 'function') {
          try { window.__SESSION_LOCK__.activate(uid); }
          catch (err) { console.warn('ÏÑ∏ÏÖò Ïû†Í∏à ÌôúÏÑ±ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', err); }
        }
        loadBuffs();
        renderBuffStatus();
        updateMailComposeVisibility(user);

        try {
          const cacheRaw = localStorage.getItem(`gd_cache_${uid}`);
          if (cacheRaw) {
            const cached = JSON.parse(cacheRaw);
            state = withAutoConvertDefaults({ ...state, ...cached });
            showGameUI();
            updateUI();
            renderPlanets();
            bootDone = true;
            maybeNotifyGuestRemoval();
          }
        } catch {}

        let plan = null;
        try {
          plan = await planMigrationForUser(user);
        } catch(e){
          console.error('planMigration error', e);
          const fallbackServer = await allocateServerForUser();
          userServerKey = fallbackServer;
          userIdKey     = makeIdKeyFromUser(user);
          userBasePath  = `users/${userServerKey}/${userIdKey}`;
          subscribePickaxePerk(userServerKey, userIdKey);
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: 'plan-error-fallback'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
          return;
        }
        userServerKey = plan.server;
        userIdKey     = makeIdKeyFromUser(user);
        userBasePath  = `users/${userServerKey}/${userIdKey}`;
        subscribePickaxePerk(userServerKey, userIdKey);

        saveSupportCtx({ banned: false });

        if (plan.need) {
          showMigrateOverlay(true, 'ÎåÄÍ∏∞ Ï§ë‚Ä¶');
          disableMigrateStart(false);
          const startBtn = document.getElementById('migrate-start');
          if (startBtn){
            startBtn.onclick = async ()=>{
              disableMigrateStart(true);
              try{
                await performMigration(plan.srcBasePath, plan.destBasePath, user);
                try {
                  await update(ref(db), {
                    [`userServerMap/${uid}`]: {
                      server: userServerKey,
                      id: userIdKey,
                      displayId: String(user?.email||'') || null,
                      migratedAt: Date.now(),
                      reason: plan.reason
                    }
                  });
                } catch {}
                saveSupportCtx({ banned: false });
                setTimeout(()=>{ showMigrateOverlay(false); proceedWithDataBinding(); }, 600);
              }catch(e){
                console.error('migration failed', e);
                setMigrateProgress('‚ùå ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                disableMigrateStart(false);
              }
            };
          }
        } else {
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: plan.reason || 'auto-assign'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
        }

      } else {
        window.__CURRENT_USER_UID = null;
        window.__CURRENT_USER_EMAIL = '';
        try {
          window.__DEVTOOL_GUARD?.resetBypass?.();
          window.__DEVTOOL_GUARD?.onAuthEmailChange?.('');
        } catch {}
        if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.release === 'function') {
          try { window.__SESSION_LOCK__.release(); }
          catch (err) { console.warn('ÏÑ∏ÏÖò Ïû†Í∏à Ìï¥Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', err); }
        }
        guestMode = false;
        guestTransferPreference = 'none';
        pendingGuestCleanup = false;
        pendingGuestRemovalNotice = false;
        uid = null; dataRef = null;
        userServerKey = null; userIdKey = null; userBasePath = null;
        dailyUnlocked = false; rankingUnlocked = false;
        bootDone = false;

        ensureFx(); window.fx.buffs = [];
        renderBuffStatus();

        security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
        securityDirty = false;
        renderSecurityBadge();

        clearSupportCtx();
        hideAllOverlays();

        state = withAutoConvertDefaults();
        localLastWrite = 0; isInitialSync = false;

        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
        setAuthMode(currentAuthMode);
        refreshGuestButton();
        updateGuestUiState();
      }
    });

    // Î∂ÄÌåÖ Ïò§Î≤ÑÎ†àÏù¥ ÌéòÏùºÏÑ∏Ïù¥ÌîÑ
    setTimeout(() => {
      const stillBooting = bootOverlay && getComputedStyle(bootOverlay).display !== 'none';
      const gameHidden = document.getElementById('container')?.style.visibility !== 'visible';
      if (stillBooting && gameHidden) {
        setBootVisible(false);
        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        showAuthStatus('ÏÑ∏ÏÖò ÌôïÏù∏Ïù¥ ÏßÄÏó∞ÎêòÏñ¥ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôòÌñàÏäµÎãàÎã§.', false);
      }
    }, 4000);

    async function startCodeLoginFlow() {
      const infoEl = document.getElementById('codeInfoText');
      const statusEl = document.getElementById('codeStatus');
      const areaEl = document.getElementById('codeArea');

      if (!infoEl || !statusEl || !areaEl) {
        console.warn('code login elements not found');
        return;
      }

      infoEl.textContent = 'Ïï±(WebView)ÏóêÏÑú Ïô∏Î∂Ä Î∏åÎùºÏö∞Ï†ÄÎ°ú Î°úÍ∑∏Ïù∏Ìï† Îïå Ïì∞Îäî ÏòµÏÖòÏûÖÎãàÎã§.';
      statusEl.textContent = 'Î°úÍ∑∏Ïù∏ Ï∞ΩÏùÑ Ïó¨Îäî Ï§ëÏûÖÎãàÎã§...';

      try {
        const res = await fetch(AUTH_BASE_URL + '/api/login-start', {
          method: 'POST'
        });
        const data = await res.json();

        currentCode = data.code;
        areaEl.style.display = 'block';
        const loginUrl = AUTH_BASE_URL + '/login.html?code=' + encodeURIComponent(currentCode);
        window.open(loginUrl, '_blank');
        statusEl.textContent = 'Î°úÍ∑∏Ïù∏ Ï∞ΩÏùÑ Ïó¥ÏóàÏäµÎãàÎã§. Í≥ÑÏÜç ÏßÑÌñâÌï¥ Ï£ºÏÑ∏Ïöî.';

        startPollingLoginStatus();
      } catch (err) {
        console.error(err);
        alert('ÏΩîÎìú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
      }
    }

    function startPollingLoginStatus() {
      if (!currentCode) return;
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        try {
          const res = await fetch(
            AUTH_BASE_URL + '/api/login-status?code=' + encodeURIComponent(currentCode)
          );
          const data = await res.json();

          const statusEl = document.getElementById('codeStatus');
          if (!statusEl) return;

          if (data.status === 'pending') {
            statusEl.textContent = 'Î°úÍ∑∏Ïù∏ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ëÏûÖÎãàÎã§...';
          } else if (data.status === 'done') {
            clearInterval(pollTimer);
            pollTimer = null;
            statusEl.textContent = 'Î°úÍ∑∏Ïù∏ ÏôÑÎ£å! Í≥ÑÏ†ï Ïó∞Í≤∞ Ï§ë...';

            if (data.customToken) {
              try {
                await signInWithCustomToken(auth, data.customToken);
                statusEl.textContent =
                  'Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§! Í≤åÏûÑÏùÑ Í≥ÑÏÜç ÏßÑÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.';
              } catch (err) {
                console.error(err);
                statusEl.textContent =
                  'Firebase Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
              }
            } else {
              statusEl.textContent = 'ÌÜ†ÌÅ∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
            }
          } else if (data.status === 'expired') {
            clearInterval(pollTimer);
            pollTimer = null;
            statusEl.textContent = 'ÏΩîÎìúÍ∞Ä ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
          } else if (data.status === 'not_found') {
            statusEl.textContent = 'ÏΩîÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
          } else {
            statusEl.textContent = 'Ïïå Ïàò ÏóÜÎäî ÏÉÅÌÉúÏûÖÎãàÎã§: ' + data.status;
          }
        } catch (err) {
          console.error(err);
          const statusEl = document.getElementById('codeStatus');
          if (statusEl) {
            statusEl.textContent =
              'ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÌôïÏù∏Îê©ÎãàÎã§...';
          }
        }
      }, 3000);
    }

    document.getElementById('google-btn').addEventListener('click', async () => {
      showAuthStatus('');
      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }
      const provider = new GoogleAuthProvider();

      try {
        await signInWithRedirect(auth, provider);
      } catch (err) {
        if (handleAuthError(err)) return;
        showAuthStatus('Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        guestTransferPreference = 'none';
      }
    });

    const btnCode = document.getElementById('btnGoogleLoginCode');
    if (btnCode) {
      btnCode.addEventListener('click', startCodeLoginFlow);
    }

    const codeDetailsToggle = document.getElementById('codeDetailsToggle');
    const codeDetails = document.getElementById('codeDetails');
    if (codeDetailsToggle && codeDetails) {
      codeDetailsToggle.addEventListener('click', () => {
        const isVisible = codeDetails.style.display === 'block';
        codeDetails.style.display = isVisible ? 'none' : 'block';
        codeDetailsToggle.textContent = isVisible ? 'ÏûêÏÑ∏Ìûà Î≥¥Í∏∞' : 'Ï†ëÍ∏∞';
      });
    }

    window.addEventListener('load', () => {
      if (window.__PLAY_ALLOWED) wireGame();
      else window.__DEFER_INIT = wireGame;
      renderBuffStatus();
      renderSecurityBadge();
    });

    setInterval(renderBuffStatus, 1000);
    window.openDailyManual = function(){
      if (!uid) {
        if (!requireLoginForFeature()) return;
      }
      checkDailyAndMaybeShow().then(()=>openDailyOverlay());
    }
  </script>

  <script>
    (function(){
      const SHOP_URL = 'https://shop.ÌÉúÏñëÍ≥ÑÏ†ïÎ≥µ.siustudio.me/';
      const overlay = document.getElementById('shop-overlay');
      const frame = document.getElementById('shop-frame');
      const closeBtn = document.getElementById('shop-close');
      if (!overlay || !frame) return;

      function emitShopError(info, extraDetail = null){
        let detail = {};
        if (typeof info === 'string') {
          detail.message = info;
        } else if (info && typeof info === 'object') {
          detail = { ...info };
        }
        if (extraDetail && typeof extraDetail === 'object') {
          detail = { ...detail, ...extraDetail };
        }
        if (!detail.message) {
          detail.message = 'Ïù¥Î≤§Ìä∏ÏΩîÏù∏ Í¥ÄÎ¶¨Î•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
        }
        try {
          window.dispatchEvent(new CustomEvent('shop-open-error', { detail }));
        } catch {
          const fallbackMessage = detail.manualMessage || detail.message;
          try { alert(detail.copyUrl ? `${fallbackMessage}\n${detail.copyUrl}` : fallbackMessage); } catch {}
        }
      }

      function ensureShopLoaded(){
        const current = frame.getAttribute('src');
        if (!current || current === 'about:blank') {
          frame.setAttribute('src', SHOP_URL);
        }
      }

      function isWebAppDisplayMode(){
        const modes = ['standalone', 'minimal-ui', 'fullscreen'];
        try {
          if (navigator.standalone) return true;
        } catch {}
        return modes.some((mode) => {
          try { return window.matchMedia(`(display-mode: ${mode})`).matches; }
          catch { return false; }
        });
      }

      function openShopOverlay(){
        try {
          window.open(SHOP_URL, '_blank', 'noopener,noreferrer');
        } catch {
          location.href = SHOP_URL;
        }
      }

      function closeShopOverlay(){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }

      closeBtn?.addEventListener('click', closeShopOverlay);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeShopOverlay();
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('show')) {
          closeShopOverlay();
        }
      });

      window.openShopOverlay = openShopOverlay;
      window.closeShopOverlay = closeShopOverlay;
    })();
  </script>

  <!-- Ïö∞ÌÅ¥Î¶≠ Ïª§Ïä§ÌÖÄ Î©îÎâ¥ -->
  <script>
    const customMenu = document.getElementById('custom-menu');
    const customDownloadItem = customMenu.querySelector('[data-action="download"]');
    const displayModes = ['standalone', 'minimal-ui', 'fullscreen'];

    const devtoolGuard = window.__DEVTOOL_GUARD = window.__DEVTOOL_GUARD || {};
    if (typeof devtoolGuard.active !== 'boolean') {
      devtoolGuard.active = true;
    }
    devtoolGuard.hideMenu = () => {
      if (customMenu) customMenu.style.display = 'none';
    };

    function isRunningAsWebApp() {
      try {
        if (navigator.standalone) return true;
      } catch {}
      return displayModes.some(mode => {
        try { return window.matchMedia(`(display-mode: ${mode})`).matches; }
        catch { return false; }
      });
    }

    function isEmbeddedContainer() {
      if (isRunningAsWebApp()) return true;
      const ua = (navigator.userAgent || '').toLowerCase();
      if (ua.includes('; wv') || ua.includes(' wv)') || ua.includes('wv)') || /\bwv\b/.test(ua)) return true;
      if (/(iphone|ipad|ipod).+applewebkit(?!.*safari)/i.test(navigator.userAgent || '')) return true;
      if (window.ReactNativeWebView || window.flutter_inappwebview || window.AndroidBridge) return true;
      if (window.Capacitor && window.Capacitor.isNativePlatform) return true;
      try {
        if (window.webkit && window.webkit.messageHandlers) return true;
      } catch {}
      return false;
    }

    const isEmbeddedApp =
      typeof window.__IS_EMBEDDED_APP === 'boolean'
        ? window.__IS_EMBEDDED_APP
        : isEmbeddedContainer();

    window.__IS_EMBEDDED_APP = isEmbeddedApp;
    try { document.documentElement.dataset.embeddedApp = isEmbeddedApp ? '1' : '0'; } catch {}

    if (isEmbeddedApp && customDownloadItem) {
      customDownloadItem.remove();
    }

    const googleBtn = document.getElementById('google-btn');
    const googleCodeBtn = document.getElementById('btnGoogleLoginCode');
    const googleCodeArea = document.getElementById('codeArea');

    if (isEmbeddedApp) {
      if (googleBtn) googleBtn.style.display = 'none';
    } else {
      if (googleCodeBtn) googleCodeBtn.style.display = 'none';
      if (googleCodeArea) googleCodeArea.style.display = 'none';
    }

    const isTouchContextMenu = (e) => {
      return (
        e.pointerType === 'touch' ||
        (typeof PointerEvent !== 'undefined' && e instanceof PointerEvent && e.pointerType === 'touch') ||
        !!e.touches?.length ||
        !!e.changedTouches?.length ||
        !!e.sourceCapabilities?.firesTouchEvents
      );
    };

    const handleContextMenu = (e) => {
      if (devtoolGuard.active === false) {
        devtoolGuard.hideMenu?.();
        return;
      }
      if (isTouchContextMenu(e)) {
        customMenu.style.display = 'none';
        return;
      }
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    };
    window.addEventListener('contextmenu', handleContextMenu);
    devtoolGuard.contextMenuHandler = handleContextMenu;
    customMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('.menu-item');
      const action = btn && btn.getAttribute('data-action');
      if (!action) return;
      if (action === 'menu') {
        try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
        try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
        try { window.close(); } catch {}
        setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
      }
      if (action === 'download') {
        if (window.__IS_EMBEDDED_APP) return;
        const proceed = confirm('Ïï± Îã§Ïö¥Î°úÎìúÎ•º ÏúÑÌï¥ onestore.co.kr ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
        if (proceed) { location.href = 'https://m.onestore.co.kr/v2/ko-kr/app/0001002762'; }
      }
      if (action === 'shop') {
        customMenu.style.display='none';
        try { window.openShopOverlay && window.openShopOverlay(); } catch {}
      }
      if (action === 'resume')   { customMenu.style.display='none'; }
      if (action === 'rank')     {
        customMenu.style.display='none';
        location.href='/ranking.html';
      }
      if (action === 'mail')     { customMenu.style.display='none'; try { window.openMailOverlay && window.openMailOverlay(); } catch {} }
      if (action === 'quests')   { customMenu.style.display='none'; try { window.openQuestOverlay && window.openQuestOverlay(); } catch {} }
      if (action === 'attendance'){ customMenu.style.display='none'; try{ window.openDailyManual(); }catch{} }
    });
    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display='none'; });
  </script>

  <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
  <script>
    (function(){
      const sideToggle = document.getElementById('side-menu-toggle');
      const sideMenu   = document.getElementById('side-menu');
      const backdrop   = document.getElementById('side-backdrop');
      const sideDownloadItem = sideMenu.querySelector('[data-action="download"]');

      if (window.__IS_EMBEDDED_APP && sideDownloadItem) {
        sideDownloadItem.remove();
      }

      function openSide(){
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closeSide(){
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }

      sideToggle.addEventListener('click', openSide);
      backdrop.addEventListener('click', closeSide);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

      sideMenu.addEventListener('click', (e)=>{
        const btn = e.target.closest('.side-item');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'menu') {
          try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
          try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
          try { window.close(); } catch {}
          setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
        }
        if (action === 'download') {
          if (window.__IS_EMBEDDED_APP) { closeSide(); return; }
          const proceed = confirm('Ïï± Îã§Ïö¥Î°úÎìúÎ•º ÏúÑÌï¥ m.onestore.co.kr ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
          if (proceed) { location.href = 'https://m.onestore.co.kr/v2/ko-kr/app/0001002762'; }
        }
        if (action === 'shop')     { try { window.openShopOverlay && window.openShopOverlay(); } catch {} }
        if (action === 'rank')     {
          location.href='/ranking.html';
        }
        if (action === 'mail')     { try { window.openMailOverlay && window.openMailOverlay(); } catch {} }
        if (action === 'quests')   { try { window.openQuestOverlay && window.openQuestOverlay(); } catch {} }
        if (action === 'attendance'){ try{ window.openDailyManual(); }catch{} }
        if (action === 'resume')   { /* Îã´Í∏∞Îßå */ }
        closeSide();
      });
    })();
  </script>

  <!-- ÎîîÎ≤ÑÍ∑∏ ÌÇ¨ -->
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    (function(){
      const devtoolGuard = window.__DEVTOOL_GUARD = window.__DEVTOOL_GUARD || {};
      if (typeof devtoolGuard.active !== 'boolean') {
        devtoolGuard.active = true;
      }

      const devtoolOptions = {
        disableMenu: true,
        disableSelect: true,
        disableCopy: true,
        disableCut: true,
        disablePaste: true,
        clearIntervalWhenDevOpenTrigger: true,
        ondevtoolopen(type, next) {
          try { window.close(); } catch {}
          next();
        },
        ondevtoolclose() { console.warn('DevTools Îã´Ìûò Í∞êÏßÄÎê®'); }
      };

      let guardInterval = null;
      let lastInstance = null;

      const stopInstance = (target) => {
        if (!target) return;
        ['stop','disable','uninstall','destroy','release','pause'].forEach((fn) => {
          try {
            if (typeof target[fn] === 'function') {
              target[fn]();
            }
          } catch {}
        });
      };

      const applyDevtoolGuards = () => {
        if (devtoolGuard.active === false) return;
        try {
          if (typeof DisableDevtool === 'function') {
            const instance = DisableDevtool(devtoolOptions);
            if (instance) {
              lastInstance = instance;
            }
          }
        } catch (err) {
          console.warn('DisableDevtool Ï†ÅÏö© Ï§ë Ïò§Î•ò', err);
        }
      };

      const ensureInterval = () => {
        if (guardInterval || devtoolGuard.active === false) return;
        guardInterval = setInterval(() => {
          if (devtoolGuard.active === false) return;
          applyDevtoolGuards();
        }, 1000);
      };

      const disableGuards = () => {
        if (devtoolGuard.active === false) return;
        devtoolGuard.active = false;
        if (guardInterval) {
          clearInterval(guardInterval);
          guardInterval = null;
        }
        devtoolGuard.hideMenu?.();
        stopInstance(lastInstance);
        stopInstance(typeof DisableDevtool === 'function' ? DisableDevtool : null);
        try { window.oncontextmenu = null; } catch {}
      };

      const enableGuards = () => {
        if (devtoolGuard.active === true) return;
        devtoolGuard.active = true;
        applyDevtoolGuards();
        ensureInterval();
      };

      devtoolGuard.disableGuards = disableGuards;
      devtoolGuard.enableGuards = enableGuards;

      applyDevtoolGuards();
      ensureInterval();

      const ADMIN_EMAILS = new Set(['siu46852579@gmail.com', 'ch3715@gmail.com']);
      devtoolGuard.allowedAdminEmails = ADMIN_EMAILS;
      devtoolGuard.adminBypassGranted = false;
      devtoolGuard.currentEmail = '';

      const normalizeEmail = (email) => (email ? String(email).toLowerCase() : '');

      const evaluateBypass = () => {
        if (devtoolGuard.adminBypassGranted && ADMIN_EMAILS.has(devtoolGuard.currentEmail)) {
          disableGuards();
        } else {
          if (!ADMIN_EMAILS.has(devtoolGuard.currentEmail)) {
            devtoolGuard.adminBypassGranted = false;
          }
          enableGuards();
        }
      };

      devtoolGuard.evaluateBypass = evaluateBypass;

      devtoolGuard.onAuthEmailChange = (email) => {
        devtoolGuard.currentEmail = normalizeEmail(email);
        evaluateBypass();
      };

      devtoolGuard.resetBypass = () => {
        devtoolGuard.adminBypassGranted = false;
        evaluateBypass();
      };

      window.addEventListener('game-admin-auth-success', () => {
        devtoolGuard.adminBypassGranted = true;
        evaluateBypass();
      });

      const initialEmail = normalizeEmail(window.__CURRENT_USER_EMAIL || '');
      if (initialEmail) {
        devtoolGuard.currentEmail = initialEmail;
        evaluateBypass();
      }
    })();
  </script>

  <!-- ÏõêÍ≤© ÏßÄÏõê -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; 
      });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- Firebase Ïª§Îß®Îìú(ÏÑ∏ÏÖò Ï†úÏñ¥) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, query, orderByChild, equalTo, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app2 = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth2 = getAuth(app2);
    const db2   = getDatabase(app2);

    let sessionId = null;

    function setActiveSession(id){
      if (!id) return;
      sessionId = String(id);
      try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}
      bindCommands(sessionId);
      watchSessionEnd(sessionId);
    }

    function bindCommands(id){
      const cmdRef = ref(db2, `sessions/${id}/commands`);
      onChildAdded(cmdRef, (snap) => {
        const cmd = snap.val() || {};
        try {
          if (cmd.type === 'navigate' && cmd.path){
            if (/^https?:\/\//i.test(cmd.path)) {
              const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;
              if (ok) location.assign(cmd.path);
            } else { location.assign(cmd.path); }
          }
          else if (cmd.type === 'click' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){
              el.focus?.(); el.click?.();
              el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window })); }
          }
          else if (cmd.type === 'highlight' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){ const prev = el.style.outline; el.style.outline = '3px solid #00e5ff'; setTimeout(()=>{ el.style.outline = prev; }, 1800); }
          }
        } catch (e) { /* noop */ }
      });
    }

    function watchSessionEnd(id){
      const statusRef = ref(db2, `sessions/${id}/meta/status`);
      onValue(statusRef, (snap) => {
        if (snap.val() === 'ended') {
          try { sessionStorage.removeItem('cobrowse_session_id'); } catch {}
        }
      });
    }

    try { sessionId = sessionStorage.getItem('cobrowse_session_id') || null; } catch {}
    if (sessionId) {
      setActiveSession(sessionId);
    } else {
      onAuthStateChanged(auth2, (user) => {
        if (!user) return;
        const q = query(ref(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));
        onValue(q, (snap) => {
          let latestId = null, latestAt = 0;
          snap.forEach(child => {
            const v = child.val();
            const st = v?.meta?.status;
            const created = v?.meta?.createdAt || 0;
            if (st === 'active' && created > latestAt) { latestAt = created; latestId = child.key; }
          });
          if (latestId) setActiveSession(latestId);
        }, { onlyOnce: true });
      });
    }
  </script>

  <!-- Popup Enforcement (Í∞ÑÏÜå) -->
  <script>
    (function(){
      const gate = document.getElementById('popup-gate');
      const countdownEl = gate ? gate.querySelector('#popup-gate-count') : null;
      const backBtn     = gate ? gate.querySelector('#popup-gate-back') : null;
      const adminBox    = gate ? gate.querySelector('#admin-login') : null;
      const adminIdEl   = adminBox ? adminBox.querySelector('#admin-id') : null;
      const adminPwEl   = adminBox ? adminBox.querySelector('#admin-password') : null;
      const adminSubmit = adminBox ? adminBox.querySelector('#admin-submit') : null;
      const adminError  = adminBox ? adminBox.querySelector('#admin-error') : null;
      const adminProgress = adminBox ? adminBox.querySelector('#admin-progress') : null;

      const ADMIN_CREDENTIALS = {
        idSalt: 'X1$!v3-admin-id-salt-2025-03-17',
        pwSalt: 'X1$!v3-admin-pw-salt-2025-03-17',
        idHash: 'Z9LHQ1IPWlcTzPmUaXfiz3MgvKuzy+l7HiPa6B9wZmY=',
        pwHash: '7gefwrVRx5cPp/arcudKhxqszjKRIGLFdOT51zijaSs='
      };

      const textEncoder = new TextEncoder();

      const base64FromBuffer = (buffer) => {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        bytes.forEach((b) => { binary += String.fromCharCode(b); });
        return btoa(binary);
      };

      const secureCompare = (a, b) => {
        if (typeof a !== 'string' || typeof b !== 'string') return false;
        if (a.length !== b.length) return false;
        let diff = 0;
        for (let i = 0; i < a.length; i += 1) {
          diff |= a.charCodeAt(i) ^ b.charCodeAt(i);
        }
        return diff === 0;
      };

      const digestWithSalt = async (value, salt) => {
        if (!window.crypto || !window.crypto.subtle) {
          console.error('Web Crypto API is not available for admin credential verification.');
          return null;
        }
        const data = textEncoder.encode(`${salt}${value}`);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return base64FromBuffer(digest);
      };

      const verifyAdmin = async (user, pass) => {
        if (!user || !pass) return false;
        try {
          const [idHash, pwHash] = await Promise.all([
            digestWithSalt(user, ADMIN_CREDENTIALS.idSalt),
            digestWithSalt(pass, ADMIN_CREDENTIALS.pwSalt)
          ]);
          if (!idHash || !pwHash) return false;
          return secureCompare(idHash, ADMIN_CREDENTIALS.idHash) &&
                 secureCompare(pwHash, ADMIN_CREDENTIALS.pwHash);
        } catch (error) {
          console.error('Failed to verify admin credentials securely:', error);
          return false;
        }
      };

      window.__verifyGameAdmin = verifyAdmin;

      const notifyAdminAuthSuccess = (context) => {
        try {
          window.dispatchEvent(new CustomEvent('game-admin-auth-success', {
            detail: { context }
          }));
        } catch (err) {
          console.warn('Failed to dispatch admin auth success event', err);
        }
      };

      if (typeof window.__PLAY_DUP_LOCK_ACTIVE !== 'boolean') {
        window.__PLAY_DUP_LOCK_ACTIVE = false;
      }
      if (typeof window.__PLAY_BASE_ALLOWED !== 'boolean') {
        window.__PLAY_BASE_ALLOWED = false;
      }

      function isMobileStrict(){
        try { if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') return navigator.userAgentData.mobile; } catch {}
        const ua = navigator.userAgent || '';
        if (/(Android|iPhone|iPad|iPod|Windows Phone|BlackBerry|IEMobile|Mobile)/i.test(ua)) return true;
        if (/Mac/.test(navigator.platform || '') && (navigator.maxTouchPoints || 0) > 1) return true;
        const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
        const canHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
        return (coarse && !canHover);
      }
      function isPopup(){
        try { if (window.opener && !window.opener.closed) return true; } catch {}
        try { if (['gameWindow','siuGame','popup'].includes(window.name)) return true; } catch {}
        return false;
      }

      const revealGame = () => {
        window.__PLAY_BASE_ALLOWED = true;
        window.__PLAY_ALLOWED = window.__PLAY_DUP_LOCK_ACTIVE ? false : true;
        ['top-bar','container'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.visibility = 'visible';
        });
        if (gate) {
          gate.classList.remove('show');
          gate.setAttribute('aria-hidden', 'true');
        }
        if (typeof window.__DEFER_INIT === 'function') {
          try { window.__DEFER_INIT(); }
          catch (e) { console.error(e); }
          window.__DEFER_INIT = null;
        }
      };

      const playAllowed = isMobileStrict() || isPopup();
      window.__PLAY_BASE_ALLOWED = playAllowed;
      window.__PLAY_ALLOWED = playAllowed && !window.__PLAY_DUP_LOCK_ACTIVE;

      if (playAllowed) {
        revealGame();
        return;
      }

      const redirect = () => { window.location.href = '/index.html'; };

      if (!gate) {
        alert('ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏñ¥ Í≤åÏûÑÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§. Î©îÎâ¥ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
        redirect();
        return;
      }

      gate.classList.add('show');
      gate.setAttribute('aria-hidden', 'false');

      let remaining = 5;
      let countdownTimer = null;
      if (countdownEl) countdownEl.textContent = String(remaining);

      const stopCountdown = () => {
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      };

      const startCountdown = () => {
        stopCountdown();
        countdownTimer = setInterval(() => {
          remaining -= 1;
          if (remaining < 0) remaining = 0;
          if (countdownEl) countdownEl.textContent = String(remaining);
          if (remaining <= 0) {
            stopCountdown();
            redirect();
          }
        }, 1000);
      };

      startCountdown();

      const goHome = () => {
        stopCountdown();
        redirect();
      };

      let holdTimer = null;
      let holdActivated = false;
      let suppressClick = false;

      const showAdminLogin = () => {
        if (!adminBox) return;
        stopCountdown();
        adminBox.classList.add('show');
        adminBox.setAttribute('aria-hidden', 'false');
        adminError && (adminError.textContent = '');
        setTimeout(() => { adminIdEl && adminIdEl.focus(); }, 60);
      };

      const startHold = () => {
        if (!adminBox) return;
        if (holdTimer) clearTimeout(holdTimer);
        holdActivated = false;
        holdTimer = setTimeout(() => {
          holdActivated = true;
          suppressClick = true;
          showAdminLogin();
        }, 2000);
      };

      const cancelHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        if (!holdActivated) {
          suppressClick = false;
        }
        holdActivated = false;
      };

      const showAdminFailureAlert = (context) => {
        const suffix = Math.floor(1000 + Math.random() * 9000);
        const code = `ADM-${context}-${suffix}`;
        const message = `[${code}] Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ùÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. ÏûÖÎ†• Ï†ïÎ≥¥Î•º Îã§Ïãú ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.`;
        if (adminError) adminError.textContent = message;
        alert(`${message}\n\nÏò§Î•òÍ∞Ä Í≥ÑÏÜçÎêòÎ©¥ ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.`);
        return code;
      };

      const startProgress = async (task) => {
        if (!adminProgress || !adminSubmit || !adminIdEl || !adminPwEl) {
          try {
            await task();
          } catch (error) {
            console.error('Admin verification error:', error);
          }
          return;
        }
        if (adminSubmit.disabled) return;
        const seconds = 10 + Math.floor(Math.random() * 11);
        let dots = 0;
        adminProgress.classList.add('show');
        adminProgress.textContent = 'Login in progress';
        adminSubmit.disabled = true;
        adminIdEl.disabled = true;
        adminPwEl.disabled = true;
        const dotTimer = setInterval(() => {
          dots = (dots + 1) % 4;
          adminProgress.textContent = 'Login in progress' + '.'.repeat(dots);
        }, 420);
        await new Promise((resolve) => setTimeout(resolve, seconds * 1000));
        try {
          await task();
        } catch (error) {
          console.error('Admin verification error (async):', error);
        } finally {
          clearInterval(dotTimer);
          adminProgress.classList.remove('show');
          adminProgress.textContent = '';
          adminSubmit.disabled = false;
          adminIdEl.disabled = false;
          adminPwEl.disabled = false;
        }
      };

      const handleAdminSubmit = () => {
        if (!adminIdEl || !adminPwEl || !adminError) return;
        const user = adminIdEl.value.trim();
        const pass = adminPwEl.value;
        if (!user || !pass) {
          adminError.textContent = 'ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.';
          return;
        }
        adminError.textContent = '';
        startProgress(async () => {
          try {
            const ok = await verifyAdmin(user, pass);
            if (ok) {
              adminIdEl.value = '';
              adminPwEl.value = '';
              adminBox && adminBox.classList.remove('show');
              adminBox && adminBox.setAttribute('aria-hidden', 'true');
              alert('login succesful');
              notifyAdminAuthSuccess('popup-gate');
              revealGame();
            } else {
              const code = showAdminFailureAlert('POP');
              adminPwEl.value = '';
              adminPwEl.focus();
              window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'popup-gate', code } }));
            }
          } catch (error) {
            console.error('Admin verification error:', error);
            const suffix = Math.floor(1000 + Math.random() * 9000);
            const code = `ADM-POP-${suffix}`;
            const message = `[${code}] ÏãúÏä§ÌÖú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.`;
            if (adminError) adminError.textContent = message;
            alert(`${message}\n\nÎ¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.`);
            adminPwEl.value = '';
            adminPwEl.focus();
            window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'popup-gate', code, fatal: true } }));
          }
        });
      };

      if (adminSubmit) {
        adminSubmit.addEventListener('click', handleAdminSubmit);
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleAdminSubmit();
          }
        });
      }
      if (adminIdEl) {
        adminIdEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }

      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.code === 'Digit1') {
          e.preventDefault();
          showAdminLogin();
        }
      });

      backBtn && backBtn.addEventListener('mousedown', startHold);
      backBtn && backBtn.addEventListener('touchstart', startHold, { passive: true });
      backBtn && backBtn.addEventListener('mouseup', cancelHold);
      backBtn && backBtn.addEventListener('mouseleave', cancelHold);
      backBtn && backBtn.addEventListener('touchend', cancelHold);
      backBtn && backBtn.addEventListener('touchcancel', cancelHold);

      backBtn && backBtn.addEventListener('click', (e) => {
        if (suppressClick) {
          e.preventDefault();
          suppressClick = false;
          return;
        }
        goHome();
      });
    })();
  </script>

  <!-- Ï§ëÎ≥µ Ïã§Ìñâ Í∞êÏßÄ & Í¥ÄÎ¶¨Ïûê ÏòàÏô∏ -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, runTransaction, update, remove, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const sessionApp = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const sessionDb  = getDatabase(sessionApp);

    (function(){
      const overlay      = document.getElementById('session-lock-overlay');
      const statusEl     = document.getElementById('session-lock-status');
      const retryBtn     = document.getElementById('session-lock-retry');
      const adminToggle  = document.getElementById('session-lock-admin-toggle');
      const adminBox     = document.getElementById('session-lock-admin');
      const adminIdEl    = document.getElementById('session-admin-id');
      const adminPwEl    = document.getElementById('session-admin-password');
      const adminSubmit  = document.getElementById('session-admin-submit');
      const adminError   = document.getElementById('session-admin-error');
      const adminProgress= document.getElementById('session-admin-progress');
      const titleEl      = document.getElementById('session-lock-title');
      const descEl       = document.getElementById('session-lock-desc');
      const noteEl       = document.getElementById('session-lock-note');
      const remoteLogoutBtn = document.getElementById('session-lock-remote-logout');
      const hardBlockOverlay  = document.getElementById('js-hard-block-overlay');
      const hardBlockTitleEl  = document.getElementById('js-hard-block-title');
      const hardBlockDescEl   = document.getElementById('js-hard-block-desc');
      const hardBlockDeviceEl = document.getElementById('js-hard-block-device');
      const hardBlockErrorEl  = document.getElementById('js-hard-block-error');
      const hardBlockReloadBtn= document.getElementById('js-hard-block-reload');

      if (!overlay) {
        window.__SESSION_LOCK__ = {
          activate(){},
          release(){},
          bypass(){},
          openAdminPanel(){},
        };
        return;
      }

      if (typeof window.__PLAY_DUP_LOCK_ACTIVE !== 'boolean') {
        window.__PLAY_DUP_LOCK_ACTIVE = false;
      }
      if (typeof window.__PLAY_BASE_ALLOWED !== 'boolean') {
        window.__PLAY_BASE_ALLOWED = (typeof window.__PLAY_ALLOWED === 'boolean') ? window.__PLAY_ALLOWED : true;
      }

      const LOCK_TITLES = {
        local: 'Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù∏ Ï∞ΩÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§',
        remote: 'Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§'
      };
      const LOCK_NOTES = {
        local: 'Îã§Î•∏ Ï∞ΩÏùÑ Îã´ÏùÄ Îí§ "Îã§Ïãú ÏãúÎèÑ" Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï£ºÏÑ∏Ïöî.',
        remote: 'Îã§Î•∏ Í∏∞Í∏∞ÎÇò Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Ïù¥ Í≥ÑÏ†ïÏù¥ Ïó¥Î†§ ÏûàÏäµÎãàÎã§. Î¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ "ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ"ÏùÑ ÎàåÎü¨ Í∞ïÏ†úÎ°ú Ï¢ÖÎ£åÌï† Ïàò ÏûàÏäµÎãàÎã§.'
      };
      const REMOTE_SESSION_PATH   = 'remoteSessions';
      const REMOTE_HEARTBEAT_MS   = 5000;
      const REMOTE_STALE_MS       = 15000;
      const REMOTE_RETRY_INTERVAL = 4000;

      const LOCK_PREFIX        = 'siu_game_lock_';
      const HEARTBEAT_INTERVAL = 3500;
      const STALE_THRESHOLD    = 12000;
      const RETRY_INTERVAL     = 4000;

      const now = () => Date.now();
      const makeToken = () => `${now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
      const ensureDeviceId = () => {
        let id = null;
        try { id = localStorage.getItem('siu_device_id'); }
        catch {}
        if (!id) {
          id = `dev_${Math.random().toString(36).slice(2, 10)}`;
          try { localStorage.setItem('siu_device_id', id); } catch {}
        }
        return id;
      };
      const describeDevice = () => {
        const ua = (navigator.userAgent || '').split(')')[0] || '';
        const platform = navigator.platform || '';
        return [platform, ua].filter(Boolean).join(' ¬∑ ').slice(0, 80) || 'Îã§Î•∏ Í∏∞Í∏∞';
      };

      let currentUid        = null;
      let token             = null;
      let hasLock           = false;
      let bypassed          = false;
      let heartbeatTimer    = null;
      let retryTimer        = null;
      let listenersAttached = false;
      let localBlockActive  = false;

      let remoteUid               = null;
      let remoteToken             = null;
      let remoteRef               = null;
      let remoteClaimed           = false;
      let remoteHeartbeatTimer    = null;
      let remoteRetryTimer        = null;
      let remoteDisconnectHandle  = null;
      let remoteInfo              = null;
      let remoteBlocked           = false;
      let remoteLogoutPending     = false;
      let remoteValueUnsubscribe  = null;
      const remoteDeviceId        = ensureDeviceId();
      const remoteLogoutLabel     = remoteLogoutBtn ? (remoteLogoutBtn.textContent || 'ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ') : 'ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ';

      const describeElapsed = (timestamp) => {
        if (!Number.isFinite(timestamp)) return null;
        const diff = now() - timestamp;
        if (!Number.isFinite(diff) || diff < 0) return null;
        if (diff < 1500) return 'Î∞©Í∏à Ï†Ñ';
        const seconds = Math.floor(diff / 1000);
        if (seconds < 60) return `${seconds}Ï¥à Ï†Ñ`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}Î∂Ñ Ï†Ñ`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}ÏãúÍ∞Ñ Ï†Ñ`;
        const days = Math.floor(hours / 24);
        return `${days}Ïùº Ï†Ñ`;
      };
      const describeHardBlockDevice = (info) => {
        const label = (info && info.deviceLabel) ? info.deviceLabel : 'Îã§Î•∏ Í∏∞Í∏∞';
        const ts = info?.updatedAt || info?.ts || null;
        const phrase = describeElapsed(ts);
        return phrase ? `${label} ¬∑ ${phrase} ÌôúÎèô` : label;
      };
      const makeHardBlockErrorCode = () => `MULTI-SESSION-${Math.floor(1000 + Math.random() * 9000)}`;
      const disableTimingApis = () => {
        try {
          const highest = window.setTimeout(() => {}, 0);
          for (let id = highest; id >= 0; id -= 1) {
            clearTimeout(id);
            clearInterval(id);
          }
        } catch {}
        try {
          window.setTimeout = () => 0;
          window.setInterval = () => 0;
        } catch {}
        try {
          window.requestAnimationFrame = () => 0;
        } catch {}
        try {
          window.requestIdleCallback = () => 0;
        } catch {}
      };
      const disableNetworkApis = () => {
        try {
          const rejected = () => Promise.reject(new Error('js blocked by multi-device guard'));
          if (typeof window.fetch === 'function') {
            window.fetch = rejected;
          }
        } catch {}
        try {
          const BlockedXHR = function () {
            throw new Error('XMLHttpRequest blocked');
          };
          BlockedXHR.prototype = window.XMLHttpRequest ? window.XMLHttpRequest.prototype : {};
          window.XMLHttpRequest = BlockedXHR;
        } catch {}
        try {
          if (navigator.sendBeacon) {
            navigator.sendBeacon = () => false;
          }
        } catch {}
      };
      const showHardBlockOverlay = (info = {}) => {
        if (!hardBlockOverlay) return;
        const source = info?.blockSource === 'local' ? 'local' : 'remote';
        if (hardBlockTitleEl) {
          hardBlockTitleEl.textContent = source === 'local'
            ? 'Í∞ôÏùÄ Í∏∞Í∏∞ÏóêÏÑú Ï§ëÎ≥µ Ïã§ÌñâÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§'
            : 'Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú Ïã§ÌñâÏù¥ Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§';
        }
        if (hardBlockDeviceEl) {
          if (source === 'local') {
            const ts = info?.ts || info?.updatedAt || null;
            const phrase = describeElapsed(ts);
            hardBlockDeviceEl.textContent = phrase
              ? `ÌòÑÏû¨ Í∏∞Í∏∞ ¬∑ ${phrase} ÌôúÎèô`
              : 'ÌòÑÏû¨ Í∏∞Í∏∞';
          } else {
            hardBlockDeviceEl.textContent = describeHardBlockDevice(info);
          }
        }
        if (hardBlockDescEl) {
          if (source === 'local') {
            hardBlockDescEl.textContent = 'Í∞ôÏùÄ Í∏∞Í∏∞ÏóêÏÑú ÎèôÏùº Í≥ÑÏ†ïÏù¥ Ïó¨Îü¨ Ï∞ΩÏóêÏÑú Ïã§ÌñâÎêòÏñ¥ ÌòÑÏû¨ Ï∞ΩÏùò Ïä§ÌÅ¨Î¶ΩÌä∏Î•º ÏôÑÏ†ÑÌûà Ï§ëÎã®ÌñàÏäµÎãàÎã§. Î™®Îì† Ï∞ΩÏùÑ Îã´ÏùÄ Îí§ ÏÉàÎ°úÍ≥†Ïπ®Ìï¥ Ï£ºÏÑ∏Ïöî.';
          } else {
            const ts = info?.updatedAt || info?.ts || null;
            const phrase = describeElapsed(ts);
            const device = (info && info.deviceLabel) ? info.deviceLabel : 'Îã§Î•∏ Í∏∞Í∏∞';
            const timeText = phrase ? `${phrase} ` : '';
            hardBlockDescEl.textContent = `${timeText}${device}ÏóêÏÑú ÏÉàÎ°úÏö¥ Ï†ëÏÜçÏù¥ Í∞êÏßÄÎêòÏñ¥ ÌòÑÏû¨ Ï∞ΩÏùò Ïã§ÌñâÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§. Í∞ôÏùÄ Í≥ÑÏ†ïÏù¥ Ïó¨Îü¨ Ï∞ΩÏóêÏÑú ÎèôÏãúÏóê Ïó¥Î¶¨Î©¥ Ïù¥Ïö©ÏïΩÍ¥Ä ÏúÑÎ∞òÏúºÎ°ú Í∞ÑÏ£ºÎê† Ïàò ÏûàÏñ¥Ïöî. Ïò§ÌÉêÏùÑ ÌîºÌïòÍ∏∞ ÏúÑÌï¥ Ìïú Î≤àÏóê ÌïòÎÇòÏùò Ï∞ΩÎßå ÌóàÏö©ÌïòÍ≥† ÏûàÏúºÎãà ÎÑàÍ∑∏ÎüΩÍ≤å ÏñëÌï¥ Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§. ÎßåÏïΩ Ïò§Î•òÍ∞Ä ÏÉùÍ∏∞Î©¥ support@siustudio.meÎ°ú Î¨∏ÏùòÌïòÏó¨ Ï£ºÏã≠ÏãúÏò§.`;
          }
        }
        if (hardBlockErrorEl) {
          const code = info?.errorCode || makeHardBlockErrorCode();
          hardBlockErrorEl.textContent = `Ïò§Î•ò ÏΩîÎìú: ${code}`;
        }
        hardBlockOverlay.classList.add('show');
        hardBlockOverlay.setAttribute('aria-hidden', 'false');
      };
      const runDeferredInitIfReady = () => {
        if (!hasLock) return;
        if (remoteBlocked) return;
        if (typeof window.__DEFER_INIT === 'function') {
          const fn = window.__DEFER_INIT;
          window.__DEFER_INIT = null;
          try { fn(); }
          catch (err) { console.error('ÏßÄÏó∞Îêú Ï¥àÍ∏∞ÌôîÎ•º Ïã§ÌñâÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err); }
        }
      };
      const updateRemoteLogoutVisibility = () => {
        if (!remoteLogoutBtn) return;
        if (remoteBlocked) {
          remoteLogoutBtn.style.display = 'inline-flex';
        } else {
          remoteLogoutBtn.style.display = 'none';
        }
        remoteLogoutBtn.disabled = !!remoteLogoutPending;
        remoteLogoutBtn.textContent = remoteLogoutPending ? 'ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ Ï§ë‚Ä¶' : remoteLogoutLabel;
      };
      const updateLockTexts = () => {
        const mode = remoteBlocked ? 'remote' : 'local';
        if (titleEl) titleEl.textContent = LOCK_TITLES[mode] || LOCK_TITLES.local;
        if (noteEl) noteEl.textContent = LOCK_NOTES[mode] || LOCK_NOTES.local;
        updateRemoteLogoutVisibility();
      };

      const getKey = (uid) => `${LOCK_PREFIX}${uid}`;
      const parseValue = (value) => {
        if (!value) return null;
        try { return JSON.parse(value); }
        catch (err) {
          console.warn('ÏÑ∏ÏÖò Ïû†Í∏à Ï†ïÎ≥¥Î•º Ìï¥ÏÑùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err);
          return null;
        }
      };
      const readLock = () => {
        if (!currentUid) return null;
        try { return parseValue(localStorage.getItem(getKey(currentUid))); }
        catch (err) {
          console.warn('ÏÑ∏ÏÖò Ïû†Í∏à Ï†ïÎ≥¥Î•º ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', err);
          return null;
        }
      };
      const writeLock = () => {
        if (!currentUid || !token) return;
        const payload = JSON.stringify({ token, ts: now() });
        try { localStorage.setItem(getKey(currentUid), payload); }
        catch (err) { console.warn('ÏÑ∏ÏÖò Ïû†Í∏à Ï†ïÎ≥¥Î•º Ï†ÄÏû•Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', err); }
      };
      const removeLockIfOwned = () => {
        if (!currentUid || !token) return;
        try {
          const raw = localStorage.getItem(getKey(currentUid));
          const parsed = parseValue(raw);
          if (parsed && parsed.token && parsed.token !== token) return;
          localStorage.removeItem(getKey(currentUid));
        } catch (err) {
          console.warn('ÏÑ∏ÏÖò Ïû†Í∏àÏùÑ Ìï¥Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.', err);
        }
      };

      const overlayShow = () => {
        updateLockTexts();
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      };
      const overlayHide = () => {
        if (remoteBlocked || localBlockActive) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        if (statusEl) statusEl.textContent = '';
        if (adminBox) {
          adminBox.classList.remove('show');
          adminBox.setAttribute('aria-hidden', 'true');
        }
      };

      const updateStatus = (info) => {
        if (!statusEl) return;
        if (remoteBlocked) {
          const updatedTs = info?.updatedAt || info?.ts || null;
          const phrase = updatedTs ? describeElapsed(updatedTs) : null;
          const device = (info && info.deviceLabel) ? info.deviceLabel : 'Îã§Î•∏ Í∏∞Í∏∞';
          statusEl.textContent = phrase
            ? `${device}ÏóêÏÑú ${phrase} ÌôúÎèôÌñàÏäµÎãàÎã§.`
            : `${device}ÏóêÏÑú Ï†ëÏÜç Ï§ëÏûÖÎãàÎã§.`;
          return;
        }
        if (!info || !info.ts) {
          statusEl.textContent = 'Îã§Î•∏ Ï∞ΩÏùÑ Îã´ÏùÄ Îí§ "Îã§Ïãú ÏãúÎèÑ"Î•º ÎàåÎü¨ Ï£ºÏÑ∏Ïöî.';
          return;
        }
        const phrase = describeElapsed(info.ts);
        statusEl.textContent = phrase
          ? `Îã§Î•∏ Ï∞ΩÏóêÏÑú ${phrase} ÌôúÎèôÌñàÏäµÎãàÎã§.`
          : 'Îã§Î•∏ Ï∞ΩÏù¥ Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§.';
      };

      const applyPlayState = () => {
        const base = (typeof window.__PLAY_BASE_ALLOWED === 'boolean')
          ? window.__PLAY_BASE_ALLOWED
          : (typeof window.__PLAY_ALLOWED === 'boolean' ? window.__PLAY_ALLOWED : true);
        if (remoteBlocked) {
          window.__PLAY_DUP_LOCK_ACTIVE = true;
          window.__PLAY_ALLOWED = false;
          return;
        }
        if (!currentUid || bypassed) {
          window.__PLAY_DUP_LOCK_ACTIVE = false;
          window.__PLAY_ALLOWED = base;
          return;
        }
        if (hasLock) {
          window.__PLAY_DUP_LOCK_ACTIVE = false;
          window.__PLAY_ALLOWED = base;
        } else {
          window.__PLAY_DUP_LOCK_ACTIVE = true;
          window.__PLAY_ALLOWED = false;
        }
      };

      const stopHeartbeat = () => {
        if (heartbeatTimer) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
        }
      };
      const startHeartbeat = () => {
        stopHeartbeat();
        if (!currentUid || !token || !hasLock || bypassed) return;
        writeLock();
        heartbeatTimer = setInterval(() => {
          if (!currentUid || !hasLock || bypassed) {
            stopHeartbeat();
            return;
          }
          writeLock();
        }, HEARTBEAT_INTERVAL);
      };

      const stopRetry = () => {
        if (retryTimer) {
          clearInterval(retryTimer);
          retryTimer = null;
        }
      };
      const stopRemoteHeartbeat = () => {
        if (remoteHeartbeatTimer) {
          clearInterval(remoteHeartbeatTimer);
          remoteHeartbeatTimer = null;
        }
      };
      const startRemoteHeartbeat = () => {
        stopRemoteHeartbeat();
        if (!remoteClaimed || !remoteRef) return;
        const beat = async () => {
          if (!remoteClaimed || !remoteRef) return;
          try { await update(remoteRef, { updatedAt: now() }); }
          catch (err) { console.warn('ÏõêÍ≤© ÏÑ∏ÏÖò ÌïòÌä∏ÎπÑÌä∏Î•º Í∞±Ïã†ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err); }
        };
        beat();
        remoteHeartbeatTimer = setInterval(beat, REMOTE_HEARTBEAT_MS);
      };
      const stopRemoteRetry = () => {
        if (remoteRetryTimer) {
          clearInterval(remoteRetryTimer);
          remoteRetryTimer = null;
        }
      };
      const detachRemoteWatcher = () => {
        if (remoteValueUnsubscribe) {
          try { remoteValueUnsubscribe(); }
          catch {}
          remoteValueUnsubscribe = null;
        }
      };
      const handleRemoteValueChange = (snap) => {
        if (!snap || remoteBlocked || !remoteToken) return;
        const data = typeof snap.val === 'function' ? snap.val() : null;
        if (!data) {
          if (remoteUid && remoteClaimed) {
            attemptRemoteClaim();
          }
          return;
        }
        if (data.token && data.token !== remoteToken) {
          setRemoteBlockedState(true, data);
        }
      };
      const attachRemoteWatcher = () => {
        if (!remoteRef || remoteValueUnsubscribe) return;
        try {
          remoteValueUnsubscribe = onValue(
            remoteRef,
            handleRemoteValueChange,
            (err) => console.warn('ÏõêÍ≤© ÏÑ∏ÏÖò Î™®ÎãàÌÑ∞ÎßÅ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', err)
          );
        } catch (err) {
          console.warn('ÏõêÍ≤© ÏÑ∏ÏÖò Î™®ÎãàÌÑ∞ÎßÅÏùÑ ÏãúÏûëÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err);
        }
      };
      const scheduleRemoteRetry = () => {
        if (remoteRetryTimer) return;
        remoteRetryTimer = setInterval(() => {
          if (!remoteUid) {
            stopRemoteRetry();
            return;
          }
          attemptRemoteClaim();
        }, REMOTE_RETRY_INTERVAL);
      };
      function hardBlockJsExecution(info) {
        if (window.__GAME_JS_HARD_BLOCKED) return;
        window.__GAME_JS_HARD_BLOCKED = true;
        try { stopHeartbeat(); } catch {}
        try { stopRetry(); } catch {}
        try { stopRemoteHeartbeat(); } catch {}
        try { stopRemoteRetry(); } catch {}
        disableTimingApis();
        disableNetworkApis();
        const enrichedInfo = info && typeof info === 'object' ? { ...info } : {};
        if (!enrichedInfo.errorCode) {
          enrichedInfo.errorCode = makeHardBlockErrorCode();
        }
        console.error(`[${enrichedInfo.errorCode}] Í≥ÑÏ†ï ÎèôÏãú Ïã§ÌñâÏù¥ Í∞êÏßÄÎêòÏñ¥ ÌòÑÏû¨ Ï∞ΩÏùò Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Ï∞®Îã®ÌñàÏäµÎãàÎã§.`);
        showHardBlockOverlay(enrichedInfo);
        try { window.__DEFER_INIT = null; } catch {}
        try { window.__HARD_SHUTDOWN_GAME?.(enrichedInfo); } catch {}
        localBlockActive = false;
        remoteBlocked = true;
        try {
          if (overlay) {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
          }
        } catch {}
        window.__PLAY_DUP_LOCK_ACTIVE = true;
        window.__PLAY_ALLOWED = false;
        try { applyPlayState(); } catch {}
      }
      const isRemoteStale = (info) => {
        if (!info) return true;
        const ts = info.updatedAt || info.ts || 0;
        if (!Number.isFinite(ts)) return true;
        const age = now() - ts;
        return !Number.isFinite(age) || age > REMOTE_STALE_MS;
      };
      const setRemoteBlockedState = (active, info = null) => {
        if (window.__GAME_JS_HARD_BLOCKED) {
          remoteBlocked = true;
          if (!remoteInfo) remoteInfo = info || null;
          return;
        }
        remoteBlocked = !!active;
        remoteInfo = info ? { ...info } : null;
        if (remoteBlocked) {
          detachRemoteWatcher();
          const enriched = remoteInfo ? { ...remoteInfo } : {};
          if (!enriched.errorCode) {
            enriched.errorCode = makeHardBlockErrorCode();
          }
          if (!enriched.blockSource) {
            enriched.blockSource = 'remote';
          }
          remoteInfo = enriched;
          hardBlockJsExecution(enriched);
          return;
        }
        stopRemoteRetry();
        updateStatus(null);
        overlayHide();
        updateLockTexts();
        applyPlayState();
        runDeferredInitIfReady();
      };
      const setupRemoteDisconnect = () => {
        if (!remoteRef) return;
        try { remoteDisconnectHandle?.cancel?.(); }
        catch {}
        try {
          remoteDisconnectHandle = onDisconnect(remoteRef);
          remoteDisconnectHandle.remove().catch(() => {});
        } catch (err) {
          remoteDisconnectHandle = null;
          console.warn('ÏõêÍ≤© ÏÑ∏ÏÖò onDisconnect Î•º ÏÑ§Ï†ïÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err);
        }
      };
      const releaseRemoteSession = async () => {
        stopRemoteHeartbeat();
        stopRemoteRetry();
        detachRemoteWatcher();
        try { await remoteDisconnectHandle?.cancel?.(); }
        catch {}
        remoteDisconnectHandle = null;
        const targetRef = remoteRef;
        const targetToken = remoteToken;
        remoteUid = null;
        remoteRef = null;
        remoteToken = null;
        remoteClaimed = false;
        remoteInfo = null;
        setRemoteBlockedState(false);
        if (targetRef && targetToken) {
          try {
            await runTransaction(targetRef, (current) => {
              if (current && current.token === targetToken) {
                return null;
              }
              return current || null;
            }, { applyLocally: false });
          } catch (err) {
            console.warn('ÏõêÍ≤© ÏÑ∏ÏÖòÏùÑ Ìï¥Ï†úÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.', err);
          }
        }
      };
      const attemptRemoteClaim = async () => {
        if (!remoteUid) {
          setRemoteBlockedState(false);
          return false;
        }
        if (!remoteToken) remoteToken = makeToken();
        const targetRef = ref(sessionDb, `${REMOTE_SESSION_PATH}/${remoteUid}`);
        let snapshot = null;
        let committed = false;
        try {
          const result = await runTransaction(targetRef, (current) => {
            const nowTs = now();
            if (current && current.token && current.token !== remoteToken && !isRemoteStale(current)) {
              snapshot = current;
              return undefined; // Ï∂©Îèå Ïãú Í∏∞Ï°¥ ÏÑ∏ÏÖòÏùÑ Ïú†ÏßÄÌïòÍ≥† Ìä∏ÎûúÏû≠ÏÖòÏùÑ Ï§ëÎã®
            }
            return {
              token: remoteToken,
              deviceId: remoteDeviceId,
              deviceLabel: describeDevice(),
              createdAt: current?.createdAt || nowTs,
              updatedAt: nowTs,
              ua: (navigator.userAgent || '').slice(0, 120)
            };
          }, { applyLocally: false });
          committed = result.committed;
          if (!snapshot) snapshot = result.snapshot?.val() || null;
        } catch (err) {
          console.warn('ÏõêÍ≤© ÏÑ∏ÏÖò ÌôïÎ≥¥ Ïã§Ìå®', err);
        }
        if (committed) {
          remoteRef = targetRef;
          remoteClaimed = true;
          snapshot = null;
          setRemoteBlockedState(false);
          setupRemoteDisconnect();
          startRemoteHeartbeat();
          attachRemoteWatcher();
          return true;
        }
        remoteClaimed = false;
        if (snapshot) {
          setRemoteBlockedState(true, snapshot);
        } else {
          scheduleRemoteRetry();
        }
        return false;
      };
      const ensureRemoteMonitor = (uid) => {
        if (!uid) {
          releaseRemoteSession();
          return;
        }
        if (remoteUid === uid) {
          if (remoteBlocked || !remoteClaimed) {
            attemptRemoteClaim();
          }
          return;
        }
        releaseRemoteSession();
        remoteUid = uid;
        remoteToken = null;
        remoteRef = null;
        remoteClaimed = false;
        remoteInfo = null;
        attemptRemoteClaim();
      };

      const ensureToken = () => {
        if (!token) token = makeToken();
      };

      const isStale = (info) => {
        if (!info || !info.ts) return false;
        const age = now() - info.ts;
        if (!Number.isFinite(age)) return false;
        return age > STALE_THRESHOLD;
      };

      const takeLock = () => {
        ensureToken();
        hasLock = true;
        stopRetry();
        localBlockActive = false;
        updateStatus(null);
        overlayHide();
        runDeferredInitIfReady();
        startHeartbeat();
        applyPlayState();
      };

      const showLock = (info) => {
        localBlockActive = true;
        const enriched = {
          ...(info || {}),
          blockSource: 'local'
        };
        if (!enriched.ts) {
          enriched.ts = now();
        }
        if (!enriched.deviceLabel) {
          enriched.deviceLabel = 'ÌòÑÏû¨ Í∏∞Í∏∞';
        }
        hardBlockJsExecution(enriched);
      };

      const attemptClaim = (existingInfo, fromRetry = false) => {
        if (!currentUid || bypassed) return false;
        ensureToken();
        const info = existingInfo ?? readLock();
        if (!info) {
          takeLock();
          return true;
        }
        if (info.token === token) {
          takeLock();
          return true;
        }
        if (isStale(info)) {
          takeLock();
          return true;
        }
        showLock(info);
        return false;
      };

      const handleStorage = (ev) => {
        if (!currentUid || bypassed) return;
        if (ev.key !== getKey(currentUid)) return;
        const info = parseValue(ev.newValue);
        if (attemptClaim(info)) return;
        showLock(info);
      };

      const handleBeforeUnload = () => {
        if (!currentUid || bypassed) return;
        if (hasLock) removeLockIfOwned();
      };

      const ensureListeners = () => {
        if (listenersAttached) return;
        window.addEventListener('storage', handleStorage);
        window.addEventListener('beforeunload', handleBeforeUnload);
        listenersAttached = true;
      };
      const removeListeners = () => {
        if (!listenersAttached) return;
        window.removeEventListener('storage', handleStorage);
        window.removeEventListener('beforeunload', handleBeforeUnload);
        listenersAttached = false;
      };

      const setBypassed = (value) => {
        if (bypassed === value) return;
        bypassed = value;
        if (bypassed) {
          stopHeartbeat();
          stopRetry();
          hasLock = false;
          overlayHide();
          runDeferredInitIfReady();
          applyPlayState();
        } else if (currentUid) {
          attemptClaim();
        } else {
          applyPlayState();
        }
      };

      function release() {
        releaseRemoteSession();
        if (hasLock && !bypassed) {
          removeLockIfOwned();
        }
        stopHeartbeat();
        stopRetry();
        hasLock = false;
        currentUid = null;
        token = null;
        bypassed = false;
        localBlockActive = false;
        overlayHide();
        removeListeners();
        applyPlayState();
      }

      function activate(uid) {
        if (!uid) {
          release();
          return;
        }
        ensureListeners();
        if (currentUid === uid) {
          ensureRemoteMonitor(uid);
          if (!bypassed) {
            attemptClaim();
          } else {
            applyPlayState();
          }
          return;
        }
        release();
        ensureListeners();
        currentUid = uid;
        bypassed = false;
        token = null;
        hasLock = false;
        ensureRemoteMonitor(uid);
        applyPlayState();
        attemptClaim();
      }

      const showAdminPanel = () => {
        if (!adminBox) return;
        adminBox.classList.add('show');
        adminBox.setAttribute('aria-hidden', 'false');
        if (adminError) adminError.textContent = '';
        if (statusEl) statusEl.textContent = '';
        setTimeout(() => adminIdEl && adminIdEl.focus(), 60);
      };

      const openAdminPanelExternal = (options = {}) => {
        overlayShow();
        showAdminPanel();
        if (statusEl) {
          const message = options && typeof options.message === 'string'
            ? options.message
            : 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ùÏùÑ ÏôÑÎ£åÌïòÎ©¥ Í≥ÑÏÜç ÏßÑÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.';
          statusEl.textContent = message;
        }
      };

      let holdTimer = null;
      let holdSuccess = false;
      let holdOpened = false;

      const startAdminHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        holdSuccess = false;
        holdOpened = false;
        holdTimer = setTimeout(() => {
          holdSuccess = true;
          showAdminPanel();
        }, 2000);
      };

      const cancelAdminHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        const wasActivated = holdSuccess;
        holdSuccess = false;
        holdOpened = wasActivated;
        return wasActivated;
      };

      const runAdminProgress = async (task) => {
        if (!adminProgress || !adminSubmit || !adminIdEl || !adminPwEl) {
          await task();
          return;
        }
        if (adminSubmit.disabled) return;
        const seconds = 10 + Math.floor(Math.random() * 11);
        let dots = 0;
        adminProgress.classList.add('show');
        adminProgress.textContent = 'Login in progress';
        adminSubmit.disabled = true;
        adminIdEl.disabled = true;
        adminPwEl.disabled = true;
        const dotTimer = setInterval(() => {
          dots = (dots + 1) % 4;
          adminProgress.textContent = 'Login in progress' + '.'.repeat(dots);
        }, 420);

        await new Promise((resolve) => {
          setTimeout(resolve, seconds * 1000);
        });

        try {
          await task();
        } finally {
          clearInterval(dotTimer);
          adminProgress.classList.remove('show');
          adminProgress.textContent = '';
          adminSubmit.disabled = false;
          adminIdEl.disabled = false;
          adminPwEl.disabled = false;
        }
      };

      const emitAdminFailure = (context) => {
        const suffix = Math.floor(1000 + Math.random() * 9000);
        const code = `ADM-${context}-${suffix}`;
        const message = `[${code}] Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ùÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. ÏûÖÎ†• Ï†ïÎ≥¥Î•º Îã§Ïãú ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.`;
        if (adminError) adminError.textContent = message;
        alert(`${message}\n\nÏò§Î•òÍ∞Ä Í≥ÑÏÜçÎêòÎ©¥ ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.`);
        return code;
      };

      const handleAdminSubmit = async () => {
        if (!adminIdEl || !adminPwEl) return;
        const id = adminIdEl.value.trim();
        const pw = adminPwEl.value;
        if (!id || !pw) {
          if (adminError) adminError.textContent = 'ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.';
          return;
        }
        if (typeof window.__verifyGameAdmin !== 'function') {
          if (adminError) adminError.textContent = 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ùÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
          return;
        }
        if (adminError) adminError.textContent = '';
        await runAdminProgress(async () => {
          try {
            const ok = await window.__verifyGameAdmin(id, pw);
            if (ok) {
              adminIdEl.value = '';
              adminPwEl.value = '';
              setBypassed(true);
              window.dispatchEvent(new CustomEvent('game-admin-auth-success', { detail: { context: 'session-lock' } }));
              alert('login succesful');
            } else {
              const code = emitAdminFailure('SL');
              adminPwEl.value = '';
              adminPwEl.focus();
              window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'session-lock', code } }));
            }
          } catch (err) {
            console.error('Session lock admin verification failed', err);
            const suffix = Math.floor(1000 + Math.random() * 9000);
            const code = `ADM-SL-${suffix}`;
            const message = `[${code}] ÏãúÏä§ÌÖú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.`;
            if (adminError) adminError.textContent = message;
            alert(`${message}\n\nÏßÄÏÜçÎê† Í≤ΩÏö∞ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.`);
            if (adminPwEl) {
              adminPwEl.value = '';
              adminPwEl.focus();
            }
            window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'session-lock', code, fatal: true } }));
          }
        });
      };

      retryBtn && retryBtn.addEventListener('click', () => {
        attemptClaim();
        attemptRemoteClaim();
      });
      remoteLogoutBtn && remoteLogoutBtn.addEventListener('click', async () => {
        if (!remoteUid || remoteLogoutPending) return;
        const confirmed = confirm('Îã§Î•∏ Í∏∞Í∏∞ÏóêÏÑú ÎèôÏùº Í≥ÑÏ†ïÏùÑ Í∞ïÏ†úÎ°ú Î°úÍ∑∏ÏïÑÏõÉÌï†ÍπåÏöî? Ïù¥ Í∏∞Í∏∞Îßå Ï†ëÏÜçÌï† Ïàò ÏûàÍ≤å Îê©ÎãàÎã§.');
        if (!confirmed) return;
        remoteLogoutPending = true;
        updateRemoteLogoutVisibility();
        try {
          await remove(ref(sessionDb, `${REMOTE_SESSION_PATH}/${remoteUid}`));
          if (statusEl) statusEl.textContent = 'ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉÏùÑ ÏöîÏ≤≠ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
        } catch (err) {
          console.error('ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®', err);
          alert('ÏõêÍ≤© Î°úÍ∑∏ÏïÑÏõÉÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
        } finally {
          remoteLogoutPending = false;
          updateRemoteLogoutVisibility();
        }
        setTimeout(() => { if (remoteUid) attemptRemoteClaim(); }, 800);
      });
      if (adminToggle) {
        adminToggle.addEventListener('mousedown', startAdminHold);
        adminToggle.addEventListener('touchstart', startAdminHold, { passive: true });
        const endHold = (ev) => {
          const opened = cancelAdminHold();
          if (!opened) {
            ev.preventDefault();
            if (statusEl) {
              statusEl.textContent = 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Ìå®ÎÑêÏùÄ Î≤ÑÌäºÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í±∞ÎÇò Ctrl+Shift+1 Îã®Ï∂ïÌÇ§Î°ú Ïó¥ Ïàò ÏûàÏäµÎãàÎã§.';
            }
          }
        };
        ['mouseup','mouseleave','touchend','touchcancel'].forEach((type) => {
          adminToggle.addEventListener(type, endHold);
        });
        adminToggle.addEventListener('blur', cancelAdminHold);
        adminToggle.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            if (!holdTimer) {
              startAdminHold();
            }
          }
        });
        adminToggle.addEventListener('keyup', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            const opened = cancelAdminHold();
            if (!opened) {
              ev.preventDefault();
              if (statusEl) {
                statusEl.textContent = 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù Ìå®ÎÑêÏùÄ Î≤ÑÌäºÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í±∞ÎÇò Ctrl+Shift+1 Îã®Ï∂ïÌÇ§Î°ú Ïó¥ Ïàò ÏûàÏäµÎãàÎã§.';
              }
            }
          }
        });
        adminToggle.addEventListener('click', (ev) => {
          if (!holdOpened) {
            ev.preventDefault();
          }
          holdOpened = false;
        });
      }
      window.addEventListener('keydown', (ev) => {
        if (ev.ctrlKey && ev.shiftKey && ev.code === 'Digit1') {
          ev.preventDefault();
          showAdminPanel();
        }
      });
      if (adminIdEl) {
        adminIdEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      adminSubmit && adminSubmit.addEventListener('click', handleAdminSubmit);
      adminPwEl && adminPwEl.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          handleAdminSubmit();
        }
      });
      hardBlockReloadBtn && hardBlockReloadBtn.addEventListener('click', () => {
        location.reload();
      });

      window.__SESSION_LOCK__ = {
        activate,
        release,
        bypass: setBypassed,
        openAdminPanel: openAdminPanelExternal
      };

      if (window.__CURRENT_USER_UID) {
        activate(window.__CURRENT_USER_UID);
      } else {
        applyPlayState();
      }
    })();
  </script>

  <!-- Ïø†Ìå° Í¥ëÍ≥† Î°úÎî© Î∞è ÌÉ≠ Î≥µÍ∑Ä Ïò§Î≤ÑÎ†àÏù¥ -->
  <script>
    (() => {
      const overlay = document.getElementById('coupang-focus-overlay');
      const closeBtn = document.getElementById('coupang-overlay-close');
      let wasHidden = false;

      const showOverlay = () => {
        if (!overlay) return;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      };

      const hideOverlay = () => {
        if (!overlay) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      };

      closeBtn?.addEventListener('click', hideOverlay);
      overlay?.addEventListener('click', (e) => {
        if (e.target === overlay) hideOverlay();
      });

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          wasHidden = true;
        } else if (wasHidden) {
          showOverlay();
          wasHidden = false;
        }
      });
    })();
  </script>

  <!-- ÏûëÏùÄ Îàà ÎÇ¥Î¶¨Îäî Ìö®Í≥º -->
  <script>
    (() => {
      const snowLayer = document.getElementById('snow-layer');
      if (!snowLayer) return;
      const flakeCount = 60;
      for (let i = 0; i < flakeCount; i++) {
        const flake = document.createElement('span');
        flake.className = 'snowflake';
        const size = 2 + Math.random() * 2;
        const duration = 7 + Math.random() * 6;
        const delay = Math.random() * -duration;
        flake.style.width = `${size}px`;
        flake.style.height = `${size}px`;
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.animationDuration = `${duration}s`;
        flake.style.animationDelay = `${delay}s`;
        flake.style.setProperty('--drift', `${(Math.random() * 40 - 20).toFixed(1)}px`);
        flake.style.opacity = (0.45 + Math.random() * 0.35).toFixed(2);
        snowLayer.appendChild(flake);
      }
    })();
  </script>

  <!-- üìé Ï†ïÏ±Ö(inframe) Ïò§Î≤ÑÎ†àÏù¥ Ïó¥Í∏∞/Îã´Í∏∞ -->
  <script>
    (function () {
      const overlay   = document.getElementById('policy-overlay');
      const frame     = document.getElementById('policy-frame');
      const closeBtn  = document.getElementById('policy-close');
      const newTabBtn = document.getElementById('policy-open-new');
      const titleEl   = document.getElementById('policy-title');
      const triggers  = document.querySelectorAll('[data-policy]');

      const POLICY_META = {
        terms:   { url: '/terms.html',   title: 'Ïù¥Ïö©ÏïΩÍ¥Ä' },
        privacy: { url: '/privacy', title: 'Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®' }
      };

      function resolveMeta(kind) {
        return POLICY_META[kind] || POLICY_META.terms;
      }

      function openPolicy(kind) {
        if (!overlay) return;
        const meta = resolveMeta(kind);
        const baseUrl = meta.url + (location.search || '') + (location.hash || '');
        if (frame) {
          if (frame.dataset.current !== meta.url) {
            frame.src = baseUrl;
            frame.dataset.current = meta.url;
          }
        }
        if (titleEl) titleEl.textContent = meta.title;
        if (newTabBtn) newTabBtn.href = meta.url;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      }

      function closePolicy() {
        if (!overlay) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }

      triggers.forEach((el) => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const kind = el.getAttribute('data-policy') || 'terms';
          openPolicy(kind);
        });
      });

      closeBtn  && closeBtn.addEventListener('click', closePolicy);
      overlay   && overlay.addEventListener('click', (e) => { if (e.target === overlay) closePolicy(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePolicy(); });
    })();
  </script>

</body>
</html>
