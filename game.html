<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</title>

  <!-- ìµœì´ˆ ì ‘ì† ì‹œ /loginìœ¼ë¡œ í•œë²ˆë§Œ ë¼ìš°íŒ… (ì›¹ë·°/ì„ë² ë””ë“œ ì•±ì€ ì£¼ì†Œ ë³€ê²½ ìƒëµ) -->
  <script>
    const __isEmbeddedApp__ = (() => {
      try {
        const ua = (navigator.userAgent || '').toLowerCase();
        if (ua.includes('; wv') || ua.includes(' wv)') || ua.includes('wv)') || /\bwv\b/.test(ua)) return true;
        if (/(iphone|ipad|ipod).+applewebkit(?!.*safari)/i.test(navigator.userAgent || '')) return true;
        if (window.ReactNativeWebView || window.flutter_inappwebview || window.AndroidBridge) return true;
        if (window.Capacitor && window.Capacitor.isNativePlatform) return true;
        if (window.webkit && window.webkit.messageHandlers) return true;
      } catch {}
      return false;
    })();

    try {
      document.documentElement.dataset.embeddedApp = __isEmbeddedApp__ ? '1' : '0';
      window.__IS_EMBEDDED_APP = __isEmbeddedApp__;
    } catch {}

    try {
      if (!__isEmbeddedApp__ && !sessionStorage.getItem('pmode_init')) {
        history.replaceState(null, '', '/login' + (location.hash || ''));
        sessionStorage.setItem('pmode_init', '1');
      }
    } catch (e) {}
  </script>

  <!-- íŒì—…/ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¶€ëª¨ ë³´ì•ˆ ì•Œë¦¼/í—ˆìš© ë„ë©”ì¸ -->
  <script>
    const allowedParentOrigins = [
      location.origin,
      'https://xn--989a202a4ogwtc69p.siustudio.me',
      'https://siustudio.me'
    ];
    function isAllowedRedirect(urlStr) {
      try {
        const u = new URL(urlStr);
        if (u.protocol !== 'https:') return false;
        const host = u.hostname;
        const base1 = 'xn--989a202a4ogwtc69p.siustudio.me';
        const base2 = 'siustudio.me';
        return (host === base1 || host === base2 ||
          host.endsWith('.' + base1) || host.endsWith('.' + base2));
      } catch { return false; }
    }
    let parentOrigin     = sessionStorage.getItem('parent_origin')     || null;
    let pendingRedirect  = sessionStorage.getItem('pending_redirect')  || null;
    let pendingState     = sessionStorage.getItem('pending_state')     || null;

    function consumePendingRedirect() {
      let target = null;
      try {
        const fromStorage = sessionStorage.getItem('pending_redirect');
        if (fromStorage) {
          sessionStorage.removeItem('pending_redirect');
          target = fromStorage;
        }
      } catch {}
      if (!target && pendingRedirect) target = pendingRedirect;
      pendingRedirect = null;
      return (target && isAllowedRedirect(target)) ? target : null;
    }

    function notifyReadyToParent() {
      try {
        if (window.opener && !window.opener.closed) {
          allowedParentOrigins.forEach((o) => {
            try { window.opener.postMessage({ type: 'login-ready' }, o); } catch {}
          });
        }
      } catch {}
    }
    notifyReadyToParent();

    function notifyAuthSuccessAndExit() {
      const target = consumePendingRedirect();
      const hasParent = window.opener && !window.opener.closed && parentOrigin;
      if (hasParent) {
        try {
          window.opener.postMessage({
            type: 'auth-success', ok: true, redirect: target || undefined, receivedState: pendingState
          }, parentOrigin);
        } catch {}
        try { window.close(); } catch {}
        return;
      }
      if (target) window.location.href = target;
    }
    window.notifyAuthSuccessAndExit = notifyAuthSuccessAndExit;
  </script>

  <style>
    :root{
      --glass-bg: rgba(10,12,20,0.40);
      --glass-brd: rgba(255,255,255,0.08);
      --accent: #00d4ff;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100vh;
    }
    body {
      font-family:Inter, Arial, sans-serif;
      background:url('/images/space-bg.jpg') center center / cover no-repeat fixed;
      color:#fff;
    }
    #snow-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:5;
      mix-blend-mode:screen;
    }
    .snowflake{
      position:absolute;
      top:-6px;
      width:4px;
      height:4px;
      background:rgba(255,255,255,0.9);
      border-radius:50%;
      box-shadow:0 0 6px rgba(255,255,255,0.55);
      animation: snowFall linear infinite;
      opacity:0.7;
    }
    @keyframes snowFall {
      0%   { transform: translate3d(0, -10px, 0); opacity:0; }
      10%  { opacity:0.9; }
      100% { transform: translate3d(var(--drift, 0px), 110vh, 0); opacity:0.95; }
    }
    body.game-hard-blocked #top-bar,
    body.game-hard-blocked #container { filter: grayscale(0.65); pointer-events:none; user-select:none; opacity:0.55; }
    body.game-hard-blocked #top-bar { opacity:0.35; }
    #container .hard-block-disabled,
    #top-bar .hard-block-disabled { pointer-events:none !important; opacity:0.5; }
    img { display:block; }

    /* ë¶€íŒ…/ìŠ¤í”¼ë„ˆ */
    #top-bar, #container { visibility: hidden; }
    .spinner { width:46px; height:46px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top-color: #00d4ff; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #boot-overlay{
      position:fixed; inset:0; z-index:3000;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60));
      backdrop-filter: blur(3px);
    }
    #boot-overlay .card{
      width:min(420px,92vw); border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(10,12,18,0.45));
      padding:16px; text-align:center; color:#e6f7ff;
      box-shadow:0 16px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* ë¡œê·¸ì¸ ì¹´ë“œ */
    #auth-container {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000;
      width:360px; max-width:92%; padding:22px; border-radius:14px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(6,7,12,0.45));
      box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
      transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .28s ease, visibility .28s;
      display:none;
      max-height: min(92vh, 760px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #auth-container.hidden { opacity:0; transform: translate(-50%, -46%) scale(.98); pointer-events:none; visibility:hidden; }
    #auth-container h2 { margin:0 0 12px; font-size:20px; color:#e8faff; letter-spacing:0.2px; }
    .gtranslate_wrapper{ display:none !important; }
    #auth-container input { width:100%; padding:12px 12px; margin:8px 0; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20); color:#fff; outline:none; font-size:14px; }
    #auth-container input:focus { box-shadow:0 8px 20px rgba(0,160,255,0.08); border-color:rgba(0,160,255,0.22); }
    #auth-container .primary-btn { width:100%; padding:12px; margin-top:8px; border-radius:10px; background:linear-gradient(90deg,#00c0ff,#0077ff); color:#00120b; font-weight:800; border:none; cursor:pointer; box-shadow: 0 6px 18px rgba(0,120,255,0.12); }
    #auth-container .ghost-btn { width:100%; padding:10px; margin-top:6px; border-radius:10px; background:transparent; color:#e6f5ff; border:1px solid rgba(255,255,255,0.08); cursor:pointer; }
    #auth-container .policy-consent { margin-top:8px; display:flex; flex-direction:column; gap:6px; text-align:left; font-size:13px; color:#e3f3ff; }
    #auth-container .policy-consent label { display:flex; gap:8px; align-items:flex-start; line-height:1.45; }
    #auth-container .policy-consent input[type="checkbox"] { margin-top:3px; }
    #auth-container .policy-consent .policy-link { background:none; border:none; color:#9fdcff; padding:0; margin-left:6px; font-size:12px; text-decoration:underline; cursor:pointer; }
    #auth-container .policy-consent .policy-link:focus { outline:1px dashed rgba(159,220,255,0.7); outline-offset:2px; }

    .auth-status { margin-top:10px; min-height:22px; font-size:13px; color:#ffdede; opacity:0; transform:translateY(6px); transition:opacity .22s ease, transform .22s ease; }
    .auth-status.show { opacity:1; transform:translateY(0); }

    .login-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,12,0.40), rgba(2,6,12,0.60)); border-radius:14px; z-index:1100; opacity:1; pointer-events:auto; }
    .login-overlay.show { display:flex; }

    #policy-overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(5,10,20,0.78); backdrop-filter:blur(6px);
      z-index:2600; opacity:0; pointer-events:none; transition:opacity .24s ease;
      padding:20px;
    }
    #policy-overlay.show { opacity:1; pointer-events:auto; }
    #policy-overlay .policy-modal {
      width:min(840px, 96vw);
      background:linear-gradient(180deg, rgba(13,18,30,0.92), rgba(8,12,22,0.96));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      box-shadow:0 24px 70px rgba(0,0,0,0.55);
      padding:18px 20px 20px;
      display:flex; flex-direction:column; gap:14px; color:#e8f6ff;
      max-height: min(92vh, 820px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #policy-overlay .policy-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #policy-overlay .policy-header h3 { margin:0; font-size:18px; color:#f0fbff; }
    #policy-overlay .policy-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #policy-overlay button.policy-close,
    #policy-overlay a.policy-open-new {
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; border-radius:8px; font-size:13px; font-weight:600;
      border:1px solid rgba(159,220,255,0.35); background:rgba(0,166,255,0.10);
      color:#d9f2ff; cursor:pointer; text-decoration:none;
    }
    #policy-overlay button.policy-close:hover,
    #policy-overlay a.policy-open-new:hover { background:rgba(0,166,255,0.20); }
    #policy-overlay button.policy-close { background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.18); }
    #policy-overlay button.policy-close:hover { background:rgba(0,0,0,0.35); }
    #policy-overlay iframe {
      width:100%; height:70vh; border:none; border-radius:12px;
      background:#ffffff; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    #policy-overlay .policy-foot { font-size:12px; color:#bcd8ee; text-align:right; }
    @media (max-width:600px) {
      #policy-overlay iframe { height:60vh; }
      #policy-overlay .policy-actions { width:100%; justify-content:flex-end; }
    }

    .google-btn { width:95%; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px; margin:8px 0 4px; background:linear-gradient(180deg,#fff,#f2f2f2); color:#000; border-radius:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .google-btn .g-icon { display:inline-flex; align-items:center; justify-content:center; }
    .google-btn .g-text { display:inline-flex; align-items:center; gap:6px; font-size:14px; }
    .google-btn small { font-weight:600; color:#666; font-size:11px; }
    html[data-embedded-app="1"] #google-btn { display:none !important; }
    html[data-embedded-app="0"] #btnGoogleLoginCode,
    html[data-embedded-app="0"] #codeArea { display:none !important; }

    @media (max-width:420px){ #auth-container{ padding:16px; } .google-btn{ width:100%; } }

    /* ìƒë‹¨ ë°” */
    #top-bar {
      position: fixed; top: 5px; left: 5px; right: 5px;
      display: flex; flex-wrap: wrap; gap:6px 8px;
      justify-content: space-between; align-items: center;
      background: rgba(30,30,30,0.55);
      padding:6px 10px; border-radius:8px;
      font-size:12px; z-index:1000;
      border: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
      overflow: hidden;
    }
    .bar-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden; }
    .bar-group img { width:16px; height:16px; }
    .bar-group span { white-space: nowrap; }
    #ship-img{
      width:140px; max-width:60vw;
      height:auto;
      margin:0 auto 10px;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,0.35));
    }
    .ship-panel{
      margin:0 auto;
      padding:16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(5,9,18,0.55));
      box-shadow: 0 18px 44px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05);
      max-width:360px;
      display:flex;
      flex-direction:column;
      gap:12px;
      text-align:center;
    }
    .ship-panel h2{
      margin:0;
      font-size:18px;
      color:#e9f7ff;
    }
    .ship-panel p{
      margin:0;
      color:#bcd8ee;
      font-size:13px;
      line-height:1.5;
    }
    .ship-panel .ship-status{
      font-size:15px;
      font-weight:700;
      color:var(--accent);
    }
    .ship-panel .general{
      width:100%;
      max-width:none;
    }
    .ship-enhance-info{ margin-top:-4px; font-size:13px; color:#c6e7ff; }
    .ship-enhance-status{ min-height:22px; font-size:13px; color:#dbe9ff; transition:color .2s ease; }
    .ship-enhance-status[data-tone="success"]{ color:#8ef7c2; }
    .ship-enhance-status[data-tone="warn"]{ color:#ffb7b7; }
    .ship-panel.enhancing #ship-img{ animation: drumPulse .38s ease-in-out infinite; }
    .ship-panel.success-glow{ box-shadow:0 0 0 0 rgba(0,212,255,0.22), 0 16px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05); }
    .ship-panel.fail-shake{ animation: shipShake .36s ease; }
    @keyframes drumPulse{ 0%{ transform:scale(1); } 50%{ transform:scale(1.04); } 100%{ transform:scale(1); } }
    @keyframes shipShake{ 0%,100%{ transform:translateX(0); } 20%{ transform:translateX(-6px); } 40%{ transform:translateX(6px); } 60%{ transform:translateX(-4px); } 80%{ transform:translateX(4px); } }

    #settings-btn {
      margin-left: 8px; padding: 6px 10px; border-radius: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12); color: #e6f5ff;
      cursor: pointer; font-weight: 700;
    }
    #settings-btn:hover { filter: brightness(1.08); }
    #guest-login-btn {
      display: none;
      margin-left: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(0,180,255,0.18), rgba(0,120,255,0.24));
      border: 1px solid rgba(0,200,255,0.45);
      color: #001624;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,140,255,0.18);
    }
    #guest-login-btn:hover { filter: brightness(1.08); }

    /* ìƒˆ ë²„í”„ ë²„íŠ¼ */
    #buff-btn{
      margin-left: 6px;
      padding: 5px 10px;
      border-radius: 8px;
      background: rgba(0,212,255,0.12);
      border: 1px solid rgba(0,212,255,0.35);
      color:#e6f5ff;
      cursor:pointer;
      font-weight:700;
      backdrop-filter: blur(4px);
    }
    #buff-btn:hover{ background: rgba(0,212,255,0.25); }

    /* ì˜ì‹¬ë„ ë°°ì§€: ìš”êµ¬ì‚¬í•­ëŒ€ë¡œ ì™„ì „ ìˆ¨ê¹€ */
    #suspicion-badge{ display:none !important; }

    /* ë³¸ë¬¸ */
    #container { margin:56px auto 20px; width:90%; max-width:640px; padding:16px 20px; background:rgba(30,30,30,0.55); border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.08); }
    h1 { font-size:1.4em; margin:6px 0 14px; color:var(--accent); }
    button.general { width:calc(100% - 32px); max-width:320px; padding:10px; margin:6px auto; font-size:13px; background:url('/images/button-bg.png') center/contain no-repeat; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:opacity .2s; white-space: pre-line; }
    button.general:disabled { opacity:0.5; cursor:not-allowed; }

    .tab-content { display:none; margin-top:12px; }
    .tab-content.active { display:block; }

    .ore-frag {
      position: absolute;
      width: 46px;
      height: 46px;
      pointer-events: none;
      opacity: .95;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.45));
      transform: translate(-50%, -50%) scale(var(--start-scale, .55)) rotate(var(--start-rot, 0deg));
      animation: oreScatter .72s ease-out forwards;
    }
    @keyframes oreScatter {
      0% {
        opacity: .95;
        transform: translate(-50%, -50%) scale(var(--start-scale, .55)) rotate(var(--start-rot, 0deg));
      }
      100% {
        opacity: 0;
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(var(--end-scale, .28)) rotate(var(--rot, 0deg));
      }
    }
    #ore { width:200px; cursor:pointer; }

    /* ìš°í´ë¦­ ë©”ë‰´ */
    #custom-menu { position: fixed; display: none; background: rgba(30,30,30,0.90); border: 1px solid #555; border-radius: 6px; padding: 8px 0; z-index: 2000; font-size: 14px; color: #fff; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    #custom-menu .menu-item { padding: 6px 12px; cursor: pointer; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    #custom-menu .menu-item:hover { background: rgba(255,255,255,0.1); }
    .count-badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; padding:2px 6px; border-radius:999px; background:#ff7a9a; color:#fff; font-size:11px; font-weight:700; }
    .count-badge.hidden { display:none; }
    #attendance-left { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }

    /* ë°”í…€ ë‚´ë¹„ */
    #bottom-nav{
      position: fixed;
      left: 50%; bottom: max(12px, env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%);
      display: flex; gap: 8px; padding: 8px;
      background: var(--glass-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--glass-brd);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      z-index: 1200; max-width: 96vw;
    }
    #bottom-nav .tab{
      display: inline-flex; align-items: center; justify-content: center;
      gap: 6px; min-width: 70px; padding: 10px 12px; font-size: 13px;
      color: #d7e8ff; cursor: pointer; user-select: none; border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06); transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    #bottom-nav .tab:hover{ transform: translateY(-1px); }
    #bottom-nav .tab.active{
      color: #001218; background: linear-gradient(180deg,#00c0ff,#00a2ff);
      border-color: transparent; box-shadow: 0 6px 18px rgba(0,160,255,0.28);
    }
    .event-panel{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px; align-items:flex-start; }
    .event-card{ background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:12px; box-shadow:0 8px 26px rgba(0,0,0,0.35); }
    .event-card h3{ margin:0 0 8px; font-size:16px; display:flex; gap:8px; align-items:center; }
    .event-stats{ display:flex; flex-direction:column; gap:6px; font-size:14px; }
    .event-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .event-actions button{ flex:1 1 150px; }
    .christmas-launch{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #christmas-start{ flex: 0 0 auto; }
    #christmas-launch-hint{ font-size:13px; color:#cfe6ff; opacity:0.9; }
    #christmas-overlay{ position:fixed; inset:0; background:rgba(2,6,12,0.85); backdrop-filter:blur(6px); z-index:3600; display:none; align-items:center; justify-content:center; padding:18px; }
    #christmas-overlay.show{ display:flex; }
    #christmas-overlay iframe{ width:calc(100vw - 28px); height:calc(100vh - 28px); border:none; border-radius:14px; background:#000; box-shadow:0 24px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.06); }
    #christmas-close{ position:absolute; top:12px; right:12px; width:34px; height:34px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.35); color:#e6f7ff; font-size:18px; cursor:pointer; box-shadow:0 10px 26px rgba(0,0,0,0.35); backdrop-filter:blur(6px); }
    #christmas-close:hover{ background:rgba(255,255,255,0.08); }
    .tree-status{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .tree-figure{ width:120px; height:120px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; background:rgba(0,0,0,0.25); object-fit:contain; }
    .tree-rewards{ margin:10px 0; padding:10px; border-radius:10px; background:rgba(0,0,0,0.25); border:1px dashed rgba(255,255,255,0.14); font-size:13px; line-height:1.5; }
    .tree-rewards strong{ color:#ffe08a; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.08); font-size:13px; }
    .pill img{ width:18px; height:18px; }
    #permanent-buffs{ margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.08); font-size:13px; color:#cfe6ff; line-height:1.45; }

    #container{ padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); }
    #planets-content{ padding-bottom: calc(220px + env(safe-area-inset-bottom, 0px)); }

    @media (max-width: 420px){
      #top-bar{ font-size:11px; padding:6px 8px; }
      #settings-btn{ padding:5px 8px; font-size:12px; }
      #bottom-nav{ left:8px; right:8px; transform:none; border-radius:14px; gap:6px; }
      #bottom-nav .tab{ padding:10px 8px; min-width:0; }
      h1{ font-size:1.2em; }
    }

    /* ì‚¬ì´ë“œ ë©”ë‰´ */
    #side-menu-toggle{
      position: fixed; left: 8px; bottom: calc(96px + env(safe-area-inset-bottom, 0px));
      z-index: 1600; width: 44px; height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);
      background: var(--glass-bg); backdrop-filter: blur(10px); color:#e6f5ff; font-size: 20px; cursor: pointer;
      display:flex; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #side-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.25); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 1550; }
    #side-backdrop.show{ opacity:1; pointer-events:auto; }
    #side-menu{
      position: fixed; top: 0; left:  0; bottom:  0; width: 260px; max-width: 84vw;
      transform: translateX(-100%); transition: transform .24s cubic-bezier(.2,.9,.3,1);
      background: rgba(15,18,28,0.60); border-right: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px); z-index: 1600; box-shadow: 10px 0 30px rgba(0,0,0,0.28);
    }
    #side-menu.open{ transform: translateX(0); }
    .side-header{ padding: 14px 14px 10px; font-weight: 800; color:#dbefff; letter-spacing:.3px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .side-items{ padding: 8px; display:flex; flex-direction:column; gap:8px; }
    .side-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.10); color:#eaf6ff; font-weight:700; cursor:pointer; user-select:none; }
    .side-item:hover{ filter: brightness(1.08); }
    .side-item .icon{ width:18px; text-align:center; }
    .side-right { opacity:.9; color:#9fdcff; font-variant-numeric: tabular-nums; }
    @media (max-width: 420px){ #side-menu-toggle{ bottom: calc(88px + env(safe-area-inset-bottom, 0px)); width:40px; height:40px; } #side-menu{ width: 240px; } }

    /* ===== ì¶œì„ & ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ ===== */
    #daily-overlay{
      position:fixed; inset:0; z-index:3500; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.50), rgba(2,6,12,.70)); backdrop-filter: blur(4px);
    }
    #daily-overlay.show{ display:flex; }
    #daily-card{
      width:min(520px, 94vw); border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.55));
      padding:14px; box-shadow: 0 16px 44px rgba(0,0,0,.50), inset 0 1px 0 rgba(255,255,255,.06);
      color:#eaf6ff;
    }
    #daily-title{ margin:0 0 8px; font-size:18px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    #daily-info{ margin:6px 0 10px; font-size:12px; color:#cfe6ff; min-height:36px; }
    #slot-access-info{ margin:4px 0 10px; font-size:11px; color:#a8dcff; line-height:1.5; }
    #daily-actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }

    /* í€˜ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ */
    #quest-overlay{
      position:fixed; inset:0; z-index:3600;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(4,8,16,0.55), rgba(4,8,16,0.78));
      backdrop-filter: blur(6px);
      opacity:0; pointer-events:none; transition:opacity .22s ease;
      padding:18px;
    }
    #quest-overlay.show{ opacity:1; pointer-events:auto; }
    #quest-card{
      width:min(680px, 96vw);
      background: linear-gradient(180deg, rgba(18,24,36,0.95), rgba(10,16,28,0.96));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(0,0,0,0.45);
      color:#e6f4ff;
      display:flex; flex-direction:column; gap:12px;
      padding:18px 20px 20px;
      max-height:92vh;
    }
    #quest-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; touch-action:none; user-select:none; cursor:grab; }
    #quest-head h3{ margin:0; font-size:20px; }
    #quest-close{ border:none; background:rgba(255,255,255,0.08); color:#f2fbff; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:14px; }
    #quest-close:hover{ background:rgba(255,255,255,0.15); }
    .quest-tabbar{ display:flex; gap:8px; }
    .qtab{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); color:#dff2ff; font-weight:700; cursor:pointer; }
    .qtab.active{ background:linear-gradient(120deg, rgba(0,214,255,0.18), rgba(0,122,255,0.24)); border-color:rgba(0,214,255,0.45); color:#001018; text-shadow:0 1px 10px rgba(0,214,255,0.35); }
    #quest-panels{ display:flex; flex-direction:column; gap:12px; }
    .quest-panel{ display:none; flex-direction:column; gap:10px; }
    .quest-panel.active{ display:flex; }
    .quest-desc{ margin:0; color:#cfe6ff; font-size:13px; }
    .quest-list{ display:flex; flex-direction:column; gap:10px; }
    .quest-item{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); }
    .quest-item.done{ border-color:rgba(0,214,255,0.40); box-shadow:0 0 0 1px rgba(0,214,255,0.12); }
    .quest-title{ font-weight:800; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .quest-progress{ position:relative; margin-top:8px; background:rgba(255,255,255,0.08); height:12px; border-radius:999px; overflow:hidden; }
    .quest-bar{ position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #00c6ff, #7cf7ff); box-shadow:0 0 14px rgba(0,214,255,0.45); }
    .quest-numbers{ margin-top:6px; color:#c5e6ff; font-size:12px; display:flex; justify-content:space-between; align-items:center; }
    .quest-summary{ padding:10px 12px; background:rgba(255,255,255,0.06); border-radius:12px; border:1px solid rgba(255,255,255,0.08); color:#e9f6ff; font-size:13px; }

    /* ===== ìš°í¸í•¨ ì˜¤ë²„ë ˆì´ ===== */
    #mail-overlay{
      position:fixed; inset:0; z-index:3600;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(4,8,16,0.55), rgba(4,8,16,0.78));
      backdrop-filter: blur(6px);
      opacity:0; pointer-events:none; transition:opacity .22s ease;
      padding:18px;
    }
    #mail-overlay.show{ opacity:1; pointer-events:auto; }
    #mail-card{
      width:min(860px, 96vw);
      background: linear-gradient(180deg, rgba(18,24,36,0.95), rgba(10,16,28,0.96));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 26px 60px rgba(0,0,0,0.45);
      color:#e6f4ff;
      display:flex; flex-direction:column; gap:16px;
      padding:20px 22px;
      max-height:92vh;
    }
    #mail-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #mail-head h3{ margin:0; font-size:20px; }
    #mail-close{
      border:none; background:rgba(255,255,255,0.08);
      color:#f2fbff; border-radius:8px; padding:6px 10px;
      cursor:pointer; font-size:14px;
    }
    #mail-close:hover{ background:rgba(255,255,255,0.15); }
    #mail-content{ display:flex; gap:16px; flex-wrap:wrap; }
    #mail-list{
      flex:1 1 280px; max-height:360px; overflow-y:auto;
      display:flex; flex-direction:column; gap:8px;
    }
    .mail-item{
      display:flex; flex-direction:column; gap:6px;
      padding:10px 12px; border-radius:12px; text-align:left;
      border:1px solid rgba(159,220,255,0.18);
      background:rgba(255,255,255,0.04);
      color:#e8f7ff; cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .mail-item:hover{ transform:translateY(-2px); }
    .mail-item.unread{ border-color:rgba(0,212,255,0.45); background:rgba(0,212,255,0.14); }
    .mail-item.selected{ box-shadow:0 0 0 2px rgba(0,212,255,0.55); }
    .mail-item .mail-subject{ font-weight:700; font-size:14px; color:#f5fbff; }
    .mail-item .mail-preview{ font-size:12px; color:#b7d8ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .mail-item .mail-meta{ display:flex; justify-content:space-between; gap:8px; font-size:11px; color:#8fb9ff; }
    #mail-detail{
      flex:2 1 360px; min-height:280px; max-height:360px;
      background:rgba(8,12,20,0.55);
      border:1px solid rgba(159,220,255,0.18);
      border-radius:12px; padding:16px;
      overflow:auto; display:flex; flex-direction:column; gap:12px;
    }
    #mail-detail h4{ margin:0; font-size:16px; }
    #mail-detail .mail-meta-line{ font-size:12px; color:#9fc8ff; margin-top:4px; }
    #mail-detail .mail-body{ white-space:pre-wrap; line-height:1.6; color:#d8ecff; }
    .mail-empty{ text-align:center; color:#9fc8ff; margin:40px auto; font-size:14px; }
    #mail-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:auto; }
    #mail-actions button{
      border:none; border-radius:10px; padding:10px 14px; font-weight:700;
      cursor:pointer; color:#00121a;
      background:linear-gradient(90deg,#00c0ff,#00a2ff);
    }
    #mail-actions button.secondary{
      background:rgba(0,0,0,0.25); color:#e6f4ff; border:1px solid rgba(159,220,255,0.30);
    }
    #mail-actions button:disabled{ opacity:0.55; cursor:not-allowed; }
    #mail-rewards{ font-size:13px; color:#cfe6ff; display:flex; flex-direction:column; gap:4px; }
    #mail-rewards span{ display:flex; align-items:center; gap:6px; }
    #mail-compose-section{
      border-top:1px solid rgba(159,220,255,0.18);
      padding-top:12px; display:none; flex-direction:column; gap:10px;
    }
    #mail-compose-section.show{ display:flex; }
    #mail-compose-section h4{ margin:0; font-size:15px; }
    #mail-compose-section .mail-hint{ margin:0; font-size:12px; color:#90baff; }
    .mail-field{ display:flex; flex-direction:column; gap:4px; font-size:12px; color:#cfe6ff; }
    #mail-compose-section input,
    #mail-compose-section textarea,
    #mail-compose-section select{
      background:rgba(6,10,20,0.55);
      border:1px solid rgba(159,220,255,0.25);
      border-radius:10px;
      color:#e9f6ff;
      padding:8px 10px;
      font-size:13px;
    }
    #mail-compose-section textarea{ min-height:90px; resize:vertical; }
    .mail-compose-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; }
    #mail-compose-send{
      align-self:flex-end;
      border:none; border-radius:10px;
      padding:10px 16px; font-weight:700; font-size:13px;
      color:#00121a; cursor:pointer;
      background:linear-gradient(90deg,#00f2ff,#00b6ff);
      box-shadow:0 10px 24px rgba(0,160,255,0.22);
    }
    #mail-compose-send:hover{ filter:brightness(1.05); }

    /* ===== ìƒì  ì˜¤ë²„ë ˆì´ ===== */
    #shop-overlay{
      position:fixed; inset:0; z-index:3650;
      display:none; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(4,8,16,0.58), rgba(4,8,16,0.82));
      backdrop-filter:blur(7px);
      padding:20px;
    }
    #shop-overlay.show{ display:flex; }
    #shop-overlay .shop-card{
      width:min(960px,96vw); height:min(720px,92vh);
      background:linear-gradient(180deg, rgba(18,24,36,0.95), rgba(8,12,22,0.97));
      border:1px solid rgba(160,210,255,0.18);
      border-radius:18px;
      box-shadow:0 30px 70px rgba(0,0,0,0.52);
      padding:18px 20px;
      display:flex; flex-direction:column; gap:14px;
      color:#e6f7ff;
    }
    #shop-overlay .shop-head{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    #shop-overlay h3{ margin:0; font-size:18px; color:#f0fbff; }
    #shop-overlay p{ margin:0; font-size:13px; color:#bed9f5; }
    #shop-close{
      border:none; border-radius:8px; padding:6px 12px;
      background:rgba(0,0,0,0.25); color:#d9f2ff; font-weight:600; cursor:pointer;
      transition:background .18s ease;
    }
    #shop-close:hover{ background:rgba(0,0,0,0.38); }
    #shop-frame{
      flex:1 1 auto; width:100%; border:none; border-radius:12px;
      background:#ffffff; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    @media (max-width:720px){
      #shop-overlay .shop-card{ padding:16px; border-radius:14px; }
      #shop-frame{ border-radius:10px; }
    }
    @media (max-width:720px){
      #mail-card{ max-height:94vh; }
      #mail-list{ max-height:240px; }
      #mail-detail{ min-height:200px; max-height:260px; }
    }

    .tabbar{ display:flex; gap:6px; margin:8px 0 10px; flex-wrap:wrap; }
    .tbtn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#eaf6ff; cursor:pointer; font-weight:800; }
    .tbtn.active{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#001820; border-color:transparent; }

    /* ìŠ¬ë¡¯í˜• (ì„¸ë¡œ ë‚™í•˜) */
    #slot-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    .slot-window{ width:320px; height:56px; overflow:hidden; border-radius:10px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }
    .reel{ display:flex; flex-direction:column; }
    .slot-item{ height:56px; display:flex; align-items:center; justify-content:center; font-weight:800; gap:8px; }
    .slot-icon{ font-size:20px; }

    /* ì»¨íŠ¸ë¡¤/í™•ë¥ /ëª©ë¡ */
    #mode-row{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .spinbtn{ padding:10px 14px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.14); font-weight:900; }
    .spin-free{ background:linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    .spin-prem{ background:linear-gradient(180deg,#ffd26b,#ff8b3d); color:#3b1a00; }
    .spin-ecoin{ background:linear-gradient(180deg,#ffe26b,#ff3dd1); color:#3b0030; }
    #prob-toggle{ width:28px; height:28px; border-radius:50%; font-weight:900; cursor:pointer;
      border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#eaf6ff; }
    #prob-panel{ display:none; font-size:12px; color:#cfe6ff; text-align:left; max-width:420px; margin-top:4px; }
    #prob-panel table{ width:100%; border-collapse:collapse; font-size:12px; }
    #prob-panel td{ padding:4px 6px; border-bottom:1px solid rgba(255,255,255,.06); }
    #reward-list{ margin-top:6px; font-size:12px; color:#dbefff; }
    
    /* ë²„í”„ ìƒíƒœ ë³´ê¸° ì˜¤ë²„ë ˆì´ */
    #buff-overlay{
      position:fixed; inset:0; z-index:3650; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #buff-overlay.show{ display:flex; }
    #buff-card{
      width:min(480px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #buff-list{ margin-top:10px; max-height:42vh; overflow-y:auto; }
    .buff-item{
      padding:8px 8px; margin-bottom:4px; border:1px solid rgba(255,255,255,0.05);
      border-radius:10px; background:rgba(0,0,0,0.12); font-size:13px;
      display:flex; justify-content:space-between; gap:8px;
    }

    /* ë²„í”„ ìƒíƒœ ì´ë¦„+ì”ì—¬ (ê¸°ì¡´ spanëŒ€ì‹  ì˜¤ë²„ë ˆì´ì—ì„œ í‘œì‹œí•˜ë¯€ë¡œ ìµœì†Œí™”) */
    #buff-status{ display:none; }

    /* í† ìŠ¤íŠ¸ */
    #toast{
      position: fixed;
      left: 50%;
      bottom: calc(80px + env(safe-area-inset-bottom, 12px));
      transform: translateX(-50%) translateY(20px);
      min-width: 220px; max-width: 92vw;
      padding: 10px 12px;
      background: rgba(10,12,20,0.85);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      color:#eaf6ff; font-weight:800; font-size:13px;
      display: none; z-index: 4000;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    #toast.show{ display:block; animation: toast-pop .28s ease-out forwards; }
    #toast .t-row{ display:flex; align-items:center; gap:10px; }
    #toast .t-msg{ flex:1; }
    #toast .t-btn{
      padding: 6px 10px; border-radius: 8px; border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; font-weight:900; cursor:pointer;
    }
    @keyframes toast-pop {
      from { opacity:0; transform: translateX(-50%) translateY(20px); }
      to   { opacity:1; transform: translateX(-50%) translateY(0); }
    }

    /* ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë²„ë ˆì´ */
    #migrate-overlay{
      position: fixed; inset:0; z-index:3600; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px);
    }
    #migrate-overlay.show{ display:flex; }
    #migrate-card{
      width:min(560px, 94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08);
      color:#eaf6ff;
    }
    #migrate-card h3{ margin:0 0 8px; font-size:18px; }
    #migrate-desc{ font-size:13px; color:#cfe6ff; line-height:1.5; }
    .warnbox{
      margin:10px 0; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,211,110,.45);
      background: rgba(255,211,110,.10); color:#ffe3a3; font-weight:700;
    }
    #migrate-progress{ margin-top:10px; font-size:13px; color:#a6e7ff; min-height:20px; }
    #migrate-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #migrate-start{ padding:10px 14px; border-radius:10px; border:none; font-weight:900; cursor:pointer;
      background: linear-gradient(180deg,#00ffa8,#00d2ff); color:#002018; }
    #migrate-start[disabled]{ opacity:.6; cursor:not-allowed; }

    /* PC íŒì—… ì•ˆë‚´ ê²Œì´íŠ¸ */
    #popup-gate {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(2,6,12,0.70), rgba(2,6,12,0.85));
      backdrop-filter: blur(4px);
      z-index: 3700;
    }
    #popup-gate.show { display: flex; }
    #popup-gate .gate-card {
      width: min(520px, 92vw);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(10,12,18,0.66));
      padding: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
      color: #eaf6ff;
      text-align: center;
    }
    #popup-gate .gate-card h3 {
      margin: 0 0 10px;
      font-size: 18px;
    }
    #popup-gate .gate-card p {
      margin: 6px 0;
      font-size: 14px;
      color: #cfe6ff;
      line-height: 1.6;
    }
    #popup-gate-count {
      font-weight: 800;
      color: #ffd36e;
    }
    .admin-login {
      margin-top: 18px;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(6, 10, 18, 0.72);
      text-align: left;
      display: none;
    }
    .admin-login.show { display: block; }
    .admin-login h4 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #ffe18a;
    }
    .admin-login p {
      margin: 4px 0 10px;
      font-size: 13px;
      color: #dde9ff;
      line-height: 1.5;
    }
    .admin-login input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-size: 13px;
      outline: none;
    }
    .admin-login input:focus {
      border-color: rgba(255,209,110,0.65);
      box-shadow: 0 8px 22px rgba(255,209,110,0.12);
    }
    .admin-login .admin-submit {
      width: 100%;
      margin-top: 2px;
      background: linear-gradient(90deg,#ffd866,#f7b733);
      color: #2d1b00;
      border: none;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .admin-login .admin-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .admin-login .admin-error {
      min-height: 16px;
      margin: 6px 0 0;
      font-size: 12px;
      color: #ff9a9a;
    }
    .admin-login .admin-progress {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      background: #ffe26a;
      color: #2d1b00;
      font-weight: 700;
      display: none;
    }
    .admin-login .admin-progress.show { display: block; }

    #session-lock-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(2,6,12,0.70), rgba(2,6,12,0.86));
      backdrop-filter: blur(6px);
      z-index: 4000;
    }
    #session-lock-overlay.show { display: flex; }
    #session-lock-overlay .lock-card {
      width: min(420px, 92vw);
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(6,8,14,0.72));
      box-shadow: 0 22px 60px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.08);
      text-align: center;
      color: #eaf6ff;
    }
    #js-hard-block-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: linear-gradient(180deg, rgba(2,4,10,0.85), rgba(3,6,16,0.92));
      backdrop-filter: blur(6px);
      z-index: 5000;
    }
    #js-hard-block-overlay.show { display: flex; }
    #js-hard-block-overlay .block-card {
      width: min(420px, 94vw);
      padding: 22px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(10,12,22,0.96), rgba(4,6,12,0.98));
      box-shadow: 0 28px 70px rgba(0,0,0,0.65), inset 0 1px 0 rgba(255,255,255,0.03);
      color: #e8f6ff;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #js-hard-block-overlay .block-card h3 {
      margin: 0;
      font-size: 19px;
      color: #ffb6c1;
    }
    #js-hard-block-overlay .block-card p {
      margin: 0;
      font-size: 14px;
      color: #d2e8ff;
      line-height: 1.5;
    }
    #js-hard-block-overlay .block-card .device-label {
      font-size: 13px;
      color: #8fb9ff;
    }
    #js-hard-block-overlay .block-card .error-code {
      font-size: 12px;
      color: #ff9f9f;
      margin-top: 2px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    #js-hard-block-overlay .block-card button {
      margin-top: 4px;
      border: none;
      border-radius: 10px;
      padding: 11px;
      font-weight: 700;
      background: linear-gradient(90deg,#ff7c7c,#ff416c);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(255,65,108,0.35);
    }
    #session-lock-overlay .lock-card h3 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    #session-lock-overlay .lock-card p {
      margin: 6px 0;
      font-size: 13px;
      color: #d8ecff;
    }
    #session-lock-overlay .lock-card .lock-note {
      font-size: 12px;
      color: #9ec9ff;
      margin-top: 4px;
    }
    #session-lock-overlay .lock-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    #session-lock-overlay .lock-status {
      min-height: 18px;
      font-size: 13px;
      color: #ffdede;
      margin-top: 12px;
    }
    #session-lock-overlay .admin-login {
      margin-top: 18px;
    }

    /* ì´ìš©ì•½ê´€ & ì •ì§€ ì˜¤ë²„ë ˆì´ */
    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,12,.60), rgba(2,6,12,.80)); backdrop-filter: blur(4px); z-index:3650; }
    .overlay.show{ display:flex; }
    .overlay-card{ width:min(620px,94vw); border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(10,12,18,.66));
      padding:16px; box-shadow: 0 22px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.08); color:#eaf6ff; }
    .overlay-card h3{ margin:0 0 8px; font-size:18px; }
    .overlay-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    #tos-body{ max-height:40vh; overflow:auto; padding:10px; border:1px solid rgba(255,255,255,0.10);
      border-radius:10px; background: rgba(0,0,0,0.2); font-size:13px; color:#cfe6ff; }
    #tos-accept[disabled]{ opacity:.6; cursor:not-allowed; }
</style>

  <script src="language.js"></script>
  <script src="https://cdn.gtranslate.net/widgets/latest/popup.js" defer></script>
</head>
<body>
  <div id="snow-layer" aria-hidden="true"></div>
  <div class="gtranslate_wrapper" aria-hidden="true"></div>
  <!-- PC íŒì—… ì•ˆë‚´ ê²Œì´íŠ¸ -->
  <div id="popup-gate" aria-hidden="true">
    <div class="gate-card" role="alertdialog" aria-modal="true" aria-labelledby="popup-gate-title">
      <h3 id="popup-gate-title">PCì—ì„œëŠ” íŒì—… í—ˆìš©ì´ í•„ìš”í•´ìš”</h3>
      <p>ì»´í“¨í„°ì—ì„œ ê²Œì„ì„ ì‹¤í–‰í•  ë•ŒëŠ” <b>íŒì—…ì„ í—ˆìš©</b>í•´ì•¼ ìƒˆ ì°½ìœ¼ë¡œ ì—´ ìˆ˜ ìˆì–´ìš”.</p>
      <p>íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ <span style="white-space:nowrap;">ê²Œì„ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span></p>
      <p><span id="popup-gate-count">5</span>ì´ˆ í›„ ë©”ë‰´ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
      <div class="overlay-actions" style="justify-content:center; margin-top:16px;">
        <button id="popup-gate-back" class="spinbtn" type="button">ë°”ë¡œ ì´ë™í•˜ê¸°</button>
      </div>
      <div id="admin-login" class="admin-login" aria-hidden="true">
        <h4>ê´€ë¦¬ì í™•ì¸</h4>
        <p>ê´€ë¦¬ì ì¸ì¦ í›„ í˜„ì¬ ì°½ì—ì„œë„ ê²Œì„ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <input type="text" id="admin-id" placeholder="ì•„ì´ë””" autocomplete="off" />
        <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" />
        <button id="admin-submit" class="spinbtn admin-submit" type="button">í™•ì¸</button>
        <p id="admin-error" class="admin-error" role="status" aria-live="polite"></p>
        <div id="admin-progress" class="admin-progress" role="status" aria-live="assertive"></div>
      </div>
    </div>
  </div>

  <div id="session-lock-overlay" aria-hidden="true">
    <div class="lock-card" role="alertdialog" aria-modal="true" aria-labelledby="session-lock-title">
      <h3 id="session-lock-title">ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì°½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
      <p id="session-lock-desc">
        ê°™ì€ ê³„ì •ì´ ì—¬ëŸ¬ ì°½ì´ë‚˜ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë™ì‹œì— ì—´ë¦¬ë©´ ì´ìš©ì•½ê´€ ìœ„ë°˜ìœ¼ë¡œ ê°„ì£¼ë  ìˆ˜ ìˆì–´ìš”.
        ì˜¤íƒì„ í”¼í•˜ê¸° ìœ„í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ì°½ë§Œ í—ˆìš©í•˜ê³  ìˆìœ¼ë‹ˆ ë„ˆê·¸ëŸ½ê²Œ ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
      </p>
      <p id="session-lock-status" class="lock-status" role="status" aria-live="polite"></p>
      <p id="session-lock-note" class="lock-note">ë‹¤ë¥¸ ì°½ì„ ë‹«ì€ ë’¤ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
      <div class="lock-actions">
        <button id="session-lock-retry" class="spinbtn" type="button">ë‹¤ì‹œ ì‹œë„</button>
        <button id="session-lock-remote-logout" class="ghost-btn" type="button" style="display:none">ì›ê²© ë¡œê·¸ì•„ì›ƒ</button>
        <button id="session-lock-admin-toggle" class="ghost-btn" type="button">ê´€ë¦¬ì ì¸ì¦</button>
      </div>
      <div id="session-lock-admin" class="admin-login" aria-hidden="true">
        <h4>ê´€ë¦¬ì í™•ì¸</h4>
        <p>ê´€ë¦¬ì ì¸ì¦ì„ ì™„ë£Œí•˜ë©´ ì—¬ëŸ¬ ì°½ì—ì„œë„ í”Œë ˆì´ë¥¼ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <input type="text" id="session-admin-id" placeholder="ì•„ì´ë””" autocomplete="off" />
        <input type="password" id="session-admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" />
        <button id="session-admin-submit" class="spinbtn admin-submit" type="button">í™•ì¸</button>
        <p id="session-admin-error" class="admin-error" role="status" aria-live="polite"></p>
        <div id="session-admin-progress" class="admin-progress" role="status" aria-live="assertive"></div>
      </div>
    </div>
  </div>

  <div id="js-hard-block-overlay" aria-hidden="true">
    <div class="block-card" role="alertdialog" aria-modal="true" aria-labelledby="js-hard-block-title">
      <h3 id="js-hard-block-title">ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‹¤í–‰ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
      <p id="js-hard-block-desc">ë³´ì•ˆì„ ìœ„í•´ í˜„ì¬ ì°½ì˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.</p>
      <p id="js-hard-block-device" class="device-label" role="status" aria-live="polite"></p>
      <p id="js-hard-block-error" class="error-code" role="status" aria-live="assertive"></p>
      <button id="js-hard-block-reload" type="button">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- ë¶€íŒ… ì¤‘ ì˜¤ë²„ë ˆì´ (ìµœì´ˆ 1íšŒë§Œ) -->
  <div id="boot-overlay" aria-hidden="false">
    <div class="card" role="status" aria-live="polite" aria-atomic="true">
      <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
        <div aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>
        <div style="text-align:left;">
          <div style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
          <div style="font-size:12px; color:#bcd8ee; margin-top:2px;">ê²Œì„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”</div>
        </div>
      </div>
      <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
    </div>
  </div>

  <!-- ì¸ì¦ -->
  <div id="auth-container" role="dialog" aria-labelledby="auth-title">
    <div style="display:flex; gap:8px; justify-content:center; margin-bottom:12px;">
      <button id="auth-tab-login" class="ghost-btn" style="flex:1; max-width:160px;">ë¡œê·¸ì¸</button>
      <button id="auth-tab-signup" class="ghost-btn" style="flex:1; max-width:160px;">íšŒì›ê°€ì…</button>
    </div>

    <h2 id="auth-title">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" autocomplete="username" />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <div id="signup-extra" style="display:none; margin-top:6px;">
      <input type="password" id="password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password" />
      <div class="policy-consent">
        <label class="policy-consent-item">
          <input type="checkbox" id="tos-checkbox" />
          <span>
            ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤
            <button type="button" id="tos-more-link" class="policy-link" data-policy="terms">ìì„¸íˆ ë³´ê¸°</button>
          </span>
        </label>
        <label class="policy-consent-item">
          <input type="checkbox" id="privacy-checkbox" />
          <span>
            ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤
            <button type="button" id="privacy-more-link" class="policy-link" data-policy="privacy">ìì„¸íˆ ë³´ê¸°</button>
          </span>
        </label>
      </div>
      <div style="margin-top:6px; font-size:12px; color:#cfe6ff; text-align:left; line-height:1.45;">
        <b>ì•ˆë‚´:</b><br/>
        Â· ì¹˜íŒ…/í•µ ì‚¬ìš©, ë²„ê·¸ ì•…ìš©, ê³„ì • ì–‘ë„/ëŒ€ì—¬ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.<br/>
        Â· <u>ìì›Â·ì½”ì¸ ë¹„ì •ìƒ ê¸‰ì¦(ì˜ˆ: í•œ ë²ˆì— 10ì–µ ì½”ì¸)</u> íƒì§€ ì‹œ ê²½ê³  ë˜ëŠ” ì¦‰ì‹œ ì •ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        Â· ì•½ê´€ ë° ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ê³  ë™ì˜í•´ ì£¼ì„¸ìš”.
      </div>
    </div>

    <button id="login-btn" class="primary-btn">ë¡œê·¸ì¸</button>
    <button id="signup-btn" class="ghost-btn" style="display:none">íšŒì›ê°€ì…</button>
    <button id="guest-start-btn" class="ghost-btn" style="margin-top:10px;">ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°</button>

    <button id="google-btn" aria-label="êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° (ê¶Œì¥)" class="google-btn">
      <span class="g-icon" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false"><path fill="#EA4335" d="M24 9.5c3.9 0 6.6 1.7 8.1 3.1l6-5.8C35.7 3.7 30.2 1.5 24 1.5 14.7 1.5 6.9 6.9 3.1 14.8l7.4 5.7C12.2 15 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24c0-1.6-.1-2.9-.4-4.2H24v8.0h12.7c-.5 2.9-2.6 5.5-5.6 7.2l8.6 6.6C43.8 36.3 46.5 30.6 46.5 24z"/><path fill="#4A90E2" d="M10.5 29.4A14.6 14.6 0 0 1 9.5 24c0-1.6.3-3.2.8-4.6L3 13.6C1.1 16.8 0 20.3 0 24,0 3.7 1.1 7.3 3 10.4l7.5-5z"/><path fill="#FBBC05" d="M24 46.5c6.2 0 11.7-2.1 15.9-5.7l-8.6-6.6c-2.4 1.6-5.4 2.6-7.3 2.6-6.3 0-11.7-5.5-12.8-12.2L3.1 33.2C6.9 41.1 14.7 46.5 24 46.5z"/></svg>
      </span>
      <span class="g-text">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸° <small>(ê¶Œì¥)</small></span>
    </button>

    <button id="btnGoogleLoginCode" aria-label="êµ¬ê¸€ ì½”ë“œ ë¡œê·¸ì¸(ì•± ì „ìš©)" class="google-btn" type="button">
      <span class="g-icon" aria-hidden="true">ğŸ”‘</span>
      <span class="g-text">êµ¬ê¸€ ë¡œê·¸ì¸(ì½”ë“œ) <small>ì•±(WebView) ì „ìš©</small></span>
    </button>

    <div id="codeArea" style="display:none; margin-top: 8px;">
      <p id="codeInfoText" style="font-size: 0.9rem; color: #ccc;">
        ì•± ì „ìš© ì½”ë“œ ë¡œê·¸ì¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...
      </p>
      <div id="codeDisplay"
           style="font-size: 32px; font-weight: bold; letter-spacing: 3px;"></div>
      <p id="codeStatus" style="font-size: 0.9rem; color: #aaa;"></p>
    </div>

    <div id="find-links" style="display:flex; gap:8px; justify-content:center; margin-top:10px; width:100%;">
      <a id="find-pw" href="find.html" style="flex:1; max-width:320px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); color:#fff; font-weight:600;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
    </div>

    <p id="auth-error" class="auth-status" role="status" aria-live="polite"></p>
    <p id="verify-info" class="auth-status" role="status" aria-live="polite" style="color:#dfffe8"></p>

    <div id="login-overlay" class="login-overlay" aria-hidden="true">
      <div class="login-card" role="status" aria-live="polite" aria-atomic="true" style="text-align:center;color:#e6f7ff;">
        <div style="display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px;">
          <div id="overlay-provider-icon" aria-hidden="true" style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.06);">ğŸ”’</div>
          <div style="text-align:left;">
            <div id="login-overlay-title" style="font-weight:800; font-size:15px;">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘</div>
            <div id="login-overlay-sub"   style="font-size:12px; color:#bcd8ee; margin-top:2px;">ë³´ì•ˆ ì—°ê²° Â· ì¸ì¦ ì¤‘â€¦</div>
          </div>
        </div>
        <div style="margin:0 auto 12px;"><div class="spinner" aria-hidden="true"></div></div>
      </div>
    </div>

  </div>

  <div id="policy-overlay" aria-hidden="true">
    <div class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="policy-title">
      <div class="policy-header">
        <h3 id="policy-title">ì •ì±… ìì„¸íˆ ë³´ê¸°</h3>
        <div class="policy-actions">
          <a id="policy-open-new" class="policy-open-new" href="/privacy" target="_blank" rel="noopener">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</a>
          <button type="button" id="policy-close" class="policy-close">ë‹«ê¸°</button>
        </div>
      </div>
      <iframe id="policy-frame" title="ì •ì±… ìƒì„¸" loading="lazy"></iframe>
      <div class="policy-foot">í”„ë ˆì„ ë‚´ ë¬¸ì„œê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ìƒˆ íƒ­ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.</div>
    </div>
  </div>

  <!-- ìƒë‹¨ ë°” & ë©”ì¸ ê²Œì„ -->
  <div id="top-bar">
    <div class="bar-group">
      <img src="/images/resource-icon.png" alt="Resource" />
      <span id="score">ìì›: 0</span>
      <img src="/images/coin-icon.png" alt="Coin" />
      <span id="coins">ì½”ì¸: 0</span>
      <img src="/images/event-icon.png" alt="EventCoin" />
      <span id="ecoins">ì´ë²¤íŠ¸ì½”ì¸: 0</span>
    </div>
    <div class="bar-group">
      <!-- ë²„í”„ ë²„íŠ¼ìœ¼ë¡œ êµì²´ -->
      <button id="buff-btn" aria-label="í˜„ì¬ ë²„í”„ ë³´ê¸°">ë²„í”„(0)</button>
      <span id="suspicion-badge" title="í•µ ì‚¬ìš© ì˜ì‹¬ë„">ì˜ì‹¬ë„: 0</span>
      <button id="guest-login-btn" type="button" aria-label="ê²ŒìŠ¤íŠ¸ì—ì„œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™">ğŸ” ë¡œê·¸ì¸</button>
      <button id="settings-btn" aria-label="ì„¤ì •ìœ¼ë¡œ ì´ë™">âš™ï¸ ì„¤ì •</button>
    </div>
  </div>

  <div id="container">
    <h1>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ ğŸŒŒ</h1>

    <div id="main-content" class="tab-content active">
      <div id="ore-container" style="position:relative; display:inline-block;">
        <img src="/images/ore.png" id="ore" alt="ê´‘ì„" />
      </div>
      <div style="display:flex; justify-content:center; gap:8px; align-items:center; margin-top:10px;">
        <button id="convert-button" class="general">10ìì› â†’ 1ì½”ì¸</button>
        <button id="auto-convert-buy" class="general">ìë™ë³€í™˜ êµ¬ë§¤<br>(100ì½”ì¸)</button>
      </div>
    </div>

    <div id="workers-content" class="tab-content">
      <p>ì´ ì´ˆë‹¹ ìì›: <span id="resource-per-sec">0</span></p>
      <button id="hire-worker" class="general">ì•Œë°” ê³ ìš© (<span id="worker-cost">0</span>ì½”ì¸)</button>
      <button id="hire-worker-ec" class="general">ì•Œë°” +10ë ™ (1EC)</button>
      <p>ì´ ì´ˆë‹¹ ì½”ì¸: <span id="coin-per-sec">0</span></p>
      <button id="hire-conversion" class="general">ì½”ì¸ ì•Œë°” (<span id="conversion-cost">0</span>ì½”ì¸)</button>
      <button id="hire-conversion-ec" class="general">ì½”ì¸ ì•Œë°” +10ë ™ (1EC)</button>
    </div>

    <div id="ship-content" class="tab-content">
      <div class="ship-panel" aria-live="polite">
        <h2>ìš°ì£¼ì„  ì œì–´ì‹¤</h2>
        <img id="ship-img" src="/images/ship-level1.png" alt="ìš°ì£¼ì„ " />
        <div class="ship-status" id="ship-level">1ë ™ (20ì½”ì¸)</div>
        <div class="ship-enhance-info">ê°•í™” ì„±ê³µ í™•ë¥ : <strong id="ship-success-rate">100%</strong></div>
        <p>ìš°ì£¼ì„ ì„ ì—…ê·¸ë ˆì´ë“œí•´ ë” ë¨¼ í–‰ì„±ê³¼ ìƒˆë¡œìš´ ì½˜í…ì¸ ë¥¼ ê°œë°©í•˜ì„¸ìš”.</p>
        <button id="upgrade-ship" class="general">ìš°ì£¼ì„  ì—…ê·¸ë ˆì´ë“œ</button>
        <div class="ship-enhance-status" id="ship-upgrade-status" aria-live="polite">ì²« ê°•í™”ëŠ” 100% ì„±ê³µ! ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ í™•ë¥ ì´ ë‚®ì•„ì§‘ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div id="upgrades-content" class="tab-content">
      <p>í´ë¦­ë‹¹ ìì›: <span id="click-power">1</span></p>
      <div class="upgrade-actions">
        <button id="click-upgrade" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (15ì½”ì¸)</button>
        <button id="click-upgrade-ec" class="general">í´ë¦­ ì—…ê·¸ë ˆì´ë“œ +10ë ™ (1EC)</button>
      </div>
    </div>

    <div id="planets-content" class="tab-content">
      <div id="planet-list"></div>
    </div>

    <div id="christmas-content" class="tab-content">
      <div class="event-panel">
        <div class="event-card">
          <h3>ğŸ„ 2025 í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸</h3>
          <div class="event-stats">
            <div class="pill"><img src="/images/santa-piece.png" alt="ì‚°íƒ€ ì¡°ê°" /> ì‚°íƒ€ ì¡°ê°: <span id="santa-pieces">0</span></div>
            <div class="pill"><img src="/images/santa-coin.png" alt="ì‚°íƒ€ ì´ë²¤íŠ¸ ì½”ì¸" /> ì‚°íƒ€ ì´ë²¤íŠ¸ì½”ì¸: <span id="santa-coins">0</span></div>
            <div class="pill"><img src="/images/event-icon.png" alt="ì´ë²¤íŠ¸ì½”ì¸" /> ì´ë²¤íŠ¸ì½”ì¸: <span id="event-coins-inline">0</span></div>
          </div>
          <div class="event-actions">
            <button id="craft-santa-coin" class="general" type="button">ì‚°íƒ€ì½”ì¸ ì œì‘ (ì¡°ê° 10ê°œ)</button>
            <button id="convert-ecoin-to-santacoin" class="general" type="button">ì´ë²¤íŠ¸ì½”ì¸ â†’ ì‚°íƒ€ì½”ì¸ (3:1)</button>
            <button id="christmas-upgrade" class="general" type="button">íŠ¸ë¦¬ ê°•í™”</button>
          </div>
          <div class="tree-status">
            <img id="tree-image" class="tree-figure" src="/images/tree1.png" alt="í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬" />
            <div>
              <div>í˜„ì¬ íŠ¸ë¦¬ ë ˆë²¨: <strong id="tree-level">0</strong> / 6</div>
              <div>ë‹¤ìŒ ê°•í™” í•„ìš” ì‚°íƒ€ì½”ì¸: <strong id="tree-cost">-</strong></div>
            </div>
          </div>
          <div class="tree-rewards" id="tree-rewards">íŠ¹ë³„ ë³´ìƒ ì•ˆë‚´</div>
        </div>

        <div class="event-card">
          <h3>ğŸ§ ë¦¬ë“¬ê²Œì„ (ì‚°íƒ€ ì¡°ê° íšë“)</h3>
          <p style="margin:6px 0 10px; color:#cfe6ff;">í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í…Œë§ˆ ì €ì‘ê¶Œ ë¬´ë£Œ ìŒì•… 10ê³¡ì„ ì¤€ë¹„í–ˆì–´ìš”. ê³¡ì„ ì™„ì£¼í•˜ê³  í•œ ë²ˆë„ í‹€ë¦¬ì§€ ì•Šìœ¼ë©´ <b>ì‚°íƒ€ ì¡°ê° 5ê°œ</b>ë¥¼ íšë“í•©ë‹ˆë‹¤.</p>
          <div class="christmas-launch">
            <button id="christmas-start" class="general" type="button">ë¦¬ë“¬ê²Œì„ ì‹œì‘í•˜ê¸°</button>
            <div id="christmas-launch-hint">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì „ì²´ í™”ë©´ì—ì„œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¦¬ë“¬ê²Œì„ì„ ì¦ê¸¸ ìˆ˜ ìˆì–´ìš”.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="christmas-overlay" aria-hidden="true">
      <button id="christmas-close" type="button" aria-label="ë¦¬ë“¬ê²Œì„ ë‹«ê¸°">âœ•</button>
      <iframe id="christmas-frame" title="í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¦¬ë“¬ê²Œì„" src="about:blank" data-src="Christmas.html" loading="lazy" allowfullscreen></iframe>
    </div>

    <!-- ë°”í…€ ë‚´ë¹„ -->
    <nav id="bottom-nav" aria-label="ê²Œì„ íƒ­ ë‚´ë¹„ê²Œì´ì…˜">
      <div class="tab active" data-tab="main"     role="button" tabindex="0"><span class="t-icon">ğŸª¨</span><span class="t-label">ë©”ì¸</span></div>
      <div class="tab"        data-tab="workers"  role="button" tabindex="0"><span class="t-icon">ğŸ‘©â€ğŸš€</span><span class="t-label">ìš°ì£¼ì¸</span></div>
      <div class="tab"        data-tab="ship"     role="button" tabindex="0"><span class="t-icon">ğŸš€</span><span class="t-label">ìš°ì£¼ì„ </span></div>
      <div class="tab"        data-tab="upgrades" role="button" tabindex="0"><span class="t-icon">âš™ï¸</span><span class="t-label">ì—…ê·¸ë ˆì´ë“œ</span></div>
      <div class="tab"        data-tab="planets"  role="button" tabindex="0"><span class="t-icon">ğŸª</span><span class="t-label">í–‰ì„±</span></div>
      <div class="tab"        data-tab="christmas" role="button" tabindex="0"><span class="t-icon">ğŸ„</span><span class="t-label">í¬ë¦¬ìŠ¤ë§ˆìŠ¤</span></div>
    </nav>
  </div>

  <!-- ì»¤ìŠ¤í…€ ë©”ë‰´ -->
    <div id="custom-menu">
      <div class="menu-item" data-action="menu"><span>ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></div>
      <div class="menu-item" data-action="download"><span>â¬‡ï¸ ì•± ë‹¤ìš´ë¡œë“œ</span></div>
      <div class="menu-item" data-action="shop"><span>ğŸš€ ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬</span></div>
      <div class="menu-item" data-action="resume"><span>â–¶ï¸ ê²Œì„ ê³„ì†í•˜ê¸°</span></div>
      <div class="menu-item" data-action="rank"><span>ğŸ† ë­í‚¹ ë³´ê¸°</span></div>
      <div class="menu-item" data-action="mail">
        <span>âœ‰ï¸ ìš°í¸í•¨</span>
        <span class="count-badge hidden" id="mail-unread-badge">0</span>
      </div>
      <div class="menu-item" data-action="quests">
        <span>ğŸ—’ï¸ í€˜ìŠ¤íŠ¸</span>
        <span class="count-badge hidden" id="quest-badge">!</span>
      </div>
      <div class="menu-item" data-action="attendance">
        <span>ğŸ“… ì¶œì„ ë³´ìƒ</span>
        <span id="attendance-left">-</span>
    </div>
  </div>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
  <button id="side-menu-toggle" aria-label="ì‚¬ì´ë“œ ë©”ë‰´ ì—´ê¸°" title="ë©”ë‰´">â˜°</button>
  <div id="side-backdrop" aria-hidden="true"></div>
  <aside id="side-menu" aria-label="ì‚¬ì´ë“œ ë©”ë‰´" aria-hidden="true">
    <div class="side-header">ë©”ë‰´</div>
    <nav class="side-items">
      <button class="side-item" data-action="menu"><span class="icon">ğŸ®</span><span>ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</span></button>
      <button class="side-item" data-action="download"><span class="icon">â¬‡ï¸</span><span>ì•± ë‹¤ìš´ë¡œë“œ</span></button>
      <button class="side-item" data-action="shop"><span class="icon">ğŸ›’</span><span>ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬</span></button>
      <button class="side-item" data-action="resume"><span class="icon">â–¶ï¸</span><span>ê²Œì„ ê³„ì†í•˜ê¸°</span></button>
      <button class="side-item" data-action="rank"><span class="icon">ğŸ†</span><span>ë­í‚¹ ë³´ê¸°</span></button>
      <button class="side-item" data-action="mail">
        <span><span class="icon">âœ‰ï¸</span>ìš°í¸í•¨</span>
        <span class="side-right" id="mail-unread-side">-</span>
      </button>
      <button class="side-item" data-action="quests">
        <span><span class="icon">ğŸ—’ï¸</span>í€˜ìŠ¤íŠ¸</span>
        <span class="side-right" id="quest-status-side">-</span>
      </button>
      <button class="side-item" data-action="attendance">
        <span><span class="icon">ğŸ“…</span>ì¶œì„ ë³´ìƒ</span>
        <span class="side-right" id="attendance-left-side">-</span>
      </button>
    </nav>
  </aside>

  <div id="mail-overlay" aria-hidden="true">
    <div id="mail-card" role="dialog" aria-modal="true" aria-labelledby="mail-title">
      <div id="mail-head">
        <h3 id="mail-title">âœ‰ï¸ ìš°í¸í•¨</h3>
        <button id="mail-close" aria-label="ìš°í¸í•¨ ë‹«ê¸°">âœ•</button>
      </div>
      <div id="mail-content">
        <div id="mail-list" role="listbox" aria-label="ë°›ì€ ìš°í¸ ëª©ë¡"></div>
        <div id="mail-detail" role="region" aria-live="polite"></div>
      </div>
      <div id="mail-compose-section" aria-live="polite">
        <h4>ê´€ë¦¬ì ìš°í¸ ë³´ë‚´ê¸°</h4>
        <p class="mail-hint">í˜„ì¬ ì‘ì„±í•œ ìš°í¸ì€ ë“±ë¡ëœ ëª¨ë“  ìœ ì €ì˜ ìš°í¸í•¨ìœ¼ë¡œ ë°œì†¡ë©ë‹ˆë‹¤.</p>
        <label class="mail-field">
          <span>ìˆ˜ì‹  ëŒ€ìƒ</span>
          <input type="text" id="mail-compose-target" value="ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)" autocomplete="off" readonly />
        </label>
        <label class="mail-field">
          <span>ì œëª©</span>
          <input type="text" id="mail-compose-subject" maxlength="80" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </label>
        <label class="mail-field">
          <span>ë‚´ìš©</span>
          <textarea id="mail-compose-body" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </label>
        <div class="mail-compose-grid">
          <label class="mail-field">
            <span>ìì›</span>
            <input type="number" id="mail-compose-res" min="0" step="1" value="0" />
          </label>
          <label class="mail-field">
            <span>ì½”ì¸</span>
            <input type="number" id="mail-compose-coin" min="0" step="1" value="0" />
          </label>
          <label class="mail-field">
            <span>ì´ë²¤íŠ¸ì½”ì¸</span>
            <input type="number" id="mail-compose-ecoin" min="0" step="1" value="0" />
          </label>
        </div>
        <div class="mail-compose-grid">
          <label class="mail-field">
            <span>ë²„í”„ ì¢…ë¥˜</span>
            <select id="mail-compose-buff-type">
              <option value="">ì—†ìŒ</option>
              <option value="all">ì „ì²´ ìƒì‚°</option>
              <option value="coin">ì½”ì¸ ìƒì‚°</option>
              <option value="res">ìì› ìƒì‚°</option>
            </select>
          </label>
          <label class="mail-field">
            <span>ë²„í”„ ë°°ìœ¨(xN)</span>
            <input type="number" id="mail-compose-buff-mult" min="0" step="0.1" value="1" />
          </label>
          <label class="mail-field">
            <span>ë²„í”„ ì§€ì†(ë¶„)</span>
            <input type="number" id="mail-compose-buff-min" min="0" step="1" value="0" />
          </label>
        </div>
        <button id="mail-compose-send" type="button">ğŸ“¨ ìš°í¸ ë°œì†¡</button>
      </div>
    </div>
  </div>

  <div id="shop-overlay" aria-hidden="true">
    <div class="shop-card" role="dialog" aria-modal="true" aria-labelledby="shop-title">
      <div class="shop-head">
        <h3 id="shop-title">ğŸ›’ ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬</h3>
        <button id="shop-close" aria-label="ìƒì  ë‹«ê¸°">âœ•</button>
      </div>
      <p>í˜ì´ì•± ê²°ì œ ëª¨ë“ˆì„ í†µí•´ ì´ë²¤íŠ¸ì½”ì¸ ë“±ì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <iframe id="shop-frame" title="íƒœì–‘ê³„ ì •ë³µ ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬" loading="lazy" src="about:blank" allow="payment *"></iframe>
    </div>
  </div>

  <!-- ì¶œì„/ìŠ¬ë¡¯ ì˜¤ë²„ë ˆì´ -->
  <div id="daily-overlay" aria-hidden="true">
    <div id="daily-card" role="dialog" aria-modal="true" aria-labelledby="daily-title">
      <div id="daily-title">
        <span>ğŸ“… ì˜¤ëŠ˜ì˜ ë³´ìƒ & ìŠ¬ë¡¯</span>
        <button id="prob-toggle" title="í™•ë¥ /ë³´ìƒ ì •ë³´">i</button>
      </div>

      <div class="tabbar">
        <button class="tbtn active" data-mode="daily">ì¶œì„ ìŠ¬ë¡¯(ë¬´ë£Œ/ì¼1íšŒ)</button>
        <button class="tbtn" data-mode="premium">í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯(ì¼ì¼ í€˜ìŠ¤íŠ¸)</button>
        <button class="tbtn" data-mode="ecoin">ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯(ì£¼ê°„ í€˜ìŠ¤íŠ¸)</button>
      </div>

      <div id="daily-info">í™•ì¸ ì¤‘â€¦</div>
      <div id="slot-access-info"></div>

      <div id="slot-wrap">
        <div class="slot-window">
          <div id="slot-reel" class="reel"></div>
        </div>
      </div>

      <div id="mode-row">
        <button id="spin-daily"   class="spinbtn spin-free">ë¬´ë£Œ ì¶œì„ ëŒë¦¬ê¸°</button>
        <button id="spin-premium" class="spinbtn spin-prem">í”„ë¦¬ë¯¸ì—„ ëŒë¦¬ê¸°(ì¼ì¼ í€˜ìŠ¤íŠ¸)</button>
        <button id="spin-ecoin"   class="spinbtn spin-ecoin">ì´ë²¤íŠ¸ì½”ì¸ ëŒë¦¬ê¸°(ì£¼ê°„ í€˜ìŠ¤íŠ¸)</button>
      </div>

      <div id="prob-panel"></div>
      <div id="reward-list"></div>

      <div id="daily-actions">
        <button id="daily-close">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¶ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë²„ë ˆì´ -->
  <div id="migrate-overlay" aria-hidden="true">
    <div id="migrate-card" role="dialog" aria-modal="true" aria-labelledby="migrate-title">
      <h3 id="migrate-title">ë°ì´í„° ì €ì¥ ë°©ì‹ ë³€ê²½ ì•ˆë‚´</h3>
      <div id="migrate-desc">
        ê²Œì„ ë‚´ ë°ì´í„° ì €ì¥ ë°©ì‹ì´ ë³€ê²½ë˜ì–´ <b>ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>
        ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>ê¸°ì¡´ ìœ„ì¹˜ì˜ ëª¨ë“  ë°ì´í„°(í•˜ìœ„ í‚¤ ì „ì²´)</b>ë¥¼ ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³ , <b>ì›ë³¸ì€ ì‚­ì œ</b>ë©ë‹ˆë‹¤.
      </div>
      <div class="warnbox">âš ï¸ ì§„í–‰ ì¤‘ ì°½ì„ ë‹«ê±°ë‚˜ ì¢…ë£Œí•˜ë©´ <b>ë°ì´í„° ì´ì „ ì¤‘ ë¬¸ì œ</b>ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ëŠ¥í•˜ë©´ ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
      <div id="migrate-progress">ëŒ€ê¸° ì¤‘â€¦</div>
      <div id="migrate-actions">
        <button id="migrate-start">ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
      </div>
    </div>
  </div>

  <!-- ğŸ—’ï¸ í€˜ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
  <div id="quest-overlay" aria-hidden="true">
    <div id="quest-card" role="dialog" aria-modal="true" aria-labelledby="quest-title">
      <div id="quest-head">
        <h3 id="quest-title">ğŸ—’ï¸ í€˜ìŠ¤íŠ¸</h3>
        <button id="quest-close" aria-label="í€˜ìŠ¤íŠ¸ ë‹«ê¸°">âœ•</button>
      </div>
      <div class="quest-tabbar">
        <button class="qtab active" data-qtab="daily">ì¼ì¼ í€˜ìŠ¤íŠ¸</button>
        <button class="qtab" data-qtab="weekly">ì£¼ê°„ í€˜ìŠ¤íŠ¸</button>
      </div>
      <div id="quest-panels">
        <div class="quest-panel active" data-panel="daily">
          <p class="quest-desc">ë§¤ì¼ 00:00(KST) ì´ˆê¸°í™” Â· ì„±ì¥ë„ì— ë”°ë¼ ëª©í‘œê°€ ìƒìŠ¹í•˜ë©° ëª¨ë“  ê³¼ì œë¥¼ ì™„ë£Œí•˜ë©´ <b>í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯</b> 1íšŒê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
          <div id="quest-daily-list" class="quest-list"></div>
          <div class="quest-summary" id="quest-daily-summary"></div>
        </div>
        <div class="quest-panel" data-panel="weekly">
          <p class="quest-desc">ë§¤ì£¼ ì¼ìš”ì¼ 12:00(KST) ì´ˆê¸°í™” Â· ì„±ì¥ë„ê°€ ë†’ì„ìˆ˜ë¡ ëª©í‘œê°€ ì»¤ì§€ë©° ëª¨ë“  ê³¼ì œë¥¼ ì™„ë£Œí•˜ë©´ <b>ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯</b> 1íšŒê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
          <div id="quest-weekly-list" class="quest-list"></div>
          <div class="quest-summary" id="quest-weekly-summary"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ“œ ì´ìš©ì•½ê´€ ì˜¤ë²„ë ˆì´ -->
  <div id="tos-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="tos-title">
      <h3 id="tos-title">ì´ìš©ì•½ê´€ ë™ì˜</h3>
      <div id="tos-body">
        <p>ë³¸ ê²Œì„ì€ ê³µì •í•œ í”Œë ˆì´ë¥¼ ìœ„í•´ ì¹˜íŒ…Â·í•µ ì‚¬ìš©ì„ ì—„ê²©íˆ ê¸ˆì§€í•©ë‹ˆë‹¤.</p>
        <ul>
          <li>í´ë¼ì´ì–¸íŠ¸Â·ì½˜ì†” ì¡°ì‘ ë“±ìœ¼ë¡œ ìì›/ì½”ì¸ì„ ë¹„ì •ìƒì ìœ¼ë¡œ ì¦ê°€ì‹œí‚¤ëŠ” í–‰ìœ„ ê¸ˆì§€</li>
          <li>ë²„ê·¸ ì•…ìš© ê¸ˆì§€, ê³„ì • ì–‘ë„/ëŒ€ì—¬ ê¸ˆì§€</li>
          <li><b>ë¹„ì •ìƒ ê¸‰ì¦</b> ì˜ˆì‹œ: í•œ ë²ˆì— <b>10ì–µ ì½”ì¸</b> ì´ìƒ ì¦ê°€ â†’ ì¦‰ì‹œ ì •ì§€ ê°€ëŠ¥</li>
        </ul>
        <p>ë™ì˜ í›„ í”Œë ˆì´ë¥¼ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;">
        <input type="checkbox" id="tos-agree" /> <span>ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤</span>
      </label>
      <div class="overlay-actions">
        <button id="tos-accept" class="spinbtn spin-free" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>
      </div>
    </div>
  </div>

  <!-- ğŸ§ª ë²„í”„ ëª©ë¡ ì˜¤ë²„ë ˆì´ -->
  <div id="buff-overlay" aria-hidden="true">
    <div id="buff-card" role="dialog" aria-modal="true" aria-labelledby="buff-title">
      <h3 id="buff-title">í˜„ì¬ ì ìš© ì¤‘ì¸ ë²„í”„</h3>
      <div id="buff-list">ì ìš© ì¤‘ì¸ ë²„í”„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="permanent-buffs"></div>
      <div class="overlay-actions">
        <button id="buff-close" class="spinbtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- â›” ì •ì§€ ì˜¤ë²„ë ˆì´ (ì˜¤íƒ ëŒ€ì‘ ë²„íŠ¼ í¬í•¨) -->
  <div id="ban-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-labelledby="ban-title">
      <h3 id="ban-title">â›” ê³„ì • ì •ì§€ë¨</h3>
      <div id="ban-desc">
        <p>ì´ìš©ì•½ê´€ ìœ„ë°˜ ì˜ì‹¬ì— ë”°ë¼ í”Œë ˆì´ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <p>ì˜ì‹¬ë„: <b id="ban-sus-value">0</b></p>
        <p style="color:#ffd36e">â€» ì •ì§€ ì¤‘ì—ëŠ” ìì›/ì½”ì¸ì´ ì¦ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <div style="margin-top:8px; font-size:13px; color:#cfe6ff;">
          ì˜¤íƒìœ¼ë¡œ íŒë‹¨ë˜ë©´ ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ <b>ì§€ì›íŒ€ì— ì¦‰ì‹œ ë©”ì¼</b>ì„ ë³´ë‚´ê±°ë‚˜, <b>ì •ë³´ ë³µì‚¬</b> í›„ ìˆ˜ë™ ë©”ì¼ ì „ì†¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="overlay-actions" style="flex-wrap:wrap;">
        <button id="ban-appeal-email" class="spinbtn">ğŸ“§ ì˜¤íƒ ë©”ì¼ ë³´ë‚´ê¸°</button>
        <button id="ban-copy-info" class="spinbtn">ğŸ“‹ ì •ë³´ ë³µì‚¬</button>
        <button id="ban-ok" class="spinbtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš´ë“œ -->
  <audio id="sfx-start"    src="/sounds/roulette_start.mp3" preload="auto"></audio>
  <audio id="sfx-tick"     src="/sounds/roulette_tick.mp3"  preload="auto"></audio>
  <audio id="sfx-win"      src="/sounds/roulette_win.mp3"   preload="auto"></audio>
  <audio id="sfx-coin"     src="/sounds/coin.mp3"          preload="auto"></audio>
  <audio id="sfx-pickaxe"  src="/sounds/pickaxe.mp3"       preload="auto"></audio>

  <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + ê²Œì„ ë¡œì§ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      sendEmailVerification,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, signInWithCustomToken,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, onValue, runTransaction, update, get
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
        authDomain: "siu-studio.firebaseapp.com",
        databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

      const AUTH_BASE_URL = 'https://applogin-chi.vercel.app';

      // ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸ íƒ­ ë…¸ì¶œ í† ê¸€
      const eventopen = true;

      function applyEventVisibility() {
        const christmasTab = document.querySelector('#bottom-nav .tab[data-tab="christmas"]');
        const christmasContent = document.getElementById('christmas-content');
        if (!eventopen) {
          christmasTab?.remove();
          christmasContent?.remove();
        }
      }

      applyEventVisibility();

      let currentCode = null;
      let pollTimer = null;

    class SessionLogger {
      constructor() {
        this.fileHandle = null;
        this.queue = [];
        this.ready = false;
        this.supportsFsAccess = !!(navigator?.storage?.getDirectory);
        this.fallbackKey = 'siu_session_log_fallback';
        this.init();
      }

      async init() {
        if (this.supportsFsAccess) {
          try {
            const root = await navigator.storage.getDirectory();
            const dir = await root.getDirectoryHandle('logs', { create: true });
            const name = `session-${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
            this.fileHandle = await dir.getFileHandle(name, { create: true });
          } catch (err) {
            console.warn('ì„¸ì…˜ ë¡œê·¸ íŒŒì¼ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err);
            this.fileHandle = null;
          }
        }
        this.ready = true;
        if (this.queue.length) {
          const pending = [...this.queue];
          this.queue.length = 0;
          for (const line of pending) {
            await this._write(line);
          }
        }
        this.log('ì„¸ì…˜ ë¡œê±°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      async _write(line) {
        if (this.fileHandle) {
          try {
            const file = await this.fileHandle.getFile();
            const writable = await this.fileHandle.createWritable({ keepExistingData: true });
            await writable.seek(file.size);
            await writable.write(line);
            await writable.close();
            return;
          } catch (err) {
            console.warn('íŒŒì¼ ë¡œê·¸ ê¸°ë¡ì— ì‹¤íŒ¨í•˜ì—¬ fallback ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', err);
            this.fileHandle = null;
          }
        }
        try {
          const prev = localStorage.getItem(this.fallbackKey) || '';
          const next = (prev + line).slice(-20000);
          localStorage.setItem(this.fallbackKey, next);
        } catch {}
      }

      async log(message) {
        const line = `[${new Date().toISOString()}] ${message}\n`;
        if (!this.ready) {
          this.queue.push(line);
          return;
        }
        await this._write(line);
      }
    }

    class RecoveryManager {
      constructor(logger, snapshotProvider) {
        this.logger = logger;
        this.snapshotProvider = snapshotProvider;
        this.key = 'siu_recovery_points_v1';
        this.interval = 180000; // 3ë¶„
        this.maxPoints = 20;
        this.timer = null;
      }

      start() {
        this.stop();
        this.safeCreate('initial-visit');
        this.timer = setInterval(() => this.safeCreate('interval'), this.interval);
      }

      stop() {
        if (this.timer) {
          clearInterval(this.timer);
          this.timer = null;
        }
      }

      resume() {
        if (this.timer) return;
        this.safeCreate('resume');
        this.timer = setInterval(() => this.safeCreate('interval'), this.interval);
      }

      safeCreate(reason) {
        try {
          this.createPoint(reason);
        } catch (err) {
          this.logger?.log?.(`ë³µêµ¬ ì§€ì  ìƒì„± ì‹¤íŒ¨(${reason}): ${err?.message || err}`);
        }
      }

      createPoint(reason = 'auto') {
        if (typeof localStorage === 'undefined') return;
        const payload = {
          ts: Date.now(),
          reason,
          localStorage: this.snapshotLocalStorage(),
          state: this.snapshotState()
        };
        let points = [];
        try {
          const raw = localStorage.getItem(this.key);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) points = parsed;
          }
        } catch {}
        points.unshift(payload);
        if (points.length > this.maxPoints) points = points.slice(0, this.maxPoints);
        try {
          localStorage.setItem(this.key, JSON.stringify(points));
          this.logger?.log?.(`ë³µêµ¬ ì§€ì ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. (${reason})`);
        } catch (err) {
          this.logger?.log?.(`ë³µêµ¬ ì§€ì  ì €ì¥ ì‹¤íŒ¨: ${err?.message || err}`);
        }
      }

      snapshotLocalStorage() {
        const snapshot = {};
        if (typeof localStorage === 'undefined') return snapshot;
        try {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key) snapshot[key] = localStorage.getItem(key);
          }
        } catch (err) {
          this.logger?.log?.(`localStorage ìŠ¤ëƒ…ìƒ· ì‹¤íŒ¨: ${err?.message || err}`);
        }
        return snapshot;
      }

      snapshotState() {
        if (typeof this.snapshotProvider !== 'function') return null;
        try {
          const src = this.snapshotProvider();
          if (!src || typeof src !== 'object') return null;
          return JSON.parse(JSON.stringify(src));
        } catch (err) {
          this.logger?.log?.(`ê²Œì„ ìƒíƒœ ìŠ¤ëƒ…ìƒ· ì‹¤íŒ¨: ${err?.message || err}`);
          return null;
        }
      }
    }

    const sessionLogger = new SessionLogger();
    window.__SESSION_LOGGER__ = sessionLogger;

    const describeReason = (reason) => {
      if (!reason) return 'no reason';
      if (typeof reason === 'string') return reason.slice(0, 400);
      if (reason instanceof Error) {
        return `${reason.name || 'Error'}: ${(reason.message || '').slice(0, 400)}`;
      }
      try {
        return JSON.stringify(reason).slice(0, 400);
      } catch {
        return String(reason).slice(0, 400);
      }
    };

    sessionLogger.log('ê²Œì„ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

    window.addEventListener('error', (event) => {
      sessionLogger.log(`window error: ${event?.message || 'unknown'} (${event?.filename || 'n/a'}:${event?.lineno || 0})`);
    });
    window.addEventListener('unhandledrejection', (event) => {
      sessionLogger.log(`unhandled rejection: ${describeReason(event?.reason)}`);
    });

    /* ======================
       ê³µí†µ ìƒíƒœ / ê²½ë¡œ
       ====================== */
    const SUPPORT_EMAIL = 'appeals@siustudio.me';
    const perkState = {
      tier: 0,
      resourceMult: 1,
      coinMult: 1,
      productionMult: 1
    };
    function resetPerkState(){
      perkState.tier = 0;
      perkState.resourceMult = 1;
      perkState.coinMult = 1;
      perkState.productionMult = 1;
    }

    let state = {};
    let uid = null;
    let dataRef = null;
    let dataUnsubscribe = null;
    let localLastWrite = 0;
    let lastSyncedServerStamp = 0;
    let isInitialSync = false;

    let userServerKey = null;
    let userIdKey     = null;
    let userBasePath  = null;

    let dailyUnlocked = false;
    let rankingUnlocked = false;
    let bootDone = false;

    const recoveryManager = new RecoveryManager(sessionLogger, () => state);
    window.__RECOVERY_MANAGER__ = recoveryManager;
    recoveryManager.start();

    const GUEST_PROFILE_KEY = 'siu_guest_profile_v1';
    let guestMode = false;
    let guestTransferPreference = 'none';
    let guestAutoStartSuppressed = false;
    let pendingGuestCleanup = false;
    let pendingGuestRemovalNotice = false;

    function readGuestProfile() {
      try {
        const raw = localStorage.getItem(GUEST_PROFILE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function hasGuestProfile() {
      try {
        const profile = readGuestProfile();
        return !!(profile && typeof profile === 'object' && profile.state);
      } catch { return false; }
    }
    function clearGuestProfile() {
      try { localStorage.removeItem(GUEST_PROFILE_KEY); } catch {}
      try { localStorage.removeItem('siu_buffs_guest'); } catch {}
    }

    const MAIL_ADMIN_EMAIL = 'siu46852579@gmail.com';
    let mailboxRef = null;
    let mailboxUnsubscribe = null;
    let perkUnsubscribe = null;
    let mailboxCache = [];
    let selectedMailId = null;

    function subscribePickaxePerk(serverKey, userIdKey){
      if (perkUnsubscribe) {
        try { perkUnsubscribe(); } catch {}
        perkUnsubscribe = null;
      }
      if (!serverKey || !userIdKey) {
        resetPerkState();
        return;
      }
      const perkRef = ref(db, `users/${serverKey}/${userIdKey}/perks/pickaxe`);
      perkUnsubscribe = onValue(perkRef, snap => {
        if (!snap.exists()) {
          resetPerkState();
          return;
        }
        const val = snap.val() || {};
        perkState.tier = Number(val.tier || 0) || 0;
        perkState.resourceMult = Number(val.resourceMult || 1) || 1;
        perkState.coinMult = Number(val.coinMult || 1) || 1;
        perkState.productionMult = Number(val.productionMult || 1) || 1;
        if (val.src) {
          console.debug?.('[perk] pickaxe perk updated from', val.src, perkState);
        }
      }, err => {
        console.warn('pickaxe perk listen error', err);
        resetPerkState();
      });
    }

    
    /* ğŸ”’ 3ì´ˆ ë¶€íŠ¸ ìŠ¤í‚µ ì „ìš© íƒ€ì„ìŠ¤íƒ¬í”„ (ìš”ì²­ì‚¬í•­) */
    const AUDIT_BOOT_TS = Date.now();
    const AUDIT_INITIAL_SKIP_MS = 3000;

    /* ğŸ”’ ì´í›„ì—ëŠ” ë” ì´ìƒ ê²€ì‚¬ ë©ˆì¶”ëŠ” freeze ì•ˆ ì”€ (ê¸°ì¡´ auditFreezeëŠ” ë”ë¯¸) */
    function auditFreeze(ms = 0) {
      // ìš”ì²­: "ì²˜ìŒ 3ì´ˆë§Œ ê²€ì‚¬ ì•ˆ í•˜ê²Œ" â†’ ë‚˜ë¨¸ì§€ ì‹œê°„ì—ëŠ” ë¬´ì¡°ê±´ ê²€ì‚¬
      // ê·¸ë˜ì„œ ì—¬ê¸°ì„œëŠ” ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
    }

    /* ë„¤íŠ¸ì›Œí¬ ì§€ì—° ê°ì§€ìš© (í† ìŠ¤íŠ¸ëŠ” ì•ˆ ë„ì›€) */
    let initialSyncStart = 0;
    let networkUnstableShown = false;

    /* ======================
       í† ìŠ¤íŠ¸ / UI ìœ í‹¸
       ====================== */
    let toastTimer = null;
    function showToast(message, actionText = null, onAction = null, ttlMs = 5000){
      if (message && message.indexOf('ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤') !== -1) return;
      if (!bootDone && message !== 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.') return;
      const box = document.getElementById('toast');
      if(!box) return;
      clearTimeout(toastTimer);
      box.innerHTML = `<div class="t-row">
        <span class="t-msg">${message}</span>
        ${actionText ? `<button class="t-btn" id="toast-action">${actionText}</button>` : ``}
      </div>`;
      box.classList.add('show');
      box.style.display='block';
      function hideToast(){ box.classList.remove('show'); box.style.display='none'; }
      if(actionText && onAction){
        const btn = document.getElementById('toast-action');
        if(btn){ btn.onclick = () => { try{ onAction(); }catch{} hideToast(); }; }
      }
      toastTimer = setTimeout(hideToast, ttlMs);
    }

    function copyTextToClipboard(text) {
      if (!text) return Promise.reject(new Error('empty'));
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise((resolve, reject) => {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          textarea.style.pointerEvents = 'none';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          const ok = document.execCommand('copy');
          textarea.remove();
          if (ok) resolve();
          else reject(new Error('copy-failed'));
        } catch (err) {
          reject(err);
        }
      });
    }

    window.addEventListener('shop-open-error', (event) => {
      const detail = event?.detail || {};
      const msg = detail.message || 'ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      const manualMessage = detail.copyUrl ? (detail.manualMessage || 'í¬ë¡¬ì—ì„œ ë‹¤ìŒ ì‚¬ì´íŠ¸ë¡œ ì´ë™í•˜ì„¸ìš”') : null;
      const toastMessage = manualMessage ? `${msg}\n${manualMessage}` : msg;

      const copyAction = detail.copyUrl ? () => {
        copyTextToClipboard(detail.copyUrl)
          .then(() => {
            showToast('ìƒì  ì£¼ì†Œë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. í¬ë¡¬ì—ì„œ ë¶™ì—¬ë„£ì–´ ì´ë™í•´ì£¼ì„¸ìš”!', null, null, 3600);
          })
          .catch(() => {
            try {
              prompt('ì•„ë˜ ì£¼ì†Œë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•œ ë’¤ í¬ë¡¬ ì£¼ì†Œì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.', detail.copyUrl);
            } catch {}
          });
      } : null;

      showToast(toastMessage, detail.copyUrl ? 'ì£¼ì†Œ ë³µì‚¬' : null, copyAction, detail.copyUrl ? 8000 : 3600);

      if (manualMessage && detail.alert !== false) {
        try {
          alert(`${manualMessage}\n${detail.copyUrl}`);
        } catch {}
      }
    });

    function maybeNotifyGuestRemoval() {
      if (!pendingGuestRemovalNotice || !bootDone) return;
      showToast('ğŸ‘‹ ê²ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆì–´ìš”. ë¡œê·¸ì¸í•œ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ í”Œë ˆì´ë¥¼ ì´ì–´ê°€ì„¸ìš”!', null, null, 4200);
      pendingGuestRemovalNotice = false;
    }

    /* ======================
       ë²„í”„ ì €ì¥/ì ìš©/í‘œì‹œ
       ====================== */
    function buffStorageKey(){ return guestMode ? 'siu_buffs_guest' : `siu_buffs_${uid||'anon'}`; }
    function ensureFx(){ if(!window.fx) window.fx={}; if(!window.fx.buffs) window.fx.buffs=[]; }
    function persistBuffs(){
      ensureFx();
      try {
        const now = Date.now();
        const toSave = window.fx.buffs.filter(b=>b && b.until>now);
        localStorage.setItem(buffStorageKey(), JSON.stringify(toSave));
      } catch {}
    }
    function loadBuffs(){
      ensureFx();
      try {
        const raw = localStorage.getItem(buffStorageKey());
        const arr = raw ? JSON.parse(raw) : [];
        const now = Date.now();
        window.fx.buffs = Array.isArray(arr) ? arr.filter(b=>b && b.until>now) : [];
      } catch { window.fx.buffs = []; }
    }
    function pruneExpiredBuffs(){
      ensureFx();
      const before = window.fx.buffs.length;
      const now = Date.now();
      window.fx.buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      if (window.fx.buffs.length !== before) persistBuffs();
    }
    function activeBuffFactor(kind){
      ensureFx();
      const now = Date.now();
      let factor = 1;
      (window.fx.buffs||[]).forEach(b=>{
        if(!b || now>=b.until) return;
        if (b.type==='all') factor *= (1 + b.value);
        else if (kind==='res'  && b.type==='res')  factor *= (1 + b.value);
        else if (kind==='coin' && b.type==='coin') factor *= (1 + b.value);
      });
      return factor;
    }
    function addTempBuff(type, value, dur){
      ensureFx();
      const now=Date.now();
      window.fx.buffs.push({ type, value, until: now + dur });
      persistBuffs();
      renderBuffStatus();
    }

    // ğŸ‘‰ ì—¬ê¸°ì„œë¶€í„°: ë²„íŠ¼/ì˜¤ë²„ë ˆì´ìš© ë²„í”„ ë Œë”
    function unlockedTreeBuffs(){
      const lv = Math.max(0, Math.min(christmasTreeRewards.length, state.christmasTreeLevel || 0));
      return christmasTreeRewards.slice(0, lv).map((r, idx) => `Lv.${idx + 1}: ${r.reward}`);
    }

    function renderPermanentBuffs(){
      const perm = document.getElementById('permanent-buffs');
      if (!perm) return;
      const buffs = unlockedTreeBuffs();
      const ecoMult = aggregateTreeMultiplier('event');
      const resMult = aggregateTreeMultiplier('res');
      const coinMult = aggregateTreeMultiplier('coin');
      const clickMult = aggregateTreeMultiplier('click');
      const workerMult = aggregateTreeMultiplier('worker');
      const multTexts = [];
      if (ecoMult > 1) multTexts.push(`ì´ë²¤íŠ¸ì½”ì¸ íšë“ x${ecoMult.toFixed(2).replace(/\.00$/, '')}`);
      if (resMult > 1) multTexts.push(`ìì› ìƒì‚° x${resMult.toFixed(2).replace(/\.00$/, '')}`);
      if (coinMult > 1) multTexts.push(`ì½”ì¸ ìƒì‚° x${coinMult.toFixed(2).replace(/\.00$/, '')}`);
      if (clickMult > 1) multTexts.push(`í´ë¦­ ì±„êµ´ x${clickMult.toFixed(2).replace(/\.00$/, '')}`);
      if (workerMult > 1) multTexts.push(`ì•Œë°” íš¨ìœ¨ x${workerMult.toFixed(2).replace(/\.00$/, '')}`);
      const list = buffs.map(b => `<li>${escapeHTML(b)}</li>`).join('');
      const multInfo = multTexts.length ? `<div style="margin-top:6px;">ì ìš© ë°°ìœ¨: ${multTexts.map(escapeHTML).join(' Â· ')}</div>` : '';
      perm.innerHTML = buffs.length
        ? `<div style="font-weight:700; margin-bottom:4px;">ğŸ ì˜êµ¬ ë²„í”„</div><ul style="margin:0 0 6px 18px; padding:0;">${list}</ul>${multInfo}`
        : '<div style="font-weight:700; margin-bottom:4px;">ğŸ ì˜êµ¬ ë²„í”„</div><div>í™œì„±í™”ëœ ì˜êµ¬ ë²„í”„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function renderBuffStatus(){
      const btn = document.getElementById('buff-btn');
      const listEl = document.getElementById('buff-list');
      pruneExpiredBuffs();
      const now = Date.now();
      const buffs = (window.fx.buffs||[]).filter(b=>b && b.until>now);
      const count = buffs.length;
      if (btn) {
        btn.textContent = count > 0 ? `ë²„í”„(${count})` : 'ë²„í”„(0)';
      }
      if (listEl) {
        if (count === 0) {
          listEl.innerHTML = 'ì ìš© ì¤‘ì¸ ë²„í”„ê°€ ì—†ìŠµë‹ˆë‹¤.';
        } else {
          const names = { all:'ì „ì²´', coin:'ì½”ì¸', res:'ìì›' };
          listEl.innerHTML = buffs.map(b=>{
            const leftMs = b.until - now;
            const m = Math.max(0, Math.floor(leftMs/60000));
            const s = Math.max(0, Math.floor((leftMs%60000)/1000));
            const mult = 1 + b.value;
            const multText = (Math.abs(mult - Math.round(mult)) < 1e-9) ? `x${Math.round(mult)}` : `x${(Math.round(mult*10)/10)}`;
            return `<div class="buff-item"><span>${names[b.type]||'ë²„í”„'} ${multText}</span><span>${m}:${String(s).padStart(2,'0')}</span></div>`;
          }).join('');
        }
      }
      renderPermanentBuffs();
    }

    /* ========= ìˆ«ì í•œêµ­ì‹ ë‹¨ìœ„ ========= */
    function formatKR(num, decimalsForUnits = 2) {
      if (num === null || num === undefined) return '0';
      if (!isFinite(num)) return String(num);
      const neg = num < 0;
      let n = Math.abs(num);
      const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°', 'ê²½', 'í•´', 'ì', 'ì–‘', 'êµ¬', 'ê°„', 'ì •', 'ì¬', 'ê·¹'];
      let u = 0;
      while (n >= 10000 && u < units.length - 1) { n /= 10000; u++; }
      if (u === 0) {
        const rounded = Math.round(n);
        return (neg ? '-' : '') + rounded.toLocaleString('ko-KR');
      }
      const s = n.toFixed(decimalsForUnits).replace(/\.0+$|(\.\d*[1-9])0+$/, '$1');
      return (neg ? '-' : '') + s + units[u];
    }

    function escapeHTML(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatMailDate(ts) {
      if (!ts) return '';
      try {
        return new Date(ts).toLocaleString('ko-KR');
      } catch { return ''; }
    }

    function updateMailBadges() {
      const unread = mailboxCache.filter(m => !m.readAt).length;
      const badge = document.getElementById('mail-unread-badge');
      if (badge) {
        if (unread > 0) {
          badge.textContent = unread > 99 ? '99+' : String(unread);
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
      const side = document.getElementById('mail-unread-side');
      if (side) {
        if (unread > 0) {
          side.textContent = unread > 99 ? '99+' : String(unread);
          side.style.opacity = '1';
        } else {
          side.textContent = '-';
          side.style.opacity = '0.65';
        }
      }
    }

    function generateMailId() {
      return `mail_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    }

    function buildMailRewardsHtml(mail) {
      const rewards = mail?.rewards;
      const rows = [];
      const resAmt = Number(rewards?.resources ?? rewards?.res ?? 0);
      if (resAmt > 0) rows.push(`<span>ğŸª¨ ìì› +${formatKR(resAmt)}</span>`);
      const coinAmt = Number(rewards?.coins ?? rewards?.coin ?? 0);
      if (coinAmt > 0) rows.push(`<span>ğŸ’° ì½”ì¸ +${formatKR(coinAmt)}</span>`);
      const ecoAmt = Number(rewards?.eventCoins ?? rewards?.eco ?? rewards?.ecoins ?? 0);
      if (ecoAmt > 0) rows.push(`<span>ğŸŸï¸ ì´ë²¤íŠ¸ì½”ì¸ +${formatKR(ecoAmt)}</span>`);
      const buffList = Array.isArray(rewards?.buffs)
        ? rewards.buffs
        : rewards?.buff ? [rewards.buff] : [];
      buffList.forEach(b => {
        if (!b) return;
        const type = b.type || b.kind;
        const mult = Number(b.value ?? b.mult ?? b.bmult ?? 0);
        const durMs = Number(b.duration ?? b.durationMs ?? b.dur ?? 0);
        if (!type || mult <= 0 || durMs <= 0) return;
        const minutes = Math.max(1, Math.round(durMs / 60000));
        rows.push(`<span>ğŸš€ ë²„í”„(${type}) Ã—${(1 + mult).toFixed(2)} / ${minutes}ë¶„</span>`);
      });
      if (!rows.length) return '<span>ë³´ìƒ ì—†ìŒ</span>';
      return rows.join('');
    }

    function renderMailList() {
      const listEl = document.getElementById('mail-list');
      if (!listEl) return;
      if (!mailboxCache.length) {
        listEl.innerHTML = '<div class="mail-empty">ë°›ì€ ìš°í¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      const html = mailboxCache.map(mail => {
        const unread = !mail.readAt;
        const selected = selectedMailId === mail.id;
        const preview = escapeHTML((mail.body || '').replace(/\s+/g, ' ').trim().slice(0, 40));
        const sent = formatMailDate(mail.sentAt);
        return `
          <button type="button" class="mail-item${unread ? ' unread' : ''}${selected ? ' selected' : ''}" data-mail-id="${mail.id}">
            <div class="mail-subject">${escapeHTML(mail.subject || 'ì œëª© ì—†ìŒ')}</div>
            <div class="mail-preview">${preview || 'ë‚´ìš© ì—†ìŒ'}</div>
            <div class="mail-meta"><span>${escapeHTML(mail.from || 'ì‹œìŠ¤í…œ')}</span><span>${sent}</span></div>
          </button>`;
      }).join('');
      listEl.innerHTML = html;
      Array.from(listEl.querySelectorAll('.mail-item')).forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-mail-id');
          selectMail(id);
        });
      });
    }

    function renderMailDetail(mail) {
      const detail = document.getElementById('mail-detail');
      if (!detail) return;
      if (!mail) {
        detail.innerHTML = '<div class="mail-empty">ìš°í¸ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
        return;
      }
      const sent = formatMailDate(mail.sentAt);
      const read = mail.readAt ? formatMailDate(mail.readAt) : null;
      const claimed = mail.claimedAt ? formatMailDate(mail.claimedAt) : null;
      const bodyHtml = escapeHTML(mail.body || '').replace(/\n/g, '<br/>');
      const rewardsHtml = buildMailRewardsHtml(mail);
      const hasRewards = !!mail.rewards && rewardsHtml !== '<span>ë³´ìƒ ì—†ìŒ</span>';
      const statusParts = [`ë°œì†¡: ${sent || '-'}`];
      if (read) statusParts.push(`ì½ìŒ: ${read}`);
      if (claimed) statusParts.push(`ë³´ìƒ ìˆ˜ë ¹: ${claimed}`);
      const claimDisabled = !hasRewards || !!mail.claimedAt;
      const claimLabel = mail.claimedAt ? 'ìˆ˜ë ¹ ì™„ë£Œ' : 'ë³´ìƒ ë°›ê¸°';
      detail.innerHTML = `
        <div>
          <h4>${escapeHTML(mail.subject || 'ì œëª© ì—†ìŒ')}</h4>
          <div class="mail-meta-line">ë³´ë‚¸ ì‚¬ëŒ: ${escapeHTML(mail.from || 'ì‹œìŠ¤í…œ')} â€¢ ${statusParts.join(' â€¢ ')}</div>
        </div>
        <div class="mail-body">${bodyHtml || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        <div id="mail-rewards">${rewardsHtml}</div>
        <div id="mail-actions">
          <button type="button" class="secondary" id="mail-delete-btn">ì‚­ì œ</button>
          <button type="button" id="mail-claim-btn" ${claimDisabled ? 'disabled' : ''}>${claimLabel}</button>
        </div>`;
      detail.querySelector('#mail-delete-btn')?.addEventListener('click', () => deleteMail(mail.id));
      if (!claimDisabled) {
        detail.querySelector('#mail-claim-btn')?.addEventListener('click', () => claimMailReward(mail.id));
      }
    }

    function selectMail(mailId) {
      if (!mailId) {
        selectedMailId = null;
        renderMailList();
        renderMailDetail(null);
        updateMailBadges();
        return;
      }
      let mail = mailboxCache.find(m => m.id === mailId);
      if (!mail) {
        selectedMailId = null;
        renderMailList();
        renderMailDetail(null);
        updateMailBadges();
        return;
      }
      selectedMailId = mailId;
      if (!mail.readAt) {
        const now = Date.now();
        mailboxCache = mailboxCache.map(m => m.id === mailId ? { ...m, readAt: m.readAt || now } : m);
        mail = mailboxCache.find(m => m.id === mailId) || mail;
        markMailAsRead(mailId);
      }
      renderMailList();
      renderMailDetail(mail);
      updateMailBadges();
    }

    async function markMailAsRead(mailId) {
      if (!uid || !userBasePath) return;
      try {
        await update(ref(db), { [`${userBasePath}/mailbox/${mailId}/readAt`]: Date.now() });
      } catch (err) {
        console.warn('markMailAsRead ì‹¤íŒ¨', err);
      }
    }

    function applyMailRewards(mail) {
      if (!mail?.rewards) return [];
      const rewards = mail.rewards || {};
      const applied = [];
      const resAmt = Math.max(0, Math.floor(Number(rewards.resources ?? rewards.res ?? 0)));
      if (resAmt > 0) {
        const finalResAmt = resAmt * (perkState.resourceMult || 1);
        registerAuditIntent('res', finalResAmt, 8000);
        state.resources += finalResAmt;
        auditAdd('res', finalResAmt);
        applied.push(`ìì› ${formatKR(finalResAmt)}`);
      }
      const coinAmt = Math.max(0, Math.floor(Number(rewards.coins ?? rewards.coin ?? 0)));
      if (coinAmt > 0) {
        const finalCoinAmt = coinAmt * (perkState.coinMult || 1);
        registerAuditIntent('coin', finalCoinAmt, 8000);
        state.coins += finalCoinAmt;
        auditGain('coin', finalCoinAmt);
        applied.push(`ì½”ì¸ ${formatKR(finalCoinAmt)}`);
      }
      const ecoAmt = Math.max(0, Math.floor(Number(rewards.eventCoins ?? rewards.eco ?? rewards.ecoins ?? 0)));
      if (ecoAmt > 0) {
        registerAuditIntent('eco', ecoAmt, 8000);
        const ecoFinal = addEventCoins(ecoAmt, 'mail');
        applied.push(`ì´ë²¤íŠ¸ì½”ì¸ ${formatKR(ecoFinal)}`);
      }
      const buffList = Array.isArray(rewards.buffs)
        ? rewards.buffs
        : rewards.buff ? [rewards.buff] : [];
      buffList.forEach(b => {
        if (!b) return;
        const type = b.type || b.kind;
        const mult = Number(b.value ?? b.mult ?? b.bmult ?? 0);
        const durMs = Number(b.duration ?? b.durationMs ?? b.dur ?? 0);
        if (!type || mult <= 0 || durMs <= 0) return;
        addTempBuff(type, mult, durMs);
        const minutes = Math.max(1, Math.round(durMs / 60000));
        applied.push(`ë²„í”„(${type}) x${(1 + mult).toFixed(2)} / ${minutes}ë¶„`);
      });
      if (applied.length > 0) {
        save();
        updateUI();
        renderPlanets();
      }
      return applied;
    }

    async function claimMailReward(mailId) {
      if (!uid || !userBasePath) {
        if (!requireLoginForFeature()) return;
        showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.', null, null, 2800);
        return;
      }
      const mailPath = ref(db, `${userBasePath}/mailbox/${mailId}`);
      let alreadyClaimed = false;
      try {
        const res = await runTransaction(mailPath, current => {
          if (!current) return current;
          if (current.claimedAt) { alreadyClaimed = true; return current; }
          const next = { ...current };
          const now = Date.now();
          next.claimedAt = now;
          if (!next.readAt) next.readAt = now;
          return next;
        });
        if (!res.snapshot.exists()) {
          showToast('ìš°í¸ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', null, null, 2600);
          return;
        }
        if (alreadyClaimed) {
          showToast('ì´ë¯¸ ìˆ˜ë ¹í•œ ìš°í¸ì…ë‹ˆë‹¤.', null, null, 2600);
          return;
        }
        const finalMail = { id: mailId, ...(res.snapshot.val() || {}) };
        const rewards = applyMailRewards(finalMail);
        mailboxCache = mailboxCache.map(m => m.id === mailId ? { ...m, readAt: finalMail.readAt, claimedAt: finalMail.claimedAt } : m);
        renderMailList();
        renderMailDetail(mailboxCache.find(m => m.id === mailId) || finalMail);
        updateMailBadges();
        if (rewards && rewards.length) {
          showToast(`ğŸ ë³´ìƒì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤! (${rewards.join(', ')})`, null, null, 4200);
        } else {
          showToast('ë³´ìƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.', null, null, 3200);
        }
      } catch (err) {
        console.error('claimMailReward ì˜¤ë¥˜', err);
        showToast('ë³´ìƒ ìˆ˜ë ¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', null, null, 3200);
      }
    }

    async function deleteMail(mailId) {
      if (!uid || !userBasePath) {
        if (!requireLoginForFeature()) return;
        showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.', null, null, 2800);
        return;
      }
      const ok = confirm('í•´ë‹¹ ìš°í¸ì„ ì‚­ì œí• ê¹Œìš”? ë³´ìƒì„ ë°›ì•˜ë‹¤ë©´ ì‚­ì œí•´ë„ ì•ˆì „í•©ë‹ˆë‹¤.');
      if (!ok) return;
      try {
        await update(ref(db), { [`${userBasePath}/mailbox/${mailId}`]: null });
        mailboxCache = mailboxCache.filter(m => m.id !== mailId);
        if (selectedMailId === mailId) {
          selectedMailId = null;
          renderMailDetail(null);
        }
        renderMailList();
        updateMailBadges();
        showToast('ìš°í¸ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.', null, null, 2600);
      } catch (err) {
        console.error('deleteMail ì˜¤ë¥˜', err);
        showToast('ìš°í¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', null, null, 3000);
      }
    }

    function openMailOverlay() {
      if (!uid) {
        if (!requireLoginForFeature()) return;
      }
      const overlay = document.getElementById('mail-overlay');
      if (!overlay) return;
      hideAllOverlays();
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');
      if (!selectedMailId && mailboxCache.length) {
        selectMail(mailboxCache[0].id);
      } else {
        renderMailList();
        const current = selectedMailId ? mailboxCache.find(m => m.id === selectedMailId) : null;
        renderMailDetail(current);
      }
      updateMailBadges();
      const targetInput = document.getElementById('mail-compose-target');
      if (targetInput) {
        targetInput.value = 'ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)';
      }
    }

    function closeMailOverlay() {
      const overlay = document.getElementById('mail-overlay');
      if (!overlay) return;
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function updateMailComposeVisibility(user) {
      const section = document.getElementById('mail-compose-section');
      if (!section) return;
      const isAdmin = !!user && String(user.email || '').toLowerCase() === MAIL_ADMIN_EMAIL;
      section.classList.toggle('show', isAdmin);
      if (isAdmin) {
        const targetInput = document.getElementById('mail-compose-target');
        if (targetInput) targetInput.value = 'ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)';
      }
    }

    async function fetchAllUserBasePaths() {
      const targets = new Set();
      const baseKeys = ['gameData', 'mailbox', 'security', 'daily'];

      try {
        const mapSnap = await get(ref(db, 'userServerMap'));
        if (mapSnap.exists()) {
          const mapVal = mapSnap.val() || {};
          Object.values(mapVal).forEach(entry => {
            const server = entry?.server;
            const id = entry?.id;
            if (typeof server === 'string' && server && typeof id === 'string' && id) {
              targets.add(`users/${server}/${id}`);
            }
          });
        }
      } catch (err) {
        console.warn('fetchAllUserBasePaths map ì˜¤ë¥˜', err);
      }

      try {
        const usersSnap = await get(ref(db, 'users'));
        if (usersSnap.exists()) {
          const collectNode = (node, parts = []) => {
            if (!node || typeof node !== 'object') return;
            const hasCoreData = baseKeys.some(k => Object.prototype.hasOwnProperty.call(node, k));
            const hasMetaOnly = parts.length >= 2 && Object.prototype.hasOwnProperty.call(node, 'meta');
            const isUserNode = hasCoreData || hasMetaOnly;
            if (isUserNode && parts.length > 0) {
              targets.add(`users/${parts.join('/')}`);
              return;
            }
            if (parts.length >= 2) return;
            for (const [childKey, childVal] of Object.entries(node)) {
              if (!childKey || !childVal || typeof childVal !== 'object') continue;
              collectNode(childVal, [...parts, childKey]);
            }
          };
          collectNode(usersSnap.val() || {}, []);
        }
      } catch (err) {
        console.warn('fetchAllUserBasePaths users ì˜¤ë¥˜', err);
      }

      return Array.from(targets);
    }

    async function sendAdminMail() {
      if (!auth?.currentUser || String(auth.currentUser.email || '').toLowerCase() !== MAIL_ADMIN_EMAIL) {
        showToast('ìš°í¸ ë°œì†¡ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', null, null, 3200);
        return;
      }
      const targetInput = document.getElementById('mail-compose-target');
      const subjectInput = document.getElementById('mail-compose-subject');
      const bodyInput = document.getElementById('mail-compose-body');
      const resInput = document.getElementById('mail-compose-res');
      const coinInput = document.getElementById('mail-compose-coin');
      const ecoInput = document.getElementById('mail-compose-ecoin');
      const buffTypeSel = document.getElementById('mail-compose-buff-type');
      const buffMultInput = document.getElementById('mail-compose-buff-mult');
      const buffMinInput = document.getElementById('mail-compose-buff-min');

      if (!subjectInput || !bodyInput) return;

      const subject = subjectInput.value.trim() || 'ì œëª© ì—†ìŒ';
      const body = bodyInput.value.trim();
      const resAmt = Math.max(0, Math.floor(Number(resInput?.value ?? 0)));
      const coinAmt = Math.max(0, Math.floor(Number(coinInput?.value ?? 0)));
      const ecoAmt = Math.max(0, Math.floor(Number(ecoInput?.value ?? 0)));
      const buffType = buffTypeSel?.value || '';
      const buffMultRaw = Number(buffMultInput?.value ?? 0);
      const buffMinutes = Math.max(0, Math.floor(Number(buffMinInput?.value ?? 0)));

      const rewards = {};
      let rewardCount = 0;
      if (resAmt > 0) { rewards.resources = resAmt; rewardCount++; }
      if (coinAmt > 0) { rewards.coins = coinAmt; rewardCount++; }
      if (ecoAmt > 0) { rewards.eventCoins = ecoAmt; rewardCount++; }
      if (buffType && buffMultRaw > 1 && buffMinutes > 0) {
        rewards.buffs = [{ type: buffType, value: buffMultRaw - 1, duration: buffMinutes * 60000 }];
        rewardCount++;
      }

      const payload = {
        subject,
        body,
        from: MAIL_ADMIN_EMAIL,
        sentAt: Date.now()
      };
      if (rewardCount > 0) payload.rewards = rewards;

      const recipients = await fetchAllUserBasePaths();
      if (!recipients.length) {
        showToast('ë°œì†¡ ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', null, null, 3600);
        if (targetInput) targetInput.value = 'ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)';
        return;
      }

      const updates = {};
      recipients.forEach(path => {
        if (!path) return;
        updates[`${path}/mailbox/${generateMailId()}`] = { ...payload };
      });

      if (!Object.keys(updates).length) {
        showToast('ë°œì†¡ ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', null, null, 3600);
        if (targetInput) targetInput.value = 'ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)';
        return;
      }

      const sendBtn = document.getElementById('mail-compose-send');
      if (sendBtn) sendBtn.disabled = true;

      try {
        await update(ref(db), updates);
        const count = recipients.length;
        showToast(`ìš°í¸ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤. (ì´ ${count}ëª…)`, null, null, 3200);
        if (targetInput) targetInput.value = 'ëª¨ë“  ìœ ì € (ìë™ ë°œì†¡)';
      } catch (err) {
        console.error('sendAdminMail ì˜¤ë¥˜', err);
        showToast('ìš°í¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', null, null, 3600);
      } finally {
        if (sendBtn) sendBtn.disabled = false;
      }
    }

    document.getElementById('mail-close')?.addEventListener('click', closeMailOverlay);
    document.getElementById('mail-compose-send')?.addEventListener('click', sendAdminMail);
    document.getElementById('mail-overlay')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeMailOverlay();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMailOverlay();
    });
    renderMailList();
    renderMailDetail(null);
    updateMailBadges();
    window.openMailOverlay = openMailOverlay;
    window.closeMailOverlay = closeMailOverlay;

    /* ========= ê¸°ë³¸ ë°ì´í„° & ìœ í‹¸ ========= */
    const defaultData = {
      resources:0, coins:0, eventCoins:0,
      clickPower:1, shipLevel:1, shipUpgradeCost:20, clickUpgradeCost:15,
      workerCount:0, conversionCount:0, autoConvertBought:false, autoConvertEnabled:false, ownedPlanets:[],
      santaPieces:0, santaCoins:0, christmasTreeLevel:0,
      quests: { daily:{}, weekly:{} },
      _lastUpdated: 0
    };

    const shipEnhanceBaseMsg = 'ì²« ê°•í™”ëŠ” 100% ì„±ê³µ! ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ í™•ë¥ ì´ ë‚®ì•„ì§‘ë‹ˆë‹¤.';
    let shipEnhanceMessage = shipEnhanceBaseMsg;
    let shipEnhanceTone = 'info';
    let shipEnhanceInProgress = false;

    function getShipSuccessRate(level = state.shipLevel) {
      const lv = Math.max(1, level || 1);
      const rate = Math.max(25, 100 - (lv - 1) * 8);
      return Math.round(rate);
    }

    function setShipEnhanceStatus(message, tone = 'info') {
      shipEnhanceMessage = message;
      shipEnhanceTone = tone;
      const statusEl = document.getElementById('ship-upgrade-status');
      if (statusEl) {
        statusEl.innerText = message;
        statusEl.dataset.tone = tone;
      }
    }

    const christmasTreeRewards = [
      { cost: 5, reward: '2025 í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸ì½”ì¸ íšë“ x2 ì˜êµ¬ ì ìš©', effects: { event: 2 } },
      { cost: 10, reward: 'ìì› ìƒì‚° x2 ì˜êµ¬', effects: { res: 2 } },
      { cost: 25, reward: 'ì½”ì¸ ìƒì‚° x2 ì˜êµ¬', effects: { coin: 2 } },
      { cost: 60, reward: 'í´ë¦­ ì±„êµ´ x2 ì˜êµ¬', effects: { click: 2 } },
      { cost: 120, reward: 'ì•Œë°” íš¨ìœ¨ x1.5 ì˜êµ¬', effects: { worker: 1.5 } },
      { cost: 200, reward: '2025 í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì´ë²¤íŠ¸ì½”ì¸ ì¶”ê°€ ë°°ìœ¨ & ì „ ìƒì‚° x2 ì˜êµ¬', effects: { res: 2, coin: 2, event: 2 } }
    ];
    function withAutoConvertDefaults(rawState) {
      const merged = { ...defaultData, ...(rawState || {}) };
      if (typeof merged.autoConvertEnabled !== 'boolean') {
        merged.autoConvertEnabled = !!merged.autoConvertBought;
      }
      return merged;
    }
    function writeGuestProfile(profile) {
      try { localStorage.setItem(GUEST_PROFILE_KEY, JSON.stringify(profile)); }
      catch (err) { console.warn('guest profile save error', err); }
    }
    function persistGuestProfile() {
      if (!guestMode) return;
      try {
        const now = Date.now();
        const snapshot = JSON.parse(JSON.stringify({ ...state }));
        if (!snapshot || typeof snapshot !== 'object') return;
        if (!snapshot._lastUpdated) snapshot._lastUpdated = now;
        writeGuestProfile({
          state: snapshot,
          rankingUnlocked: !!rankingUnlocked,
          lastSavedAt: now
        });
      } catch (err) {
        console.warn('guest persist failed', err);
      }
    }
    function applyGuestProfile(profile) {
      const rawState = (profile && typeof profile === 'object' && profile.state && typeof profile.state === 'object')
        ? profile.state
        : null;
      state = withAutoConvertDefaults(rawState);
      rankingUnlocked = !!(profile && profile.rankingUnlocked);
    }
    function loadGuestProfileIntoState() {
      const profile = readGuestProfile();
      applyGuestProfile(profile || {});
    }
    const initialWorkerCost=10, workerCostGrowth=1.2;
    const initialWorkerPower=1, workerPowerGrowth=1.05;
    const initialConversionCost=50, conversionCostGrowth=1.3;
    const initialClickUpgradeCost=15, clickUpgradeIncrement=3;

    function getWorkerCost()   { return Math.floor(initialWorkerCost   * Math.pow(workerCostGrowth, state.workerCount)); }
    function getWorkerPower()  { return initialWorkerPower * Math.pow(workerPowerGrowth, state.workerCount); }
    function getConversionCost(){ return Math.floor(initialConversionCost * Math.pow(conversionCostGrowth, state.conversionCount)); }
    function ensureClickUpgradeCost(){
      const sanitized = Math.max(1, Math.round(state.clickUpgradeCost ?? initialClickUpgradeCost));
      if (state.clickUpgradeCost !== sanitized) state.clickUpgradeCost = sanitized;
      return sanitized;
    }
    function getNextClickUpgradeCost(currentCost){
      const base = currentCost ?? initialClickUpgradeCost;
      return Math.max(1, Math.round(base + clickUpgradeIncrement));
    }
    function applyClickUpgrades(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      let cost = ensureClickUpgradeCost();
      for (let i = 0; i < count; i++) {
        state.clickPower = (state.clickPower||1) + 1;
        cost = getNextClickUpgradeCost(cost);
      }
      state.clickUpgradeCost = cost;
    }
    function hireWorkersBulk(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      state.workerCount += count;
      applyQuestProgress('worker', count);
    }
    function hireConversionsBulk(levels = 1){
      const count = Math.max(0, Math.floor(levels));
      if (!count) return;
      state.conversionCount += count;
    }

    function isOffline(){
      try { return navigator.onLine === false; }
      catch { return false; }
    }

    function isBackgrounded(){
      try { return document.visibilityState === 'hidden'; }
      catch { return false; }
    }

    // ğŸ”„ ë³€í™˜(ì¦ê°€/ì§€ì¶œ ì¥ë¶€ ë°˜ì˜)
    function convertResources(maxCount = null, source = 'manual') {
      if (isOffline()) return false;
      const possible = Math.floor(state.resources / 10);
      const count = maxCount === null ? possible : Math.min(possible, maxCount);
      if (count <= 0) return false;

      const resOut = count * 10;
      state.resources -= resOut;
      auditSpend('res', resOut);

      const coinMul = activeBuffFactor('coin') * aggregateTreeMultiplier('coin');
      const perkCoinMul = perkState.coinMult || 1;
      const inc = count * coinMul * perkCoinMul;
      state.coins += inc;
      auditGain('coin', inc, source === 'manual' ? 'manual' : 'auto');
      applyQuestProgress('convert', count);
      playSfx('sfx-coin');
      return true;
    }

    function aggregateTreeMultiplier(kind) {
      const lv = Math.max(0, Math.min(christmasTreeRewards.length, state.christmasTreeLevel || 0));
      let mult = 1;
      for (let i = 0; i < lv; i++) {
        const eff = christmasTreeRewards[i]?.effects || {};
        if (eff.all) mult *= eff.all;
        if (kind === 'res' && eff.res) mult *= eff.res;
        if (kind === 'coin' && eff.coin) mult *= eff.coin;
        if (kind === 'click' && eff.click) mult *= eff.click;
        if (kind === 'worker' && eff.worker) mult *= eff.worker;
        if (kind === 'event' && eff.event) mult *= eff.event;
      }
      return mult;
    }

    function addEventCoins(amount, source = 'reward') {
      const base = Math.max(0, Math.floor(amount || 0));
      if (!base) return 0;
      const mult = aggregateTreeMultiplier('event');
      const finalAmt = Math.max(0, Math.floor(base * mult));
      state.eventCoins = (state.eventCoins || 0) + finalAmt;
      auditGain('eco', finalAmt, source);
      return finalAmt;
    }

    function autoCraftSantaCoins() {
      const pieces = Math.max(0, Math.floor(state.santaPieces || 0));
      const craftable = Math.floor(pieces / 10);
      if (craftable <= 0) return 0;
      state.santaPieces -= craftable * 10;
      state.santaCoins = (state.santaCoins || 0) + craftable;
      return craftable;
    }

    function attachHoldRepeat(target, action, options = {}) {
      const btn = typeof target === 'string' ? document.getElementById(target) : target;
      if (!btn) return;

      const initialDelay = options.initialDelay ?? 350;
      const repeatInterval = options.repeatInterval ?? 90;
      let holdTimeout = null;
      let repeatTimer = null;
      let pointerActive = false;

      const clearTimers = () => {
        if (holdTimeout) { clearTimeout(holdTimeout); holdTimeout = null; }
        if (repeatTimer) { clearInterval(repeatTimer); repeatTimer = null; }
      };

      const invoke = () => {
        const result = action();
        return result !== false;
      };

      const stop = () => {
        pointerActive = false;
        clearTimers();
      };

      const start = ev => {
        if (ev.button !== undefined && ev.button !== 0) return;
        pointerActive = true;
        if (!invoke()) {
          pointerActive = false;
          return;
        }
        clearTimers();
        holdTimeout = setTimeout(() => {
          repeatTimer = setInterval(() => {
            if (!invoke()) stop();
          }, repeatInterval);
        }, initialDelay);
        ev.preventDefault();
      };

      btn.addEventListener('pointerdown', start);
      btn.addEventListener('pointerup', stop);
      btn.addEventListener('pointerleave', stop);
      btn.addEventListener('pointercancel', stop);
      btn.addEventListener('contextmenu', ev => {
        if (pointerActive) ev.preventDefault();
      });
      btn.addEventListener('click', ev => {
        if (ev.detail !== 0) return; // í‚¤ë³´ë“œ í´ë¦­ ì™¸ì—ëŠ” pointerdownìœ¼ë¡œ ì²˜ë¦¬
        invoke();
      });
      btn.addEventListener('keydown', ev => {
        if (ev.key === ' ' || ev.key === 'Enter') {
          ev.preventDefault();
          invoke();
        }
      });
    }

    async function ensureInitialData(refObj) {
      try {
        await runTransaction(refObj, current => {
          if (current === null) return { ...defaultData, _lastUpdated: Date.now() };
          return current;
        });
      } catch (err) { console.error('ì´ˆê¸°í™” íŠ¸ëœì­ì…˜ ì—ëŸ¬:', err); }
    }

    const SAVE_DEBOUNCE_MS = 450;
    let saveTimer = null;
    let lastSaveAt = 0;

    function performSaveNow() {
      if (!window.__PLAY_ALLOWED) return;
      const now = Date.now();
      state._lastUpdated = now;
      sessionLogger?.log?.('ì €ì¥ ë£¨í‹´ì´ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
      if (guestMode) {
        persistGuestProfile();
        recoveryManager?.safeCreate?.('guest-save');
        sessionLogger?.log?.('ê²ŒìŠ¤íŠ¸ í”„ë¡œí•„ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
        lastSaveAt = now;
        return;
      }
      if (!uid || !dataRef) return;
      if (isInitialSync) return;
      localLastWrite = now;
      lastSaveAt = now;
      try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
      update(dataRef, { ...state })
        .then(() => sessionLogger?.log?.('ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥ ì™„ë£Œ'))
        .catch(err => {
          console.error('ì €ì¥ ì—ëŸ¬:', err);
          sessionLogger?.log?.(`ì €ì¥ ì—ëŸ¬: ${err?.message || err}`);
        });
      recoveryManager?.safeCreate?.('sync-save');
    }

    function save(forceImmediate = false) {
      if (forceImmediate) {
        if (saveTimer) { clearTimeout(saveTimer); saveTimer = null; }
        performSaveNow();
        return;
      }
      const now = Date.now();
      const elapsed = now - lastSaveAt;
      if (elapsed >= SAVE_DEBOUNCE_MS) {
        if (saveTimer) { clearTimeout(saveTimer); saveTimer = null; }
        performSaveNow();
        return;
      }
      if (saveTimer) return;
      saveTimer = setTimeout(() => {
        saveTimer = null;
        performSaveNow();
      }, SAVE_DEBOUNCE_MS - elapsed);
    }

    window.addEventListener('pagehide', () => {
      sessionLogger?.log?.('pagehide ì´ë²¤íŠ¸ ê°ì§€, ì¦‰ì‹œ ì €ì¥í•©ë‹ˆë‹¤.');
      save(true);
      recoveryManager?.safeCreate?.('pagehide');
      recoveryManager?.stop?.();
    });
    document.addEventListener('visibilitychange', () => {
      sessionLogger?.log?.(`visibilitychange: ${document.visibilityState}`);
      if (document.visibilityState === 'hidden') {
        recoveryManager?.safeCreate?.('hidden');
        save(true);
      } else if (document.visibilityState === 'visible') {
        recoveryManager?.resume?.();
      }
    });

    /* ========= ìƒˆ í‚¤ ê·œì¹™ ========= */
    function encodeEmailToKey(email){
      const s = String(email||'').trim().toLowerCase();
      return s
        .replace(/\s+/g,'')
        .replace(/@/g,'_at_')
        .replace(/\./g,'_dot_')
        .replace(/[#$\[\]\/\\?%*]/g, '-')
        .replace(/[^a-z0-9_\-]/g, '-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromDisplayName(name){
      return (String(name||'').trim().toLowerCase() || 'user')
        .replace(/[^a-z0-9_\-]/g,'-')
        .replace(/-+/g,'-')
        .replace(/^[-_]+|[-_]+$/g,'') || 'user';
    }
    function fallbackIdFromUid(uid){
      return `user_${String(uid||'').slice(0,8) || '00000000'}`;
    }
    function makeIdKeyFromUser(user){
      if (user?.email) return encodeEmailToKey(user.email);
      if (user?.displayName) return fallbackIdFromDisplayName(user.displayName);
      return fallbackIdFromUid(user?.uid);
    }

    function isNewlyCreatedAccount(user, minutes = 5) {
      try {
        const ct = Date.parse(user?.metadata?.creationTime || '') || 0;
        const lt = Date.parse(user?.metadata?.lastSignInTime || '') || 0;
        if (!ct || !lt) return false;
        return Math.abs(lt - ct) <= minutes * 60 * 1000;
      } catch { return false; }
    }

    async function allocateServerForUser(){
      try{
        const res = await runTransaction(ref(db, 'meta/nextIndex'), cur => (cur || 0) + 1);
        const idx = res?.snapshot?.val() || 1;
        const serverNum = Math.max(1, Math.ceil(idx / 15));
        return `server${serverNum}`;
      }catch{
        return 'server1';
      }
    }

    async function planMigrationForUser(user){
      const uid = user.uid;
      const desiredId = makeIdKeyFromUser(user);
      const desiredServer = await allocateServerForUser();

      let mapping = null;
      try {
        const m = await get(ref(db, `userServerMap/${uid}`));
        mapping = m.exists() ? (m.val() || null) : null;
      } catch {}

      const legacySnap = await get(ref(db, `users/${uid}`));
      const legacyExists = legacySnap.exists();

      let srcBasePath = null;
      let server = desiredServer;

      if (mapping && mapping.server && mapping.id) {
        srcBasePath = `users/${mapping.server}/${mapping.id}`;
        server = mapping.server;
      } else if (legacyExists) {
        srcBasePath = `users/${uid}`;
      }

      const destBasePath = `users/${server}/${desiredId}`;
      const destSnap = await get(ref(db, destBasePath));
      const destExists = destSnap.exists();

      if (isNewlyCreatedAccount(user) && !legacyExists && !mapping && !destExists) {
        return { need: false, server, oldMapping: null, srcBasePath: null, destBasePath, reason: 'fresh-signup' };
      }

      if (mapping && mapping.server && mapping.id && mapping.id !== desiredId) {
        try {
          const srcSnap = await get(ref(db, srcBasePath));
          if (!srcSnap.exists()){
            return { need:false, server: mapping.server, oldMapping: mapping, srcBasePath: null, destBasePath, reason: 'rename-mapping-only' };
          }
        } catch {}
        return { need:true, server: mapping.server, oldMapping: mapping, srcBasePath, destBasePath, reason: 'rename-to-email-id' };
      }

      if (!mapping && legacyExists) {
        return { need:true, server, oldMapping: null, srcBasePath: `users/${uid}`, destBasePath, reason: 'legacy-flat' };
      }

      return { need:false, server, oldMapping: mapping || null, srcBasePath: null, destBasePath, reason: 'fresh-or-already-ok' };
    }

    function showMigrateOverlay(show=true, msg='ëŒ€ê¸° ì¤‘â€¦'){
      const ov = document.getElementById('migrate-overlay');
      const pr = document.getElementById('migrate-progress');
      if (pr) pr.textContent = msg || '';
      if (ov){
        ov.classList.toggle('show', !!show);
        ov.setAttribute('aria-hidden', show ? 'false':'true');
      }
    }
    function setMigrateProgress(msg){ const pr=document.getElementById('migrate-progress'); if(pr) pr.textContent = msg||''; }
    function disableMigrateStart(dis=true){ const btn=document.getElementById('migrate-start'); if(btn) btn.disabled=!!dis; }

    async function performMigration(srcBasePath, destBasePath, user){
      setMigrateProgress('1/3 ê¸°ì¡´ ë°ì´í„° ì½ëŠ” ì¤‘â€¦');
      const srcRef = ref(db, srcBasePath);
      const destRef = ref(db, destBasePath);

      const snap = await get(srcRef);
      if (!snap.exists()){
        setMigrateProgress('ì†ŒìŠ¤ì— ë°ì´í„°ê°€ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤.');
      } else {
        const payload = snap.val() || {};
        setMigrateProgress('2/3 ìƒˆ ìœ„ì¹˜ë¡œ ë³µì‚¬ ì¤‘â€¦');
        await update(ref(db), { [destBasePath]: payload });
        setMigrateProgress('3/3 ì›ë³¸ ì‚­ì œ ì¤‘â€¦');
        await update(ref(db), { [srcBasePath]: null });
      }
      const displayEmail = String(user?.email || '').trim();
      await update(ref(db), {
        [`userServerMap/${user.uid}`]: {
          server: userServerKey,
          id: userIdKey,
          displayId: displayEmail || null,
          migratedAt: Date.now()
        }
      });
      setMigrateProgress('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ! ì ì‹œ í›„ ê²Œì„ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦');
    }

    /* ======================
       KST ìœ í‹¸ / ë°ì¼ë¦¬
       ====================== */
    function kstDate(d=new Date()){
      return new Date(new Date(d).toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    }
    function kstDayKey(d=new Date()){
      const t = kstDate(d);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), day=String(t.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function nextResetKST(d=new Date()){ const t=kstDate(d); const n=new Date(t); n.setHours(24,0,0,0); return n; }
    function fmtLeft(ms){
      if(ms<=0) return 'ì§€ê¸ˆ ê°€ëŠ¥';
      const s=Math.floor(ms/1000);
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
    }

    const BASE_DAILY_QUESTS = [
      { id:'collect_res',       title:'ìì› 1,200 ì±„ì§‘',                unit:'res',         target:1200 },
      { id:'convert_ore',       title:'ìì› ë³€í™˜(ìë™ í¬í•¨) 25íšŒ',      unit:'convert',     target:25 },
      { id:'hire_workers',      title:'ì•Œë°” 3ëª… ê³ ìš©',                  unit:'worker',      target:3 },
      { id:'ship_upgrade',      title:'ìš°ì£¼ì„  1íšŒ ì—…ê·¸ë ˆì´ë“œ(ì¤‘ê°„)',     unit:'ship',        target:1 },
      { id:'coin_manual_daily', title:'ì§ì ‘ ì „í™˜ìœ¼ë¡œ ì½”ì¸ 2,400 íšë“',   unit:'coin_manual', target:2400 },
      { id:'coin_worker_daily', title:'ì•Œë°”ë¡œ ì½”ì¸ 3,200 íšë“',          unit:'coin_worker', target:3200 }
    ];
    const BASE_WEEKLY_QUESTS = [
      { id:'coin_manual_weekly', title:'ì§ì ‘ ì „í™˜ìœ¼ë¡œ ì½”ì¸ 45,000 íšë“', unit:'coin_manual', target:45000 },
      { id:'coin_worker_weekly', title:'ì•Œë°”ë¡œ ì½”ì¸ 60,000 íšë“',        unit:'coin_worker', target:60000 },
      { id:'upgrade_ship',       title:'ìš°ì£¼ì„  4íšŒ ì—…ê·¸ë ˆì´ë“œ',          unit:'ship',        target:4 },
      { id:'explore_planet',     title:'ìƒˆ í–‰ì„± 2ê°œ ì •ë³µ',               unit:'planet',      target:2 },
      { id:'bulk_convert',       title:'ìì› ë³€í™˜(ìë™ í¬í•¨) 120íšŒ',     unit:'convert',     target:120 }
    ];

    function computeQuestDifficultySnapshot(kind){
      const planets     = state.ownedPlanets?.length || 0;
      const ship        = Math.max(1, state.shipLevel || 1);
      const workers     = state.workerCount || 0;
      const converters  = state.conversionCount || 0;
      const auto        = (state.autoConvertBought && state.autoConvertEnabled) ? 1 : 0;
      const wealthScore = Math.log10(Math.max(1, (state.coins||0) + (state.resources||0)));
      let raw = 1 + (workers * 0.05) + (converters * 0.08) + (ship * 0.12) + (planets * 0.28) + (auto * 0.25) + (wealthScore * 0.18);
      if (kind === 'weekly') raw += planets * 0.12 + ship * 0.08 + converters * 0.05;
      const cap = kind === 'weekly' ? 4.6 : 3.2;
      return Math.min(cap, raw);
    }

    function weeklyAnchor(d=new Date()){
      const t = kstDate(d);
      const day = t.getDay(); // 0: Sun
      const anchor = new Date(t);
      anchor.setHours(12,0,0,0);
      anchor.setDate(anchor.getDate() - day);
      if (day === 0 && t < anchor) anchor.setDate(anchor.getDate() - 7);
      return anchor;
    }
    function weeklyKey(d=new Date()){
      const a = weeklyAnchor(d);
      const y=a.getFullYear(), m=String(a.getMonth()+1).padStart(2,'0'), day=String(a.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}@12`;
    }
    function nextWeeklyReset(d=new Date()){
      const a = weeklyAnchor(d);
      const n = new Date(a);
      n.setDate(a.getDate()+7);
      return n;
    }

    function ensureQuestBuckets(){
      if (!state.quests || typeof state.quests !== 'object') state.quests = {};
      if (!state.quests.daily || typeof state.quests.daily !== 'object') state.quests.daily = {};
      if (!state.quests.weekly || typeof state.quests.weekly !== 'object') state.quests.weekly = {};
      if (!state.quests.daily.progress || typeof state.quests.daily.progress !== 'object') state.quests.daily.progress = {};
      if (!state.quests.weekly.progress || typeof state.quests.weekly.progress !== 'object') state.quests.weekly.progress = {};
    }
    function syncQuestPeriods(){
      ensureQuestBuckets();
      const dKey = kstDayKey();
      const wKey = weeklyKey();
      if (state.quests.daily.key !== dKey) {
        state.quests.daily = { key:dKey, progress:{}, completed:false, premiumUsed:false, completedAt:0, difficulty: computeQuestDifficultySnapshot('daily') };
      }
      if (state.quests.weekly.key !== wKey) {
        state.quests.weekly = { key:wKey, progress:{}, completed:false, ecoinUsed:false, completedAt:0, difficulty: computeQuestDifficultySnapshot('weekly') };
      }
      if (!state.quests.daily.progress) state.quests.daily.progress = {};
      if (!state.quests.weekly.progress) state.quests.weekly.progress = {};
      if (!state.quests.daily.difficulty) state.quests.daily.difficulty = computeQuestDifficultySnapshot('daily');
      if (!state.quests.weekly.difficulty) state.quests.weekly.difficulty = computeQuestDifficultySnapshot('weekly');
    }
    function questDifficulty(kind){
      syncQuestPeriods();
      const bucket = state?.quests?.[kind];
      return Math.max(1, bucket?.difficulty || 1);
    }
    function questUnitScale(task, kind){
      if (!task || (task.unit!=='coin_manual' && task.unit!=='coin_worker')) return 1;
      const wealth = Math.log10(Math.max(10, (state.coins||0) + (state.resources||0)));
      const clickScore = Math.max(1, state.clickPower || 1);
      const workerScore = Math.max(1, state.conversionCount || 0);
      let scale = 1 + (wealth * 0.25);
      if (task.unit === 'coin_manual') scale += Math.min(2.4, clickScore * 0.15);
      if (task.unit === 'coin_worker') scale += Math.min(3.0, workerScore * 0.22);
      const cap = kind === 'weekly' ? 4.8 : 3.6;
      return Math.min(cap, scale);
    }
    function questTasks(kind){
      const base = kind === 'weekly' ? BASE_WEEKLY_QUESTS : BASE_DAILY_QUESTS;
      const diff = questDifficulty(kind);
      return base.map(task => ({
        ...task,
        target: Math.max(task.target, Math.round(task.target * diff * questUnitScale(task, kind)))
      }));
    }
    function questProgress(kind){ syncQuestPeriods(); return state?.quests?.[kind]?.progress || {}; }
    function isQuestComplete(kind){
      const tasks = questTasks(kind);
      const prog = questProgress(kind);
      return tasks.every(t => (prog[t.id] || 0) >= t.target);
    }
    function questRewardAvailable(kind){
      syncQuestPeriods();
      if (kind === 'daily') return isQuestComplete('daily') && !state.quests.daily.premiumUsed;
      if (kind === 'weekly') return isQuestComplete('weekly') && !state.quests.weekly.ecoinUsed;
      return false;
    }

    function applyQuestProgress(kind, amount = 1){
      syncQuestPeriods();
      const delta = Math.max(0, Number(amount) || 0);
      if (!delta) return;

      ['daily','weekly'].forEach(type => {
        const qs = state.quests[type];
        if (!qs.progress) qs.progress = {};
        const tasks = questTasks(type).filter(t => t.unit === kind);
        if (!tasks.length) return;

        tasks.forEach(task => {
          const prev = Number(qs.progress?.[task.id] || 0);
          const next = Math.min(task.target, prev + delta);
          qs.progress[task.id] = next;
        });

        const finished = isQuestComplete(type);
        if (finished && !qs.completed){
          qs.completed = true;
          qs.completedAt = Date.now();
          const msg = type === 'daily'
            ? 'âœ… ì¼ì¼ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ì´ ì—´ë ¸ì–´ìš”.'
            : 'ğŸŒŸ ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ì´ ì—´ë ¸ì–´ìš”.';
          showToast(msg, 'ë°”ë¡œ ë³´ê¸°', () => { try { openQuestOverlay(); } catch {} }, 5200);
        }
      });

      renderQuestUI();
      updateSpinButtons();
    }

    /* âœ… ë£°ë ›ìš© ê¸°ë³¸ê°’ì€ ìœ ì§€í•˜ì§€ë§Œ, ì§€ê¸ˆë¶€í„°ëŠ” â€œí˜„ì¬ ì½”ì¸ ê¸°ë°˜â€ ë³´ìƒì´ ìš°ì„  */
    function calcBaseCoin(){
      const rps = state.workerCount * getWorkerPower();
      const cps = state.conversionCount;
      const rpc = state.clickPower;
      const planets = (state.ownedPlanets?.length || 0);
      const ship = (state.shipLevel || 1);
      const auto = (state.autoConvertBought && state.autoConvertEnabled) ? 1 : 0;
      const score =
        20 * Math.log2(1 + rps) +
        45 * Math.log2(1 + cps) +
        10 * Math.log2(1 + rpc) +
        120 * planets +
        32  * ship +
        (auto ? 20 : 0);
      const baseRaw = 50 + score;
      return Math.min(Math.max(baseRaw * 0.65, 30), 30000);
    }

    /* ====== ì—¬ê¸°ì„œë¶€í„° ë£°ë › í…œí”Œë¦¿ ====== */
    const ROULETTE_AUDIT_WINDOW_MS = 15000;

    const TPL_DAILY = [
      { key:'coin_cur_06', type:'coin', currentCoinMul:0.6, icon:'ğŸ’°', color:'#00E5FF', w:0.35 },
      { key:'coin_cur_07', type:'coin', currentCoinMul:0.7, icon:'ğŸ’°', color:'#4DFFB5', w:0.25 },
      { key:'res_x2_5m',   type:'buff', bkind:'res',  bmult:1.0, bdur:5*60*1000, icon:'âš¡',  color:'#FFA8FF', w:0.18 },
      { key:'all_x2_3m',   type:'buff', bkind:'all',  bmult:1.0, bdur:3*60*1000, icon:'ğŸš€',  color:'#8AE1FF', w:0.13 },
      { key:'coinbuf_x2_3m', type:'buff', bkind:'coin', bmult:1.0, bdur:3*60*1000, icon:'ğŸª™', color:'#FFD0A8', w:0.06 },
      { key:'eco_1',       type:'ecoin', val:1,       icon:'ğŸŸï¸', color:'#FFD05C', w:0.03 }
    ];

    const TPL_PREMIUM = [
      { key:'coin_cur_1',  type:'coin', currentCoinMul:1.4, icon:'ğŸ’°', color:'#00E5FF', w:0.26 },
      { key:'coin_cur_2',  type:'coin', currentCoinMul:2.8, icon:'ğŸ’°', color:'#4DFFB5', w:0.20 },
      { key:'coin_x5_5',   type:'coin', coinMul:7.5,       icon:'ğŸ’°', color:'#32C6FF', w:0.10 },
      { key:'all_x2_10m',  type:'buff', bkind:'all',  bmult:1.4, bdur:12*60*1000, icon:'ğŸš€', color:'#8AE1FF', w:0.18 },
      { key:'res_x3_7m',   type:'buff', bkind:'res',  bmult:2.6, bdur:9*60*1000,  icon:'âš¡', color:'#FFA8FF', w:0.12 },
      { key:'coinbuf_x3_5m', type:'buff', bkind:'coin', bmult:2.5, bdur:7*60*1000, icon:'ğŸª™', color:'#FFD0A8', w:0.09 },
      { key:'eco_3',       type:'ecoin', val:5,       icon:'ğŸŸï¸', color:'#FF9E3D', w:0.05 }
    ];

    const TPL_ECOIN = [
      { key:'coin_cur_5',  type:'coin', currentCoinMul:7.0,  icon:'ğŸ’°', color:'#00E5FF', w:0.26 },
      { key:'coin_cur_10', type:'coin', currentCoinMul:14.0, icon:'ğŸ’°', color:'#4DFFB5', w:0.20 },
      { key:'coin_cur_20', type:'coin', currentCoinMul:28.0, icon:'ğŸ’°', color:'#32C6FF', w:0.12 },
      { key:'all_x3_15m',  type:'buff', bkind:'all',  bmult:2.5, bdur:18*60*1000, icon:'ğŸš€', color:'#8AE1FF', w:0.16 },
      { key:'res_x5_12m',  type:'buff', bkind:'res',  bmult:4.5,  bdur:15*60*1000, icon:'âš¡', color:'#FFA8FF', w:0.11 },
      { key:'eco_8',       type:'ecoin', val:12,      icon:'ğŸŸï¸', color:'#FFBE5C', w:0.07 },
      { key:'eco_12',      type:'ecoin', val:18,      icon:'ğŸŸï¸', color:'#FF9E3D', w:0.05 },
      { key:'eco_20',      type:'ecoin', val:28,      icon:'ğŸŸï¸', color:'#FF7AE1', w:0.03 }
    ];

    function materializeItems(tpl, mode){
      const base = calcBaseCoin();
      return tpl.map(it=>{
        if (it.type === 'coin' && typeof it.currentCoinMul === 'number') {
          const curCoins = state.coins || 0;
          const amt = Math.max(1, Math.round(curCoins * it.currentCoinMul));
          return {
            ...it,
            awardCoin: amt,
            label: `í˜„ì¬ì½”ì¸ Ã—${it.currentCoinMul} (= ${formatKR(amt)})`,
            onWin:()=>{
              const finalAmt = amt * (perkState.coinMult || 1);
              registerAuditIntent('coin', finalAmt, ROULETTE_AUDIT_WINDOW_MS);
              state.coins += finalAmt;
              auditGain('coin', finalAmt);
            }
          };
        }
        if (it.type==='coin' && typeof it.coinMul === 'number') {
          const amt = Math.max(1, Math.round(base * it.coinMul));
          return {
            ...it,
            awardCoin: amt,
            label:`ì½”ì¸ ${formatKR(amt)}`,
            onWin:()=>{
              const finalAmt = amt * (perkState.coinMult || 1);
              registerAuditIntent('coin', finalAmt, ROULETTE_AUDIT_WINDOW_MS);
              state.coins += finalAmt;
              auditGain('coin', finalAmt);
            }
          };
        }
        if (it.type==='ecoin'){
          return {
            ...it,
            awardEcoin: it.val,
            label:`ì´ë²¤íŠ¸ì½”ì¸ Ã—${it.val}`,
            onWin:()=>{
              registerAuditIntent('eco', it.val, ROULETTE_AUDIT_WINDOW_MS);
              const gained = addEventCoins(it.val, 'slot');
              auditGain('eco', gained);
            }
          };
        }
        if (it.type==='buff'){
          const multText = `x${1+it.bmult}`;
          const minText  = `${Math.round(it.bdur/60000)}m`;
          let title = it.bkind==='all' ? `ëª¨ë“  ìƒì‚° ${multText}`
                   : it.bkind==='coin' ? `ì½”ì¸ ìƒì‚° ${multText}`
                   :                    `ìì› ìƒì‚° ${multText}`;
          return { ...it, label:`${title} / ${minText}`, onWin:()=>{ addTempBuff(it.bkind, it.bmult, it.bdur); } };
        }
        return it;
      });
    }
    function getItemsForMode(mode){
      const tpl = mode==='daily'   ? TPL_DAILY
               : mode==='premium' ? TPL_PREMIUM
               : mode==='ecoin'   ? TPL_ECOIN
               : TPL_PREMIUM;
      return materializeItems(tpl, mode);
    }

    function playSfx(id){
      if (isOffline() || isBackgrounded()) return;
      const el=document.getElementById(id);
      if (el && el.play){ el.currentTime=0; el.play().catch(()=>{}); return; }
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination); o.type='triangle';
        o.frequency.value = id==='sfx-start'? 340 : id==='sfx-win'? 660 : 880;
        g.gain.setValueAtTime(.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.12, ctx.currentTime+.02);
        o.start(); o.stop(ctx.currentTime+.08);
      }catch{}
    }
    function startTickLoop(intv=120){ stopTickLoop(); startTickLoop._id=setInterval(()=>playSfx('sfx-tick'), intv); }
    function stopTickLoop(){ if(startTickLoop._id){ clearInterval(startTickLoop._id); startTickLoop._id=null; } }

    const slotWrap = document.getElementById('slot-wrap');
    const reel = document.getElementById('slot-reel');
    function buildSlot(items){
      const rows = items.map(it=>`<div class="slot-item"><span class="slot-icon">${it.icon||'ğŸ'}</span>${it.label||it.key}</div>`).join('');
      reel.innerHTML = rows.repeat(8);
      reel.style.transform = 'translateY(0px)';
      reel.style.transition = 'none';
    }

    let isSpinning = false;
    let lastRouletteAwardAt = 0;

    function spinSlot(items, picked){
      const rowH=56;
      const idx = Math.max(0, items.findIndex(it=>it.key===picked.key));
      const stopRow = (items.length*6) + (idx<0?0:idx);
      const targetY = - stopRow * rowH;
      startTickLoop(90);
      playSfx('sfx-start');
      return new Promise(resolve=>{
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            reel.style.transition = 'transform 2.6s cubic-bezier(.17,.89,.35,1.12)';
            reel.style.transform = `translateY(${targetY}px)`;
          });
        });
        reel.ontransitionend = ()=>{ reel.ontransitionend=null; stopTickLoop(); playSfx('sfx-win'); resolve(); };
      });
    }

    const dailyOverlay = document.getElementById('daily-overlay');
    const dailyInfo    = document.getElementById('daily-info');
    const dailyCloseBtn= document.getElementById('daily-close');
    const probPanel    = document.getElementById('prob-panel');
    const probToggle   = document.getElementById('prob-toggle');
    const rewardList   = document.getElementById('reward-list');
    const tabs = Array.from(document.querySelectorAll('.tbtn'));
    const spinDailyBtn   = document.getElementById('spin-daily');
    const spinPremiumBtn = document.getElementById('spin-premium');
    const spinEcoinBtn   = document.getElementById('spin-ecoin');
    const questOverlay   = document.getElementById('quest-overlay');
    const questCard      = document.getElementById('quest-card');
    const questHead      = document.getElementById('quest-head');
    const questCloseBtn  = document.getElementById('quest-close');
    const questTabs      = Array.from(document.querySelectorAll('.qtab'));
    const questPanels    = {
      daily: document.querySelector('.quest-panel[data-panel="daily"]'),
      weekly: document.querySelector('.quest-panel[data-panel="weekly"]')
    };
    const questDailyList   = document.getElementById('quest-daily-list');
    const questWeeklyList  = document.getElementById('quest-weekly-list');
    const questDailySummary= document.getElementById('quest-daily-summary');
    const questWeeklySummary= document.getElementById('quest-weekly-summary');
    const questBadge       = document.getElementById('quest-badge');
    const questSideStatus  = document.getElementById('quest-status-side');
    const slotAccessInfo   = document.getElementById('slot-access-info');

    let dailyCache = null;
    let currentMode = 'daily';
    let activeItems = [];

    /* ====== ğŸ”’ ì´ë²¤íŠ¸ ì ê¸ˆ(ìº”ìŠ¬) ìœ í‹¸ ====== */
    let eventLockUntil = 0;
    function isEventLocked(){ return Date.now() < eventLockUntil; }
    function cancelEvents(reason='ì´ë²¤íŠ¸ ì¼ì‹œ ì¤‘ì§€'){
      eventLockUntil = Date.now() + 5*60*1000; // 5ë¶„ ì ê¸ˆ
      try { showToast(`ğŸŸï¸ ${reason} (5ë¶„)`, null, null, 5000); } catch {}
      try {
        const info = document.getElementById('daily-info');
        if (info) info.innerHTML = 'âš ï¸ ì•ˆì „ ì ê²€ìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      } catch {}
      updateSpinButtons();
    }

    function openDailyOverlay(){ dailyOverlay.classList.add('show'); dailyOverlay.setAttribute('aria-hidden','false'); }
    function closeDailyOverlay(){ dailyOverlay.classList.remove('show'); dailyOverlay.setAttribute('aria-hidden','true'); }
    dailyCloseBtn.onclick = closeDailyOverlay;
    probToggle.onclick = ()=>{ probPanel.style.display = (probPanel.style.display==='block'?'none':'block'); };

    function setMode(mode){
      currentMode = mode;
      tabs.forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
      activeItems = getItemsForMode(mode);
      slotWrap.style.display     = 'flex';
      document.getElementById('spin-daily').style.display   = (mode==='daily')? 'inline-block':'none';
      document.getElementById('spin-premium').style.display = (mode==='premium')? 'inline-block':'none';
      document.getElementById('spin-ecoin').style.display   = (mode==='ecoin')? 'inline-block':'none';
      buildSlot(activeItems);
      buildProbPanel(activeItems, mode);
      buildRewardList(activeItems);
      updateSpinButtons();
    }
    tabs.forEach(b=>b.addEventListener('click', ()=>setMode(b.dataset.mode)));

    function setQuestTab(tab){
      questTabs.forEach(b=>b.classList.toggle('active', b.dataset.qtab===tab));
      Object.entries(questPanels).forEach(([key, panel]) => {
        if (!panel) return;
        panel.classList.toggle('active', key === tab);
      });
    }
    questTabs.forEach(b=>b.addEventListener('click', ()=>setQuestTab(b.dataset.qtab)));

    function buildQuestList(kind, container){
      if (!container) return;
      const tasks = questTasks(kind);
      const prog  = questProgress(kind);
      const rows = tasks.map(task => {
        const cur = Math.min(task.target, prog[task.id] || 0);
        const pct = Math.min(100, (cur / task.target) * 100);
        const done = cur >= task.target;
        const curText = (task.unit === 'coin' || task.unit === 'res') ? formatKR(Math.floor(cur)) : Math.floor(cur);
        const targetText = (task.unit === 'coin' || task.unit === 'res') ? formatKR(task.target) : task.target;
        return `<div class="quest-item ${done?'done':''}">
          <div class="quest-title">${done ? 'âœ…' : 'â–«ï¸'} ${task.title}</div>
          <div class="quest-progress"><div class="quest-bar" style="width:${pct}%"></div></div>
          <div class="quest-numbers"><span>${curText} / ${targetText}</span><span>${pct.toFixed(0)}%</span></div>
        </div>`;
      }).join('');
      container.innerHTML = rows || '<div class="quest-item">í€˜ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    }

    function questResetText(kind){
      const now = kstDate();
      const resetAt = kind === 'daily' ? nextResetKST(now) : nextWeeklyReset(now);
      const left = Math.max(0, resetAt - now);
      const label = kind === 'daily' ? 'ë‹¤ìŒ ì´ˆê¸°í™”ê¹Œì§€' : 'ë‹¤ìŒ ì£¼ê°„ ì´ˆê¸°í™”ê¹Œì§€';
      return `${label} ${fmtLeft(left)}`;
    }

    function renderQuestSummaries(){
      if (questDailySummary){
        const ready = questRewardAvailable('daily');
        const done  = isQuestComplete('daily');
        const used  = !!state.quests?.daily?.premiumUsed;
        const msg = ready ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ 1íšŒ ì‚¬ìš© ê°€ëŠ¥!'
          : done && used ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ì„ ì˜¤ëŠ˜ ì´ë¯¸ ì‚¬ìš©í–ˆì–´ìš”.'
          : 'ëª¨ë“  ê³¼ì œë¥¼ ì™„ë£Œí•´ í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ì„ ì—´ì–´ë³´ì„¸ìš”.';
        questDailySummary.innerHTML = `${msg}<br>${questResetText('daily')}`;
      }
      if (questWeeklySummary){
        const ready = questRewardAvailable('weekly');
        const done  = isQuestComplete('weekly');
        const used  = !!state.quests?.weekly?.ecoinUsed;
        const msg = ready ? 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ 1íšŒ ì‚¬ìš© ê°€ëŠ¥!'
          : done && used ? 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ì„ ì´ë²ˆ ì£¼ ì´ë¯¸ ì‚¬ìš©í–ˆì–´ìš”.'
          : 'ëª¨ë“  ê³¼ì œë¥¼ ì™„ë£Œí•´ ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ì„ ì—´ì–´ë³´ì„¸ìš”.';
        questWeeklySummary.innerHTML = `${msg}<br>${questResetText('weekly')}`;
      }
    }

    function renderQuestBadges(){
      const dailyReady = questRewardAvailable('daily');
      const weeklyReady = questRewardAvailable('weekly');
      if (questBadge){
        const visible = dailyReady || weeklyReady;
        questBadge.classList.toggle('hidden', !visible);
        questBadge.textContent = visible ? '!' : 'Â·';
      }
      if (questSideStatus){
        const label = dailyReady && weeklyReady ? 'ë‘ ìŠ¬ë¡¯ ì¤€ë¹„'
          : dailyReady ? 'í”„ë¦¬ë¯¸ì—„ ì¤€ë¹„'
          : weeklyReady ? 'ì´ë²¤íŠ¸ì½”ì¸ ì¤€ë¹„'
          : 'ì§„í–‰ ì¤‘';
        questSideStatus.textContent = label;
      }
    }

    function renderSlotAccess(){
      if (!slotAccessInfo) return;
      const dailyReady = questRewardAvailable('daily');
      const weeklyReady = questRewardAvailable('weekly');
      const dailyDone = isQuestComplete('daily');
      const weeklyDone = isQuestComplete('weekly');
      const dailyUsed = !!state.quests?.daily?.premiumUsed;
      const weeklyUsed = !!state.quests?.weekly?.ecoinUsed;
      const dailyText = dailyReady ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ ì‚¬ìš© ê°€ëŠ¥ (ì¼ì¼ í€˜ìŠ¤íŠ¸ ì™„ë£Œ)'
        : dailyDone && dailyUsed ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ ì˜¤ëŠ˜ ì‚¬ìš© ì™„ë£Œ'
        : 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯: ì¼ì¼ í€˜ìŠ¤íŠ¸ ì™„ë£Œ í•„ìš”';
      const weeklyText = weeklyReady ? 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ ì‚¬ìš© ê°€ëŠ¥ (ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ)'
        : weeklyDone && weeklyUsed ? 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ ì´ë²ˆ ì£¼ ì‚¬ìš© ì™„ë£Œ'
        : 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯: ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ í•„ìš”';
      slotAccessInfo.innerHTML = `${dailyText}<br>${weeklyText}`;
    }

    function renderQuestUI(){
      syncQuestPeriods();
      buildQuestList('daily', questDailyList);
      buildQuestList('weekly', questWeeklyList);
      renderQuestSummaries();
      renderQuestBadges();
      renderSlotAccess();
    }

    function openQuestOverlay(){
      renderQuestUI();
      setQuestTab('daily');
      if (!questOverlay) return;
      questOverlay.classList.add('show');
      questOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeQuestOverlay(){
      if (!questOverlay) return;
      if (questCard){ questCard.style.transform=''; questCard.style.transition=''; }
      questOverlay.classList.remove('show');
      questOverlay.setAttribute('aria-hidden', 'true');
    }
    questCloseBtn?.addEventListener('click', closeQuestOverlay);
    questOverlay?.addEventListener('click', (e) => { if (e.target === questOverlay) closeQuestOverlay(); });
    window.openQuestOverlay = openQuestOverlay;

    function enableQuestDragClose(){
      if (!questCard || !questHead) return;
      let startY = 0;
      let currentY = 0;
      let dragging = false;

      const resetPosition = () => {
        questCard.style.transition = 'transform .22s ease';
        questCard.style.transform = 'translateY(0)';
        setTimeout(() => { questCard.style.transition = ''; }, 240);
      };

      const onPointerDown = (ev) => {
        const y = ev.clientY ?? ev.touches?.[0]?.clientY;
        if (y === undefined) return;
        dragging = true;
        startY = y;
        currentY = y;
        questCard.style.transition = 'none';
      };

      const onPointerMove = (ev) => {
        if (!dragging) return;
        const y = ev.clientY ?? ev.touches?.[0]?.clientY;
        if (y === undefined) return;
        currentY = y;
        const delta = Math.max(0, currentY - startY);
        questCard.style.transform = `translateY(${Math.min(delta, 160)}px)`;
      };

      const onPointerUp = () => {
        if (!dragging) return;
        const delta = Math.max(0, currentY - startY);
        dragging = false;
        if (delta > 120) {
          questCard.style.transition = 'transform .18s ease';
          questCard.style.transform = 'translateY(160px)';
          setTimeout(() => closeQuestOverlay(), 140);
          return;
        }
        resetPosition();
      };

      ['pointerdown','touchstart'].forEach(evt => questHead.addEventListener(evt, onPointerDown, { passive: true }));
      ['pointermove','touchmove'].forEach(evt => questOverlay?.addEventListener(evt, onPointerMove, { passive: true }));
      ['pointerup','pointercancel','touchend','touchcancel'].forEach(evt => questOverlay?.addEventListener(evt, onPointerUp, { passive: true }));
    }
    enableQuestDragClose();

    function buildProbPanel(items, mode){
      const total=items.reduce((a,b)=>a+b.w,0)||1;
      const rows=items.map(it=>`<tr><td>${it.icon||''} ${it.label||it.key}</td><td style="text-align:right">${((it.w/total)*100).toFixed(2)}%</td></tr>`).join('');
      const header = mode==='daily' ? 'ì¶œì„ ìŠ¬ë¡¯ í™•ë¥ '
                  : mode==='premium' ? 'í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ í™•ë¥ (ì¼ì¼ í€˜ìŠ¤íŠ¸ ë³´ìƒ)'
                  : 'ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ í™•ë¥ (ì£¼ê°„ í€˜ìŠ¤íŠ¸ ë³´ìƒ)';
      probPanel.innerHTML = `<div style="margin-bottom:6px; color:#9fdcff;">${header}</div><table>${rows}</table>`;
    }
    function buildRewardList(items){
      rewardList.innerHTML = 'ğŸ° ë³´ìƒ ëª©ë¡: ' + items.map(it=>`${it.icon||''} ${it.label||it.key}`).join(' Â· ');
    }
    function canClaimToday(){
      const today = kstDayKey();
      return dailyCache?.lastKey !== today;
    }
    function refreshDailyInfo(canClaim){
      const today = kstDayKey();
      const streak = dailyCache?.streak || 0;
      const resetLeft = Math.max(0, nextResetKST()-kstDate());
      const leftText = canClaim ? 'ì§€ê¸ˆ ê°€ëŠ¥' : `ë‹¤ìŒ ì¶œì„ê¹Œì§€ ${fmtLeft(resetLeft)}`;

      if (!dailyUnlocked){
        const need = Math.max(0, 100 - (state.coins||0));
        dailyInfo.innerHTML = `ğŸ”’ ì¶œì„ ë³´ìƒì€ <b>100ì½”ì¸</b> ëª¨ìœ¼ë©´ í•´ì œ!<br>ë‚¨ì€ ì½”ì¸: <b>${formatKR(need)}</b>`;
        spinDailyBtn.disabled = true;
        return;
      }
      dailyInfo.innerHTML = canClaim
        ? `ì˜¤ëŠ˜(${today}) ì¶œì„ ìŠ¬ë¡¯ ê°€ëŠ¥! <b>${leftText}</b><br>ì—°ì† ${streak}ì¼`
        : `ì˜¤ëŠ˜(${today})ì€ ì´ë¯¸ ì™„ë£Œ. <b>${leftText}</b><br>í˜„ì¬ ì—°ì† ${streak}ì¼`;
      spinDailyBtn.disabled = !canClaim;
    }

    async function applyPrizeTransaction(delta){
      await runTransaction(dataRef, current => {
        const cur = current || { ...defaultData };
        const next = { ...cur };
        next.coins      = (next.coins||0) + (delta.coins||0);
        next.resources  = (next.resources||0) + (delta.resources||0);
        next.eventCoins = (next.eventCoins||0) + (delta.eventCoins||0);
        next._lastUpdated = Date.now();
        return next;
      });
    }
    function makeDeltaSnapshot(){
      return { coins: state.coins||0, resources: state.resources||0, eventCoins: state.eventCoins||0 };
    }
    function deltaFrom(before){
      return {
        coins: (state.coins||0) - before.coins,
        resources: (state.resources||0) - before.resources,
        eventCoins: (state.eventCoins||0) - before.eventCoins
      };
    }
    function pickWeighted(items){ const s=items.reduce((a,b)=>a+b.w,0); let r=Math.random()*s; for(const it of items){ if((r-=it.w)<=0) return it; } return items.at(-1); }
    function canSpendEC(n){ return (state.eventCoins||0) >= n; }

    /* ğŸ” ë²„íŠ¼ ìƒíƒœ(ì ê¸ˆ í¬í•¨) */
    function updateSpinButtons(){
      const locked = isEventLocked();
      const canDaily   = dailyUnlocked && canClaimToday() && !isSpinning;
      const canPremium = questRewardAvailable('daily')  && !isSpinning;
      const canEcoin   = questRewardAvailable('weekly') && !isSpinning;

      spinDailyBtn.disabled   = locked || !canDaily;
      spinPremiumBtn.disabled = locked || !canPremium;
      spinEcoinBtn.disabled   = locked || !canEcoin;

      if (locked && dailyInfo){
        dailyInfo.innerHTML = 'âš ï¸ ì•ˆì „ ì ê²€ìœ¼ë¡œ ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      }

      renderSlotAccess();
    }

    async function tryUnlockDaily(){
      if (!uid || dailyUnlocked) return;
      if ((state.coins || 0) >= 100){
        dailyUnlocked = true;
        try {
          await update(ref(db), { [`${userBasePath}/daily/unlocked`]: true });
        } catch(e){ console.warn('unlock save error', e); }
        showToast('ğŸ”“ ì¶œì„ ë³´ìƒ ì ê¸ˆ í•´ì œ!', 'ì§€ê¸ˆ ì—´ê¸°', () => {
          setMode('daily'); openDailyOverlay();
        });
        refreshDailyInfo(canClaimToday());
        updateAttendanceLabels();
        updateSpinButtons();
      }
    }

    async function handleSpin(mode){
      if (!uid || !window.__PLAY_ALLOWED || isSpinning) return;
      if (!security.tosAccepted){ showTosOverlay(true); return; }
      if (security.banned){ showBanOverlay(true); return; }

      if (isEventLocked()){
        dailyInfo.innerHTML = 'ì´ë²¤íŠ¸ê°€ ì¼ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        updateSpinButtons();
        return;
      }

      if (mode==='daily' && !dailyUnlocked) { refreshDailyInfo(false); return; }
      if (mode==='premium' && !questRewardAvailable('daily')) {
        dailyInfo.innerHTML='í”„ë¦¬ë¯¸ì—„ ìŠ¬ë¡¯ì€ ì¼ì¼ í€˜ìŠ¤íŠ¸ ì™„ë£Œ í›„ í•˜ë£¨ 1íšŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        renderSlotAccess();
        return;
      }
      if (mode==='ecoin'   && !questRewardAvailable('weekly')){
        dailyInfo.innerHTML='ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ì€ ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ í›„ ì£¼ 1íšŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        renderSlotAccess();
        return;
      }

      setMode(mode);
      const picked = pickWeighted(activeItems);
      const before = makeDeltaSnapshot();

      isSpinning = true; updateSpinButtons();
      await spinSlot(activeItems, picked);
      picked.onWin();
      lastRouletteAwardAt = Date.now();

      try{
        const delta = deltaFrom(before);
        await applyPrizeTransaction(delta); updateUI();
        if (mode==='daily'){
          const today = kstDayKey(); const yesterday = kstDayKey(new Date(kstDate().getTime()-86400000));
          let streak = Number(dailyCache?.streak||0);
          if (dailyCache?.lastKey === yesterday) streak+=1; else streak=1;
          await update(ref(db), {
            [`${userBasePath}/daily`]: { ...(dailyCache||{}), unlocked: true, lastKey: today, streak, lastClaimAt: Date.now(), lastPrize: picked.key }
          });
          dailyCache = { ...(dailyCache||{}), lastKey: today, streak, unlocked:true };
          dailyInfo.innerHTML = `ğŸ‰ ë‹¹ì²¨: <b>${picked.label}</b><br>ì—°ì† ${streak}ì¼`;
        } else {
          if (mode==='premium'){
            state.quests.daily.premiumUsed = true;
            dailyInfo.innerHTML = `ğŸ‰ í”„ë¦¬ë¯¸ì—„ ë‹¹ì²¨: <b>${picked.label}</b><br>ì¼ì¼ í€˜ìŠ¤íŠ¸ ë³´ìƒ ì‚¬ìš© ì™„ë£Œ`;
          } else {
            state.quests.weekly.ecoinUsed = true;
            dailyInfo.innerHTML = `ğŸ‰ ì´ë²¤íŠ¸ì½”ì¸ ìŠ¬ë¡¯ ë‹¹ì²¨: <b>${picked.label}</b><br>ì£¼ê°„ ë³´ìƒ ì‚¬ìš© ì™„ë£Œ`;
          }
          renderQuestUI();
          save();
        }
      }catch(e){
        console.error(e);
        dailyInfo.textContent='ë³´ìƒ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }finally{
        isSpinning = false; updateSpinButtons();
      }
    }

    document.getElementById('spin-daily').onclick   = ()=>handleSpin('daily');
    document.getElementById('spin-premium').onclick = ()=>handleSpin('premium');
    document.getElementById('spin-ecoin').onclick   = ()=>handleSpin('ecoin');

    async function fetchDaily(){
      if (!uid) return;
      try{
        const snap = await get(ref(db, `${userBasePath}/daily`));
        const v = snap.exists() ? snap.val() : { lastKey:null, streak:0, unlocked:false };
        dailyCache = v;
        dailyUnlocked = v?.unlocked ? true : false;
      }catch{
        dailyCache = { lastKey:null, streak:0, unlocked:false }; dailyUnlocked = false;
      }
    }
    async function checkDailyAndMaybeShow(){
      await fetchDaily();
      refreshDailyInfo(canClaimToday());
      setMode('daily');
      if (dailyUnlocked && canClaimToday()) openDailyOverlay();
    }

    const attMenuRight = document.getElementById('attendance-left');
    const attSideRight = document.getElementById('attendance-left-side');
    function updateAttendanceLabels(){
      if (!uid){ attMenuRight.textContent='-'; attSideRight.textContent='-'; return; }
      if (!dailyUnlocked){ attMenuRight.textContent='ì ê¸ˆ'; attSideRight.textContent='ì ê¸ˆ'; return; }
      const today = kstDayKey();
      const can = (dailyCache?.lastKey !== today);
      if (can){ attMenuRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; attSideRight.textContent='ì§€ê¸ˆ ê°€ëŠ¥'; }
      else{
        const left = Math.max(0, nextResetKST()-kstDate());
        const txt = fmtLeft(left);
        attMenuRight.textContent=txt; attSideRight.textContent=txt;
      }
    }
    setInterval(updateAttendanceLabels, 1000);

    let lastShipImageLevel = null;
    function setShipImage(level) {
      const img = document.getElementById('ship-img');
      if (!img) return;
      const normalized = Math.max(1, level);
      if (lastShipImageLevel === normalized) return;
      let attempted = normalized;
      img.onerror = function onErr() {
        if (attempted > 1) {
          attempted -= 1;
          img.src = `/images/ship-level${attempted}.png`;
        } else {
          img.onerror = null;
          img.src = `/images/ship-level1.png`;
        }
      };
      img.src = `/images/ship-level${attempted}.png`;
      lastShipImageLevel = normalized;
    }

    const authContainer = document.getElementById('auth-container');
    const authErrorEl   = document.getElementById('auth-error');
    const bootOverlay   = document.getElementById('boot-overlay');

    // â˜… ë¶€íŒ… ì˜¤ë²„ë ˆì´ëŠ” 'ì²˜ìŒ 1íšŒ'ë§Œ
    function setBootVisible(v){
      if (!bootOverlay) return;
      const seen = localStorage.getItem('boot_seen') === '1';
      if (seen) {
        bootOverlay.style.display = 'none';
        bootOverlay.setAttribute('aria-hidden','true');
        return;
      }
      bootOverlay.style.display = v ? 'flex' : 'none';
      bootOverlay.setAttribute('aria-hidden', v ? 'false' : 'true');
    }

    function showAuthStatus(msg, isError = true) {
      authErrorEl.textContent = msg || '';
      if (msg) authErrorEl.classList.add('show'); else authErrorEl.classList.remove('show');
      authErrorEl.style.color = isError ? '#ffdede' : '#dfffe8';
    }

    function refreshGuestButton() {
      if (!guestStartBtn) return;
      guestStartBtn.textContent = hasGuestProfile() ? 'ê²ŒìŠ¤íŠ¸ë¡œ ê³„ì†í•˜ê¸°' : 'ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°';
    }

    function updateGuestUiState() {
      if (guestLoginBtn) {
        guestLoginBtn.style.display = guestMode ? 'inline-flex' : 'none';
      }
    }

    function showGameUI() {
      try {
        authContainer.classList.add('hidden');
        try { history.replaceState(null, '', '/ê²Œì„' + (location.hash || '')); } catch {}
        setTimeout(() => {
          authContainer.style.display = 'none';
          ['top-bar','container'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.visibility = 'visible';
          });
        }, 300);
      } catch (e) { console.error('showGameUI error', e); }
    }

    function startGuestMode() {
      try {
        hideAllOverlays();
        guestMode = true;
        guestTransferPreference = 'none';
        guestAutoStartSuppressed = false;
        loadGuestProfileIntoState();
        security.tosAccepted = true;
        security.banned = false;
        securityDirty = false;
        ensureFx();
        loadBuffs();
        renderBuffStatus();
        renderSecurityBadge();
        setBootVisible(false);
        bootDone = true;
        showAuthStatus('');
        showGameUI();
        updateUI();
        auditInit();
        renderPlanets();
        updateMailBadges();
        refreshGuestButton();
        updateGuestUiState();
        persistGuestProfile();
      } catch (err) {
        console.error('guest start failed', err);
      }
    }

    /* ===========================
       âš ï¸ ë³´ì•ˆ/ì•½ê´€/ì˜ì‹¬ë„ (ê°•í™”íŒ)
       =========================== */
    let security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
    let securityDirty = false;

    const TOS_ACCEPT_PREFIX = 'siu_tos_ok_';
    function markLocalTosAccepted(id) {
      if (!id) return;
      try { localStorage.setItem(`${TOS_ACCEPT_PREFIX}${id}`, '1'); } catch {}
    }
    function hasLocalTosAccepted(id) {
      if (!id) return false;
      try { return localStorage.getItem(`${TOS_ACCEPT_PREFIX}${id}`) === '1'; }
      catch { return false; }
    }

    // ì„ê³„ê°’
    const SEC_WARN_LEVEL = 20;
    const SEC_BAN_LEVEL  = 30;

    const EPS               = 1e-6;
    const UNKNOWN_THRESH    = 0.05;
    const HUMAN_MAX_CPS     = 12;
    const MAX_TICK_GAP_MS   = 5000;
    const RES_WEIGHT        = 0.8;
    const COIN_WEIGHT       = 1.0;
    const ECO_WEIGHT        = 1.2;

    const BAN_SPIKE_COINS = 1_000_000_000;
    const BAN_SPIKE_RES   = 100_000_000;
    const BAN_SPIKE_ECO   = 50_000;

    function renderSecurityBadge(){
      const el = document.getElementById('suspicion-badge');
      if (!el) return;
      el.classList.remove('warn','ban');
      el.textContent = `ì˜ì‹¬ë„: ${Math.round(security.suspicion)}`;
      if (security.suspicion >= SEC_BAN_LEVEL){ el.classList.add('ban'); }
      else if (security.suspicion > SEC_WARN_LEVEL){ el.classList.add('warn'); }
    }
    function showTosOverlay(show=true){
      const ov = document.getElementById('tos-overlay');
      if (ov){ ov.classList.toggle('show', !!show); ov.setAttribute('aria-hidden', show?'false':'true'); }
    }
    function showBanOverlay(show=true){
      const ov = document.getElementById('ban-overlay');
      if (ov){
        document.getElementById('ban-sus-value').textContent = Math.round(security.suspicion || 0);
        ov.classList.toggle('show', !!show); ov.setAttribute('aria-hidden', show?'false':'true');
      }
    }
    function markTosViolationFlag(){
      const vio = security.suspicion > SEC_WARN_LEVEL || security.banned;
      if (security.tosViolated !== vio){ security.tosViolated = vio; securityDirty = true; }
    }
    async function loadSecurity(){
      try {
        const snap = await get(ref(db, `${userBasePath}/security`));
        if (snap.exists()){
          const v = snap.val() || {};
          security = { ...security, ...v };
        }
      } catch {}
      if (uid) {
        if (security.tosAccepted) {
          markLocalTosAccepted(uid);
        } else if (hasLocalTosAccepted(uid)) {
          security.tosAccepted = true;
          securityDirty = true;
        }
      }
      markTosViolationFlag();
      await saveSecurity();
    }
    async function saveSecurity(){
      if (!uid || !userBasePath) return;
      if (!securityDirty) return;
      try {
        await update(ref(db), { [`${userBasePath}/security`]: {
          suspicion: security.suspicion,
          banned: security.banned,
          tosAccepted: security.tosAccepted,
          tosViolated: security.tosViolated,
          fairSeconds: security.fairSeconds,
          lastWarnAt: security.lastWarnAt
        }});
      } catch {}
      securityDirty = false;
    }

    const SUPPORT_CTX_KEY = 'siu_support_ctx';
    function saveSupportCtx(extra = {}) {
      const ctx = {
        server: userServerKey || null,
        idKey: userIdKey || null,
        basePath: userBasePath || null,
        uid: uid || null,
        suspicion: (security && typeof security.suspicion === 'number') ? security.suspicion : null,
        banned: !!(security && security.banned),
        ts: Date.now(),
        ...extra
      };
      try { localStorage.setItem(SUPPORT_CTX_KEY, JSON.stringify(ctx)); } catch {}
      return ctx;
    }
    function readSupportCtx() {
      try {
        const raw = localStorage.getItem(SUPPORT_CTX_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function clearSupportCtx(){
      try { localStorage.removeItem(SUPPORT_CTX_KEY); } catch {}
    }
    function hideAllOverlays(){
      try{ showBanOverlay(false); }catch{}
      try{ showTosOverlay(false); }catch{}
      try{ showMigrateOverlay(false); }catch{}
      try{ closeMailOverlay(); }catch{}
      try{ closeShopOverlay(); }catch{}
      try{
        const ov = document.getElementById('daily-overlay');
        if (ov){ ov.classList.remove('show'); ov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const pov = document.getElementById('policy-overlay');
        if (pov){ pov.classList.remove('show'); pov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const bov = document.getElementById('buff-overlay');
        if (bov){ bov.classList.remove('show'); bov.setAttribute('aria-hidden','true'); }
      }catch{}
      try{
        const qov = document.getElementById('quest-overlay');
        if (qov){ qov.classList.remove('show'); qov.setAttribute('aria-hidden','true'); }
      }catch{}
    }

    // === í•©ë²• ì¦ê° ì¥ë¶€ ===
    let audit = {
      last: null,
      recGain:  { res:0, coin:0, eco:0 },
      recSpend: { res:0, coin:0, eco:0 },
      lastAt: 0
    };
    function auditInit(){
      audit.last   = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.lastAt = Date.now();
    }
    function trackCoinQuestProgress(amount, source = 'generic'){
      const delta = Math.max(0, Number(amount) || 0);
      if (!delta) return;
      if (source === 'worker') { applyQuestProgress('coin_worker', delta); return; }
      if (source === 'manual') { applyQuestProgress('coin_manual', delta); return; }
      applyQuestProgress('coin', delta);
    }
    function auditGain(kind, amount, source = 'generic'){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recGain[k]) audit.recGain[k] = 0;
      audit.recGain[k] += Number(amount||0);
      if (k === 'res') applyQuestProgress('res', amount);
      if (k === 'coin') trackCoinQuestProgress(amount, source);
    }
    function auditSpend(kind, amount){
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      if (!audit.recSpend[k]) audit.recSpend[k] = 0;
      audit.recSpend[k] += Number(amount||0);
    }
    function auditAdd(kind, amount, source = 'generic'){ auditGain(kind, amount, source); }
    function auditResetCycle(){
      audit.recGain  = { res:0, coin:0, eco:0 };
      audit.recSpend = { res:0, coin:0, eco:0 };
      audit.last     = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      audit.lastAt   = Date.now();
    }

    // ì˜ë„ í—ˆìš© ì°½
    let auditIntent = { res:0, coin:0, eco:0, until:0 };
    function registerAuditIntent(kind, amount, windowMs=6000){
      const now = Date.now();
      if (auditIntent.until < now) auditIntent = { res:0, coin:0, eco:0, until: now + windowMs };
      const k = kind === 'coins' ? 'coin' : (kind === 'resources' ? 'res' : kind);
      auditIntent[k] = (auditIntent[k] || 0) + Math.max(0, Number(amount||0));
      auditIntent.until = Math.max(auditIntent.until, now + windowMs);
    }

    // BAN ì—”ë“œí¬ì¸íŠ¸
    let __BAN_ENDPOINT = null;
    async function __getBanEndpoint() {
      if (__BAN_ENDPOINT) return __BAN_ENDPOINT;
      try {
        const snap = await get(ref(db, 'meta/banEndpoint'));
        if (snap.exists()) __BAN_ENDPOINT = String(snap.val());
      } catch {}
      return __BAN_ENDPOINT;
    }
    async function requestAccountDisable(reason = 'auto-ban') {
      try {
        const url = await __getBanEndpoint();
        if (!url || !auth?.currentUser) return;
        const idToken = await auth.currentUser.getIdToken(true);
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            idToken,
            reason,
            suspicion: security?.suspicion ?? null
          })
        });
      } catch (e) { console.warn('ban endpoint failed', e); }
    }

    function expectedResGain(dtSec){
      const resBuff = activeBuffFactor('res');
      const workerGain = (state.workerCount * getWorkerPower()) * resBuff * dtSec;
      const clickGain  = (state.clickPower || 1) * HUMAN_MAX_CPS * resBuff * dtSec;
      return workerGain + clickGain + 0.5;
    }
    function expectedCoinGain(dtSec){
      const coinBuff = activeBuffFactor('coin');
      const convGain = (state.conversionCount || 0) * coinBuff * dtSec;
      return convGain + 2;
    }

    function adjustSuspicion(delta){
      const prev = security.suspicion;
      security.suspicion = Math.max(0, Math.min(1000, prev + delta));

      if (!security.banned && security.suspicion > SEC_WARN_LEVEL){
        const now = Date.now();
        if (!security.lastWarnAt || now - security.lastWarnAt > 60000){
          security.lastWarnAt = now;
          showToast('âš ï¸ ì˜ì‹¬ë„ê°€ 20ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë¹„ì •ìƒ ì¦ê°€ê°€ íƒì§€ë˜ë©´ ì •ì§€ë  ìˆ˜ ìˆì–´ìš”.');
          securityDirty = true;
        }
      }

      if (security.suspicion >= SEC_BAN_LEVEL && !security.banned){
        security.banned = true;
        securityDirty = true;
        requestAccountDisable('auto-ban:suspicion>=30').finally(async ()=>{
          showBanOverlay(true);
          showToast('â›” ì˜ì‹¬ë„ 30 ì´ìƒìœ¼ë¡œ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          try { await saveSecurity(); } catch {}
          saveSupportCtx({ banned: true });
          try { await auth.signOut(); } catch {}
        });
      }

      markTosViolationFlag();
      securityDirty = true;
      renderSecurityBadge();
    }

    function auditCheck(){
      const nowGlobal = Date.now();

      // âœ… ìš”ì²­ì‚¬í•­: "ì²˜ìŒ 3ì´ˆë§Œ ê²€ì‚¬í•˜ì§€ ì•Šê²Œ"
      // â†’ ì´ˆê¸° ë¶€íŒ… ì‹œì‘ ì‹œê°(AUDIT_BOOT_TS)ë¡œë¶€í„° 3ì´ˆê°€ ì§€ë‚˜ê¸° ì „ì´ë©´ ê²€ì‚¬ ìŠ¤í‚µ
      if (nowGlobal - AUDIT_BOOT_TS < AUDIT_INITIAL_SKIP_MS) {
        auditResetCycle();
        return;
      }

      if (!audit.last){ auditInit(); return; }
      const now = nowGlobal;
      let dtMs = now - (audit.lastAt || now);
      if (dtMs < 0) dtMs = 0;
      if (dtMs > MAX_TICK_GAP_MS) dtMs = MAX_TICK_GAP_MS;
      const dtSec = dtMs / 1000;

      const cur = { res: state.resources||0, coins: state.coins||0, eco: state.eventCoins||0 };
      let dr = cur.res   - audit.last.res;
      let dc = cur.coins - audit.last.coins;
      let de = cur.eco   - audit.last.eco;

      if (now <= (auditIntent.until||0)) {
        const useRes = Math.min(Math.max(0, dr), auditIntent.res||0);
        const useCoin= Math.min(Math.max(0, dc), auditIntent.coin||0);
        const useEco = Math.min(Math.max(0, de), auditIntent.eco||0);
        dr -= useRes; dc -= useCoin; de -= useEco;
        auditIntent.res  -= useRes;
        auditIntent.coin -= useCoin;
        auditIntent.eco  -= useEco;
      } else {
        auditIntent = { res:0, coin:0, eco:0, until:0 };
      }

      if (dc >= BAN_SPIKE_COINS || dr >= BAN_SPIKE_RES || de >= BAN_SPIKE_ECO) {
        adjustSuspicion(SEC_BAN_LEVEL + 1);
        auditResetCycle();
        return;
      }

      const legRes  = (audit.recGain.res  - audit.recSpend.res);
      const legCoin = (audit.recGain.coin - audit.recSpend.coin);
      const legEco  = (audit.recGain.eco  - audit.recSpend.eco);

      const physResRoom  = expectedResGain(dtSec);
      const physCoinRoom = expectedCoinGain(dtSec);

      const unknownRes  = Math.max(0, dr - legRes);
      const unknownCoin = Math.max(0, dc - legCoin);
      const unknownEco  = Math.max(0, de - legEco);

      const spikeRes  = Math.max(0, dr - (legRes  + physResRoom));
      const spikeCoin = Math.max(0, dc - (legCoin + physCoinRoom));

      if (unknownEco > EPS) {
        const rollback = Math.min(Math.floor(unknownEco), Math.floor(state.eventCoins || 0));
        if (rollback > 0) {
          state.eventCoins -= rollback;
          save(); updateUI();
        }
        cancelEvents('ë¹„ì •ìƒ ì´ë²¤íŠ¸ì½”ì¸ ì¦ê°€ ê°ì§€');
      }

      const mag = Math.log10(1
        + unknownRes
        + (unknownCoin * 10)
        + (unknownEco  * 20)
        + spikeRes
        + (spikeCoin * 10)
      );

      const ratioRes  = physResRoom  > 0 ? (dr - legRes) / physResRoom   : 0;
      const ratioCoin = physCoinRoom > 0 ? (dc - legCoin) / physCoinRoom : 0;
      const ratioBoost = Math.max(0, ratioRes - 1) + Math.max(0, ratioCoin - 1);

      const baseUnknown =
        (unknownRes  > EPS ? unknownRes  * RES_WEIGHT  : 0) +
        (unknownCoin > EPS ? unknownCoin * COIN_WEIGHT : 0) +
        (unknownEco  > EPS ? unknownEco  * ECO_WEIGHT  : 0);

      const baseSpike =
        (spikeRes  > EPS ? spikeRes  * 1.6 : 0) +
        (spikeCoin > EPS ? spikeCoin * 1.6 : 0);

      let score = (baseUnknown + baseSpike) * (1 + 0.6*mag + 0.8*ratioBoost);
      if (lastRouletteAwardAt && (now - lastRouletteAwardAt) < 12000) {
        const ecoSafe = unknownEco <= EPS;
        const spikeSafe = spikeRes <= EPS && spikeCoin <= EPS;
        score *= ecoSafe && spikeSafe ? 0.35 : 0.6;
      }

      if (score > UNKNOWN_THRESH){
        const add = Math.min(24, Math.max(2, Math.ceil(score)));
        adjustSuspicion(add);
        security.fairSeconds = 0;
        securityDirty = true;
      } else {
        security.fairSeconds = (security.fairSeconds||0) + dtSec;
        if (security.fairSeconds >= 90 && security.suspicion > 0){
          adjustSuspicion(-1);
          security.fairSeconds = 0;
        }
        securityDirty = true;
      }

      auditResetCycle();
    }

    function buildSupportInfoText(){
      const persisted = readSupportCtx();
      const server = userServerKey || persisted?.server || '(ì•Œ ìˆ˜ ì—†ìŒ)';
      const idKey  = userIdKey     || persisted?.idKey  || '(ì•Œ ìˆ˜ ì—†ìŒ)';
      const path   = userBasePath  || persisted?.basePath || '(ì•Œ ìˆ˜ ì—†ìŒ)';
      const nowKST = kstDate().toLocaleString('ko-KR');
      const uidStr = uid || persisted?.uid || '(ë¯¸ë¡œê·¸ì¸)';
      const sus    = (typeof security?.suspicion === 'number') ? security.suspicion
                : (typeof persisted?.suspicion === 'number') ? persisted.suspicion : null;
      return [
        `ì„œë²„: ${server}`,
        `ì•„ì´ë””í‚¤: ${idKey}`,
        `Realtime DB ê²½ë¡œ: ${path}`,
        `UID: ${uidStr}`,
        `í˜„ì¬ ì˜ì‹¬ë„: ${sus === null ? '(ì•Œ ìˆ˜ ì—†ìŒ)' : sus}`,
        `ë°œìƒ ì‹œê°(KST): ${nowKST}`
      ].join('\n');
    }
    function buildSupportMail(){
      const persisted = readSupportCtx();
      const s = userServerKey || persisted?.server || 'server?';
      const i = userIdKey     || persisted?.idKey  || 'id?';
      const subject = `[Appeal] ì˜¤íƒ ê²€í†  ìš”ì²­ - ${s} / ${i}`;
      const header  = 'ì•ˆë…•í•˜ì„¸ìš”, ì˜¤íƒìœ¼ë¡œ ì˜ì‹¬ë˜ì–´ ê²€í† ë¥¼ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.\n';
      const info    = buildSupportInfoText();
      const footer  = '\n\nìƒì„¸ ìƒí™©:\n(ì—¬ê¸°ì— ìƒí™©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”)\n';
      const body    = `${header}\n${info}${footer}`;
      const mailto  = `mailto:${SUPPORT_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      return { subject, body, mailto };
    }
    async function copySupportInfo(){
      try {
        await navigator.clipboard.writeText(buildSupportInfoText());
        showToast('ë³µì‚¬ ì™„ë£Œ! ë©”ì¼ì— ë¶™ì—¬ë„£ì–´ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.', null, null, 2500);
      } catch {
        showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', null, null, 2500);
      }
    }

    const scheduleUiFrame = typeof requestAnimationFrame === 'function'
      ? cb => requestAnimationFrame(cb)
      : cb => setTimeout(cb, 16);

    function renderChristmasUI() {
      const piecesEl = document.getElementById('santa-pieces');
      const coinsEl = document.getElementById('santa-coins');
      const eventInline = document.getElementById('event-coins-inline');
      if (piecesEl) piecesEl.innerText = formatKR(Math.floor(state.santaPieces || 0));
      if (coinsEl) coinsEl.innerText = formatKR(Math.floor(state.santaCoins || 0));
      if (eventInline) eventInline.innerText = formatKR(state.eventCoins || 0);

      const treeLv = Math.max(0, state.christmasTreeLevel || 0);
      const treeMax = christmasTreeRewards.length;
      const treeLevelEl = document.getElementById('tree-level');
      if (treeLevelEl) treeLevelEl.innerText = treeLv.toString();

      const nextReward = christmasTreeRewards[treeLv];
      const costEl = document.getElementById('tree-cost');
      if (costEl) costEl.innerText = nextReward ? `${nextReward.cost}` : 'MAX';

      const treeImg = document.getElementById('tree-image');
      if (treeImg) {
        const imgLv = Math.max(1, Math.min(treeMax, treeLv || 1));
        treeImg.src = `/images/tree${imgLv}.png`;
        treeImg.alt = `í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ë ˆë²¨ ${imgLv}`;
      }

      const unlockedBuffs = christmasTreeRewards.slice(0, treeLv).map((r, idx) => `<li>Lv.${idx + 1}: ${escapeHTML(r.reward)}</li>`);
      const rewardBox = document.getElementById('tree-rewards');
      if (rewardBox) {
        const upcoming = nextReward ? `<div style="margin-top:6px;">ë‹¤ìŒ ë³´ìƒ: <strong>${escapeHTML(nextReward.reward)}</strong></div>` : '<div style="margin-top:6px;">ëª¨ë“  ë³´ìƒì„ íšë“í–ˆìŠµë‹ˆë‹¤!</div>';
        rewardBox.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">í•´ì œëœ ë³´ìƒ</div>${unlockedBuffs.length ? `<ul style="margin:0 0 6px 18px; padding:0;">${unlockedBuffs.join('')}</ul>` : '<div>ì•„ì§ í•´ì œëœ ë³´ìƒì´ ì—†ì–´ìš”.</div>'}${upcoming}`;
      }

      renderPermanentBuffs();
    }

    function renderUIContents() {
      pruneExpiredBuffs();
      syncQuestPeriods();
      document.getElementById('score').innerText  = `ìì›: ${formatKR(state.resources)}`;
      document.getElementById('coins').innerText  = `ì½”ì¸: ${formatKR(state.coins)}`;
      document.getElementById('ecoins').innerText = `ì´ë²¤íŠ¸ì½”ì¸: ${formatKR(state.eventCoins||0)}`;
      document.getElementById('ship-level').innerText = `${state.shipLevel}ë ™ (${formatKR(state.shipUpgradeCost)}ì½”ì¸)`;
      setShipImage(state.shipLevel);
      const successRate = getShipSuccessRate();
      const rateEl = document.getElementById('ship-success-rate');
      if (rateEl) rateEl.innerText = `${successRate}%`;
      const shipBtn = document.getElementById('upgrade-ship');
      if (shipBtn) shipBtn.disabled = shipEnhanceInProgress || ((state.coins < state.shipUpgradeCost) && !canSpendEC(1));
      const shipStatusEl = document.getElementById('ship-upgrade-status');
      if (shipStatusEl) {
        shipStatusEl.innerText = shipEnhanceMessage;
        shipStatusEl.dataset.tone = shipEnhanceTone;
      }

      const clickUp = document.getElementById('click-upgrade');
      const clickUpEc = document.getElementById('click-upgrade-ec');
      const clickCost = ensureClickUpgradeCost();
      clickUp.innerText = `í´ë¦­ ì—…ê·¸ë ˆì´ë“œ (${formatKR(clickCost)}ì½”ì¸)`;
      clickUp.disabled  = (state.coins < clickCost) && !canSpendEC(1);
      if (clickUpEc) {
        clickUpEc.disabled = !canSpendEC(1);
      }
      document.getElementById('click-power').innerText = Math.round(state.clickPower).toString();

      const autoBtn = document.getElementById('auto-convert-buy');
      if (state.autoConvertBought) {
        const status = state.autoConvertEnabled ? 'ON' : 'OFF';
        autoBtn.innerHTML = `ìë™ë³€í™˜ ${status}`;
        autoBtn.setAttribute('aria-pressed', state.autoConvertEnabled ? 'true' : 'false');
      } else {
        autoBtn.innerHTML = `ìë™ë³€í™˜ êµ¬ë§¤<br>(${formatKR(100)}ì½”ì¸)`;
        autoBtn.removeAttribute('aria-pressed');
      }
      autoBtn.disabled = !state.autoConvertBought && state.coins < 100;

      document.getElementById('convert-button').disabled = state.resources < 10;

      const hireWork = document.getElementById('hire-worker');
      hireWork.innerText = `ì•Œë°” ê³ ìš© (${formatKR(getWorkerCost())}ì½”ì¸)`;
      hireWork.disabled = state.coins < getWorkerCost();
      const hireWorkEc = document.getElementById('hire-worker-ec');
      if (hireWorkEc) {
        hireWorkEc.disabled = !canSpendEC(1);
      }
      const resPerSec = state.workerCount * getWorkerPower() * activeBuffFactor('res') * aggregateTreeMultiplier('res') * aggregateTreeMultiplier('worker');
      document.getElementById('resource-per-sec').innerText = resPerSec.toFixed(1);

      const hireConv = document.getElementById('hire-conversion');
      hireConv.innerText = `ì½”ì¸ ì•Œë°” (${formatKR(getConversionCost())}ì½”ì¸)`;
      hireConv.disabled = state.coins < getConversionCost();
      const hireConvEc = document.getElementById('hire-conversion-ec');
      if (hireConvEc) {
        hireConvEc.disabled = !canSpendEC(1);
      }
      const coinPerSec = state.conversionCount * activeBuffFactor('coin') * aggregateTreeMultiplier('coin') * aggregateTreeMultiplier('worker');
      document.getElementById('coin-per-sec').innerText = coinPerSec.toFixed(1);

      renderChristmasUI();

      renderSecurityBadge();
      tryUnlockDaily();
      renderBuffStatus();
      renderQuestUI();
      updateSpinButtons();

      try {
        if (uid) {
          const cachePick = {
            resources: state.resources,
            coins: state.coins,
            eventCoins: state.eventCoins,
            clickPower: state.clickPower,
            clickUpgradeCost: state.clickUpgradeCost,
            shipLevel: state.shipLevel,
            shipUpgradeCost: state.shipUpgradeCost,
            workerCount: state.workerCount,
            conversionCount: state.conversionCount,
            autoConvertBought: state.autoConvertBought,
            autoConvertEnabled: state.autoConvertEnabled,
            ownedPlanets: state.ownedPlanets
          };
          localStorage.setItem(`gd_cache_${uid}`, JSON.stringify(cachePick));
        }
      } catch {}
    }

    let uiRenderScheduled = false;
    let uiRenderDirty = false;
    function updateUI(forceImmediate = false) {
      if (forceImmediate) {
        uiRenderDirty = false;
        uiRenderScheduled = false;
        renderUIContents();
        return;
      }
      uiRenderDirty = true;
      if (uiRenderScheduled) return;
      uiRenderScheduled = true;
      scheduleUiFrame(() => {
        uiRenderScheduled = false;
        if (!uiRenderDirty) return;
        uiRenderDirty = false;
        renderUIContents();
      });
    }

    function renderPlanets() {
      const planets = [
        {name:'ë‹¬',cost:100,requiredShipLevel:1},
        {name:'ìˆ˜ì„±',cost:500,requiredShipLevel:2},
        {name:'ê¸ˆì„±',cost:2000,requiredShipLevel:3},
        {name:'ì§€êµ¬',cost:10000,requiredShipLevel:4},
        {name:'í™”ì„±',cost:50000,requiredShipLevel:5},
        {name:'ëª©ì„±',cost:250000,requiredShipLevel:6},
        {name:'í† ì„±',cost:1000000,requiredShipLevel:7},
        {name:'ì²œì™•ì„±',cost:5000000,requiredShipLevel:8},
        {name:'í•´ì™•ì„±',cost:20000000,requiredShipLevel:9}
      ];
      const list = document.getElementById('planet-list'); list.innerHTML = '';
      planets.forEach((p, i) => {
        const div = document.createElement('div');
        const owned = state.ownedPlanets && state.ownedPlanets.includes(i);
        const canBuy = state.shipLevel >= p.requiredShipLevel;
        div.style.margin='10px 0';
        div.innerHTML = `<strong>${p.name}</strong> â€” ${formatKR(p.cost)}ì½”ì¸<br>í•„ìš” ë ™: ${p.requiredShipLevel}`;
        const btn = document.createElement('button'); btn.className='general';
        btn.textContent = owned ? 'êµ¬ë§¤ ì™„ë£Œ' : (canBuy ? 'êµ¬ë§¤' : 'ë ™ ë¶€ì¡±'); btn.disabled = owned || !canBuy;
        btn.onclick = async () => {
          if (!ensureReady()) return;
          if (state.coins >= p.cost) {
            state.coins -= p.cost;
            auditSpend('coin', p.cost);
            if (!state.ownedPlanets) state.ownedPlanets = [];
            state.ownedPlanets.push(i);
            applyQuestProgress('planet', 1);
            save(); updateUI(); renderPlanets();
            if (p.name === 'í™”ì„±' && !rankingUnlocked) {
              rankingUnlocked = true;
              if (uid && userBasePath) {
                try {
                  await update(ref(db, `${userBasePath}/meta`), { rankingUnlocked: true });
                } catch{}
              }
              showToast('ğŸ† ë­í‚¹ ì ê¸ˆ í•´ì œ!', 'ë°”ë¡œ ê°€ê¸°', ()=>{
                if (!requireLoginForFeature()) return;
                location.href='/ranking.html';
              });
            }
            if (state.ownedPlanets.length === planets.length) window.location.href = '/ending.html';
          }
        };
        div.appendChild(btn); list.appendChild(div);
      });
    }

    const oreParticlePool = [];
    const ORE_PARTICLES_PER_CLICK = 8;
    const ORE_PARTICLE_POOL_LIMIT = 120;
    let activeOreParticles = 0;

    function createOreParticle() {
      const frag = document.createElement('img');
      frag.src = '/images/ore.png';
      frag.alt = '';
      frag.className = 'ore-frag';
      frag.addEventListener('animationend', () => {
        frag.remove();
        activeOreParticles = Math.max(0, activeOreParticles - 1);
        if (oreParticlePool.length < ORE_PARTICLE_POOL_LIMIT) {
          oreParticlePool.push(frag);
        }
      });
      return frag;
    }

    function spawnParticles(x,y) {
      const container = document.getElementById('ore-container');
      if (!container) return;
      const available = Math.max(0, ORE_PARTICLE_POOL_LIMIT - activeOreParticles);
      const count = Math.min(ORE_PARTICLES_PER_CLICK, available);
      for (let i = 0; i < count; i++){
        const frag = oreParticlePool.pop() || createOreParticle();
        const dx = (Math.random() - 0.5) * 220;
        const dy = (Math.random() - 0.5) * 200;
        const startScale = 0.45 + Math.random() * 0.25;
        const endScale = startScale * (0.35 + Math.random() * 0.25);
        const startRot = (Math.random() - 0.5) * 20;
        const rot = (Math.random() - 0.5) * 260;
        frag.style.setProperty('--dx', `${dx}px`);
        frag.style.setProperty('--dy', `${dy}px`);
        frag.style.setProperty('--start-scale', startScale.toFixed(2));
        frag.style.setProperty('--end-scale', endScale.toFixed(2));
        frag.style.setProperty('--start-rot', `${startRot.toFixed(2)}deg`);
        frag.style.setProperty('--rot', `${rot.toFixed(2)}deg`);
        frag.style.left = x+'px';
        frag.style.top = y+'px';
        frag.style.animation = 'none';
        // restart animation (force reflow)
        void frag.offsetWidth;
        frag.style.animation = '';
        container.appendChild(frag);
        activeOreParticles++;
      }
    }

    function ensureReady() {
      if (!window.__PLAY_ALLOWED) { showAuthStatus('PCì—ì„œëŠ” íŒì—…ìœ¼ë¡œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. íŒì—…ìœ¼ë¡œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.'); return false; }
      if (!uid && !guestMode) { showAuthStatus('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'); return false; }
      if (!guestMode && isInitialSync) { showAuthStatus('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'); return false; }
      if (!guestMode && !security.tosAccepted){ showTosOverlay(true); showAuthStatus('ì´ìš©ì•½ê´€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.', true); return false; }
      if (!guestMode && security.banned){ showBanOverlay(true); showAuthStatus('ì´ìš©ì•½ê´€ ìœ„ë°˜ ì˜ì‹¬(ê³„ì • ì •ì§€)ìœ¼ë¡œ í”Œë ˆì´ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.', true); return false; }
      showAuthStatus(''); return true;
    }

    (function prepareHardShutdown(){
      if (typeof window.__HARD_SHUTDOWN_GAME === 'function') return;
      let applied = false;
      const disableInteractiveAreas = () => {
        const selectors = [
          '#container button', '#container a', '#container input', '#container select', '#container textarea',
          '#container [role="button"]', '#top-bar button', '#top-bar a', '#top-bar [role="button"]'
        ];
        try {
          document.querySelectorAll(selectors.join(',')).forEach((el) => {
            try {
              if ('disabled' in el) el.disabled = true;
              el.classList.add('hard-block-disabled');
              el.setAttribute('aria-disabled', 'true');
            } catch {}
          });
        } catch {}
      };
      window.__HARD_SHUTDOWN_GAME = (info) => {
        if (applied) return;
        applied = true;
        try { window.__PLAY_ALLOWED = false; } catch {}
        try { window.__PLAY_BASE_ALLOWED = false; } catch {}
        try {
          if (window.__gameTimer) {
            clearInterval(window.__gameTimer);
            window.__gameTimer = null;
          }
        } catch {}
        disableInteractiveAreas();
        try { document.body.classList.add('game-hard-blocked'); } catch {}
        try {
          const msg = info?.message || 'ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‹¤í–‰ì´ ê°ì§€ë˜ì–´ í˜„ì¬ ì°½ì˜ ë™ì‘ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.';
          showAuthStatus(msg, true);
        } catch {}
      };
    })();

    function wireGame() {
      document.getElementById('ore').addEventListener('click', e => {
        if (!window.__PLAY_ALLOWED) return;
        if (!guestMode && (!uid || isInitialSync)) return;
        if (security.banned){ showBanOverlay(true); return; }

        if (!ensureReady()) return;
        const rect = e.target.getBoundingClientRect();
        spawnParticles(e.clientX - rect.left, e.clientY - rect.top);
        const resMul = activeBuffFactor('res') * aggregateTreeMultiplier('res');
        const clickMul = aggregateTreeMultiplier('click');
        const perkResMul = perkState.resourceMult || 1;
        const inc = state.clickPower * resMul * perkResMul * clickMul;
        state.resources += inc;
        auditAdd('res', inc);
        playSfx('sfx-pickaxe');
        if (state.autoConvertBought && state.autoConvertEnabled) convertResources(null, 'auto');
        save(); updateUI();
      });
      attachHoldRepeat('convert-button', () => {
        if (!ensureReady()) return false;
        if (!convertResources(1, 'manual')) return false;
        save(); updateUI();
        return true;
      });
      document.getElementById('auto-convert-buy').addEventListener('click', () => {
        if (!ensureReady()) return;
        if (!state.autoConvertBought) {
          if (state.coins < 100) return;
          state.coins -= 100;
          auditSpend('coin', 100);
          state.autoConvertBought = true;
          state.autoConvertEnabled = true;
        } else {
          state.autoConvertEnabled = !state.autoConvertEnabled;
        }
        save(); updateUI();
      });

      const christmasOverlay = document.getElementById('christmas-overlay');
      const christmasFrame = document.getElementById('christmas-frame');
      const christmasStartBtn = document.getElementById('christmas-start');
      const christmasCloseBtn = document.getElementById('christmas-close');

      function openChristmasOverlay() {
        if (!christmasOverlay || !christmasFrame) return;
        const src = christmasFrame.dataset.src;
        if (src && (!christmasFrame.src || christmasFrame.src === 'about:blank')) {
          christmasFrame.src = src;
        }
        christmasOverlay.classList.add('show');
        christmasOverlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      function closeChristmasOverlay() {
        if (!christmasOverlay || !christmasFrame) return;
        christmasOverlay.classList.remove('show');
        christmasOverlay.setAttribute('aria-hidden', 'true');
        christmasFrame.src = 'about:blank';
        document.body.style.overflow = '';
      }

      christmasStartBtn?.addEventListener('click', () => {
        if (!ensureReady()) return;
        openChristmasOverlay();
      });

      christmasCloseBtn?.addEventListener('click', () => {
        closeChristmasOverlay();
      });

      document.getElementById('craft-santa-coin')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        if ((state.santaPieces || 0) < 10) {
          showToast('ì‚°íƒ€ ì¡°ê°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¦¬ë“¬ê²Œì„ì„ í”Œë ˆì´í•´ ë³´ì„¸ìš”!', null, null, 2600);
          return;
        }
        state.santaPieces -= 10;
        state.santaCoins = (state.santaCoins || 0) + 1;
        showToast('ğŸ… ì‚°íƒ€ ì´ë²¤íŠ¸ì½”ì¸ 1ê°œë¥¼ ì œì‘í–ˆìŠµë‹ˆë‹¤!', null, null, 2400);
        save(); updateUI();
      });

      document.getElementById('convert-ecoin-to-santacoin')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        if (!canSpendEC(3)) {
          showToast('ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', null, null, 2400);
          return;
        }
        state.eventCoins -= 3;
        state.santaCoins = (state.santaCoins || 0) + 1;
        auditSpend('eco', 3);
        showToast('ì´ë²¤íŠ¸ì½”ì¸ 3ê°œë¥¼ ì‚°íƒ€ ì´ë²¤íŠ¸ì½”ì¸ 1ê°œë¡œ êµí™˜í–ˆì–´ìš”.', null, null, 2400);
        save(); updateUI();
      });

      document.getElementById('christmas-upgrade')?.addEventListener('click', () => {
        if (!ensureReady()) return;
        const lv = Math.max(0, state.christmasTreeLevel || 0);
        const next = christmasTreeRewards[lv];
        if (!next) {
          showToast('ìµœëŒ€ íŠ¸ë¦¬ ë ˆë²¨ì…ë‹ˆë‹¤!', null, null, 2200);
          return;
        }
        if ((state.santaCoins || 0) < next.cost) {
          showToast('ì‚°íƒ€ ì´ë²¤íŠ¸ì½”ì¸ì´ ë¶€ì¡±í•´ìš”.', null, null, 2400);
          return;
        }
        state.santaCoins -= next.cost;
        state.christmasTreeLevel = lv + 1;
        showToast(`íŠ¸ë¦¬ Lv.${lv + 1} ë‹¬ì„±! ${next.reward}`, null, null, 3200);
        renderBuffStatus();
        save(); updateUI();
      });
      attachHoldRepeat('hire-worker', () => {
        if (!ensureReady()) return false;
        const cost = getWorkerCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          hireWorkersBulk(1);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-worker-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        hireWorkersBulk(10);
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-conversion', () => {
        if (!ensureReady()) return false;
        const cost = getConversionCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          hireConversionsBulk(1);
        } else if (canSpendEC(1)) {
          state.eventCoins -= 1;
          auditSpend('eco', 1);
          hireConversionsBulk(10);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('hire-conversion-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        hireConversionsBulk(10);
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('upgrade-ship', () => {
        if (!ensureReady()) return false;

        if (shipEnhanceInProgress) return false;

        const cost = state.shipUpgradeCost;
        let paidWith = null;
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          paidWith = 'coin';
        } else if (canSpendEC(1)) {
          state.eventCoins -= 1;
          auditSpend('eco', 1);
          paidWith = 'eco';
        } else {
          return false;
        }

        const chance = getShipSuccessRate();
        const shipPanel = document.querySelector('.ship-panel');
        shipEnhanceInProgress = true;
        shipPanel?.classList.add('enhancing');
        setShipEnhanceStatus(`ë‘êµ¬ë‘êµ¬... ê°•í™” ì¤€ë¹„ ì¤‘! (ì„±ê³µ í™•ë¥  ${chance}%)`, 'info');
        playSfx('sfx-start');
        updateUI();

        setTimeout(() => {
          const success = Math.random() * 100 < chance;
          shipPanel?.classList.remove('enhancing');

          if (success) {
            state.shipLevel++;
            state.shipUpgradeCost = Math.floor(state.shipUpgradeCost * 2 + 30);
            applyQuestProgress('ship', 1);
            playSfx('sfx-win');
            shipPanel?.classList.add('success-glow');
            setTimeout(() => shipPanel?.classList.remove('success-glow'), 820);
            setShipEnhanceStatus(`ì„±ê³µ! ìš°ì£¼ì„  ${state.shipLevel}ë ™ ë‹¬ì„± (ë„ì „ í™•ë¥  ${chance}%)`, 'success');
          } else {
            shipPanel?.classList.add('fail-shake');
            setTimeout(() => shipPanel?.classList.remove('fail-shake'), 720);
            const payment = paidWith === 'eco' ? 'ì´ë²¤íŠ¸ì½”ì¸ 1ê°œ' : `${formatKR(cost)}ì½”ì¸`;
            setShipEnhanceStatus(`ì‹¤íŒ¨... ${payment}ì´(ê°€) ì†Œëª¨ëìŠµë‹ˆë‹¤. í™•ë¥ ì€ ìœ ì§€ë¼ìš”! (ì„±ê³µ í™•ë¥  ${chance}%)`, 'warn');
          }

          shipEnhanceInProgress = false;
          save(); updateUI(); renderPlanets();
        }, 1100);

        return false;
      });

      attachHoldRepeat('click-upgrade', () => {
        if (!ensureReady()) return false;
        const cost = ensureClickUpgradeCost();
        if (state.coins >= cost) {
          state.coins -= cost;
          auditSpend('coin', cost);
          applyClickUpgrades(1);
        } else if (canSpendEC(1)) {
          state.eventCoins -= 1;
          auditSpend('eco', 1);
          applyClickUpgrades(10);
        } else {
          return false;
        }
        save(); updateUI();
        return true;
      });
      attachHoldRepeat('click-upgrade-ec', () => {
        if (!ensureReady()) return false;
        if (!canSpendEC(1)) return false;
        state.eventCoins -= 1;
        auditSpend('eco', 1);
        applyClickUpgrades(10);
        save(); updateUI();
        return true;
      });

      document.querySelectorAll('#bottom-nav .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tab.dataset.tab + '-content').classList.add('active');
        document.querySelectorAll('#bottom-nav .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }));

      // ë²„í”„ ë²„íŠ¼ ì˜¤í”ˆ
      const buffBtn = document.getElementById('buff-btn');
      const buffOv  = document.getElementById('buff-overlay');
      const buffClose = document.getElementById('buff-close');
      if (buffBtn && buffOv) {
        buffBtn.addEventListener('click', ()=>{
          renderBuffStatus();
          buffOv.classList.add('show');
          buffOv.setAttribute('aria-hidden','false');
        });
      }
      if (buffClose && buffOv) {
        const closeBuffOverlay = () => {
          buffOv.classList.remove('show');
          buffOv.setAttribute('aria-hidden','true');
        };

        const openAdminFromBuff = () => {
          let opened = false;
          if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.openAdminPanel === 'function') {
            try {
              window.__SESSION_LOCK__.openAdminPanel({ message: 'ê´€ë¦¬ì ì¸ì¦ í›„ ê°œë°œì ë„êµ¬ ì ê¸ˆì„ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' });
              opened = true;
            } catch (err) {
              console.warn('ê´€ë¦¬ì ì¸ì¦ íŒ¨ë„ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', err);
            }
          }
          return opened;
        };

        let adminHoldTimer = null;
        let adminHoldTriggered = false;
        let suppressCloseClick = false;

        const startAdminHold = () => {
          if (adminHoldTimer) {
            clearTimeout(adminHoldTimer);
            adminHoldTimer = null;
          }
          adminHoldTriggered = false;
          adminHoldTimer = setTimeout(() => {
            adminHoldTimer = null;
            if (openAdminFromBuff()) {
              adminHoldTriggered = true;
              suppressCloseClick = true;
            }
          }, 20000);
        };

        const cancelAdminHold = () => {
          if (adminHoldTimer) {
            clearTimeout(adminHoldTimer);
            adminHoldTimer = null;
          }
          const wasTriggered = adminHoldTriggered;
          adminHoldTriggered = false;
          return wasTriggered;
        };

        const finishAdminHold = (event) => {
          if (cancelAdminHold()) {
            event.preventDefault();
            event.stopPropagation();
          }
        };

        buffClose.addEventListener('mousedown', startAdminHold);
        buffClose.addEventListener('touchstart', startAdminHold, { passive: true });
        ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach((type) => {
          buffClose.addEventListener(type, finishAdminHold);
        });

        buffClose.addEventListener('click', (event) => {
          if (suppressCloseClick) {
            event.preventDefault();
            event.stopPropagation();
            suppressCloseClick = false;
            return;
          }
          cancelAdminHold();
          closeBuffOverlay();
        });
      }

      // ë©”ì¸ ë£¨í”„ (ë¦¬ì†ŒìŠ¤ ë° UI ê°±ì‹  ì „ìš©)
      window.__gameTimer = setInterval(() => {
        if (!guestMode && (!uid || isInitialSync)) return;

        if (window.__PLAY_ALLOWED && !security.banned) {
          const offline = isOffline();
          pruneExpiredBuffs();

          // ìì› ì•Œë°”
          const prodMul = perkState.productionMult || 1;
          const perkResMul = perkState.resourceMult || 1;
          const perkCoinMul = perkState.coinMult || 1;

          let workerGain = state.workerCount * getWorkerPower() * activeBuffFactor('res') * aggregateTreeMultiplier('res') * aggregateTreeMultiplier('worker');
          if (state.workerCount > 0) {
            const finalWorkerGain = workerGain * prodMul * perkResMul;
            state.resources += finalWorkerGain;
            auditAdd('res', finalWorkerGain);
          }

          // ì½”ì¸ ì•Œë°”
          let convGain = state.conversionCount * activeBuffFactor('coin') * aggregateTreeMultiplier('coin') * aggregateTreeMultiplier('worker');
          if (!offline && state.conversionCount > 0) {
            const finalConvGain = convGain * prodMul * perkCoinMul;
            state.coins += finalConvGain;
            auditAdd('coin', finalConvGain, 'worker');
          }

          // ìë™ ë³€í™˜
          if (!offline && state.autoConvertBought && state.autoConvertEnabled) convertResources(null, 'auto');
        }

        // âœ… ì˜ì‹¬ë„ ê²€ì‚¬ëŠ” 1ì´ˆë§ˆë‹¤ ë³„ë„ë¡œ ìœ ì§€
        auditCheck();

        if (window.__PLAY_ALLOWED) {
          updateUI();
        }
      }, 1000);

      // ë³´ì•ˆ/ìƒíƒœ ì €ì¥ì€ 5ì´ˆ ì£¼ê¸°ë¡œ ë¶„ë¦¬í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ì™„í™”
      window.__saveTimer = setInterval(async () => {
        if (!guestMode && (!uid || isInitialSync)) return;
        await saveSecurity();
        if (window.__PLAY_ALLOWED) {
          save();
        }
      }, 5000);
    }

    window.addEventListener('message', (event) => {
      if (event.origin && event.origin !== window.location.origin) return;
      const data = event.data || {};
      if (data.type === 'christmas-clear' && data.pieces) {
        const gain = Math.max(0, Math.floor(data.pieces));
        state.santaPieces = (state.santaPieces || 0) + gain;
        const crafted = autoCraftSantaCoins();
        renderBuffStatus();
        save(); updateUI();
        const craftedMsg = crafted > 0 ? ` (+ì‚°íƒ€ì½”ì¸ ${crafted}ê°œ ì œì‘)` : '';
        showToast(`ğŸ… ì‚°íƒ€ ì¡°ê° ${gain}ê°œ íšë“!${craftedMsg}`, null, null, 3200);
      }
    });

    /* ======================
       ì¸ì¦/ë¶€íŒ… íë¦„
       ====================== */
    const tabLogin  = document.getElementById('auth-tab-login');
    const tabSignup = document.getElementById('auth-tab-signup');
    const signupExtra = document.getElementById('signup-extra');
    const loginBtn  = document.getElementById('login-btn');
    const signupBtnEl = document.getElementById('signup-btn');
    const guestStartBtn = document.getElementById('guest-start-btn');
    const guestLoginBtn = document.getElementById('guest-login-btn');
    const tosCheckbox = document.getElementById('tos-checkbox');
    const privacyCheckbox = document.getElementById('privacy-checkbox');
    const verifyInfoEl = document.getElementById('verify-info');

    function updateSignupAvailability() {
      if (!signupBtnEl) return;
      const allow = !!tosCheckbox?.checked && !!privacyCheckbox?.checked;
      signupBtnEl.disabled = !allow;
    }

    let currentAuthMode = 'login';
    function setAuthMode(mode) {
      currentAuthMode = (mode === 'signup') ? 'signup' : 'login';
      if (mode === 'signup') {
        tabLogin.classList.remove('active'); tabSignup.classList.add('active');
        signupExtra.style.display = 'block'; loginBtn.style.display='none'; signupBtnEl.style.display='block';
        signupBtnEl.textContent = 'íšŒì›ê°€ì…';
      } else {
        tabLogin.classList.add('active'); tabSignup.classList.remove('active');
        signupExtra.style.display = 'none'; loginBtn.style.display='block'; signupBtnEl.style.display='none';
        signupBtnEl.disabled = false;
      }
      showAuthStatus('');
      if (verifyInfoEl) {
        verifyInfoEl.textContent = '';
        verifyInfoEl.classList.remove('show');
      }
      try { history.replaceState(null, '', (currentAuthMode === 'signup' ? '/signup' : '/login') + (location.hash || '')); } catch {}
      updateSignupAvailability();
    }

    const LOGIN_PROMPT_MESSAGE = 'ë­í‚¹ì´ë‘ ìš°í¸í•¨ë“± ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ëŠ” ë¡œê·¸ì¸í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤! ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    const GUEST_OVERWRITE_PROMPT = 'ì´ ê¸°ê¸°ì— ì €ì¥ëœ ê²ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ë©´ ê³„ì • ë°ì´í„°ì— ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? í™•ì¸ì„ ëˆ„ë¥´ë©´ ë®ì–´ì“°ê¸°, ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.';

    function showLoginScreen() {
      hideAllOverlays();
      authContainer.style.display = 'block';
      authContainer.classList.remove('hidden');
      ['top-bar','container'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.visibility = 'hidden';
      });
      setAuthMode('login');
      showAuthStatus('');
      refreshGuestButton();
      updateGuestUiState();
    }

    function requireLoginForFeature() {
      if (uid) return true;
      if (guestMode) {
        const wantsLogin = confirm(LOGIN_PROMPT_MESSAGE);
        if (wantsLogin) {
          try { persistGuestProfile(); } catch {}
          guestAutoStartSuppressed = true;
          guestMode = false;
          updateGuestUiState();
          showLoginScreen();
        }
        return false;
      }
      showAuthStatus('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.');
      return false;
    }
    window.requireLoginForFeature = requireLoginForFeature;

    tabLogin.addEventListener('click',  () => { hideAllOverlays(); setAuthMode('login');  showAuthStatus(''); });
    tabSignup.addEventListener('click', () => { hideAllOverlays(); setAuthMode('signup'); showAuthStatus(''); });

    guestStartBtn?.addEventListener('click', () => {
      startGuestMode();
    });

    guestLoginBtn?.addEventListener('click', () => {
      if (guestMode) {
        try { persistGuestProfile(); } catch {}
      }
      guestAutoStartSuppressed = true;
      guestMode = false;
      updateGuestUiState();
      showLoginScreen();
    });

    document.getElementById('settings-btn').addEventListener('click', () => {
      try { history.replaceState(null, '', '/ì„¤ì •' + (location.hash || '')); } catch {}
      location.href = '/setting.html';
    });

    function handleAuthError(err) {
      const code = err?.code || '';
      if (code === 'auth/user-disabled') {
        security.banned = true;
        securityDirty = true;
        showAuthStatus('â›” ì´ìš©ì•½ê´€ ìœ„ë°˜ìœ¼ë¡œ ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤íƒìœ¼ë¡œ ì˜ì‹¬ë˜ë©´ appeals@siustudio.me ë¡œ ë©”ì¼ì„ ë³´ë‚´ ì£¼ì„¸ìš”.', true);
        try { saveSupportCtx({ banned: true }); } catch {}
        return true;
      }
      return false;
    }

    loginBtn.addEventListener('click', async () => {
      showAuthStatus('');
      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { showAuthStatus('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const isPasswordProvider = user && user.providerData.some(p=>p.providerId==='password');

        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆì–´ìš”. ë°›ì€ ë©”ì¼ì˜ ë§í¬ë¡œ ì¸ì¦í•œ ë’¤ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', true);
          try { await auth.signOut(); } catch {}
          return;
        }
      } catch (err) {
        if (!handleAuthError(err)) {
          const code = (err && err.code) || '';
          const msg =
            (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials')
              ? 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
            code === 'auth/user-not-found'         ? 'ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ë¨¼ì € ì§„í–‰í•˜ì„¸ìš”.' :
            code === 'auth/invalid-email'          ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
            code === 'auth/network-request-failed' ? 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' :
            'ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”';
          showAuthStatus(msg);
        }
        guestTransferPreference = 'none';
      }
    });

    async function handleSignup() {
      showAuthStatus('');
      if (verifyInfoEl) {
        verifyInfoEl.textContent = '';
        verifyInfoEl.classList.remove('show');
      }

      const email = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      const pw2 = document.getElementById('password-confirm').value;
      const agreeTerms = document.getElementById('tos-checkbox')?.checked;
      const agreePrivacy = document.getElementById('privacy-checkbox')?.checked;

      if (!email) { showAuthStatus('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if (!pw || !pw2) { showAuthStatus('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if (pw !== pw2) { showAuthStatus('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      if (!agreeTerms || !agreePrivacy) {
        showAuthStatus('ì´ìš©ì•½ê´€ê³¼ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ëª¨ë‘ ë™ì˜í•´ì•¼ íšŒì›ê°€ì… ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }

      signupBtnEl.disabled = true;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        try { await sendEmailVerification(cred.user); } catch {}
        showAuthStatus('');
        if (verifyInfoEl) {
          verifyInfoEl.textContent = 'âœ… ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ë¡œ ì „ì†¡ëœ ì¸ì¦ ë§í¬ë¥¼ í™•ì¸í•œ í›„ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
          verifyInfoEl.classList.add('show');
        }
        try { await auth.signOut(); } catch {}
        setAuthMode('login');
      } catch (err) {
        const code = err?.code || '';
        const msg =
          code === 'auth/email-already-in-use' ? 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.' :
          code === 'auth/invalid-email' ? 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
          code === 'auth/weak-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.' :
          code === 'auth/network-request-failed' ? 'ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' :
          'íšŒì›ê°€ì… ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
        showAuthStatus(msg);
        guestTransferPreference = 'none';
      } finally {
        updateSignupAvailability();
      }
    }

    signupBtnEl?.addEventListener('click', async (e) => {
      e.preventDefault();
      await handleSignup();
    });

    tosCheckbox?.addEventListener('change', updateSignupAvailability);
    privacyCheckbox?.addEventListener('change', updateSignupAvailability);
    updateSignupAvailability();
    refreshGuestButton();
    updateGuestUiState();

    // TOS ë™ì˜
    const tosAgree = document.getElementById('tos-agree');
    const tosAccept = document.getElementById('tos-accept');
    tosAgree?.addEventListener('change', ()=>{ tosAccept.disabled = !tosAgree.checked; });
    tosAccept?.addEventListener('click', async ()=>{
      security.tosAccepted = true; securityDirty = true;
      if (uid) markLocalTosAccepted(uid);
      await saveSecurity();
      showTosOverlay(false);
      showToast('âœ… ì´ìš©ì•½ê´€ì— ë™ì˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê³µì •í•œ í”Œë ˆì´ë¥¼ ë¶€íƒë“œë ¤ìš”!', null, null, 3500);
    });

    // ì •ì§€ ì˜¤ë²„ë ˆì´ ë²„íŠ¼ë“¤
    document.getElementById('ban-ok')?.addEventListener('click', ()=> showBanOverlay(false));
    document.getElementById('ban-appeal-email')?.addEventListener('click', ()=>{
      const { mailto } = buildSupportMail();
      location.href = mailto;
    });
    document.getElementById('ban-copy-info')?.addEventListener('click', copySupportInfo);

    // ì •ê¸° í† í° í™•ì¸
    setInterval(async () => {
      try {
        if (auth?.currentUser) {
          await auth.currentUser.getIdToken(true);
        }
      } catch (err) {
        if (handleAuthError(err)) {
          try { await auth.signOut(); } catch {}
        }
      }
    }, 30000);

    // ë°ì´í„° ë°”ì¸ë”©
    async function proceedWithDataBinding(){
      if (mailboxUnsubscribe) { try { mailboxUnsubscribe(); } catch {} mailboxUnsubscribe = null; }
      mailboxCache = [];
      selectedMailId = null;
      renderMailList();
      renderMailDetail(null);
      updateMailBadges();
      mailboxRef = ref(db, `${userBasePath}/mailbox`);
      mailboxUnsubscribe = onValue(mailboxRef, snap => {
        const raw = snap.exists() ? snap.val() : {};
        const entries = Object.entries(raw || {}).map(([id, mail]) => ({ id, ...(mail || {}) }));
        entries.sort((a, b) => (b.sentAt || 0) - (a.sentAt || 0));
        mailboxCache = entries;
        if (selectedMailId && !mailboxCache.some(m => m.id === selectedMailId)) {
          selectedMailId = null;
        }
        renderMailList();
        const current = selectedMailId ? mailboxCache.find(m => m.id === selectedMailId) : null;
        renderMailDetail(current || null);
        updateMailBadges();
      });
      updateMailComposeVisibility(auth.currentUser || null);

      try {
        const rankSnap = await get(ref(db, `${userBasePath}/meta/rankingUnlocked`));
        rankingUnlocked = !!(rankSnap.exists() ? rankSnap.val() : false);
      } catch { rankingUnlocked = false; }

      dataRef = ref(db, `${userBasePath}/gameData`);
      const shouldApplyGuest = guestTransferPreference === 'overwrite' && hasGuestProfile();
      const guestProfile = shouldApplyGuest ? readGuestProfile() : null;
      isInitialSync = true;
      try {
        const saved = localStorage.getItem(`lastWrite_${uid}`);
        localLastWrite = saved ? parseInt(saved, 10) : 0;
      } catch { localLastWrite = 0; }

      await ensureInitialData(dataRef);
      await loadSecurity();

      saveSupportCtx({ banned: false });

      if (shouldApplyGuest && guestProfile && guestProfile.state) {
        try {
          const now = Date.now();
          const merged = withAutoConvertDefaults(guestProfile.state || {});
          merged._lastUpdated = now;
          await update(dataRef, { ...merged });
          localLastWrite = now;
          try { localStorage.setItem(`lastWrite_${uid}`, String(now)); } catch {}
          try { localStorage.setItem(`gd_cache_${uid}`, JSON.stringify(merged)); } catch {}
          if (guestProfile.rankingUnlocked && uid && userBasePath) {
            try { await update(ref(db), { [`${userBasePath}/meta/rankingUnlocked`]: true }); }
            catch {}
            rankingUnlocked = true;
          }
        } catch (err) {
          console.error('guest data merge failed', err);
        }
        guestTransferPreference = 'none';
      } else {
        guestTransferPreference = 'none';
      }

      if (pendingGuestCleanup) {
        clearGuestProfile();
        refreshGuestButton();
        pendingGuestRemovalNotice = true;
        pendingGuestCleanup = false;
      }

      const syncStart = Date.now();
      initialSyncStart = syncStart;

      dataUnsubscribe = onValue(dataRef, async snap => {
        const server = snap.exists() ? snap.val() : null;
        const rawStamp = Number(server?._lastUpdated);
        const serverStamp = Number.isFinite(rawStamp) ? rawStamp : 0;
        const loadTime = Date.now() - syncStart;

        // ì´ì „ ì½”ë“œì—ì„œ ì—¬ê¸°ì„œ auditFreeze(...) í•˜ë˜ ê±° ì „ë¶€ ì œê±°
        if (loadTime > 3000 && !networkUnstableShown) {
          networkUnstableShown = true;
        }

        if (isInitialSync) {
          state = withAutoConvertDefaults(server);

          // ì´ ë¶€ë¶„ë„ ì´ì œ freeze ì•ˆ í•¨
          await fetchDaily();

          if (window.__PLAY_ALLOWED) { updateUI(true); renderPlanets(); }
          isInitialSync = false;
          showGameUI();

          try { localStorage.setItem('boot_seen', '1'); } catch {}

          window.notifyAuthSuccessAndExit && window.notifyAuthSuccessAndExit();
          await checkDailyAndMaybeShow();
          updateAttendanceLabels();
          bootDone = true;
          lastSyncedServerStamp = serverStamp || 0;
          auditInit();
          renderSecurityBadge();
          maybeNotifyGuestRemoval();

          if (!security.tosAccepted){ showTosOverlay(true); }
          if (security.banned){ showBanOverlay(true); }
          return;
        }

        if (!server) {
          state = withAutoConvertDefaults();
        } else {
          const serverLast = serverStamp;
          if (serverLast >= (localLastWrite || 0)) {
            state = withAutoConvertDefaults(server);
          } else {
            state = withAutoConvertDefaults({ ...server, ...state });
            try { if (JSON.stringify(server) !== JSON.stringify(state)) save(true); }
            catch { save(true); }
          }
        }
        const prevSynced = lastSyncedServerStamp || 0;
        const isNewServerState = serverStamp && serverStamp !== prevSynced;
        const remoteMutation = isNewServerState && serverStamp > (localLastWrite || 0);
        if (window.__PLAY_ALLOWED) { updateUI(true); renderPlanets(); }
        if (remoteMutation) {
          auditInit();
          auditIntent = { res:0, coin:0, eco:0, until:0 };
          localLastWrite = serverStamp;
          try { localStorage.setItem(`lastWrite_${uid}`, String(serverStamp)); } catch {}
        }
        lastSyncedServerStamp = serverStamp || prevSynced;
      });
    }

    onAuthStateChanged(auth, async user => {
      sessionLogger?.log?.(user
        ? `ì¸ì¦ ìƒíƒœ ì—…ë°ì´íŠ¸: ${(user.email || user.uid || 'unknown')}`
        : 'ì¸ì¦ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      hideAllOverlays();
      setBootVisible(false);
      showAuthStatus('');
      if (dataUnsubscribe) { try{ dataUnsubscribe(); }catch{} dataUnsubscribe=null; }
      if (mailboxUnsubscribe) { try{ mailboxUnsubscribe(); }catch{} mailboxUnsubscribe=null; }
      subscribePickaxePerk(null, null);
      mailboxRef = null;
      mailboxCache = [];
      selectedMailId = null;
      renderMailList();
      renderMailDetail(null);
      updateMailBadges();
      closeMailOverlay();
      updateMailComposeVisibility(null);

      if (user) {
        guestMode = false;
        guestAutoStartSuppressed = false;
        clearSupportCtx();
        hideAllOverlays();
        security.banned = false;
        updateGuestUiState();

        if (hasGuestProfile()) {
          pendingGuestCleanup = true;
        }

        const isPasswordProvider = (user.providerData || []).some(p => p.providerId === 'password');
        if (isPasswordProvider && !user.emailVerified) {
          try { await sendEmailVerification(user); } catch {}
          showAuthStatus('ğŸ“§ ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆì–´ìš”. ë°›ì€ ë©”ì¼ì˜ ë§í¬ë¡œ ì¸ì¦í•œ ë’¤ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', true);
          try { await auth.signOut(); } catch {}
          return;
        }

        uid = user.uid;
        window.__CURRENT_USER_EMAIL = user.email || '';
        try {
          window.__DEVTOOL_GUARD?.onAuthEmailChange?.(window.__CURRENT_USER_EMAIL);
        } catch {}
        window.__CURRENT_USER_UID = uid;
        if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.activate === 'function') {
          try { window.__SESSION_LOCK__.activate(uid); }
          catch (err) { console.warn('ì„¸ì…˜ ì ê¸ˆ í™œì„±í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', err); }
        }
        loadBuffs();
        renderBuffStatus();
        updateMailComposeVisibility(user);

        try {
          const cacheRaw = localStorage.getItem(`gd_cache_${uid}`);
          if (cacheRaw) {
            const cached = JSON.parse(cacheRaw);
            state = withAutoConvertDefaults({ ...state, ...cached });
            showGameUI();
            updateUI();
            renderPlanets();
            bootDone = true;
            maybeNotifyGuestRemoval();
          }
        } catch {}

        let plan = null;
        try {
          plan = await planMigrationForUser(user);
        } catch(e){
          console.error('planMigration error', e);
          const fallbackServer = await allocateServerForUser();
          userServerKey = fallbackServer;
          userIdKey     = makeIdKeyFromUser(user);
          userBasePath  = `users/${userServerKey}/${userIdKey}`;
          subscribePickaxePerk(userServerKey, userIdKey);
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: 'plan-error-fallback'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
          return;
        }
        userServerKey = plan.server;
        userIdKey     = makeIdKeyFromUser(user);
        userBasePath  = `users/${userServerKey}/${userIdKey}`;
        subscribePickaxePerk(userServerKey, userIdKey);

        saveSupportCtx({ banned: false });

        if (plan.need) {
          showMigrateOverlay(true, 'ëŒ€ê¸° ì¤‘â€¦');
          disableMigrateStart(false);
          const startBtn = document.getElementById('migrate-start');
          if (startBtn){
            startBtn.onclick = async ()=>{
              disableMigrateStart(true);
              try{
                await performMigration(plan.srcBasePath, plan.destBasePath, user);
                try {
                  await update(ref(db), {
                    [`userServerMap/${uid}`]: {
                      server: userServerKey,
                      id: userIdKey,
                      displayId: String(user?.email||'') || null,
                      migratedAt: Date.now(),
                      reason: plan.reason
                    }
                  });
                } catch {}
                saveSupportCtx({ banned: false });
                setTimeout(()=>{ showMigrateOverlay(false); proceedWithDataBinding(); }, 600);
              }catch(e){
                console.error('migration failed', e);
                setMigrateProgress('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                disableMigrateStart(false);
              }
            };
          }
        } else {
          try {
            await update(ref(db), {
              [`userServerMap/${uid}`]: {
                server: userServerKey,
                id: userIdKey,
                displayId: String(user?.email||'') || null,
                assignedAt: Date.now(),
                reason: plan.reason || 'auto-assign'
              }
            });
          } catch {}
          saveSupportCtx({ banned: false });
          await proceedWithDataBinding();
        }

      } else {
        window.__CURRENT_USER_UID = null;
        window.__CURRENT_USER_EMAIL = '';
        try {
          window.__DEVTOOL_GUARD?.resetBypass?.();
          window.__DEVTOOL_GUARD?.onAuthEmailChange?.('');
        } catch {}
        if (window.__SESSION_LOCK__ && typeof window.__SESSION_LOCK__.release === 'function') {
          try { window.__SESSION_LOCK__.release(); }
          catch (err) { console.warn('ì„¸ì…˜ ì ê¸ˆ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', err); }
        }
        guestMode = false;
        guestTransferPreference = 'none';
        pendingGuestCleanup = false;
        pendingGuestRemovalNotice = false;
        uid = null; dataRef = null;
        userServerKey = null; userIdKey = null; userBasePath = null;
        dailyUnlocked = false; rankingUnlocked = false;
        bootDone = false;

        ensureFx(); window.fx.buffs = [];
        renderBuffStatus();

        security = { suspicion:0, banned:false, tosAccepted:false, tosViolated:false, fairSeconds:0, lastWarnAt:0 };
        securityDirty = false;
        renderSecurityBadge();

        clearSupportCtx();
        hideAllOverlays();

        state = withAutoConvertDefaults();
        localLastWrite = 0; isInitialSync = false;

        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        ['top-bar','container'].forEach(id => document.getElementById(id).style.visibility = 'hidden');
        setAuthMode(currentAuthMode);
        refreshGuestButton();
        updateGuestUiState();
      }
    });

    // ë¶€íŒ… ì˜¤ë²„ë ˆì´ í˜ì¼ì„¸ì´í”„
    setTimeout(() => {
      const stillBooting = bootOverlay && getComputedStyle(bootOverlay).display !== 'none';
      const gameHidden = document.getElementById('container')?.style.visibility !== 'visible';
      if (stillBooting && gameHidden) {
        setBootVisible(false);
        authContainer.style.display = 'block';
        setTimeout(() => authContainer.classList.remove('hidden'), 16);
        showAuthStatus('ì„¸ì…˜ í™•ì¸ì´ ì§€ì—°ë˜ì–´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.', false);
      }
    }, 4000);

    async function startCodeLoginFlow() {
      const infoEl = document.getElementById('codeInfoText');
      const codeEl = document.getElementById('codeDisplay');
      const statusEl = document.getElementById('codeStatus');
      const areaEl = document.getElementById('codeArea');

      if (!infoEl || !codeEl || !statusEl || !areaEl) {
        console.warn('code login elements not found');
        return;
      }

      infoEl.textContent = 'ì´ ê¸°ëŠ¥ì€ ì•±(WebView)ì—ì„œ ì™¸ë¶€ ë¸Œë¼ìš°ì €ë¡œ ë¡œê·¸ì¸í•  ë•Œ ì“°ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.';

      try {
        const res = await fetch(AUTH_BASE_URL + '/api/login-start', {
          method: 'POST'
        });
        const data = await res.json();

        currentCode = data.code;
        areaEl.style.display = 'block';
        codeEl.textContent = currentCode;
        statusEl.textContent = 'ì½”ë“œë¥¼ ë³µì‚¬í•˜ê³ , 3ì´ˆ í›„ ì—´ë¦´ ë¡œê·¸ì¸ í™”ë©´ì—ì„œ êµ¬ê¸€ ë¡œê·¸ì¸ì„ ì™„ë£Œí•˜ì„¸ìš”.';

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(currentCode).then(() => {
            statusEl.textContent = 'ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì´ˆ í›„ ë¡œê·¸ì¸ í™”ë©´ì´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.';
          }).catch(() => {
          });
        }

        const loginUrl = AUTH_BASE_URL + '/login.html?code=' + encodeURIComponent(currentCode);
        setTimeout(() => window.open(loginUrl, '_blank'), 3000);

        startPollingLoginStatus();
      } catch (err) {
        console.error(err);
        alert('ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    function startPollingLoginStatus() {
      if (!currentCode) return;
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        try {
          const res = await fetch(
            AUTH_BASE_URL + '/api/login-status?code=' + encodeURIComponent(currentCode)
          );
          const data = await res.json();

          const statusEl = document.getElementById('codeStatus');
          if (!statusEl) return;

          if (data.status === 'pending') {
            statusEl.textContent = 'ë¡œê·¸ì¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
          } else if (data.status === 'done') {
            clearInterval(pollTimer);
            pollTimer = null;
            statusEl.textContent = 'ë¡œê·¸ì¸ ì™„ë£Œ! ê³„ì • ì—°ê²° ì¤‘...';

            if (data.customToken) {
              try {
                await signInWithCustomToken(auth, data.customToken);
                statusEl.textContent =
                  'ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ê²Œì„ì„ ê³„ì† ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
              } catch (err) {
                console.error(err);
                statusEl.textContent =
                  'Firebase ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
              }
            } else {
              statusEl.textContent = 'í† í° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }
          } else if (data.status === 'expired') {
            clearInterval(pollTimer);
            pollTimer = null;
            statusEl.textContent = 'ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else if (data.status === 'not_found') {
            statusEl.textContent = 'ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else {
            statusEl.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤: ' + data.status;
          }
        } catch (err) {
          console.error(err);
          const statusEl = document.getElementById('codeStatus');
          if (statusEl) {
            statusEl.textContent =
              'ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸ë©ë‹ˆë‹¤...';
          }
        }
      }, 3000);
    }

    document.getElementById('google-btn').addEventListener('click', async () => {
      showAuthStatus('');
      guestTransferPreference = 'none';
      if (hasGuestProfile()) {
        const wantsOverwrite = confirm(GUEST_OVERWRITE_PROMPT);
        guestTransferPreference = wantsOverwrite ? 'overwrite' : 'skip';
      }
      const provider = new GoogleAuthProvider();

      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        if (handleAuthError(err)) return;
        try {
          await signInWithRedirect(auth, provider);
        } catch (err2) {
          if (handleAuthError(err2)) return;
          showAuthStatus('êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        guestTransferPreference = 'none';
      }
    });

    const btnCode = document.getElementById('btnGoogleLoginCode');
    if (btnCode) {
      btnCode.addEventListener('click', startCodeLoginFlow);
    }

    window.addEventListener('load', () => {
      if (window.__PLAY_ALLOWED) wireGame();
      else window.__DEFER_INIT = wireGame;
      renderBuffStatus();
      renderSecurityBadge();
    });

    setInterval(renderBuffStatus, 1000);
    window.openDailyManual = function(){
      if (!uid) {
        if (!requireLoginForFeature()) return;
      }
      checkDailyAndMaybeShow().then(()=>openDailyOverlay());
    }
  </script>

  <script>
    (function(){
      const SHOP_URL = 'https://shop.íƒœì–‘ê³„ì •ë³µ.siustudio.me/';
      const overlay = document.getElementById('shop-overlay');
      const frame = document.getElementById('shop-frame');
      const closeBtn = document.getElementById('shop-close');
      if (!overlay || !frame) return;

      function emitShopError(info, extraDetail = null){
        let detail = {};
        if (typeof info === 'string') {
          detail.message = info;
        } else if (info && typeof info === 'object') {
          detail = { ...info };
        }
        if (extraDetail && typeof extraDetail === 'object') {
          detail = { ...detail, ...extraDetail };
        }
        if (!detail.message) {
          detail.message = 'ì´ë²¤íŠ¸ì½”ì¸ ê´€ë¦¬ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
        try {
          window.dispatchEvent(new CustomEvent('shop-open-error', { detail }));
        } catch {
          const fallbackMessage = detail.manualMessage || detail.message;
          try { alert(detail.copyUrl ? `${fallbackMessage}\n${detail.copyUrl}` : fallbackMessage); } catch {}
        }
      }

      function ensureShopLoaded(){
        const current = frame.getAttribute('src');
        if (!current || current === 'about:blank') {
          frame.setAttribute('src', SHOP_URL);
        }
      }

      function isWebAppDisplayMode(){
        const modes = ['standalone', 'minimal-ui', 'fullscreen'];
        try {
          if (navigator.standalone) return true;
        } catch {}
        return modes.some((mode) => {
          try { return window.matchMedia(`(display-mode: ${mode})`).matches; }
          catch { return false; }
        });
      }

      function openShopOverlay(){
        try {
          window.open(SHOP_URL, '_blank', 'noopener,noreferrer');
        } catch {
          location.href = SHOP_URL;
        }
      }

      function closeShopOverlay(){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }

      closeBtn?.addEventListener('click', closeShopOverlay);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeShopOverlay();
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('show')) {
          closeShopOverlay();
        }
      });

      window.openShopOverlay = openShopOverlay;
      window.closeShopOverlay = closeShopOverlay;
    })();
  </script>

  <!-- ìš°í´ë¦­ ì»¤ìŠ¤í…€ ë©”ë‰´ -->
  <script>
    const customMenu = document.getElementById('custom-menu');
    const customDownloadItem = customMenu.querySelector('[data-action="download"]');
    const displayModes = ['standalone', 'minimal-ui', 'fullscreen'];

    const devtoolGuard = window.__DEVTOOL_GUARD = window.__DEVTOOL_GUARD || {};
    if (typeof devtoolGuard.active !== 'boolean') {
      devtoolGuard.active = true;
    }
    devtoolGuard.hideMenu = () => {
      if (customMenu) customMenu.style.display = 'none';
    };

    function isRunningAsWebApp() {
      try {
        if (navigator.standalone) return true;
      } catch {}
      return displayModes.some(mode => {
        try { return window.matchMedia(`(display-mode: ${mode})`).matches; }
        catch { return false; }
      });
    }

    function isEmbeddedContainer() {
      if (isRunningAsWebApp()) return true;
      const ua = (navigator.userAgent || '').toLowerCase();
      if (ua.includes('; wv') || ua.includes(' wv)') || ua.includes('wv)') || /\bwv\b/.test(ua)) return true;
      if (/(iphone|ipad|ipod).+applewebkit(?!.*safari)/i.test(navigator.userAgent || '')) return true;
      if (window.ReactNativeWebView || window.flutter_inappwebview || window.AndroidBridge) return true;
      if (window.Capacitor && window.Capacitor.isNativePlatform) return true;
      try {
        if (window.webkit && window.webkit.messageHandlers) return true;
      } catch {}
      return false;
    }

    const isEmbeddedApp =
      typeof window.__IS_EMBEDDED_APP === 'boolean'
        ? window.__IS_EMBEDDED_APP
        : isEmbeddedContainer();

    window.__IS_EMBEDDED_APP = isEmbeddedApp;
    try { document.documentElement.dataset.embeddedApp = isEmbeddedApp ? '1' : '0'; } catch {}

    if (isEmbeddedApp && customDownloadItem) {
      customDownloadItem.remove();
    }

    const googleBtn = document.getElementById('google-btn');
    const googleCodeBtn = document.getElementById('btnGoogleLoginCode');
    const googleCodeArea = document.getElementById('codeArea');

    if (isEmbeddedApp) {
      if (googleBtn) googleBtn.style.display = 'none';
    } else {
      if (googleCodeBtn) googleCodeBtn.style.display = 'none';
      if (googleCodeArea) googleCodeArea.style.display = 'none';
    }

    const handleContextMenu = (e) => {
      if (devtoolGuard.active === false) {
        devtoolGuard.hideMenu?.();
        return;
      }
      e.preventDefault();
      customMenu.style.top = `${e.clientY}px`;
      customMenu.style.left = `${e.clientX}px`;
      customMenu.style.display = 'block';
    };
    window.addEventListener('contextmenu', handleContextMenu);
    devtoolGuard.contextMenuHandler = handleContextMenu;
    customMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('.menu-item');
      const action = btn && btn.getAttribute('data-action');
      if (!action) return;
      if (action === 'menu') {
        try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
        try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
        try { window.close(); } catch {}
        setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
      }
      if (action === 'download') {
        if (window.__IS_EMBEDDED_APP) return;
        const proceed = confirm('ì•± ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ onestore.co.kr ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (proceed) { location.href = 'https://m.onestore.co.kr/v2/ko-kr/app/0001002762'; }
      }
      if (action === 'shop') {
        customMenu.style.display='none';
        try { window.openShopOverlay && window.openShopOverlay(); } catch {}
      }
      if (action === 'resume')   { customMenu.style.display='none'; }
      if (action === 'rank')     {
        customMenu.style.display='none';
        location.href='/ranking.html';
      }
      if (action === 'mail')     { customMenu.style.display='none'; try { window.openMailOverlay && window.openMailOverlay(); } catch {} }
      if (action === 'quests')   { customMenu.style.display='none'; try { window.openQuestOverlay && window.openQuestOverlay(); } catch {} }
      if (action === 'attendance'){ customMenu.style.display='none'; try{ window.openDailyManual(); }catch{} }
    });
    window.addEventListener('click', e => { if (!customMenu.contains(e.target)) customMenu.style.display='none'; });
  </script>

  <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
  <script>
    (function(){
      const sideToggle = document.getElementById('side-menu-toggle');
      const sideMenu   = document.getElementById('side-menu');
      const backdrop   = document.getElementById('side-backdrop');
      const sideDownloadItem = sideMenu.querySelector('[data-action="download"]');

      if (window.__IS_EMBEDDED_APP && sideDownloadItem) {
        sideDownloadItem.remove();
      }

      function openSide(){
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }
      function closeSide(){
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden','true');
      }

      sideToggle.addEventListener('click', openSide);
      backdrop.addEventListener('click', closeSide);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });

      sideMenu.addEventListener('click', (e)=>{
        const btn = e.target.closest('.side-item');
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'menu') {
          try { if (window.opener && !window.opener.closed) { window.opener.focus(); } } catch {}
          try { window.opener && window.opener.postMessage && window.opener.postMessage({ type: 'request-close-popup', from: location.href }, '*'); } catch {}
          try { window.close(); } catch {}
          setTimeout(()=>{ if(!window.closed) location.href='/index.html'; }, 250);
        }
        if (action === 'download') {
          if (window.__IS_EMBEDDED_APP) { closeSide(); return; }
          const proceed = confirm('ì•± ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ m.onestore.co.kr ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (proceed) { location.href = 'https://m.onestore.co.kr/v2/ko-kr/app/0001002762'; }
        }
        if (action === 'shop')     { try { window.openShopOverlay && window.openShopOverlay(); } catch {} }
        if (action === 'rank')     {
          location.href='/ranking.html';
        }
        if (action === 'mail')     { try { window.openMailOverlay && window.openMailOverlay(); } catch {} }
        if (action === 'quests')   { try { window.openQuestOverlay && window.openQuestOverlay(); } catch {} }
        if (action === 'attendance'){ try{ window.openDailyManual(); }catch{} }
        if (action === 'resume')   { /* ë‹«ê¸°ë§Œ */ }
        closeSide();
      });
    })();
  </script>

  <!-- ë””ë²„ê·¸ í‚¬ -->
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    (function(){
      const devtoolGuard = window.__DEVTOOL_GUARD = window.__DEVTOOL_GUARD || {};
      if (typeof devtoolGuard.active !== 'boolean') {
        devtoolGuard.active = true;
      }

      const devtoolOptions = {
        disableMenu: true,
        disableSelect: true,
        disableCopy: true,
        disableCut: true,
        disablePaste: true,
        clearIntervalWhenDevOpenTrigger: true,
        ondevtoolopen(type, next) {
          try { window.close(); } catch {}
          next();
        },
        ondevtoolclose() { console.warn('DevTools ë‹«í˜ ê°ì§€ë¨'); }
      };

      let guardInterval = null;
      let lastInstance = null;

      const stopInstance = (target) => {
        if (!target) return;
        ['stop','disable','uninstall','destroy','release','pause'].forEach((fn) => {
          try {
            if (typeof target[fn] === 'function') {
              target[fn]();
            }
          } catch {}
        });
      };

      const applyDevtoolGuards = () => {
        if (devtoolGuard.active === false) return;
        try {
          if (typeof DisableDevtool === 'function') {
            const instance = DisableDevtool(devtoolOptions);
            if (instance) {
              lastInstance = instance;
            }
          }
        } catch (err) {
          console.warn('DisableDevtool ì ìš© ì¤‘ ì˜¤ë¥˜', err);
        }
      };

      const ensureInterval = () => {
        if (guardInterval || devtoolGuard.active === false) return;
        guardInterval = setInterval(() => {
          if (devtoolGuard.active === false) return;
          applyDevtoolGuards();
        }, 1000);
      };

      const disableGuards = () => {
        if (devtoolGuard.active === false) return;
        devtoolGuard.active = false;
        if (guardInterval) {
          clearInterval(guardInterval);
          guardInterval = null;
        }
        devtoolGuard.hideMenu?.();
        stopInstance(lastInstance);
        stopInstance(typeof DisableDevtool === 'function' ? DisableDevtool : null);
        try { window.oncontextmenu = null; } catch {}
      };

      const enableGuards = () => {
        if (devtoolGuard.active === true) return;
        devtoolGuard.active = true;
        applyDevtoolGuards();
        ensureInterval();
      };

      devtoolGuard.disableGuards = disableGuards;
      devtoolGuard.enableGuards = enableGuards;

      applyDevtoolGuards();
      ensureInterval();

      const ADMIN_EMAILS = new Set(['siu46852579@gmail.com', 'ch3715@gmail.com']);
      devtoolGuard.allowedAdminEmails = ADMIN_EMAILS;
      devtoolGuard.adminBypassGranted = false;
      devtoolGuard.currentEmail = '';

      const normalizeEmail = (email) => (email ? String(email).toLowerCase() : '');

      const evaluateBypass = () => {
        if (devtoolGuard.adminBypassGranted && ADMIN_EMAILS.has(devtoolGuard.currentEmail)) {
          disableGuards();
        } else {
          if (!ADMIN_EMAILS.has(devtoolGuard.currentEmail)) {
            devtoolGuard.adminBypassGranted = false;
          }
          enableGuards();
        }
      };

      devtoolGuard.evaluateBypass = evaluateBypass;

      devtoolGuard.onAuthEmailChange = (email) => {
        devtoolGuard.currentEmail = normalizeEmail(email);
        evaluateBypass();
      };

      devtoolGuard.resetBypass = () => {
        devtoolGuard.adminBypassGranted = false;
        evaluateBypass();
      };

      window.addEventListener('game-admin-auth-success', () => {
        devtoolGuard.adminBypassGranted = true;
        evaluateBypass();
      });

      const initialEmail = normalizeEmail(window.__CURRENT_USER_EMAIL || '');
      if (initialEmail) {
        devtoolGuard.currentEmail = initialEmail;
        evaluateBypass();
      }
    })();
  </script>

  <!-- ì›ê²© ì§€ì› -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; 
      });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- Firebase ì»¤ë§¨ë“œ(ì„¸ì…˜ ì œì–´) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, query, orderByChild, equalTo, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app2 = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth2 = getAuth(app2);
    const db2   = getDatabase(app2);

    let sessionId = null;

    function setActiveSession(id){
      if (!id) return;
      sessionId = String(id);
      try { sessionStorage.setItem('cobrowse_session_id', sessionId); } catch {}
      bindCommands(sessionId);
      watchSessionEnd(sessionId);
    }

    function bindCommands(id){
      const cmdRef = ref(db2, `sessions/${id}/commands`);
      onChildAdded(cmdRef, (snap) => {
        const cmd = snap.val() || {};
        try {
          if (cmd.type === 'navigate' && cmd.path){
            if (/^https?:\/\//i.test(cmd.path)) {
              const ok = (typeof window.isAllowedRedirect === 'function') ? window.isAllowedRedirect(cmd.path) : true;
              if (ok) location.assign(cmd.path);
            } else { location.assign(cmd.path); }
          }
          else if (cmd.type === 'click' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){
              el.focus?.(); el.click?.();
              el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window })); }
          }
          else if (cmd.type === 'highlight' && cmd.selector){
            const el = document.querySelector(cmd.selector);
            if (el){ const prev = el.style.outline; el.style.outline = '3px solid #00e5ff'; setTimeout(()=>{ el.style.outline = prev; }, 1800); }
          }
        } catch (e) { /* noop */ }
      });
    }

    function watchSessionEnd(id){
      const statusRef = ref(db2, `sessions/${id}/meta/status`);
      onValue(statusRef, (snap) => {
        if (snap.val() === 'ended') {
          try { sessionStorage.removeItem('cobrowse_session_id'); } catch {}
        }
      });
    }

    try { sessionId = sessionStorage.getItem('cobrowse_session_id') || null; } catch {}
    if (sessionId) {
      setActiveSession(sessionId);
    } else {
      onAuthStateChanged(auth2, (user) => {
        if (!user) return;
        const q = query(ref(db2, 'sessions'), orderByChild('meta/userUid'), equalTo(user.uid));
        onValue(q, (snap) => {
          let latestId = null, latestAt = 0;
          snap.forEach(child => {
            const v = child.val();
            const st = v?.meta?.status;
            const created = v?.meta?.createdAt || 0;
            if (st === 'active' && created > latestAt) { latestAt = created; latestId = child.key; }
          });
          if (latestId) setActiveSession(latestId);
        }, { onlyOnce: true });
      });
    }
  </script>

  <!-- Popup Enforcement (ê°„ì†Œ) -->
  <script>
    (function(){
      const gate = document.getElementById('popup-gate');
      const countdownEl = gate ? gate.querySelector('#popup-gate-count') : null;
      const backBtn     = gate ? gate.querySelector('#popup-gate-back') : null;
      const adminBox    = gate ? gate.querySelector('#admin-login') : null;
      const adminIdEl   = adminBox ? adminBox.querySelector('#admin-id') : null;
      const adminPwEl   = adminBox ? adminBox.querySelector('#admin-password') : null;
      const adminSubmit = adminBox ? adminBox.querySelector('#admin-submit') : null;
      const adminError  = adminBox ? adminBox.querySelector('#admin-error') : null;
      const adminProgress = adminBox ? adminBox.querySelector('#admin-progress') : null;

      const ADMIN_CREDENTIALS = {
        idSalt: 'X1$!v3-admin-id-salt-2025-03-17',
        pwSalt: 'X1$!v3-admin-pw-salt-2025-03-17',
        idHash: 'Z9LHQ1IPWlcTzPmUaXfiz3MgvKuzy+l7HiPa6B9wZmY=',
        pwHash: '7gefwrVRx5cPp/arcudKhxqszjKRIGLFdOT51zijaSs='
      };

      const textEncoder = new TextEncoder();

      const base64FromBuffer = (buffer) => {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        bytes.forEach((b) => { binary += String.fromCharCode(b); });
        return btoa(binary);
      };

      const secureCompare = (a, b) => {
        if (typeof a !== 'string' || typeof b !== 'string') return false;
        if (a.length !== b.length) return false;
        let diff = 0;
        for (let i = 0; i < a.length; i += 1) {
          diff |= a.charCodeAt(i) ^ b.charCodeAt(i);
        }
        return diff === 0;
      };

      const digestWithSalt = async (value, salt) => {
        if (!window.crypto || !window.crypto.subtle) {
          console.error('Web Crypto API is not available for admin credential verification.');
          return null;
        }
        const data = textEncoder.encode(`${salt}${value}`);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return base64FromBuffer(digest);
      };

      const verifyAdmin = async (user, pass) => {
        if (!user || !pass) return false;
        try {
          const [idHash, pwHash] = await Promise.all([
            digestWithSalt(user, ADMIN_CREDENTIALS.idSalt),
            digestWithSalt(pass, ADMIN_CREDENTIALS.pwSalt)
          ]);
          if (!idHash || !pwHash) return false;
          return secureCompare(idHash, ADMIN_CREDENTIALS.idHash) &&
                 secureCompare(pwHash, ADMIN_CREDENTIALS.pwHash);
        } catch (error) {
          console.error('Failed to verify admin credentials securely:', error);
          return false;
        }
      };

      window.__verifyGameAdmin = verifyAdmin;

      const notifyAdminAuthSuccess = (context) => {
        try {
          window.dispatchEvent(new CustomEvent('game-admin-auth-success', {
            detail: { context }
          }));
        } catch (err) {
          console.warn('Failed to dispatch admin auth success event', err);
        }
      };

      if (typeof window.__PLAY_DUP_LOCK_ACTIVE !== 'boolean') {
        window.__PLAY_DUP_LOCK_ACTIVE = false;
      }
      if (typeof window.__PLAY_BASE_ALLOWED !== 'boolean') {
        window.__PLAY_BASE_ALLOWED = false;
      }

      function isMobileStrict(){
        try { if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') return navigator.userAgentData.mobile; } catch {}
        const ua = navigator.userAgent || '';
        if (/(Android|iPhone|iPad|iPod|Windows Phone|BlackBerry|IEMobile|Mobile)/i.test(ua)) return true;
        if (/Mac/.test(navigator.platform || '') && (navigator.maxTouchPoints || 0) > 1) return true;
        const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
        const canHover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
        return (coarse && !canHover);
      }
      function isPopup(){
        try { if (window.opener && !window.opener.closed) return true; } catch {}
        try { if (['gameWindow','siuGame','popup'].includes(window.name)) return true; } catch {}
        return false;
      }

      const revealGame = () => {
        window.__PLAY_BASE_ALLOWED = true;
        window.__PLAY_ALLOWED = window.__PLAY_DUP_LOCK_ACTIVE ? false : true;
        ['top-bar','container'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.visibility = 'visible';
        });
        if (gate) {
          gate.classList.remove('show');
          gate.setAttribute('aria-hidden', 'true');
        }
        if (typeof window.__DEFER_INIT === 'function') {
          try { window.__DEFER_INIT(); }
          catch (e) { console.error(e); }
          window.__DEFER_INIT = null;
        }
      };

      const playAllowed = isMobileStrict() || isPopup();
      window.__PLAY_BASE_ALLOWED = playAllowed;
      window.__PLAY_ALLOWED = playAllowed && !window.__PLAY_DUP_LOCK_ACTIVE;

      if (playAllowed) {
        revealGame();
        return;
      }

      const redirect = () => { window.location.href = '/index.html'; };

      if (!gate) {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ê²Œì„ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë©”ë‰´ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        redirect();
        return;
      }

      gate.classList.add('show');
      gate.setAttribute('aria-hidden', 'false');

      let remaining = 5;
      let countdownTimer = null;
      if (countdownEl) countdownEl.textContent = String(remaining);

      const stopCountdown = () => {
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      };

      const startCountdown = () => {
        stopCountdown();
        countdownTimer = setInterval(() => {
          remaining -= 1;
          if (remaining < 0) remaining = 0;
          if (countdownEl) countdownEl.textContent = String(remaining);
          if (remaining <= 0) {
            stopCountdown();
            redirect();
          }
        }, 1000);
      };

      startCountdown();

      const goHome = () => {
        stopCountdown();
        redirect();
      };

      let holdTimer = null;
      let holdActivated = false;
      let suppressClick = false;

      const showAdminLogin = () => {
        if (!adminBox) return;
        stopCountdown();
        adminBox.classList.add('show');
        adminBox.setAttribute('aria-hidden', 'false');
        adminError && (adminError.textContent = '');
        setTimeout(() => { adminIdEl && adminIdEl.focus(); }, 60);
      };

      const startHold = () => {
        if (!adminBox) return;
        if (holdTimer) clearTimeout(holdTimer);
        holdActivated = false;
        holdTimer = setTimeout(() => {
          holdActivated = true;
          suppressClick = true;
          showAdminLogin();
        }, 2000);
      };

      const cancelHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        if (!holdActivated) {
          suppressClick = false;
        }
        holdActivated = false;
      };

      const showAdminFailureAlert = (context) => {
        const suffix = Math.floor(1000 + Math.random() * 9000);
        const code = `ADM-${context}-${suffix}`;
        const message = `[${code}] ê´€ë¦¬ì ì¸ì¦ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì…ë ¥ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
        if (adminError) adminError.textContent = message;
        alert(`${message}\n\nì˜¤ë¥˜ê°€ ê³„ì†ë˜ë©´ ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
        return code;
      };

      const startProgress = async (task) => {
        if (!adminProgress || !adminSubmit || !adminIdEl || !adminPwEl) {
          try {
            await task();
          } catch (error) {
            console.error('Admin verification error:', error);
          }
          return;
        }
        if (adminSubmit.disabled) return;
        const seconds = 10 + Math.floor(Math.random() * 11);
        let dots = 0;
        adminProgress.classList.add('show');
        adminProgress.textContent = 'Login in progress';
        adminSubmit.disabled = true;
        adminIdEl.disabled = true;
        adminPwEl.disabled = true;
        const dotTimer = setInterval(() => {
          dots = (dots + 1) % 4;
          adminProgress.textContent = 'Login in progress' + '.'.repeat(dots);
        }, 420);
        await new Promise((resolve) => setTimeout(resolve, seconds * 1000));
        try {
          await task();
        } catch (error) {
          console.error('Admin verification error (async):', error);
        } finally {
          clearInterval(dotTimer);
          adminProgress.classList.remove('show');
          adminProgress.textContent = '';
          adminSubmit.disabled = false;
          adminIdEl.disabled = false;
          adminPwEl.disabled = false;
        }
      };

      const handleAdminSubmit = () => {
        if (!adminIdEl || !adminPwEl || !adminError) return;
        const user = adminIdEl.value.trim();
        const pass = adminPwEl.value;
        if (!user || !pass) {
          adminError.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        adminError.textContent = '';
        startProgress(async () => {
          try {
            const ok = await verifyAdmin(user, pass);
            if (ok) {
              adminIdEl.value = '';
              adminPwEl.value = '';
              adminBox && adminBox.classList.remove('show');
              adminBox && adminBox.setAttribute('aria-hidden', 'true');
              alert('login succesful');
              notifyAdminAuthSuccess('popup-gate');
              revealGame();
            } else {
              const code = showAdminFailureAlert('POP');
              adminPwEl.value = '';
              adminPwEl.focus();
              window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'popup-gate', code } }));
            }
          } catch (error) {
            console.error('Admin verification error:', error);
            const suffix = Math.floor(1000 + Math.random() * 9000);
            const code = `ADM-POP-${suffix}`;
            const message = `[${code}] ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
            if (adminError) adminError.textContent = message;
            alert(`${message}\n\në¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
            adminPwEl.value = '';
            adminPwEl.focus();
            window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'popup-gate', code, fatal: true } }));
          }
        });
      };

      if (adminSubmit) {
        adminSubmit.addEventListener('click', handleAdminSubmit);
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleAdminSubmit();
          }
        });
      }
      if (adminIdEl) {
        adminIdEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }

      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.code === 'Digit1') {
          e.preventDefault();
          showAdminLogin();
        }
      });

      backBtn && backBtn.addEventListener('mousedown', startHold);
      backBtn && backBtn.addEventListener('touchstart', startHold, { passive: true });
      backBtn && backBtn.addEventListener('mouseup', cancelHold);
      backBtn && backBtn.addEventListener('mouseleave', cancelHold);
      backBtn && backBtn.addEventListener('touchend', cancelHold);
      backBtn && backBtn.addEventListener('touchcancel', cancelHold);

      backBtn && backBtn.addEventListener('click', (e) => {
        if (suppressClick) {
          e.preventDefault();
          suppressClick = false;
          return;
        }
        goHome();
      });
    })();
  </script>

  <!-- ì¤‘ë³µ ì‹¤í–‰ ê°ì§€ & ê´€ë¦¬ì ì˜ˆì™¸ -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, runTransaction, update, remove, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const sessionApp = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const sessionDb  = getDatabase(sessionApp);

    (function(){
      const overlay      = document.getElementById('session-lock-overlay');
      const statusEl     = document.getElementById('session-lock-status');
      const retryBtn     = document.getElementById('session-lock-retry');
      const adminToggle  = document.getElementById('session-lock-admin-toggle');
      const adminBox     = document.getElementById('session-lock-admin');
      const adminIdEl    = document.getElementById('session-admin-id');
      const adminPwEl    = document.getElementById('session-admin-password');
      const adminSubmit  = document.getElementById('session-admin-submit');
      const adminError   = document.getElementById('session-admin-error');
      const adminProgress= document.getElementById('session-admin-progress');
      const titleEl      = document.getElementById('session-lock-title');
      const descEl       = document.getElementById('session-lock-desc');
      const noteEl       = document.getElementById('session-lock-note');
      const remoteLogoutBtn = document.getElementById('session-lock-remote-logout');
      const hardBlockOverlay  = document.getElementById('js-hard-block-overlay');
      const hardBlockTitleEl  = document.getElementById('js-hard-block-title');
      const hardBlockDescEl   = document.getElementById('js-hard-block-desc');
      const hardBlockDeviceEl = document.getElementById('js-hard-block-device');
      const hardBlockErrorEl  = document.getElementById('js-hard-block-error');
      const hardBlockReloadBtn= document.getElementById('js-hard-block-reload');

      if (!overlay) {
        window.__SESSION_LOCK__ = {
          activate(){},
          release(){},
          bypass(){},
          openAdminPanel(){},
        };
        return;
      }

      if (typeof window.__PLAY_DUP_LOCK_ACTIVE !== 'boolean') {
        window.__PLAY_DUP_LOCK_ACTIVE = false;
      }
      if (typeof window.__PLAY_BASE_ALLOWED !== 'boolean') {
        window.__PLAY_BASE_ALLOWED = (typeof window.__PLAY_ALLOWED === 'boolean') ? window.__PLAY_ALLOWED : true;
      }

      const LOCK_TITLES = {
        local: 'ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì°½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤',
        remote: 'ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤'
      };
      const LOCK_NOTES = {
        local: 'ë‹¤ë¥¸ ì°½ì„ ë‹«ì€ ë’¤ "ë‹¤ì‹œ ì‹œë„" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.',
        remote: 'ë‹¤ë¥¸ ê¸°ê¸°ë‚˜ ë¸Œë¼ìš°ì €ì—ì„œ ì´ ê³„ì •ì´ ì—´ë ¤ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ "ì›ê²© ë¡œê·¸ì•„ì›ƒ"ì„ ëˆŒëŸ¬ ê°•ì œë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
      };
      const REMOTE_SESSION_PATH   = 'remoteSessions';
      const REMOTE_HEARTBEAT_MS   = 5000;
      const REMOTE_STALE_MS       = 15000;
      const REMOTE_RETRY_INTERVAL = 4000;

      const LOCK_PREFIX        = 'siu_game_lock_';
      const HEARTBEAT_INTERVAL = 3500;
      const STALE_THRESHOLD    = 12000;
      const RETRY_INTERVAL     = 4000;

      const now = () => Date.now();
      const makeToken = () => `${now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
      const ensureDeviceId = () => {
        let id = null;
        try { id = localStorage.getItem('siu_device_id'); }
        catch {}
        if (!id) {
          id = `dev_${Math.random().toString(36).slice(2, 10)}`;
          try { localStorage.setItem('siu_device_id', id); } catch {}
        }
        return id;
      };
      const describeDevice = () => {
        const ua = (navigator.userAgent || '').split(')')[0] || '';
        const platform = navigator.platform || '';
        return [platform, ua].filter(Boolean).join(' Â· ').slice(0, 80) || 'ë‹¤ë¥¸ ê¸°ê¸°';
      };

      let currentUid        = null;
      let token             = null;
      let hasLock           = false;
      let bypassed          = false;
      let heartbeatTimer    = null;
      let retryTimer        = null;
      let listenersAttached = false;
      let localBlockActive  = false;

      let remoteUid               = null;
      let remoteToken             = null;
      let remoteRef               = null;
      let remoteClaimed           = false;
      let remoteHeartbeatTimer    = null;
      let remoteRetryTimer        = null;
      let remoteDisconnectHandle  = null;
      let remoteInfo              = null;
      let remoteBlocked           = false;
      let remoteLogoutPending     = false;
      let remoteValueUnsubscribe  = null;
      const remoteDeviceId        = ensureDeviceId();
      const remoteLogoutLabel     = remoteLogoutBtn ? (remoteLogoutBtn.textContent || 'ì›ê²© ë¡œê·¸ì•„ì›ƒ') : 'ì›ê²© ë¡œê·¸ì•„ì›ƒ';

      const describeElapsed = (timestamp) => {
        if (!Number.isFinite(timestamp)) return null;
        const diff = now() - timestamp;
        if (!Number.isFinite(diff) || diff < 0) return null;
        if (diff < 1500) return 'ë°©ê¸ˆ ì „';
        const seconds = Math.floor(diff / 1000);
        if (seconds < 60) return `${seconds}ì´ˆ ì „`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        const days = Math.floor(hours / 24);
        return `${days}ì¼ ì „`;
      };
      const describeHardBlockDevice = (info) => {
        const label = (info && info.deviceLabel) ? info.deviceLabel : 'ë‹¤ë¥¸ ê¸°ê¸°';
        const ts = info?.updatedAt || info?.ts || null;
        const phrase = describeElapsed(ts);
        return phrase ? `${label} Â· ${phrase} í™œë™` : label;
      };
      const makeHardBlockErrorCode = () => `MULTI-SESSION-${Math.floor(1000 + Math.random() * 9000)}`;
      const disableTimingApis = () => {
        try {
          const highest = window.setTimeout(() => {}, 0);
          for (let id = highest; id >= 0; id -= 1) {
            clearTimeout(id);
            clearInterval(id);
          }
        } catch {}
        try {
          window.setTimeout = () => 0;
          window.setInterval = () => 0;
        } catch {}
        try {
          window.requestAnimationFrame = () => 0;
        } catch {}
        try {
          window.requestIdleCallback = () => 0;
        } catch {}
      };
      const disableNetworkApis = () => {
        try {
          const rejected = () => Promise.reject(new Error('js blocked by multi-device guard'));
          if (typeof window.fetch === 'function') {
            window.fetch = rejected;
          }
        } catch {}
        try {
          const BlockedXHR = function () {
            throw new Error('XMLHttpRequest blocked');
          };
          BlockedXHR.prototype = window.XMLHttpRequest ? window.XMLHttpRequest.prototype : {};
          window.XMLHttpRequest = BlockedXHR;
        } catch {}
        try {
          if (navigator.sendBeacon) {
            navigator.sendBeacon = () => false;
          }
        } catch {}
      };
      const showHardBlockOverlay = (info = {}) => {
        if (!hardBlockOverlay) return;
        const source = info?.blockSource === 'local' ? 'local' : 'remote';
        if (hardBlockTitleEl) {
          hardBlockTitleEl.textContent = source === 'local'
            ? 'ê°™ì€ ê¸°ê¸°ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤'
            : 'ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‹¤í–‰ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
        }
        if (hardBlockDeviceEl) {
          if (source === 'local') {
            const ts = info?.ts || info?.updatedAt || null;
            const phrase = describeElapsed(ts);
            hardBlockDeviceEl.textContent = phrase
              ? `í˜„ì¬ ê¸°ê¸° Â· ${phrase} í™œë™`
              : 'í˜„ì¬ ê¸°ê¸°';
          } else {
            hardBlockDeviceEl.textContent = describeHardBlockDevice(info);
          }
        }
        if (hardBlockDescEl) {
          if (source === 'local') {
            hardBlockDescEl.textContent = 'ê°™ì€ ê¸°ê¸°ì—ì„œ ë™ì¼ ê³„ì •ì´ ì—¬ëŸ¬ ì°½ì—ì„œ ì‹¤í–‰ë˜ì–´ í˜„ì¬ ì°½ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì™„ì „íˆ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤. ëª¨ë“  ì°½ì„ ë‹«ì€ ë’¤ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.';
          } else {
            const ts = info?.updatedAt || info?.ts || null;
            const phrase = describeElapsed(ts);
            const device = (info && info.deviceLabel) ? info.deviceLabel : 'ë‹¤ë¥¸ ê¸°ê¸°';
            const timeText = phrase ? `${phrase} ` : '';
            hardBlockDescEl.textContent = `${timeText}${device}ì—ì„œ ìƒˆë¡œìš´ ì ‘ì†ì´ ê°ì§€ë˜ì–´ í˜„ì¬ ì°½ì˜ ì‹¤í–‰ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤. ê°™ì€ ê³„ì •ì´ ì—¬ëŸ¬ ì°½ì—ì„œ ë™ì‹œì— ì—´ë¦¬ë©´ ì´ìš©ì•½ê´€ ìœ„ë°˜ìœ¼ë¡œ ê°„ì£¼ë  ìˆ˜ ìˆì–´ìš”. ì˜¤íƒì„ í”¼í•˜ê¸° ìœ„í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ì°½ë§Œ í—ˆìš©í•˜ê³  ìˆìœ¼ë‹ˆ ë„ˆê·¸ëŸ½ê²Œ ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ë§Œì•½ ì˜¤ë¥˜ê°€ ìƒê¸°ë©´ support@siustudio.meë¡œ ë¬¸ì˜í•˜ì—¬ ì£¼ì‹­ì‹œì˜¤.`;
          }
        }
        if (hardBlockErrorEl) {
          const code = info?.errorCode || makeHardBlockErrorCode();
          hardBlockErrorEl.textContent = `ì˜¤ë¥˜ ì½”ë“œ: ${code}`;
        }
        hardBlockOverlay.classList.add('show');
        hardBlockOverlay.setAttribute('aria-hidden', 'false');
      };
      const runDeferredInitIfReady = () => {
        if (!hasLock) return;
        if (remoteBlocked) return;
        if (typeof window.__DEFER_INIT === 'function') {
          const fn = window.__DEFER_INIT;
          window.__DEFER_INIT = null;
          try { fn(); }
          catch (err) { console.error('ì§€ì—°ëœ ì´ˆê¸°í™”ë¥¼ ì‹¤í–‰í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err); }
        }
      };
      const updateRemoteLogoutVisibility = () => {
        if (!remoteLogoutBtn) return;
        if (remoteBlocked) {
          remoteLogoutBtn.style.display = 'inline-flex';
        } else {
          remoteLogoutBtn.style.display = 'none';
        }
        remoteLogoutBtn.disabled = !!remoteLogoutPending;
        remoteLogoutBtn.textContent = remoteLogoutPending ? 'ì›ê²© ë¡œê·¸ì•„ì›ƒ ì¤‘â€¦' : remoteLogoutLabel;
      };
      const updateLockTexts = () => {
        const mode = remoteBlocked ? 'remote' : 'local';
        if (titleEl) titleEl.textContent = LOCK_TITLES[mode] || LOCK_TITLES.local;
        if (noteEl) noteEl.textContent = LOCK_NOTES[mode] || LOCK_NOTES.local;
        updateRemoteLogoutVisibility();
      };

      const getKey = (uid) => `${LOCK_PREFIX}${uid}`;
      const parseValue = (value) => {
        if (!value) return null;
        try { return JSON.parse(value); }
        catch (err) {
          console.warn('ì„¸ì…˜ ì ê¸ˆ ì •ë³´ë¥¼ í•´ì„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err);
          return null;
        }
      };
      const readLock = () => {
        if (!currentUid) return null;
        try { return parseValue(localStorage.getItem(getKey(currentUid))); }
        catch (err) {
          console.warn('ì„¸ì…˜ ì ê¸ˆ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', err);
          return null;
        }
      };
      const writeLock = () => {
        if (!currentUid || !token) return;
        const payload = JSON.stringify({ token, ts: now() });
        try { localStorage.setItem(getKey(currentUid), payload); }
        catch (err) { console.warn('ì„¸ì…˜ ì ê¸ˆ ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', err); }
      };
      const removeLockIfOwned = () => {
        if (!currentUid || !token) return;
        try {
          const raw = localStorage.getItem(getKey(currentUid));
          const parsed = parseValue(raw);
          if (parsed && parsed.token && parsed.token !== token) return;
          localStorage.removeItem(getKey(currentUid));
        } catch (err) {
          console.warn('ì„¸ì…˜ ì ê¸ˆì„ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', err);
        }
      };

      const overlayShow = () => {
        updateLockTexts();
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      };
      const overlayHide = () => {
        if (remoteBlocked || localBlockActive) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        if (statusEl) statusEl.textContent = '';
        if (adminBox) {
          adminBox.classList.remove('show');
          adminBox.setAttribute('aria-hidden', 'true');
        }
      };

      const updateStatus = (info) => {
        if (!statusEl) return;
        if (remoteBlocked) {
          const updatedTs = info?.updatedAt || info?.ts || null;
          const phrase = updatedTs ? describeElapsed(updatedTs) : null;
          const device = (info && info.deviceLabel) ? info.deviceLabel : 'ë‹¤ë¥¸ ê¸°ê¸°';
          statusEl.textContent = phrase
            ? `${device}ì—ì„œ ${phrase} í™œë™í–ˆìŠµë‹ˆë‹¤.`
            : `${device}ì—ì„œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.`;
          return;
        }
        if (!info || !info.ts) {
          statusEl.textContent = 'ë‹¤ë¥¸ ì°½ì„ ë‹«ì€ ë’¤ "ë‹¤ì‹œ ì‹œë„"ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.';
          return;
        }
        const phrase = describeElapsed(info.ts);
        statusEl.textContent = phrase
          ? `ë‹¤ë¥¸ ì°½ì—ì„œ ${phrase} í™œë™í–ˆìŠµë‹ˆë‹¤.`
          : 'ë‹¤ë¥¸ ì°½ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.';
      };

      const applyPlayState = () => {
        const base = (typeof window.__PLAY_BASE_ALLOWED === 'boolean')
          ? window.__PLAY_BASE_ALLOWED
          : (typeof window.__PLAY_ALLOWED === 'boolean' ? window.__PLAY_ALLOWED : true);
        if (remoteBlocked) {
          window.__PLAY_DUP_LOCK_ACTIVE = true;
          window.__PLAY_ALLOWED = false;
          return;
        }
        if (!currentUid || bypassed) {
          window.__PLAY_DUP_LOCK_ACTIVE = false;
          window.__PLAY_ALLOWED = base;
          return;
        }
        if (hasLock) {
          window.__PLAY_DUP_LOCK_ACTIVE = false;
          window.__PLAY_ALLOWED = base;
        } else {
          window.__PLAY_DUP_LOCK_ACTIVE = true;
          window.__PLAY_ALLOWED = false;
        }
      };

      const stopHeartbeat = () => {
        if (heartbeatTimer) {
          clearInterval(heartbeatTimer);
          heartbeatTimer = null;
        }
      };
      const startHeartbeat = () => {
        stopHeartbeat();
        if (!currentUid || !token || !hasLock || bypassed) return;
        writeLock();
        heartbeatTimer = setInterval(() => {
          if (!currentUid || !hasLock || bypassed) {
            stopHeartbeat();
            return;
          }
          writeLock();
        }, HEARTBEAT_INTERVAL);
      };

      const stopRetry = () => {
        if (retryTimer) {
          clearInterval(retryTimer);
          retryTimer = null;
        }
      };
      const stopRemoteHeartbeat = () => {
        if (remoteHeartbeatTimer) {
          clearInterval(remoteHeartbeatTimer);
          remoteHeartbeatTimer = null;
        }
      };
      const startRemoteHeartbeat = () => {
        stopRemoteHeartbeat();
        if (!remoteClaimed || !remoteRef) return;
        const beat = async () => {
          if (!remoteClaimed || !remoteRef) return;
          try { await update(remoteRef, { updatedAt: now() }); }
          catch (err) { console.warn('ì›ê²© ì„¸ì…˜ í•˜íŠ¸ë¹„íŠ¸ë¥¼ ê°±ì‹ í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err); }
        };
        beat();
        remoteHeartbeatTimer = setInterval(beat, REMOTE_HEARTBEAT_MS);
      };
      const stopRemoteRetry = () => {
        if (remoteRetryTimer) {
          clearInterval(remoteRetryTimer);
          remoteRetryTimer = null;
        }
      };
      const detachRemoteWatcher = () => {
        if (remoteValueUnsubscribe) {
          try { remoteValueUnsubscribe(); }
          catch {}
          remoteValueUnsubscribe = null;
        }
      };
      const handleRemoteValueChange = (snap) => {
        if (!snap || remoteBlocked || !remoteToken) return;
        const data = typeof snap.val === 'function' ? snap.val() : null;
        if (!data) {
          if (remoteUid && remoteClaimed) {
            attemptRemoteClaim();
          }
          return;
        }
        if (data.token && data.token !== remoteToken) {
          setRemoteBlockedState(true, data);
        }
      };
      const attachRemoteWatcher = () => {
        if (!remoteRef || remoteValueUnsubscribe) return;
        try {
          remoteValueUnsubscribe = onValue(
            remoteRef,
            handleRemoteValueChange,
            (err) => console.warn('ì›ê²© ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', err)
          );
        } catch (err) {
          console.warn('ì›ê²© ì„¸ì…˜ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err);
        }
      };
      const scheduleRemoteRetry = () => {
        if (remoteRetryTimer) return;
        remoteRetryTimer = setInterval(() => {
          if (!remoteUid) {
            stopRemoteRetry();
            return;
          }
          attemptRemoteClaim();
        }, REMOTE_RETRY_INTERVAL);
      };
      function hardBlockJsExecution(info) {
        if (window.__GAME_JS_HARD_BLOCKED) return;
        window.__GAME_JS_HARD_BLOCKED = true;
        try { stopHeartbeat(); } catch {}
        try { stopRetry(); } catch {}
        try { stopRemoteHeartbeat(); } catch {}
        try { stopRemoteRetry(); } catch {}
        disableTimingApis();
        disableNetworkApis();
        const enrichedInfo = info && typeof info === 'object' ? { ...info } : {};
        if (!enrichedInfo.errorCode) {
          enrichedInfo.errorCode = makeHardBlockErrorCode();
        }
        console.error(`[${enrichedInfo.errorCode}] ê³„ì • ë™ì‹œ ì‹¤í–‰ì´ ê°ì§€ë˜ì–´ í˜„ì¬ ì°½ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.`);
        showHardBlockOverlay(enrichedInfo);
        try { window.__DEFER_INIT = null; } catch {}
        try { window.__HARD_SHUTDOWN_GAME?.(enrichedInfo); } catch {}
        localBlockActive = false;
        remoteBlocked = true;
        try {
          if (overlay) {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
          }
        } catch {}
        window.__PLAY_DUP_LOCK_ACTIVE = true;
        window.__PLAY_ALLOWED = false;
        try { applyPlayState(); } catch {}
      }
      const isRemoteStale = (info) => {
        if (!info) return true;
        const ts = info.updatedAt || info.ts || 0;
        if (!Number.isFinite(ts)) return true;
        const age = now() - ts;
        return !Number.isFinite(age) || age > REMOTE_STALE_MS;
      };
      const setRemoteBlockedState = (active, info = null) => {
        if (window.__GAME_JS_HARD_BLOCKED) {
          remoteBlocked = true;
          if (!remoteInfo) remoteInfo = info || null;
          return;
        }
        remoteBlocked = !!active;
        remoteInfo = info ? { ...info } : null;
        if (remoteBlocked) {
          detachRemoteWatcher();
          const enriched = remoteInfo ? { ...remoteInfo } : {};
          if (!enriched.errorCode) {
            enriched.errorCode = makeHardBlockErrorCode();
          }
          if (!enriched.blockSource) {
            enriched.blockSource = 'remote';
          }
          remoteInfo = enriched;
          hardBlockJsExecution(enriched);
          return;
        }
        stopRemoteRetry();
        updateStatus(null);
        overlayHide();
        updateLockTexts();
        applyPlayState();
        runDeferredInitIfReady();
      };
      const setupRemoteDisconnect = () => {
        if (!remoteRef) return;
        try { remoteDisconnectHandle?.cancel?.(); }
        catch {}
        try {
          remoteDisconnectHandle = onDisconnect(remoteRef);
          remoteDisconnectHandle.remove().catch(() => {});
        } catch (err) {
          remoteDisconnectHandle = null;
          console.warn('ì›ê²© ì„¸ì…˜ onDisconnect ë¥¼ ì„¤ì •í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err);
        }
      };
      const releaseRemoteSession = async () => {
        stopRemoteHeartbeat();
        stopRemoteRetry();
        detachRemoteWatcher();
        try { await remoteDisconnectHandle?.cancel?.(); }
        catch {}
        remoteDisconnectHandle = null;
        const targetRef = remoteRef;
        const targetToken = remoteToken;
        remoteUid = null;
        remoteRef = null;
        remoteToken = null;
        remoteClaimed = false;
        remoteInfo = null;
        setRemoteBlockedState(false);
        if (targetRef && targetToken) {
          try {
            await runTransaction(targetRef, (current) => {
              if (current && current.token === targetToken) {
                return null;
              }
              return current || null;
            }, { applyLocally: false });
          } catch (err) {
            console.warn('ì›ê²© ì„¸ì…˜ì„ í•´ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', err);
          }
        }
      };
      const attemptRemoteClaim = async () => {
        if (!remoteUid) {
          setRemoteBlockedState(false);
          return false;
        }
        if (!remoteToken) remoteToken = makeToken();
        const targetRef = ref(sessionDb, `${REMOTE_SESSION_PATH}/${remoteUid}`);
        let snapshot = null;
        let committed = false;
        try {
          const result = await runTransaction(targetRef, (current) => {
            const nowTs = now();
            if (current && current.token && current.token !== remoteToken && !isRemoteStale(current)) {
              snapshot = current;
              return undefined; // ì¶©ëŒ ì‹œ ê¸°ì¡´ ì„¸ì…˜ì„ ìœ ì§€í•˜ê³  íŠ¸ëœì­ì…˜ì„ ì¤‘ë‹¨
            }
            return {
              token: remoteToken,
              deviceId: remoteDeviceId,
              deviceLabel: describeDevice(),
              createdAt: current?.createdAt || nowTs,
              updatedAt: nowTs,
              ua: (navigator.userAgent || '').slice(0, 120)
            };
          }, { applyLocally: false });
          committed = result.committed;
          if (!snapshot) snapshot = result.snapshot?.val() || null;
        } catch (err) {
          console.warn('ì›ê²© ì„¸ì…˜ í™•ë³´ ì‹¤íŒ¨', err);
        }
        if (committed) {
          remoteRef = targetRef;
          remoteClaimed = true;
          snapshot = null;
          setRemoteBlockedState(false);
          setupRemoteDisconnect();
          startRemoteHeartbeat();
          attachRemoteWatcher();
          return true;
        }
        remoteClaimed = false;
        if (snapshot) {
          setRemoteBlockedState(true, snapshot);
        } else {
          scheduleRemoteRetry();
        }
        return false;
      };
      const ensureRemoteMonitor = (uid) => {
        if (!uid) {
          releaseRemoteSession();
          return;
        }
        if (remoteUid === uid) {
          if (remoteBlocked || !remoteClaimed) {
            attemptRemoteClaim();
          }
          return;
        }
        releaseRemoteSession();
        remoteUid = uid;
        remoteToken = null;
        remoteRef = null;
        remoteClaimed = false;
        remoteInfo = null;
        attemptRemoteClaim();
      };

      const ensureToken = () => {
        if (!token) token = makeToken();
      };

      const isStale = (info) => {
        if (!info || !info.ts) return false;
        const age = now() - info.ts;
        if (!Number.isFinite(age)) return false;
        return age > STALE_THRESHOLD;
      };

      const takeLock = () => {
        ensureToken();
        hasLock = true;
        stopRetry();
        localBlockActive = false;
        updateStatus(null);
        overlayHide();
        runDeferredInitIfReady();
        startHeartbeat();
        applyPlayState();
      };

      const showLock = (info) => {
        localBlockActive = true;
        const enriched = {
          ...(info || {}),
          blockSource: 'local'
        };
        if (!enriched.ts) {
          enriched.ts = now();
        }
        if (!enriched.deviceLabel) {
          enriched.deviceLabel = 'í˜„ì¬ ê¸°ê¸°';
        }
        hardBlockJsExecution(enriched);
      };

      const attemptClaim = (existingInfo, fromRetry = false) => {
        if (!currentUid || bypassed) return false;
        ensureToken();
        const info = existingInfo ?? readLock();
        if (!info) {
          takeLock();
          return true;
        }
        if (info.token === token) {
          takeLock();
          return true;
        }
        if (isStale(info)) {
          takeLock();
          return true;
        }
        showLock(info);
        return false;
      };

      const handleStorage = (ev) => {
        if (!currentUid || bypassed) return;
        if (ev.key !== getKey(currentUid)) return;
        const info = parseValue(ev.newValue);
        if (attemptClaim(info)) return;
        showLock(info);
      };

      const handleBeforeUnload = () => {
        if (!currentUid || bypassed) return;
        if (hasLock) removeLockIfOwned();
      };

      const ensureListeners = () => {
        if (listenersAttached) return;
        window.addEventListener('storage', handleStorage);
        window.addEventListener('beforeunload', handleBeforeUnload);
        listenersAttached = true;
      };
      const removeListeners = () => {
        if (!listenersAttached) return;
        window.removeEventListener('storage', handleStorage);
        window.removeEventListener('beforeunload', handleBeforeUnload);
        listenersAttached = false;
      };

      const setBypassed = (value) => {
        if (bypassed === value) return;
        bypassed = value;
        if (bypassed) {
          stopHeartbeat();
          stopRetry();
          hasLock = false;
          overlayHide();
          runDeferredInitIfReady();
          applyPlayState();
        } else if (currentUid) {
          attemptClaim();
        } else {
          applyPlayState();
        }
      };

      function release() {
        releaseRemoteSession();
        if (hasLock && !bypassed) {
          removeLockIfOwned();
        }
        stopHeartbeat();
        stopRetry();
        hasLock = false;
        currentUid = null;
        token = null;
        bypassed = false;
        localBlockActive = false;
        overlayHide();
        removeListeners();
        applyPlayState();
      }

      function activate(uid) {
        if (!uid) {
          release();
          return;
        }
        ensureListeners();
        if (currentUid === uid) {
          ensureRemoteMonitor(uid);
          if (!bypassed) {
            attemptClaim();
          } else {
            applyPlayState();
          }
          return;
        }
        release();
        ensureListeners();
        currentUid = uid;
        bypassed = false;
        token = null;
        hasLock = false;
        ensureRemoteMonitor(uid);
        applyPlayState();
        attemptClaim();
      }

      const showAdminPanel = () => {
        if (!adminBox) return;
        adminBox.classList.add('show');
        adminBox.setAttribute('aria-hidden', 'false');
        if (adminError) adminError.textContent = '';
        if (statusEl) statusEl.textContent = '';
        setTimeout(() => adminIdEl && adminIdEl.focus(), 60);
      };

      const openAdminPanelExternal = (options = {}) => {
        overlayShow();
        showAdminPanel();
        if (statusEl) {
          const message = options && typeof options.message === 'string'
            ? options.message
            : 'ê´€ë¦¬ì ì¸ì¦ì„ ì™„ë£Œí•˜ë©´ ê³„ì† ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
          statusEl.textContent = message;
        }
      };

      let holdTimer = null;
      let holdSuccess = false;
      let holdOpened = false;

      const startAdminHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        holdSuccess = false;
        holdOpened = false;
        holdTimer = setTimeout(() => {
          holdSuccess = true;
          showAdminPanel();
        }, 2000);
      };

      const cancelAdminHold = () => {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        const wasActivated = holdSuccess;
        holdSuccess = false;
        holdOpened = wasActivated;
        return wasActivated;
      };

      const runAdminProgress = async (task) => {
        if (!adminProgress || !adminSubmit || !adminIdEl || !adminPwEl) {
          await task();
          return;
        }
        if (adminSubmit.disabled) return;
        const seconds = 10 + Math.floor(Math.random() * 11);
        let dots = 0;
        adminProgress.classList.add('show');
        adminProgress.textContent = 'Login in progress';
        adminSubmit.disabled = true;
        adminIdEl.disabled = true;
        adminPwEl.disabled = true;
        const dotTimer = setInterval(() => {
          dots = (dots + 1) % 4;
          adminProgress.textContent = 'Login in progress' + '.'.repeat(dots);
        }, 420);

        await new Promise((resolve) => {
          setTimeout(resolve, seconds * 1000);
        });

        try {
          await task();
        } finally {
          clearInterval(dotTimer);
          adminProgress.classList.remove('show');
          adminProgress.textContent = '';
          adminSubmit.disabled = false;
          adminIdEl.disabled = false;
          adminPwEl.disabled = false;
        }
      };

      const emitAdminFailure = (context) => {
        const suffix = Math.floor(1000 + Math.random() * 9000);
        const code = `ADM-${context}-${suffix}`;
        const message = `[${code}] ê´€ë¦¬ì ì¸ì¦ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì…ë ¥ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
        if (adminError) adminError.textContent = message;
        alert(`${message}\n\nì˜¤ë¥˜ê°€ ê³„ì†ë˜ë©´ ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
        return code;
      };

      const handleAdminSubmit = async () => {
        if (!adminIdEl || !adminPwEl) return;
        const id = adminIdEl.value.trim();
        const pw = adminPwEl.value;
        if (!id || !pw) {
          if (adminError) adminError.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (typeof window.__verifyGameAdmin !== 'function') {
          if (adminError) adminError.textContent = 'ê´€ë¦¬ì ì¸ì¦ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }
        if (adminError) adminError.textContent = '';
        await runAdminProgress(async () => {
          try {
            const ok = await window.__verifyGameAdmin(id, pw);
            if (ok) {
              adminIdEl.value = '';
              adminPwEl.value = '';
              setBypassed(true);
              window.dispatchEvent(new CustomEvent('game-admin-auth-success', { detail: { context: 'session-lock' } }));
              alert('login succesful');
            } else {
              const code = emitAdminFailure('SL');
              adminPwEl.value = '';
              adminPwEl.focus();
              window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'session-lock', code } }));
            }
          } catch (err) {
            console.error('Session lock admin verification failed', err);
            const suffix = Math.floor(1000 + Math.random() * 9000);
            const code = `ADM-SL-${suffix}`;
            const message = `[${code}] ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
            if (adminError) adminError.textContent = message;
            alert(`${message}\n\nì§€ì†ë  ê²½ìš° ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
            if (adminPwEl) {
              adminPwEl.value = '';
              adminPwEl.focus();
            }
            window.dispatchEvent(new CustomEvent('game-admin-auth-failed', { detail: { context: 'session-lock', code, fatal: true } }));
          }
        });
      };

      retryBtn && retryBtn.addEventListener('click', () => {
        attemptClaim();
        attemptRemoteClaim();
      });
      remoteLogoutBtn && remoteLogoutBtn.addEventListener('click', async () => {
        if (!remoteUid || remoteLogoutPending) return;
        const confirmed = confirm('ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë™ì¼ ê³„ì •ì„ ê°•ì œë¡œ ë¡œê·¸ì•„ì›ƒí• ê¹Œìš”? ì´ ê¸°ê¸°ë§Œ ì ‘ì†í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.');
        if (!confirmed) return;
        remoteLogoutPending = true;
        updateRemoteLogoutVisibility();
        try {
          await remove(ref(sessionDb, `${REMOTE_SESSION_PATH}/${remoteUid}`));
          if (statusEl) statusEl.textContent = 'ì›ê²© ë¡œê·¸ì•„ì›ƒì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        } catch (err) {
          console.error('ì›ê²© ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨', err);
          alert('ì›ê²© ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        } finally {
          remoteLogoutPending = false;
          updateRemoteLogoutVisibility();
        }
        setTimeout(() => { if (remoteUid) attemptRemoteClaim(); }, 800);
      });
      if (adminToggle) {
        adminToggle.addEventListener('mousedown', startAdminHold);
        adminToggle.addEventListener('touchstart', startAdminHold, { passive: true });
        const endHold = (ev) => {
          const opened = cancelAdminHold();
          if (!opened) {
            ev.preventDefault();
            if (statusEl) {
              statusEl.textContent = 'ê´€ë¦¬ì ì¸ì¦ íŒ¨ë„ì€ ë²„íŠ¼ì„ ê¸¸ê²Œ ëˆ„ë¥´ê±°ë‚˜ Ctrl+Shift+1 ë‹¨ì¶•í‚¤ë¡œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
          }
        };
        ['mouseup','mouseleave','touchend','touchcancel'].forEach((type) => {
          adminToggle.addEventListener(type, endHold);
        });
        adminToggle.addEventListener('blur', cancelAdminHold);
        adminToggle.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            if (!holdTimer) {
              startAdminHold();
            }
          }
        });
        adminToggle.addEventListener('keyup', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') {
            const opened = cancelAdminHold();
            if (!opened) {
              ev.preventDefault();
              if (statusEl) {
                statusEl.textContent = 'ê´€ë¦¬ì ì¸ì¦ íŒ¨ë„ì€ ë²„íŠ¼ì„ ê¸¸ê²Œ ëˆ„ë¥´ê±°ë‚˜ Ctrl+Shift+1 ë‹¨ì¶•í‚¤ë¡œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
              }
            }
          }
        });
        adminToggle.addEventListener('click', (ev) => {
          if (!holdOpened) {
            ev.preventDefault();
          }
          holdOpened = false;
        });
      }
      window.addEventListener('keydown', (ev) => {
        if (ev.ctrlKey && ev.shiftKey && ev.code === 'Digit1') {
          ev.preventDefault();
          showAdminPanel();
        }
      });
      if (adminIdEl) {
        adminIdEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      if (adminPwEl) {
        adminPwEl.addEventListener('input', () => { if (adminError) adminError.textContent = ''; });
      }
      adminSubmit && adminSubmit.addEventListener('click', handleAdminSubmit);
      adminPwEl && adminPwEl.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          handleAdminSubmit();
        }
      });
      hardBlockReloadBtn && hardBlockReloadBtn.addEventListener('click', () => {
        location.reload();
      });

      window.__SESSION_LOCK__ = {
        activate,
        release,
        bypass: setBypassed,
        openAdminPanel: openAdminPanelExternal
      };

      if (window.__CURRENT_USER_UID) {
        activate(window.__CURRENT_USER_UID);
      } else {
        applyPlayState();
      }
    })();
  </script>

  <!-- ì‘ì€ ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ -->
  <script>
    (() => {
      const snowLayer = document.getElementById('snow-layer');
      if (!snowLayer) return;
      const flakeCount = 60;
      for (let i = 0; i < flakeCount; i++) {
        const flake = document.createElement('span');
        flake.className = 'snowflake';
        const size = 2 + Math.random() * 2;
        const duration = 7 + Math.random() * 6;
        const delay = Math.random() * -duration;
        flake.style.width = `${size}px`;
        flake.style.height = `${size}px`;
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.animationDuration = `${duration}s`;
        flake.style.animationDelay = `${delay}s`;
        flake.style.setProperty('--drift', `${(Math.random() * 40 - 20).toFixed(1)}px`);
        flake.style.opacity = (0.45 + Math.random() * 0.35).toFixed(2);
        snowLayer.appendChild(flake);
      }
    })();
  </script>

  <!-- ğŸ“ ì •ì±…(inframe) ì˜¤ë²„ë ˆì´ ì—´ê¸°/ë‹«ê¸° -->
  <script>
    (function () {
      const overlay   = document.getElementById('policy-overlay');
      const frame     = document.getElementById('policy-frame');
      const closeBtn  = document.getElementById('policy-close');
      const newTabBtn = document.getElementById('policy-open-new');
      const titleEl   = document.getElementById('policy-title');
      const triggers  = document.querySelectorAll('[data-policy]');

      const POLICY_META = {
        terms:   { url: '/terms.html',   title: 'ì´ìš©ì•½ê´€' },
        privacy: { url: '/privacy', title: 'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨' }
      };

      function resolveMeta(kind) {
        return POLICY_META[kind] || POLICY_META.terms;
      }

      function openPolicy(kind) {
        if (!overlay) return;
        const meta = resolveMeta(kind);
        const baseUrl = meta.url + (location.search || '') + (location.hash || '');
        if (frame) {
          if (frame.dataset.current !== meta.url) {
            frame.src = baseUrl;
            frame.dataset.current = meta.url;
          }
        }
        if (titleEl) titleEl.textContent = meta.title;
        if (newTabBtn) newTabBtn.href = meta.url;
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
      }

      function closePolicy() {
        if (!overlay) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }

      triggers.forEach((el) => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          const kind = el.getAttribute('data-policy') || 'terms';
          openPolicy(kind);
        });
      });

      closeBtn  && closeBtn.addEventListener('click', closePolicy);
      overlay   && overlay.addEventListener('click', (e) => { if (e.target === overlay) closePolicy(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePolicy(); });
    })();
  </script>

</body>
</html>
