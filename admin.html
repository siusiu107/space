<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ›  ê´€ë¦¬ì íŒ¨ë„ - íƒœì–‘ê³„ ì •ë³µ</title>
<style>
  :root{
    --bg:#0b1220; --card:rgba(255,255,255,0.06);
    --stroke:rgba(255,255,255,0.12);
    --accent:#00c0ff; --ok:#20df9e; --warn:#ffd36e; --err:#ff7b7b;
  }
  body{ margin:0; padding:24px; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; color:#eaf6ff; background:var(--bg); }
  h1{ margin:0 0 16px; font-size:20px; color:var(--accent); }
  .card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:16px; margin-bottom:16px; }
  label{ display:block; margin:8px 0 4px; font-weight:700; }
  input, select{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:rgba(0,0,0,0.25); color:#fff; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
  button{ padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:linear-gradient(180deg,#00c0ff,#00a2ff); color:#001218; font-weight:900; cursor:pointer; }
  button.secondary{ background:transparent; color:#eaf6ff; }
  button.warn{ background:linear-gradient(180deg,#ffd36e,#ffb347); color:#3b1a00; }
  button.danger{ background:linear-gradient(180deg,#ff7b7b,#ff5f5f); color:#2b0000; }
  .muted{ color:#9fdcff; font-size:12px; }
  .hidden{ display:none; }
  #toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(10,12,20,.9); border:1px solid var(--stroke); border-radius:12px; padding:8px 12px; display:none; z-index:9999; }
  .kv{ display:grid; grid-template-columns:140px 1fr; gap:6px 8px; margin-top:8px; font-size:14px; }
  .kv b{ color:#dffaff; }
  .note{ font-size:12px; color:#cfe6ff; margin-top:6px; }
</style>
</head>
<body>
  <h1>ğŸ›  ê´€ë¦¬ì íŒ¨ë„</h1>

  <div class="card" id="auth-card">
    <div id="auth-state" class="muted">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
    <div id="no-perm" class="hidden" style="color:#ffdede; margin-top:8px; font-weight:800;">ì´ í˜ì´ì§€ë¥¼ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!</div>
  </div>

  <div class="card hidden" id="search-card">
    <h2 style="margin:0 0 10px;">ğŸ” ì‚¬ìš©ì ê²€ìƒ‰</h2>
    <div class="row">
      <div>
        <label>ì´ë©”ì¼</label>
        <input id="q-email" type="email" placeholder="user@example.com" />
      </div>
      <div>
        <label>UID</label>
        <input id="q-uid" type="text" placeholder="Firebase UID" />
      </div>
    </div>
    <div class="btnbar">
      <button id="btn-search">ê²€ìƒ‰</button>
      <button id="btn-clear" class="secondary">ì´ˆê¸°í™”</button>
    </div>
    <div id="search-note" class="note">email ë˜ëŠ” uid ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.</div>
  </div>

  <div class="card hidden" id="result-card">
    <h2 style="margin:0 0 10px;">ğŸ‘¤ ì‚¬ìš©ì ìƒíƒœ</h2>
    <div class="kv">
      <div><b>UID</b></div><div id="out-uid">-</div>
      <div><b>Email</b></div><div id="out-email">-</div>
      <div><b>Auth Disabled</b></div><div id="out-disabled">-</div>
      <div><b>Base Path</b></div><div id="out-base">-</div>
      <div><b>Tried Paths</b></div><div id="out-tried" style="word-break:break-all;">-</div>
    </div>
  </div>

  <div class="card hidden" id="edit-card">
    <h2 style="margin:0 0 10px;">ğŸ§© ê²Œì„ ë°ì´í„° / ë³´ì•ˆ ìˆ˜ì •</h2>

    <div class="row">
      <div>
        <label>ìì›(resources)</label>
        <input id="in-resources" type="number" step="1" />
      </div>
      <div>
        <label>ì½”ì¸(coins)</label>
        <input id="in-coins" type="number" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ì´ë²¤íŠ¸ì½”ì¸(eventCoins)</label>
        <input id="in-eco" type="number" step="1" />
      </div>
      <div>
        <label>í´ë¦­íŒŒì›Œ(clickPower)</label>
        <input id="in-click" type="number" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ìš°ì£¼ì„  ë ™(shipLevel)</label>
        <input id="in-ship" type="number" step="1" />
      </div>
      <div>
        <label>ì—…ê¸€ ë¹„ìš©(shipUpgradeCost)</label>
        <input id="in-shipcost" type="number" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ì•Œë°” ìˆ˜(workerCount)</label>
        <input id="in-worker" type="number" step="1" />
      </div>
      <div>
        <label>ì½”ì¸ ì•Œë°” ìˆ˜(conversionCount)</label>
        <input id="in-conv" type="number" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ì˜ì‹¬ë„(suspicion)</label>
        <input id="in-sus" type="number" step="1" />
      </div>
      <div>
        <label>ì •ì§€(banned)</label>
        <select id="in-banned">
          <option value="false">false</option>
          <option value="true">true</option>
        </select>
      </div>
    </div>

    <div class="btnbar">
      <button id="btn-save">ì €ì¥</button>
      <button id="btn-sus0" class="secondary">ì˜ì‹¬ë„ 0ìœ¼ë¡œ</button>
      <button id="btn-unban" class="warn">ì •ì§€ í•´ì œ & ì˜ì‹¬ë„ 10</button>
      <button id="btn-reactivate" class="warn">ê³„ì • ì¬í™œì„±í™”(Auth+RTDB)</button>
    </div>
    <div class="note">â€» ì €ì¥ì€ ì¼ë¶€ ì…ë ¥ëœ í•„ë“œë§Œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
  </div>

  <div id="toast"></div>

  <!-- Firebase v9 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-functions.js";

    // === ê²Œì„ê³¼ ë™ì¼í•œ ì„¤ì • ì‚¬ìš© ===
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app, "asia-northeast3");

    const ADMIN_EMAIL = "siu46852579@gmail.com";

    // === UI refs ===
    const elAuthState = document.getElementById("auth-state");
    const elNoPerm = document.getElementById("no-perm");
    const cardSearch = document.getElementById("search-card");
    const cardResult = document.getElementById("result-card");
    const cardEdit = document.getElementById("edit-card");

    const qEmail = document.getElementById("q-email");
    const qUid   = document.getElementById("q-uid");
    const btnSearch = document.getElementById("btn-search");
    const btnClear  = document.getElementById("btn-clear");

    const outUid = document.getElementById("out-uid");
    const outEmail = document.getElementById("out-email");
    const outDisabled = document.getElementById("out-disabled");
    const outBase = document.getElementById("out-base");
    const outTried = document.getElementById("out-tried");

    const inResources = document.getElementById("in-resources");
    const inCoins = document.getElementById("in-coins");
    const inEco = document.getElementById("in-eco");
    const inClick = document.getElementById("in-click");
    const inShip = document.getElementById("in-ship");
    const inShipCost = document.getElementById("in-shipcost");
    const inWorker = document.getElementById("in-worker");
    const inConv = document.getElementById("in-conv");
    const inSus = document.getElementById("in-sus");
    const inBanned = document.getElementById("in-banned");

    const btnSave = document.getElementById("btn-save");
    const btnSus0 = document.getElementById("btn-sus0");
    const btnUnban = document.getElementById("btn-unban");
    const btnReactivate = document.getElementById("btn-reactivate");

    let current = { uid:null, email:null, basePath:null, disabled:null };

    function toast(msg, ms=2200){
      const t = document.getElementById("toast");
      t.textContent = msg; t.style.display = "block";
      setTimeout(()=>{ t.style.display="none"; }, ms);
    }

    function showCards(can){
      cardSearch.classList.toggle("hidden", !can);
      cardResult.classList.toggle("hidden", !can);
      cardEdit.classList.toggle("hidden", !can);
    }

    async function ensureSignedIn(){
      return new Promise(async (resolve)=>{
        onAuthStateChanged(auth, async (u)=>{
          if(!u){
            elAuthState.textContent = "êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”(ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥).";
            const provider = new GoogleAuthProvider();
            try{
              await signInWithPopup(auth, provider);
            }catch(e){
              elAuthState.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            }
            return;
          }
          // í† í° ìƒˆë¡œê³ ì¹¨(ì»¤ìŠ¤í…€ í´ë ˆì„ ë°˜ì˜ìš©)
          try { await u.getIdToken(true); } catch {}
          const token = await u.getIdTokenResult().then(r=>r?.claims||{});
          const isAdmin = token.admin === true || (u.email && u.email.toLowerCase() === ADMIN_EMAIL);
          elAuthState.textContent = `ë¡œê·¸ì¸: ${u.email || u.uid}`;
          if(!isAdmin){
            elNoPerm.classList.remove("hidden");
            showCards(false);
            return resolve(false);
          }
          elNoPerm.classList.add("hidden");
          showCards(true);
          resolve(true);
        });
      });
    }

    // === Callable helpers ===
    const callFind = httpsCallable(functions, "adminFindUser");
    const callUpdate = httpsCallable(functions, "adminUpdateUser");
    const callReactivate = httpsCallable(functions, "reactivateUser");

    function fillForm(gameData, security){
      // ìˆ«ì ì•„ë‹Œ ê°’ì€ ê³µë€ ìœ ì§€
      const num = (v)=> (Number.isFinite(Number(v)) ? Number(v) : "");
      inResources.value = num(gameData?.resources);
      inCoins.value     = num(gameData?.coins);
      inEco.value       = num(gameData?.eventCoins);
      inClick.value     = num(gameData?.clickPower);
      inShip.value      = num(gameData?.shipLevel);
      inShipCost.value  = num(gameData?.shipUpgradeCost);
      inWorker.value    = num(gameData?.workerCount);
      inConv.value      = num(gameData?.conversionCount);

      inSus.value       = num(security?.suspicion);
      inBanned.value    = String(!!security?.banned);
    }

    function pickSetPayload(){
      const pickNum = (el)=> {
        const v = el.value.trim();
        if (v==="") return undefined;
        const n = Number(v);
        return Number.isFinite(n) ? n : undefined;
      };
      const gd = {
        resources: pickNum(inResources),
        coins: pickNum(inCoins),
        eventCoins: pickNum(inEco),
        clickPower: pickNum(inClick),
        shipLevel: pickNum(inShip),
        shipUpgradeCost: pickNum(inShipCost),
        workerCount: pickNum(inWorker),
        conversionCount: pickNum(inConv),
      };
      const sec = {
        suspicion: pickNum(inSus),
        banned: (inBanned.value === "true")
      };
      // undefined ì œê±°
      const gdClean = Object.fromEntries(Object.entries(gd).filter(([,v])=>v!==undefined));
      const secClean = Object.fromEntries(Object.entries(sec).filter(([,v])=>v!==undefined));
      return { gameData: gdClean, security: secClean };
    }

    async function doSearch(){
      const email = qEmail.value.trim() || undefined;
      const uid = qUid.value.trim() || undefined;

      if(!email && !uid){
        toast("email ë˜ëŠ” uidë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return;
      }
      try{
        const r = await callFind({ target: { email, uid } });
        const d = r.data || {};
        current.uid = d.targetUid || null;
        current.email = d.targetEmail || null;
        current.basePath = d.basePath || null;
        current.disabled = !!d.disabled;

        outUid.textContent = d.targetUid || "-";
        outEmail.textContent = d.targetEmail || "-";
        outDisabled.textContent = String(!!d.disabled);
        outBase.textContent = d.basePath || "(ë¯¸ë°œê²¬)";
        outTried.textContent = (d.triedPaths && d.triedPaths.length) ? d.triedPaths.join("  â€¢  ") : "-";

        fillForm(d.gameData, d.security);
        toast(d.basePath ? "ì°¾ìŒ!" : "ê²½ë¡œë¥¼ ì§ì ‘ ì°¾ì§€ ëª»í–ˆì–´ìš”. triedPaths í™•ì¸");
      }catch(e){
        console.error(e);
        toast("ê²€ìƒ‰ ì‹¤íŒ¨: " + (e?.message || "unknown"));
      }
    }

    async function doSave(){
      if(!current.uid && !current.email){ toast("ë¨¼ì € ê²€ìƒ‰í•˜ì„¸ìš”."); return; }
      const set = pickSetPayload();
      if (!Object.keys(set.gameData).length && !Object.keys(set.security).length){
        toast("ë³€ê²½í•  ê°’ì´ ì—†ìŠµë‹ˆë‹¤."); return;
      }
      try{
        const r = await callUpdate({ target: { uid: current.uid, email: current.email }, set });
        const d = r.data || {};
        toast(d.updated ? "ì €ì¥ ì™„ë£Œ!" : "ë°˜ì˜í•  ê°’ì´ ì—†ì—ˆìŠµë‹ˆë‹¤.");
        // ì €ì¥ í›„ ì¬ì¡°íšŒ
        await doSearch();
      }catch(e){
        console.error(e);
        toast("ì €ì¥ ì‹¤íŒ¨: " + (e?.message || "unknown"));
      }
    }

    async function doUnban(){
      if(!current.uid && !current.email){ toast("ë¨¼ì € ê²€ìƒ‰í•˜ì„¸ìš”."); return; }
      try{
        // RTDBë§Œ ì™„í™”í•´ë„ ë˜ì§€ë§Œ, ì‹¤ë¬´ì—ì„  Auth disabledë„ í•¨ê»˜ í•´ì œí•˜ëŠ”ê²Œ ì•ˆì „
        const r = await callReactivate({
          target: { uid: current.uid, email: current.email },
          alsoUnbanInRtdb: true,
          suspicionTo: 10
        });
        toast("ì •ì§€ í•´ì œ + ì˜ì‹¬ë„ 10ìœ¼ë¡œ ì„¤ì • ì™„ë£Œ!");
        await doSearch();
      }catch(e){
        console.error(e);
        toast("ì •ì§€ í•´ì œ ì‹¤íŒ¨: " + (e?.message || "unknown"));
      }
    }

    async function doReactivate(){
      if(!current.uid && !current.email){ toast("ë¨¼ì € ê²€ìƒ‰í•˜ì„¸ìš”."); return; }
      try{
        const r = await callReactivate({
          target: { uid: current.uid, email: current.email },
          alsoUnbanInRtdb: true,
          suspicionTo: Number.isFinite(Number(inSus.value)) ? Number(inSus.value) : 10
        });
        toast("ê³„ì • ì¬í™œì„±í™” ì™„ë£Œ!");
        await doSearch();
      }catch(e){
        console.error(e);
        toast("ì¬í™œì„±í™” ì‹¤íŒ¨: " + (e?.message || "unknown"));
      }
    }

    // ì˜ì‹¬ë„ 0 ë²„íŠ¼
    btnSus0.addEventListener("click", ()=>{
      inSus.value = "0";
      toast("ì˜ì‹¬ë„ ì…ë ¥ê°’ì„ 0ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. 'ì €ì¥'ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.");
    });

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    btnSearch.addEventListener("click", doSearch);
    btnClear.addEventListener("click", ()=>{
      qEmail.value=""; qUid.value="";
      outUid.textContent = outEmail.textContent = outDisabled.textContent = outBase.textContent = outTried.textContent = "-";
      fillForm({}, {});
      current = { uid:null, email:null, basePath:null, disabled:null };
      toast("ì´ˆê¸°í™” ì™„ë£Œ");
    });
    btnSave.addEventListener("click", doSave);
    btnUnban.addEventListener("click", doUnban);
    btnReactivate.addEventListener("click", doReactivate);

    // ì§„ì… ì‹œ ê¶Œí•œ í™•ì¸
    await ensureSignedIn();
  </script>
</body>
</html>
