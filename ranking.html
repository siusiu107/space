<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ëˆ ë­í‚¹ ğŸŒŒ</title>
  <style>
    body { margin:0; padding:0; font-family:Arial,sans-serif; background:url('images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    #ranking-container { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:20px; border-radius:8px; width:90%; max-width:500px; text-align:center; display:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #444; font-size:14px; }
    th { background:rgba(30,30,30,0.9); }
    td { background:rgba(20,20,20,0.7); }
    tr:nth-child(even) td { background:rgba(20,20,20,0.5); }
    .btn { margin:10px 5px 0; padding:8px 16px; background:#00aaff; border:none; border-radius:4px; color:#fff; cursor:pointer; text-decoration:none; display:inline-block; }
    #nickname-prompt { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; color:#fff; text-align:center; padding-top:20%; }
    input[type="text"], input[type="checkbox"] { margin:6px; padding:6px; border-radius:4px; border:none; font-size:14px; }
    #filter-container { margin-top:10px; }
  </style>
</head>
<body>
  <!-- ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ -->
  <div id="nickname-prompt">
    <h2>ğŸ‰ ë‹‰ë„¤ì„ì„ ìƒì„±í•´ì£¼ì„¸ìš”!</h2>
    <p>ì´ ë‹‰ë„¤ì„ì€ ë­í‚¹ì— í‘œì‹œë˜ë©° <strong>í•œ ë²ˆ ìƒì„±í•˜ë©´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong></p>
    <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
    <br>
    <button class="btn" id="submit-nickname">í™•ì¸</button>
  </div>

  <!-- ë­í‚¹ ì»¨í…Œì´ë„ˆ -->
  <div id="ranking-container">
    <h1>ğŸ’° ì½”ì¸ ë­í‚¹ Top 50</h1>
    <div id="filter-container">
      <label>
        <input type="checkbox" id="toggle-no-nickname" checked>
        ë‹‰ë„¤ì„ ì—†ëŠ” ì‚¬ìš©ì í‘œì‹œ
      </label>
    </div>
    <table>
      <thead>
        <tr><th>ìˆœìœ„</th><th>ë‹‰ë„¤ì„</th><th>ì½”ì¸</th></tr>
      </thead>
      <tbody id="ranking-body">
        <!-- ìˆœìœ„ í•­ëª©ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
      </tbody>
    </table>
    <button id="logout-btn" class="btn">ë¡œê·¸ì•„ì›ƒ</button>
    <a href="game.html" class="btn">ê²Œì„ìœ¼ë¡œ</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM ìš”ì†Œ
    const rankingContainer = document.getElementById('ranking-container');
    const rankingBody = document.getElementById('ranking-body');
    const nicknamePrompt = document.getElementById('nickname-prompt');
    const nicknameInput = document.getElementById('nickname-input');
    const submitBtn = document.getElementById('submit-nickname');
    const toggleNoNick = document.getElementById('toggle-no-nickname');
    let rankingList = [];

    // ì¸ì¦ ìƒíƒœ í™•ì¸
    onAuthStateChanged(auth, async user => {
      if (!user) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”');
        window.location.href = 'game.html';
        return;
      }
      const profileRef = ref(db, `users/${user.uid}/profile/nickname`);
      const snap = await get(profileRef);
      if (!snap.exists()) {
        // ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
        nicknamePrompt.style.display = 'block';
        submitBtn.onclick = async () => {
          const nick = nicknameInput.value.trim();
          if (!nick) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          await set(profileRef, nick);
          nicknamePrompt.style.display = 'none';
          initRanking();
        };
      } else {
        initRanking();
      }
    });

    // ë­í‚¹ ì´ˆê¸°í™”
    function initRanking() {
      nicknamePrompt.style.display = 'none';
      rankingContainer.style.display = 'block';
      loadRanking();
      toggleNoNick.addEventListener('change', renderRanking);
    }

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    document.getElementById('logout-btn').addEventListener('click', () => {
      signOut(auth).then(() => {
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
        window.location.href = 'game.html';
      });
    });

    // ë­í‚¹ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadRanking() {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      rankingList = [];
      snapshot.forEach(userSnap => {
        const profile = userSnap.child('profile').val() || {};
        const data = userSnap.child('gameData').val() || {};
        const coins = data.coins || 0;
        const nickname = profile.nickname || '';
        rankingList.push({ nickname, coins: Math.floor(coins) });
      });
      rankingList.sort((a, b) => b.coins - a.coins);
      renderRanking();
    }

    // ë­í‚¹ ë Œë”ë§
    function renderRanking() {
      const showNoNick = toggleNoNick.checked;
      rankingBody.innerHTML = '';
      let rank = 1;
      for (const item of rankingList) {
        if (!showNoNick && !item.nickname) continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${item.nickname || 'ë‹‰ë„¤ì„ ì—†ìŒ'}</td>
          <td>${item.coins}</td>
        `;
        rankingBody.appendChild(tr);
        rank++;
        if (rank > 50) break;
      }
    }
  </script>

  <!-- ê°œë°œì ë„êµ¬ ì°¨ë‹¨ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({
      disableMenu: true,
      disableSelect: true,
      disableCopy: true,
      disableCut: true,
      disablePaste: true,
      clearIntervalWhenDevOpenTrigger: true,
      ondevtoolopen(type, next) {
        window.close();
        next();
      },
      ondevtoolclose() {
        console.warn('DevTools ë‹«í˜ ê°ì§€ë¨');
      }
    });
  </script>
</body>
</html>
