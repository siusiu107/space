<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒŒ íƒœì–‘ê³„ ì •ë³µ: ëˆ ë­í‚¹ ğŸŒŒ</title>
  <script>
    try { history.replaceState(null, '', '/ë­í‚¹' + (location.hash || '')); }
    catch(e){ console.warn('ì£¼ì†Œ í‘œì‹œ ë³€ê²½ ì‹¤íŒ¨:', e); }
  </script>

  <style>
    body { margin:0; padding:0; font-family:Arial,sans-serif; background:url('images/space-bg.jpg') center/cover no-repeat; color:#fff; }
    #ranking-container { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:20px; border-radius:8px; width:90%; max-width:500px; text-align:center; display:none; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #444; font-size:14px; }
    th { background:rgba(30,30,30,0.9); }
    td { background:rgba(20,20,20,0.7); }
    tr:nth-child(even) td { background:rgba(20,20,20,0.5); }
    .btn { margin:10px 5px 0; padding:8px 16px; background:#00aaff; border:none; border-radius:4px; color:#fff; cursor:pointer; text-decoration:none; display:inline-block; }
    #nickname-prompt { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; color:#fff; text-align:center; padding-top:20%; }
    input[type="text"], input[type="checkbox"] { margin:6px; padding:6px; border-radius:4px; border:none; font-size:14px; }
    #filter-container { margin-top:10px; }
  </style>
</head>
<body>
  <!-- ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ -->
  <div id="nickname-prompt">
    <h2>ğŸ‰ ë‹‰ë„¤ì„ì„ ìƒì„±í•´ì£¼ì„¸ìš”!</h2>
    <p>ì´ ë‹‰ë„¤ì„ì€ ë­í‚¹ì— í‘œì‹œë˜ë©° <strong>í•œ ë²ˆ ìƒì„±í•˜ë©´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong></p>
    <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" />
    <br>
    <button class="btn" id="submit-nickname">í™•ì¸</button>
  </div>

  <!-- ë­í‚¹ ì»¨í…Œì´ë„ˆ -->
  <div id="ranking-container">
    <h1>ğŸ’° ì½”ì¸ ë­í‚¹ Top 50</h1>
    <div id="filter-container">
      <label>
        <input type="checkbox" id="toggle-no-nickname" checked>
        ë‹‰ë„¤ì„ ì—†ëŠ” ì‚¬ìš©ì í‘œì‹œ
      </label>
    </div>
    <table>
      <thead>
        <tr><th>ìˆœìœ„</th><th>ë‹‰ë„¤ì„</th><th>ì½”ì¸</th></tr>
      </thead>
      <tbody id="ranking-body"></tbody>
    </table>
    <button id="logout-btn" class="btn">ë¡œê·¸ì•„ì›ƒ</button>
    <a href="game.html" class="btn">ê²Œì„ìœ¼ë¡œ</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const rankingContainer = document.getElementById('ranking-container');
    const rankingBody = document.getElementById('ranking-body');
    const nicknamePrompt = document.getElementById('nickname-prompt');
    const nicknameInput = document.getElementById('nickname-input');
    const submitBtn = document.getElementById('submit-nickname');
    const toggleNoNick = document.getElementById('toggle-no-nickname');
    let rankingList = [];

    // ğŸ” ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ game.htmlì„ íŒì—…ìœ¼ë¡œ ë„ì›Œ postMessage ë¡œê·¸ì¸ ì§„í–‰
    function openLoginPopupAndWire() {
      const LOGIN_ORIGIN = location.origin;   // ê°™ì€ ì˜¤ë¦¬ì§„ ê¸°ì¤€
      const RETURN_URL   = location.href;     // ë¡œê·¸ì¸ ì„±ê³µ í›„ ë‹¤ì‹œ ì´ í˜ì´ì§€ë¡œ

      const w = 1024, h = 768;
      const left = Math.max(0, (screen.width - w) / 2 | 0);
      const top  = Math.max(0, (screen.height - h) / 2 | 0);
      const popup = window.open(
        `${LOGIN_ORIGIN}/game.html`,
        'gameWindow',
        `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );
      const state = (crypto?.randomUUID && crypto.randomUUID()) || String(Math.random());

      function isAllowedRedirect(urlStr){
        try{
          const u = new URL(urlStr);
          if(u.protocol !== 'https:') return false;
          const host = u.hostname;
          const base1 = 'xn--989a202a4ogwtc69p.siustudio.kro.kr';
          const base2 = 'siustudio.kro.kr';
          return (host === base1 || host === base2 || host.endsWith('.'+base1) || host.endsWith('.'+base2));
        }catch{return false;}
      }

      function sendInit(){
        if(!popup || popup.closed) return;
        popup.postMessage({ type:'init-login', redirect: RETURN_URL, state }, LOGIN_ORIGIN);
      }

      window.addEventListener('message', (e) => {
        if(e.origin !== LOGIN_ORIGIN) return;
        const { type, ok, receivedState, redirect, message } = e.data || {};
        if(type === 'login-ready'){ sendInit(); return; }
        if(type === 'auth-success' && ok && receivedState === state){
          try{ popup.close(); }catch{}
          const target = isAllowedRedirect(redirect||RETURN_URL) ? (redirect||RETURN_URL) : RETURN_URL;
          window.location.href = target; // ranking.html ì¬ì§„ì… â†’ onAuthStateChangedì—ì„œ user ê°ì§€
          return;
        }
        if(type === 'auth-error'){
          try{ popup.close(); }catch{}
          alert(message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { openLoginPopupAndWire(); return; }

      const profileRef = ref(db, `users/${user.uid}/profile/nickname`);
      const snap = await get(profileRef);
      if (!snap.exists()) {
        nicknamePrompt.style.display = 'block';
        submitBtn.onclick = async () => {
          const nick = nicknameInput.value.trim();
          if (!nick) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          await set(profileRef, nick);
          nicknamePrompt.style.display = 'none';
          initRanking();
        };
      } else {
        initRanking();
      }
    });

    function initRanking() {
      nicknamePrompt.style.display = 'none';
      rankingContainer.style.display = 'block';
      loadRanking();
      toggleNoNick.addEventListener('change', renderRanking);
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
      signOut(auth).then(() => {
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
        window.location.href = 'game.html';
      });
    });

    async function loadRanking() {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      rankingList = [];
      snapshot.forEach(userSnap => {
        const profile = userSnap.child('profile').val() || {};
        const data = userSnap.child('gameData').val() || {};
        const coins = data.coins || 0;
        const nickname = profile.nickname || '';
        rankingList.push({ nickname, coins: Math.floor(coins) });
      });
      rankingList.sort((a, b) => b.coins - a.coins);
      renderRanking();
    }

    function renderRanking() {
      const showNoNick = toggleNoNick.checked;
      rankingBody.innerHTML = '';
      let rank = 1;
      for (const item of rankingList) {
        if (!showNoNick && !item.nickname) continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${item.nickname || 'ë‹‰ë„¤ì„ ì—†ìŒ'}</td>
          <td>${item.coins}</td>
        `;
        rankingBody.appendChild(tr);
        rank++;
        if (rank > 50) break;
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/disable-devtool@latest"></script>
  <script>
    DisableDevtool({
      disableMenu: true,
      disableSelect: true,
      disableCopy: true,
      disableCut: true,
      disablePaste: true,
      clearIntervalWhenDevOpenTrigger: true,
      ondevtoolopen(type, next) {
        window.close();
        next();
      },
      ondevtoolclose() {
        console.warn('DevTools ë‹«í˜ ê°ì§€ë¨');
      }
    });
  </script>
  <script>
    // ìš°í´ë¦­ ì „ì²´ ì°¨ë‹¨(ì…ë ¥ ìš”ì†ŒëŠ” ì˜ˆì™¸)
    document.addEventListener('contextmenu', function (e) {
      if (e.target.closest('input, textarea, [contenteditable="true"])) return;
      e.preventDefault();
    });
  </script>
</body>
</html>
