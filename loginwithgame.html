<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>태양계 정복 · 게임 로그인</title>

  <!-- Firebase SDK (모듈 버전) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // --- Firebase 설정 (게임 / 상점과 동일 프로젝트) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    const $ = (sel) => document.querySelector(sel);

    const card = $("#card");
    const emailInput = $("#email");
    const pwInput = $("#password");
    const msgBox = $("#msg");
    const titleText = $("#title-text");
    const subtitleText = $("#subtitle-text");
    const primaryBtn = $("#primary-btn");
    const googleBtn = $("#google-btn");
    const toggleModeLink = $("#toggle-mode");
    const redirectInfo = $("#redirect-info");
    const loggedInBox = $("#logged-in");
    const loggedInEmail = $("#logged-in-email");
    const backBtn = $("#back-btn");
    const logoutBtn = $("#logout-btn");

    let mode = "login"; // 'login' | 'signup'
    let redirectUrl = "/";
    let autoRedirectTimer = null;

    function setMsg(text) {
      msgBox.textContent = text || "";
    }

    function parseRedirect() {
      const params = new URLSearchParams(window.location.search);
      const r = params.get("redirect");
      if (!r) {
        // redirect 없는 경우 기본은 게임으로
        return "/game.html";
      }
      try {
        const url = new URL(r, window.location.href);
        // 같은 origin이면 그대로 사용
        // (도메인 다르게 써도 보내고 싶으면 이 체크를 제거해도 됨)
        // if (url.origin !== window.location.origin) return "/game.html";
        return url.href;
      } catch {
        return "/game.html";
      }
    }

    function updateModeUI() {
      if (mode === "login") {
        titleText.textContent = "게임 계정으로 로그인";
        subtitleText.textContent = "태양계 정복에서 사용하는 이메일 / 비밀번호 또는 Google 계정으로 로그인해 주세요.";
        primaryBtn.textContent = "로그인";
        toggleModeLink.textContent = "아직 계정이 없다면? 회원가입";
      } else {
        titleText.textContent = "새 게임 계정 만들기";
        subtitleText.textContent = "이메일과 비밀번호를 입력해 새 게임 계정을 생성합니다. 이후 같은 계정으로 게임과 상점에 모두 로그인할 수 있습니다.";
        primaryBtn.textContent = "회원가입 후 로그인";
        toggleModeLink.textContent = "이미 계정이 있다면? 로그인으로 돌아가기";
      }
      setMsg("");
    }

    function switchMode() {
      mode = (mode === "login") ? "signup" : "login";
      updateModeUI();
    }

    function setLoggedInUI(user) {
      $("#auth-box").style.display = "none";
      loggedInBox.style.display = "flex";
      loggedInEmail.textContent = user.email || user.displayName || user.uid;

      setMsg("");

      // 안내 텍스트
      redirectInfo.textContent =
        "로그인이 완료되었습니다. 잠시 후 이전 페이지로 자동 이동합니다.";

      // 1.5초 후 자동 이동
      if (autoRedirectTimer) clearTimeout(autoRedirectTimer);
      autoRedirectTimer = setTimeout(() => {
        window.location.href = redirectUrl;
      }, 1500);
    }

    function setLoggedOutUI() {
      $("#auth-box").style.display = "block";
      loggedInBox.style.display = "none";
      loggedInEmail.textContent = "";
      redirectInfo.textContent = "";
      if (autoRedirectTimer) {
        clearTimeout(autoRedirectTimer);
        autoRedirectTimer = null;
      }
    }

    async function handlePrimarySubmit(ev) {
      ev.preventDefault();
      const email = (emailInput.value || "").trim();
      const pw = (pwInput.value || "").trim();

      if (!email || !pw) {
        setMsg("이메일과 비밀번호를 모두 입력해 주세요.");
        return;
      }

      try {
        setMsg(mode === "login" ? "로그인 중..." : "계정 생성 중...");
        if (mode === "login") {
          await signInWithEmailAndPassword(auth, email, pw);
          setMsg("");
        } else {
          await createUserWithEmailAndPassword(auth, email, pw);
          setMsg("회원가입 완료! 잠시 후 자동으로 이동합니다.");
        }
      } catch (err) {
        console.error(err);
        const code = err.code || "";
        if (code === "auth/user-not-found") {
          setMsg("해당 이메일의 계정을 찾을 수 없습니다. 회원가입을 먼저 진행해 주세요.");
        } else if (code === "auth/wrong-password") {
          setMsg("비밀번호가 올바르지 않습니다.");
        } else if (code === "auth/email-already-in-use") {
          setMsg("이미 사용 중인 이메일입니다. 로그인으로 시도해 주세요.");
        } else if (code === "auth/weak-password") {
          setMsg("비밀번호가 너무 약합니다. 조금 더 복잡하게 설정해 주세요.");
        } else {
          setMsg("오류가 발생했습니다: " + (code || err.message));
        }
      }
    }

    async function handleGoogleLogin() {
      try {
        setMsg("Google 계정으로 로그인 중...");
        await signInWithPopup(auth, googleProvider);
        setMsg("");
      } catch (err) {
        console.error(err);
        const code = err.code || "";
        if (code === "auth/popup-closed-by-user") {
          setMsg("로그인 창이 닫혔습니다. 다시 시도해 주세요.");
        } else {
          setMsg("Google 로그인 중 오류가 발생했습니다: " + (code || err.message));
        }
      }
    }

    function handleBackNow() {
      window.location.href = redirectUrl;
    }

    async function handleLogout() {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
      }
    }

    // 초기 설정
    redirectUrl = parseRedirect();
    const displayRedirect = (() => {
      try {
        const u = new URL(redirectUrl, window.location.href);
        return u.href;
      } catch {
        return redirectUrl;
      }
    })();
    $("#redirect-target").textContent = displayRedirect;

    updateModeUI();

    // 이벤트 바인딩
    primaryBtn.addEventListener("click", handlePrimarySubmit);
    googleBtn.addEventListener("click", handleGoogleLogin);
    toggleModeLink.addEventListener("click", (e) => {
      e.preventDefault();
      switchMode();
    });
    backBtn.addEventListener("click", handleBackNow);
    logoutBtn.addEventListener("click", handleLogout);

    // Auth 상태 감시
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setLoggedInUI(user);
      } else {
        setLoggedOutUI();
      }
    });
  </script>

  <style>
    :root {
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at bottom, #0f172a 0, #020617 55%);
      color: #e5ebff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }
    .card {
      width: 100%;
      max-width: 420px;
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.7);
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.25), transparent 55%),
        radial-gradient(circle at bottom right, rgba(129,140,248,0.2), transparent 60%),
        rgba(15,23,42,0.96);
      box-shadow: 0 24px 60px rgba(15,23,42,0.9);
      padding: 20px 18px 18px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: #9ca3af;
    }
    .logo span.icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #facc15, #f97316 45%, #312e81 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 6px;
    }
    .subtitle {
      margin: 0 0 10px;
      font-size: 13px;
      color: #cbd5f5;
    }
    .redirect-row {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .redirect-row code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      padding: 2px 4px;
      border-radius: 6px;
      color: #e5e7eb;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }
    label {
      font-size: 12px;
      color: #e5e7eb;
    }
    input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    input:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96,165,250,0.7);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease-out;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      border-color: rgba(191,219,254,0.7);
      color: #eff6ff;
      box-shadow: 0 10px 25px rgba(37,99,235,0.6);
      margin-top: 4px;
    }
    .btn-primary:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37,99,235,0.75);
    }
    .btn-google {
      margin-top: 6px;
      background: rgba(15,23,42,0.9);
      border-color: rgba(148,163,184,0.8);
      color: #e5e7eb;
    }
    .btn-google:hover {
      background: rgba(15,23,42,1);
    }
    .google-icon {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      background: conic-gradient(from 45deg, #ea4335 0 25%, #4285f4 25% 50%, #34a853 50% 75%, #fbbc05 75% 100%);
    }
    .toggle-row {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      justify-content: center;
    }
    .toggle-row a {
      color: #c4b5fd;
      text-decoration: underline;
      cursor: pointer;
    }
    #msg {
      margin-top: 6px;
      min-height: 1.2em;
      font-size: 11px;
      color: #f97373;
    }
    .hint {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
    }

    /* 로그인 완료 상태 */
    #logged-in {
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }
    #logged-in-email {
      font-weight: 600;
      color: #dbeafe;
      font-size: 14px;
    }
    .logged-buttons {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .btn-outline {
      background: rgba(15,23,42,0.9);
      border-color: rgba(148,163,184,0.8);
      color: #e5e7eb;
      flex: 1;
    }
    .btn-soft {
      background: rgba(30,64,175,0.8);
      border-color: rgba(191,219,254,0.7);
      color: #eff6ff;
      flex: 1.4;
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="logo">
      <span class="icon">☀️</span>
      <span>태양계 정복 · 게임 로그인</span>
    </div>

    <h1 id="title-text">게임 계정으로 로그인</h1>
    <p class="subtitle" id="subtitle-text">
      태양계 정복에서 사용하는 이메일 / 비밀번호 또는 Google 계정으로 로그인해 주세요.
    </p>

    <div class="redirect-row">
      돌아갈 위치: <code id="redirect-target"></code>
    </div>

    <!-- 로그인 / 회원가입 박스 -->
    <div id="auth-box">
      <div class="field">
        <label for="email">이메일</label>
        <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
      </div>
      <div class="field">
        <label for="password">비밀번호</label>
        <input id="password" type="password" autocomplete="current-password" placeholder="비밀번호" />
      </div>

      <button class="btn btn-primary" id="primary-btn">로그인</button>
      <button class="btn btn-google" id="google-btn">
        <span class="google-icon"></span>
        <span>Google 계정으로 계속하기</span>
      </button>

      <div class="toggle-row">
        <span><a href="#" id="toggle-mode">아직 계정이 없다면? 회원가입</a></span>
      </div>

      <div id="msg"></div>

      <p class="hint">
        이 페이지는 <strong>로그인만 처리</strong>하며, 완료되면 자동으로 이전 화면으로 돌아갑니다.
      </p>
    </div>

    <!-- 로그인 완료 상태 -->
    <div id="logged-in">
      <div>로그인된 계정:</div>
      <div id="logged-in-email"></div>
      <div id="redirect-info" class="hint"></div>
      <div class="logged-buttons">
        <button class="btn btn-soft" id="back-btn">지금 바로 이동</button>
        <button class="btn btn-outline" id="logout-btn">다른 계정으로 로그인</button>
      </div>
    </div>
  </div>
</body>
</html>
