<!-- ====================== setting.html ====================== -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>âš™ï¸ ì„¤ì • - íƒœì–‘ê³„ ì •ë³µ</title>
<style>
  :root{
    --glass: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(6,7,12,0.6));
    --stroke: rgba(255,255,255,0.14);
    --fg:#eaf6ff; --muted:#bcd8ee; --accent:#00c0ff; --accent2:#0099ff; --danger:#ff6b6b;
    --bg:#08111f;
  }
  *{box-sizing:border-box}
  body{margin:0;background:url('/images/space-bg.jpg') center/cover no-repeat fixed, var(--bg);color:var(--fg);font:15px/1.7 Inter,system-ui,Arial}
  a{color:inherit;text-decoration:none}
  #topbar{position:fixed;top:8px;left:8px;right:8px;z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:12px;background:rgba(20,24,34,.78);backdrop-filter:blur(10px);border:1px solid var(--stroke)}
  #back-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.04));border:1px solid var(--stroke);font-weight:800}
  #addr{font-size:12px;color:var(--muted);user-select:none}
  #container{width:min(900px,94vw);margin:74px auto 28px}
  .card{background:var(--glass);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);padding:16px;margin:14px 0}
  h1{margin:0 0 8px;font-size:22px;color:#dff7ff}
  .sub{margin:0 0 18px;font-size:13px;color:var(--muted)}
  .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
        background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));margin:10px 0;gap:12px}
  .left{display:flex;align-items:center;gap:12px}
  .title{font-weight:800}
  .desc{font-size:13px;color:var(--muted)}
  .right{display:flex;align-items:center;gap:8px}
  .btn{padding:10px 12px;border:1px solid var(--stroke);color:#001218;font-weight:800;border-radius:10px;cursor:pointer;background-image: linear-gradient(180deg, var(--accent), var(--accent2))}
  .btn.secondary{color:#e6f7ff;background:none;background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03))}
  .btn.danger{background:none;color:#ffecec;background:linear-gradient(180deg, rgba(255,50,50,.9), rgba(200,0,0,.88));border-color: rgba(255,80,80,.4)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hr{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
  footer{margin:12px 0 24px;text-align:center;color:var(--muted);font-size:12px}

  /* ===== íƒ­ (ì„¤ì •/ì›ê²©ì§€ì›/ê´€ë¦¬ì) ===== */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab-btn{padding:8px 12px;border:1px solid var(--stroke);border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));cursor:pointer}
  .tab-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06222b;font-weight:900}
  .tab-panel{display:none}.tab-panel.active{display:block}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);font-size:.86em}
  .ok{color:#3bd18e}.wait{color:#60a5fa}.end{color:#f87171}
  .chat{display:grid;grid-template-rows:1fr auto;gap:8px;height:260px;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px}
  .msgs{overflow:auto}
  .bubble{max-width:85%;padding:8px 10px;margin:6px 0;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16)}
  .me{margin-left:auto;background:rgba(0,208,255,.16);border-color:rgba(0,208,255,.45)}
  .sys{font-size:.9em;opacity:.95}
  .chat input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#fff}

  /* ===== ê´€ë¦¬ì ë·°ì–´ ===== */
  iframe#view{width:100%;height:520px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:#000}
  .list .item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);margin:8px 0}
  .muted{color:var(--muted)}

  /* ===== ì‚¬ìš©ì íƒ­: ë¯¸ë‹ˆ ë¯¸ëŸ¬ ===== */
  #u-mini-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  #u-mini-toggle{margin-left:auto}
  #u-mini{width:260px;height:140px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:#000;display:none}

  @media (max-width:420px){
    body{font-size:15.5px}
    .desc{font-size:13.5px}
    .tab-btn{padding:10px 12px}
    iframe#view{height:420px}
    #u-mini{width:220px;height:120px}
  }
</style>
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <div id="topbar">
    <button id="back-btn" aria-label="ëŒì•„ê°€ê¸°">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
    <div id="addr">ì„¤ì •</div>
  </div>

  <div id="container">
    <div class="card">
      <h1>âš™ï¸ ì„¤ì •</h1>
      <p class="sub">ì‹¤ì œë¡œ ì œê³µë˜ëŠ” ì„¤ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤. ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ë†’ì˜€ì–´ìš”.</p>

      <!-- íƒ­ -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="account">ì¼ë°˜</button>
        <button class="tab-btn" data-tab="assist">ì›ê²©ì§€ì›</button>
        <button class="tab-btn" data-tab="admin">ê´€ë¦¬ì</button>
      </div>

      <!-- ì¼ë°˜ íƒ­ -->
      <section id="panel-account" class="tab-panel active">
        <!-- ê³„ì • -->
        <div class="item">
          <div class="left">
            <div>ğŸ‘¤</div>
            <div>
              <div class="title">ê³„ì •</div>
              <div class="desc" id="account-desc">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
            </div>
          </div>
          <div class="right">
            <button id="signout-btn" class="btn secondary" disabled>ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
        <div class="hr"></div>
        <!-- ë°ì´í„° ì´ˆê¸°í™” -->
        <div class="item">
          <div class="left">
            <div>â™»ï¸</div>
            <div>
              <div class="title">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”</div>
              <div class="desc">ìì›Â·ì½”ì¸Â·ì—…ê·¸ë ˆì´ë“œÂ·í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.</div>
            </div>
          </div>
          <div class="right">
            <button id="reset-btn" class="btn danger" disabled>ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="hr"></div>
        <!-- ì´ìš©ì•½ê´€(ì›ê²©) -->
        <div class="item" style="align-items:flex-start">
          <div class="left">
            <div>ğŸ“„</div>
            <div>
              <div class="title">ì›ê²©ì§€ì› ì´ìš©ì•½ê´€ (ìš”ì•½)</div>
              <div class="desc" style="white-space:pre-wrap">
â€¢ í™”ë©´ ê³µìœ ëŠ” <b>ë™ì˜</b> í›„ ì‹œì‘ë©ë‹ˆë‹¤. ì–¸ì œë“  ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
â€¢ <b>ë¹„ë°€ë²ˆí˜¸/ID ë“± ê°œì¸ì •ë³´</b>ëŠ” ê´€ë¦¬ì í™”ë©´ì—ì„œ <b>ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹)</b> ì²˜ë¦¬ë˜ë©° í´ë¦­Â·ì…ë ¥Â·í¬ì»¤ìŠ¤ê°€ ì°¨ë‹¨ë©ë‹ˆë‹¤.
â€¢ ì±„íŒ…/ì œì–´ ë¡œê·¸ëŠ” ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì¦‰ì‹œ <b>ì‚­ì œ</b>ë©ë‹ˆë‹¤.
â€¢ ë¶€ì ì ˆí•œ ì±„íŒ…(ëª¨ìš•/í˜ì˜¤/ìŠ¤íŒ¸/ì—°ë½ì²˜ ê³µìœ  ë“±) ê¸ˆì§€.
â€¢ ê´€ë¦¬ìëŠ” <b>ë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.</b>ë¼ëŠ” ë©”ì‹œì§€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ì›ê²©ì§€ì›(ì‚¬ìš©ì) íƒ­ -->
      <section id="panel-assist" class="tab-panel">
        <div class="item" style="flex-direction:column;align-items:stretch">
          <div class="left" style="justify-content:space-between;width:100%">
            <div class="title">ë‚´ ì„¸ì…˜</div>
            <div><span id="u-badge" class="badge wait">ìƒíƒœ: ëŒ€ê¸°</span></div>
          </div>
          <div class="desc" id="helperLabel" style="margin-top:4px"></div>
          <div class="hr" style="width:100%"></div>

          <div class="row" style="justify-content:space-between;width:100%" id="u-mini-row">
            <div class="row">
              <label class="row"><input type="checkbox" id="u-allow-nav" style="transform:scale(1.1)"/> ë„¤ë¹„ê²Œì´ì…˜ í—ˆìš©</label>
              <label class="row"><input type="checkbox" id="u-allow-adv" style="transform:scale(1.1)"/> ê³ ê¸‰ì œì–´(í´ë¦­/ìŠ¤í¬ë¡¤) í—ˆìš©</label>
            </div>
            <button id="u-mini-toggle" class="btn secondary">ë¯¸ë‹ˆ ë¯¸ëŸ¬</button>
          </div>
          <iframe id="u-mini" title="ê´€ë¦¬ì ì¡°ì‘ ë¯¸ë¦¬ë³´ê¸°"></iframe>

          <div class="row" style="margin-top:8px">
            <button id="u-request" class="btn">ì›ê²©ì§€ì› ìš”ì²­</button>
            <button id="u-end" class="btn danger" style="display:none">ì¢…ë£Œ</button>
            <span class="desc">ìš”ì²­ í›„ ê´€ë¦¬ìê°€ ìˆ˜ë½í•˜ë©´ ë‚´ í™”ë©´ ê³µìœ  ë™ì˜ì°½ì´ ëœ¹ë‹ˆë‹¤.</span>
          </div>
          <div class="chat" style="margin-top:10px">
            <div id="u-msgs" class="msgs"></div>
            <div class="row">
              <input id="u-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥â€¦"/>
              <button id="u-send" class="btn secondary">ì „ì†¡</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ê´€ë¦¬ì íƒ­ -->
      <section id="panel-admin" class="tab-panel">
        <div class="item">
          <div class="left"><div>ğŸ›¡ï¸</div><div><div class="title">ê´€ë¦¬ì ì „ìš©</div><div class="desc">ê´€ë¦¬ìë§Œ ìš”ì²­ì„ ìˆ˜ë½í•˜ê³  ì›ê²© ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div></div>
          <div class="right"><span id="admin-email" class="desc"></span></div>
        </div>
        <div class="item">
          <div style="width:100%">
            <div class="title" style="margin-bottom:6px">ëŒ€ê¸° ì¤‘ ìš”ì²­</div>
            <div id="a-waiting" class="list"></div>
          </div>
        </div>
        <div class="item" id="a-session" style="display:none;flex-direction:column;align-items:stretch">
          <div class="row" style="justify-content:space-between">
            <div class="row"><span id="a-badge" class="badge wait">ì„¸ì…˜: ì—°ê²° ì¤€ë¹„</span></div>
            <button id="a-end" class="btn danger">ì„¸ì…˜ ì¢…ë£Œ</button>
          </div>
          <div id="a-toggles" class="muted" style="margin:6px 0 10px"></div>
          <iframe id="view" title="ì‚¬ìš©ì í™”ë©´" allow="autoplay"></iframe>
          <div class="desc" style="margin-top:8px">í™”ë©´ì„ í´ë¦­/íœ í•˜ë©´ ì‚¬ìš©ì í˜ì´ì§€ì— ê·¸ëŒ€ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. (ë¯¼ê°ì˜ì—­ì€ ì‚¬ìš©ì ì¸¡ì—ì„œ ì°¨ë‹¨/ë§ˆìŠ¤í‚¹)</div>
        </div>
      </section>
    </div>

    <footer>íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ Â· v0.1.0</footer>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getDatabase, ref, runTransaction, update, set, onValue, onChildAdded, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
  authDomain: "siu-studio.firebaseapp.com",
  databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "siu-studio",
  storageBucket: "siu-studio.appspot.com",
  messagingSenderId: "830887143444",
  appId: "1:830887143444:web:70b45fc12140e893c31f01",
  measurementId: "G-1Y090YJDB6"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

const backBtn=document.getElementById('back-btn');
backBtn.onclick=()=>{
  try{ const referrer=document.referrer; if(referrer && new URL(referrer).origin===location.origin){ history.back(); return; } }catch{}
  location.href='/game.html';
};

/* ===== íƒ­ ===== */
const tabBtns=[...document.querySelectorAll('.tab-btn')];
const panels={account:document.getElementById('panel-account'),assist:document.getElementById('panel-assist'),admin:document.getElementById('panel-admin')};
tabBtns.forEach(b=>b.onclick=()=>{
  tabBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
  Object.values(panels).forEach(p=>p.classList.remove('active'));
  panels[b.dataset.tab].classList.add('active');
});

/* ===== ì¼ë°˜ ì„¤ì •: ê³„ì •/ì´ˆê¸°í™” ===== */
const accountDesc=document.getElementById('account-desc');
const signoutBtn=document.getElementById('signout-btn');
const resetBtn=document.getElementById('reset-btn');

const defaultData = { resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20, workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[], _lastUpdated: Date.now() };

let uid=null; let email=null;
onAuthStateChanged(auth, user=>{
  if(user && user.emailVerified){
    uid=user.uid; email=user.email;
    accountDesc.textContent = `${email} (ë¡œê·¸ì¸ë¨)`;
    signoutBtn.disabled=false; resetBtn.disabled=false;
  }else if(user && !user.emailVerified){
    accountDesc.textContent='ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¸ì¦ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
    signoutBtn.disabled=false; resetBtn.disabled=true;
  }else{
    accountDesc.textContent='ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'; signoutBtn.disabled=true; resetBtn.disabled=true;
  }
  document.getElementById('admin-email').textContent = `í˜„ì¬ ë¡œê·¸ì¸: ${email || 'ê²ŒìŠ¤íŠ¸'}`;
});
signoutBtn.onclick=()=>signOut(auth);
resetBtn.onclick=async()=>{
  if(!uid){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”'); return; }
  if(!confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?\nìì›/ì½”ì¸/ì—…ê·¸ë ˆì´ë“œ/í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì´ ëª¨ë‘ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.')) return;
  const path = ref(db, `users/${uid}/gameData`);
  try{
    await runTransaction(path, ()=> ({...defaultData, _lastUpdated: Date.now()}));
    try{ localStorage.removeItem(`lastWrite_${uid}`);}catch{}
    alert('ì´ˆê¸°í™” ì™„ë£Œ!');
  }catch{ alert('ì´ˆê¸°í™” ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.'); }
};

/* ===== ì›ê²©ì§€ì›: ì‚¬ìš©ì íƒ­ (ë¯¸ë‹ˆ ë¯¸ëŸ¬ í¬í•¨) ===== */
const uBadge=document.getElementById('u-badge');
const uAllowNav=document.getElementById('u-allow-nav');
const uAllowAdv=document.getElementById('u-allow-adv');
const uReq=document.getElementById('u-request');
const uEnd=document.getElementById('u-end');
const uMsgs=document.getElementById('u-msgs');
const uInput=document.getElementById('u-input');
const uSend=document.getElementById('u-send');
const helperLabel=document.getElementById('helperLabel');
const uMini=document.getElementById('u-mini');
const uMiniToggle=document.getElementById('u-mini-toggle');

const banned=[/ì‹œ[ã…£i]ë°œ/i,/ë³‘?ì‹ /i,/ì¢†/i,/fuck/i,/shit/i,/nigg/i,/rape/i,/\b010[-\s]?\d{4}[-\s]?\d{4}\b/i,/(https?:\/\/|t\.me\/|discord\.gg|kakao\.me)/i];
const clean = (t)=> !banned.some(r=>r.test(t||''));
const addMsg=(el, txt, me=false, sys=false)=>{ const b=document.createElement('div'); b.className='bubble'+(me?' me':'')+(sys?' sys':''); b.textContent=txt; el.appendChild(b); el.scrollTop=el.scrollHeight; };
const setBadge=(el,cls,text)=>{ el.className='badge '+cls; el.textContent='ìƒíƒœ: '+text; };

let pcU=null, miniDoc=null, miniCursor=null, miniLabel=null, miniOn=false;
function ensurePCU(){
  if(pcU) return pcU;
  pcU = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  pcU.onicecandidate = (e)=>{ if(e.candidate){ const c = push(ref(db, `assist/${uid}/signal/userIce`)); set(c, e.candidate.toJSON()); } };
  pcU.onconnectionstatechange=()=>{ if(pcU.connectionState==='connected') setBadge(uBadge,'ok','ì—°ê²°ë¨'); if(pcU.connectionState==='disconnected'||pcU.connectionState==='failed') setBadge(uBadge,'end','í•´ì œë¨'); };
  return pcU;
}
function initMini(){
  const doc = uMini.contentDocument || uMini.contentWindow?.document;
  if(!doc) return;
  doc.open();
  doc.write(`<!doctype html><meta charset="utf-8"><style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font:12px system-ui,Arial;overflow:hidden}
    .cursor{position:absolute;left:0;top:0;width:14px;height:14px;border:2px solid #00d4ff;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 12px rgba(0,212,255,.8)}
    .label{position:absolute;left:8px;top:6px;background:rgba(0,0,0,.4);padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.14)}
  </style><div class="label">ê´€ë¦¬ì ì»¤ì„œ</div><div class="cursor" id="c"></div>`);
  doc.close();
  miniDoc=doc; miniCursor=doc.getElementById('c'); miniLabel=doc.querySelector('.label');
}
function showMini(on){ miniOn=!!on; uMini.style.display = miniOn ? 'block' : 'none'; if(miniOn && !miniDoc) initMini(); }
function moveMini(nx, ny, msg){
  if(!miniOn) return; if(!miniDoc) initMini();
  const w = uMini.clientWidth, h = uMini.clientHeight;
  const x = Math.min(Math.max(nx,0),1)*w, y = Math.min(Math.max(ny,0),1)*h;
  miniCursor.style.left=x+'px'; miniCursor.style.top=y+'px'; if(msg&&miniLabel) miniLabel.textContent=msg;
}
uMiniToggle.onclick=()=>showMini(!miniOn);

// ê²½ë¡œ
let sessionRef, chatRef, signalOfferRef, signalAnswerRef, signalAdminIceRef, controlRef;
function bindUPaths(){
  sessionRef        = ref(db, `assist/${uid}`);
  chatRef           = ref(db, `assist/${uid}/chat`);
  signalOfferRef    = ref(db, `assist/${uid}/signal/offer`);
  signalAnswerRef   = ref(db, `assist/${uid}/signal/answer`);
  signalAdminIceRef = ref(db, `assist/${uid}/signal/adminIce`);
  controlRef        = ref(db, `assist/${uid}/control`);
}

onAuthStateChanged(auth, user=>{
  if(!user) return;
  uid=user.uid; bindUPaths();
  update(sessionRef, { uid, status:'idle', allowNav:false, allowAdvanced:false, updatedAt:serverTimestamp() });
  onChildAdded(chatRef, s=>{ const m=s.val(); if(!m) return; addMsg(uMsgs, m.text||'', m.role==='user', m.role==='system'); });
  onValue(ref(db, `assist/${uid}/helper`), s=>{ const v=s.val(); helperLabel.textContent = v?`ë„ìš°ë¯¸: ${v}`:''; });

  onValue(ref(db, `assist/${uid}/accept`), async s=>{
    const ok=s.val(); if(ok===true){
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
        const pc=ensurePCU(); stream.getTracks().forEach(t=>pc.addTrack(t,stream));
        const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await set(signalOfferRef, offer);
        uEnd.style.display=''; uReq.style.display='none';
        addMsg(uMsgs,'ê´€ë¦¬ìê°€ ì—°ê²°ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', false, true);
        update(sessionRef, { status:'connecting', updatedAt:serverTimestamp() });
        const sync = ()=> update(sessionRef, { allowNav: !!uAllowNav.checked, allowAdvanced: !!uAllowAdv.checked, updatedAt:serverTimestamp() });
        uAllowNav.onchange=sync; uAllowAdv.onchange=sync; sync();
      }catch{ addMsg(uMsgs,'í™”ë©´ê³µìœ ê°€ ì·¨ì†Œ/ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false, true); update(sessionRef, { status:'idle', updatedAt:serverTimestamp() }); setBadge(uBadge,'end','ì·¨ì†Œë¨'); }
    }
  });
  onValue(signalAnswerRef, async s=>{ const v=s.val(); if(!v) return; await ensurePCU().setRemoteDescription(v); });
  onChildAdded(signalAdminIceRef, async s=>{ const c=s.val(); if(!c) return; try{ await ensurePCU().addIceCandidate(new RTCIceCandidate(c)); }catch{} });
  onChildAdded(controlRef, s=>{
    const c=s.val()||{}; const navOK=!!uAllowNav.checked; const advOK=!!uAllowAdv.checked;
    if(c.type==='navigate'&&navOK){ location.href=c.path||location.href; return; }
    if(!advOK) return;
    if(c.type==='click'){
      const x = Math.round(window.innerWidth * c.nx), y = Math.round(window.innerHeight * c.ny);
      const el = document.elementFromPoint(x,y); if(!el) return;
      if(el.closest('input[type="password"], [data-sensitive="true"]')){ const m=push(chatRef); set(m,{role:'system',text:'ë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.',ts:Date.now()}); moveMini(c.nx,c.ny,'ë¯¼ê°ì˜ì—­ ì°¨ë‹¨'); return; }
      try{ el.focus({preventScroll:true}); }catch{}
      el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,clientX:x,clientY:y}));
      moveMini(c.nx,c.ny,'í´ë¦­');
    }
    if(c.type==='scroll'){ window.scrollBy({ top:c.dy||0, behavior:'smooth' }); moveMini(0.06,0.08, c.dy>0?'ìŠ¤í¬ë¡¤â†“':'ìŠ¤í¬ë¡¤â†‘'); }
  });
});

// ì±„íŒ…/ìš”ì²­/ì¢…ë£Œ
uSend.onclick=()=>{ const t=uInput.value.trim(); if(!t) return; uInput.value=''; if(!clean(t)){ addMsg(uMsgs,'ë¶€ì ì ˆí•œ ë©”ì‹œì§€ëŠ” ì „ì†¡í•  ìˆ˜ ì—†ì–´ìš”.', false, true); return; } const m=push(chatRef); set(m,{role:'user',text:t,ts:Date.now()}); };
uReq.onclick=async()=>{ if(!uid){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”'); return; } const m=push(chatRef); set(m,{role:'user',text:'ì›ê²©ì§€ì› ìš”ì²­í•©ë‹ˆë‹¤ ğŸ™',ts:Date.now()}); await update(sessionRef,{status:'waiting',updatedAt:serverTimestamp()}); setBadge(uBadge,'wait','ëŒ€ê¸°'); };
uEnd.onclick=async()=>{
  try{ if(pcU){ pcU.getSenders().forEach(s=>s.track&&s.track.stop()); pcU.close(); } }catch{} pcU=null;
  await update(sessionRef,{status:'ended',allowNav:false,allowAdvanced:false,updatedAt:serverTimestamp()});
  await set(ref(db, `assist/${uid}/signal`), null);
  await set(ref(db, `assist/${uid}/accept`), null);
  await set(ref(db, `assist/${uid}/control`), null);
  await set(ref(db, `assist/${uid}/chat`), null);
  uEnd.style.display='none'; uReq.style.display=''; setBadge(uBadge,'end','ì¢…ë£Œ'); addMsg(uMsgs,'ì„¸ì…˜ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ì±„íŒ…/ì œì–´ ê¸°ë¡ì€ ì‚­ì œë©ë‹ˆë‹¤.', false, true);
  showMini(false);
};

/* ===== ê´€ë¦¬ì íƒ­ ===== */
const ADMIN_EMAIL = 'siu46852579@gmail.com';
const aWaiting=document.getElementById('a-waiting');
const aSession=document.getElementById('a-session');
const aBadge=document.getElementById('a-badge');
const aToggles=document.getElementById('a-toggles');
const aEnd=document.getElementById('a-end');
const iframe=document.getElementById('view');

function initViewerDoc(){
  const doc = iframe.contentDocument || iframe.contentWindow?.document;
  if(!doc) return;
  doc.open();
  doc.write(`<!doctype html><meta charset="utf-8"><style>html,body{margin:0;height:100%;background:#000;color:#fff;font:14px system-ui,Arial}video{width:100%;height:100%;object-fit:contain;background:#000}.hint{position:absolute;left:8px;top:8px;background:rgba(0,0,0,.4);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.14);font-size:12px}</style><div class="hint">í´ë¦­Â·íœ  ì¡°ì‘ì€ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤</div><video id="v" autoplay playsinline muted></video>`);
  doc.close();
}
initViewerDoc();
const vdoc = iframe.contentDocument || iframe.contentWindow?.document;
const v = vdoc.getElementById('v');

let currentUid=null, pcA=null;

function renderWaiting(){
  onValue(ref(db,'assist'), snap=>{
    const data=snap.val()||{};
    aWaiting.innerHTML='';
    const entries = Object.values(data).filter(s=>s&&s.status==='waiting');
    if(entries.length===0){ aWaiting.innerHTML='<div class="muted">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    Object.values(data).forEach(s=>{
      if(!s || s.status!=='waiting') return;
      const item=document.createElement('div'); item.className='item';
      item.innerHTML=`<div><div><b>${s.uid}</b></div><div class="muted">ë„¤ë¹„í—ˆìš©:${!!s.allowNav} Â· ê³ ê¸‰:${!!s.allowAdvanced}</div></div>`;
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ìˆ˜ë½';
      btn.onclick=()=> acceptSession(s.uid);
      item.appendChild(btn); aWaiting.appendChild(item);
    });
  });
}

async function acceptSession(u){
  if(email!==ADMIN_EMAIL){ alert('ê´€ë¦¬ìë§Œ ìˆ˜ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
  currentUid=u; aSession.style.display='block'; aBadge.className='badge wait'; aBadge.textContent='ì„¸ì…˜: ì—°ê²° ì¤‘â€¦';
  await update(ref(db, `assist/${u}`), { helper: email, updatedAt:serverTimestamp() });
  await set(ref(db, `assist/${u}/accept`), true);

  onValue(ref(db, `assist/${u}/signal/offer`), async snap=>{
    const offer=snap.val(); if(!offer) return; await setupAdminPC(u, offer);
  });
  onValue(ref(db, `assist/${u}`), s=>{
    const st=s.val()||{}; aToggles.textContent=`ë„¤ë¹„í—ˆìš©:${!!st.allowNav} Â· ê³ ê¸‰:${!!st.allowAdvanced} Â· ìƒíƒœ:${st.status||'-'}`;
    if(st.status==='ended'){ aBadge.className='badge end'; aBadge.textContent='ì„¸ì…˜: ì¢…ë£Œë¨'; }
    if(st.status==='connected'){ aBadge.className='badge ok'; aBadge.textContent='ì„¸ì…˜: ì—°ê²°ë¨'; }
  });
}

async function setupAdminPC(u, offer){
  if(pcA) try{ pcA.close(); }catch{}; pcA = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  pcA.onicecandidate = (e)=>{ if(e.candidate){ const c=push(ref(db, `assist/${u}/signal/adminIce`)); set(c, e.candidate.toJSON()); } };
  pcA.ontrack = (e)=>{ v.srcObject=e.streams[0]; aBadge.className='badge ok'; aBadge.textContent='ì„¸ì…˜: ì—°ê²°ë¨'; };
  pcA.onconnectionstatechange=()=>{ if(pcA.connectionState==='connected'){ aBadge.className='badge ok'; aBadge.textContent='ì„¸ì…˜: ì—°ê²°ë¨'; } if(pcA.connectionState==='disconnected'||pcA.connectionState==='failed'){ aBadge.className='badge end'; aBadge.textContent='ì„¸ì…˜: í•´ì œë¨'; } };
  await pcA.setRemoteDescription(offer);
  const ans = await pcA.createAnswer(); await pcA.setLocalDescription(ans);
  await set(ref(db, `assist/${u}/signal/answer`), ans);
  await update(ref(db, `assist/${u}`), { status:'connected', updatedAt:serverTimestamp() });

  onChildAdded(ref(db, `assist/${u}/signal/userIce`), async s=>{ const c=s.val(); if(!c) return; try{ await pcA.addIceCandidate(new RTCIceCandidate(c)); }catch{} });

  const sendControl=(p)=>{ const m=push(ref(db, `assist/${u}/control`)); set(m,p); };
  vdoc.addEventListener('click', e=>{
    const rect=v.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width, y=(e.clientY-rect.top)/rect.height;
    sendControl({ type:'click', nx:Math.min(Math.max(x,0),1), ny:Math.min(Math.max(y,0),1), ts:Date.now() });
  });
  vdoc.addEventListener('wheel', e=>{ sendControl({ type:'scroll', dy:e.deltaY, ts:Date.now() }); }, {passive:true});
}

const aEnd=document.getElementById('a-end');
let email=null;
onAuthStateChanged(auth, user=>{
  email = user?.email || null;
  const adminTabBtn = document.querySelector('.tab-btn[data-tab="admin"]');
  const isAdmin = !!(user && user.email==='siu46852579@gmail.com' && user.emailVerified);
  if(!isAdmin){ adminTabBtn.title='ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥'; }
  renderWaiting();
});

aEnd.onclick=async()=>{
  if(!currentUid) return;
  try{
    await update(ref(db, `assist/${currentUid}`), { status:'ended', updatedAt:serverTimestamp() });
    await set(ref(db, `assist/${currentUid}/accept`), null);
    await set(ref(db, `assist/${currentUid}/control`), null);
    await set(ref(db, `assist/${currentUid}/signal`), null);
  }catch{}
  try{ pcA && pcA.close(); }catch{} pcA=null; currentUid=null; v.srcObject=null;
  aBadge.className='badge end'; aBadge.textContent='ì„¸ì…˜: ì¢…ë£Œë¨';
};
</script>
</body>
</html>