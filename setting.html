<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>âš™ï¸ ì„¤ì • - íƒœì–‘ê³„ ì •ë³µ</title>

  <style>
    :root{
      --bg-img: url('/images/space-bg.jpg');
      --glass-bg: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(6,7,12,0.60));
      --panel-bg: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(10,13,20,0.72));
      --stroke: rgba(255,255,255,0.18);
      --stroke-2: rgba(255,255,255,0.26);
      --text: #eaf2ff;
      --text-strong: #ffffff;
      --muted: #d0e7ff;
      --muted-2: #b7d4ff;
      --accent: #00d1ff;
      --accent-2:#0096ff;
      --danger:#ff6b6b;
      --ok:#36d399;
      --warn:#ffd166;
      --focus: #00e0ff;
      --shadow: 0 18px 48px rgba(0,0,0,0.55);
      --radius: 16px;
      --radius-sm: 12px;
      --space: clamp(14px, 2vw, 18px);
      --fs-base: 16px;
      --lh: 1.65;
    }

    *{ box-sizing: border-box; }
    html{ font-size: var(--fs-base); }
    body{
      margin:0; padding:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--panel-bg), var(--bg-img) center/cover no-repeat fixed;
      color: var(--text); line-height: var(--lh);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    img{ display:block; }
    a{ color:inherit; text-decoration: none; }
    ::selection{ background: rgba(0, 208, 255, .35); }
    ::placeholder{ color: #cfe7ff; opacity:.9; }

    #topbar{
      position:fixed; top:8px; left:8px; right:8px; z-index: 1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-radius: var(--radius-sm);
      background: rgba(15,18,28,0.82);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    #back-btn{
      display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      padding:10px 12px; border-radius:10px; font-weight:800; color: var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      border:1px solid var(--stroke);
      touch-action: manipulation;
    }
    #back-btn:hover{ filter:brightness(1.06); }
    #back-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
    #addr{ font-size:.82rem; color: var(--muted); user-select:none; }

    #container{
      width: min(980px, 94vw);
      margin: calc(56px + 10px) auto 28px;
      padding: var(--space);
    }
    .card{
      background: var(--glass-bg);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.06);
      padding: var(--space);
      margin: 14px 0;
    }

    h1{ margin:0 0 8px; font-size: clamp(1.25rem, 1.6rem, 1.8rem); color: var(--text-strong); text-wrap: balance; letter-spacing:.2px; }
    h2{ margin:6px 0 10px; font-size: clamp(1.05rem, 1.2rem, 1.4rem); color: var(--text-strong); letter-spacing:.2px; }
    .sub{ margin:2px 0 18px; font-size:.92rem; color: var(--muted); }

    .item{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px; border-radius: var(--radius-sm);
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }
    .item .left{ display:flex; align-items:flex-start; gap:12px; min-width: 0; }
    .item .title{ font-weight:800; color: var(--text-strong); }
    .item .desc{ font-size:.95rem; color: var(--muted); }
    .item .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    .btn{
      padding:10px 12px; border:1px solid var(--stroke-2);
      color:#001218; font-weight:800; border-radius:10px; cursor:pointer;
      background-image: linear-gradient(180deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(0,160,255,.22);
      transition: transform .08s ease, filter .2s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ color:var(--text); border-color: var(--stroke); background-image:none; background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.04)); box-shadow: none; }
    .btn.danger{ background-image:none; color:#ffecec; background: linear-gradient(180deg, rgba(255,70,70,0.95), rgba(190,0,0,0.92)); border-color: rgba(255,90,90,0.55); }
    .btn.ok{ background-image:none; color:#002a1f; background: linear-gradient(180deg, var(--ok), #17b17a); }
    .btn.warn{ background-image:none; color:#3b2a00; background: linear-gradient(180deg, var(--warn), #ffb703); }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }
    .btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }

    .hr{ height:1px; background: rgba(255,255,255,0.12); margin: 10px 0; }
    .muted{ color: var(--muted); font-size:.9rem; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    label.checkbox{ display:flex; gap:8px; align-items:flex-start; font-size:.95rem; }
    input[type="checkbox"]{ transform: scale(1.12); accent-color: var(--accent-2); }

    #toast{ position:fixed; left:50%; bottom: max(18px, env(safe-area-inset-bottom)); transform: translateX(-50%) translateY(20px); background: rgba(0,0,0,0.78); color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:all .25s ease; z-index:2800; border:1px solid rgba(255,255,255,0.16); }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    #overlay{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index: 1800; }
    #overlay .box{ width:min(420px, 92vw); border-radius:14px; padding:16px; text-align:center; background: var(--glass-bg); border:1px solid var(--stroke); color:#dff7ff; box-shadow: var(--shadow); }
    .spinner{ width:44px; height:44px; border-radius:50%; border:4px solid rgba(255,255,255,0.18); border-top-color: var(--accent); margin: 10px auto; animation: spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .chat{ display:grid; grid-template-rows: 1fr auto; gap:8px; height: clamp(220px, 36vh, 360px); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:10px; background: linear-gradient(180deg, rgba(0,0,0,0.30), rgba(255,255,255,0.04)); }
    .chat-messages{ overflow:auto; padding-right:6px; scroll-behavior:smooth; }
    .bubble{ max-width: 85%; padding:10px 12px; margin:6px 0; border-radius:12px; background: rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18); word-break: break-word; font-size:1rem; color: var(--text); }
    .me{ margin-left:auto; background: rgba(0,180,255,0.22); border-color: rgba(0,180,255,0.45); }
    .sys{ background: rgba(255,255,255,0.08); font-size:.9rem; opacity:.98; }
    .meta{ font-size:.78rem; color:var(--muted-2); margin-top:2px; }
    .chat-input{ display:flex; gap:6px; }
    .chat-input input{ flex:1; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); color:var(--text); }

    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot.gray{ background:#6b7280; } .dot.blue{ background:#38bdf8; } .dot.green{ background:#22c55e; } .dot.red{ background:#ef4444; } .dot.yellow{ background:#f59e0b; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1900; padding: 10px; }
    .modal.show{ display:flex; }
    .modal .panel{ width:min(680px, 100%); max-height:85vh; overflow:auto; border-radius:14px; padding:16px; background: var(--glass-bg); border:1px solid var(--stroke); color:#e6f7ff; box-shadow: var(--shadow); }
    .panel .title{ font-weight:800; font-size:1.1rem; margin-bottom:6px; color: var(--text-strong); }
    .panel .desc{ font-size:.98rem; color:var(--muted); }
    .panel .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    footer{ margin:12px 0 24px; text-align:center; color:var(--muted); font-size:.86rem; }

    @media (max-width: 560px){
      #container{ width: min(100%, 100vw); margin-top: calc(52px + 8px); padding: 12px; }
      .item{ flex-direction: column; align-items: stretch; }
      .item .right{ width:100%; justify-content:flex-start; }
      .btn{ width:auto; min-height: 42px; }
      .chat{ height: clamp(240px, 44vh, 420px); }
      .bubble{ max-width: 92%; }
      label.checkbox{ font-size: 1rem; }
      h1{ font-size: 1.25rem; }
      h2{ font-size: 1.05rem; }
    }

    /* === in-frame overlay í‘œì‹œ === */
    #helper-overlay{ position:fixed; inset:0; pointer-events:none; z-index:3000; display:none; }
    #helper-overlay.show{ display:block; }
    #helper-cursor{ position:fixed; width:18px; height:18px; border-radius:50%; border:2px solid rgba(0,212,255,.95); background:rgba(0,212,255,.12); transform:translate(-50%,-50%); opacity:0; transition:opacity .2s ease, transform .12s ease; box-shadow:0 0 24px rgba(0,212,255,.5); pointer-events:none; }
    #helper-hl{ position:fixed; border:2px solid rgba(255,230,0,.95); box-shadow:0 0 24px rgba(255,230,0,.35), inset 0 0 10px rgba(255,230,0,.25); border-radius:10px; opacity:0; transition:opacity .25s ease; pointer-events:none; }
    #helper-iframe{ position:fixed; right:10px; bottom:10px; width: min(360px, 92vw); height: 180px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(10,12,20,.82); pointer-events:auto; z-index:3001; box-shadow:0 10px 30px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06); }
    @media (max-width:560px){ #helper-iframe{ width: calc(100vw - 20px); height: 160px; right:10px; left:10px; } }
  </style>
</head>
<body>
  <div id="topbar">
    <button id="back-btn" aria-label="ëŒì•„ê°€ê¸°">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
    <div id="addr">ì„¤ì •</div>
  </div>

  <div id="container">
    <div class="card">
      <h1>âš™ï¸ ì„¤ì •</h1>
      <p class="sub">ì‹¤ì œë¡œ ì œê³µë˜ëŠ” ì„¤ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.</p>

      <div class="item">
        <div class="left">
          <div aria-hidden="true">ğŸ‘¤</div>
          <div>
            <div class="title">ê³„ì •</div>
            <div class="desc" id="account-desc">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
          </div>
        </div>
        <div class="right">
          <button id="signout-btn" class="btn secondary" disabled>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="hr" role="presentation"></div>

      <div class="item">
        <div class="left">
          <div aria-hidden="true">â™»ï¸</div>
          <div>
            <div class="title">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”</div>
            <div class="desc">ìì›Â·ì½”ì¸Â·ì—…ê·¸ë ˆì´ë“œÂ·í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="right">
          <button id="reset-btn" class="btn danger" disabled>ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="card" id="remote-card">
      <h2>ğŸ›°ï¸ ì›ê²© ë„ì›€</h2>
      <p class="sub">ë„ìš°ë¯¸ ì—°ê²° ì‹œ ì±„íŒ… ê°€ëŠ¥, <b>ë™ì˜í•œ ê²½ìš°ì—ë§Œ</b> ì œì–´ ê¶Œí•œì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>

      <div class="item" id="user-remote">
        <div class="left">
          <div aria-hidden="true">ğŸ™‹</div>
          <div>
            <div class="title">ë‚´ ë„ì›€ ì„¸ì…˜</div>
            <div class="desc">
              <span id="session-status"><span class="dot gray"></span>ëŒ€ê¸° ì¤‘</span>
              <span class="muted" id="session-helper"></span>
            </div>
          </div>
        </div>
        <div class="right">
          <button id="btn-open-consent" class="btn" disabled>ì›ê²© ë„ì›€ ìš”ì²­</button>
          <button id="btn-end-session" class="btn danger" style="display:none;">ì¢…ë£Œ</button>
          <label class="checkbox" title="ë„ìš°ë¯¸ê°€ ë‚´ ë¸Œë¼ìš°ì € ê²½ë¡œ ì´ë™ì„ ì§€ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
            <input id="chk-grant-control" type="checkbox" disabled />
            <span class="muted">ì œì–´ ê¶Œí•œ(ë„¤ë¹„ê²Œì´ì…˜)</span>
          </label>
          <label class="checkbox" title="ë„ìš°ë¯¸ê°€ í´ë¦­/ìŠ¤í¬ë¡¤ ê°™ì€ ìƒí˜¸ì‘ìš©ì„ ì›ê²©ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.">
            <input id="chk-grant-advanced" type="checkbox" disabled />
            <span class="muted">ê³ ê¸‰ ì œì–´(í´ë¦­Â·ìŠ¤í¬ë¡¤)</span>
          </label>
          <button id="btn-view-tos" class="btn secondary" style="margin-left:6px;">ì´ìš©ì•½ê´€</button>
        </div>
      </div>

      <div class="item" id="chat-area" style="display:none;">
        <div class="left" style="flex-direction:column; align-items:stretch; width:100%;">
          <div class="row" style="justify-content:space-between;">
            <div class="title">ì±„íŒ…</div>
            <div class="muted" id="chat-tip">ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë©”ì‹œì§€ëŠ” ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</div>
          </div>
          <div class="chat" aria-live="polite">
            <div id="msgs" class="chat-messages"></div>
            <div class="chat-input">
              <input id="msg-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥..." maxlength="1000" />
              <button id="msg-send" class="btn secondary">ì „ì†¡</button>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">â€» ë¶€ì ì ˆÂ·ëª¨ìš•Â·ì°¨ë³„Â·ê´‘ê³ Â·ì—°ë½ì²˜ ê³µìœ ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="item" id="admin-console" style="display:none;">
        <div class="left" style="flex-direction:column; align-items:flex-start; width:100%;">
          <div class="title">ê´€ë¦¬ì ì½˜ì†”</div>
          <div class="desc">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìë¥¼ ìë™ ì—°ê²°í•˜ê³ , ê²½ë¡œ ì´ë™Â·í•˜ì´ë¼ì´íŠ¸Â·í´ë¦­ ë“±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¯¼ê°ì˜ì—­ ì¡°ì‘ì€ ë¹„ê³µê°œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>

          <div class="row" style="margin-top:8px;">
            <label class="checkbox"><input id="chk-helper-wait" type="checkbox" /> <span>ë„ì›€ ëŒ€ê¸° ëª¨ë“œ(ìë™ ì—°ê²°)</span></label>
            <button id="btn-leave-session" class="btn danger" style="display:none;">ì„¸ì…˜ ì¢…ë£Œ</button>
          </div>

          <div class="hr" style="width:100%;"></div>

          <div class="title" style="margin-top:2px; margin-bottom:4px;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­</div>
          <div id="waiting-list" class="muted">ì—†ìŒ</div>

          <div class="hr" style="width:100%;"></div>

          <div id="admin-tools" style="display:none; width:100%;">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <div class="title">ì œì–´ íŒ¨ë„</div>
              <div class="muted" id="admin-session-label"></div>
            </div>

            <div class="row" style="margin-top:6px;">
              <input id="nav-path" type="text" placeholder="/game.html" style="flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); color:#e6f7ff;">
              <button id="btn-send-nav" class="btn">ê²½ë¡œ ì´ë™</button>
              <button class="btn secondary" data-nav="/game.html">/game.html</button>
              <button class="btn secondary" data-nav="/setting.html">/setting.html</button>
              <button class="btn secondary" data-nav="/ranking.html">/ranking.html</button>
            </div>

            <div class="row" style="margin-top:10px; width:100%;">
              <input id="sel-input" type="text" placeholder="CSS ì„ íƒì (ì˜ˆ: #upgrade-ship, [data-action='rank'])" style="flex:1; min-width:240px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.08); color:#e6f7ff;">
              <button id="btn-highlight" class="btn ok" title="ì‚¬ìš©ì í™”ë©´ì—ì„œ í•´ë‹¹ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸">í•˜ì´ë¼ì´íŠ¸</button>
              <button id="btn-click" class="btn" title="ì‚¬ìš©ì í™”ë©´ì—ì„œ í•´ë‹¹ ìš”ì†Œ í´ë¦­">í´ë¦­</button>
              <button id="btn-scroll" class="btn secondary" title="í•´ë‹¹ ìš”ì†Œë¡œ ìŠ¤í¬ë¡¤">ìŠ¤í¬ë¡¤</button>
              <button id="btn-alert" class="btn warn">ì•Œë¦¼</button>
              <button id="btn-ping" class="btn secondary">í•‘</button>
            </div>

            <div class="hr" style="width:100%;"></div>

            <div class="title">ì±„íŒ…(ê´€ë¦¬ì)</div>
            <div class="chat">
              <div id="msgs-admin" class="chat-messages"></div>
              <div class="chat-input">
                <input id="msg-input-admin" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥..." maxlength="1000" />
                <button id="msg-send-admin" class="btn secondary">ì „ì†¡</button>
              </div>
            </div>
            <div class="muted" style="margin-top:6px;">â€» ë¶€ì ì ˆ ë‚´ìš© ì „ì†¡ ì‹œ ìë™ ì°¨ë‹¨ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <footer>íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ Â· v0.1.0</footer>
  </div>

  <!-- í† ìŠ¤íŠ¸ / ì˜¤ë²„ë ˆì´ -->
  <div id="toast" role="status" aria-live="polite">ì•Œë¦¼</div>
  <div id="overlay" aria-hidden="true"><div class="box"><div>ì²˜ë¦¬ ì¤‘â€¦</div><div class="spinner" aria-hidden="true"></div><div style="font-size:12px;color:#cfe7ff;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div></div></div>

  <!-- in-frame overlay (í‘œì‹œ ì „ìš©) -->
  <div id="helper-overlay" aria-hidden="true">
    <div id="helper-cursor" aria-hidden="true"></div>
    <div id="helper-hl" aria-hidden="true"></div>
    <iframe id="helper-iframe" title="ì›ê²© ë„ì›€ ì •ë³´" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <!-- ë™ì˜ ëª¨ë‹¬ -->
  <div id="consent-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consent-title">
    <div class="panel">
      <div id="consent-title" class="title">ì›ê²© ë„ì›€ ìš”ì²­ ë™ì˜</div>
      <div class="desc" style="line-height:1.65;">
        â€¢ ì—°ê²° ëŒ€ìƒ: ê´€ë¦¬ì(<b>siu46852579@gmail.com</b>)ë§Œ ê°€ëŠ¥<br/>
        â€¢ ê¸°ë³¸ ì œì–´: ì±„íŒ… + í˜ì´ì§€ ë‚´ ë„¤ë¹„ê²Œì´ì…˜(ê²½ë¡œ ì´ë™)<br/>
        â€¢ <b>ê³ ê¸‰ ì œì–´</b>: í´ë¦­/ìŠ¤í¬ë¡¤ì€ <b>ë‚´ê°€ í† ê¸€ì„ ì¼¤ ë•Œë§Œ</b> ì‹¤í–‰ë¨. <b>ë¹„ë°€ë²ˆí˜¸/ID ë° ê°œì¸ì •ë³´ ì…ë ¥ë€</b>(type=password, [data-sensitive])ì€ ê´€ë¦¬ìì—ê²Œ <b>ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹)</b> ì²˜ë¦¬ë˜ì–´ í´ë¦­Â·í¬ì»¤ìŠ¤Â·ì…ë ¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.<br/>
        â€¢ ëª¨ë“  ì±„íŒ…Â·ì œì–´ ê¸°ë¡ì€ <b>ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì˜êµ¬ ì‚­ì œ</b><br/>
        â€¢ ì–¸ì œë“ ì§€ ì¢…ë£Œ ê°€ëŠ¥
      </div>
      <label class="checkbox" style="margin-top:10px;"><input id="chk-consent" type="checkbox"/> <span>ìœ„ ë‚´ìš©ì„ ì´í•´í–ˆê³ , ì›ê²© ë„ì›€ ì—°ê²°ì— ë™ì˜í•©ë‹ˆë‹¤.</span></label>
      <label class="checkbox" style="margin-top:6px;"><input id="chk-accept-tos" type="checkbox"/> <span>ë¶€ì ì ˆ ì±„íŒ… ê¸ˆì§€ ë° ì´ìš©ì•½ê´€ì„ ì½ê³  ë™ì˜í•©ë‹ˆë‹¤. (<a href="#" id="open-tos-inline">ë³´ê¸°</a>)</span></label>
      <div class="actions"><button id="consent-cancel" class="btn secondary">ì·¨ì†Œ</button><button id="consent-ok" class="btn" disabled>ë™ì˜í•˜ê³  ìš”ì²­</button></div>
    </div>
  </div>

  <!-- ì´ìš©ì•½ê´€ ëª¨ë‹¬ -->
  <div id="tos-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tos-title">
    <div class="panel">
      <div id="tos-title" class="title">ì›ê²© ë„ì›€ ì´ìš©ì•½ê´€</div>
      <div class="desc" style="white-space:pre-wrap; line-height:1.7;">
[ëª©ì ]
ë³¸ ì•½ê´€ì€ â€œíƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤â€(ì´í•˜ â€˜ì‚¬ì´íŠ¸â€™)ì—ì„œ ì œê³µí•˜ëŠ” ì›ê²© ë„ì›€ ê¸°ëŠ¥ì˜ ì´ìš© ì¡°ê±´ì„ ê·œì •í•©ë‹ˆë‹¤.

[ì£¼ì²´]
ë„ìš°ë¯¸ëŠ” ê´€ë¦¬ì ê³„ì •(ì´ë©”ì¼: siu46852579@gmail.com)ì— í•œí•©ë‹ˆë‹¤. ì¼ë°˜ ì´ìš©ìëŠ” ë³¸ì¸ ë™ì˜ í›„ì—ë§Œ ì—°ê²°ë©ë‹ˆë‹¤.

[ì œê³µ ë²”ìœ„]
1) ê¸°ë³¸ ê¸°ëŠ¥: ì±„íŒ…, í˜ì´ì§€ ë‚´ ë„¤ë¹„ê²Œì´ì…˜(ê²½ë¡œ ì´ë™ ì§€ì‹œ)
2) ê³ ê¸‰ ì œì–´(ì„ íƒ): ì´ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ â€˜ê³ ê¸‰ ì œì–´(í´ë¦­Â·ìŠ¤í¬ë¡¤)â€™ë¥¼ í™œì„±í™”í•œ ê²½ìš°ì— í•œí•´ ë²„íŠ¼ í´ë¦­, ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸, ìŠ¤í¬ë¡¤ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3) ì œí•œ: ë¹„ë°€ë²ˆí˜¸/ID ë° ê°œì¸ì •ë³´ ì…ë ¥ë€(type=password, [data-sensitive])ì€ ê´€ë¦¬ìì—ê²Œ ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹) ì²˜ë¦¬ë˜ë©°, í´ë¦­Â·í¬ì»¤ìŠ¤Â·ì…ë ¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë°”ê¹¥ ë™ì‘, í´ë¦½ë³´ë“œ ì ‘ê·¼, íŒŒì¼ ì—…/ë‹¤ìš´ë¡œë“œ, í‚¤ë³´ë“œ ì…ë ¥ ì „ì†¡ì€ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ì ‘ì† ë° ê¸°ë¡]
ì—°ê²°Â·ì±„íŒ…Â·ì œì–´ ì´ë²¤íŠ¸ëŠ” ì„¸ì…˜ ë™ì•ˆë§Œ ì„ì‹œ ì €ì¥ë˜ë©°, ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì„œë²„ì—ì„œ ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì§€ì—° ë“± ê¸°ìˆ ì  ì‚¬ìœ ë¡œ ìˆ˜ ë¶„ ë‚´ ì‚­ì œë  ìˆ˜ ìˆìŒ)

[ê°œì¸ì •ë³´ ë³´í˜¸]
ë¹„ë°€ë²ˆí˜¸/ID ë“± ê°œì¸ì •ë³´ëŠ” ê´€ë¦¬ì í™”ë©´ì—ì„œ ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹)ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ê´€ë¦¬ìê°€ ë¯¼ê° ì˜ì—­ì„ í´ë¦­/í¬ì»¤ìŠ¤/ì…ë ¥ ì‹œë„í•˜ë©´ â€œë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.â€ê°€ ê´€ë¦¬ì ì±„íŒ…ì— í‘œì‹œë˜ë©° ì‹¤ì œ ì¡°ì‘ì€ ì°¨ë‹¨ë©ë‹ˆë‹¤. ê´€ë¦¬ì í™”ë©´ì—ëŠ” "ë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤."ë¼ê³  í‘œì‹œë©ë‹ˆë‹¤.

[ì´ìš©ì ì˜ë¬´]
1) í—ˆìœ„ ì‚¬ì‹¤ ìœ í¬, ëª¨ìš•Â·í˜ì˜¤Â·ìŒë€Â·í­ë ¥ì  í‘œí˜„, ìŠ¤íŒ¸Â·ê´‘ê³ , ì—°ë½ì²˜/ì™¸ë¶€ ë§í¬ ê³µìœ  ë“±ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.
2) ë¶ˆë²• ë˜ëŠ” ì œ3ì ê¶Œë¦¬ë¥¼ ì¹¨í•´í•˜ëŠ” í–‰ìœ„ë¥¼ í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
3) ë„ìš°ë¯¸ì˜ ì¡°ì‘ì„ ì›ì¹˜ ì•Šì„ ê²½ìš° ì–¸ì œë“  ì œì–´ í† ê¸€ì„ ë„ê±°ë‚˜ ì„¸ì…˜ì„ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[ë„ìš°ë¯¸ ì˜ë¬´]
1) ë„ìš°ë¯¸ëŠ” ì´ìš©ì ë™ì˜ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤.
2) ë„ìš°ë¯¸ì˜ í•˜ì´ë¼ì´íŠ¸/í´ë¦­ì€ ì´ìš©ì í™”ë©´ì— ì‹œê°ì ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•˜ë©°, ë¯¼ê° ì •ë³´ëŠ” ë¹„ê³µê°œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

[ë©´ì±…]
ê³ ê¸‰ ì œì–´ë¡œ ë°œìƒí•œ í˜ì´ì§€ ë‚´ ì¡°ì‘ ê²°ê³¼ëŠ” ì´ìš©ìì˜ ìë°œì  ë™ì˜ í•˜ì— ìˆ˜í–‰ë˜ë©°, ì‚¬ì´íŠ¸ëŠ” ê³ ì˜ ë˜ëŠ” ì¤‘ê³¼ì‹¤ì´ ì—†ëŠ” í•œ ì†í•´ì— ëŒ€í•´ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ë¶„ìŸ]
ë¶„ìŸ ë°œìƒ ì‹œ í•œêµ­ë²•ì„ ì¤€ê±°ë²•ìœ¼ë¡œ í•˜ë©°, ê´€í• ì€ ì‚¬ì´íŠ¸ ìš´ì˜ìì˜ ì£¼ì†Œì§€ ê´€í•  ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.
      </div>
      <div class="actions"><button id="tos-close" class="btn">ë‹«ê¸°</button></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, runTransaction, onValue, set, update, push, onChildAdded, onDisconnect, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const defaultData = { resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20, workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[], _lastUpdated: Date.now() };
    const ADMIN_EMAIL = 'siu46852579@gmail.com';

    const accountDesc = document.getElementById('account-desc');
    const signoutBtn  = document.getElementById('signout-btn');
    const resetBtn    = document.getElementById('reset-btn');
    const backBtn     = document.getElementById('back-btn');
    const toast       = document.getElementById('toast');
    const overlay     = document.getElementById('overlay');

    const btnOpenConsent = document.getElementById('btn-open-consent');
    const btnEndSession  = document.getElementById('btn-end-session');
    const chkGrantControl= document.getElementById('chk-grant-control');
    const chkGrantAdvanced = document.getElementById('chk-grant-advanced');
    const sessionStatus  = document.getElementById('session-status');
    const sessionHelper  = document.getElementById('session-helper');
    const chatArea       = document.getElementById('chat-area');
    const msgs           = document.getElementById('msgs');
    const msgInput       = document.getElementById('msg-input');
    const msgSend        = document.getElementById('msg-send');

    const adminConsole   = document.getElementById('admin-console');
    const chkHelperWait  = document.getElementById('chk-helper-wait');
    const waitingListEl  = document.getElementById('waiting-list');
    const adminTools     = document.getElementById('admin-tools');
    const adminSessionLabel = document.getElementById('admin-session-label');
    const btnLeaveSession   = document.getElementById('btn-leave-session');
    const msgsAdmin      = document.getElementById('msgs-admin');
    const msgInputAdmin  = document.getElementById('msg-input-admin');
    const msgSendAdmin   = document.getElementById('msg-send-admin');
    const navPath        = document.getElementById('nav-path');
    const btnSendNav     = document.getElementById('btn-send-nav');
    const selectorInput  = document.getElementById('sel-input');

    const consentModal   = document.getElementById('consent-modal');
    const chkConsent     = document.getElementById('chk-consent');
    const chkAcceptTos   = document.getElementById('chk-accept-tos');
    const consentOK      = document.getElementById('consent-ok');
    const consentCancel  = document.getElementById('consent-cancel');
    const tosModal       = document.getElementById('tos-modal');
    const openTosInline  = document.getElementById('open-tos-inline');
    const tosClose       = document.getElementById('tos-close');
    const btnViewTos     = document.getElementById('btn-view-tos');

    const helperOverlay = document.getElementById('helper-overlay');
    const helperCursor  = document.getElementById('helper-cursor');
    const helperHL      = document.getElementById('helper-hl');
    const helperIframe  = document.getElementById('helper-iframe');

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600); }
    function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; overlay.setAttribute('aria-hidden', show ? 'false':'true'); }
    function dot(color, text){ return `<span class="dot ${color}"></span>${text}`; }
    function scrollToBottom(el){ el.scrollTop = el.scrollHeight; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function showHelperOverlay(on){ helperOverlay.classList.toggle('show', !!on); helperOverlay.setAttribute('aria-hidden', on ? 'false':'true'); }
    function initHelperIframe(){
      if(!helperIframe) return;
      const doc = helperIframe.contentDocument || helperIframe.contentWindow?.document;
      if(!doc) return;
      doc.open();
      doc.write(`<!doctype html><html><head><meta charset="utf-8"/><style>
        body{margin:0;font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#eaf2ff;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(6,7,12,.6))}
        header{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.12);font-weight:800;color:#fff;display:flex;justify-content:space-between;align-items:center}
        #log{padding:8px 10px;height:calc(100% - 40px);overflow:auto}.row{margin:6px 0;opacity:.95}
        .time{color:#b9d8ff;font-size:11px;margin-left:6px}.ok{color:#36d399}.warn{color:#ffd166}.act{color:#00d1ff}.mask{color:#ffbaba}
      </style></head><body><header>ì›ê²© ë„ì›€ <span style="font-weight:600;font-size:12px;opacity:.9;">(í‘œì‹œ ì „ìš©)</span></header><div id="log" role="log" aria-live="polite"></div></body></html>`);
      doc.close();
    }
    function logToIframe(text, cls=''){
      const doc = helperIframe.contentDocument || helperIframe.contentWindow?.document;
      const log = doc?.getElementById('log');
      if(!log) return;
      const row = doc.createElement('div');
      row.className = 'row ' + (cls||'');
      const t = new Date().toLocaleTimeString();
      row.innerHTML = `${text} <span class="time">${t}</span>`;
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }
    function pulseAtElement(el){
      try{
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width/2, cy = r.top + r.height/2;
        helperCursor.style.left = `${cx}px`;
        helperCursor.style.top  = `${cy}px`;
        helperCursor.style.opacity = '1';
        helperCursor.style.transform = 'translate(-50%,-50%) scale(1.0)';
        setTimeout(()=> helperCursor.style.opacity = '0', 320);
      }catch{}
    }
    function outlineElement(el){
      try{
        const r = el.getBoundingClientRect();
        helperHL.style.left = `${r.left - 6}px`;
        helperHL.style.top  = `${r.top - 6}px`;
        helperHL.style.width  = `${r.width + 12}px`;
        helperHL.style.height = `${r.height + 12}px`;
        helperHL.style.opacity = '1';
        setTimeout(()=> helperHL.style.opacity = '0', 800);
      }catch{}
    }
    function isSensitive(el){ return !!el.closest('input[type="password"], [data-sensitive="true"]'); }
    function onHelperConnected(helperEmail){ showHelperOverlay(true); initHelperIframe(); logToIframe(`<span class="ok">ê´€ë¦¬ì ì—°ê²°ë¨</span> â€” ${helperEmail||''}`); }
    function onHelperDisconnected(){ logToIframe(`<span class="warn">ê´€ë¦¬ì ì—°ê²° ì¢…ë£Œ</span>`); showHelperOverlay(false); }

    backBtn.addEventListener('click', () => {
      try{
        const ref = document.referrer;
        if (ref && new URL(ref).origin === location.origin) { history.back(); return; }
      }catch{}
      location.href = '/game.html';
    });

    let uid = null; let meEmail = null; let isAdmin = false; let mySessionId = null;
    let chatUnsub = null; let chatUnsubAdmin = null; let controlUnsub = null; let activeAdminSession = null;

    onAuthStateChanged(auth, async (user) => {
      if (user && user.emailVerified){
        uid = user.uid; meEmail = user.email || ''; isAdmin = (meEmail === ADMIN_EMAIL);
        accountDesc.textContent = `${meEmail} (ë¡œê·¸ì¸ë¨)`;
        signoutBtn.disabled = false; resetBtn.disabled = false; btnOpenConsent.disabled = false;
        mySessionId = uid; subscribeUserSession();
        if (isAdmin) initAdminConsole(); else adminConsole.style.display = 'none';
      } else if (user && !user.emailVerified){
        accountDesc.textContent = 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¸ì¦ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
        signoutBtn.disabled = false; resetBtn.disabled = true; btnOpenConsent.disabled = true; adminConsole.style.display = 'none';
      } else {
        accountDesc.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        signoutBtn.disabled = true; resetBtn.disabled = true; btnOpenConsent.disabled = true; adminConsole.style.display = 'none';
      }
    });

    signoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆì–´ìš”'); } catch (e) { showToast('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨'); }
    });

    resetBtn.addEventListener('click', async () => {
      if (!uid){ showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”'); return; }
      const ok = confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?\nìì›/ì½”ì¸/ì—…ê·¸ë ˆì´ë“œ/í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì´ ëª¨ë‘ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.');
      if (!ok) return; showOverlay(true);
      try{
        const data = { ...defaultData, _lastUpdated: Date.now() };
        await runTransaction(ref(db, `users/${uid}/gameData`), () => data);
        try { localStorage.removeItem(`lastWrite_${uid}`); } catch {}
        showToast('ì´ˆê¸°í™” ì™„ë£Œ!');
      }catch(e){
        console.error(e);
        showToast('ì´ˆê¸°í™” ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }finally{
        showOverlay(false);
      }
    });

    /* ===== ë™ì˜ & ì•½ê´€ ===== */
    function refreshConsentBtn(){ consentOK.disabled = !(chkConsent.checked && chkAcceptTos.checked); }
    document.getElementById('btn-open-consent').addEventListener('click', ()=>{
      chkConsent.checked=false; chkAcceptTos.checked=false; refreshConsentBtn();
      document.getElementById('consent-modal').classList.add('show');
    });
    consentCancel.addEventListener('click', ()=> document.getElementById('consent-modal').classList.remove('show'));
    chkConsent.addEventListener('change', refreshConsentBtn);
    chkAcceptTos.addEventListener('change', refreshConsentBtn);
    btnViewTos?.addEventListener('click', ()=> document.getElementById('tos-modal').classList.add('show'));
    openTosInline?.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('tos-modal').classList.add('show'); });
    tosClose?.addEventListener('click', ()=> document.getElementById('tos-modal').classList.remove('show'));

    consentOK.addEventListener('click', async () => {
      if (!uid) return; document.getElementById('consent-modal').classList.remove('show');
      const sref = ref(db, `helpSessions/${uid}`); const now = Date.now();
      const base = { ownerUid: uid, ownerEmail: meEmail || '', status: 'waiting', consentGranted: true, controlGranted: false, controlAdvanced: false, helperUid: null, helperEmail: null, createdAt: now, updatedAt: now };
      await update(sref, base);
      try{ onDisconnect(sref).update({ status:'ended', updatedAt: serverTimestamp() }); }catch{}
      showToast('ì›ê²© ë„ì›€ ìš”ì²­ì„ ë³´ëƒˆì–´ìš”');
    });

    /* ===== ì±„íŒ…(ê¸ˆì¹™ì–´ í¬í•¨) ===== */
    const banned = [
      /ì‹œ[ã…£i]ë°œ/i, /ë³‘?ì‹ /i, /ì¢†/i, /fuck/i, /shit/i, /nigg/i, /rape/i,
      /\b010[-\s]?\d{4}[-\s]?\d{4}\b/i, /(https?:\/\/|t\.me\/|discord\.gg|kakao\.me|openkakao)/i
    ];
    function isClean(text){ return !banned.some(re=>re.test(text||'')); }
    function sendUserMsg(){
      const text = (msgInput.value || '').trim();
      if (!text) return;
      if (!isClean(text)) { showToast('ë¶€ì ì ˆí•œ ë©”ì‹œì§€ëŠ” ì „ì†¡í•  ìˆ˜ ì—†ì–´ìš”'); return; }
      const mref = push(ref(db, `helpSessions/${mySessionId}/chat`));
      set(mref, { from: meEmail || 'user', role:'user', text, ts: Date.now() });
      msgInput.value = '';
    }

    function attachChatForUser(status){
      if (chatUnsub){ chatUnsub(); chatUnsub = null; }
      msgs.innerHTML = '';
      if (status !== 'connected' && status !== 'waiting') return;
      const cref = ref(db, `helpSessions/${mySessionId}/chat`);
      const off = onChildAdded(cref, (snap) => {
        const m = snap.val();
        const b = document.createElement('div');
        b.className = 'bubble ' + (m.role==='admin' || m.role==='system' ? '' : 'me') + (m.role==='system' ? ' sys' : '');
        b.innerHTML = `${escapeHtml(m.text || '')}<div class="meta">${m.from || ''}</div>`;
        msgs.appendChild(b);
        scrollToBottom(msgs);
      });
      chatUnsub = ()=> off();
    }

    /* ===== ì œì–´ ìˆ˜ì‹  (ì‚¬ìš©ì í™”ë©´ ì‹œê°í™” + ë³´ì•ˆ) ===== */
    function pulseElement(el){
      const r = el.getBoundingClientRect();
      const x = r.left + r.width/2, y = r.top + r.height/2;
      const dot = document.createElement('div');
      dot.style.cssText = `position:fixed; left:${x-10}px; top:${y-10}px; width:20px; height:20px; border-radius:50%; border:2px solid #00d4ff; background:rgba(0,212,255,.15); pointer-events:none; z-index:3002; transform:scale(.6); opacity:.95; transition: transform .3s ease, opacity .35s ease;`;
      document.body.appendChild(dot);
      requestAnimationFrame(()=>{ dot.style.transform='scale(1.4)'; dot.style.opacity='.15'; });
      setTimeout(()=>dot.remove(), 450);
    }

    function attachControlListenerForUser(status, helperUid){
      if (controlUnsub){ controlUnsub(); controlUnsub = null; }
      if (status !== 'connected') { onHelperDisconnected(); return; }
      const ctrlRef = ref(db, `helpSessions/${mySessionId}/control`);
      const off = onChildAdded(ctrlRef, async (snap) => {
        const c = snap.val() || {};
        if (!helperUid || c.fromUid !== helperUid) return;

        // navigate
        if (c.type === 'navigate' && typeof c.path === 'string'){
          if (!chkGrantControl.checked) return;
          logToIframe(`<span class="act">ê²½ë¡œ ì´ë™</span> â†’ <b>${escapeHtml(c.path)}</b>`);
          showHelperOverlay(true);
          location.href = c.path;
          return;
        }

        // alert
        if (c.type === 'alert' && typeof c.message === 'string'){
          logToIframe(`<span class="act">ì•Œë¦¼</span> â€” ${escapeHtml(c.message)}`);
          alert('[ê´€ë¦¬ì] ' + c.message);
          return;
        }

        // ping
        if (c.type === 'ping'){
          logToIframe(`<span class="act">í•‘</span> ìˆ˜ì‹ `);
          console.log('[PING from helper]', new Date().toISOString());
          return;
        }

        // ê³ ê¸‰ ì œì–´ í•„ìš”
        if (!chkGrantAdvanced.checked) return;

        const sel = c.selector;
        const el = sel ? document.querySelector(sel) : null;
        const sysNotify = async (msg) => {
          const mref = push(ref(db, `helpSessions/${mySessionId}/chat`));
          await set(mref, { from:'system', role:'system', text: msg, ts: Date.now() });
        };

        if (c.type === 'highlight'){
          if (el){ outlineElement(el); pulseAtElement(el); logToIframe(`<span class="act">í•˜ì´ë¼ì´íŠ¸</span> â€” ${escapeHtml(sel)}`); }
          return;
        }

        if (c.type === 'click'){
          if (el){
            if (isSensitive(el)){
              logToIframe(`<span class="mask">ë¯¼ê°ì˜ì—­ ë³´í˜¸: í´ë¦­ ì°¨ë‹¨</span> â€” ${escapeHtml(sel)}`);
              await sysNotify('ë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.');
              return;
            }
            try{ el.focus({preventScroll:true}); }catch{}
            try{ el.click(); }catch{}
            pulseElement(el); outlineElement(el);
            logToIframe(`<span class="act">í´ë¦­</span> â€” ${escapeHtml(sel)}`);
          }
          return;
        }

        if (c.type === 'scrollTo'){
          if (el){
            el.scrollIntoView({ behavior: c.behavior || 'smooth', block:'center' });
            outlineElement(el); pulseAtElement(el);
            logToIframe(`<span class="act">ìŠ¤í¬ë¡¤</span> â€” ${escapeHtml(sel)}`);
          }
          return;
        }
      });
      controlUnsub = ()=> off();
      onHelperConnected(sessionHelper?.textContent?.replace(' Â· ë„ìš°ë¯¸: ','') || 'ê´€ë¦¬ì');
    }

    /* ===== ì„¸ì…˜ êµ¬ë… ===== */
    function subscribeUserSession(){
      if (!mySessionId) return;
      const sref = ref(db, `helpSessions/${mySessionId}`);
      onValue(sref, (snap) => {
        const s = snap.val();
        if (!s){
          sessionStatus.innerHTML = dot('gray','ëŒ€ê¸° ì¤‘');
          sessionHelper.textContent='';
          btnEndSession.style.display = 'none';
          chkGrantControl.checked = false; chkGrantControl.disabled = true;
          chkGrantAdvanced.checked = false; chkGrantAdvanced.disabled = true;
          chatArea.style.display = 'none';
          onHelperDisconnected();
          return;
        }
        const status = s.status || 'idle';
        const helper = s.helperEmail || '';
        let label='ëŒ€ê¸° ì¤‘', color='gray';
        if (status==='waiting'){ label='ë„ìš°ë¯¸ ëŒ€ê¸° ì¤‘'; color='blue'; }
        if (status==='connected'){ label='ì—°ê²°ë¨'; color='green'; }
        if (status==='ended'){ label='ì¢…ë£Œë¨'; color='red'; }
        sessionStatus.innerHTML = dot(color, label);
        sessionHelper.textContent = helper ? ` Â· ë„ìš°ë¯¸: ${helper}` : '';

        if (status==='connected' || status==='waiting'){ btnEndSession.style.display = ''; chatArea.style.display = ''; }
        else { btnEndSession.style.display = 'none'; chatArea.style.display = 'none'; }

        chkGrantControl.disabled = (status !== 'connected');
        chkGrantAdvanced.disabled = (status !== 'connected');

        chkGrantControl.checked = !!s.controlGranted;
        chkGrantAdvanced.checked = !!s.controlAdvanced;

        attachChatForUser(status);
        attachControlListenerForUser(status, s.helperUid);
      });

      btnEndSession.onclick = async () => {
        const ok = confirm('ì„¸ì…˜ì„ ì¢…ë£Œí• ê¹Œìš”? (ì±„íŒ…/ì œì–´ ë¡œê·¸ ì‚­ì œ)');
        if (!ok) return;
        try{
          const sid = mySessionId;
          await update(ref(db, `helpSessions/${sid}`), { status:'ended', endedAt: Date.now(), updatedAt: Date.now() });
          await remove(ref(db, `helpSessions/${sid}/chat`));
          await remove(ref(db, `helpSessions/${sid}/control`));
          showToast('ì„¸ì…˜ ì¢…ë£Œ ë° ë¡œê·¸ ì‚­ì œ');
          onHelperDisconnected();
        }catch(e){ console.error(e); showToast('ì¢…ë£Œ ì‹¤íŒ¨'); }
      };

      chkGrantControl.addEventListener('change', async (e)=>{
        try{
          await update(ref(db, `helpSessions/${mySessionId}`), { controlGranted: !!e.target.checked, updatedAt: Date.now() });
          showToast(e.target.checked ? 'ì œì–´ ê¶Œí•œ ë¶€ì—¬ë¨' : 'ì œì–´ ê¶Œí•œ í•´ì œë¨');
        }catch(err){ console.error(err); showToast('ë³€ê²½ ì‹¤íŒ¨'); e.target.checked = !e.target.checked; }
      });
      chkGrantAdvanced.addEventListener('change', async (e)=>{
        try{
          await update(ref(db, `helpSessions/${mySessionId}`), { controlAdvanced: !!e.target.checked, updatedAt: Date.now() });
          showToast(e.target.checked ? 'ê³ ê¸‰ ì œì–´ ON' : 'ê³ ê¸‰ ì œì–´ OFF');
        }catch(err){ console.error(err); showToast('ë³€ê²½ ì‹¤íŒ¨'); e.target.checked = !e.target.checked; }
      });
      msgSend.addEventListener('click', sendUserMsg);
      msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendUserMsg(); });
    }

    /* ===== ê´€ë¦¬ì ì½˜ì†”(ê´€ë¦¬ìë§Œ) ===== */
    function initAdminConsole(){
      adminConsole.style.display='';
      onValue(ref(db, 'helpSessions'), (snap) => {
        const data = snap.val() || {};
        const waiting = Object.entries(data)
          .filter(([,s]) => s && s.status==='waiting' && s.consentGranted===true)
          .map(([id,s]) => ({ id, email: s.ownerEmail||id, at: s.updatedAt||s.createdAt||0 }));

        if (waiting.length === 0){ waitingListEl.textContent = 'ì—†ìŒ'; }
        else {
          waitingListEl.innerHTML = '';
          waiting.forEach(w => {
            const row = document.createElement('div');
            row.className = 'row'; row.style.marginTop = '6px';
            const when = new Date(w.at).toLocaleString();
            row.innerHTML = `<span>ì‚¬ìš©ì: <b>${escapeHtml(w.email)}</b> Â· <span class="muted">${when}</span></span>`;
            const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'ë„ì›€ ì‹œì‘';
            btn.onclick = () => connectAsHelper(w.id);
            row.appendChild(btn);
            waitingListEl.appendChild(row);
          });
        }
        if (chkHelperWait.checked && !activeAdminSession && waiting.length > 0) connectAsHelper(waiting[0].id);
      });

      chkHelperWait.addEventListener('change', ()=> showToast(chkHelperWait.checked ? 'ë„ì›€ ëŒ€ê¸° ëª¨ë“œ ON' : 'ë„ì›€ ëŒ€ê¸° ëª¨ë“œ OFF'));
      document.querySelectorAll('button[data-nav]').forEach(b=>{ b.addEventListener('click', ()=> { navPath.value = b.getAttribute('data-nav'); }); });
      btnSendNav.addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        sendControl(activeAdminSession, { type:'navigate', path: (navPath.value||'/game.html') });
      });
      document.getElementById('btn-ping').addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        sendControl(activeAdminSession, { type:'ping' });
      });
      document.getElementById('btn-alert').addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const msg = prompt('ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ì•Œë¦¼ ë©”ì‹œì§€:','ì›ê²© ì§€ì› í…ŒìŠ¤íŠ¸');
        if (msg) sendControl(activeAdminSession, { type:'alert', message: msg.slice(0,300) });
      });
      const throttle = (()=>{ let t=0; return (ms=120)=>{ const n=Date.now(); if(n-t<ms) return true; t=n; return false; };})();
      document.getElementById('btn-highlight').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'highlight', selector: sel });
      });
      document.getElementById('btn-click').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'click', selector: sel });
      });
      document.getElementById('btn-scroll').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'scrollTo', selector: sel, behavior:'smooth' });
      });

      msgSendAdmin.addEventListener('click', ()=>{
        if (!activeAdminSession) return;
        const text = (msgInputAdmin.value||'').trim();
        if (!text) return;
        if (!isClean(text)) { showToast('ë¶€ì ì ˆí•œ ë©”ì‹œì§€ëŠ” ì°¨ë‹¨ë©ë‹ˆë‹¤'); return; }
        const mref = push(ref(db, `helpSessions/${activeAdminSession}/chat`));
        set(mref, { from: meEmail || 'admin', role:'admin', text, ts: Date.now() });
        msgInputAdmin.value = '';
      });
      msgInputAdmin.addEventListener('keydown', (e)=>{ if(e.key==='Enter') msgSendAdmin.click(); });
      document.getElementById('btn-leave-session').addEventListener('click', endAdminSession);
    }

    async function connectAsHelper(sessionId){
      const user = auth.currentUser; if (!user) return showToast('ë¡œê·¸ì¸ í•„ìš”');
      const sref = ref(db, `helpSessions/${sessionId}`);
      let ok = false;
      await runTransaction(sref, (s) => {
        if (!s || s.status!=='waiting' || s.helperUid) return s;
        s.status = 'connected';
        s.helperUid = user.uid;
        s.helperEmail = user.email || ADMIN_EMAIL;
        s.connectedAt = Date.now();
        s.updatedAt = Date.now();
        ok = true;
        return s;
      });
      if (!ok) return showToast('ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì²˜ë¦¬ë˜ì—ˆì–´ìš”');
      activeAdminSession = sessionId;
      adminSessionLabel.textContent = 'ì„¸ì…˜: ' + sessionId;
      adminTools.style.display = '';
      btnLeaveSession.style.display = '';
      attachChatForAdmin(sessionId);
      showToast('ì‚¬ìš©ìì™€ ì—°ê²°ë¨');
      try{ onDisconnect(sref).update({ status:'waiting', helperUid:null, helperEmail:null, updatedAt: serverTimestamp() }); }catch{}
    }

    async function endAdminSession(){
      if (!activeAdminSession) return;
      try{
        const sid = activeAdminSession;
        await update(ref(db, `helpSessions/${sid}`), { status:'ended', endedAt: Date.now(), updatedAt: Date.now() });
        await remove(ref(db, `helpSessions/${sid}/chat`));
        await remove(ref(db, `helpSessions/${sid}/control`));
      }catch(e){ console.error(e); }
      cleanupAdminSessionUI();
      showToast('ì„¸ì…˜ ì¢…ë£Œë¨');
    }

    function cleanupAdminSessionUI(){
      activeAdminSession = null;
      adminTools.style.display = 'none';
      adminSessionLabel.textContent = '';
      btnLeaveSession.style.display = 'none';
      if (chatUnsubAdmin){ chatUnsubAdmin(); chatUnsubAdmin = null; }
      msgsAdmin.innerHTML = '';
    }

    function attachChatForAdmin(sessionId){
      if (chatUnsubAdmin){ chatUnsubAdmin(); chatUnsubAdmin = null; }
      msgsAdmin.innerHTML = '';
      const cref = ref(db, `helpSessions/${sessionId}/chat`);
      const off = onChildAdded(cref, (snap) => {
        const m = snap.val();
        const b = document.createElement('div');
        const mine = (m.role==='admin');
        b.className = 'bubble ' + (mine ? 'me':'' ) + (m.role==='system' ? ' sys':'' );
        b.innerHTML = `${escapeHtml(m.text || '')}<div class="meta">${m.from || ''}</div>`;
        msgsAdmin.appendChild(b);
        scrollToBottom(msgsAdmin);
      });
      chatUnsubAdmin = ()=> off();
    }

    function sendControl(sessionId, payload){
      const pref = push(ref(db, `helpSessions/${sessionId}/control`));
      set(pref, { ...payload, fromUid: uid, ts: Date.now() });
    }
  </script>
</body>
</html>
