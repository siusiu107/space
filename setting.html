<!-- /setting.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>âš™ï¸ ì„¤ì • - íƒœì–‘ê³„ ì •ë³µ</title>

  <style>
    :root{
      --glass-bg: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(6,7,12,0.55));
      --stroke: rgba(255,255,255,0.12);
      --muted: #bcd8ee;
      --accent: #00c0ff;
      --accent-2:#00a2ff;
      --danger:#ff6b6b;
      --ok:#36d399;
      --warn:#ffd166;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:0; font-family: Inter, Arial, sans-serif;
      background:url('/images/space-bg.jpg') center/cover no-repeat fixed;
      color:#e6f7ff;
    }
    a{ color:inherit; text-decoration:none; }

    /* ìƒë‹¨ë°” */
    #topbar{
      position:fixed; top:8px; left:8px; right:8px; z-index: 1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-radius:12px;
      background: rgba(20,24,34,0.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border:1px solid var(--stroke);
    }
    #back-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:10px; cursor:pointer;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border:1px solid var(--stroke); font-weight:800;
    }
    #back-btn:hover{ filter:brightness(1.05); }
    #addr{ font-size:12px; color: var(--muted); user-select:none; }

    /* ì»¨í…Œì´ë„ˆ */
    #container{ width: min(920px, 92vw); margin: 70px auto 28px; }
    .card{
      background: var(--glass-bg);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
      padding:16px; margin: 14px 0;
    }
    h1{ margin:0 0 8px; font-size:22px; color:#dff7ff; }
    h2{ margin:4px 0 8px; font-size:18px; color:#dff7ff; }
    .sub{ margin:0 0 18px; font-size:13px; color:var(--muted); }

    /* ì„¤ì • ì•„ì´í…œ */
    .item{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      margin:10px 0;
    }
    .item .left{ display:flex; align-items:center; gap:10px; }
    .item .title{ font-weight:800; }
    .item .desc{ font-size:12px; color:var(--muted); }
    .item .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    /* ë²„íŠ¼ */
    .btn{
      padding:10px 12px; border:1px solid var(--stroke);
      color:#001218; font-weight:800; border-radius:10px; cursor:pointer;
      background-image: linear-gradient(180deg, var(--accent), var(--accent-2));
    }
    .btn.secondary{
      color:#e6f7ff;
      background-image:none; background:linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03));
    }
    .btn.danger{
      background-image:none; color:#ffecec;
      background: linear-gradient(180deg, rgba(255,50,50,0.9), rgba(200,0,0,0.88));
      border-color: rgba(255,80,80,0.4);
    }
    .btn.ok{
      background-image:none; color:#002a1f;
      background: linear-gradient(180deg, var(--ok), #1bbf87);
      border-color: rgba(27,191,135,0.4);
    }
    .btn.warn{
      background-image:none; color:#3b2a00;
      background: linear-gradient(180deg, var(--warn), #ffb703);
      border-color: rgba(255,215,102,0.4);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* êµ¬ë¶„ì„  */
    .hr{ height:1px; background: rgba(255,255,255,0.08); margin: 10px 0; }

    /* í† ìŠ¤íŠ¸ */
    #toast{
      position:fixed; left:50%; bottom: max(18px, env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,0.75); color:#fff; padding:10px 14px; border-radius:10px;
      opacity:0; pointer-events:none; transition:all .25s ease; z-index:2000;
      border:1px solid rgba(255,255,255,0.12);
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #overlay{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.45); z-index: 1800;
    }
    #overlay .box{
      width:300px; border-radius:14px; padding:16px; text-align:center;
      background: var(--glass-bg); border:1px solid var(--stroke);
      color:#dff7ff;
    }
    .spinner{
      width:42px; height:42px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.18); border-top-color: var(--accent);
      margin: 10px auto; animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ì±„íŒ… */
    .chat{
      display:grid; grid-template-rows: 1fr auto; gap:8px;
      height: 260px; border:1px solid rgba(255,255,255,0.08); border-radius:12px;
      padding:10px; background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));
    }
    .chat-messages{
      overflow:auto; padding-right:6px;
      scroll-behavior:smooth;
    }
    .bubble{
      max-width: 78%; padding:8px 10px; margin:6px 0; border-radius:12px;
      background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
      word-break: break-word; font-size:14px;
    }
    .me{ margin-left:auto; background: rgba(0,192,255,0.15); border-color: rgba(0,192,255,0.35); }
    .sys{ background: rgba(255,255,255,0.04); font-size:12px; opacity:.95; }
    .meta{ font-size:11px; color:#bcd8ee; margin-top:2px; }
    .chat-input{ display:flex; gap:6px; }
    .chat-input input{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color:#e6f7ff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted{ color:#bcd8ee; font-size:12px; }

    /* ìƒíƒœ ì  */
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot.gray{ background:#6b7280; }
    .dot.blue{ background:#38bdf8; }
    .dot.green{ background:#22c55e; }
    .dot.red{ background:#ef4444; }
    .dot.yellow{ background:#f59e0b; }

    /* ë™ì˜/ì•½ê´€ ëª¨ë‹¬ */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1900; }
    .modal.show{ display:flex; }
    .modal .panel{
      width:min(560px, 92vw); border-radius:14px; padding:16px;
      background: var(--glass-bg); border:1px solid var(--stroke); color:#e6f7ff;
    }
    .panel .title{ font-weight:800; font-size:18px; margin-bottom:6px; }
    .panel .desc{ font-size:13px; color:var(--muted); }
    .panel .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    label.checkbox{ display:flex; gap:8px; align-items:flex-start; margin-top:10px; font-size:13px; }
    input[type="checkbox"]{ transform: scale(1.1); }
    footer{ margin:12px 0 24px; text-align:center; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <div id="topbar">
    <button id="back-btn" aria-label="ëŒì•„ê°€ê¸°">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
    <div id="addr">ì„¤ì •</div>
  </div>

  <div id="container">
    <div class="card">
      <h1>âš™ï¸ ì„¤ì •</h1>
      <p class="sub">ì‹¤ì œë¡œ ì œê³µë˜ëŠ” ì„¤ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.</p>

      <!-- ê³„ì • -->
      <div class="item">
        <div class="left">
          <div>ğŸ‘¤</div>
          <div>
            <div class="title">ê³„ì •</div>
            <div class="desc" id="account-desc">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
          </div>
        </div>
        <div class="right">
          <button id="signout-btn" class="btn secondary" disabled>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- ë°ì´í„°(ì‹¤ì œ ë™ì‘) -->
      <div class="item">
        <div class="left">
          <div>â™»ï¸</div>
          <div>
            <div class="title">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”</div>
            <div class="desc">ìì›Â·ì½”ì¸Â·ì—…ê·¸ë ˆì´ë“œÂ·í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="right">
          <button id="reset-btn" class="btn danger" disabled>ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <!-- ========== ğŸ›°ï¸ ì›ê²© ë„ì›€ ========== -->
    <div class="card" id="remote-card">
      <h2>ğŸ›°ï¸ ì›ê²© ë„ì›€</h2>
      <p class="sub">ë„ìš°ë¯¸ ì—°ê²° ì‹œ ì±„íŒ… ê°€ëŠ¥, <b>ë™ì˜í•œ ê²½ìš°ì—ë§Œ</b> ì œì–´ ê¶Œí•œì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>

      <!-- ì‚¬ìš©ì ì„¹ì…˜ -->
      <div class="item" id="user-remote">
        <div class="left">
          <div>ğŸ™‹</div>
          <div>
            <div class="title">ë‚´ ë„ì›€ ì„¸ì…˜</div>
            <div class="desc">
              <span id="session-status"><span class="dot gray"></span>ëŒ€ê¸° ì¤‘</span>
              <span class="muted" id="session-helper"></span>
            </div>
          </div>
        </div>
        <div class="right">
          <button id="btn-open-consent" class="btn" disabled>ì›ê²© ë„ì›€ ìš”ì²­</button>
          <button id="btn-end-session" class="btn danger" style="display:none;">ì¢…ë£Œ</button>

          <label class="checkbox" title="ë„ìš°ë¯¸ê°€ ë‚´ ë¸Œë¼ìš°ì € ê²½ë¡œ ì´ë™ì„ ì§€ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
            <input id="chk-grant-control" type="checkbox" disabled />
            <span class="muted">ì œì–´ ê¶Œí•œ(ë„¤ë¹„ê²Œì´ì…˜)</span>
          </label>

          <label class="checkbox" title="ë„ìš°ë¯¸ê°€ í´ë¦­/ìŠ¤í¬ë¡¤ ê°™ì€ ìƒí˜¸ì‘ìš©ì„ ì›ê²©ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.">
            <input id="chk-grant-advanced" type="checkbox" disabled />
            <span class="muted">ê³ ê¸‰ ì œì–´(í´ë¦­Â·ìŠ¤í¬ë¡¤)</span>
          </label>

          <button id="btn-view-tos" class="btn secondary" style="margin-left:6px;">ì´ìš©ì•½ê´€</button>
        </div>
      </div>

      <!-- ì±„íŒ… -->
      <div class="item" id="chat-area" style="display:none;">
        <div class="left" style="flex-direction:column; align-items:stretch; width:100%;">
          <div class="row" style="justify-content:space-between;">
            <div class="title">ì±„íŒ…</div>
            <div class="muted" id="chat-tip">ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë©”ì‹œì§€ëŠ” ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</div>
          </div>
          <div class="chat" aria-live="polite">
            <div id="msgs" class="chat-messages"></div>
            <div class="chat-input">
              <input id="msg-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥..." maxlength="1000" />
              <button id="msg-send" class="btn secondary">ì „ì†¡</button>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">â€» ë¶€ì ì ˆÂ·ëª¨ìš•Â·ì°¨ë³„Â·ê´‘ê³ Â·ì—°ë½ì²˜ ê³µìœ ëŠ” ê¸ˆì§€ë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <!-- ê´€ë¦¬ì ì½˜ì†” -->
      <div class="item" id="admin-console" style="display:none;">
        <div class="left" style="flex-direction:column; align-items:flex-start;">
          <div class="title">ê´€ë¦¬ì ì½˜ì†”</div>
          <div class="desc">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìë¥¼ ìë™ìœ¼ë¡œ ì—°ê²°í•˜ê³ , ê²½ë¡œ ì´ë™Â·í•˜ì´ë¼ì´íŠ¸Â·í´ë¦­ ë“± ì œì–´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

          <div class="row" style="margin-top:8px;">
            <label class="checkbox">
              <input id="chk-helper-wait" type="checkbox" />
              <span>ë„ì›€ ëŒ€ê¸° ëª¨ë“œ(ìë™ ì—°ê²°)</span>
            </label>
            <button id="btn-leave-session" class="btn danger" style="display:none;">ì„¸ì…˜ ì¢…ë£Œ</button>
          </div>

          <div class="hr" style="width:100%;"></div>

          <div class="title" style="margin-top:2px;">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­</div>
          <div id="waiting-list" class="muted">ì—†ìŒ</div>

          <div class="hr" style="width:100%;"></div>

          <div id="admin-tools" style="display:none; width:100%;">
            <div class="row" style="justify-content:space-between;">
              <div class="title">ì œì–´ íŒ¨ë„</div>
              <div class="muted" id="admin-session-label"></div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="row" style="margin-top:6px;">
              <input id="nav-path" type="text" placeholder="/game.html" style="flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color:#e6f7ff;">
              <button id="btn-send-nav" class="btn">ê²½ë¡œ ì´ë™</button>
              <button class="btn secondary" data-nav="/game.html">/game.html</button>
              <button class="btn secondary" data-nav="/setting.html">/setting.html</button>
              <button class="btn secondary" data-nav="/ranking.html">/ranking.html</button>
            </div>

            <!-- ê³ ê¸‰ ì œì–´ -->
            <div class="row" style="margin-top:10px; width:100%; flex-wrap:wrap;">
              <input id="sel-input" type="text" placeholder="CSS ì„ íƒì (ì˜ˆ: #upgrade-ship, [data-action='rank'])" style="flex:1; min-width:240px; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color:#e6f7ff;">
              <button id="btn-highlight" class="btn ok" title="ì‚¬ìš©ì í™”ë©´ì—ì„œ í•´ë‹¹ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸">í•˜ì´ë¼ì´íŠ¸</button>
              <button id="btn-click" class="btn" title="ì‚¬ìš©ì í™”ë©´ì—ì„œ í•´ë‹¹ ìš”ì†Œ í´ë¦­">í´ë¦­</button>
              <button id="btn-scroll" class="btn secondary" title="í•´ë‹¹ ìš”ì†Œë¡œ ìŠ¤í¬ë¡¤">ìŠ¤í¬ë¡¤</button>
              <button id="btn-alert" class="btn warn">ì•Œë¦¼</button>
              <button id="btn-ping" class="btn secondary">í•‘</button>
            </div>

            <div class="hr" style="width:100%;"></div>

            <div class="title">ì±„íŒ…(ê´€ë¦¬ì)</div>
            <div class="chat">
              <div id="msgs-admin" class="chat-messages"></div>
              <div class="chat-input">
                <input id="msg-input-admin" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥..." maxlength="1000" />
                <button id="msg-send-admin" class="btn secondary">ì „ì†¡</button>
              </div>
            </div>
            <div class="muted" style="margin-top:6px;">â€» ë¶€ì ì ˆ ë‚´ìš© ì „ì†¡ ì‹œ ìë™ ì°¨ë‹¨ë©ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <footer>íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ Â· v0.1.0</footer>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" role="status" aria-live="polite">ì•Œë¦¼</div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="overlay" aria-hidden="true">
    <div class="box">
      <div>ì²˜ë¦¬ ì¤‘â€¦</div>
      <div class="spinner" aria-hidden="true"></div>
      <div style="font-size:12px;color:#cfe7ff;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <!-- ë™ì˜ ëª¨ë‹¬ -->
  <div id="consent-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consent-title">
    <div class="panel">
      <div id="consent-title" class="title">ì›ê²© ë„ì›€ ìš”ì²­ ë™ì˜</div>
      <div class="desc" style="line-height:1.6;">
        â€¢ ì—°ê²° ëŒ€ìƒ: ê´€ë¦¬ì(<b>siu46852579@gmail.com</b>)ë§Œ ê°€ëŠ¥<br/>
        â€¢ ê¸°ë³¸ ì œì–´: ì±„íŒ… + í˜ì´ì§€ ë‚´ ë„¤ë¹„ê²Œì´ì…˜(ê²½ë¡œ ì´ë™)<br/>
        â€¢ <b>ê³ ê¸‰ ì œì–´</b>: í´ë¦­/ìŠ¤í¬ë¡¤ì€ <b>ë‚´ê°€ í† ê¸€ì„ ì¼¤ ë•Œë§Œ</b> ì‹¤í–‰ë¨. <b>ë¹„ë°€ë²ˆí˜¸/ID ë° ê°œì¸ì •ë³´ ì…ë ¥ë€</b>(type=password, [data-sensitive])ì€ ê´€ë¦¬ìì—ê²Œ <b>ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹)</b> ì²˜ë¦¬ë˜ì–´ í´ë¦­Â·í¬ì»¤ìŠ¤Â·ì…ë ¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.<br/>
        â€¢ ëª¨ë“  ì±„íŒ…Â·ì œì–´ ê¸°ë¡ì€ <b>ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì˜êµ¬ ì‚­ì œ</b><br/>
        â€¢ ì–¸ì œë“ ì§€ ì¢…ë£Œ ê°€ëŠ¥
      </div>

      <label class="checkbox"><input id="chk-consent" type="checkbox"/>
        <span>ìœ„ ë‚´ìš©ì„ ì´í•´í–ˆê³ , ì›ê²© ë„ì›€ ì—°ê²°ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
      </label>
      <label class="checkbox"><input id="chk-accept-tos" type="checkbox"/>
        <span>ë¶€ì ì ˆ ì±„íŒ… ê¸ˆì§€ ë° ì´ìš©ì•½ê´€ì„ ì½ê³  ë™ì˜í•©ë‹ˆë‹¤. (<a href="#" id="open-tos-inline">ë³´ê¸°</a>)</span>
      </label>

      <div class="actions">
        <button id="consent-cancel" class="btn secondary">ì·¨ì†Œ</button>
        <button id="consent-ok" class="btn" disabled>ë™ì˜í•˜ê³  ìš”ì²­</button>
      </div>
    </div>
  </div>

  <!-- ì´ìš©ì•½ê´€ ëª¨ë‹¬ -->
  <div id="tos-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tos-title">
    <div class="panel" style="max-height:80vh; overflow:auto;">
      <div id="tos-title" class="title">ì›ê²© ë„ì›€ ì´ìš©ì•½ê´€</div>
      <div class="desc" style="white-space:pre-wrap; line-height:1.65;">
[ëª©ì ]
ë³¸ ì•½ê´€ì€ â€œíƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤â€(ì´í•˜ â€˜ì‚¬ì´íŠ¸â€™)ì—ì„œ ì œê³µí•˜ëŠ” ì›ê²© ë„ì›€ ê¸°ëŠ¥ì˜ ì´ìš© ì¡°ê±´ì„ ê·œì •í•©ë‹ˆë‹¤.

[ì£¼ì²´]
ë„ìš°ë¯¸ëŠ” ê´€ë¦¬ì ê³„ì •(ì´ë©”ì¼: siu46852579@gmail.com)ì— í•œí•©ë‹ˆë‹¤. ì¼ë°˜ ì´ìš©ìëŠ” ë³¸ì¸ ë™ì˜ í›„ì—ë§Œ ì—°ê²°ë©ë‹ˆë‹¤.

[ì œê³µ ë²”ìœ„]
1) ê¸°ë³¸ ê¸°ëŠ¥: ì±„íŒ…, í˜ì´ì§€ ë‚´ ë„¤ë¹„ê²Œì´ì…˜(ê²½ë¡œ ì´ë™ ì§€ì‹œ)
2) ê³ ê¸‰ ì œì–´(ì„ íƒ): ì´ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ â€˜ê³ ê¸‰ ì œì–´(í´ë¦­Â·ìŠ¤í¬ë¡¤)â€™ë¥¼ í™œì„±í™”í•œ ê²½ìš°ì— í•œí•´ ë²„íŠ¼ í´ë¦­, ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸, ìŠ¤í¬ë¡¤ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3) ì œí•œ: ë¹„ë°€ë²ˆí˜¸/ID ë° ê°œì¸ì •ë³´ ì…ë ¥ë€(type=password, [data-sensitive])ì€ ê´€ë¦¬ìì—ê²Œ ë¹„ê³µê°œ(ë§ˆìŠ¤í‚¹) ì²˜ë¦¬ë˜ë©°, í´ë¦­Â·í¬ì»¤ìŠ¤Â·ì…ë ¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë°”ê¹¥ ë™ì‘, í´ë¦½ë³´ë“œ ì ‘ê·¼, íŒŒì¼ ì—…/ë‹¤ìš´ë¡œë“œ, í‚¤ë³´ë“œ ì…ë ¥ ì „ì†¡ì€ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ì ‘ì† ë° ê¸°ë¡]
ì—°ê²°Â·ì±„íŒ…Â·ì œì–´ ì´ë²¤íŠ¸ëŠ” ì„¸ì…˜ ë™ì•ˆë§Œ ì„ì‹œ ì €ì¥ë˜ë©°, ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì„œë²„ì—ì„œ ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì§€ì—° ë“± ê¸°ìˆ ì  ì‚¬ìœ ë¡œ ìˆ˜ ë¶„ ë‚´ ì‚­ì œë  ìˆ˜ ìˆìŒ)

[ì´ìš©ì ì˜ë¬´]
1) í—ˆìœ„ ì‚¬ì‹¤ ìœ í¬, ëª¨ìš•Â·í˜ì˜¤Â·ìŒë€Â·í­ë ¥ì  í‘œí˜„, ìŠ¤íŒ¸Â·ê´‘ê³ , ì—°ë½ì²˜/ì™¸ë¶€ í™ë³´ ë§í¬ ê³µìœ  ë“±ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.
2) ë¶ˆë²• ë˜ëŠ” ì œ3ì ê¶Œë¦¬ë¥¼ ì¹¨í•´í•˜ëŠ” í–‰ìœ„ë¥¼ í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
3) ë„ìš°ë¯¸ì˜ ì¡°ì‘ì„ ì›ì¹˜ ì•Šì„ ê²½ìš° ì–¸ì œë“  ì œì–´ í† ê¸€ì„ ë„ê±°ë‚˜ ì„¸ì…˜ì„ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[ë„ìš°ë¯¸ ì˜ë¬´]
1) ë„ìš°ë¯¸ëŠ” ì´ìš©ì ë™ì˜ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤.
2) ë„ìš°ë¯¸ì˜ í•˜ì´ë¼ì´íŠ¸/í´ë¦­ì€ ì´ìš©ì í™”ë©´ì— ì‹œê°ì ìœ¼ë¡œ í‘œì‹œë˜ì–´ì•¼ í•˜ë©°, ë¯¼ê° ì •ë³´ëŠ” ë¹„ê³µê°œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ê´€ë¦¬ìì˜ í™”ë©´ì—ëŠ” â€œë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.â€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.

[ë©´ì±…]
ê³ ê¸‰ ì œì–´ë¡œ ë°œìƒí•œ í˜ì´ì§€ ë‚´ ì¡°ì‘ ê²°ê³¼ëŠ” ì´ìš©ìì˜ ìë°œì  ë™ì˜ í•˜ì— ìˆ˜í–‰ë˜ë©°, ì‚¬ì´íŠ¸ëŠ” ê³ ì˜ ë˜ëŠ” ì¤‘ê³¼ì‹¤ì´ ì—†ëŠ” í•œ ì†í•´ì— ëŒ€í•´ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ë¶„ìŸ]
ë¶„ìŸ ë°œìƒ ì‹œ í•œêµ­ë²•ì„ ì¤€ê±°ë²•ìœ¼ë¡œ í•˜ë©°, ê´€í• ì€ ì‚¬ì´íŠ¸ ìš´ì˜ìì˜ ì£¼ì†Œì§€ ê´€í•  ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.
      </div>
      <div class="actions">
        <button id="tos-close" class="btn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, runTransaction, onValue, set, update, push, onChildAdded,
      onDisconnect, serverTimestamp, get, remove
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // ===== Firebase ì„¤ì • =====
    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== ê¸°ë³¸ ë°ì´í„° =====
    const defaultData = {
      resources:0, coins:0, clickPower:1,
      shipLevel:1, shipUpgradeCost:20,
      workerCount:0, conversionCount:0,
      autoConvertBought:false, ownedPlanets:[],
      _lastUpdated: Date.now()
    };

    // ===== ìƒìˆ˜/ì°¸ì¡° =====
    const ADMIN_EMAIL = 'siu46852579@gmail.com';
    const accountDesc = document.getElementById('account-desc');
    const signoutBtn  = document.getElementById('signout-btn');
    const resetBtn    = document.getElementById('reset-btn');
    const backBtn     = document.getElementById('back-btn');
    const toast       = document.getElementById('toast');
    const overlay     = document.getElementById('overlay');

    // ì›ê²© ë„ì›€ UI
    const btnOpenConsent = document.getElementById('btn-open-consent');
    const btnEndSession  = document.getElementById('btn-end-session');
    const chkGrantControl= document.getElementById('chk-grant-control');
    const chkGrantAdvanced = document.getElementById('chk-grant-advanced');
    const sessionStatus  = document.getElementById('session-status');
    const sessionHelper  = document.getElementById('session-helper');
    const chatArea       = document.getElementById('chat-area');
    const msgs           = document.getElementById('msgs');
    const msgInput       = document.getElementById('msg-input');
    const msgSend        = document.getElementById('msg-send');

    // ê´€ë¦¬ì ì½˜ì†”
    const adminConsole   = document.getElementById('admin-console');
    const chkHelperWait  = document.getElementById('chk-helper-wait');
    const waitingListEl  = document.getElementById('waiting-list');
    const adminTools     = document.getElementById('admin-tools');
    const adminSessionLabel = document.getElementById('admin-session-label');
    const btnLeaveSession   = document.getElementById('btn-leave-session');

    const msgsAdmin      = document.getElementById('msgs-admin');
    const msgInputAdmin  = document.getElementById('msg-input-admin');
    const msgSendAdmin   = document.getElementById('msg-send-admin');

    const navPath        = document.getElementById('nav-path');
    const btnSendNav     = document.getElementById('btn-send-nav');
    const selectorInput  = document.getElementById('sel-input');

    // ì•½ê´€ ëª¨ë‹¬
    const consentModal   = document.getElementById('consent-modal');
    const chkConsent     = document.getElementById('chk-consent');
    const chkAcceptTos   = document.getElementById('chk-accept-tos');
    const consentOK      = document.getElementById('consent-ok');
    const consentCancel  = document.getElementById('consent-cancel');
    const tosModal       = document.getElementById('tos-modal');
    const openTosInline  = document.getElementById('open-tos-inline');
    const tosClose       = document.getElementById('tos-close');
    const btnViewTos     = document.getElementById('btn-view-tos');

    // ===== ê³µí†µ í•¨ìˆ˜ =====
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show');
      clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600); }
    function showOverlay(show){ overlay.style.display = show ? 'flex' : 'none'; overlay.setAttribute('aria-hidden', show ? 'false':'true'); }
    function dot(color, text){ return `<span class="dot ${color}"></span>${text}`; }
    function scrollToBottom(el){ el.scrollTop = el.scrollHeight; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ===== ë’¤ë¡œê°€ê¸° =====
    backBtn.addEventListener('click', () => {
      try{ const ref = document.referrer;
        if (ref && new URL(ref).origin === location.origin) { history.back(); return; }
      }catch{}
      location.href = '/game.html';
    });

    // ===== ì¸ì¦ ìƒíƒœ =====
    let uid = null;
    let meEmail = null;
    let isAdmin = false;

    // ì„¸ì…˜ ìƒíƒœ
    let mySessionId = null;        // ì‚¬ìš©ì ì„¸ì…˜ ID = uid
    let activeAdminSession = null; // ê´€ë¦¬ìê°€ ì—°ê²°í•œ ëŒ€ìƒ
    let chatUnsub = null;
    let chatUnsubAdmin = null;
    let controlUnsub = null;

    onAuthStateChanged(auth, async (user) => {
      if (user && user.emailVerified){
        uid = user.uid;
        meEmail = user.email || '';
        isAdmin = (meEmail === ADMIN_EMAIL);

        accountDesc.textContent = `${meEmail} (ë¡œê·¸ì¸ë¨)`;
        signoutBtn.disabled = false;
        resetBtn.disabled = false;

        btnOpenConsent.disabled = false;
        chkGrantControl.disabled = true;
        chkGrantAdvanced.disabled = true;

        // ì‚¬ìš©ììš© ì„¸ì…˜
        mySessionId = uid;
        subscribeUserSession();

        // ê´€ë¦¬ì ì½˜ì†”
        if (isAdmin){ adminConsole.style.display = ''; initAdminConsole(); }
        else { adminConsole.style.display = 'none'; }
      } else if (user && !user.emailVerified){
        accountDesc.textContent = 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¸ì¦ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
        signoutBtn.disabled = false; resetBtn.disabled = true; btnOpenConsent.disabled = true;
        adminConsole.style.display = 'none';
      } else {
        accountDesc.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        signoutBtn.disabled = true; resetBtn.disabled = true; btnOpenConsent.disabled = true;
        adminConsole.style.display = 'none';
      }
    });

    // ===== ë¡œê·¸ì•„ì›ƒ =====
    signoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆì–´ìš”'); } catch (e) { showToast('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨'); }
    });

    // ===== ì´ˆê¸°í™”(ì‹¤ì œ ë™ì‘) =====
    resetBtn.addEventListener('click', async () => {
      if (!uid){ showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”'); return; }
      const ok = confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?\nìì›/ì½”ì¸/ì—…ê·¸ë ˆì´ë“œ/í–‰ì„± êµ¬ë§¤ ë‚´ì—­ì´ ëª¨ë‘ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒì•„ê°‘ë‹ˆë‹¤.');
      if (!ok) return;
      showOverlay(true);
      try{
        const data = { ...defaultData, _lastUpdated: Date.now() };
        await runTransaction(ref(db, `users/${uid}/gameData`), () => data);
        try { localStorage.removeItem(`lastWrite_${uid}`); } catch {}
        showToast('ì´ˆê¸°í™” ì™„ë£Œ!');
      }catch(e){
        console.error(e);
        showToast('ì´ˆê¸°í™” ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }finally{
        showOverlay(false);
      }
    });

    // ===== ë™ì˜/ì•½ê´€ ëª¨ë‹¬ =====
    function refreshConsentBtn(){
      consentOK.disabled = !(chkConsent.checked && chkAcceptTos.checked);
    }
    btnOpenConsent.addEventListener('click', ()=>{ chkConsent.checked=false; chkAcceptTos.checked=false; refreshConsentBtn(); consentModal.classList.add('show'); });
    consentCancel.addEventListener('click', ()=> consentModal.classList.remove('show'));
    chkConsent.addEventListener('change', refreshConsentBtn);
    chkAcceptTos.addEventListener('change', refreshConsentBtn);
    btnViewTos?.addEventListener('click', ()=> tosModal.classList.add('show'));
    openTosInline?.addEventListener('click', (e)=>{ e.preventDefault(); tosModal.classList.add('show'); });
    tosClose?.addEventListener('click', ()=> tosModal.classList.remove('show'));

    consentOK.addEventListener('click', async () => {
      if (!uid) return;
      consentModal.classList.remove('show');

      // ì„¸ì…˜ ìƒì„±/ê°±ì‹ : waiting
      const sref = ref(db, `helpSessions/${uid}`);
      const now = Date.now();
      const base = {
        ownerUid: uid, ownerEmail: meEmail || '',
        status: 'waiting',
        consentGranted: true,
        controlGranted: false,
        controlAdvanced: false,
        helperUid: null, helperEmail: null,
        createdAt: now, updatedAt: now
      };
      await update(sref, base);

      try{ onDisconnect(sref).update({ status:'ended', updatedAt: serverTimestamp() }); }catch{}

      showToast('ì›ê²© ë„ì›€ ìš”ì²­ì„ ë³´ëƒˆì–´ìš”');
    });

    // ===== ì±„íŒ… í•„í„°/ì „ì†¡ =====
    const banned = [
      /ì‹œ[ã…£i]ë°œ/i, /ë³‘?ì‹ /i, /ì¢†/i, /fuck/i, /shit/i, /nigg/i, /rape/i,
      /\b010[-\s]?\d{4}[-\s]?\d{4}\b/i,
      /(https?:\/\/|t\.me\/|discord\.gg|kakao\.me|openkakao)/i
    ];
    function isClean(text){ return !banned.some(re=>re.test(text||'')); }

    function sendUserMsg(){
      const text = (msgInput.value || '').trim();
      if (!text) return;
      if (!isClean(text)) { showToast('ë¶€ì ì ˆí•œ ë©”ì‹œì§€ëŠ” ì „ì†¡í•  ìˆ˜ ì—†ì–´ìš”'); return; }
      const mref = push(ref(db, `helpSessions/${mySessionId}/chat`));
      set(mref, { from: meEmail || 'user', role:'user', text, ts: Date.now() });
      msgInput.value = '';
    }
    function sendAdminMsg(){
      if (!activeAdminSession) return;
      const text = (msgInputAdmin.value||'').trim();
      if (!text) return;
      if (!isClean(text)) { showToast('ë¶€ì ì ˆí•œ ë©”ì‹œì§€ëŠ” ì°¨ë‹¨ë©ë‹ˆë‹¤'); return; }
      const mref = push(ref(db, `helpSessions/${activeAdminSession}/chat`));
      set(mref, { from: meEmail || 'admin', role:'admin', text, ts: Date.now() });
      msgInputAdmin.value = '';
    }

    // ===== ì‚¬ìš©ì ì„¸ì…˜/ì±„íŒ…/ì œì–´ =====
    function subscribeUserSession(){
      if (!mySessionId) return;
      const sref = ref(db, `helpSessions/${mySessionId}`);

      onValue(sref, (snap) => {
        const s = snap.val();
        if (!s){
          sessionStatus.innerHTML = dot('gray','ëŒ€ê¸° ì¤‘');
          sessionHelper.textContent = '';
          btnEndSession.style.display = 'none';
          chkGrantControl.checked = false; chkGrantControl.disabled = true;
          chkGrantAdvanced.checked = false; chkGrantAdvanced.disabled = true;
          chatArea.style.display = 'none';
          return;
        }
        const status = s.status || 'idle';
        const helper = s.helperEmail || '';
        const control = !!s.controlGranted;

        let label='ëŒ€ê¸° ì¤‘', color='gray';
        if (status==='waiting'){ label='ë„ìš°ë¯¸ ëŒ€ê¸° ì¤‘'; color='blue'; }
        if (status==='connected'){ label='ì—°ê²°ë¨'; color='green'; }
        if (status==='ended'){ label='ì¢…ë£Œë¨'; color='red'; }
        sessionStatus.innerHTML = dot(color, label);
        sessionHelper.textContent = helper ? ` Â· ë„ìš°ë¯¸: ${helper}` : '';

        if (status==='connected' || status==='waiting'){
          btnEndSession.style.display = '';
          chatArea.style.display = '';
        } else {
          btnEndSession.style.display = 'none';
          chatArea.style.display = 'none';
        }

        chkGrantControl.disabled = (status !== 'connected');
        chkGrantAdvanced.disabled = (status !== 'connected');
        chkGrantControl.checked = !!s.controlGranted;
        chkGrantAdvanced.checked = !!s.controlAdvanced;

        attachChatForUser(status);
        attachControlListenerForUser(status, control, s.helperUid);
      });

      // ì¢…ë£Œ + ë¡œê·¸ ì‚­ì œ
      btnEndSession.onclick = async () => {
        const ok = confirm('ì„¸ì…˜ì„ ì¢…ë£Œí• ê¹Œìš”? (ì±„íŒ…/ì œì–´ ë¡œê·¸ ì‚­ì œ)');
        if (!ok) return;
        try{
          const sid = mySessionId;
          await update(ref(db, `helpSessions/${sid}`), { status:'ended', endedAt: Date.now(), updatedAt: Date.now() });
          await remove(ref(db, `helpSessions/${sid}/chat`));
          await remove(ref(db, `helpSessions/${sid}/control`));
          showToast('ì„¸ì…˜ ì¢…ë£Œ ë° ë¡œê·¸ ì‚­ì œ');
        }catch(e){ console.error(e); showToast('ì¢…ë£Œ ì‹¤íŒ¨'); }
      };

      // ê¶Œí•œ í† ê¸€
      chkGrantControl.addEventListener('change', async (e)=>{
        try{
          await update(ref(db, `helpSessions/${mySessionId}`), { controlGranted: !!e.target.checked, updatedAt: Date.now() });
          showToast(e.target.checked ? 'ì œì–´ ê¶Œí•œ ë¶€ì—¬ë¨' : 'ì œì–´ ê¶Œí•œ í•´ì œë¨');
        }catch(err){ console.error(err); showToast('ë³€ê²½ ì‹¤íŒ¨'); e.target.checked = !e.target.checked; }
      });
      chkGrantAdvanced.addEventListener('change', async (e)=>{
        try{
          await update(ref(db, `helpSessions/${mySessionId}`), { controlAdvanced: !!e.target.checked, updatedAt: Date.now() });
          showToast(e.target.checked ? 'ê³ ê¸‰ ì œì–´ ON' : 'ê³ ê¸‰ ì œì–´ OFF');
        }catch(err){ console.error(err); showToast('ë³€ê²½ ì‹¤íŒ¨'); e.target.checked = !e.target.checked; }
      });

      // ì±„íŒ… ì „ì†¡ (ì‚¬ìš©ì)
      msgSend.addEventListener('click', sendUserMsg);
      msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendUserMsg(); });
    }

    function attachChatForUser(status){
      if (chatUnsub){ chatUnsub(); chatUnsub = null; }
      msgs.innerHTML = '';
      if (status !== 'connected' && status !== 'waiting') return;

      const cref = ref(db, `helpSessions/${mySessionId}/chat`);
      const off = onChildAdded(cref, (snap) => {
        const m = snap.val();
        const b = document.createElement('div');
        b.className = 'bubble ' + (m.role==='admin' || m.role==='system' ? '' : 'me') + (m.role==='system' ? ' sys' : '');
        b.innerHTML = `${escapeHtml(m.text || '')}<div class="meta">${m.from || ''}</div>`;
        msgs.appendChild(b);
        scrollToBottom(msgs);
      });
      chatUnsub = ()=> off();
    }

    function pulseElement(el){
      const r = el.getBoundingClientRect();
      const x = r.left + r.width/2, y = r.top + r.height/2;
      const dot = document.createElement('div');
      dot.style.cssText = `
        position:fixed; left:${x-10}px; top:${y-10}px; width:20px; height:20px;
        border-radius:50%; border:2px solid #00d4ff; background:rgba(0,212,255,.15);
        pointer-events:none; z-index:3000; transform:scale(.6); opacity:.95;
        transition: transform .3s ease, opacity .35s ease;
      `;
      document.body.appendChild(dot);
      requestAnimationFrame(()=>{ dot.style.transform='scale(1.4)'; dot.style.opacity='.15'; });
      setTimeout(()=>dot.remove(), 450);
    }
    function isSensitive(el){ return !!el.closest('input[type="password"], [data-sensitive="true"]'); }
    function safeClick(el){ try{ el.focus({preventScroll:true}); }catch{} try{ el.click(); }catch{} }

    // ì‚¬ìš©ì ìª½ ì œì–´ ë¦¬ìŠ¤ë„ˆ
    function attachControlListenerForUser(status, controlGranted, helperUid){
      if (controlUnsub){ controlUnsub(); controlUnsub = null; }
      if (status !== 'connected') return;
      const ctrlRef = ref(db, `helpSessions/${mySessionId}/control`);
      const off = onChildAdded(ctrlRef, async (snap) => {
        const c = snap.val() || {};
        if (!helperUid || c.fromUid !== helperUid) return;

        // ë„¤ë¹„/ì•Œë¦¼/í•‘
        if (c.type === 'navigate' && typeof c.path === 'string'){ if (!controlGranted) return; location.href = c.path; return; }
        if (c.type === 'alert' && typeof c.message === 'string'){ alert('[ê´€ë¦¬ì] ' + c.message); return; }
        if (c.type === 'ping'){ console.log('[PING from helper]', new Date().toISOString()); return; }

        // ê³ ê¸‰ ì œì–´ í•„ìš”
        if (!chkGrantAdvanced.checked) return;

        const sel = c.selector;
        const el = sel ? document.querySelector(sel) : null;

        // ë¯¼ê° ì°¨ë‹¨ + ê´€ë¦¬ìì—ê²Œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ í†µì§€
        const sysNotify = async (msg) => {
          const mref = push(ref(db, `helpSessions/${mySessionId}/chat`));
          await set(mref, { from:'system', role:'system', text: msg, ts: Date.now() });
        };

        if (c.type === 'highlight'){
          if (el){ pulseElement(el); }
        } else if (c.type === 'click'){
          if (el){
            if (isSensitive(el)){ await sysNotify('ë¯¼ê°í•œ ì •ë³´ì´ë¯€ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.'); return; }
            safeClick(el); pulseElement(el);
          }
        } else if (c.type === 'scrollTo'){
          if (el){ el.scrollIntoView({ behavior: c.behavior || 'smooth', block:'center' }); pulseElement(el); }
        }
      });
      controlUnsub = ()=> off();
    }

    // ===== ê´€ë¦¬ì ì½˜ì†” =====
    function initAdminConsole(){
      // ëŒ€ê¸° ëª©ë¡
      onValue(ref(db, 'helpSessions'), (snap) => {
        const data = snap.val() || {};
        const waiting = Object.entries(data)
          .filter(([,s]) => s && s.status==='waiting' && s.consentGranted===true)
          .map(([id,s]) => ({ id, email: s.ownerEmail||id, at: s.updatedAt||s.createdAt||0 }));

        if (waiting.length === 0){ waitingListEl.textContent = 'ì—†ìŒ'; }
        else {
          waitingListEl.innerHTML = '';
          waiting.forEach(w => {
            const row = document.createElement('div');
            row.className = 'row'; row.style.marginTop = '6px';
            const when = new Date(w.at).toLocaleString();
            row.innerHTML = `<span>ì‚¬ìš©ì: <b>${escapeHtml(w.email)}</b> Â· <span class="muted">${when}</span></span>`;
            const btn = document.createElement('button');
            btn.className = 'btn'; btn.textContent = 'ë„ì›€ ì‹œì‘';
            btn.onclick = () => connectAsHelper(w.id);
            row.appendChild(btn);
            waitingListEl.appendChild(row);
          });
        }
        if (chkHelperWait.checked && !activeAdminSession && waiting.length > 0) connectAsHelper(waiting[0].id);
      });

      chkHelperWait.addEventListener('change', ()=> showToast(chkHelperWait.checked ? 'ë„ì›€ ëŒ€ê¸° ëª¨ë“œ ON' : 'ë„ì›€ ëŒ€ê¸° ëª¨ë“œ OFF'));

      document.querySelectorAll('button[data-nav]').forEach(b=>{
        b.addEventListener('click', ()=> { navPath.value = b.getAttribute('data-nav'); });
      });

      btnSendNav.addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        sendControl(activeAdminSession, { type:'navigate', path: (navPath.value||'/game.html') });
      });

      document.getElementById('btn-ping').addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        sendControl(activeAdminSession, { type:'ping' });
      });
      document.getElementById('btn-alert').addEventListener('click', () => {
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const msg = prompt('ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ì•Œë¦¼ ë©”ì‹œì§€:','ì›ê²© ì§€ì› í…ŒìŠ¤íŠ¸');
        if (msg) sendControl(activeAdminSession, { type:'alert', message: msg.slice(0,300) });
      });

      // ê³ ê¸‰ ì œì–´ ì „ì†¡
      const throttle = (()=>{ let t=0; return (ms=120)=>{ const n=Date.now(); if(n-t<ms) return true; t=n; return false; };})();
      document.getElementById('btn-highlight').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'highlight', selector: sel });
      });
      document.getElementById('btn-click').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'click', selector: sel });
      });
      document.getElementById('btn-scroll').addEventListener('click', ()=>{
        if (!activeAdminSession) return showToast('ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ì–´ìš”');
        const sel = selectorInput.value.trim(); if (!sel) return; if (throttle()) return;
        sendControl(activeAdminSession, { type:'scrollTo', selector: sel, behavior:'smooth' });
      });

      msgSendAdmin.addEventListener('click', sendAdminMsg);
      msgInputAdmin.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendAdminMsg(); });

      btnLeaveSession.addEventListener('click', endAdminSession);
    }

    async function connectAsHelper(sessionId){
      if (!isAdmin) return showToast('ê´€ë¦¬ìë§Œ ì—°ê²°í•  ìˆ˜ ìˆì–´ìš”');
      const user = auth.currentUser;
      if (!user) return showToast('ë¡œê·¸ì¸ í•„ìš”');

      const sref = ref(db, `helpSessions/${sessionId}`);
      let ok = false;
      await runTransaction(sref, (s) => {
        if (!s || s.status!=='waiting' || s.helperUid) return s;
        s.status = 'connected';
        s.helperUid = user.uid;
        s.helperEmail = user.email || ADMIN_EMAIL;
        s.connectedAt = Date.now();
        s.updatedAt = Date.now();
        ok = true;
        return s;
      });

      if (!ok) return showToast('ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì²˜ë¦¬ë˜ì—ˆì–´ìš”');

      activeAdminSession = sessionId;
      adminSessionLabel.textContent = 'ì„¸ì…˜: ' + sessionId;
      adminTools.style.display = '';
      btnLeaveSession.style.display = '';
      attachChatForAdmin(sessionId);
      showToast('ì‚¬ìš©ìì™€ ì—°ê²°ë¨');

      try{ onDisconnect(sref).update({ status:'waiting', helperUid:null, helperEmail:null, updatedAt: serverTimestamp() }); }catch{}
    }

    async function endAdminSession(){
      if (!activeAdminSession) return;
      try{
        const sid = activeAdminSession;
        await update(ref(db, `helpSessions/${sid}`), { status:'ended', endedAt: Date.now(), updatedAt: Date.now() });
        await remove(ref(db, `helpSessions/${sid}/chat`));
        await remove(ref(db, `helpSessions/${sid}/control`));
      }catch(e){ console.error(e); }
      cleanupAdminSessionUI();
      showToast('ì„¸ì…˜ ì¢…ë£Œë¨');
    }

    function cleanupAdminSessionUI(){
      activeAdminSession = null;
      adminTools.style.display = 'none';
      adminSessionLabel.textContent = '';
      btnLeaveSession.style.display = 'none';
      if (chatUnsubAdmin){ chatUnsubAdmin(); chatUnsubAdmin = null; }
      msgsAdmin.innerHTML = '';
    }

    function attachChatForAdmin(sessionId){
      if (chatUnsubAdmin){ chatUnsubAdmin(); chatUnsubAdmin = null; }
      msgsAdmin.innerHTML = '';
      const cref = ref(db, `helpSessions/${sessionId}/chat`);
      const off = onChildAdded(cref, (snap) => {
        const m = snap.val();
        const b = document.createElement('div');
        const mine = (m.role==='admin');
        b.className = 'bubble ' + (mine ? 'me':'' ) + (m.role==='system' ? ' sys':'' );
        b.innerHTML = `${escapeHtml(m.text || '')}<div class="meta">${m.from || ''}</div>`;
        msgsAdmin.appendChild(b);
        scrollToBottom(msgsAdmin);
      });
      chatUnsubAdmin = ()=> off();
    }

    function sendControl(sessionId, payload){
      const pref = push(ref(db, `helpSessions/${sessionId}/control`));
      set(pref, { ...payload, fromUid: uid, ts: Date.now() });
    }
  </script>
</body>
</html>
