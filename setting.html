<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>⚙️ 설정 - 태양계 정복</title>
  <style>
    :root{ --glass-bg: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(6,7,12,0.55)); --stroke: rgba(255,255,255,0.12); --muted: #bcd8ee; --accent: #00c0ff; --accent-2:#00a2ff; --danger:#ff6b6b; }
    *{ box-sizing: border-box; }
    body{ margin:0; padding:0; font-family: Inter, Arial, sans-serif; background:url('/images/space-bg.jpg') center/cover no-repeat fixed; color:#e6f7ff; }
    a{ color:inherit; text-decoration:none; }
    #topbar{ position:fixed; top:8px; left:8px; right:8px; z-index: 1000; display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:12px; background: rgba(20,24,34,0.75); backdrop-filter: blur(10px); border:1px solid var(--stroke); }
    #back-btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer; background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); border:1px solid var(--stroke); font-weight:800; }
    #addr{ font-size:12px; color: var(--muted); user-select:none; }
    #container{ width: min(800px, 92vw); margin: 70px auto 28px; }
    .card{ background: var(--glass-bg); border: 1px solid var(--stroke); border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06); padding:16px; margin: 14px 0; }
    h1{ margin:0 0 8px; font-size:22px; color:#dff7ff; }
    .sub{ margin:0 0 18px; font-size:13px; color:var(--muted); }
    .item{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); margin:10px 0; }
    .item .left{ display:flex; align-items:center; gap:10px; }
    .item .title{ font-weight:800; }
    .item .desc{ font-size:12px; color:var(--muted); }
    .item .right{ display:flex; align-items:center; gap:8px; }
    .btn{ padding:10px 12px; border:1px solid var(--stroke); color:#001218; font-weight:800; border-radius:10px; cursor:pointer; background-image: linear-gradient(180deg, var(--accent), var(--accent-2)); }
    .btn.secondary{ color:#e6f7ff; background:linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03)); }
    .btn.danger{ background-image:none; color:#ffecec; background: linear-gradient(180deg, rgba(255,50,50,0.9), rgba(200,0,0,0.88)); border-color: rgba(255,80,80,0.4); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .hr{ height:1px; background: rgba(255,255,255,0.08); margin: 10px 0; }
    #toast{ position:fixed; left:50%; bottom: max(18px, env(safe-area-inset-bottom)); transform: translateX(-50%) translateY(20px); background: rgba(0,0,0,0.75); color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:all .25s ease; z-index:2000; border:1px solid rgba(255,255,255,0.12); }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    #overlay{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index: 1800; }
    #overlay .box{ width:300px; border-radius:14px; padding:16px; text-align:center; background: var(--glass-bg); border:1px solid var(--stroke); color:#dff7ff; }
    .spinner{ width:42px; height:42px; border-radius:50%; border:4px solid rgba(255,255,255,0.18); border-top-color: var(--accent); margin: 10px auto; animation: spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    footer{ margin:12px 0 24px; text-align:center; color:var(--muted); font-size:12px; }

    /* 상담사 콘솔 */
    #agent-console{ display:none; }
    #agent-console.active{ display:block; }
    #cbrw-frame{ width:100%; height:70vh; border:1px solid rgba(255,255,255,0.1); border-radius:12px; }
    #agent-status{ font-size:12px; color:#bcd8ee; margin:8px 2px; }
  </style>
</head>
<body>
  <!-- 상단바 -->
  <div id="topbar">
    <button id="back-btn" aria-label="돌아가기">⬅️ 돌아가기</button>
    <div id="addr">/setting</div>
  </div>

  <div id="container">
    <div class="card">
      <h1>⚙️ 설정</h1>
      <p class="sub">실제로 제공되는 설정만 표시합니다.</p>

      <!-- 계정 -->
      <div class="item">
        <div class="left">
          <div>👤</div>
          <div>
            <div class="title">계정</div>
            <div class="desc" id="account-desc">로그인 상태 확인 중…</div>
          </div>
        </div>
        <div class="right">
          <button id="signout-btn" class="btn secondary" disabled>로그아웃</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- 데이터(실제 동작) -->
      <div class="item">
        <div class="left">
          <div>♻️</div>
          <div>
            <div class="title">게임 데이터 초기화</div>
            <div class="desc">자원·코인·업그레이드·행성 구매 내역을 기본값으로 되돌립니다.</div>
          </div>
        </div>
        <div class="right">
          <button id="reset-btn" class="btn danger" disabled>초기화</button>
        </div>
      </div>
    </div>

    <!-- 상담사 콘솔(관리자 계정 전용) -->
    <div id="agent-console" class="card">
      <h1>🛰 상담사 콘솔</h1>
      <p class="sub">사용자 도움요청이 오면 자동 연결됩니다.</p>
      <div id="agent-status">대기 중…</div>
      <iframe id="cbrw-frame" title="Cobrowse Connect" allow="clipboard-read; clipboard-write"></iframe>
    </div>

    <footer>태양계 정복: 우주 생존 클릭커 · v0.1.0</footer>
  </div>

  <!-- 토스트 & 오버레이 -->
  <div id="toast" role="status" aria-live="polite">알림</div>
  <div id="overlay" aria-hidden="true">
    <div class="box">
      <div>처리 중…</div>
      <div class="spinner" aria-hidden="true"></div>
      <div style="font-size:12px;color:#cfe7ff;">잠시만 기다려주세요</div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, runTransaction, onValue, update, get, child, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    try { history.replaceState(null, '', '/setting' + (location.hash || '')); } catch (e) {}

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const defaultData = {
      resources:0, coins:0, clickPower:1, shipLevel:1, shipUpgradeCost:20,
      workerCount:0, conversionCount:0, autoConvertBought:false, ownedPlanets:[], _lastUpdated: Date.now()
    };

    const accountDesc = document.getElementById('account-desc');
    const signoutBtn  = document.getElementById('signout-btn');
    const resetBtn    = document.getElementById('reset-btn');
    const backBtn     = document.getElementById('back-btn');
    const toast       = document.getElementById('toast');
    const overlay     = document.getElementById('overlay');

    function showToast(msg){
      toast.textContent = msg; toast.classList.add('show');
      clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600);
    }
    function showOverlay(show){
      overlay.style.display = show ? 'flex' : 'none';
      overlay.setAttribute('aria-hidden', show ? 'false':'true');
    }

    backBtn.addEventListener('click', () => { location.href = '/game.html'; });

    let uid = null;
    let isAgent = false;

    onAuthStateChanged(auth, async (user) => {
      if (user && user.emailVerified){
        uid = user.uid;
        accountDesc.textContent = `${user.email} (로그인됨)`;
        signoutBtn.disabled = false;
        resetBtn.disabled = false;

        // === Cobrowse 사용자 식별/시작 (설정 페이지도 제어 가능하게)
        try{
          window.CobrowseIO = window.CobrowseIO || {};
          CobrowseIO.customData = { user_id: uid, user_email: user.email || '', page: location.pathname };
          await CobrowseIO.client?.(); CobrowseIO.start?.();
        }catch(e){}

        // === 상담사 모드 진입: 관리자 계정
        isAgent = (user.email === 'siu46852579@gmail.com');
        if (isAgent) startAgentConsole();

      } else if (user && !user.emailVerified){
        accountDesc.textContent = '이메일 인증이 필요합니다. 인증 후 다시 시도하세요.';
        signoutBtn.disabled = false; resetBtn.disabled = true;
        try { await sendEmailVerification(user); } catch {}
      } else {
        accountDesc.textContent = '로그인이 필요합니다.';
        signoutBtn.disabled = true; resetBtn.disabled = true;
      }
    });

    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      showToast('로그아웃 되었어요');
    });

    resetBtn.addEventListener('click', async () => {
      if (!uid){ showToast('로그인 후 이용하세요'); return; }
      const ok = confirm('정말 초기화할까요?\n자원/코인/업그레이드/행성 구매 내역이 모두 기본값으로 되돌아갑니다.');
      if (!ok) return;
      showOverlay(true);
      try{
        const data = { ...defaultData, _lastUpdated: Date.now() };
        await runTransaction(ref(db, `users/${uid}/gameData`), () => data);
        try { localStorage.removeItem(`lastWrite_${uid}`); } catch {}
        showToast('초기화 완료!');
      }catch(e){
        console.error(e); showToast('초기화 실패. 네트워크를 확인하세요.');
      }finally{ showOverlay(false); }
    });

    // ========== 상담사 콘솔 자동 연결 ==========
    const agentConsole = document.getElementById('agent-console');
    const agentStatus  = document.getElementById('agent-status');
    const frame        = document.getElementById('cbrw-frame');
    let watching = false;

    function startAgentConsole(){
      agentConsole.classList.add('active');
      if (watching) return; watching = true;

      const sessionsRef = ref(db, 'support/sessions');
      onValue(sessionsRef, async (snap) => {
        const all = snap.exists() ? snap.val() : {};
        const waiting = Object.values(all).filter(s => s.status === 'waiting')
          .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0))[0];

        if (!waiting) {
          agentStatus.textContent = '대기 중… 새로운 요청이 오면 자동 연결합니다.';
          frame.src = 'about:blank';
          return;
        }

        agentStatus.textContent = `사용자 연결 중… (uid: ${waiting.user?.uid || 'unknown'})`;
        frame.src = waiting.connectUrl || `https://cobrowse.io/connect?filter_user_id=${encodeURIComponent(waiting.user?.uid||'')}`;

        frame.onload = async () => {
          agentStatus.textContent = '세션 뷰 로드됨. 원격제어 요청 중…';
          // 선택: Agent SDK가 로드되어 있으면 원격제어 자동 요청 시도
          try {
            const api = window.CobrowseAPI || window.CobrowseAgent;
            if (api && typeof api.attachContext === 'function') {
              const ctx = await api.attachContext(frame);
              await ctx.setTool?.('control');
              await ctx.setRemoteControl?.('requested');
            }
          } catch(e) { console.warn('Agent SDK attach 실패(선택사항)', e); }

          try {
            await update(ref(db, `support/sessions/${waiting.id}`), { status: 'connecting', connectedAt: Date.now() });
          } catch {}
        };
      });
    }

    // 창 닫힘 시: 진행 중 세션 종료 & 채팅 삭제
    window.addEventListener('beforeunload', async () => {
      if (!isAgent) return;
      try{
        const snap = await get(ref(db, 'support/sessions'));
        if (snap.exists()) {
          const updates = {};
          Object.entries(snap.val()).forEach(([id, s]) => {
            if (s.status === 'connecting' || s.status === 'waiting') {
              updates[`support/sessions/${id}/status`]  = 'ended';
              updates[`support/sessions/${id}/endedAt`] = Date.now();
              updates[`support/chats/${id}`] = null; // 채팅 내용 삭제
            }
          });
          if (Object.keys(updates).length) await update(ref(db), updates);
        }
      }catch(e){}
    });
  </script>

  <!-- Cobrowse.io (설정 페이지도 제어 가능) -->
  <script src="https://js.cobrowse.io/CobrowseIO.js"></script>
  <script>
    CobrowseIO.license = 'eFtcbWqBdRylMQ';
    CobrowseIO.capabilities = ['cursor','pointer','scroll','keypress','select'];
    CobrowseIO.trustedOrigins = [
      location.origin,
      'https://siustudio.kro.kr',
      'https://xn--989a202a4ogwtc69p.siustudio.kro.kr'
    ];
    // (개발용) 사용자 원격제어 자동 허용 — 운영은 제거 권장
    CobrowseIO.confirmRemoteControl = function(){ return Promise.resolve(true); };
    CobrowseIO.client().then(function(){ CobrowseIO.start(); });
  </script>

  <!-- (선택) Cobrowse Agent SDK: 자동 원격제어 요청에 사용 -->
  <script src="https://cdn.jsdelivr.net/npm/cobrowse-agent-sdk@2.11.0/dist/index.umd.js"></script>
</body>
</html>
