<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>âš™ï¸ ì„¤ì • - íƒœì–‘ê³„ ì •ë³µ</title>
  <style>
    :root{
      --glass-bg: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(6,7,12,0.55));
      --stroke: rgba(255,255,255,0.12);
      --muted: #bcd8ee;
      --accent: #00c0ff;
      --accent-2:#00a2ff;
      --danger:#ff6b6b;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:0; font-family: Inter, Arial, sans-serif;
      background:#0b1220 url('/images/space-bg.jpg') center/cover no-repeat fixed;
      color:#e6f7ff;
    }
    a{ color:inherit; text-decoration:none; }
    #topbar{
      position:fixed; top:8px; left:8px; right:8px; z-index: 1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border-radius:12px;
      background: rgba(20,24,34,0.75);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border:1px solid var(--stroke);
    }
    #back-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:10px; cursor:pointer;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border:1px solid var(--stroke); font-weight:800;
    }
    #back-btn:hover{ filter:brightness(1.05); }
    #addr{ font-size:12px; color: var(--muted); user-select:none; }
    #container{ width: min(980px, 94vw); margin: 70px auto 28px; display:grid; gap:16px; }
    .card{
      background: var(--glass-bg); border: 1px solid var(--stroke);
      border-radius: 16px; box-shadow: 0 16px 40px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
      padding:16px;
    }
    h1{ margin:0 0 8px; font-size:22px; color:#dff7ff; }
    .sub{ margin:0 0 18px; font-size:13px; color:var(--muted); }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      margin:10px 0;
    }
    .item .left{ display:flex; align-items:center; gap:10px; }
    .item .title{ font-weight:800; }
    .item .desc{ font-size:12px; color:var(--muted); }
    .item .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .btn{
      padding:10px 12px; border:1px solid var(--stroke);
      color:#001218; font-weight:800; border-radius:10px; cursor:pointer;
      background-image: linear-gradient(180deg, var(--accent), var(--accent-2));
    }
    .btn.secondary{
      color:#e6f7ff; background-image:none;
      background:linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03));
    }
    .btn.danger{
      background-image:none; color:#ffecec;
      background: linear-gradient(180deg, rgba(255,50,50,0.9), rgba(200,0,0,0.88));
      border-color: rgba(255,80,80,0.4);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .hr{ height:1px; background: rgba(255,255,255,0.08); margin: 10px 0; }
    #toast{
      position:fixed; left:50%; bottom: max(18px, env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,0.75); color:#fff;
      padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none;
      transition:all .25s ease; z-index:2000;
      border:1px solid rgba(255,255,255,0.12);
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    #overlay{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.45); z-index: 1800;
    }
    #overlay .box{
      width:300px; border-radius:14px; padding:16px; text-align:center;
      background: var(--glass-bg); border:1px solid var(--stroke); color:#dff7ff;
    }
    .spinner{
      width:42px; height:42px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.18); border-top-color: var(--accent);
      margin: 10px auto; animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    footer{ margin:12px 0 24px; text-align:center; color:var(--muted); font-size:12px; }
    .chat-wrap{
      display:none; margin-top:10px; border:1px solid var(--stroke);
      border-radius:12px; padding:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    }
    .chat-wrap .log{
      height:220px; overflow:auto; border:1px solid rgba(255,255,255,0.08);
      border-radius:10px; padding:8px; background:rgba(0,0,0,0.2);
      font-size:14px;
    }
    .chat-wrap .row{ display:flex; gap:8px; margin-top:8px; }
    .chat-wrap input{
      flex:1; padding:10px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.18); background:rgba(0,0,0,0.25); color:#e6f7ff;
    }
    #tos{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2100;
      background: rgba(0,0,0,0.5);
    }
    #tos .panel{
      width:min(720px, 92vw); max-height:80vh; overflow:auto;
      background: var(--glass-bg); border:1px solid var(--stroke);
      border-radius:16px; padding:16px;
    }
    #tos h3{ margin:0 0 8px; }
    #tos p{ color:#cfe7ff; font-size:14px; line-height:1.5; }
    #user-section, #admin-section{ display:none; }
    .req-wrap{ display:none; margin-top:10px; border:1px solid var(--stroke); border-radius:12px; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); }
    .req-list{ max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:10px; background:rgba(0,0,0,0.2); }
    .req-row{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .req-row:last-child{ border-bottom:none; }
    .req-code{ font-weight:800; letter-spacing:0.5px; margin-right:6px; }
    .badge{ font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,0.18); margin-right:6px; }
    .badge.active{ background:rgba(0,200,255,0.12); }
    .badge.ended{ background:rgba(255,80,80,0.12); }
    .muted{ color:var(--muted); font-size:12px; }
    .req-actions{ display:flex; gap:6px; }
  </style>
</head>
<body>
  <div id="topbar">
    <button id="back-btn" aria-label="ëŒì•„ê°€ê¸°">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
    <div id="addr">/setting</div>
  </div>

  <div id="container">
    <div id="user-section" class="card">
      <h1>âš™ï¸ ì„¤ì •</h1>
      <p class="sub">ì‹¤ì œë¡œ ì œê³µë˜ëŠ” ì„¤ì •ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.</p>

      <div class="item">
        <div class="left">
          <div>ğŸ‘¤</div>
          <div>
            <div class="title">ê³„ì •</div>
            <div class="desc" id="account-desc">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
            <div class="desc" id="account-path" style="margin-top:4px; font-family:ui-monospace,Consolas,monospace;"></div>
          </div>
        </div>
        <div class="right">
          <button id="signout-btn" class="btn secondary" disabled>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="item">
        <div class="left">
          <div>â™»ï¸</div>
          <div>
            <div class="title">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”</div>
            <div class="desc">ì´ ê³„ì •ì˜ ê²Œì„ ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•œ ë’¤ ìë™ ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="right">
          <button id="reset-btn" class="btn danger" disabled>ì „ì²´ ì‚­ì œ</button>
        </div>
      </div>

      <div class="item">
        <div class="left">
          <div>ğŸ†˜</div>
          <div>
            <div class="title">ìƒë‹´ì‚¬ ë„ì›€</div>
            <div class="desc">í™”ë©´ ê³µìœ  + ì›ê²© ì œì–´ë¥¼ ìƒë‹´ì‚¬ì—ê²Œ ìš”ì²­í•©ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="right">
          <button id="help-btn" class="btn">ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?? ìƒë‹´ì‚¬ì—ê²Œ ë„ì›€ ìš”ì²­í•˜ê¸°</button>
        </div>
      </div>

      <div id="chat-user" class="chat-wrap" aria-live="polite">
        <div class="title">ìƒë‹´ì‚¬ ì±„íŒ…</div>
        <div class="desc">ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì±„íŒ…ì€ ì‚­ì œë˜ê³  ë¡œê·¸ë§Œ ë³´ì¡´ë©ë‹ˆë‹¤.</div>
        <div id="chat-log-user" class="log" role="log"></div>
        <div class="row">
          <input id="chat-input-user" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦" />
          <button id="chat-send-user" class="btn secondary">ì „ì†¡</button>
          <button id="end-session-user" class="btn danger">ì„¸ì…˜ ì¢…ë£Œ</button>
        </div>
        <div class="desc" style="margin-top:6px">ì„¸ì…˜ ì½”ë“œ: <code id="session-code-user">ì—†ìŒ</code></div>
      </div>
    </div>

    <div id="admin-section" class="card">
      <h1>ğŸ‘¨â€ğŸ’¼ ìƒë‹´ì‚¬ ì½˜ì†”</h1>
      <p class="sub">ëŒ€ì‹œë³´ë“œì—ì„œ <b>Enter code</b> ë˜ëŠ” ëª©ë¡ <b>Connect</b>ë¡œ ì›ê²© ì œì–´ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>

      <div class="item">
        <div class="left">
          <div>ğŸ”—</div>
          <div>
            <div class="title">ì„¸ì…˜ ì—°ê²°</div>
            <div class="desc">ì‚¬ìš©ìê°€ ìƒì„±í•œ 6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
          </div>
        </div>
        <div class="right">
          <input id="sess-admin" placeholder="ì„¸ì…˜ ì½”ë“œ 6ìë¦¬" />
          <button id="connect-admin" class="btn">ì—°ê²°</button>
          <button id="openDash-admin" class="btn secondary">Cobrowse ëŒ€ì‹œë³´ë“œ</button>
        </div>
      </div>

      <div class="item">
        <div class="left">
          <div>ğŸ§­</div>
          <div>
            <div class="title">ì›ê²© íƒìƒ‰/ì¡°ì‘</div>
            <div class="desc">ê²½ë¡œ ì´ë™ ë˜ëŠ” CSS ì„ íƒì í´ë¦­/í•˜ì´ë¼ì´íŠ¸ë¥¼ ì‚¬ìš©ì ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="right">
          <input id="path-admin" placeholder="/game.html ë˜ëŠ” https://example.com" />
          <button id="nav-admin" class="btn">ê²½ë¡œ ì´ë™</button>
          <input id="selector-admin" placeholder="CSS ì„ íƒì (ì˜ˆ: #buy, .btn-primary)" />
          <button id="click-admin" class="btn secondary">ì„ íƒì í´ë¦­</button>
          <button id="highlight-admin" class="btn secondary">í•˜ì´ë¼ì´íŠ¸</button>
        </div>
      </div>

      <div id="chat-admin" class="chat-wrap">
        <div class="title">ì±„íŒ…</div>
        <div id="chat-log-admin" class="log"></div>
        <div class="row">
          <input id="chat-input-admin" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦" />
          <button id="chat-send-admin" class="btn secondary">ì „ì†¡</button>
          <button id="end-session-admin" class="btn danger">ì„¸ì…˜ ì¢…ë£Œ(ì±„íŒ… ì‚­ì œ)</button>
        </div>
        <div class="desc" style="margin-top:6px" id="status-admin">ëŒ€ê¸°ì¤‘â€¦</div>
      </div>

      <div id="req-wrap" class="req-wrap">
        <div class="title">ìš”ì²­ ëª©ë¡</div>
        <div class="desc">ì‚¬ìš©ìê°€ ìƒì„±í•œ <b>í™œì„± ì„¸ì…˜</b>ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div id="req-list" class="req-list" role="list"></div>
      </div>
    </div>

    <footer>íƒœì–‘ê³„ ì •ë³µ: ìš°ì£¼ ìƒì¡´ í´ë¦­ì»¤ Â· v0.1.0</footer>
  </div>

  <div id="toast" role="status" aria-live="polite">ì•Œë¦¼</div>

  <div id="overlay" aria-hidden="true">
    <div class="box">
      <div>ì²˜ë¦¬ ì¤‘â€¦</div>
      <div class="spinner" aria-hidden="true"></div>
      <div style="font-size:12px;color:#cfe7ff;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <div id="tos" aria-modal="true" role="dialog">
    <div class="panel">
      <h3>ì›ê²© ì§€ì› ì´ìš©ì•½ê´€</h3>
      <p>ì›ê²© ì§€ì› ì„¸ì…˜ ë™ì•ˆ ìƒë‹´ì‚¬ëŠ” ê·€í•˜ì˜ ë¸Œë¼ìš°ì € í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìœ¼ë©°, ê·€í•˜ì˜ ëª…ì‹œì  ë™ì˜ê°€ ìˆì„ ê²½ìš° ë§ˆìš°ìŠ¤/í‚¤ë³´ë“œ ì…ë ¥ì„ ì›ê²©ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>ê²°ì œì •ë³´Â·ë¹„ë°€ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ê°€ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ ì£¼ì„¸ìš”. í•„ìš”í•œ ê²½ìš° í•´ë‹¹ ì˜ì—­ì€ ë§ˆìŠ¤í‚¹ë˜ê±°ë‚˜ ê³µìœ ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>ì„¸ì…˜ ì¤‘ ì±„íŒ… ë‚´ì—­ì€ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ <b>ì„ì‹œ ì €ì¥</b>ë˜ë©°, ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì±„íŒ… ë‚´ì—­ì€ ì‚­ì œë©ë‹ˆë‹¤. ë‹¤ë§Œ, ì‹œìŠ¤í…œ ë¡œê·¸(ì„¸ì…˜ ìƒì„±/ì¢…ë£Œ ì‹œê°, ì˜¤ë¥˜, ìš”ì•½ ë“±)ëŠ” í’ˆì§ˆ/ë³´ì•ˆ ëª©ì ìœ¼ë¡œ ë³´ì¡´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>ì›ê²© ì œì–´ëŠ” ì–¸ì œë“  ì¢…ë£Œí•  ìˆ˜ ìˆìœ¼ë©°, ì¢…ë£Œ ì¦‰ì‹œ ì œì–´ ê¶Œí•œì€ í•´ì œë©ë‹ˆë‹¤.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="tos-cancel" class="btn secondary">ì·¨ì†Œ</button>
        <button id="tos-accept" class="btn">ë™ì˜í•˜ê³  ì§„í–‰</button>
      </div>
    </div>
  </div>

  <!-- CobrowseIO -->
  <script>
    (function(w,t,c,p,s,e){
      p=new Promise(function(r){
        w[c]={client:function(){
          if(!s){ s=document.createElement(t);
            s.src='https://js.cobrowse.io/CobrowseIO.js'; s.async=1; s.crossOrigin='anonymous';
            e=document.getElementsByTagName(t)[0]; e.parentNode.insertBefore(s,e);
            s.onload=function(){ r(w[c]); };
          } return p;
        }}; });
    })(window,'script','CobrowseIO');
    window.CobrowseIO = window.CobrowseIO || {};
    CobrowseIO.license = "eFtcbWqBdRylMQ";
    CobrowseIO.capabilities = ["cursor","remote-control"];
  </script>

  <!-- Firebase + App Scripts -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, runTransaction, push, onChildAdded, set, remove,
      serverTimestamp, update, get, child, onChildChanged, onChildRemoved, query, orderByChild, equalTo
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    try { history.replaceState(null, '', '/setting' + (location.hash || '')); } catch (e) {}

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const backBtn     = document.getElementById('back-btn');
    const toast       = document.getElementById('toast');
    const overlay     = document.getElementById('overlay');
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600);
    }
    function showOverlay(show){
      overlay.style.display = show ? 'flex' : 'none';
      overlay.setAttribute('aria-hidden', show ? 'false':'true');
    }
    backBtn.addEventListener('click', () => { location.href = '/game.html'; });

    const userSection  = document.getElementById('user-section');
    const adminSection = document.getElementById('admin-section');

    const accountDesc = document.getElementById('account-desc');
    const accountPath = document.getElementById('account-path');
    const signoutBtn  = document.getElementById('signout-btn');
    const resetBtn    = document.getElementById('reset-btn');
    const helpBtn     = document.getElementById('help-btn');

    const chatUserWrap  = document.getElementById('chat-user');
    const chatLogUser   = document.getElementById('chat-log-user');
    const chatInputUser = document.getElementById('chat-input-user');
    const chatSendUser  = document.getElementById('chat-send-user');
    const endBtnUser    = document.getElementById('end-session-user');
    const sessionCodeElUser = document.getElementById('session-code-user');

    const tosModal  = document.getElementById('tos');
    const tosAccept = document.getElementById('tos-accept');
    const tosCancel = document.getElementById('tos-cancel');

    const sessAdmin     = document.getElementById('sess-admin');
    const connectAdmin  = document.getElementById('connect-admin');
    const openDashBtn   = document.getElementById('openDash-admin');

    const pathAdmin     = document.getElementById('path-admin');
    const navAdmin      = document.getElementById('nav-admin');
    const selectorAdmin = document.getElementById('selector-admin');
    const clickAdmin    = document.getElementById('click-admin');
    const highlightAdmin= document.getElementById('highlight-admin');

    const chatAdminWrap = document.getElementById('chat-admin');
    const chatLogAdmin  = document.getElementById('chat-log-admin');
    const chatInputAdmin= document.getElementById('chat-input-admin');
    const chatSendAdmin = document.getElementById('chat-send-admin');
    const endBtnAdmin   = document.getElementById('end-session-admin');
    const statusAdmin   = document.getElementById('status-admin');

    const reqWrap = document.getElementById('req-wrap');
    const reqList = document.getElementById('req-list');

    let uid = null;
    let userServerKey = null;
    let userIdKey     = null;
    let userBasePath  = null;

    function sanitizeIdKey(raw) {
      const s = (raw || '').toString().trim().toLowerCase();
      const base = s.replace(/[^a-z0-9._-]+/g, '_').replace(/^_+|_+$/g, '');
      return base || 'user';
    }
    function makeIdKeyFromUser(user) {
      const email = (user.email || '').toString();
      if (email.includes('@')) {
        const local = email.split('@')[0];
        return sanitizeIdKey(local);
      }
      const name = sanitizeIdKey(user.displayName || '');
      if (name && name !== 'user') return name;
      return `user_${(user.uid || '').slice(0,6) || '000000'}`;
    }

    async function ensureServerMapping(user) {
      const mapRef = ref(db, `userServerMap/${user.uid}`);
      try {
        const snap = await get(mapRef);
        if (snap.exists()) {
          const { server, id } = snap.val() || {};
          if (server && id) return { server, id };
        }
      } catch {}

      let nextIndex = 0;
      try {
        const tRef = ref(db, 'meta/nextIndex');
        const res = await runTransaction(tRef, cur => (cur || 0) + 1);
        nextIndex = res?.snapshot?.val() || 1;
      } catch { nextIndex = 1; }

      const serverNum = Math.max(1, Math.ceil(nextIndex / 15));
      let server = `server${serverNum}`;
      let idKey  = makeIdKeyFromUser(user);

      try {
        const existsSnap = await get(ref(db, `users/${server}/${idKey}`));
        if (existsSnap.exists()) idKey = `${idKey}-${(user.uid||'').slice(0,4)}`;
      } catch {}

      try {
        await update(ref(db), {
          [`userServerMap/${user.uid}`]: { server, id: idKey, createdAt: Date.now() }
        });
      } catch {}

      return { server, id: idKey };
    }

    let userSessionId = null;
    function appendMsgUser(who, text, ts){
      const d = document.createElement('div');
      const time = ts ? new Date(ts).toLocaleTimeString() : '';
      d.textContent = `[${who}] ${text} ${time?`Â· ${time}`:''}`;
      chatLogUser.appendChild(d);
      chatLogUser.scrollTop = chatLogUser.scrollHeight;
    }
    function openTos(){ tosModal.style.display = 'flex'; }
    function closeTos(){ tosModal.style.display = 'none'; }
    tosCancel.onclick = closeTos;
    const helpBtnHandler = async () => { openTos(); };
    helpBtn.addEventListener('click', helpBtnHandler);
    tosAccept.addEventListener('click', async () => { closeTos(); await startRemoteHelpUser(); });

    async function startRemoteHelpUser(){
      helpBtn.disabled = true;
      try{
        await window.CobrowseIO.client();
        await window.CobrowseIO.start();
        const code = await window.CobrowseIO.createSessionCode();
        userSessionId = code;
        sessionCodeElUser.textContent = code;

        await set(ref(db, `sessions/${userSessionId}/meta`), {
          createdAt: serverTimestamp(),
          userUid: uid || null,
          status: 'active'
        });
        await push(ref(db, `sessions/${userSessionId}/logs`), { type:'create', by:'user', at: serverTimestamp() });

        const userChatRef = ref(db, `sessions/${userSessionId}/chat`);
        onChildAdded(userChatRef, (snap)=>{
          const m = snap.val(); if (!m) return;
          appendMsgUser(m.from==='agent'?'ìƒë‹´ì‚¬':'ë‚˜', m.text, m.ts || Date.now());
        });

        const userCmdRef = ref(db, `sessions/${userSessionId}/commands`);
        onChildAdded(userCmdRef, (snap) => {
          const cmd = snap.val(); if (!cmd) return;
          if (cmd.type === 'navigate' && cmd.path) {
            try { location.assign(cmd.path); }
            catch(e){ push(ref(db, `sessions/${userSessionId}/logs`), { type:'error', msg:'navigate failed', detail:String(e), at: serverTimestamp() }); }
          } else if (cmd.type === 'click' && cmd.selector) {
            const el = document.querySelector(cmd.selector);
            if (el) {
              try {
                el.focus?.(); el.click?.();
                el.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true, view:window }));
                push(ref(db, `sessions/${userSessionId}/logs`), { type:'action', msg:'click', selector:cmd.selector, at: serverTimestamp() });
              } catch(e) {
                push(ref(db, `sessions/${userSessionId}/logs`), { type:'error', msg:'click failed', selector:cmd.selector, detail:String(e), at: serverTimestamp() });
              }
            } else {
              push(ref(db, `sessions/${userSessionId}/logs`), { type:'warn', msg:'selector not found', selector:cmd.selector, at: serverTimestamp() });
            }
          } else if (cmd.type === 'highlight' && cmd.selector) {
            const el = document.querySelector(cmd.selector);
            if (el) {
              const prev = el.style.outline;
              el.style.outline = '3px solid #00e5ff';
              setTimeout(()=>{ el.style.outline = prev; }, 1800);
              push(ref(db, `sessions/${userSessionId}/logs`), { type:'action', msg:'highlight', selector:cmd.selector, at: serverTimestamp() });
            } else {
              push(ref(db, `sessions/${userSessionId}/logs`), { type:'warn', msg:'selector not found', selector:cmd.selector, at: serverTimestamp() });
            }
          }
        });

        chatUserWrap.style.display = 'block';
        showToast('ìƒë‹´ì‚¬ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆì–´ìš”: ' + code);
        try { await navigator.clipboard.writeText(code); } catch {}
      }catch(err){
        console.error(err);
        showToast('ë„ì›€ ìš”ì²­ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }finally{
        helpBtn.disabled = false;
      }
    }

    const sendUserMsg = async () => {
      if (!userSessionId) return showToast('ì„¸ì…˜ì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”');
      const text = chatInputUser.value.trim(); if (!text) return;
      chatInputUser.value = '';
      await push(ref(db, `sessions/${userSessionId}/chat`), { from:'user', text, ts: Date.now() });
      await push(ref(db, `sessions/${userSessionId}/logs`), { type:'chat', dir:'user->agent', text, at: serverTimestamp() });
    };
    chatSendUser.addEventListener('click', sendUserMsg);
    chatInputUser.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendUserMsg(); });

    endBtnUser.addEventListener('click', async () => {
      if (!userSessionId) return;
      const ok = confirm('ì›ê²© ì§€ì› ì„¸ì…˜ì„ ì¢…ë£Œí• ê¹Œìš”? (ì±„íŒ…ë‚´ìš©ì€ ì‚­ì œë˜ê³  ë¡œê·¸ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤)');
      if (!ok) return;
      try{
        await update(ref(db, `sessions/${userSessionId}/meta`), { status:'ended', endedAt: serverTimestamp() });
        await remove(ref(db, `sessions/${userSessionId}/chat`));
        await push(ref(db, `sessions/${userSessionId}/logs`), { type:'end', by:'user', at: serverTimestamp() });
        chatUserWrap.style.display = 'none';
        sessionCodeElUser.textContent = 'ì—†ìŒ';
        userSessionId = null;
        showToast('ì„¸ì…˜ì„ ì¢…ë£Œí–ˆì–´ìš”');
      }catch(e){ console.error(e); showToast('ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨'); }
    });

    /* ------- ì €ì¥ì†Œ ì „ì²´ ì´ˆê¸°í™”(ê°•í™”íŒ) ------- */
    async function clearAllClientStorage() {
      // 1) Local/Session Storage
      try { localStorage.clear(); } catch {}
      try { sessionStorage.clear(); } catch {}

      // 2) Cache Storage (PWA/Service Worker ìºì‹œ)
      try {
        if (window.caches?.keys) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch {}

      // 3) IndexedDB (Firebase auth/ì„¤ì¹˜/ì‹¬ì¥ë°•ë™ ë“±)
      try {
        if (indexedDB && indexedDB.databases) {
          const dbs = await indexedDB.databases();
          await Promise.all((dbs || []).map(d => d?.name && indexedDB.deleteDatabase(d.name)));
        } else {
          // ë¸Œë¼ìš°ì €ê°€ databases() ë¯¸ì§€ì›ì´ë©´ í”í•œ DB ì´ë¦„ë“¤ë§Œ ë² ìŠ¤íŠ¸ì—í¬íŠ¸ë¡œ ì œê±°
          const candidates = [
            'firebaseLocalStorageDb',
            'firebase-installations-database',
            'firebase-heartbeat-database',
            'firebase-messaging-database',
            'keyval-store'
          ];
          for (const name of candidates) {
            try { indexedDB.deleteDatabase(name); } catch {}
          }
        }
      } catch {}

      // 4) (ì„ íƒ) ë“±ë¡ëœ ì„œë¹„ìŠ¤ì›Œì»¤ í•´ì œ
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
      } catch {}
    }

    // âœ… users/{server}/{id} í•˜ìœ„ë§Œ ë¹„ìš°ê³  gameData ìµœì†Œ ìƒíƒœ ì¬ì‘ì„±
    async function wipeUserNodeKeepShell(basePath){
      const baseRef = ref(db, basePath);
      const snap = await get(baseRef);

      const updates = {};
      if (snap.exists()) {
        const children = Object.keys(snap.val() || {});
        for (const key of children) {
          if (key !== 'gameData') updates[`${basePath}/${key}`] = null;
        }
      }
      updates[`${basePath}/gameData`] = {
        resources: 0,
        coins: 0,
        _lastUpdated: serverTimestamp()
      };
      await update(ref(db), updates);
    }

    // ë²„íŠ¼: ë¡œê·¸ì•„ì›ƒ
    signoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆì–´ìš”'); setTimeout(()=>location.href='/index.html', 400); }
      catch (e) { console.error(e); showToast('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨'); }
    });

    // ë²„íŠ¼: ì „ì²´ ì‚­ì œ
    resetBtn.addEventListener('click', async () => {
      if (!uid){ showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”'); return; }
      const basePath = userBasePath;
      if (!basePath){ showToast('ë°ì´í„° ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”'); return; }

      const ok = confirm(
        `ì •ë§ ì‚­ì œí• ê¹Œìš”?\n` +
        `Â· ${basePath} ë‚´ë¶€ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤(ë…¸ë“œëŠ” ìœ ì§€).\n` +
        `Â· gameDataëŠ” ìì›/ì½”ì¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n` +
        `Â· ì´ ë¸Œë¼ìš°ì €ì˜ ì €ì¥ì†Œ(local/session/IndexedDB/ìºì‹œ)ë„ ëª¨ë‘ ë¹„ì›Œì§‘ë‹ˆë‹¤.\n` +
        `Â· ì™„ë£Œ í›„ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.`
      );
      if (!ok) return;

      resetBtn.disabled = true;
      signoutBtn.disabled = true;
      helpBtn.disabled = true;
      showOverlay(true);

      try{
        // 1) ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”
        await wipeUserNodeKeepShell(basePath);

        // 2) í´ë¼ì´ì–¸íŠ¸ ì €ì¥ì†Œ ì™„ì „ ì´ˆê¸°í™”
        await clearAllClientStorage();

        // 3) ì•ˆë‚´ ë° ë¡œê·¸ì•„ì›ƒ/ë¦¬ë‹¤ì´ë ‰íŠ¸
        showToast('ë°ì´í„°/ì €ì¥ì†Œ ì´ˆê¸°í™” ì™„ë£Œ. ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤â€¦');
        try { await signOut(auth); } catch(e){ console.warn('signOut ì‹¤íŒ¨:', e); }
        setTimeout(()=>{ location.href = '/index.html'; }, 600);
      }catch(e){
        console.error(e);
        showToast('ì‚­ì œ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬/ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
        resetBtn.disabled = false;
        signoutBtn.disabled = false;
        helpBtn.disabled = false;
      }finally{
        showOverlay(false);
      }
    });

    /* ----- ê´€ë¦¬ì ê¸°ëŠ¥ ê°„ë‹¨ êµ¬í˜„ ----- */
    let adminSessionId = null;
    function appendMsgAdmin(who, text, ts){
      const d = document.createElement('div');
      const time = ts ? new Date(ts).toLocaleTimeString() : '';
      d.textContent = `[${who}] ${text} ${time?`Â· ${time}`:''}`;
      chatLogAdmin.appendChild(d);
      chatLogAdmin.scrollTop = chatLogAdmin.scrollHeight;
    }
    function bindAdminHandlers(){
      openDashBtn.onclick = () => window.open('https://cobrowse.io/dashboard', '_blank', 'noopener');
      connectAdmin.onclick = async () => {
        adminSessionId = (sessAdmin.value || '').trim();
        if (!adminSessionId) return alert('ì„¸ì…˜ ì½”ë“œ(6ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        statusAdmin.textContent = 'ì„¸ì…˜ ì—°ê²° ì¤‘â€¦';
        const base = ref(db, `sessions/${adminSessionId}`);
        const metaSnap = await get(child(base, 'meta'));
        if (!metaSnap.exists()){
          await set(child(base, 'meta'), { createdAt: serverTimestamp(), status:'active' });
        }
        onChildAdded(child(base, 'chat'), (snap) => {
          const m = snap.val(); if (!m) return;
          appendMsgAdmin(m.from==='user'?'ì‚¬ìš©ì':'ìƒë‹´ì‚¬', m.text, m.ts || Date.now());
        });
        chatAdminWrap.style.display = 'block';
        statusAdmin.textContent = 'ì±„íŒ… ì—°ê²°ë¨';
      };
      navAdmin.onclick = async () => {
        if (!adminSessionId) return alert('ë¨¼ì € ì„¸ì…˜ì„ ì—°ê²°í•˜ì„¸ìš”.');
        const path = (pathAdmin.value || '').trim();
        if (!path) return alert('ì´ë™í•  ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        await push(ref(db, `sessions/${adminSessionId}/commands`), { type:'navigate', path, at: Date.now() });
        await push(ref(db, `sessions/${adminSessionId}/logs`), { type:'command', cmd:'navigate', path, by:'agent', at: serverTimestamp() });
      };
      clickAdmin.onclick = async () => {
        if (!adminSessionId) return alert('ë¨¼ì € ì„¸ì…˜ì„ ì—°ê²°í•˜ì„¸ìš”.');
        const selector = (selectorAdmin.value || '').trim();
        if (!selector) return alert('CSS ì„ íƒìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        await push(ref(db, `sessions/${adminSessionId}/commands`), { type:'click', selector, at: Date.now() });
        await push(ref(db, `sessions/${adminSessionId}/logs`), { type:'command', cmd:'click', selector, by:'agent', at: serverTimestamp() });
      };
      highlightAdmin.onclick = async () => {
        if (!adminSessionId) return alert('ë¨¼ì € ì„¸ì…˜ì„ ì—°ê²°í•˜ì„¸ìš”.');
        const selector = (selectorAdmin.value || '').trim();
        if (!selector) return alert('CSS ì„ íƒìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        await push(ref(db, `sessions/${adminSessionId}/commands`), { type:'highlight', selector, at: Date.now() });
        await push(ref(db, `sessions/${adminSessionId}/logs`), { type:'command', cmd:'highlight', selector, by:'agent', at: serverTimestamp() });
      };
      const sendAdminMsg = async () => {
        if (!adminSessionId) return alert('ë¨¼ì € ì„¸ì…˜ì„ ì—°ê²°í•˜ì„¸ìš”.');
        const text = chatInputAdmin.value.trim(); if (!text) return;
        chatInputAdmin.value = '';
        await push(ref(db, `sessions/${adminSessionId}/chat`), { from:'agent', text, ts: Date.now() });
        await push(ref(db, `sessions/${adminSessionId}/logs`), { type:'chat', dir:'agent->user', text, at: serverTimestamp() });
      };
      chatSendAdmin.onclick = sendAdminMsg;
      chatInputAdmin.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendAdminMsg(); });
      endBtnAdmin.onclick = async () => {
        if (!adminSessionId) return;
        const ok = confirm('ì´ ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  ì±„íŒ…ì„ ì‚­ì œí• ê¹Œìš”?');
        if (!ok) return;
        const base = ref(db, `sessions/${adminSessionId}`);
        await update(child(base, 'meta'), { status:'ended', endedAt: serverTimestamp() });
        await remove(child(base, 'chat'));
        await push(child(base, 'logs'), { type:'end', by:'agent', at: serverTimestamp() });
        statusAdmin.textContent = 'ì„¸ì…˜ ì¢…ë£Œë¨';
      };
    }
    function bindActiveRequestsList(){
      const q = query(ref(db, 'sessions'), orderByChild('meta/status'), equalTo('active'));
      onChildAdded(q, (snap) => {
        const id = snap.key;
        const li = document.createElement('div');
        li.className = 'req-row';
        li.id = `req-${id}`;
        li.innerHTML = `
          <div>
            <span class="req-code">${id}</span>
            <span class="badge active">ACTIVE</span>
            <span class="muted">ìµœê·¼ ìƒì„±</span>
          </div>
          <div class="req-actions">
            <button class="btn secondary" data-code="${id}">Connect</button>
          </div>
        `;
        reqList.appendChild(li);
        li.querySelector('button')?.addEventListener('click', () => {
          sessAdmin.value = id;
          connectAdmin.click();
        });
      });
      onChildChanged(q, (snap) => {
        const id = snap.key;
        const el = document.getElementById(`req-${id}`);
        if (!el) return;
        const st = (snap.val()?.meta?.status) || 'active';
        const badge = el.querySelector('.badge');
        if (st !== 'active') {
          badge.textContent = 'ENDED';
          badge.classList.remove('active'); badge.classList.add('ended');
        }
      });
      onChildRemoved(q, (snap) => {
        const id = snap.key;
        document.getElementById(`req-${id}`)?.remove();
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        userSection.style.display = 'block';
        adminSection.style.display = 'none';
        accountDesc.textContent = 'ë¡œê·¸ì•„ì›ƒë¨';
        accountPath.textContent = '';
        resetBtn.disabled = true;
        signoutBtn.disabled = true;
        return;
      }

      uid = user.uid;
      const { server, id } = await ensureServerMapping(user);
      userServerKey = server;
      userIdKey     = id;
      userBasePath  = `users/${server}/${id}`;

      accountDesc.textContent = `${user.email || '(ì´ë©”ì¼ ì—†ìŒ)'} Â· UID ${uid.slice(0,6)}â€¦`;
      accountPath.textContent = `ê²½ë¡œ: users/${server}/${id}`;

      const isAdmin = (user.email||'').toLowerCase().includes('admin');
      userSection.style.display  = 'block';
      adminSection.style.display = isAdmin ? 'block' : 'none';

      signoutBtn.disabled = false;
      resetBtn.disabled   = false;

      if (isAdmin) {
        reqWrap.style.display = 'block';
        bindAdminHandlers();
        bindActiveRequestsList();
      }

      try { (await window.CobrowseIO.client()); } catch {}
    });

  </script>
</body>
</html>
